<div id="Analysis_More">
<div class="head">
<h1>Theory Analysis_More</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Library Additions›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Analysis_More
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Analysis/Equivalence_Lebesgue_Henstock_Integration.html">HOL-Analysis.Equivalence_Lebesgue_Henstock_Integration</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Function_Algebras.html">HOL-Library.Function_Algebras</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Types_To_Sets/Linear_Algebra_On.html">HOL-Types_To_Sets.Linear_Algebra_On</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">lemma</span></span> openin_open_Int'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"open <span class="free">S</span> <span class="main">⟹</span> openin <span class="main">(</span>top_of_set <span class="free">U</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="free">U</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_open<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Parametricity rules for topology›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹TODO: also check with theory <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Transfer_Euclidean_Space_Vector›</span></span></span></span> in AFP/ODE...›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Sigma_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_set <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> rel_set <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> Sigma Sigma"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> filterlim_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> rel_filter <span class="free">B</span> <span class="main">===&gt;</span> rel_filter <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> filterlim filterlim"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filterlim_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> nhds_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_filter <span class="free">A</span><span class="main">)</span> nhds nhds"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"bi_total <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> open open"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nhds_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> at_within_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_set <span class="free">A</span> <span class="main">===&gt;</span> rel_filter <span class="free">A</span><span class="main">)</span> at_within at_within"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"bi_total <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> open open"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> at_within_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> continuous_on continuous_on"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"bi_total <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> open open"</span></span>
    <span class="quoted"><span class="quoted">"bi_unique <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"bi_total <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">B</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> open open"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_transfer_right_total<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>t2_space set<span class="main">.</span> continuous_on <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> Collect <span class="free">AP</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">Y</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>t2_space set<span class="main">.</span> continuous_on <span class="bound">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> DomainA<span class="main">:</span> <span class="quoted"><span class="quoted">"Domainp <span class="free">A</span> <span class="main">=</span> <span class="free">AP</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">folded</span> DomainA<span class="main">,</span> <span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"right_total <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>openin <span class="main">(</span>top_of_set <span class="main">(</span>Collect <span class="free">AP</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> open"</span></span>
    <span class="quoted"><span class="quoted">"bi_unique <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"bi_total <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">B</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> open open"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> DomainA<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">f</span> <span class="skolem">g</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="skolem">X</span> <span class="skolem">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> H<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> XA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> Domainp <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span>top_of_set <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" continuous_on <span class="main">(</span><span class="skolem">X</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">=</span> continuous_on <span class="skolem">Y</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_eq_continuous_within continuous_within_topological *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x B
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> AA
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">AA</span></span> <span class="main"><span class="main">∩</span></span> Collect <span class="main"><span class="main">(</span></span>Domainp <span class="free"><span class="free">A</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> XA<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> XA <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_subtopology<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_transfer_right_total2<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>t2_space set<span class="main">.</span> continuous_on <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">Y</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>t2_space set<span class="main">.</span> continuous_on <span class="bound">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> DomainB<span class="main">:</span> <span class="quoted"><span class="quoted">"Domainp <span class="free">B</span> <span class="main">=</span> <span class="free">BP</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">folded</span> DomainB<span class="main">,</span> <span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"bi_total <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> open open"</span></span>
    <span class="quoted"><span class="quoted">"bi_unique <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"right_total <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">B</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>openin <span class="main">(</span>top_of_set <span class="main">(</span>Collect <span class="free">BP</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> open"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> DomainB<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">f</span> <span class="skolem">g</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="skolem">X</span> <span class="skolem">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="skolem">X</span> <span class="skolem">f</span> <span class="main">=</span> continuous_on <span class="skolem">Y</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_eq_continuous_within continuous_within_topological
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x C
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_subtopology<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Domainp_applyI H<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> H<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rel_setD1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x C
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sub</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"top_of_set <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Ba</span><span class="main">∈</span><span class="main">{</span><span class="bound">A</span><span class="main">.</span> Ball <span class="bound">A</span> <span class="main">(</span>Domainp <span class="free">B</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          openin <span class="main">(</span>top_of_set <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">Ba</span> <span class="main">⟶</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">Ba</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Aa</span><span class="main">.</span>  open <span class="bound">Aa</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">Aa</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">Aa</span> <span class="main">⟶</span> <span class="skolem">f</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">Ba</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">A</span><span class="main">.</span> Ball <span class="bound">A</span> <span class="main">(</span>Domainp <span class="free">B</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="var">?sub</span> <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="var">?sub</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Domainp_applyI H<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> H<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rel_setD1<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">D</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">D</span> <span class="main">⟶</span> <span class="skolem">f</span> <span class="bound">y</span> <span class="main">∈</span> <span class="var">?B</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cont x
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> open <span class="bound">A</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">A</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">A</span> <span class="main">⟶</span> <span class="skolem">f</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> generate_topology_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"right_total <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="main">(</span>rel_set <span class="free">A</span><span class="main">)</span> <span class="main">===&gt;</span> rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>generate_topology <span class="keyword1">o</span> <span class="main">(</span>insert <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> generate_topology"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> t<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="main">(</span>rel_set <span class="free">A</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="skolem">X</span> <span class="skolem">Y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> rI<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inf_absorb1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq_UNIV_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domainp <span class="free">A</span> <span class="bound">a</span><span class="main">}</span> <span class="skolem">Z</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Z</span>
    <span class="keyword1"><span class="command">using</span></span> that assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> right_total_def rel_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> bi_uniqueDr <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>generate_topology <span class="main">∘</span> insert <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">X</span> <span class="main">=</span> generate_topology <span class="skolem">C</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> o_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="skolem">C</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def
      <span class="keyword1"><span class="command">using</span></span> rI
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> UNIV
      <span class="keyword1"><span class="command">with</span></span> eq_UNIV_I<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generate_topology.UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Int <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> Int<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Domainp_iff Domainp_set Int_Collect<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Domainp_iff Domainp_set Int_Collect<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Int.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> a'<span class="main">]</span> Int.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> b'<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="skolem">C</span> <span class="skolem">a'</span>"</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="skolem">C</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> generate_topology.Int<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="skolem">C</span> <span class="main">(</span><span class="skolem">a'</span> <span class="main">∩</span> <span class="skolem">b'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∩</span> <span class="skolem">b'</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generate_topology.Int<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>UN <span class="skolem">K</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> UN<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">K'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> rel_set <span class="free">A</span> <span class="main">(</span><span class="bound">k</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">K'</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> choice<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Domainp_iff Domainp_set Int_Collect<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">K'</span></span> <span class="keyword2"><span class="keyword">where</span></span> K'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> rel_set <span class="free">A</span> <span class="main">(</span><span class="bound">k</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">K'</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">from</span></span> UN.IH<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="skolem">C</span> <span class="skolem">k'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> <span class="skolem">K'</span><span class="main">`</span><span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k'</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> generate_topology.UN<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="skolem">C</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="skolem">K'</span> <span class="main">`</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> K' <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="main">(=)</span> <span class="main">===&gt;</span> rel_set <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">K'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def rel_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="skolem">K'</span> <span class="main">`</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generate_topology.UN<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Basis <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> eq_UNIV_I<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span> Basis<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generate_topology.UNIV<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> Basis<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> Basis<span class="main">(</span>1<span class="main">)</span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∩</span> Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_set_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">B</span>›</span></span> s
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> Basis<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> generate_topology.Basis<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="skolem">C</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_set <span class="free">A</span> <span class="skolem">X</span> <span class="skolem">Y</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> UNIV
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'b</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domainp <span class="free">A</span> <span class="bound">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> generate_topology.Basis<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Int <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="skolem">a'</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="skolem">b'</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> right_total_def right_total_rel_set<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> generate_topology.Int<span class="main">[</span><span class="operator">OF</span> Int.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> Int.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domainp <span class="free">A</span> <span class="bound">a</span><span class="main">}</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a'</span> <span class="main">∩</span> <span class="skolem">b'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∩</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹rel_set <span class="free">A</span> <span class="skolem">X</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">∩</span> <span class="skolem">b</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="skolem">X</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> I_def
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∩</span> <span class="skolem">b'</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>UN <span class="skolem">K</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">K'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> rel_set <span class="free">A</span> <span class="main">(</span><span class="bound">K'</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> choice<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> right_total_def right_total_rel_set<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">K'</span></span> <span class="keyword2"><span class="keyword">where</span></span> K'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> rel_set <span class="free">A</span> <span class="main">(</span><span class="skolem">K'</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">from</span></span> UN.IH<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domainp <span class="free">A</span> <span class="bound">a</span><span class="main">}</span> <span class="skolem">B</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">K'</span><span class="main">`</span><span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> generate_topology.UN<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="main">{</span><span class="bound">a</span><span class="main">.</span> Domainp <span class="free">A</span> <span class="bound">a</span><span class="main">}</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="skolem">K'</span><span class="main">`</span><span class="skolem">K</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">from</span></span> K' <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="main">(=)</span> <span class="main">===&gt;</span> rel_set <span class="free">A</span><span class="main">)</span> <span class="skolem">K'</span> id"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def rel_set_def<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span>  <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>id <span class="main">`</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹rel_set <span class="free">A</span> <span class="skolem">X</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="skolem">X</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> U_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> U_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="skolem">K'</span> <span class="main">`</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Basis <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹rel_set <span class="free">A</span> <span class="skolem">X</span> <span class="skolem">s</span>›</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> generate_topology.Basis<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> mem_ball

<span class="keyword1"><span class="command">lemma</span></span> in_closureI<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> closure <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> closure_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> open_continuous_vimage <span class="main">=</span> continuous_on_open_vimage<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemma</span></span> open_continuous_vimage'<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">s</span> <span class="main">⟹</span> continuous_on <span class="free">s</span> <span class="free">f</span> <span class="main">⟹</span> open <span class="free">B</span> <span class="main">⟹</span> open <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> open_continuous_vimage<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Int_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> support_on_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"support_on <span class="free">carrier</span> <span class="free">f</span> <span class="main">⊆</span> support_on <span class="free">carrier</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> support_on_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> image_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">×</span> <span class="free">g</span> <span class="main">`</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closed support›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">csupport_on</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> closure <span class="main">(</span>support_on <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_csupport_on<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>csupport_on <span class="free">carrier</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> csupport_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_in_csupportD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> csupport_on <span class="free">carrier</span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> csupport_on_def support_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> csupport_on_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"csupport_on <span class="free">carrier</span> <span class="free">f</span> <span class="main">⊆</span> csupport_on <span class="free">carrier</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">carrier</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> csupport_on_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closure_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> support_on_mono<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Homeomorphism›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"homeomorphism <span class="main">{}</span> <span class="free">t</span> <span class="free">f</span> <span class="free">f'</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"homeomorphism <span class="free">s</span> <span class="main">{}</span> <span class="free">f</span> <span class="free">f'</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"homeomorphism UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">::</span>real_normed_vector"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> homeomorphism_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_range_scaleR_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">::</span>real_vector"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_scaleR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"homeomorphism UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>real_normed_vector<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> homeomorphism_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_range_scaleR_iff <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_prod<span class="main">:</span>
  <span class="quoted"><span class="quoted">"homeomorphism <span class="main">(</span><span class="free">a</span> <span class="main">×</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">×</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g'</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"homeomorphism <span class="free">a</span> <span class="free">c</span> <span class="free">f</span> <span class="free">f'</span>"</span></span>
     <span class="quoted"><span class="quoted">"homeomorphism <span class="free">b</span> <span class="free">d</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> homeomorphism_def image_prod<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> continuous_on_compose2<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generalizations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> openin_subtopology_eq_generate_topology<span class="main">:</span>
  <span class="quoted"><span class="quoted">"openin <span class="main">(</span>top_of_set <span class="free">S</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> generate_topology <span class="main">(</span>insert <span class="free">S</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> <span class="free">BB</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> open_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">=</span> generate_topology <span class="free">BB</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="free">S</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> <span class="free">BB</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="free">BB</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
    <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> UNIV
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generate_topology.Basis<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Int <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="free">S</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> <span class="free">BB</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> generate_topology.Int<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> Int <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>UN <span class="skolem">K</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="free">S</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> <span class="free">BB</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">∈</span><span class="skolem">K</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> generate_topology.UN<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Basis <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> generate_topology.Basis<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> generate_topology <span class="free">BB</span> <span class="bound">T</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">T</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="free">S</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> <span class="free">BB</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> UNIV
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Int <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> generate_topology.Int 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>UN <span class="skolem">K</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> UN.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="skolem">K</span><span class="main">-</span><span class="main">{</span>UNIV<span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> generate_topology <span class="free">BB</span> <span class="bound">T</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">T</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">THEN</span> bchoice<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="skolem">T</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">{</span>UNIV<span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> generate_topology <span class="free">BB</span> <span class="bound">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="skolem">K</span> <span class="main">-</span> <span class="main">{</span>UNIV<span class="main">}</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">T</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> generate_topology.UN<span class="main">[</span><span class="operator">OF</span> T<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="free">BB</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="skolem">T</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">{</span>UNIV<span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">K</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="skolem">T</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">{</span>UNIV<span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">∉</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>2<span class="main">)</span> UN that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">∈</span> <span class="skolem">K</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> UN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Basis <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> generate_topology.UNIV generate_topology.Basis <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> generate_topology <span class="free">BB</span> <span class="bound">T</span> <span class="main">∧</span> UNIV <span class="main">=</span> <span class="bound">T</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"generate_topology <span class="main">(</span>insert <span class="free">S</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> <span class="free">BB</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generate_topology.UNIV<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> open_gen open_openin openin_open_Int' openin_subtopology<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equal topologies›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> topology_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span>topspace <span class="free">t</span> <span class="main">=</span> topspace <span class="free">s</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">⊆</span>topspace <span class="free">t</span><span class="main">.</span> openin <span class="free">t</span> <span class="bound">x</span> <span class="main">=</span> openin <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> openin_subset topology_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finer topologies›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finer_than</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword3">(</span><span class="keyword1">finer'_than</span><span class="keyword3">)</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="keyword1"><span class="free">finer_than</span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">⟷</span> continuous_map <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finer_than_iff_nhds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">T1</span> <span class="keyword1">finer_than</span> <span class="free">T2</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">.</span> openin <span class="free">T2</span> <span class="bound">X</span> <span class="main">⟶</span> openin <span class="free">T1</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> topspace <span class="free">T1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>topspace <span class="free">T1</span> <span class="main">⊆</span> topspace <span class="free">T2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finer_than_def continuous_map_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_finer_topo<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_map <span class="free">s</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"continuous_map <span class="free">s'</span> <span class="free">t</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">finer_than</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finer_than_def o_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> continuous_map_compose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_finer_topo2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_map <span class="free">s</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"continuous_map <span class="free">s</span> <span class="free">t'</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">finer_than</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finer_than_def o_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> continuous_map_compose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> antisym_finer_than<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">finer_than</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="keyword1">finer_than</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finer_than_def topology_eq_iff continuous_map_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> inf.orderE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> subtopology_finer_than<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"top_of_set <span class="free">X</span> <span class="keyword1">finer_than</span> euclidean"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finer_than_iff_nhds openin_subtopology<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Support›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> support_on_nonneg_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"support_on <span class="free">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> support_on <span class="free">X</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>ordered_comm_monoid_add"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> support_on_def sum_nonneg_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> support_on_nonneg_sum_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"support_on <span class="free">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> support_on <span class="free">X</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>ordered_comm_monoid_add"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> support_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> sum.neutral<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> support_on_nonneg_sum_subset'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"support_on <span class="free">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="bound">x</span><span class="main">.</span> support_on <span class="free">X</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>ordered_comm_monoid_add"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> support_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> sum.neutral<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Final topology (Bourbaki, General Topology I, 4.)›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">final_topology</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
  topology <span class="main">(</span><span class="main">λ</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> openin <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span> <span class="main">-`</span> <span class="bound">U</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> openin_final_topology<span class="main">:</span>
  <span class="quoted"><span class="quoted">"openin <span class="main">(</span>final_topology <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> openin <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="main">-`</span> <span class="bound">U</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> final_topology_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> topology_inverse'<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> istopology_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> openin <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="main">-`</span> <span class="skolem">S</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> openin <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="main">-`</span> <span class="skolem">T</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="skolem">S</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="skolem">T</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">_</span> <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">U</span><span class="main">∈</span><span class="skolem">K</span><span class="main">.</span> <span class="bound">U</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> openin <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="main">-`</span> <span class="bound">U</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">K</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="bound">X</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> openin_Union<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="main">⋃</span><span class="skolem">K</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_Union<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> topspace_final_topology<span class="main">:</span>
  <span class="quoted"><span class="quoted">"topspace <span class="main">(</span>final_topology <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">→</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="free">X</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> topspace_def
    <span class="keyword1"><span class="command">unfolding</span></span> openin_final_topology
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> UnionI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_final_topologyI2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_map <span class="main">(</span><span class="free">Y</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>final_topology <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">→</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_final_topology continuous_map_alt topspace_final_topology<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_final_topologyI1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_map <span class="main">(</span>final_topology <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span><span class="main">)</span> <span class="free">Z</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> continuous_map <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="free">Z</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> that<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">→</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">→</span> topspace <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> continuous_map_alt
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">V</span> <span class="keyword3"><span class="command">assume</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"openin <span class="free">Z</span> <span class="skolem">V</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> oV<span class="main">:</span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="free">g</span> <span class="main">-`</span> <span class="skolem">V</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> hyp<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> V
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_map_alt vimage_comp <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">V</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="free">g</span> <span class="main">-`</span> <span class="skolem">V</span> <span class="main">∩</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="free">X</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">f</span> <span class="skolem">i</span> <span class="main">-`</span> <span class="free">g</span> <span class="main">-`</span> <span class="skolem">V</span> <span class="main">∩</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span>final_topology <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">-`</span> <span class="skolem">V</span> <span class="main">∩</span> topspace <span class="main">(</span>final_topology <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_final_topology oV topspace_final_topology that *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> topspace_final_topology›</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> continuous_on_final_topology_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_map <span class="main">(</span>final_topology <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span><span class="main">)</span> <span class="free">Z</span> <span class="free">g</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> continuous_map <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="free">Z</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> topspace <span class="main">(</span><span class="free">Y</span> <span class="bound">i</span><span class="main">)</span> <span class="main">→</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">→</span> topspace <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> continuous_on_final_topologyI1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ that<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> continuous_map_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> continuous_on_final_topologyI2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> that<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quotient topology›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_topology</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> topology <span class="main">⇒</span> <span class="tfree">'b</span> topology"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_topology</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> final_topology <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">`</span> topspace <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">::</span>unit<span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> openin_map_topology<span class="main">:</span>
  <span class="quoted"><span class="quoted">"openin <span class="main">(</span>map_topology <span class="free">p</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">⊆</span> <span class="free">p</span> <span class="main">`</span> topspace <span class="free">X</span> <span class="main">∧</span> openin <span class="free">X</span> <span class="main">(</span><span class="free">p</span> <span class="main">-`</span> <span class="bound">U</span> <span class="main">∩</span> topspace <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_topology_def openin_final_topology<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> topspace_map_topology<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"topspace <span class="main">(</span>map_topology <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> topspace <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_topology_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> topspace_final_topology<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_map_topology<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_map <span class="free">T</span> <span class="main">(</span>map_topology <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> continuous_map_alt openin_map_topology
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_map_composeD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_map <span class="free">T</span> <span class="free">X</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> topspace <span class="free">T</span> <span class="main">→</span> topspace <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_map_topology2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_map <span class="free">T</span> <span class="free">X</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> continuous_map <span class="main">(</span>map_topology <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_topology_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_final_topologyI1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_map_composeD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> continuous_map_compose<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_final_topologyI2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_sub_finer_than_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_topology <span class="free">f</span> <span class="main">(</span>subtopology <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">finer_than</span> subtopology <span class="main">(</span>map_topology <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finer_than_def continuous_map_def openin_subtopology openin_map_topology
      topspace_subtopology<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_map_finer_than_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subtopology <span class="main">(</span>map_topology <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="free">X</span> <span class="keyword1">finer_than</span> map_topology <span class="free">f</span> <span class="main">(</span>subtopology <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"openin <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">X</span><span class="main">)</span>"</span></span><span class="comment1">― ‹this is more or less the condition from
    <span class="antiquoted"><span class="operator">🌐</span>‹https://math.stackexchange.com/questions/705840/quotient-topology-vs-subspace-topology›</span>›</span>
  <span class="keyword1"><span class="command">unfolding</span></span> finer_than_def continuous_map_alt
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span>map_topology <span class="free">f</span> <span class="main">(</span>subtopology <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">U</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="keyword2"><span class="keyword">where</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>topspace <span class="free">T</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"openin <span class="free">T</span> <span class="skolem">W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="skolem">U</span> <span class="main">∩</span> <span class="main">(</span>topspace <span class="free">T</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">W</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> topspace_subtopology openin_subtopology openin_map_topology<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">W</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="free">X</span><span class="main">)</span> <span class="main">∩</span> topspace <span class="free">T</span> <span class="main">=</span> <span class="skolem">W</span> <span class="main">∩</span> topspace <span class="free">T</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff W<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> vimage_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="free">T</span> <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> W that<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span>subtopology <span class="main">(</span>map_topology <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="skolem">U</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> topspace <span class="free">T</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> W
    <span class="keyword1"><span class="command">unfolding</span></span> topspace_subtopology topspace_map_topology openin_subtopology openin_map_topology
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">`</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">W</span></span></span> <span class="main"><span class="main"><span class="main">∩</span></span></span> <span class="free"><span class="free"><span class="free">X</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subtopology_map_topology<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subtopology <span class="main">(</span>map_topology <span class="free">f</span> <span class="free">T</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> map_topology <span class="free">f</span> <span class="main">(</span>subtopology <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"openin <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym_finer_than<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> sub_map_finer_than_commute<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> map_sub_finer_than_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> quotient_map_map_topology<span class="main">:</span>
  <span class="quoted"><span class="quoted">"quotient_map <span class="free">X</span> <span class="main">(</span>map_topology <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> quotient_map_def openin_map_topology <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage_def Int_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> topological_space_quotient<span class="main">:</span> <span class="quoted"><span class="quoted">"class.topological_space <span class="main">(</span>openin <span class="main">(</span>map_topology <span class="free">f</span> euclidean<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_map_topology<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> t2_space_quotient<span class="main">:</span> <span class="quoted"><span class="quoted">"class.t2_space <span class="main">(</span>open<span class="main">::</span><span class="tfree">'b</span> set <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> open_def<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">=</span> <span class="main">(</span>openin <span class="main">(</span>map_topology <span class="main">(</span><span class="free">p</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>t2_space<span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span>topological_space<span class="main">)</span> euclidean<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"surj <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> open_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> open <span class="bound">X</span> <span class="main">⟹</span> open <span class="main">(</span><span class="free">p</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">p</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"closed <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> class.t2_space.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> open_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> topological_space_quotient<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="free">p</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹surj <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹closed <span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="main">-</span><span class="var">?R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">-</span><span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_def b_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> open_prod_elim<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N<span class="hidden">⇩</span><sub>x</sub></span></span> <span class="skolem"><span class="skolem">N<span class="hidden">⇩</span><sub>y</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">N<span class="hidden">⇩</span><sub>x</sub></span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">N<span class="hidden">⇩</span><sub>y</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">N<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">×</span> <span class="skolem">N<span class="hidden">⇩</span><sub>y</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">×</span> <span class="skolem">N<span class="hidden">⇩</span><sub>y</sub></span> <span class="main">⊆</span> <span class="main">-</span><span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">`</span> <span class="skolem">N<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">∩</span> <span class="free">p</span> <span class="main">`</span> <span class="skolem">N<span class="hidden">⇩</span><sub>y</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">N<span class="hidden">⇩</span><sub>x</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">N<span class="hidden">⇩</span><sub>y</sub></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">p</span> <span class="main">`</span> <span class="skolem">N<span class="hidden">⇩</span><sub>x</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">p</span> <span class="main">`</span> <span class="skolem">N<span class="hidden">⇩</span><sub>y</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">`</span> <span class="skolem">N<span class="hidden">⇩</span><sub>x</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">`</span> <span class="skolem">N<span class="hidden">⇩</span><sub>y</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span> <span class="main">×</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a_def b_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">U</span> <span class="bound">V</span><span class="main">.</span> open <span class="bound">U</span> <span class="main">∧</span> open <span class="bound">V</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="bound">U</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">∈</span> <span class="bound">V</span> <span class="main">∧</span> <span class="bound">U</span> <span class="main">∩</span> <span class="bound">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> second_countable_topology_quotient<span class="main">:</span> <span class="quoted"><span class="quoted">"class.second_countable_topology <span class="main">(</span>open<span class="main">::</span><span class="tfree">'b</span> set <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> open_def<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">=</span> <span class="main">(</span>openin <span class="main">(</span>map_topology <span class="main">(</span><span class="free">p</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>second_countable_topology<span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span>topological_space<span class="main">)</span> euclidean<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"surj <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> open_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> open <span class="bound">X</span> <span class="main">⟹</span> open <span class="main">(</span><span class="free">p</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> class.second_countable_topology.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> open_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> topological_space_quotient<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">have</span></span> euclidean_def<span class="main">:</span> <span class="quoted"><span class="quoted">"euclidean <span class="main">=</span> map_topology <span class="free">p</span> euclidean"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> openin_inverse open_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> continuous_on<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> continuous_map_iff_continuous2 continuous_on_map_topology euclidean_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> ex_countable_basis<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"countable <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"topological_basis <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="free">p</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"countable <span class="main">(</span><span class="skolem">B</span><span class="main">::</span><span class="tfree">'b</span> set set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹countable <span class="skolem">A</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"topological_basis <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> topological_basisI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹topological_basis <span class="skolem">A</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def topological_basis_open <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_p<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">O'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">O'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">O'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">p</span> <span class="main">-`</span> <span class="skolem">O'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">O'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_vimage<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">O'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> UNIV_I open_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rangeE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">-`</span> <span class="skolem">O'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">O'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> topological_basisE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹topological_basis <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="main">(</span><span class="free">p</span> <span class="main">-`</span> <span class="skolem">O'</span><span class="main">)</span>›</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">⊆</span> <span class="free">p</span> <span class="main">-`</span> <span class="skolem">O'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">`</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B'</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">O'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B'</span> <span class="main">⊆</span> <span class="skolem">O'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B'</span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">B'</span> <span class="main">∧</span> <span class="bound">B'</span> <span class="main">⊆</span> <span class="skolem">O'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B</span><span class="main">::</span><span class="tfree">'b</span> set set<span class="main">.</span> countable <span class="bound">B</span> <span class="main">∧</span> open <span class="main">=</span> generate_topology <span class="bound">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> topological_basis_imp_subbasis<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closure_Union<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> closure <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compactness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compact_if_closed_subset_of_compact<span class="main">:</span>
  <span class="quoted"><span class="quoted">"compact <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> compactI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">UU</span> <span class="keyword3"><span class="command">assume</span></span> UU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="skolem">UU</span><span class="main">.</span> open <span class="bound">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="skolem">UU</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>insert <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">UU</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> insert <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">UU</span> <span class="main">⟹</span> open <span class="bound">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> UU <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_Compl <span class="quoted"><span class="quoted">‹closed <span class="free">S</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> compactE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹compact <span class="free">T</span>›</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">𝒯'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 𝒯<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒯'</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">UU</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">𝒯'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="skolem">𝒯'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">C'</span></span><span class="main">⊆</span><span class="skolem">UU</span><span class="main">.</span> finite <span class="bound">C'</span> <span class="main">∧</span> <span class="free">S</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="bound">C'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">𝒯'</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">{</span></span><span class="main"><span class="main">-</span></span><span class="free"><span class="free">S</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 𝒯 UU
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 𝒯 <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> <span class="skolem">𝒯'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒯
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">𝒯'</span> <span class="main">-</span> <span class="main">{</span><span class="main">-</span> <span class="free">S</span><span class="main">}</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒯 UU <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">U</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Locally finite›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">locally_finite_on</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="bound">p</span><span class="main">∈</span><span class="bound">N</span> <span class="main">∧</span> open <span class="bound">N</span> <span class="main">∧</span> finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">i</span> <span class="main">∩</span> <span class="bound">N</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> locally_finite_onI <span class="main">=</span> locally_finite_on_def<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> locally_finite_onE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">I</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">N</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">N</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> locally_finite_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> locally_finite_onD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">I</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">U</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_onE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> locally_finite_on_open_coverI<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">I</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">U</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> open_cover<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> open <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">U</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_cover
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="bound">N</span> <span class="main">∧</span> open <span class="bound">N</span> <span class="main">∧</span> finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="bound">N</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">U</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> conjI i fin<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> locally_finite_compactD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> lf<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">I</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> compact<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">N</span> <span class="bound">p</span> <span class="main">∧</span> open <span class="main">(</span><span class="bound">N</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="bound">N</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bchoice<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> locally_finite_onE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lf<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="bound">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> open <span class="main">(</span><span class="skolem">N</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">N</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">p</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="skolem">N</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">`</span> <span class="free">X</span> <span class="main">⟹</span> open <span class="bound">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> N subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> compactE<span class="main">[</span><span class="operator">OF</span> compact this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">N</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset_image<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">N</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span><span class="skolem">C</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">N</span> <span class="bound">c</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_Union<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> C N<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>finite_subset<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closure_Int_open_eq_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span>closure <span class="free">T</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">T</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_Int_closure_eq_empty <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> locally_finite_on_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">J</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">V</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free">U</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">J</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">I</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> locally_finite_onE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">J</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">N</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="bound">N</span> <span class="main">∧</span> open <span class="bound">N</span> <span class="main">∧</span> finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">V</span> <span class="bound">i</span> <span class="main">∩</span> <span class="bound">N</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">N</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> locally_finite_on_closure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">I</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> locally_finite_onE<span class="main">[</span><span class="operator">OF</span> that this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">N</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="bound">N</span> <span class="main">∧</span> open <span class="bound">N</span> <span class="main">∧</span> finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">N</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">N</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closure_Int_open_eq_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> locally_finite_on_closedin_Union_closure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closedin <span class="main">(</span>top_of_set <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">I</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closedin_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> openin_subopen<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∉</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> locally_finite_onE<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">N</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?I</span>"</span></span><span class="main">)</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N'</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">N'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> N<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span>top_of_set <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="skolem">N'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> openin_open_Int<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∩</span> <span class="skolem">N'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N'_def N<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="skolem">N'</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x that<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> N<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> closure_iff_nhds_not_empty dual_order.refl<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> openin <span class="main">(</span>top_of_set <span class="free">X</span><span class="main">)</span> <span class="bound">T</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">T</span> <span class="main">∧</span> <span class="bound">T</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> closure_subtopology_minimal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span> <span class="main">⟹</span> closedin <span class="main">(</span>top_of_set <span class="free">X</span><span class="main">)</span> <span class="free">T</span> <span class="main">⟹</span> closure <span class="free">S</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closedin_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> closure_minimal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> locally_finite_on_closure_Union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> closure <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"locally_finite_on <span class="free">X</span> <span class="free">I</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> closure <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> SUP_le_iff closed_closure closure_minimal closure_subset subsetCE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closure_subtopology_minimal<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> locally_finite_on_closedin_Union_closure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of cover›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">refines</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">refines</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">refines</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refines_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">refines</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">refines</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refines_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functions as vector space›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">scaleR</span><span class="main">)</span> <span class="quoted">scaleR</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">scaleR_fun</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">scaleR_fun</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scaleR_fun_beta<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleR_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">real_vector</span><span class="main">)</span> <span class="quoted">real_vector</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scaleR_fun_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Additional lemmas›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> <span class="main">=</span> vimage_Un vimage_Int

<span class="keyword1"><span class="command">lemma</span></span> finite_Collect_imageI<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">U</span></span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">U</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">d</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">c</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_surj that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_compose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_compose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> scaleR_compose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_scaleR_ball<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_normed_vector"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="free">c</span> <span class="main">`</span> ball <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> ball <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>abs <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem_ball dist_norm<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span> <span class="main">-</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">b</span><span class="main">)</span>  <span class="main">=</span> abs <span class="free">c</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_scaleR<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> norm_scaleR<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> abs <span class="free">c</span> <span class="main">*</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mult_strict_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> abs <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> abs <span class="free">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> norm <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_scaleR<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> norm_scaleR<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">¦</span><span class="free">c</span><span class="main">¦</span> <span class="main">*</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">c</span><span class="main">¦</span> <span class="main">*</span> <span class="free">r</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">¦</span><span class="free">c</span><span class="main">¦</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xdc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span> <span class="main">∈</span> ball <span class="free">a</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem_ball dist_norm<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xdc<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Continuity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_within_topologicalE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">s</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"open <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms continuous_within_topological <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_within_topologicalE'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">A</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"open <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms continuous_within_topologicalE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I image_subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⟹</span> continuous_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inverse <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_normed_div_algebra"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_inverse<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">has_derivative</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_plus_fun<span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="keyword1">has_derivative</span> <span class="free">x'</span> <span class="main">+</span> <span class="free">y'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">has_derivative</span> <span class="free">x'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="keyword1">has_derivative</span> <span class="free">y'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_scaleR_fun<span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="keyword1">has_derivative</span> <span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="keyword1">has_derivative</span> <span class="free">y'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scaleR_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_times_fun<span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">x</span> <span class="free">a</span> <span class="main">*</span> <span class="free">y'</span> <span class="bound">h</span> <span class="main">+</span> <span class="free">x'</span> <span class="bound">h</span> <span class="main">*</span> <span class="free">y</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">has_derivative</span> <span class="free">x'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="keyword1">has_derivative</span> <span class="free">y'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span>real_normed_algebra"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> real_sqrt_has_derivative_generic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span>sqrt <span class="keyword1">has_derivative</span> <span class="main">(*)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> inverse <span class="main">(</span>sqrt <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_at_withinI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> DERIV_real_sqrt_generic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> inverse <span class="main">(</span>sqrt <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> at_within_open<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_field_derivative_def open_delete <span class="dynamic"><span class="dynamic">ac_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqrt_has_derivative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sqrt <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f'</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> <span class="free">f'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_eq_rhs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_derivative_compose<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> that<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> real_sqrt_has_derivative_generic<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> that<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> has_derivative_norm_compose<span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span> <span class="main">=</span> has_derivative_compose<span class="main">[</span><span class="operator">OF</span> _ has_derivative_norm<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Differentiable›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> differentiable_on_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_transform_eventually<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> D
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">D</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_derivative_within<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_mono Lim_transform_eventually<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_within_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> differentiable_transform_eventually<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">X</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_at_topological <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> at_within_open<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> differentiable_within_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that differentiable_eqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_eq_differentiable_at<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> differentiable_chain_within<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_comp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span>  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> differentiable_on_comp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> differentiable_on_subset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> differentiable_on_compose2 <span class="main">=</span> differentiable_on_comp2<span class="main">[</span><span class="operator">unfolded</span> o_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_openD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> differentiable_on_eq_differentiable_at that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_add_fun<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">differentiable_on</span> UNIV <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">differentiable_on</span> UNIV <span class="main">⟹</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="keyword1">differentiable_on</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_mult_fun<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">differentiable_on</span> UNIV <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">differentiable_on</span> UNIV <span class="main">⟹</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="keyword1">differentiable_on</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span>real_normed_algebra"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_scaleR_fun<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">differentiable_on</span> UNIV <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="keyword1">differentiable_on</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scaleR_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqrt_differentiable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sqrt <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">using</span></span> sqrt_has_derivative<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="main">_</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqrt_differentiable_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sqrt <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sqrt_differentiable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inverse <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_normed_field"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> differentiable_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_openI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def at_within_open<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span> differentiable_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> differentiable_norm_compose_at <span class="main">=</span> differentiable_compose<span class="main">[</span><span class="operator">OF</span> differentiable_norm_at<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_Pair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">g</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> differentiable_on_def
  <span class="keyword1"><span class="command">using</span></span> differentiable_Pair<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_at_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_derivative_fst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_at_snd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_derivative_snd<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> frechet_derivative_worksI <span class="main">=</span> frechet_derivative_works<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> sin_differentiable_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sin <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> differentiable_def has_derivative_sin that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> cos_differentiable_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cos <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> differentiable_def has_derivative_cos that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Frechet derivative›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> frechet_derivative_transform_within_open_ext <span class="main">=</span>
  fun_cong<span class="main">[</span><span class="operator">OF</span> frechet_derivative_transform_within_open<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> frechet_derivative_at' <span class="main">=</span> frechet_derivative_at<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_plus_fun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="main">⟹</span>
  frechet_derivative <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
    frechet_derivative <span class="free">x</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> frechet_derivative <span class="free">y</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> frechet_derivative_worksI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> frechet_derivative_plus <span class="main">=</span> frechet_derivative_plus_fun<span class="main">[</span><span class="operator">unfolded</span> plus_fun_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_zero_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">0</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frechet_derivative_const zero_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_sin<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sin <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">xa</span> <span class="main">*</span> cos <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span>real"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_derivative_sin<span class="main"><span class="main">[</span></span><span class="operator">OF</span> frechet_derivative_worksI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_cos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cos <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">xa</span> <span class="main">*</span> <span class="main">-</span> sin <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span>real"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> has_derivative_cos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> frechet_derivative_worksI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_sum_fun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> sum <span class="free">f</span> <span class="free">I</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_fun_def plus_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_sum_fun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  frechet_derivative <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> frechet_derivative <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frechet_derivative_zero_fun frechet_derivative_plus_fun differentiable_sum_fun<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_fun_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> frechet_derivative_sum <span class="main">=</span> frechet_derivative_sum_fun<span class="main">[</span><span class="operator">unfolded</span> sum_fun_def<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_times_fun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">g</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="main">⟹</span>
  frechet_derivative <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="free">a</span> <span class="main">*</span> frechet_derivative <span class="free">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="bound">x</span> <span class="main">+</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">g</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span>real_normed_algebra"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> frechet_derivative_worksI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> frechet_derivative_times <span class="main">=</span> frechet_derivative_times_fun<span class="main">[</span><span class="operator">unfolded</span> times_fun_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_scaleR_fun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="main">⟹</span>
  frechet_derivative <span class="main">(</span><span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> frechet_derivative <span class="free">y</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> frechet_derivative_worksI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> frechet_derivative_scaleR <span class="main">=</span> frechet_derivative_scaleR_fun<span class="main">[</span><span class="operator">unfolded</span> scaleR_fun_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> frechet_derivative <span class="main">(</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> frechet_derivative <span class="free">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> diff_chain_at frechet_derivative_at' frechet_derivative_works that<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_compose_eucl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="main">(</span>frechet_derivative <span class="free">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">interpret</span></span> g<span class="main">:</span> linear <span class="quoted"><span class="quoted">"frechet_derivative <span class="free">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_frechet_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> f<span class="main">:</span> linear <span class="quoted"><span class="quoted">"frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_frechet_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span>
    frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span>frechet_derivative <span class="free">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> frechet_derivative_compose<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> o_apply
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> euclidean_representation<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g.sum g.scaleR f.sum f.scaleR<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="skolem">v</span> <span class="main">=</span> <span class="var">?r</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_works_on_open<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">X</span> <span class="main">⟹</span> open <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> frechet_derivative_works_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_onD differentiable_on_openD frechet_derivative_worksI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inverse <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_normed_field"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> frechet_derivative_worksI
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sqrt <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">f</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sqrt_has_derivative<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> has_derivative_eq_rhs<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frechet_derivative_worksI that <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">v</span> <span class="main">∙</span> sgn <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_inner"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> frechet_derivative_worksI that <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bounded_linear<span class="main">)</span> frechet_derivative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_eq_rhs<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">bundle</span></span> no_matrix_mult <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">no_notation</span></span> matrix_matrix_mult <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">**</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bounded_bilinear<span class="main">)</span> frechet_derivative<span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> no_matrix_mult
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span> <span class="main">⟹</span>
      frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">x</span> <span class="bound">a</span> <span class="main"><span class="free">**</span></span> <span class="free">y</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">x</span> <span class="free">a</span> <span class="main"><span class="free">**</span></span> frechet_derivative <span class="free">y</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="bound">h</span> <span class="main">+</span> frechet_derivative <span class="free">x</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="bound">h</span> <span class="main"><span class="free">**</span></span> <span class="free">y</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> FDERIV frechet_derivative_worksI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_divide<span class="main">:</span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">/</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">h</span> <span class="main">/</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span>frechet_derivative <span class="free">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">h</span> <span class="main">*</span> <span class="free">f</span> <span class="free">x</span> <span class="main">/</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_normed_field"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divide_inverse_commute bounded_bilinear.frechet_derivative<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bounded_bilinear_mult<span class="main"><span class="main">]</span></span>
      frechet_derivative_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_pair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">v</span><span class="main">,</span> frechet_derivative <span class="free">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_worksI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_worksI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> fst <span class="main">(</span>frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">(</span><span class="main">_</span><span class="main">::</span>real_normed_vector <span class="main">×</span> <span class="main">_</span><span class="main">::</span>real_normed_vector<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> frechet_derivative_worksI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_snd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> snd <span class="main">(</span>frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">(</span><span class="main">_</span><span class="main">::</span>real_normed_vector <span class="main">×</span> <span class="main">_</span><span class="main">::</span>real_normed_vector<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> frechet_derivative_worksI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_eq_vector_derivative_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">t</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> vector_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> frechet_derivative_eq_vector_derivative<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Linear algebra›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> vector_space<span class="main">)</span> dim_pos_finite_dimensional_vector_spaceE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'b</span> set<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">basis</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite_dimensional_vector_space <span class="free">scale</span> <span class="free">basis</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"local.span <span class="skolem">b</span> <span class="main">=</span> local.span UNIV"</span></span> <span class="quoted"><span class="quoted">"local.independent <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dim_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim UNIV <span class="main">=</span> card <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dim_eq_card<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_ge_0_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_dimensional_vector_space <span class="free">scale</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> vector_space_on <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">Rep</span><span class="main">::</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">(</span><span class="bound">Abs</span><span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span><span class="main">.</span> type_definition <span class="bound">Rep</span> <span class="bound">Abs</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> local_typedef_vector_space_on <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">scale</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>

<span class="keyword1"><span class="command">lemmas_with</span></span> <span class="main">[</span><span class="operator">var_simplified</span> <span class="dynamic"><span class="dynamic">explicit_ab_group_add</span></span><span class="main">,</span>
    <span class="operator">unoverload_type</span> <span class="tfree">'d</span><span class="main">,</span>
    <span class="operator">OF</span> type.ab_group_add_axioms type_vector_space_on_with<span class="main">,</span>
    <span class="operator">folded</span> dim_S_def<span class="main">,</span>
    <span class="operator">untransferred</span><span class="main">,</span>
    <span class="operator">var_simplified</span> <span class="dynamic"><span class="dynamic">implicit_ab_group_add</span></span><span class="main">]</span><span class="main">:</span>
    lt_dim_pos_finite_dimensional_vector_spaceE <span class="main">=</span> vector_space.dim_pos_finite_dimensional_vector_spaceE

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas_with</span></span> <span class="main">[</span><span class="operator">cancel_type_definition</span><span class="main">,</span>
    <span class="operator">OF</span> S_ne<span class="main">,</span>
    <span class="operator">folded</span> subset_iff'<span class="main">,</span>
    <span class="operator">simplified</span> pred_fun_def<span class="main">,</span> <span class="operator">folded</span> finite_dimensional_vector_space_on_with<span class="main">,</span>
    <span class="operator">simplified</span><span class="comment1">―‹too much?›</span><span class="main">]</span><span class="main">:</span>
    dim_pos_finite_dimensional_vector_spaceE <span class="main">=</span> lt_dim_pos_finite_dimensional_vector_spaceE

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extensional function space›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹f is zero outside A. We use such functions to canonically represent
  functions whose domain is A›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extensional0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>zero<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extensional0</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extensional0_0<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">X</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extensional0_UNIV<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 UNIV <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ext_extensional0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extensional0_add<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> extensional0 <span class="free">S</span> <span class="free">g</span> <span class="main">⟹</span> extensional0 <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="main">+</span> <span class="free">g</span><span class="main">::</span><span class="main">_</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span>comm_monoid_add<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extensinoal0_mult<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="free">x</span> <span class="main">⟹</span> extensional0 <span class="free">S</span> <span class="free">y</span> <span class="main">⟹</span> extensional0 <span class="free">S</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span>mult_zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extensional0_scaleR<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> extensional0 <span class="free">S</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span><span class="main">::</span><span class="main">_</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span>real_vector<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extensional0_outside<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> extensional0 <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_extensional0<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>Collect <span class="main">(</span>extensional0 <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subspace_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Send the function f to its canonical representative as a function with domain A›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>zero<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">restrict0</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restrict0_UNIV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 UNIV <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extensional0_restrict0<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">A</span> <span class="main">(</span>restrict0 <span class="free">A</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_def restrict0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict0_times<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 <span class="free">A</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> restrict0 <span class="free">A</span> <span class="free">x</span> <span class="main">*</span> restrict0 <span class="free">A</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span>mult_zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict0_apply_in<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> restrict0 <span class="free">A</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict0_apply_out<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> restrict0 <span class="free">A</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict0_scaleR<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 <span class="free">A</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span><span class="main">::</span><span class="main">_</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span>real_vector<span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> restrict0 <span class="free">A</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict0_add<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="main">+</span> <span class="free">g</span><span class="main">::</span><span class="main">_</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span>real_vector<span class="main">)</span> <span class="main">=</span> restrict0 <span class="free">A</span> <span class="free">f</span> <span class="main">+</span> restrict0 <span class="free">A</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict0_restrict0<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 <span class="free">X</span> <span class="main">(</span>restrict0 <span class="free">Y</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> restrict0 <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Smooth">
<div class="head">
<h1>Theory Smooth</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Smooth Functions between Normed Vector Spaces›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Smooth
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Analysis_More.html">Analysis_More</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹From/To <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Multivariate_Taylor.thy›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multivariate_Taylor_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_normed_vector <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>banach"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Df</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Df_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="free">Df</span> <span class="bound">a</span> <span class="main">0</span> <span class="free">H</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Df_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">i</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> closed_segment <span class="free">X</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">Df</span> <span class="bound">a</span> <span class="bound">i</span> <span class="free">H</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="free">Df</span> <span class="bound">a</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">a</span> <span class="keyword1">within</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_segment <span class="free">X</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span>
      <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">Df</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">H</span><span class="main">)</span> <span class="free">n</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> multivariate_Taylor_has_integral<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">Df</span> <span class="free">X</span> <span class="bound">i</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> multivariate_Taylor<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">Df</span> <span class="free">X</span> <span class="bound">i</span> <span class="free">H</span><span class="main">)</span> <span class="main">+</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> multivariate_Taylor_integrable<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"closed_segment <span class="free">X</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">line</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">line</span> <span class="skolem">t</span> <span class="main">=</span> <span class="free">X</span> <span class="main">+</span> <span class="skolem">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">have</span></span> segment_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_segment <span class="free">X</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">line</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_def closed_segment_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> line_deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">line</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="skolem">line</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Dg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Dg</span> <span class="skolem">n</span> <span class="skolem">t</span> <span class="main">=</span> <span class="free">Df</span> <span class="main">(</span><span class="skolem">line</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">n</span> <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> Dg0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Dg</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Dg_def Df_Nil g_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> DgSuc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Dg</span> <span class="skolem">m</span> <span class="keyword1">has_vector_derivative</span> <span class="skolem">Dg</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">line</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> segment_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span> <span class="main">=</span> has_derivative_in_compose<span class="main">[</span><span class="operator">OF</span> _ has_derivative_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Df_Cons<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">interpret</span></span> Df<span class="main">:</span> linear <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="free">Df</span> <span class="main">(</span><span class="skolem">line</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_derivative_linear <span class="dynamic"><span class="dynamic">derivative_intros</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span> <span class="main">=</span>
      has_derivative_compose<span class="main">[</span><span class="operator">OF</span> _ line_deriv<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Df.scaleR <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Dg_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> has_vector_derivative_def g_def segment_eq
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cs<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> g_Taylor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="keyword1">has_integral</span> <span class="skolem">g</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">0</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">/</span> fact <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">Dg</span> <span class="bound">i</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def Dg_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> line_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Taylor_has_integral<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> c<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def line_def Dg_def<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> c
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integral_unique add.commute<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Higher-order differentiable›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">higher_differentiable_on</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_normed_vector set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>real_normed_vector<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">higher_differentiable_on</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="main">⟷</span> continuous_on <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">higher_differentiable_on</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="free">higher_differentiable_on</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ball_differentiable_atD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def differentiable_at_withinI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_imp_continuous_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_imp_continuous_on ball_differentiable_atD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_imp_differentiable_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ball_differentiable_atD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_congI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">g</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="skolem">g</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       2<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="skolem">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 Suc<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differentiable_eqI<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> frechet_derivative <span class="skolem">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3"</span> Suc.prems<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> frechet_derivative_transform_within_open_ext that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 2 3 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> 2 4<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span> <span class="main">⟷</span> higher_differentiable_on <span class="free">T</span> <span class="free">g</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_congI assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_SucD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_imp_continuous_on ball_differentiable_atD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_addD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_SucD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_addD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> <span class="free">n</span>"</span></span><span class="main">]</span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_open_subsetsI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">T</span> <span class="main">∧</span> open <span class="bound">T</span> <span class="main">∧</span> higher_differentiable_on <span class="bound">T</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 0
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> at_within_open
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Lim_at_imp_Lim_at_within<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> at_within_open <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> differentiable_at_withinI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_const<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> frechet_derivative_const<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_id<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frechet_derivative_works higher_differentiable_on_const<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">g</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span>
    f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f g <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frechet_derivative_plus
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_intros</span></span> f g Suc.IH hf hg
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bounded_bilinear<span class="main">)</span> differentiable<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">prod</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">S</span>"</span></span> 
 <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> differentiableI frechet_derivative_worksI that FDERIV<span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> d <span class="main">=</span> bounded_bilinear.differentiable
<span class="keyword1"><span class="command">lemmas</span></span> differentiable_inner <span class="main">=</span> bounded_bilinear_inner<span class="main">[</span><span class="operator">THEN</span> d<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> differentiable_scaleR <span class="main">=</span> bounded_bilinear_scaleR<span class="main">[</span><span class="operator">THEN</span> d<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> differentiable_mult <span class="main">=</span> bounded_bilinear_mult<span class="main">[</span><span class="operator">THEN</span> d<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bounded_bilinear<span class="main">)</span> differentiable_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">prod</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def differentiable<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> do <span class="main">=</span> bounded_bilinear.differentiable_on
<span class="keyword1"><span class="command">lemmas</span></span> differentiable_on_inner <span class="main">=</span> bounded_bilinear_inner<span class="main">[</span><span class="operator">THEN</span> do<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> differentiable_on_scaleR <span class="main">=</span> bounded_bilinear_scaleR<span class="main">[</span><span class="operator">THEN</span> do<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> differentiable_on_mult <span class="main">=</span> bounded_bilinear_mult<span class="main">[</span><span class="operator">THEN</span> do<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bounded_bilinear<span class="main">)</span> higher_differentiable_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">prod</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">g</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> continuous_on<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span>
    f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f g <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span> Suc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frechet_derivative
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_intros</span></span> f g differentiable higher_differentiable_on_add Suc.IH
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_SucD
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> hdo <span class="main">=</span> bounded_bilinear.higher_differentiable_on
<span class="keyword1"><span class="command">lemmas</span></span> higher_differentiable_on_inner <span class="main">=</span> bounded_bilinear_inner<span class="main">[</span><span class="operator">THEN</span> hdo<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> higher_differentiable_on_scaleR <span class="main">=</span> bounded_bilinear_scaleR<span class="main">[</span><span class="operator">THEN</span> hdo<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> higher_differentiable_on_mult <span class="main">=</span> bounded_bilinear_mult<span class="main">[</span><span class="operator">THEN</span> hdo<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> finite <span class="free">F</span> <span class="main">⟹</span> higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">F</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_const higher_differentiable_on_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">T</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> continuous_on_subset differentiable_on_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">T</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">g</span> <span class="free">n</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>euclidean_space"</span></span><span class="comment1">―‹TODO: can we get around this restriction?›</span>
  <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1-3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>4-<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_compose2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems
  <span class="keyword1"><span class="command">have</span></span>
    f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">w</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">g</span> <span class="main">`</span> <span class="main">_</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span> f g <span class="quoted"><span class="quoted">‹open <span class="free">T</span>›</span></span> Suc
      Suc.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">v</span><span class="main">,</span> <span class="operator">unfolded</span> o_def<span class="main">]</span>
      higher_differentiable_on_SucD<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frechet_derivative_compose_eucl subset_iff
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> differentiable_chain_within higher_differentiable_on_sum
          higher_differentiable_on_scaleR higher_differentiable_on_inner
          higher_differentiable_on_const
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> differentiable_at_withinI
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_uminus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_scaleR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_const<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_minus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">g</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_add<span class="main">[</span><span class="operator">OF</span> _ higher_differentiable_on_uminus<span class="main">,</span> <span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_inverse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inverse <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_normed_field"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_inverse<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fn<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="skolem">f</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_SucD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_inverse image_iff power2_eq_square
        frechet_derivative_inverse divide_inverse
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> differentiable_inverse higher_differentiable_on_uminus higher_differentiable_on_mult
          Suc.IH fn
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_divide<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">/</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">g</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_normed_field"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_mult<span class="main">[</span><span class="operator">OF</span> _ higher_differentiable_on_inverse<span class="main">,</span> <span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> _ that<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    that<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divide_inverse image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_open_Union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="main">⋃</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="bound">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> open <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> differentiable_on_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_iff at_within_open open_Union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_open_Union<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">(</span><span class="main">⋃</span><span class="free">S</span><span class="main">)</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> higher_differentiable_on <span class="bound">s</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> open <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_open_Union<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_open_Union<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_open_Un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">T</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that differentiable_on_open_Union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">S</span><span class="main">,</span> <span class="free">T</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_open_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">T</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_open_Union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">S</span><span class="main">,</span> <span class="free">T</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sqrt <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fn<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="skolem">f</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_SucD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_imp_continuous_on<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> op<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="skolem">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"open <span class="var">?op</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_continuous_vimage'<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹continuous_on <span class="free">S</span> <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> on<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="skolem">f</span> <span class="main">-`</span> <span class="main">{..&lt;</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"open <span class="var">?on</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_continuous_vimage'<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> op'<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="var">?op</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> on'<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="var">?on</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_const<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">(</span><span class="var">?op</span> <span class="main">∪</span> <span class="var">?on</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span><span class="main">::</span>real <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_open_Un op on
          higher_differentiable_on_congI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ op'<span class="main"><span class="main">]</span></span> higher_differentiable_on_congI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ on'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?op</span> <span class="main">∪</span> <span class="var">?on</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">1</span><span class="main">::</span>real <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> fn i Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sqrt_differentiable_on image_iff frechet_derivative_sqrt
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sqrt_differentiable higher_differentiable_on_mult higher_differentiable_on_inverse
          higher_differentiable_on_divide higher_differentiable_on_const
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_frechet_derivativeI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="free">h</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">X</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_norm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_inner"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_norm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fn<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="skolem">f</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_SucD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_norm frechet_derivative_norm image_iff sgn_div_norm
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> differentiable_norm_compose_at higher_differentiable_on_inner
          higher_differentiable_on_inverse
          higher_differentiable_on_mult Suc.IH fn<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> higher_differentiable_on.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_Pair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">k</span> <span class="main">⟹</span> higher_differentiable_on <span class="free">S</span> <span class="free">g</span> <span class="free">k</span> <span class="main">⟹</span>
   higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> higher_differentiable_on.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">unfolding</span></span> higher_differentiable_on.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frechet_derivative_pair<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_compose'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">T</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">g</span> <span class="free">n</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_compose<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> comp_def that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> higher_differentiable_on_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">(</span><span class="free">S</span> <span class="main">×</span> <span class="free">T</span><span class="main">)</span> fst <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> higher_differentiable_on.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_at_fst frechet_derivative_fst frechet_derivative_id higher_differentiable_on_const<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps continuous_on_fst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_snd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">(</span><span class="free">S</span> <span class="main">×</span> <span class="free">T</span><span class="main">)</span> snd <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> higher_differentiable_on.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_at_snd frechet_derivative_snd frechet_derivative_id higher_differentiable_on_const<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps continuous_on_snd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_fst_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> differentiable_at_fst
      <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps frechet_derivative_fst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_snd_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> differentiable_at_snd
      <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps frechet_derivative_snd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_Pair'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">k</span> <span class="main">⟹</span> higher_differentiable_on <span class="free">T</span> <span class="free">g</span> <span class="free">k</span> <span class="main">⟹</span>
   higher_differentiable_on <span class="main">(</span><span class="free">S</span> <span class="main">×</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">::</span>euclidean_space<span class="main">⇒</span><span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">::</span>euclidean_space<span class="main">⇒</span><span class="main">_</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_Pair open_Times S T
      higher_differentiable_on_fst
      higher_differentiable_on_snd
      higher_differentiable_on_compose'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span>
      higher_differentiable_on_compose'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">g</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">T</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_sin<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sin <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> higher_differentiable_on_cos<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cos <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atomize_conj
  <span class="keyword1"><span class="command">using</span></span> f
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sin <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cos <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_SucD
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps sin_differentiable_at cos_differentiable_at
        frechet_derivative_sin frechet_derivative_cos S
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_mult higher_differentiable_on_uminus
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Higher directional derivatives›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nth_derivative</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>real_normed_vector<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_derivative</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nth_derivative</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free">nth_derivative</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_nth_derivative_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="free">i</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span>
    nth_derivative <span class="free">i</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="free">h</span><span class="main">)</span> <span class="free">x</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_derivative_funpow<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nth_derivative <span class="free">i</span> <span class="free">f</span> <span class="free">x</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="bound">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="free">h</span><span class="main">)</span> <span class="main">^^</span> <span class="free">i</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> funpow_Suc_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_derivative_exists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="free">i</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">h</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span>
    <span class="bound">f'</span> <span class="free">h</span> <span class="main">=</span> nth_derivative <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">X</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps that <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frechet_derivative_worksI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> higher_differentiable_on.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> higher_derivatives_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">X</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Df</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">h</span><span class="main">.</span> <span class="free">Df</span> <span class="bound">a</span> <span class="main">0</span> <span class="bound">h</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">h</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">Df</span> <span class="bound">a</span> <span class="bound">i</span> <span class="free">H</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="free">Df</span> <span class="bound">a</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">Df</span> <span class="bound">a</span> <span class="bound">i</span> <span class="free">H</span> <span class="main">=</span> nth_derivative <span class="bound">i</span> <span class="free">f</span> <span class="bound">a</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">X</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> nth_derivative_exists<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="bound">i</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">H</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">f'</span> <span class="free">H</span> <span class="main">=</span> nth_derivative <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> bchoice_iff<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">i</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">H</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="skolem">f'</span> <span class="skolem">x</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="skolem">f'</span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="free">H</span> <span class="main">=</span> nth_derivative <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">f</span> <span class="skolem">x</span> <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Df</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Df</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="skolem">a</span> <span class="keyword1">else</span> <span class="skolem">f'</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">h</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Df</span> <span class="skolem">a</span> <span class="main">0</span> <span class="skolem">h</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">h</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Df_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">Df</span> <span class="bound">a</span> <span class="skolem">i</span> <span class="free">H</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="skolem">Df</span> <span class="skolem">a</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Df_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> _ <span class="quoted"><span class="quoted">‹open <span class="free">X</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_transform_within_open<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> f'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="skolem">Df</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="free">H</span> <span class="main">=</span> nth_derivative <span class="skolem">i</span> <span class="free">f</span> <span class="skolem">a</span> <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Df_def f'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_derivative_differentiable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_imp_continuous_nth_derivative<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_at_real_eq_scaleR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"NO_MATCH <span class="main">1</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frechet_derivative_eq_vector_derivative that<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_real_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps frechet_derivative_at_real_eq_scaleR
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_scaleR higher_differentiable_on_const
      <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_real_SucI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_real_Suc higher_differentiable_on.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> o<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_real_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_on_real_Suc'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"open <span class="free">S</span> <span class="main">⟹</span> higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> continuous_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_derivative_differentiable
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_SucD
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_real_SucI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_real_Suc higher_differentiable_on.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
      higher_differentiable_on_imp_continuous_nth_derivative<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_segment_subsetD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">H</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"closed_segment <span class="free">X</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_Taylor<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_normed_vector <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>banach"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">H</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Df</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hd<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_segment <span class="free">X</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> nth_derivative <span class="free">n</span> <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">H</span><span class="main">)</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> nth_derivative <span class="bound">i</span> <span class="free">f</span> <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> nth_derivative <span class="bound">i</span> <span class="free">f</span> <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">+</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="free">i</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th3</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> higher_derivatives_exists<span class="main">[</span><span class="operator">OF</span> hd<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Df</span></span> <span class="keyword2"><span class="keyword">where</span></span> Df<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">h</span><span class="main">.</span> <span class="skolem">Df</span> <span class="bound">a</span> <span class="main">0</span> <span class="bound">h</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">h</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">Df</span> <span class="bound">a</span> <span class="bound">i</span> <span class="free">H</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="skolem">Df</span> <span class="bound">a</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="skolem">Df</span> <span class="bound">a</span> <span class="bound">i</span> <span class="free">H</span> <span class="main">=</span> nth_derivative <span class="bound">i</span> <span class="free">f</span> <span class="bound">a</span> <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> multivariate_Taylor_integral<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">&gt;</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span>›</span></span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Df</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">H</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main">,</span> <span class="operator">OF</span> Df<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> cs
  <span class="keyword1"><span class="command">have</span></span> mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">Df</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">H</span><span class="main">)</span> <span class="free">n</span> <span class="free">H</span><span class="main">)</span> <span class="keyword1">has_integral</span>
     <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> fact <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">Df</span> <span class="free">X</span> <span class="bound">i</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>
     <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> cs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_eq_rhs<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def
    <span class="keyword1"><span class="command">using</span></span> negligible_empty _ mt
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_spike<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> closed_segment_subsetD<span class="main">[</span><span class="operator">OF</span> cs<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Df <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span> <span class="var"><span class="quoted"><span class="var">?th3</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_integral_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_componentwise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">⇒</span> real"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="main">(</span>frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_frechet_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Linear_Algebra.linear_componentwise<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> second_derivative_componentwise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nth_derivative <span class="numeral">2</span> <span class="free">f</span> <span class="free">a</span> <span class="free">v</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">⇒</span> real"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2 higher_differentiable_on.simps differentiable_on_openD
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2 higher_differentiable_on.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> differentiable_on_openD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Basis <span class="main">⟹</span>
         frechet_derivative
          <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="free">v</span> <span class="main">∙</span> <span class="bound">i</span> <span class="main">*</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">v</span> <span class="main">∙</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> frechet_derivative_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> differentiable_mult diff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> frechet_derivative_times<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frechet_derivative_const<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> frechet_derivative_componentwise<span class="main"><span class="main">[</span></span><span class="operator">OF</span> diff<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_transform_within_open_ext <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ S frechet_derivative_componentwise<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> d1<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> higher_differentiable_Taylor1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_normed_vector <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>banach"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hd<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_segment <span class="free">X</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> nth_derivative <span class="numeral">2</span> <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">H</span><span class="main">)</span> <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="free">X</span> <span class="main">+</span> nth_derivative <span class="main">1</span> <span class="free">f</span> <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">X</span> <span class="main">+</span> nth_derivative <span class="main">1</span> <span class="free">f</span> <span class="free">X</span> <span class="free">H</span> <span class="main">+</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_Taylor<span class="main">[</span><span class="operator">OF</span> _ hd cs<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2 i_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> differentiable_on_open_blinfunE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="free">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> <span class="skolem">f'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> differentiable_on_openD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_linear <span class="skolem">f'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_bounded_linear<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bf'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> blinfun_apply <span class="skolem">bf'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bounded_linear_Blinfun_apply<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bf'</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="bound">bf'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f'
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="skolem">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_blinfunI1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on <span class="free">X</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> Basis <span class="main">⟹</span> continuous_on <span class="free">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> blinfun_apply <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tendsto_componentwise1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c1_euclidean_blinfunE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span>real_normed_vector"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> Basis <span class="main">⟹</span> continuous_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">bf'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="free">bf'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">bf'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> blinfun_apply <span class="main">(</span><span class="free">bf'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_linear <span class="main">(</span><span class="free">f'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_derivative_bounded_linear that<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bf'</span></span> <span class="keyword2"><span class="keyword">where</span></span> bf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x</span> <span class="main">=</span> blinfun_apply <span class="main">(</span><span class="skolem">bf'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bchoice<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bounded_linear_Blinfun_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="skolem">bf'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> f_tendsto<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">n</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">f'</span> <span class="skolem">x</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> Basis"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_def that<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="skolem">bf'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_blinfunI1<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bf'<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> blinfun_apply <span class="main">(</span><span class="skolem">bf'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bf' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_Sigma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> Pi <span class="free">T</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>Sigma <span class="free">T</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">T</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    defined
    continuous_on_compose2<span class="main">[</span><span class="operator">OF</span>
      continuous_on_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">T</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> f_cont<span class="main"><span class="main">]</span></span>
      continuous_on_Pair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> continuous_on_id y_cont<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_Times_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">X</span> <span class="main">×</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">Y</span> <span class="main">×</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> continuous_on_compose2<span class="main">[</span><span class="operator">OF</span> that continuous_on_swap<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">×</span> <span class="free">Y</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta' product_swap<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leibniz_rule'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">fx</span> <span class="bound">x</span> <span class="bound">t</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"convex <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="free">fx</span> <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> Basis <span class="main">⟹</span> continuous_on <span class="main">(</span><span class="free">S</span> <span class="main">×</span> cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">fx</span> <span class="bound">x</span> <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">integrable_on</span> cbox <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>euclidean_space <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>euclidean_space"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fx1<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">fx</span> <span class="bound">x</span> <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> cbox <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> Basis"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_Sigma<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ c1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> fx2<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">fx</span> <span class="skolem">x</span> <span class="bound">t</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> Basis"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_Sigma<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ continuous_on_Times_swap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> that <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> cbox <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span> <span class="main">∧</span>
      blinfun_apply <span class="main">(</span><span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">fx</span> <span class="bound">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      continuous_on <span class="free">S</span> <span class="bound">f'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c1_euclidean_blinfunE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span> fx1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fx'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      fx'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="skolem">fx'</span> <span class="bound">t</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> blinfun_apply <span class="main">(</span><span class="skolem">fx'</span> <span class="bound">t</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">fx</span> <span class="bound">x</span> <span class="bound">t</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> continuous_on <span class="free">S</span> <span class="main">(</span><span class="skolem">fx'</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">S</span> <span class="main">×</span> cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">fx'</span> <span class="bound">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_blinfunI1<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> c1<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_eq<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fx' split_beta'<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> leibniz_rule<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">t</span><span class="main">.</span> <span class="skolem">fx'</span> <span class="bound">t</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">OF</span> fx'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i c <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹convex <span class="free">S</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span>integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">fx'</span> <span class="bound">t</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span>integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">fx'</span> <span class="bound">t</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> fx'xi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">fx'</span> <span class="bound">t</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">integrable_on</span> cbox <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> integrable_continuous<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_blinfunI1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fx' <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> fx2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blinfun_apply <span class="main">(</span>integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">fx'</span> <span class="bound">t</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xb</span><span class="main">.</span> <span class="free">fx</span> <span class="skolem">x</span> <span class="bound">xb</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> blinfun_apply_integral<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fx'xi<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> fx' <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> integral_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xb</span><span class="main">.</span> <span class="free">fx</span> <span class="skolem">x</span> <span class="bound">xb</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def differentiable_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> leibniz_rule'_interval <span class="main">=</span> leibniz_rule'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span><span class="main"><span class="main">::</span></span>ordered_euclidean_space"</span></span></span><span class="main">,</span>
    <span class="operator">unfolded</span> cbox_interval<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> leibniz_rule'_higher<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"convex <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">(</span><span class="free">S</span><span class="main">×</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="comment1">―‹this condition is actually too strong:
      it would suffice if higher partial derivatives (w.r.t. x) are continuous w.r.t. t.
      but it makes the statement short and no need to introduce new constants›</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>euclidean_space <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword1"><span class="command">using</span></span> c1
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integral_continuous_on_param<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="skolem">x</span> <span class="main">=</span> frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span>
    Suc.prems<span class="main">[</span><span class="operator">THEN</span> higher_differentiable_on_imp_continuous_on<span class="main">,</span> <span class="operator">THEN</span> continuous_on_compose2<span class="main">,</span>
      <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">,</span> <span class="skolem">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">,</span> <span class="operator">unfolded</span> split_beta' fst_conv snd_conv<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> prems<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xt</span><span class="main">.</span> <span class="bound">xt</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">×</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="bound">xt</span>"</span></span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">(</span><span class="free">S</span> <span class="main">×</span> cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">D</span> <span class="bound">x</span> <span class="main">(</span><span class="skolem">dx</span><span class="main">,</span> <span class="skolem">dt</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dx</span> <span class="skolem">dt</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps D_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> frechet_derivative_worksI<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> D_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">∈</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="skolem">D</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">::</span><span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Dx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">∈</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">dx</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="bound">dx</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> has_derivative_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p1 D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cD<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">S</span> <span class="main">×</span> cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_imp_continuous_on<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">v</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="keyword1">integrable_on</span> cbox <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_continuous<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> leibniz_rule'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹convex <span class="free"><span class="free">S</span></span>›</span></span></span> Dx cD fi<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> ihd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_openD<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ihd<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> at_within_open<span class="main">[</span><span class="operator">OF</span> that <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * ** <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> leibniz_rule'_higher_interval <span class="main">=</span> leibniz_rule'_higher<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">::</span>ordered_euclidean_space"</span></span><span class="main">,</span>
    <span class="operator">unfolded</span> cbox_interval<span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Smoothness›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">k_smooth_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"enat <span class="main">⇒</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>real_normed_vector<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_<span class="keyword1">-smooth'_on</span>"</span> <span class="main">[</span>1000<span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
 smooth_on_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1"><span class="free">-smooth_on</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> higher_differentiable_on <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">smooth_on</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∞</span><span class="keyword1">-smooth_on</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivative_is_smooth'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smooth_on_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> plus_1_eSuc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eSuc_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> enat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivative_is_smooth<span class="main">:</span> <span class="quoted"><span class="quoted">"smooth_on <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> smooth_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> derivative_is_smooth'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">∞</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_imp_continuous_on<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_imp_continuous_on<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smooth_on_def enat_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_imp_differentiable_on<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def Suc_ile_eq enat_0
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_imp_differentiable_on<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> smooth_on_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_open_Un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">T</span> <span class="free">f</span> <span class="main">⟹</span> open <span class="free">S</span> <span class="main">⟹</span> open <span class="free">T</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def higher_differentiable_on_open_Un<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_open_subsetsI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">T</span> <span class="main">∧</span> open <span class="bound">T</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="bound">T</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> smooth_on_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_open_subsetsI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_const<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def higher_differentiable_on_const<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_id<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def higher_differentiable_on_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_add_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span> <span class="main">⟹</span> open <span class="free">S</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="main">+</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def higher_differentiable_on_add plus_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> smooth_on_add <span class="main">=</span> smooth_on_add_fun<span class="main">[</span><span class="operator">unfolded</span> plus_fun_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> finite <span class="free">F</span> <span class="main">⟹</span> <span class="free">n</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def higher_differentiable_on_sum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bounded_bilinear<span class="main">)</span> smooth_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> no_matrix_mult
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main"><span class="free">**</span></span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def higher_differentiable_on<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_compose2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">T</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">`</span> <span class="free">U</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">U</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_compose <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">T</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_compose2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">T</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">f</span></span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> s <span class="main">=</span> bounded_bilinear.smooth_on
<span class="keyword1"><span class="command">lemmas</span></span> smooth_on_inner <span class="main">=</span> bounded_bilinear_inner<span class="main">[</span><span class="operator">THEN</span> s<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> smooth_on_scaleR <span class="main">=</span> bounded_bilinear_scaleR<span class="main">[</span><span class="operator">THEN</span> s<span class="main">]</span>
   <span class="keyword2"><span class="keyword">and</span></span> smooth_on_mult <span class="main">=</span> bounded_bilinear_mult<span class="main">[</span><span class="operator">THEN</span> s<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_divide<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span> <span class="main">⟹</span> open <span class="free">S</span> <span class="main">⟹</span><span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">/</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_normed_field"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def higher_differentiable_on_divide<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_scaleR_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span> <span class="main">⟹</span> open <span class="free">S</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scaleR_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_scaleR <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_uminus_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span> <span class="main">⟹</span> open <span class="free">S</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">-</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smooth_on_scaleR_fun<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> smooth_on_uminus <span class="main">=</span> smooth_on_uminus_fun<span class="main">[</span><span class="operator">unfolded</span> fun_Compl_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_minus_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span> <span class="main">⟹</span> open <span class="free">S</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="main">-</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_conv_add_uminus
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_add_fun<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_uminus_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> smooth_on_minus <span class="main">=</span> smooth_on_minus_fun<span class="main">[</span><span class="operator">unfolded</span> fun_diff_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_times_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span> <span class="main">⟹</span> open <span class="free">S</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_normed_algebra"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inverse <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_normed_field"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span><span class="main">_</span><span class="main">::</span>real_inner"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_norm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sqrt <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_sqrt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_frechet_derivative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∞</span><span class="keyword1">-smooth_on</span> UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∞</span><span class="keyword1">-smooth_on</span> UNIV <span class="free">f</span>"</span></span>
    <span class="comment1">―‹TODO: generalize›</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_frechet_derivativeI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> smooth_on_frechet_derivivative_comp <span class="main">=</span> smooth_on_compose2<span class="main">[</span><span class="operator">OF</span> smooth_on_frechet_derivative<span class="main">,</span> <span class="operator">unfolded</span> o_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_onD<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bounded_linear<span class="main">)</span> higher_differentiable_on<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps linear_continuous_on bounded_linear_axioms<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps frechet_derivative higher_differentiable_on_const<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> bounded_linear_axioms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bounded_linear_imp_differentiable<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bounded_linear<span class="main">)</span> smooth_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def higher_differentiable_on<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_snd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_snd_comp that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> higher_differentiable_on_fst_comp that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_sin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sin <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_sin<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_cos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cos <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cos<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_Taylor2E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∞</span><span class="keyword1">-smooth_on</span> UNIV <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">g</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Y</span><span class="main">.</span>
    <span class="free">f</span> <span class="bound">Y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">X</span> <span class="main">+</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="bound">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> Basis <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> Basis <span class="main">⟹</span> <span class="main">∞</span><span class="keyword1">-smooth_on</span> UNIV <span class="main">(</span><span class="free">g</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="comment1">―‹TODO: generalize›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"convex <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∞</span><span class="keyword1">-smooth_on</span> <span class="skolem">S</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="skolem">H</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> nth_derivative <span class="numeral">2</span> <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">H</span><span class="main">)</span> <span class="skolem">H</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">H</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d2</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">v'</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">H</span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">d2</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">x</span> <span class="skolem">H</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">H</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">g</span> <span class="skolem">H</span> <span class="bound">x</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">H</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="skolem">S</span> <span class="free">f</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hd<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> hd2 <span class="main">=</span> this <span class="quoted"><span class="quoted">‹open <span class="skolem">S</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> d2_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="skolem">S</span> <span class="main">(</span><span class="skolem">d2</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> hd2<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def numeral_2_eq_2 higher_differentiable_on.simps d2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span> continuous_on_compose2<span class="main">[</span><span class="operator">OF</span> d2_cont<span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> hdiff2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∞</span><span class="keyword1">-smooth_on</span> <span class="skolem">S</span> <span class="main">(</span><span class="skolem">d2</span> <span class="skolem">v</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">v'</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d2_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_frechet_derivivative_comp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_frechet_derivivative_comp<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def assms<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="skolem">Y</span> <span class="main">-</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">+</span> <span class="skolem">H</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_segment <span class="free">X</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹convex <span class="skolem">S</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closed_segment_subset<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="skolem">H</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="free">X</span> <span class="main">+</span> nth_derivative <span class="main">1</span> <span class="free">f</span> <span class="free">X</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">X</span> <span class="main">+</span> nth_derivative <span class="main">1</span> <span class="free">f</span> <span class="free">X</span> <span class="skolem">H</span> <span class="main">+</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="skolem">i</span> <span class="skolem">H</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="skolem">H</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> i_def
      <span class="keyword1"><span class="command">using</span></span> higher_differentiable_Taylor1<span class="main">[</span><span class="operator">OF</span> hd2 cs<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> i<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>

    <span class="keyword1"><span class="command">have</span></span> integrable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">H</span> <span class="bound">x</span> <span class="skolem">a</span> <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">H</span> <span class="bound">x</span> <span class="skolem">n</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> 
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">n</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_continuous_interval <span class="dynamic"><span class="dynamic">continuous_intros</span></span> closed_segment_subsetD
          cs <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> i_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="skolem">H</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="skolem">g</span> <span class="skolem">H</span> <span class="skolem">x</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">unfolding</span></span> i_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> second_derivative_componentwise<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd2<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closed_segment_subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cs<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> that<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def d2_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="skolem">i</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="skolem">g</span> <span class="skolem">H</span> <span class="bound">x</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> integral_spike<span class="main"><span class="main">[</span></span><span class="operator">OF</span> negligible_empty<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> i_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">g'</span> <span class="bound">i</span> <span class="bound">j</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left sum_distrib_right integral_sum integrable g'_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integral_mult_right<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> integral_mult_right<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="main">+</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">X</span> <span class="main">+</span> nth_derivative <span class="main">1</span> <span class="free">f</span> <span class="free">X</span> <span class="skolem">H</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="skolem">H</span> <span class="main">∙</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">H</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">g'</span> <span class="bound">i</span> <span class="bound">j</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">X</span> <span class="main">+</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">g'</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Y</span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">T</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span> <span class="main">1</span><span class="main">&lt;..&lt;</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="main">1</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> T_small<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">T</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">+</span> <span class="skolem">b</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">S</span> <span class="main">×</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> open_Times <span class="quoted"><span class="quoted">‹open <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">T</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smooth_on <span class="skolem">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">Y</span><span class="main">.</span> <span class="skolem">g'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">(</span><span class="bound">Y</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> Basis"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> Basis"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">unfolding</span></span> smooth_on_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> leibniz_rule'_higher_interval<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">S</span></span> <span class="main"><span class="main">×</span></span> <span class="skolem"><span class="skolem">T</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_mult <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> diff_conv_add_uminus<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_add<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_const<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> scaleR_minus1_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_scaleR<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_const<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_snd_comp<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_id<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_onD<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_compose2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hdiff2<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">T</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> T_small <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">⊆</span> <span class="skolem">T</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_Times smooth_on_add smooth_on_scaleR smooth_on_snd
        smooth_on_minus smooth_on_fst<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> smooth_on_Pair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span> n <span class="keyword1"><span class="command">unfolding</span></span> smooth_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">g</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>3<span class="main">)</span> n <span class="keyword1"><span class="command">unfolding</span></span> smooth_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_Pair <span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 1 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> smooth_on_Pair'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">S</span> <span class="main">×</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">T</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">::</span>euclidean_space<span class="main">⇒</span><span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">::</span>euclidean_space<span class="main">⇒</span><span class="main">_</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> <span class="free">f</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>3<span class="main">)</span> n <span class="keyword1"><span class="command">unfolding</span></span> smooth_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">T</span> <span class="free">g</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>4<span class="main">)</span> n <span class="keyword1"><span class="command">unfolding</span></span> smooth_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">(</span><span class="free">S</span> <span class="main">×</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="free">g</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> higher_differentiable_on_Pair'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 1 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diffeomorphism›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">diffeomorphism</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">⟷</span>
  <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1">-smooth_on</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1">-smooth_on</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="main">∧</span> homeomorphism <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diffeomorphism_imp_homeomorphism<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> <span class="free">s</span> <span class="free">t</span> <span class="free">p</span> <span class="free">p'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"homeomorphism <span class="free">s</span> <span class="free">t</span> <span class="free">p</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diffeomorphism_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diffeomorphismD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> <span class="free">S</span> <span class="free">T</span> <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> diffeomorphism_smoothD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">T</span> <span class="free">g</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> diffeomorphism_inverseD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> diffeomorphism_image_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diffeomorphism_def homeomorphism_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diffeomorphism_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">n</span> <span class="free">S</span> <span class="free">T</span> <span class="free">f</span> <span class="free">g</span> <span class="main">⟹</span> diffeomorphism <span class="free">n</span> <span class="free">T</span> <span class="free">U</span> <span class="free">h</span> <span class="free">k</span> <span class="main">⟹</span> open <span class="free">S</span> <span class="main">⟹</span> open <span class="free">T</span> <span class="main">⟹</span> open <span class="free">U</span> <span class="main">⟹</span>
    diffeomorphism <span class="free">n</span> <span class="free">S</span> <span class="free">U</span> <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">⇒</span><span class="main">_</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diffeomorphism_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_compose homeomorphism_compose<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diffeomorphism_add<span class="main">:</span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diffeomorphism_def homeomorphism_add <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_minus smooth_on_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diffeomorphism_scaleR<span class="main">:</span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that diffeomorphism_def homeomorphism_scaleR
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_minus smooth_on_scaleR<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Bump_Function">
<div class="head">
<h1>Theory Bump_Function</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bump Functions›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Bump_Function
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Smooth.html">Smooth</a>
    <span class="quoted">"<a href="../../HOL/HOL-Analysis/Weierstrass_Theorems.html">HOL-Analysis.Weierstrass_Theorems</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Construction›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> exp<span class="main">(</span><span class="main">-</span>inverse <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_nonpos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> f <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> exp_inv_limit_0_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> exp<span class="main">(</span><span class="main">-</span>inverse <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">exp</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_at_bot<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">uminus</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_uminus_at_bot_at_top<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_inverse_at_top_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inverse <span class="main">(</span><span class="bound">x</span> <span class="main">^</span> Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span>
  <span class="main">-</span> <span class="main">(</span>inverse <span class="main">(</span><span class="bound">t</span> <span class="main">^</span> Suc <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="bound">t</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> inverse <span class="main">(</span><span class="bound">t</span> <span class="main">^</span> Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_filter
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> eventuallyI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> exp_inv_limit_0_right_gen'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> inverse <span class="main">(</span><span class="bound">t</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> exp<span class="main">(</span>inverse <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_inv_limit_0_right
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> exp_minus inverse_eq_divide<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> df<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inverse <span class="main">(</span><span class="bound">x</span> <span class="main">^</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> 
    <span class="main">-</span> <span class="main">(</span>inverse <span class="main">(</span><span class="bound">t</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_filter
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> eventuallyI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> exp <span class="main">(</span>inverse <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span>
    <span class="main">-</span> <span class="main">(</span>exp <span class="main">(</span>inverse <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> eventuallyI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lhopital_right_0_at_top <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ df dg<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">exp</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_at_top<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_inverse_at_top_right<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_filter<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">+</span></span> real <span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span>inverse <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">^</span></span> <span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">/</span></span> exp <span class="main"><span class="main">(</span></span>inverse <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps tendsto_mult_right_zero <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_filter<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exp_inv_limit_0_right_gen<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> exp<span class="main">(</span><span class="main">-</span>inverse <span class="bound">t</span><span class="main">)</span> <span class="main">/</span> <span class="bound">t</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exp_inv_limit_0_right_gen'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Lim_cong_within divide_inverse exp_minus<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> f_limit_0_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_at_right_less<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> exp<span class="main">(</span><span class="main">-</span>inverse <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> f <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">eventually_elim</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> exp<span class="main">(</span><span class="main">-</span>inverse <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exp_inv_limit_0_right<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Lim_transform_eventually<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_limit_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> _ f_limit_0_right
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_split_at_real<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_left <span class="main">0</span><span class="main">.</span> <span class="main">0</span> <span class="main">=</span> f <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def eventually_at_filter<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Lim_transform_eventually<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_tendsto<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f <span class="main">⤏</span> f <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_limit_0 f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_tendstoD<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">=</span> f <span class="bound">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">eventually_elim</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Lim_transform_eventually<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_tendstoD<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> exp<span class="main">(</span><span class="main">-</span>inverse <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> f <span class="bound">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">eventually_elim</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> exp <span class="main">(</span><span class="main">-</span> inverse <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">─</span><span class="free">x</span><span class="main">→</span> f <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Lim_transform_eventually<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_continuous<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> f"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f_tendsto continuous_on continuous_on_subset subset_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_real_polynomial_function<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"real_polynomial_function <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> linear_continuous_on<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_nth_derivative_is_poly<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span> f <span class="free">k</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> real_polynomial_function <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> nth_derivative <span class="free">k</span> f <span class="bound">t</span> <span class="main">1</span> <span class="main">=</span> <span class="bound">p</span> <span class="bound">t</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> exp<span class="main">(</span><span class="main">-</span>inverse <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps f_continuous<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> fk<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span> f <span class="skolem">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"real_polynomial_function <span class="skolem">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">t</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="bound">t</span> <span class="main">/</span> <span class="bound">t</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span> inverse <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> p'1<span class="main">:</span> <span class="quoted"><span class="quoted">"real_polynomial_function <span class="skolem">p'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p'2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">has_real_derivative</span> <span class="main">(</span><span class="skolem">p'</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_real_derivative_polynomial_function<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> p1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rp</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="skolem">p'</span> <span class="skolem">t</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">t</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">have</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"real_polynomial_function <span class="skolem">rp</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> real_polynomial_function.intros<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span> real_polynomial_function_diff
        p1 p'1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> fk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="skolem">t</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span><span class="main">)</span>
    <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span>
        <span class="skolem">rp</span> <span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span>inverse <span class="skolem">t</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">t</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> p'2 that <span class="keyword1"><span class="command">have</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">(*)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> at_within_open<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span>"</span></span><span class="main"><span class="main">]</span></span> has_field_derivative_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">t</span> <span class="main">/</span> <span class="bound">t</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span> inverse <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">*</span> <span class="skolem">rp</span> <span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span>inverse <span class="skolem">t</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">t</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> dp ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> rp_def power2_eq_square<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_pred mult_is_0 neq0_conv power_Suc zero_neq_numeral<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">has_derivative</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">*</span> <span class="skolem">rp</span> <span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span>inverse <span class="skolem">t</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">t</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_transform_within<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ zero_less_one<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> that p2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">has_derivative</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">*</span> <span class="skolem">rp</span> <span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span>inverse <span class="skolem">t</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">t</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> at_within_open<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> frechet_derivative_at'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> hdS<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span> f <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> higher_differentiable_on_real_Suc'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fk fk' frechet_derivative_nth_derivative_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> continuous_on_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fk'<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> p'1 p1 rp
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> continuous_on_real_polynomial_function<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="skolem">t</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">rp</span> <span class="skolem">t</span> <span class="main">/</span> <span class="skolem">t</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span> inverse <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="skolem">t</span> <span class="main">1</span> <span class="main">=</span> frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frechet_derivative_nth_derivative_commute<span class="main">)</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">rp</span> <span class="skolem">t</span> <span class="main">/</span> <span class="skolem">t</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span>inverse <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fk'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">t</span></span> <span class="main"><span class="main">&gt;</span></span> <span class="main"><span class="main">0</span></span>›</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_has_derivative_at_neg<span class="main">:</span>
  <span class="quoted"><span class="quoted">" <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span>f <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_transform_within_open<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..&lt;</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_differentiable_at_neg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> f <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f_has_derivative_at_neg
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_f_at_neg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="main">0</span><span class="main">}</span> <span class="main">⟹</span> frechet_derivative f <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at'<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> f_has_derivative_at_neg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_nth_derivative_lt_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">{..&lt;</span><span class="main">0</span><span class="main">}</span> f <span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span><span class="main">0</span><span class="main">.</span> nth_derivative <span class="free">k</span> f <span class="bound">t</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> rewr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="main">0</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps f_def rewr
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lessThan_iff
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> continuous_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> differentiable_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..&lt;</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_fun_def frechet_derivative_const Suc.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> that Suc.IH
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> frechet_derivative_transform_within_open<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{..&lt;</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frechet_derivative_zero_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps f_differentiable_at_neg
        frechet_derivative_f_at_neg zero_fun_def
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> frechet_derivative_nth_derivative_commute
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> lessThan_iff
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> higher_differentiable_on_const
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> higher_differentiable_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> netlimit_at_left<span class="main">:</span> <span class="quoted"><span class="quoted">"netlimit <span class="main">(</span>at_left <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_ident_at<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> netlimit_at_right<span class="main">:</span> <span class="quoted"><span class="quoted">"netlimit <span class="main">(</span>at_right <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_ident_at<span class="main">)</span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> has_derivative_split_at<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="keyword1">has_derivative</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="keyword1">has_derivative</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span>at_left <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="keyword1">has_derivative</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span>at_right <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> has_derivative_def netlimit_at netlimit_at_right netlimit_at_left
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> filterlim_split_at<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> has_derivative_at_left_at_right'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="keyword1">has_derivative</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="keyword1">has_derivative</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="main">{..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="keyword1">has_derivative</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="free">x</span><span class="main">..}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_split_at<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_subset<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_subset<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> real_polynomial_function_tendsto<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">⤏</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"real_polynomial_function <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bounded_linear.tendsto<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_nth_derivative_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"higher_differentiable_on UNIV f <span class="free">k</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≤</span><span class="main">0</span><span class="main">.</span> nth_derivative <span class="free">k</span> f <span class="bound">t</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> real_polynomial_function <span class="bound">p</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> nth_derivative <span class="free">k</span> f <span class="bound">t</span> <span class="main">1</span> <span class="main">=</span> <span class="bound">p</span> <span class="bound">t</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> exp<span class="main">(</span><span class="main">-</span>inverse <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> higher_differentiable_on.simps f_continuous<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.IH <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pk</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"higher_differentiable_on UNIV f <span class="skolem">k</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> nth_derivative <span class="skolem">k</span> f <span class="bound">t</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"real_polynomial_function <span class="skolem">pk</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> nth_derivative <span class="skolem">k</span> f <span class="bound">t</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">pk</span> <span class="bound">t</span> <span class="main">/</span> <span class="bound">t</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span> inverse <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> f_nth_derivative_lt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span><span class="main">]</span>
    local.f_nth_derivative_is_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> neg<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">{..&lt;</span><span class="main">0</span><span class="main">}</span> f <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> neg0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span><span class="main">0</span><span class="main">.</span> nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="bound">t</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span> f <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"real_polynomial_function <span class="skolem">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="bound">t</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="bound">t</span> <span class="main">/</span> <span class="bound">t</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span> inverse <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> at_within_eq_at_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span> <span class="main">=</span> at_right <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_eq_iff eventually_at_filter <span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">&lt;..}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">at</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span> <span class="main">≠</span> bot"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> at_within_eq_bot_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> k_th_has_derivative_at_left<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span> <span class="keyword1">within</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_transform_within<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ zero_less_one<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> k_th_has_derivative_at_right<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_transform_within<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
          f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x'</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">if</span></span> <span class="bound"><span class="bound">x'</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">0</span></span> <span class="keyword1"><span class="keyword1">then</span></span> <span class="main"><span class="main">0</span></span> <span class="keyword1"><span class="keyword1">else</span></span> <span class="skolem"><span class="skolem">pk</span></span> <span class="bound"><span class="bound">x'</span></span> <span class="main"><span class="main">/</span></span> <span class="bound"><span class="bound">x'</span></span> <span class="main"><span class="main">^</span></span> <span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">*</span></span> <span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">*</span></span> exp <span class="main"><span class="main">(</span></span><span class="main"><span class="main">-</span></span> inverse <span class="bound"><span class="bound">x'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ zero_less_one<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> has_derivative_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Lim_ident_at<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">pk</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span>exp <span class="main"><span class="main">(</span></span><span class="main"><span class="main">-</span></span> inverse <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">/</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">^</span></span> <span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">*</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> real_polynomial_function_tendsto<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> tendsto_eq_rhs<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> at_within_eq_at_right<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_inv_limit_0_right_gen<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_at_filter <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> IH<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> k_th_has_derivative<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_at_left_at_right'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> k_th_has_derivative_at_left<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> k_th_has_derivative_at_right<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> nth_Suc_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="main">0</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frechet_derivative_nth_derivative_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> frechet_derivative_at'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> k_th_has_derivative<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on UNIV f <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_eq_continuous_within
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">real</span>
      <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"isCont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> at_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">at</span> <span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="main">{..&lt;</span><span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> at_within_open<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="main">0</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> at_eq
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_transform_within<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ zero_less_one<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> neg0 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> at_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> at_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">at</span> <span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> at_within_open<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> at_eq
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_transform_within<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ zero_less_one<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> p 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span>
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> continuous_real_polymonial_function continuous_at_imp_continuous_within<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_left <span class="main">0</span><span class="main">.</span> <span class="main">0</span> <span class="main">=</span> nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="bound">x</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> neg0
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_filter<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Lim_transform_eventually<span class="main">)</span> 
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span> inverse <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">0</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> real_polynomial_function_tendsto<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exp_inv_limit_0_right_gen<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span> inverse <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            nth_derivative <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> f <span class="bound">x</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> p
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_filter<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_def nth_Suc_zero 3 filterlim_split_at
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nth_derivative.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nth_derivative <span class="skolem">k</span> f <span class="bound">x</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">consider</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> k_th_has_derivative <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">with</span></span> neg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> higher_differentiable_on_real_Suc'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">with</span></span> pos <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> higher_differentiable_on_real_Suc'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"higher_differentiable_on UNIV f <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> higher_differentiable_on_real_Suc'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> open_UNIV<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_real_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_smooth_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> f"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f_higher_differentiable_on<span class="main">:</span> <span class="quoted"><span class="quoted">"higher_differentiable_on <span class="free">S</span> f <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f_nth_derivative_cases
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_def higher_differentiable_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subset_UNIV<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_compose_smooth_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> f <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smooth_on_compose<span class="main">[</span><span class="operator">OF</span> f_smooth_on that open_UNIV subset_UNIV<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_pos_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_eq_zero_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cutoff function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> f <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>f <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">+</span> f <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> denominator_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span> f <span class="main">(</span><span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def add_pos_pos<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> denominator_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span> f <span class="main">(</span><span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> denominator_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> h_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> h <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"h <span class="free">t</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def f_nonneg denominator_pos<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> h_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> h <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> h_less_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">t</span> <span class="main">⟹</span> h <span class="free">t</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def f_pos_iff denominator_pos<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> h_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"h <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> h_eq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"h <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def f_eq_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> h_compose_smooth_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> h <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> denominator_nonzero
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_divide f_compose_smooth_on smooth_on_minus smooth_on_add
      that<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bump function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">H</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">::</span>real_inner <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> h <span class="main">(</span>norm <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> H <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"H <span class="free">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def h_range<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_eq_one<span class="main">:</span> <span class="quoted"><span class="quoted">"H <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> cball <span class="main">0</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def h_eq_1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"H <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ball <span class="main">0</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def h_pos<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_eq_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"H <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> ball <span class="main">0</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def h_eq_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_neq_zeroD<span class="main">:</span> <span class="quoted"><span class="quoted">"H <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> ball <span class="main">0</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H_eq_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> H_smooth_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> UNIV H"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>ball <span class="main">0</span> <span class="main">1</span><span class="main">)</span> H"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_eq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>UNIV <span class="main">-</span> cball <span class="main">0</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> H"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> h_compose_smooth_on smooth_on_norm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>ball <span class="main">0</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>UNIV <span class="main">-</span> cball <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ball <span class="main">0</span> <span class="main">1</span> <span class="main">∪</span> <span class="main">(</span>UNIV <span class="main">-</span> cball <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem_ball<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> smooth_on_open_Un<span class="main">[</span><span class="operator">OF</span> 1 2 O<span class="main">,</span> <span class="operator">unfolded</span> *<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_subset<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_compose_smooth_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> H <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smooth_on_compose<span class="main">[</span><span class="operator">OF</span> H_smooth_on that<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Chart">
<div class="head">
<h1>Theory Chart</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Charts›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Chart
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Analysis_More.html">Analysis_More</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A chart on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span> is a homeomorphism from an open subset of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span> to an open subset
  of some Euclidean space <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span>. Here <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d'›</span></span></span></span> are open subsets of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span>, respectively,
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f: d → d'›</span></span></span></span> is the mapping, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f': d' → d›</span></span></span></span> is the inverse mapping.›</span></span>
<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="quoted">topological_space</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span><span class="quoted">euclidean_space</span><span class="main">)</span> chart <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">d</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">,</span> <span class="bound">d'</span><span class="main">::</span><span class="tfree">'e</span> set<span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span><span class="main">.</span>
    open <span class="bound">d</span> <span class="main">∧</span> open <span class="bound">d'</span> <span class="main">∧</span> homeomorphism <span class="bound">d</span> <span class="bound">d'</span> <span class="bound">f</span> <span class="bound">f'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">{}</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">{}</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> undefined<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> undefined<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_chart

<span class="keyword1"><span class="command">lift_definition</span></span> apply_chart<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>topological_space<span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span>"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">d'</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion</span> <span class="quoted">apply_chart</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">lift_definition</span></span> inv_chart<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>topological_space<span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">d'</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span><span class="main">.</span> <span class="bound">f'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> domain<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>topological_space<span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">d'</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span><span class="main">.</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> codomain<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>topological_space<span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart <span class="main">⇒</span> <span class="tfree">'e</span> set"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">d'</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span><span class="main">.</span> <span class="bound">d'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_domain<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>domain <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> open_codomain<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> chart_homeomorphism<span class="main">:</span> <span class="quoted"><span class="quoted">"homeomorphism <span class="main">(</span>domain <span class="free">c</span><span class="main">)</span> <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span>inv_chart <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> at_within_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> domain <span class="free">c</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> at_within_open<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that open_domain<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> at_within_codomain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> codomain <span class="free">c</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> codomain <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> at_within_open<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that open_codomain<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  chart_in_codomain<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="free">x</span> <span class="main">∈</span> codomain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv_chart_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span> <span class="main">⟹</span> inv_chart <span class="free">c</span> <span class="main">(</span><span class="free">c</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv_chart_in_domain<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> codomain <span class="free">c</span> <span class="main">⟹</span> inv_chart <span class="free">c</span> <span class="free">y</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> chart_inverse_inv_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> codomain <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">(</span>inv_chart <span class="free">c</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> image_domain_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c</span><span class="main">)</span> <span class="main">=</span> codomain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv_image_codomain_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_chart <span class="free">c</span> <span class="main">`</span> <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span> <span class="main">=</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> continuous_on_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>domain <span class="free">c</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> continuous_on_codomain<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span> <span class="main">(</span>inv_chart <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chart_homeomorphism<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chart_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"domain <span class="free">c</span> <span class="main">=</span> domain <span class="free">d</span>"</span></span>
    <span class="quoted"><span class="quoted">"codomain <span class="free">c</span> <span class="main">=</span> codomain <span class="free">d</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">d</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> inv_chart <span class="free">c</span> <span class="bound">x</span> <span class="main">=</span> inv_chart  <span class="free">d</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> continuous_on_chart<span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span>
  continuous_on_compose2<span class="main">[</span><span class="operator">OF</span> continuous_on_domain<span class="main">]</span>
  continuous_on_compose2<span class="main">[</span><span class="operator">OF</span> continuous_on_codomain<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_apply_chart<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">)</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_at_imp_continuous_within<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> continuous_on_domain<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> that at_within_domain<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_eq_continuous_within<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_inv_chart<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>inv_chart <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> codomain <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_at_imp_continuous_within<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> continuous_on_codomain<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> that at_within_codomain<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_eq_continuous_within<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> apply_chart_tendsto<span class="main">[</span><span class="operator">tendsto_intros</span><span class="main">]</span> <span class="main">=</span> isCont_tendsto_compose<span class="main">[</span><span class="operator">OF</span> continuous_apply_chart<span class="main">,</span> <span class="operator">rotated</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> inv_chart_tendsto<span class="main">[</span><span class="operator">tendsto_intros</span><span class="main">]</span> <span class="main">=</span> isCont_tendsto_compose<span class="main">[</span><span class="operator">OF</span> continuous_inv_chart<span class="main">,</span> <span class="operator">rotated</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_within_compose2'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">within</span> <span class="free">t</span><span class="main">)</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">`</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">t</span> <span class="main">⟹</span>
    continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">s</span><span class="main">)</span> <span class="free">f</span> <span class="main">⟹</span>
    continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_within_compose2 continuous_within_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> continuous_chart<span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span>
  continuous_within_compose2'<span class="main">[</span><span class="operator">OF</span> continuous_apply_chart<span class="main">]</span>
  continuous_within_compose2'<span class="main">[</span><span class="operator">OF</span> continuous_inv_chart<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_chart_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">s</span> <span class="main">(</span>apply_chart <span class="free">c</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">s</span> <span class="main">⊆</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">s</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">s</span> <span class="main">(</span>inv_chart <span class="free">c</span> <span class="keyword1">o</span> apply_chart <span class="free">c</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> continuous_on_chart<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span>inv_chart <span class="free">c</span> <span class="keyword1">o</span> apply_chart <span class="free">c</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_chart_inv'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>apply_chart <span class="free">c</span> <span class="main">`</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> inv_chart <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">s</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">s</span> <span class="main">(</span>apply_chart <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms continuous_on_domain continuous_on_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">s</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> inv_chart <span class="free">c</span> <span class="keyword1">o</span> apply_chart <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_compose<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> inv_chart <span class="free">c</span> <span class="keyword1">o</span> apply_chart <span class="free">c</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_apply_chart<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>apply_chart <span class="free">f</span><span class="main">)</span> <span class="main">(</span>domain <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_on_inverseI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"inv_chart <span class="free">f</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> apply_chart_Int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">`</span> <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> domain <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> domain <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_apply_chart that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_image_Int<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chart_image_eq_vimage<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">`</span> <span class="free">X</span> <span class="main">=</span> inv_chart <span class="free">c</span> <span class="main">-`</span> <span class="free">X</span> <span class="main">∩</span> codomain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> open_chart_image<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">c</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> domain <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">`</span> <span class="free">X</span> <span class="main">=</span> inv_chart <span class="free">c</span> <span class="main">-`</span> <span class="free">X</span> <span class="main">∩</span> codomain <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chart_image_eq_vimage<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> continuous_on_codomain continuous_on_open_vimage open_codomain<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_inv_chart_image<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>inv_chart <span class="free">c</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> codomain <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_chart <span class="free">c</span> <span class="main">`</span> <span class="free">X</span> <span class="main">=</span> <span class="free">c</span> <span class="main">-`</span> <span class="free">X</span> <span class="main">∩</span> domain <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> image_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> continuous_on_domain continuous_on_open_vimage open_domain<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_UNIV_imp_open_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"homeomorphism UNIV UNIV <span class="free">p</span> <span class="free">p'</span> <span class="main">⟹</span> open <span class="free">f'</span> <span class="main">⟹</span> open <span class="main">(</span><span class="free">p</span> <span class="main">`</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> homeomorphism_imp_open_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> U<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Restriction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"homeomorphism <span class="main">(</span><span class="free">a</span> <span class="main">∩</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">∩</span> <span class="free">f'</span> <span class="main">-`</span> <span class="free">s</span><span class="main">)</span> <span class="free">f</span> <span class="free">f'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"homeomorphism <span class="free">a</span> <span class="free">b</span> <span class="free">f</span> <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> continuous_on_subset <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> restrict_chart<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>t2_space<span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">d'</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> open <span class="bound">S</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">d</span> <span class="main">∩</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">d'</span> <span class="main">∩</span> <span class="bound">f'</span> <span class="main">-`</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_continuous_vimage' homeomorphism_restrict
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> homeomorphism_cont2 homeomorphism_cont1 <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_chart_restrict_chart<span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_chart <span class="free">X</span> <span class="main">(</span>restrict_chart <span class="free">Y</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> restrict_chart <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> domain_restrict_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">S</span> <span class="main">⟹</span> domain <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> domain <span class="free">c</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> domain_restrict_chart_if<span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> open <span class="free">S</span> <span class="keyword1">then</span> domain <span class="free">c</span> <span class="main">∩</span> <span class="free">S</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> codomain_restrict_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">S</span> <span class="main">⟹</span> codomain <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> codomain <span class="free">c</span> <span class="main">∩</span> inv_chart <span class="free">c</span> <span class="main">-`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> codomain_restrict_chart_if<span class="main">:</span> <span class="quoted"><span class="quoted">"codomain <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> open <span class="free">S</span> <span class="keyword1">then</span> codomain <span class="free">c</span> <span class="main">∩</span> inv_chart <span class="free">c</span> <span class="main">-`</span> <span class="free">S</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> apply_chart_restrict_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_chart <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> apply_chart <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv_chart_restrict_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_chart <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> inv_chart <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composition›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> compose_chart<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">⇒</span><span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">⇒</span><span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>topological_space<span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">d'</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> homeomorphism UNIV UNIV <span class="bound">p</span> <span class="bound">p'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">p</span> <span class="main">`</span> <span class="bound">d'</span><span class="main">,</span> <span class="bound">p</span> <span class="keyword1">o</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span> <span class="keyword1">o</span> <span class="bound">p'</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> homeomorphism_UNIV_imp_open_map homeomorphism_compose homeomorphism_of_subsets<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compose_chart_apply_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_chart <span class="main">(</span>compose_chart <span class="free">p</span> <span class="free">p'</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">o</span> apply_chart <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> compose_chart_inv_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_chart <span class="main">(</span>compose_chart <span class="free">p</span> <span class="free">p'</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> inv_chart <span class="free">c</span> <span class="keyword1">o</span> <span class="free">p'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> domain_compose_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span>compose_chart <span class="free">p</span> <span class="free">p'</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> codomain_compose_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"codomain <span class="main">(</span>compose_chart <span class="free">p</span> <span class="free">p'</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">`</span> codomain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"homeomorphism UNIV UNIV <span class="free">p</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Topological_Manifold">
<div class="head">
<h1>Theory Topological_Manifold</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Topological Manifolds›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Topological_Manifold
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Chart.html">Chart</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of topological manifolds. Existence of locally finite cover.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defintition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define topological manifolds as a second-countable Hausdorff space, where
  every point in the carrier set has a neighborhood that is homeomorphic to an open
  subset of the Euclidean space. Here topological manifolds are specified by a set
  of charts, and the carrier set is simply defined to be the union of the domain of
  the charts.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> manifold <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">charts</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>second_countable_topology<span class="main">,</span> t2_space<span class="main">}</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">carrier</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>domain <span class="main">`</span> <span class="free">charts</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_carrier<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open carrier"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrier_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> carrierE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrier_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> domain_subset_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="free">c</span> <span class="main">⊆</span> carrier"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrier_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_domain_in_carrier<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">charts</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrier_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Existence of locally finite cover›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every point has a precompact neighborhood.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> precompact_neighborhoodE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="free">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="free">C</span> <span class="main">⊆</span> carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> carrierE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="free">x</span> <span class="main">∈</span> codomain <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> open_contains_cball<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"codomain <span class="skolem">c</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"cball <span class="main">(</span>apply_chart <span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">⊆</span> codomain <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> e'<span class="main">:</span> <span class="quoted"><span class="quoted">"ball <span class="main">(</span>apply_chart <span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">⊆</span> codomain <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem_ball<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> inv_chart <span class="skolem">c</span> <span class="main">`</span> ball <span class="main">(</span><span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> C_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"apply_chart <span class="skolem">c</span> <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> compact<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>inv_chart <span class="skolem">c</span> <span class="main">`</span> cball <span class="main">(</span>apply_chart <span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> compact_continuous_image continuous_on_chart<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> closure_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="skolem">C</span> <span class="main">⊆</span> inv_chart <span class="skolem">c</span> <span class="main">`</span> cball <span class="main">(</span>apply_chart <span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closure_minimal<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def mem_ball<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compact_imp_closed<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> compact<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="skolem">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> compact_if_closed_subset_of_compact<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"inv_chart <span class="skolem"><span class="skolem">c</span></span> <span class="main"><span class="main">`</span></span> cball <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">c</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">e</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compact<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closure_subset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closure <span class="skolem">C</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closure_subset c e
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There exists a covering of the carrier by precompact sets.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> precompact_open_coverE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">U</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat<span class="main">⇒</span><span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> carrier"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> open <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> compact <span class="main">(</span>closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> closure <span class="main">(</span><span class="free">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> carrier"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">{}</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">b</span> <span class="main">∧</span> open <span class="bound">b</span> <span class="main">∧</span> compact <span class="main">(</span>closure <span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> closure <span class="bound">b</span> <span class="main">⊆</span> carrier"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> precompact_neighborhoodE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">balls</span></span> <span class="keyword2"><span class="keyword">where</span></span> balls<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">balls</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> open <span class="main">(</span><span class="skolem">balls</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> compact <span class="main">(</span>closure <span class="main">(</span><span class="skolem">balls</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> closure <span class="main">(</span><span class="skolem">balls</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?balls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">balls</span> <span class="main">`</span> carrier"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?balls</span> <span class="main">⟹</span> open <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> balls<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Lindelof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?balls</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ℱ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ℱ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ℱ'</span> <span class="main">⊆</span> <span class="var">?balls</span>"</span></span> <span class="quoted"><span class="quoted">"countable <span class="skolem">ℱ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">ℱ'</span> <span class="main">=</span> <span class="main">⋃</span><span class="var">?balls</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ℱ'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ℱ' balls <span class="quoted"><span class="quoted">‹carrier <span class="main">≠</span> <span class="main">{}</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> from_nat_into <span class="skolem">ℱ'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> into_range_balls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="var">?balls</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"from_nat_into <span class="skolem">ℱ'</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">ℱ'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> from_nat_into<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ℱ'</span> <span class="main">⊆</span> <span class="var">?balls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> U_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">U</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="main">(</span><span class="skolem">U</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">U</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> balls into_range_balls<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="skolem">i</span> <span class="main">⊆</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> closure_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> carrier"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">U</span> <span class="main">_</span> <span class="main">⊆</span> carrier›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">balls</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span> ℱ' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> <span class="skolem">ℱ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> from_nat_into_surj<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹countable <span class="skolem">ℱ'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">F</span> <span class="main">∈</span> <span class="skolem">ℱ'</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There exists a locally finite covering of the carrier by precompact sets.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> precompact_locally_finite_open_coverE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">W</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat<span class="main">⇒</span><span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="free">W</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> open <span class="main">(</span><span class="free">W</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> compact <span class="main">(</span>closure <span class="main">(</span><span class="free">W</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> closure <span class="main">(</span><span class="free">W</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="quoted"><span class="quoted">"locally_finite_on carrier UNIV <span class="free">W</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> precompact_open_coverE <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">.</span> <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> carrier"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> open <span class="main">(</span><span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> compact <span class="main">(</span>closure <span class="main">(</span><span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> closure <span class="main">(</span><span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">V</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span>
    <span class="main">(</span>open <span class="main">(</span><span class="bound">V</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span>
    compact <span class="main">(</span>closure <span class="main">(</span><span class="bound">V</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="skolem">U</span> <span class="bound">j</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="bound">j</span> <span class="main">∧</span>
    closure <span class="main">(</span><span class="bound">V</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⊆</span> carrier<span class="main">)</span> <span class="main">∧</span>
    closure <span class="main">(</span><span class="bound">V</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">V</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">V</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">V</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="bound">V</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dependent_nat_choice<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="main">0</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">n</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closure <span class="skolem">X</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> compactE_image<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">UNIV</span> <span class="quoted"><span class="skolem">U</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹open <span class="main">(</span><span class="skolem">U</span> <span class="main">_</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹closure <span class="skolem">X</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⊆</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="skolem">X</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span><span class="skolem">M</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="skolem">n</span> <span class="skolem">X</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">U</span></span> <span class="main"><span class="main">(</span></span>Suc <span class="skolem"><span class="skolem">n</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⋃</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">∈</span></span><span class="skolem"><span class="skolem">M</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> impI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">U</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">U</span> <span class="main">`</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> U<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="main">(</span><span class="skolem">U</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">U</span> <span class="main">`</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">M</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closure_Union <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> U<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">U</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">U</span> <span class="main">`</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">U</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">U</span> <span class="main">`</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
        <span class="keyword1"><span class="command">using</span></span> U <span class="quoted"><span class="quoted">‹finite <span class="skolem">M</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closure_Union<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closure <span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">U</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span><span class="skolem">M</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span> V<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> open <span class="main">(</span><span class="skolem">V</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> compact <span class="main">(</span>closure <span class="main">(</span><span class="skolem">V</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">j</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="bound">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> V_mono_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">j</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> V_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="skolem">l</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> V_mono_Suc that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lift_Suc_mono_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> V_cover<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">V</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">V</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> V<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="skolem">V</span> <span class="main">`</span> UNIV<span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="skolem">V</span> <span class="skolem">j</span> <span class="keyword1">else</span> <span class="skolem">V</span> <span class="skolem">j</span> <span class="main">-</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="main">(</span><span class="skolem">W</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> compact_if_closed_subset_of_compact<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"closure <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">V</span></span> <span class="skolem"><span class="skolem">j</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> V<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closure_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> V<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> V<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> open_W<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">W</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def V<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> W_cover<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">W</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">V</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that V_cover
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> ex<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> k2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">k</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k2 that V<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">from</span></span> not_less_Least<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> k_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> k_def<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> k
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> W_eq_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> W_cover <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> carrier"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> V_cover<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> W_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="skolem">W</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">V</span> <span class="skolem">k</span> <span class="main">-</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">l</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">l</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> V_mono<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> less <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">arith</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"locally_finite_on carrier UNIV <span class="skolem">W</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_on_open_coverI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">W</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> W_eq_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">W</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_W<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">W</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">..</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">W</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> "</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">l</span> <span class="main">∩</span> <span class="skolem">W</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&gt;</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">-</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">k</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">..</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> W_disjoint<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> l
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">from</span></span> W_disjoint<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> l
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>finite_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span>UNIV <span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">W</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">W</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> V closure_mono
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Diff_subset subsetD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> open <span class="main">(</span><span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> compact <span class="main">(</span>closure <span class="main">(</span><span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> closure <span class="main">(</span><span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="quoted"><span class="quoted">"locally_finite_on carrier UNIV <span class="skolem">W</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Differentiable_Manifold">
<div class="head">
<h1>Theory Differentiable_Manifold</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Differentiable/Smooth Manifolds›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Differentiable_Manifold
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Smooth.html">Smooth</a>
    <a href="Topological_Manifold.html">Topological_Manifold</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Smooth compatibility›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smooth_compat</span><span class="main">::</span><span class="quoted"><span class="quoted">"enat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>topological_space<span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space<span class="main">)</span>chart<span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span>chart<span class="main">⇒</span>bool"</span></span>
  <span class="main">(</span><span class="quoted">"_<span class="keyword1">-smooth'_compat</span>"</span> <span class="main">[</span>1000<span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">smooth_compat</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">⟷</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">`</span> <span class="main">(</span>domain <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∩</span> domain <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">∘</span> inv_chart <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">`</span> <span class="main">(</span>domain <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∩</span> domain <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∘</span> inv_chart <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_D1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c1</span> <span class="main">∩</span> domain <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c1</span> <span class="main">∩</span> domain <span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_chart_image<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c1</span> <span class="main">∩</span> domain <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_D2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c2</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c1</span> <span class="main">∩</span> domain <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c1</span> <span class="main">∘</span> inv_chart <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">c2</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c1</span> <span class="main">∩</span> domain <span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_chart_image<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c2</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c1</span> <span class="main">∩</span> domain <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c1</span> <span class="main">∘</span> inv_chart <span class="free">c2</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smooth_compat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> smooth_on_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_def inf_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_restrict_chartI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_def domain_restrict_chart_if <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> smooth_on_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_restrict_chartI2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c'</span> <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c'</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smooth_compat_restrict_chartI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">]</span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_restrict_chartD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"domain <span class="free">c1</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">⟹</span> open <span class="free">U</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="main">(</span>restrict_chart <span class="free">U</span> <span class="free">c2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_def domain_restrict_chart_if <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> smooth_on_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_restrict_chartD2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"domain <span class="free">c1</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">⟹</span> open <span class="free">U</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="main">(</span>restrict_chart <span class="free">U</span> <span class="free">c2</span><span class="main">)</span> <span class="free">c1</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c2</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smooth_compat_restrict_chartD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">c2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_def smooth_on_le<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C^k›</span></span></span></span>-Manifold›</span></span>

<span class="keyword1"><span class="command">locale</span></span> c_manifold <span class="main">=</span> manifold <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span><span class="main">::</span><span class="quoted">enat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pairwise_compat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">∈</span> <span class="free">charts</span> <span class="main">⟹</span> <span class="free">c2</span> <span class="main">∈</span> <span class="free">charts</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Atlas›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atlas</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chart set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atlas</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> domain <span class="bound">c</span> <span class="main">⊆</span> carrier <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c'</span> <span class="main">∈</span> <span class="free">charts</span><span class="main">.</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="bound">c</span> <span class="bound">c'</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> charts_subset_atlas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">charts</span> <span class="main">⊆</span> atlas"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atlas_def pairwise_compat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_charts_in_atlas<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">charts</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> atlas"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atlas_def pairwise_compat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> maximal_atlas<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c'</span><span class="main">.</span> <span class="bound">c'</span> <span class="main">∈</span> atlas <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> <span class="bound">c'</span>"</span></span>
    <span class="quoted"><span class="quoted">"domain <span class="free">c</span> <span class="main">⊆</span> carrier"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that charts_subset_atlas
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atlas_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chart_compose_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c1</span> <span class="free">c2</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">≡</span> domain <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">≡</span> domain <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subsets<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">⊆</span> carrier"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">charts</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="bound">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">charts</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c2</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span><span class="free">U</span> <span class="main">∩</span> <span class="free">V</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_open_subsetsI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> <span class="free">c1</span> <span class="main">`</span> <span class="main">(</span><span class="free">U</span> <span class="main">∩</span> <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> <span class="free">c1</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword1"><span class="command">using</span></span> subsets
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c3</span></span> <span class="keyword2"><span class="keyword">where</span></span> c3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> domain <span class="skolem">c3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c3</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> carrierE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="skolem">c3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c2</span> <span class="skolem">c3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="main">=</span> domain <span class="skolem">c3</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> diff1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span><span class="free">U</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c3</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span><span class="free">U</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_chart_image<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> <span class="free">c1</span> <span class="main">`</span> <span class="main">(</span><span class="free">U</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c3 w'<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> c13 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c3</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span> <span class="skolem">w'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> diff2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="skolem">c3</span> <span class="main">`</span> <span class="main">(</span><span class="free">V</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span> <span class="main">∘</span> inv_chart <span class="skolem">c3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">c3</span> <span class="main">`</span> <span class="main">(</span><span class="free">V</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_chart_image<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">c3</span> <span class="main">`</span> <span class="main">(</span><span class="free">V</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">∈</span> <span class="free">V</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> y_def c3 w'<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> c23 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span><span class="free">U</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">c2</span> <span class="main">∘</span> inv_chart <span class="skolem">c3</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span><span class="skolem">c3</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diff2 diff1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_compose2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span><span class="free">U</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> <span class="free">c1</span> <span class="main">`</span> <span class="main">(</span><span class="free">U</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span><span class="free">U</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">∩</span> <span class="skolem">W</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">∈</span> <span class="free">V</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> w' c3<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="skolem">w'</span> <span class="main">∈</span> <span class="bound">T</span> <span class="main">∧</span> open <span class="bound">T</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="bound">T</span> <span class="main">(</span>apply_chart <span class="free">c2</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">c1</span></span></span> <span class="main"><span class="main"><span class="main">`</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">U</span></span></span> <span class="main"><span class="main"><span class="main">∩</span></span></span> <span class="free"><span class="free"><span class="free">V</span></span></span> <span class="main"><span class="main"><span class="main">∩</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">W</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">charts</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="bound">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">charts</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c2</span> <span class="bound">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"domain <span class="free">c1</span> <span class="main">∩</span> domain <span class="free">c2</span> <span class="main">⊆</span> carrier"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smooth_compat_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c1</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c1</span> <span class="main">∩</span> domain <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c2</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> that chart_compose_lemma<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c2</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c1</span> <span class="main">∩</span> domain <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c1</span> <span class="main">∘</span> inv_chart <span class="free">c2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> inf_commute<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> chart_compose_lemma<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> maximal_atlas'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c'</span><span class="main">.</span> <span class="bound">c'</span> <span class="main">∈</span> <span class="free">charts</span> <span class="main">⟹</span> <span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> <span class="bound">c'</span>"</span></span>
    <span class="quoted"><span class="quoted">"domain <span class="free">c</span> <span class="main">⊆</span> carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> maximal_atlas<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> atlas"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_compat_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">using</span></span> atlas_def <span class="quoted"><span class="quoted">‹<span class="skolem">c'</span> <span class="main">∈</span> atlas›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>

<span class="keyword1"><span class="command">lemma</span></span> atlas_is_atlas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">a1</span> <span class="free">a2</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a2</span> <span class="main">∈</span> atlas"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that atlas_def smooth_compat_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> domain_atlas_subset_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas <span class="main">⟹</span> domain <span class="free">c</span> <span class="main">⊆</span> carrier"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> in_carrier_atlasI<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atlas_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atlasE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> carrierE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> charts_subset_atlas
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_chart_in_atlas<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict_chart <span class="free">S</span> <span class="free">c</span> <span class="main">∈</span> atlas"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> maximal_atlas<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> atlas"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">∈</span> atlas›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atlas_is_atlas<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_compat_restrict_chartI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> domain <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domain_restrict_chart_if<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> domain_atlas_subset_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atlas_restrictE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"domain <span class="free">c</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> carrierE<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> restrict_chart <span class="free">X</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"domain <span class="skolem">d</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def restrict_chart_in_atlas<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> open_ball_chartE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> carrier"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"domain <span class="free">c</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"codomain <span class="free">c</span> <span class="main">=</span> ball <span class="main">(</span><span class="free">c</span> <span class="free">x</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> carrierE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c</span> <span class="main">∩</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>apply_chart <span class="skolem">c</span> <span class="main">`</span> <span class="main">(</span>domain <span class="skolem">c</span> <span class="main">∩</span> <span class="free">U</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="free">x</span> <span class="main">∈</span> <span class="skolem">c</span> <span class="main">`</span> <span class="main">(</span>domain <span class="skolem">c</span> <span class="main">∩</span> <span class="free">U</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> openE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="main">(</span><span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">⊆</span> <span class="skolem">c</span> <span class="main">`</span> <span class="main">(</span>domain <span class="skolem">c</span> <span class="main">∩</span> <span class="free">U</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> inv_chart <span class="skolem">c</span> <span class="main">`</span> ball <span class="main">(</span><span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> restrict_chart <span class="skolem">C</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> atlas"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> atlas"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c'_def restrict_chart_in_atlas<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> C_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"apply_chart <span class="skolem">c</span> <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c'_def <span class="quoted"><span class="quoted">‹open <span class="skolem">C</span>›</span></span> c <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="skolem">C</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domain <span class="skolem">c'</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c'_def <span class="quoted"><span class="quoted">‹open <span class="skolem">C</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"codomain <span class="skolem">c'</span> <span class="main">=</span> ball <span class="main">(</span><span class="skolem">c'</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e <span class="quoted"><span class="quoted">‹open <span class="skolem">C</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c'_def codomain_restrict_chart_if C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_compat_compose_chart<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> diffeo<span class="main">:</span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> UNIV UNIV <span class="free">p</span> <span class="free">p'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="main">(</span>compose_chart <span class="free">p</span> <span class="free">p'</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> dD<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> diffeomorphismD<span class="main">[</span><span class="operator">OF</span> diffeo<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> homeo<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> diffeomorphism_imp_homeomorphism<span class="main">[</span><span class="operator">OF</span> diffeo<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>apply_chart <span class="free">c</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c</span> <span class="main">∩</span> domain <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="free">c'</span> <span class="main">∘</span> inv_chart <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>apply_chart <span class="free">c'</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c</span> <span class="main">∩</span> domain <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="free">c</span> <span class="main">∘</span> inv_chart <span class="free">c'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> homeo <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">p</span> <span class="main">`</span> apply_chart <span class="free">c</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c</span> <span class="main">∩</span> domain <span class="free">c'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> homeomorphism_UNIV_imp_open_map<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">∘</span> apply_chart <span class="free">c</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c</span> <span class="main">∩</span> domain <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="free">c'</span> <span class="main">∘</span> inv_chart <span class="free">c</span> <span class="main">∘</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_compose2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dD<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> c<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms image_comp <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> * <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>apply_chart <span class="free">c'</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">c</span> <span class="main">∩</span> domain <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∘</span> <span class="main">(</span>apply_chart <span class="free">c</span> <span class="main">∘</span> inv_chart <span class="free">c'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_compose2<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dD<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms image_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> smooth_compat_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compose_chart_in_atlas<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> diffeo<span class="main">:</span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> UNIV UNIV <span class="free">p</span> <span class="free">p'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compose_chart <span class="free">p</span> <span class="free">p'</span> <span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> maximal_atlas<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> diffeomorphism_imp_homeomorphism<span class="main">[</span><span class="operator">OF</span> diffeo<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span>compose_chart <span class="free">p</span> <span class="free">p'</span> <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> atlas"</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">∈</span> atlas›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> atlas_is_atlas<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="main">(</span>compose_chart <span class="free">p</span> <span class="free">p'</span> <span class="free">c</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diffeo
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_compat_compose_chart<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_centered_ball_chartE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> carrier"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x0</span>"</span></span> <span class="quoted"><span class="quoted">"domain <span class="free">c</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"codomain <span class="free">c</span> <span class="main">=</span> ball <span class="free">x0</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> open_ball_chartE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> atlas"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"domain <span class="skolem">c</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"codomain <span class="skolem">c</span> <span class="main">=</span> ball <span class="main">(</span><span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">/</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">c</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">c</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diffeomorphism_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="skolem">c</span> <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">e</span> <span class="main">/</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">e</span> <span class="main">/</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diffeomorphism_scaleR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">/</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> UNIV UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">+</span> <span class="free">x0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diffeomorphism_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">e</span> <span class="main">/</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="bound">y</span> <span class="main">+</span> <span class="main">-</span> <span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">x0</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">e</span> <span class="main">/</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">c</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> diffeomorphism_compose<span class="main">[</span><span class="operator">OF</span> diffeomorphism_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1 2<span class="main"><span class="main">]</span></span> 3<span class="main">,</span> <span class="operator">unfolded</span> o_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> diffeo<span class="main">:</span> <span class="quoted"><span class="quoted">"diffeomorphism <span class="free">k</span> UNIV UNIV <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def t'_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> compose_chart_in_atlas<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> atlas›</span></span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compose_chart <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">c</span> <span class="main">∈</span> atlas"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> diffeomorphism_imp_homeomorphism<span class="main">[</span><span class="operator">OF</span> diffeo<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="main">(</span>compose_chart <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">(</span><span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compose_chart <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">c</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span>compose_chart <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹domain <span class="skolem">c</span> <span class="main">⊆</span> <span class="free">U</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">`</span> codomain <span class="skolem">c</span> <span class="main">=</span> ball <span class="free">x0</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">`</span> codomain <span class="skolem">c</span> <span class="main">=</span> <span class="main">(+)</span> <span class="free">x0</span> <span class="main">`</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="main">(</span><span class="free">e</span> <span class="main">/</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">-</span> apply_chart <span class="skolem">c</span> <span class="free">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">(</span><span class="skolem">c</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c t_def image_image<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ball <span class="free">x0</span> <span class="free">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> image_add_ball image_scaleR_ball<span class="main">[</span><span class="operator">OF</span> nz<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"codomain <span class="main">(</span>compose_chart <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> ball <span class="free">x0</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Submanifold›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> manifold<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">charts_submanifold</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span>restrict_chart <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">`</span> <span class="free">charts</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> c_manifold' <span class="main">=</span> c_manifold

<span class="keyword1"><span class="command">locale</span></span> submanifold <span class="main">=</span> c_manifold' <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">k</span></span> <span class="comment1">―‹breaks infinite loop for sublocale sub›</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">charts</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>t2_space<span class="main">,</span>second_countable_topology<span class="main">}</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> open_submanifold<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> charts_submanifold<span class="main">:</span> <span class="quoted"><span class="quoted">"c_manifold <span class="main">(</span>charts_submanifold <span class="free">S</span><span class="main">)</span> <span class="free">k</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> charts_submanifold_def atlas_is_atlas in_charts_in_atlas restrict_chart_in_atlas<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> sub<span class="main">:</span> c_manifold <span class="quoted"><span class="quoted">"<span class="main">(</span>charts_submanifold <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">k</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> charts_submanifold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> carrier_submanifold<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sub.carrier <span class="main">=</span> <span class="free">S</span> <span class="main">∩</span> carrier"</span></span>
  <span class="keyword1"><span class="command">using</span></span> open_submanifold
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> manifold.carrier_def charts_submanifold_def domain_restrict_chart_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_chart_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_chart carrier <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> chart_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> charts_submanifold_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"charts_submanifold carrier <span class="main">=</span> <span class="free">charts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> charts_submanifold_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> charts_submanifold_Int_carrier<span class="main">:</span>
  <span class="quoted"><span class="quoted">"charts_submanifold <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> carrier<span class="main">)</span> <span class="main">=</span> charts_submanifold <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> open_submanifold
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> charts_submanifold_def restrict_chart_restrict_chart<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> submanifold_atlasE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> sub.atlas"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> maximal_atlas'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="free">c</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∩</span> carrier"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sub.domain_atlas_subset_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"domain <span class="free">c</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_submanifold <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict_chart <span class="free">S</span> <span class="skolem">c'</span> <span class="main">∈</span> <span class="main">(</span>charts_submanifold <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> charts_submanifold_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict_chart <span class="free">S</span> <span class="skolem">c'</span> <span class="main">∈</span> sub.atlas"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub.atlas_is_atlas<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_compat_restrict_chartD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> U<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> dc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_submanifold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> submanifold_atlasI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_chart <span class="free">S</span> <span class="free">c</span> <span class="main">∈</span> sub.atlas"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sub.maximal_atlas'<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> <span class="main">(</span>charts_submanifold <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="keyword2"><span class="keyword">where</span></span> c''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> restrict_chart <span class="free">S</span> <span class="skolem">c''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c''</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> charts_submanifold_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> c''
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_compat_restrict_chartI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_compat_restrict_chartI2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> atlas_is_atlas<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c''</span> <span class="main">∈</span> <span class="free">charts</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span>restrict_chart <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> sub.carrier"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain_atlas_subset_carrier<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_submanifold <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> c_manifold<span class="main">)</span> restrict_chart_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict_chart carrier <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> chart_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> c_manifold<span class="main">)</span> charts_submanifold_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"charts_submanifold carrier <span class="main">=</span> <span class="free">charts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> charts_submanifold_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Differentiable maps›</span></span>

<span class="keyword1"><span class="command">locale</span></span> c_manifolds <span class="main">=</span>
  src<span class="main">:</span> c_manifold <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">k</span></span> <span class="main">+</span> 
  dest<span class="main">:</span> c_manifold <span class="quoted"><span class="free">charts2</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">charts1</span> <span class="free">charts2</span>

<span class="keyword1"><span class="command">locale</span></span> diff <span class="main">=</span> c_manifolds <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">charts2</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">charts1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>t2_space<span class="main">,</span>second_countable_topology<span class="main">}</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">charts2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>t2_space<span class="main">,</span>second_countable_topology<span class="main">}</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart set"</span></span>
    <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> exists_smooth_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> src.carrier <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>src.atlas<span class="main">.</span> <span class="main">∃</span><span class="bound">c2</span><span class="main">∈</span>dest.atlas<span class="main">.</span>
      <span class="free">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span>
      <span class="free">f</span> <span class="main">`</span> domain <span class="bound">c1</span> <span class="main">⊆</span> domain <span class="bound">c2</span> <span class="main">∧</span>
      <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="bound">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> src.carrier <span class="main">⊆</span> dest.carrier"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exists_smooth_on
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifolds <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">charts1</span> <span class="free">charts2</span> <span class="free">f</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>src.carrier<span class="main">.</span> <span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>src.atlas<span class="main">.</span> <span class="main">∃</span><span class="bound">c2</span><span class="main">∈</span>dest.atlas<span class="main">.</span>
    <span class="bound">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span>
    <span class="free">f</span> <span class="main">`</span> domain <span class="bound">c1</span> <span class="main">⊆</span> domain <span class="bound">c2</span> <span class="main">∧</span>
    <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="bound">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">_</span><span class="main">.</span> <span class="var">?r</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword1"><span class="command">interpret</span></span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">charts2</span></span> <span class="quoted"><span class="free">f</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> src.carrier <span class="main">⟹</span> <span class="var">?r</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exists_smooth_on<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>src.carrier<span class="main">.</span> <span class="var">?r</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> diff <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diffE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> src.carrier"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c1</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> chart"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c2</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">∈</span> src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">∈</span> dest.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> domain <span class="free">c1</span> <span class="main">⊆</span> domain <span class="free">c2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="free">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="free">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exists_smooth_on assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_at<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> src.carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> dest.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> domain <span class="skolem">c1</span> <span class="main">⊆</span> domain <span class="skolem">c2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diffE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> smooth_on_imp_continuous_on<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="skolem">c1</span> <span class="main">`</span> domain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">`</span> domain <span class="skolem">c1</span> <span class="main">⊆</span> domain <span class="skolem">c2</span>›</span></span> continuous_on_chart_inv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_domain_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>domain <span class="skolem">c1</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_chart_inv'<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isCont <span class="free">f</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_eq_continuous_at<span class="main">[</span><span class="operator">OF</span> open_domain<span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">T</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹isCont <span class="free">f</span> <span class="free">x</span>›</span></span> continuous_at_imp_continuous_within<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on src.carrier <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_eq_continuous_within
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> continuous_at<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> continuous_on_intro<span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span> continuous_on_compose2<span class="main">[</span><span class="operator">OF</span> continuous_on _<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> continuous_within<span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span> continuous_within_compose3<span class="main">[</span><span class="operator">OF</span> continuous_at<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> tendsto<span class="main">[</span><span class="operator">tendsto_intros</span><span class="main">]</span> <span class="main">=</span> isCont_tendsto_compose<span class="main">[</span><span class="operator">OF</span> continuous_at<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_chartsD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="main">∈</span> src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d2</span> <span class="main">∈</span> dest.atlas"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="free">d1</span> <span class="main">∩</span> inv_chart <span class="free">d1</span> <span class="main">-`</span> <span class="main">(</span>src.carrier <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> domain <span class="free">d2</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>apply_chart <span class="free">d2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="free">d1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_open_subsetsI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> codomain <span class="free">d1</span> <span class="main">∩</span> inv_chart <span class="free">d1</span> <span class="main">-`</span> <span class="main">(</span>src.carrier <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> domain <span class="free">d2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>inv_chart <span class="free">d1</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> domain <span class="free">d2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> codomain <span class="free">d1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="free">d1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> src.carrier"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> dest.atlas"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fc1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> domain <span class="skolem">c1</span> <span class="main">⊆</span> domain <span class="skolem">c2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xc1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diffE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> src.carrier›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span> <span class="main">⟹</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> fc1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">d1</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">d1</span> <span class="main">∩</span> domain <span class="skolem">c1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">∘</span> inv_chart <span class="free">d1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> src.atlas_is_atlas<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d1</span> <span class="main">∈</span> src.atlas›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c1</span> <span class="main">∈</span> src.atlas›</span></span><span class="main">,</span> <span class="operator">THEN</span> smooth_compat_D1<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="skolem">c2</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">d2</span> <span class="main">∩</span> domain <span class="skolem">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">d2</span> <span class="main">∘</span> inv_chart <span class="skolem">c2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dest.atlas_is_atlas<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d2</span> <span class="main">∈</span> dest.atlas›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c2</span> <span class="main">∈</span> dest.atlas›</span></span><span class="main">,</span> <span class="operator">THEN</span> smooth_compat_D2<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="main">(</span><span class="free">d1</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">d1</span> <span class="main">∩</span> domain <span class="skolem">c1</span><span class="main">)</span> <span class="main">∩</span> inv_chart <span class="free">d1</span> <span class="main">-`</span> <span class="main">(</span>src.carrier <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> domain <span class="free">d2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> T_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_continuous_vimage'<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> open_continuous_vimage' src.open_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> T_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> apply_chart <span class="free">d1</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">d1</span> <span class="main">∩</span> domain <span class="skolem">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> opens<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">c1</span> <span class="main">`</span> inv_chart <span class="free">d1</span> <span class="main">`</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">c2</span> <span class="main">`</span> <span class="main">(</span>domain <span class="free">d2</span> <span class="main">∩</span> domain <span class="skolem">c2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fc1 <span class="quoted"><span class="quoted">‹open <span class="skolem">T</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="main">(</span>apply_chart <span class="skolem">c1</span> <span class="main">∘</span> inv_chart <span class="free">d1</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="free">d2</span> <span class="main">∘</span> inv_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="main">(</span><span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r2 d opens
    <span class="keyword1"><span class="command">unfolding</span></span> image_comp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_compose2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this r1 <span class="quoted"><span class="quoted">‹open <span class="skolem">T</span>›</span></span> opens<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="skolem">T</span>
      <span class="main">(</span><span class="main">(</span><span class="free">d2</span> <span class="main">∘</span> inv_chart <span class="skolem">c2</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">∘</span> inv_chart <span class="free">d1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_comp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_compose2<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="skolem">T</span> <span class="main">(</span><span class="free">d2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="free">d1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">T</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> x xc1 fc1 y <span class="quoted"><span class="quoted">‹<span class="skolem">c1</span> <span class="main">∈</span> src.atlas›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="bound">T</span> <span class="main">∧</span> open <span class="bound">T</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="bound">T</span> <span class="main">(</span>apply_chart <span class="free">d2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="free">d1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">T</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_between_chartsE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="main">∈</span> src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d2</span> <span class="main">∈</span> dest.atlas"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> domain <span class="free">d1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> src.carrier"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span> <span class="main">∈</span> domain <span class="free">d2</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">X</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">X</span> <span class="main">(</span>apply_chart <span class="free">d2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="free">d1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> codomain <span class="free">d1</span> <span class="main">∩</span> inv_chart <span class="free">d1</span> <span class="main">-`</span> <span class="main">(</span>src.carrier <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> domain <span class="free">d2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span>codomain <span class="free">d1</span> <span class="main">∩</span> inv_chart <span class="free">d1</span> <span class="main">-`</span> <span class="main">(</span>src.carrier <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> domain <span class="free">d2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> diff_chartsD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="skolem">X</span> <span class="main">(</span>apply_chart <span class="free">d2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="free">d1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="free">y</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_continuous_vimage' <span class="dynamic"><span class="dynamic">continuous_intros</span></span> src.open_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> X_def
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">M1</span> <span class="free">M3</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">M1</span> <span class="free">M2</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">M2</span> <span class="free">M3</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> f<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">M1</span></span> <span class="quoted"><span class="free">M2</span></span> <span class="quoted"><span class="free">f</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> g<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">M2</span></span> <span class="quoted"><span class="free">M3</span></span> <span class="quoted"><span class="free">g</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> fg<span class="main">:</span> c_manifolds <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">M1</span></span> <span class="quoted"><span class="free">M3</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fg.diff_iff
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> f.src.carrier"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> f.src.atlas"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> f.dest.atlas"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fc1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> domain <span class="skolem">c1</span> <span class="main">⊆</span> domain <span class="skolem">c2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> df<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f.diffE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">∈</span> f.dest.carrier"</span></span> <span class="keyword1"><span class="command">using</span></span> f.defined <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> f.src.carrier›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="skolem"><span class="skolem">c3</span></span> <span class="keyword2"><span class="keyword">where</span></span> c2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c2'</span> <span class="main">∈</span> f.dest.atlas"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> c3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c3</span> <span class="main">∈</span> g.dest.atlas"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> gc2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">`</span> domain <span class="skolem">c2'</span> <span class="main">⊆</span> domain <span class="skolem">c3</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c2'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c2'</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c3</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">∘</span> inv_chart <span class="skolem">c2'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g.diffE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">-`</span> domain <span class="skolem">c3</span> <span class="main">∩</span> domain <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f.defined c1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> open_continuous_vimage <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_def<span class="main">)</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fc1 fx gc2'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_def <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>›</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span> <span class="main">=</span> restrict_chart <span class="skolem">D</span> <span class="skolem">c1</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span> <span class="main">∈</span> f.src.atlas"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d1_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> f.src.restrict_chart_in_atlas c1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c3</span> <span class="main">∈</span> g.dest.atlas"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">d1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d1_def <span class="quoted"><span class="quoted">‹open <span class="skolem">D</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">D</span>›</span></span> x<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> sub_c3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> domain <span class="skolem">d1</span> <span class="main">⊆</span> domain <span class="skolem">c3</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d1_def D_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">d1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c3</span> <span class="main">∘</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> inv_chart <span class="skolem">d1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_open_subsetsI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> codomain <span class="skolem">d1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">iy</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">d1</span> <span class="skolem">iy</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> iy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">iy</span> <span class="main">∈</span> domain <span class="skolem">d1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">note</span></span> iy
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> f.src.domain_atlas_subset_carrier<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d1</span> <span class="main">∈</span> f.src.atlas›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> iS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">iy</span> <span class="main">∈</span> f.src.carrier"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">iy</span> <span class="main">∈</span> f.dest.carrier"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f.defined <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> f.dest.atlasE <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d2</span></span> <span class="keyword2"><span class="keyword">where</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d2</span> <span class="main">∈</span> f.dest.atlas"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> fy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">iy</span> <span class="main">∈</span> domain <span class="skolem">d2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> f.diff_between_chartsE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d1</span> <span class="main">∈</span> f.src.atlas›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d2</span> <span class="main">∈</span> f.dest.atlas›</span></span> iy iS fy<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="skolem">T</span> <span class="main">(</span>apply_chart <span class="skolem">d2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">d1</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span> <span class="skolem">iy</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">T</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> T_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> codomain <span class="skolem">d1</span> <span class="main">∩</span> inv_chart <span class="skolem">d1</span> <span class="main">-`</span> <span class="main">(</span>f.src.carrier <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> domain <span class="skolem">d2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> gf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">iy</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> domain <span class="skolem">c3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub_c3 iy <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> iS f.defined <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">iy</span><span class="main">)</span> <span class="main">∈</span> f.dest.carrier"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> g.diff_between_chartsE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d2</span> <span class="main">∈</span> f.dest.atlas›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c3</span> <span class="main">∈</span> g.dest.atlas›</span></span> fy this gf<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="skolem">X</span> <span class="main">(</span>apply_chart <span class="skolem">c3</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">∘</span> inv_chart <span class="skolem">d2</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_chart <span class="skolem">d2</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">iy</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">X</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> codomain <span class="skolem">d2</span> <span class="main">∩</span> inv_chart <span class="skolem">d2</span> <span class="main">-`</span> <span class="main">(</span>f.dest.carrier <span class="main">∩</span> <span class="free">g</span> <span class="main">-`</span> domain <span class="skolem">c3</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">T</span>›</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="skolem">T</span> <span class="main">(</span>apply_chart <span class="skolem">c3</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">∘</span> inv_chart <span class="skolem">d2</span> <span class="main">∘</span> <span class="main">(</span>apply_chart <span class="skolem">d2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">d1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 1 <span class="quoted"><span class="quoted">‹open <span class="skolem">T</span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">X</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_compose<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> sub_c3 f.defined <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main">:</span> T_def X_def›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="skolem">T</span> <span class="main">(</span>apply_chart <span class="skolem">c3</span> <span class="main">∘</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> inv_chart <span class="skolem">d1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">T</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="bound">T</span> <span class="main">∧</span> open <span class="bound">T</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="bound">T</span> <span class="main">(</span>apply_chart <span class="skolem">c3</span> <span class="main">∘</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> inv_chart <span class="skolem">d1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>f.src.atlas<span class="main">.</span>
            <span class="main">∃</span><span class="bound">c2</span><span class="main">∈</span>g.dest.atlas<span class="main">.</span>
               <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span>
               <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> domain <span class="bound">c1</span> <span class="main">⊆</span> domain <span class="bound">c2</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="bound">c2</span> <span class="main">∘</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> diff <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_submanifold<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="main">(</span>src.charts_submanifold <span class="free">S</span><span class="main">)</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> submanifold <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">S</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> that src.charts_submanifold_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sub.carrier"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> src.carrier"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> diffE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> src.carrier›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> c1c2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> dest.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> domain <span class="skolem">c1</span> <span class="main">⊆</span> domain <span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> rc1<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict_chart <span class="free">S</span> <span class="skolem">c1</span> <span class="main">∈</span> sub.atlas"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1c2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> submanifold_atlasI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>sub.atlas<span class="main">.</span> <span class="main">∃</span><span class="bound">c2</span><span class="main">∈</span>dest.atlas<span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">`</span> domain <span class="bound">c1</span> <span class="main">⊆</span> domain <span class="bound">c2</span> <span class="main">∧</span>
      <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="bound">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rc1
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rev_bexI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> c1c2<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rev_bexI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> c1c2 <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_submanifold2<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">charts1</span> <span class="main">(</span>dest.charts_submanifold <span class="free">S</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> src.carrier <span class="main">⊆</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> submanifold <span class="quoted"><span class="free">charts2</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">S</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> that src.charts_submanifold_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> src.carrier"</span></span>
    <span class="keyword1"><span class="command">from</span></span> diffE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> c1c2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> dest.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> domain <span class="skolem">c1</span> <span class="main">⊆</span> domain <span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict_chart <span class="free">S</span> <span class="skolem">c2</span> <span class="main">∈</span> sub.atlas"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1c2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> submanifold_atlasI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>src.atlas<span class="main">.</span> <span class="main">∃</span><span class="bound">c2</span><span class="main">∈</span>sub.atlas<span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">`</span> domain <span class="bound">c1</span> <span class="main">⊆</span> domain <span class="bound">c2</span> <span class="main">∧</span>
      <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="bound">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1c2<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rev_bexI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> r
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rev_bexI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> c1c2 <span class="quoted"><span class="quoted">‹open <span class="free">S</span>›</span></span> that<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_on_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifolds <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_localI<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">charts1</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> src.carrier <span class="main">⟹</span> diff <span class="free">k</span> <span class="main">(</span>src.charts_submanifold <span class="main">(</span><span class="free">U</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> src.carrier <span class="main">⟹</span> open <span class="main">(</span><span class="free">U</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> src.carrier <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">U</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> src.carrier"</span></span>
  <span class="keyword1"><span class="command">have</span></span> open_U<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">U</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> in_U<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">U</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> submanifold <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that x
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">interpret</span></span> l<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"src.charts_submanifold <span class="main">(</span><span class="free">U</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">charts2</span></span> <span class="quoted"><span class="free">f</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sub.carrier"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> l.diffE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> c1c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> sub.atlas"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> dest.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> domain <span class="skolem">c1</span> <span class="main">⊆</span> domain <span class="skolem">c2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> src.atlas"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> submanifold_atlasE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c1c2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>src.atlas<span class="main">.</span> <span class="main">∃</span><span class="bound">c2</span><span class="main">∈</span>dest.atlas<span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">`</span> domain <span class="bound">c1</span> <span class="main">⊆</span> domain <span class="bound">c2</span> <span class="main">∧</span>
    <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="bound">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> conjI <span class="quoted"><span class="quoted">‹<span class="skolem">c1</span> <span class="main">∈</span> src.atlas›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c2</span> <span class="main">∈</span> dest.atlas›</span></span> c1c2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_open_coverI<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">charts1</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> diff <span class="free">k</span> <span class="main">(</span>src.charts_submanifold <span class="bound">u</span><span class="main">)</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> op<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> open <span class="bound">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cover<span class="main">:</span> <span class="quoted"><span class="quoted">"src.carrier <span class="main">⊆</span> <span class="main">⋃</span><span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>src.carrier<span class="main">.</span> <span class="skolem">V</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bchoice<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> cover
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="main">(</span>src.charts_submanifold <span class="main">(</span><span class="skolem">V</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
    <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">V</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> src.carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that diff op V
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_localI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_open_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">charts1</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="main">(</span>src.charts_submanifold <span class="free">U</span><span class="main">)</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
    <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="main">(</span>src.charts_submanifold <span class="free">V</span><span class="main">)</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"open <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"src.carrier <span class="main">⊆</span> <span class="free">U</span> <span class="main">∪</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_open_coverI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">U</span><span class="main">,</span> <span class="free">V</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> self<span class="main">:</span> c_manifolds <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">charts</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_id<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">charts</span> <span class="free">charts</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> self.diff_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> atlasE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> smooth_on_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_manifold_order_le<span class="main">:</span> <span class="quoted"><span class="quoted">"c_manifold <span class="free">charts</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">use</span> pairwise_compat smooth_compat_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_atlas_order_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> c_manifold.atlas <span class="free">charts</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> l<span class="main">:</span> c_manifold <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">l</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_manifold_order_le<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l.atlas_def atlas_def smooth_compat_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifolds <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_manifolds_order_le<span class="main">:</span> <span class="quoted"><span class="quoted">"c_manifolds <span class="free">l</span> <span class="free">charts1</span> <span class="free">charts2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">use</span> src.pairwise_compat dest.pairwise_compat smooth_compat_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ that<span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> diff <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_order_le<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">l</span> <span class="free">charts1</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> l<span class="main">:</span> c_manifolds <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">charts2</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_manifolds_order_le<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diff <span class="free">l</span> <span class="free">charts1</span> <span class="free">charts2</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diff_axioms
    <span class="keyword1"><span class="command">unfolding</span></span> l.diff_iff diff_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ that<span class="main"><span class="main">]</span></span> src.in_atlas_order_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span>
        dest.in_atlas_order_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Differentiable functions›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_eucl<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> chart"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV<span class="main">,</span> UNIV<span class="main">,</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">,</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">charts_eucl</span> <span class="main">≡</span> <span class="main">{</span>chart_eucl<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_eucl_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"domain chart_eucl <span class="main">=</span> UNIV"</span></span>
  <span class="quoted"><span class="quoted">"codomain chart_eucl <span class="main">=</span> UNIV"</span></span>
  <span class="quoted"><span class="quoted">"apply_chart chart_eucl <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inv_chart chart_eucl <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">locale</span></span> diff_fun <span class="main">=</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted">charts_eucl</span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">charts</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>t2_space<span class="main">,</span>second_countable_topology<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>euclidean_space"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">M1</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">M1</span> <span class="free">M2</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">M2</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_fun_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> diff_fun_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c1_manifold_atlas_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"c_manifold charts_eucl <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_refl<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> manifold_eucl<span class="main">:</span> c_manifold <span class="quoted"><span class="quoted">"charts_eucl"</span></span> <span class="quoted"><span class="free">k</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c1_manifold_atlas_eucl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chart_eucl_in_atlas<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"chart_eucl <span class="main">∈</span> manifold_eucl.atlas <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> manifold_eucl.charts_subset_atlas
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> apply_chart_smooth_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>domain <span class="free">c</span><span class="main">)</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> manifold_eucl.atlas <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> chart_eucl"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> manifold_eucl.atlas_is_atlas<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> smooth_compat_D2<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_chart_smooth_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span> <span class="main">(</span>inv_chart <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> manifold_eucl.atlas <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c</span> chart_eucl"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> manifold_eucl.atlas_is_atlas<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> smooth_compat_D1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def image_domain_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_chart_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">X</span> <span class="main">(</span>apply_chart <span class="free">c</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">X</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> manifold_eucl.atlas <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">X</span> <span class="main">⊆</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">X</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">X</span> <span class="main">(</span>inv_chart <span class="free">c</span> <span class="main">∘</span> <span class="main">(</span>apply_chart <span class="free">c</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_compose inv_chart_smooth_on<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_continuous_vimage <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> smooth_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_chart_inv2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span><span class="free">c</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> inv_chart <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> manifold_eucl.atlas <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">X</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">X</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> inv_chart <span class="free">c</span><span class="main">)</span> <span class="main">∘</span> apply_chart <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> apply_chart_smooth_on
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_compose2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_continuous_vimage <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> smooth_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> diff_fun <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_order_le<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">l</span> <span class="free">charts</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_order_le<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_fun_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diffeormorphism›</span></span>

<span class="keyword1"><span class="command">locale</span></span> diffeomorphism <span class="main">=</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">charts2</span></span> <span class="quoted"><span class="free">f</span></span> <span class="main">+</span> inv<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts2</span></span> <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">f'</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">charts1</span> <span class="free">charts2</span> <span class="free">f</span> <span class="free">f'</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> src.carrier <span class="main">⟹</span> <span class="free">f'</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f'_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> dest.carrier <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> manifold_eucl<span class="main">:</span> c_manifolds <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>chart_eucl<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">charts</span> <span class="main">{</span>chart_eucl<span class="main">}</span> <span class="main">=</span> diff_fun <span class="free">k</span> <span class="free">charts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_fun_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_funI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>carrier <span class="main">⟹</span> <span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>atlas<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="main">(</span><span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> manifold_eucl.diff_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> that <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">chart_eucl</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> diff<span class="main">)</span> diff_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">charts1</span> <span class="free">charts2</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> src.carrier <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> src.carrier"</span></span>
  <span class="keyword1"><span class="command">from</span></span> diff_axioms<span class="main">[</span><span class="operator">unfolded</span> diff_iff<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> chart"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">c2</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> chart"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">c1</span><span class="main">∈</span>src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> dest.atlas"</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> domain <span class="skolem">c1</span> <span class="main">⊆</span> domain <span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>src.atlas<span class="main">.</span> <span class="main">∃</span><span class="bound">c2</span><span class="main">∈</span>dest.atlas<span class="main">.</span>
      <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="free">g</span> <span class="main">`</span> domain <span class="bound">c1</span> <span class="main">⊆</span> domain <span class="bound">c2</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="bound">c2</span> <span class="main">∘</span> <span class="free">g</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> smooth_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span> diff_fun <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> src.carrier <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_cong<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_funD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>src.atlas<span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="main">(</span><span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> src.carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> diff_fun_axioms<span class="main">[</span><span class="operator">unfolded</span> src.manifold_eucl.diff_iff<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> x<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> manifold_eucl.atlas <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> domain <span class="skolem">c1</span> <span class="main">⊆</span> domain <span class="skolem">c2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span>apply_chart <span class="skolem">c2</span> <span class="main">∘</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> smooth_on_chart_inv<span class="main">[</span><span class="operator">OF</span> s<span class="main">]</span> a
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">c1</span></span><span class="main"><span class="main">]</span></span> a <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_funE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> src.carrier"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c1</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c1</span><span class="main">∈</span>src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> inv_chart <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_funD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_between_chartsD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> src.atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> inv_chart <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> src.carrier"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> domain chart_eucl"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> diff_between_chartsE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chart_eucl_in_atlas assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="skolem">X</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> inv_chart <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> codomain <span class="free">c</span> <span class="main">∩</span> inv_chart <span class="free">c</span> <span class="main">-`</span> <span class="main">(</span>src.carrier <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> codomain <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_submanifold<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>src.charts_submanifold <span class="free">S</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_submanifold
  <span class="keyword1"><span class="command">unfolding</span></span> diff_fun_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_funI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> carrierE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_const<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_funI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> carrierE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_add<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> diff_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">a</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> a.diff_funE<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">∘</span> inv_chart <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>atlas<span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ca
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="main">]</span></span> ca smooth_on_add_fun <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_compose b.diff_fun_between_chartsD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_fun_const<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_fun_const<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_fun_add<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> plus_fun_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_scaleR<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> diff_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">a</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> a.diff_funE<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">∘</span> inv_chart <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> inv_chart <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">o</span> inv_chart <span class="skolem">c</span><span class="main">)</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">o</span> inv_chart <span class="skolem">c</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>atlas<span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ca
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="main">]</span></span> smooth_on_scaleR
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_compose b.diff_fun_between_chartsD<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span> * o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_scaleR_left<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scaleR_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_fun_scaleR that diff_fun_const<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_times<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">::</span>real_normed_algebra"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> diff_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">a</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> a.diff_funE<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">∘</span> inv_chart <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>atlas<span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ca
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="main">]</span></span> ca smooth_on_times_fun <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_compose b.diff_fun_between_chartsD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_divide<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">/</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">::</span>real_normed_field"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> diff_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">a</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> a.diff_funE<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">∘</span> inv_chart <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>atlas<span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">/</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ca nz
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="main">]</span></span> ca smooth_on_mult smooth_on_inverse
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> b.diff_fun_between_chartsD
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_compose o_def
        divide_inverse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_Collect_diff_fun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>Collect <span class="main">(</span>diff_fun <span class="free">k</span> <span class="free">charts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subspace_def diff_fun_zero diff_fun_add diff_fun_scaleR_left<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> manifold_eucl_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"manifold_eucl.carrier <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> manifold_eucl.carrier_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_charts_euclD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> UNIV <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> charts_eucl <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_open_subsetsI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword1"><span class="command">interpret</span></span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted">charts_eucl</span> <span class="quoted"><span class="free">g</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> manifold_eucl.carrier"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> diff_funE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> manifold_eucl.atlas <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="skolem">c1</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="skolem">c1</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> inv_chart <span class="skolem">c1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>domain <span class="skolem">c1</span><span class="main">)</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_chart_inv2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_subset<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> c<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">T</span> <span class="main">∧</span> open <span class="bound">T</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="bound">T</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_charts_euclI<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> charts_eucl <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> UNIV <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> manifold_eucl.diff_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">chart_eucl</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Partition_Of_Unity">
<div class="head">
<h1>Theory Partition_Of_Unity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Partitions Of Unity›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Partition_Of_Unity
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Bump_Function.html">Bump_Function</a> <a href="Differentiable_Manifold.html">Differentiable_Manifold</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Regular cover›</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A cover is regular if, in addition to being countable and locally finite,
  the codomain of every chart is the open ball of radius 3, such that the
  inverse image of open balls of radius 1 also cover the manifold.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">regular_cover</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">::</span><span class="tfree">'i</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chart<span class="main">)</span> <span class="main">⟷</span>
  countable <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span>
  carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">.</span> domain <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  locally_finite_on carrier <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>domain <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">.</span> codomain <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> ball <span class="main">0</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">∧</span>
  carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">.</span> inv_chart <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">0</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every covering has a refinement that is a regular cover.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> reguler_refinementE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝒳</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cover<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">𝒳</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> open_cover<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> open <span class="main">(</span><span class="free">𝒳</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">N</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ψ</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>domain <span class="keyword1">o</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">`</span> <span class="free">N</span> <span class="keyword1">refines</span> <span class="free">𝒳</span> <span class="main">`</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"regular_cover <span class="free">N</span> <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> precompact_locally_finite_open_coverE
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">V</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat<span class="main">⇒</span><span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> V<span class="main">:</span>
    <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> open <span class="main">(</span><span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> compact <span class="main">(</span>closure <span class="main">(</span><span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="quoted"><span class="quoted">"locally_finite_on carrier UNIV <span class="skolem">V</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">intersecting</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">intersecting</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">have</span></span> intersecting_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">intersecting</span> <span class="main">(</span>closure <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">intersecting</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> open_Int_closure_eq_empty<span class="main">[</span><span class="operator">OF</span> V<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intersecting_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> locally_finite_compactD<span class="main">[</span><span class="operator">OF</span> V<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> V<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> V<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">intersecting</span> <span class="main">(</span>closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersecting_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_intersecting<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">intersecting</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersecting_closure<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chart<span class="main">.</span>
    <span class="bound">ψ</span> <span class="main">∈</span> atlas <span class="main">∧</span>
    codomain <span class="bound">ψ</span> <span class="main">=</span> ball <span class="main">0</span> <span class="numeral">3</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> domain <span class="bound">ψ</span> <span class="main">⊆</span> <span class="free">𝒳</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="bound">j</span> <span class="main">⟶</span> domain <span class="bound">ψ</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span>
      <span class="skolem">p</span> <span class="main">∈</span> domain <span class="bound">ψ</span> <span class="main">∧</span>
      <span class="bound">ψ</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> cover that open_cover <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">𝒳</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">𝒳</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">VS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">VS</span> <span class="main">=</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="bound">U</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> open_VS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> <span class="bound">T</span> <span class="main">∈</span> <span class="skolem">VS</span> <span class="main">⟹</span> open <span class="main">(</span><span class="skolem">V</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> VS_def V<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> locally_finite_onD<span class="main">[</span><span class="operator">OF</span> V<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> that<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">VS</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> VS_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> atlasE<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ'</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> domain <span class="skolem">ψ'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">VS</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> domain <span class="skolem">ψ'</span> <span class="main">∩</span> <span class="free">𝒳</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">W</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def open_VS <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> c <span class="quoted"><span class="quoted">‹finite <span class="skolem">VS</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">W</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def c ψ' VS_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="main">⊆</span> carrier"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ψ'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> open_centered_ball_chartE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">W</span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">W</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">W</span> <span class="main">⊆</span> carrier›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="numeral">3</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> atlas"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> domain <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"domain <span class="skolem">ψ</span> <span class="main">⊆</span> <span class="skolem">W</span>"</span></span> <span class="quoted"><span class="quoted">"codomain <span class="skolem">ψ</span> <span class="main">=</span> ball <span class="main">0</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> domain <span class="skolem">ψ</span> <span class="main">⊆</span> <span class="free">𝒳</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c ψ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="skolem">j</span> <span class="main">⟹</span> domain <span class="skolem">ψ</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">using</span></span> c ψ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def VS_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ψ</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p2</span> <span class="main">∈</span> carrier<span class="main">.</span>
    <span class="main">∃</span><span class="bound">ψ</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chart<span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> atlas <span class="main">∧</span> codomain <span class="bound">ψ</span> <span class="main">=</span> ball <span class="main">0</span> <span class="numeral">3</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> domain <span class="bound">ψ</span> <span class="main">⊆</span> <span class="free">𝒳</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">p2</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="bound">j</span> <span class="main">⟶</span> domain <span class="bound">ψ</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">p2</span> <span class="main">∈</span> domain <span class="bound">ψ</span> <span class="main">∧</span>
         apply_chart <span class="bound">ψ</span> <span class="bound">p2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chart"</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> carrier <span class="main">⟹</span> codomain <span class="main">(</span><span class="skolem">ψ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> ball <span class="main">0</span> <span class="numeral">3</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">𝒳</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="bound">j</span> <span class="main">⟹</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="bound">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∈</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="main">(</span><span class="skolem">ψ</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="skolem">ψ</span> <span class="bound">p</span> <span class="main">∈</span> atlas"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bchoice_iff
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> f
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">f</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> V
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="skolem">p</span> <span class="main">=</span> inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">0</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">have</span></span> U_open<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">U</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">using</span></span> that ψ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> U_subset_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="skolem">p</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">using</span></span> ψ<span class="main">(</span>1<span class="main">)</span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">⊆</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∧</span> finite <span class="bound">M</span> <span class="main">∧</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">U</span> <span class="main">`</span> <span class="bound">M</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> clcover<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">U</span> <span class="main">`</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ψ
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inv_chart_inverse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ψ<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> V<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> V<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> less_irrefl norm_numeral norm_one norm_zero one_less_numeral_iff subsetCE
          zero_less_norm_iff zero_neq_numeral<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">`</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⟹</span> open <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">B</span>
      <span class="keyword1"><span class="command">using</span></span> V<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> U_open<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> compactE<span class="main">[</span><span class="operator">OF</span> V<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> clcover this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Um</span></span> <span class="keyword2"><span class="keyword">where</span></span> Um<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Um</span> <span class="main">⊆</span> <span class="skolem">U</span> <span class="main">`</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Um</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="skolem">Um</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Um<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="skolem">Um</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">∈</span>closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">U</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p_of</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">Um</span> <span class="main">⟹</span> <span class="skolem">p_of</span> <span class="bound">t</span> <span class="main">∈</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">Um</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">p_of</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p_of</span> <span class="main">`</span> <span class="skolem">Um</span> <span class="main">⊆</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_of
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">p_of</span> <span class="main">`</span> <span class="skolem">Um</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">Um</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">U</span> <span class="main">`</span> <span class="skolem">p_of</span> <span class="main">`</span> <span class="skolem">Um</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Um p_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="skolem">M'</span> <span class="bound">l</span> <span class="main">⊆</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> finite <span class="main">(</span><span class="skolem">M'</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="bound">l</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">U</span> <span class="main">`</span> <span class="skolem">M'</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">M'</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">l</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">have</span></span> V_Least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">la</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">la</span> <span class="main">=</span> <span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">V</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI_ex<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊆</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">M</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">U</span> <span class="main">`</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> M'<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_Least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> M' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> V_Least<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> M'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> M<span class="main">(</span>1<span class="main">)</span> V<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> M_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">l</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"countable <span class="main">(</span><span class="main">⋃</span><span class="bound">l</span><span class="main">.</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> countable_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> countableE_bij<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">N</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">m</span> <span class="skolem">N</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">l</span><span class="main">.</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> the_inv_into <span class="skolem">N</span> <span class="skolem">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> m_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">⟹</span> <span class="skolem">m'</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> m'_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="bound">l</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">m</span> <span class="main">(</span><span class="skolem">m'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def m'_def the_inv_into_f_f<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> m_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">l</span><span class="main">.</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> n that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bij_betwE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> m'_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command">using</span></span> that n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_def bij_betw_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> the_inv_into_into<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> m_in <span class="keyword1"><span class="command">have</span></span> m_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">i</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that M_carrier
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">⟹</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> atlas"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ψ<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>domain <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">N</span> <span class="keyword1">refines</span> <span class="free">𝒳</span> <span class="main">`</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refines_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m_in_carrier ψ<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_cover <span class="skolem">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"countable <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> carrier_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">0</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> V
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> M <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">0</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="main">]</span></span> m'_in<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> carrier_eq_W<span class="main">:</span>  <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?W</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> carrier_subset
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="var">?W</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> U_subset_domain ψ<span class="main">(</span>1<span class="main">)</span> M_carrier m_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="var">?W</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="main">⊆</span> carrier"</span></span> <span class="keyword1"><span class="command">using</span></span> M_carrier ψ<span class="main">(</span>6<span class="main">)</span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m_in<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"locally_finite_on carrier <span class="skolem">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_on_open_coverI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> carrier_eq_W <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ki</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ki</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> m_in<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">ki</span> <span class="main">∈</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> pkc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">ki</span> <span class="main">∈</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> k M<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">ki</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> M_carrier<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">ki</span>"</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> V<span class="main">(</span>1<span class="main">)</span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> kj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="skolem">V</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> open_Int_closure_eq_empty<span class="main">[</span><span class="operator">OF</span> V<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> pkc j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> jinterk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">intersecting</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intersecting_def<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> V<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>range <span class="skolem">V</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> V<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> V<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> range <span class="skolem">V</span> <span class="main">⟹</span> open <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">B</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> compactE<span class="main">[</span><span class="operator">OF</span> 1 2 3<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Vj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Vj</span> <span class="main">⊆</span> range <span class="skolem">V</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Vj</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="skolem">Vj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">V</span> <span class="main">`</span> <span class="skolem">J</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset_image<span class="main">)</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ki'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ki'</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">ki'</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">ki</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ki'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">ki'</span> <span class="main">∈</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ki'</span> <span class="main">∈</span> <span class="skolem">N</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">ki'</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">ki</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">ki'</span> <span class="main">∈</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ki'  H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> pkc'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">ki'</span> <span class="main">∈</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k' M<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">ki'</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="skolem">j'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> M_carrier V<span class="main">(</span>1<span class="main">)</span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">have</span></span> kj'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">V</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">V</span> <span class="skolem">j'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> open_Int_closure_eq_empty<span class="main">[</span><span class="operator">OF</span> V<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> pkc' j' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j'interk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> <span class="skolem">intersecting</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intersecting_def<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> j'interj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">∈</span> <span class="skolem">intersecting</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k' ψ<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> j'<span class="main">]</span> ψ<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intersecting_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">intersecting</span> <span class="main">`</span> <span class="skolem">V</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">intersecting</span> <span class="main">`</span> <span class="skolem">V</span> <span class="main">`</span> <span class="skolem">intersecting</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> jinterk j'interk' j'interj
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">ki'</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">intersecting</span> <span class="main">`</span> <span class="skolem">V</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">intersecting</span> <span class="main">`</span> <span class="skolem">V</span> <span class="main">`</span> <span class="skolem">intersecting</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ki'
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> m_inverse<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ki'</span> <span class="main">∈</span> <span class="skolem">m'</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">M</span> <span class="main">(</span><span class="skolem">V</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">intersecting</span> <span class="main">`</span> <span class="skolem">V</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">intersecting</span> <span class="main">`</span> <span class="skolem">V</span> <span class="main">`</span> <span class="skolem">intersecting</span> <span class="main">(</span><span class="skolem">V</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main">)</span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">ki</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">m'</span></span> <span class="main"><span class="main">`</span></span> <span class="main"><span class="main">⋃</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">V</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">`</span></span> <span class="main"><span class="main">⋃</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">intersecting</span></span> <span class="main"><span class="main">`</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="main"><span class="main">`</span></span> <span class="main"><span class="main">⋃</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">intersecting</span></span> <span class="main"><span class="main">`</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="main"><span class="main">`</span></span> <span class="skolem"><span class="skolem">intersecting</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">V</span></span> <span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> finite_intersecting intersecting_def M <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> codomain <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ball <span class="main">0</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ψ<span class="main">(</span>1<span class="main">)</span> M_carrier m_in
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">0</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊆</span> carrier"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ψ<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> M_carrier<span class="main">]</span> M_carrier m_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ψ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> carrier_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> regular_cover_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_apply_chart<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span>domain <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> charts_eucl <span class="free">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> atlas"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> submanifold <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"domain <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sub.carrier"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>sub.atlas<span class="main">.</span>
            <span class="main">∃</span><span class="bound">c2</span><span class="main">∈</span>manifold_eucl.dest.atlas<span class="main">.</span>
               <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> <span class="free">ψ</span> <span class="main">`</span> domain <span class="bound">c1</span> <span class="main">⊆</span> domain <span class="bound">c2</span> <span class="main">∧</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="bound">c2</span> <span class="main">∘</span> <span class="free">ψ</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"restrict_chart <span class="main"><span class="main">(</span></span>domain <span class="free"><span class="free">ψ</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">ψ</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"chart_eucl"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="main">(</span>restrict_chart <span class="main">(</span>domain <span class="free">ψ</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x <span class="quoted"><span class="quoted">‹<span class="free">ψ</span> <span class="main">∈</span> atlas›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="main">(</span>restrict_chart <span class="main">(</span>domain <span class="free">ψ</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chart_eucl <span class="main">∘</span> <span class="free">ψ</span> <span class="main">∘</span> inv_chart <span class="main">(</span>restrict_chart <span class="main">(</span>domain <span class="free">ψ</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_continuous_vimage' continuous_on_codomain<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> submanifold_atlasI<span class="main">)</span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inv_chart<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="main">(</span>manifold_eucl.charts_submanifold <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">charts</span> <span class="main">(</span>inv_chart <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> atlas"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> submanifold <span class="quoted">charts_eucl</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"codomain <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sub.carrier"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">∈</span>sub.atlas<span class="main">.</span>
            <span class="main">∃</span><span class="bound">c2</span><span class="main">∈</span>atlas<span class="main">.</span>
               <span class="skolem">x</span> <span class="main">∈</span> domain <span class="bound">c1</span> <span class="main">∧</span> inv_chart <span class="free">c</span> <span class="main">`</span> domain <span class="bound">c1</span> <span class="main">⊆</span> domain <span class="bound">c2</span> <span class="main">∧</span>
               <span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="bound">c1</span><span class="main">)</span> <span class="main">(</span><span class="bound">c2</span> <span class="main">∘</span> inv_chart <span class="free">c</span> <span class="main">∘</span> inv_chart <span class="bound">c1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"restrict_chart <span class="main"><span class="main">(</span></span>codomain <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span> chart_eucl"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> domain <span class="main">(</span>restrict_chart <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span> chart_eucl<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">∈</span> atlas›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="main">(</span>codomain <span class="main">(</span>restrict_chart <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span> chart_eucl<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">∘</span> inv_chart <span class="free">c</span> <span class="main">∘</span> inv_chart <span class="main">(</span>restrict_chart <span class="main">(</span>codomain <span class="free">c</span><span class="main">)</span> chart_eucl<span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_continuous_vimage' continuous_on_codomain<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> submanifold_atlasI<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_inj_on <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> domain <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="free">x</span> <span class="main">=</span> <span class="free">c</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">c</span> <span class="main">(</span>domain <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_apply_chart<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partition of unity by smooth functions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  Given any open cover <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X›</span></span></span></span> indexed by a set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>, there exists a family of
  smooth functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>φ›</span></span></span></span> indexed by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>, such that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0 ≤ φ ≤ 1›</span></span></span></span>, the (closed) support
  of each <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>φ i›</span></span></span></span> is contained in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X i›</span></span></span></span>, the supports are locally finite, and the
  sum of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>φ i›</span></span></span></span> is the constant function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>1›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> partitions_of_unityE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">X</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> open <span class="main">(</span><span class="free">X</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">φ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">φ</span> <span class="bound">i</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="free">φ</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> csupport_on carrier <span class="main">(</span><span class="free">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> carrier <span class="main">⊆</span> <span class="free">X</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"locally_finite_on carrier <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> csupport_on carrier <span class="main">(</span><span class="free">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> reguler_refinementE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ψ</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chart"</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">⟹</span> <span class="skolem">ψ</span> <span class="bound">i</span> <span class="main">∈</span> atlas"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>domain <span class="keyword1">o</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">N</span> <span class="keyword1">refines</span> <span class="free">X</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="quoted"><span class="quoted">"regular_cover <span class="skolem">N</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="skolem">i</span> <span class="main">=</span> inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">0</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="skolem">i</span> <span class="main">=</span> inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">0</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">i</span> <span class="main">=</span> inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">`</span> ball <span class="main">0</span> <span class="numeral">3</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span><span class="main">::</span><span class="quoted">nat</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹regular_cover <span class="skolem">N</span> <span class="skolem">ψ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> regular_cover<span class="main">:</span>
    <span class="quoted"><span class="quoted">"countable <span class="skolem">N</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"locally_finite_on carrier <span class="skolem">N</span> <span class="main">(</span>domain <span class="main">∘</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">⟹</span> codomain <span class="main">(</span><span class="skolem">ψ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> ball <span class="main">0</span> <span class="numeral">3</span>"</span></span>
    <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="skolem">U</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> regular_cover_def U_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> open_W<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">W</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def regular_cover<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> W_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">W</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> W_def regular_cover<span class="main">(</span>4<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> carrier_W<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> regular_cover W_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> V_subset_W<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">W</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊆</span> closure <span class="main">(</span>inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">`</span> cball <span class="main">0</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> V_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closure_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inv_chart <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">`</span> cball <span class="main">0</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closure_closed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> compact_imp_closed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> compact_continuous_image<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> regular_cover that<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="skolem">W</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> carrier_V<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> regular_cover<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def V_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> carrier_W <span class="keyword1"><span class="command">using</span></span> V_subset_W <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="skolem">i</span> <span class="keyword1">then</span> H <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> f_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">=</span> H <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">W</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> f_eq_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">j</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def W_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">j</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def W_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">N</span>›</span></span> regular_cover<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="skolem">j</span>›</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> H_eq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> f_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> manifold_eucl.diff_open_Un<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> diff_fun_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> W_eq <span class="main">=</span> W_eq<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">i</span> <span class="main">⊆</span> carrier"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> W_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> regular_cover <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">interpret</span></span> W<span class="main">:</span> submanifold _ _ <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_W i<span class="main">)</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span><span class="skolem">W</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>H <span class="main">∘</span> <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun_compose<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?M2.0</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">charts_eucl</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_apply_chart<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">ψ</span></span> <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> W_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> ψ <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun_charts_euclI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H_smooth_on<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span><span class="skolem">W</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun.diff_fun_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>

    <span class="keyword1"><span class="command">interpret</span></span> V'<span class="main">:</span> submanifold _ _ <span class="quoted"><span class="quoted">"carrier <span class="main">-</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span>carrier <span class="main">-</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> V'.sub.diff_fun_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span>carrier <span class="main">-</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun.diff_fun_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> H_eq_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> W_eq image_eqI in_closureI inv_chart_inverse<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">W</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def regular_cover i<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>carrier <span class="main">-</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="skolem">W</span> <span class="skolem">i</span> <span class="main">∪</span> <span class="main">(</span>carrier <span class="main">-</span> closure <span class="main">(</span><span class="skolem">V</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V_subset_W<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">ψ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">ψ</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">j</span></span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ψ</span> <span class="skolem">x</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>carrier<span class="main">.</span> <span class="main">∃</span><span class="bound">I</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">∧</span> open <span class="bound">I</span> <span class="main">∧</span>finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">∩</span> <span class="bound">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>carrier<span class="main">.</span> <span class="var">?P</span> <span class="bound">p</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> carrier"</span></span>
    <span class="keyword1"><span class="command">from</span></span> locally_finite_onE<span class="main">[</span><span class="operator">OF</span> regular_cover<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="main">(</span>domain <span class="main">∘</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="main">(</span>domain <span class="main">∘</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> bchoice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> open <span class="main">(</span><span class="skolem">I</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> subset_W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">j</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">j</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that W_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> finite_W<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">j</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_W<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ that<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> manifold_eucl.diff_localI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> diff_fun_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> submanifold _ _ <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">interpret</span></span> df<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f_diff<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="bound">y</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">j</span></span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">j</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub.diff_fun_divide<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> df.diff_submanifold<span class="main"><span class="main">[</span></span><span class="operator">folded</span> diff_fun_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> I<span class="main">)</span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sub.diff_fun_sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">j</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">interpret</span></span> df'<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f_diff<span class="main">)</span> <span class="operator">fact</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> df'.diff_fun_submanifold<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> I<span class="main">)</span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_nonneg_eq_0_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> I<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> H_range <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
          <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> regular_cover<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def W_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="skolem">j</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> W_eq <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">N</span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> carrier›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="skolem">x</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">note</span></span> f_eq_one<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">N</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="skolem">j</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xa</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">∧</span> <span class="skolem">W</span> <span class="bound">xa</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">xa</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">N</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun.diff_fun_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> g_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_right<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> I<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> carrier›</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_W<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> carrier_submanifold I <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> f_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def H_range <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> U_sub_W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def W_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> sumf_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="comment1">(* and this sum is smooth, use to simplify earlier reasoning! *)</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> regular_cover<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> finite_W<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_nonneg f_eq_one U_sub_W <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> sumf_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_nonneg <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> g_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="skolem">i</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> divide_nonneg_nonneg sumf_nonneg f_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> g_le_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span> <span class="comment1">(*sumf is positive*)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> divide_le_eq_1_pos<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> sumf_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> member_le_sum<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> sum.infinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_simps sum_nonneg H_range<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> sum_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_divide_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> sumf_pos<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">(</span><span class="bound">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ψ<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bchoice<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refines_def W_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">⟹</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">(</span><span class="skolem">a</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">α</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">α</span> <span class="skolem">x</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">α</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> manifold_eucl.diff_localI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> diff_fun_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="comment1">(* extract the lemma here?! *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> submanifold _ _ <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">α</span> <span class="main">∧</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">I</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub.diff_fun_sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> i
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">interpret</span></span> dg<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g<span class="main">)</span> <span class="operator">fact</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dg.diff_fun_submanifold<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> I<span class="main">)</span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun.diff_fun_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> φ_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_right<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> _ I<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> carrier_submanifold <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def f_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">α</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg g_nonneg that<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">α</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> φ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_W<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> g_nonneg <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_g<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">α</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">α</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="skolem">φ</span> <span class="bound">α</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="skolem">φ</span> <span class="bound">α</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">α</span></span> <span class="main">|</span> <span class="bound">α</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">φ</span> <span class="bound">α</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">.</span> <span class="skolem">φ</span> <span class="bound">α</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">α</span></span> <span class="main">|</span> <span class="bound">α</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">φ</span> <span class="bound">α</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">α</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> φ_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">α</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">xa</span><span class="main">:</span><span class="main">{</span><span class="bound"><span class="bound">α</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="skolem">φ</span> <span class="bound">α</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">xa</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.Sigma<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">a</span></span> <span class="main"><span class="main">`</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound">j</span></span></span></span> <span class="main"><span class="main">∈</span></span> <span class="skolem"><span class="skolem">N</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">∈</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sum_nonneg_eq_0_iff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> _ finite_W<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> finite_W<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> _ finite_W<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>snd <span class="main">`</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">xa</span><span class="main">:</span><span class="main">{</span><span class="bound"><span class="bound">α</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="skolem">φ</span> <span class="bound">α</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">xa</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> l<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">a</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sum_nonneg_eq_0_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> _ finite_W<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> g_nonneg <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> yy
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sum_nonneg_eq_0_iff<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> _ finite_W<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">N</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_left<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_W<span class="main">)</span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sigma_def image_iff a<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sum_nonneg_eq_0_iff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> _ finite_W<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_g<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> g_supp_le_V<span class="main">:</span> <span class="quoted"><span class="quoted">"support_on carrier <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> support_on_def g_def f_def V_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> H_neq_zeroD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inv_chart_inverse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> W_eq that<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> clsupp_g_le_W<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span>support_on carrier <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">W</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">unfolding</span></span> csupport_on_def
    <span class="keyword1"><span class="command">using</span></span> V_subset_W closure_mono that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> csupp_g_le_W<span class="main">:</span> <span class="quoted"><span class="quoted">"csupport_on carrier <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">W</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> csupport_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> domain <span class="main">(</span><span class="skolem">ψ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">Na</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">Na</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Na</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lfW<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_finite_on carrier <span class="skolem">N</span> <span class="skolem">W</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> regular_cover<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_finite_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lf_supp_g<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_finite_on carrier <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> support_on carrier <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">α</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_on_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> g_supp_le_V V_subset_W
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"csupport_on carrier <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">∩</span> carrier <span class="main">⊆</span> <span class="free">X</span> <span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">α</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">}</span><span class="main">.</span> support_on carrier <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> closure <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closure_mono<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> g_supp_le_V <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"support_on carrier <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">}</span><span class="main">.</span> support_on carrier <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> φ_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> support_on_nonneg_sum_subset'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> g_supp_le_V
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrier_V<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"csupport_on carrier <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">∩</span> carrier <span class="main">⊆</span> closure <span class="main">…</span> <span class="main">∩</span> carrier"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> csupport_on_def <span class="keyword1"><span class="command">using</span></span> closure_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">}</span><span class="main">.</span> closure <span class="main">(</span>support_on carrier <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_on_closure_Union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lf_supp_g<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> closure_mono<span class="main">[</span><span class="operator">OF</span> g_supp_le_V<span class="main">]</span> V_subset_W
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrier_W<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">}</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> UN_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> clsupp_g_le_W
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">X</span> <span class="skolem">α</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"locally_finite_on carrier <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> support_on carrier <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> carrier"</span></span>
    <span class="keyword1"><span class="command">from</span></span> locally_finite_onE<span class="main">[</span><span class="operator">OF</span> lfW this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Nhd</span></span> <span class="keyword2"><span class="keyword">where</span></span> Nhd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">Nhd</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">Nhd</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">W</span> <span class="bound">i</span> <span class="main">∩</span> <span class="skolem">Nhd</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Nhd</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="bound">Nhd</span> <span class="main">∧</span> open <span class="bound">Nhd</span> <span class="main">∧</span> finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> support_on carrier <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">Nhd</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Nhd</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Nhd<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">a</span></span> <span class="main"><span class="main">`</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound">i</span></span></span></span> <span class="main"><span class="main">∈</span></span> <span class="skolem"><span class="skolem">N</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">∩</span></span> <span class="skolem"><span class="skolem">Nhd</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">{}</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> support_on_def φ_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sum_nonneg_eq_0_iff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> g_nonneg<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> _ finite_W <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"locally_finite_on carrier <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> csupport_on carrier <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> csupport_on_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> locally_finite_on_closure<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A ⊆ U ⊆ carrier›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> is closed and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span> is open, there exists
  a differentiable function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ψ›</span></span></span></span> such that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0 ≤ ψ ≤ 1›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ψ = 1›</span></span></span></span> on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>, and the
  support of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ψ›</span></span></span></span> is contained in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> smooth_bump_functionE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closedin <span class="main">(</span>top_of_set carrier<span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> carrier"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ψ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">ψ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">ψ</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="free">ψ</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"csupport_on carrier <span class="free">ψ</span> <span class="main">∩</span> carrier <span class="main">⊆</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">U</span> <span class="keyword1">else</span> carrier <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>carrier <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> closedin_def open_Int open_carrier openin_open topspace_euclidean_subtopology<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> open <span class="main">(</span><span class="skolem">V</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">.</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> csupport_on carrier <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> carrier <span class="main">⊆</span> <span class="skolem">V</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"locally_finite_on carrier <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> csupport_on carrier <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> partitions_of_unityE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> V<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1-3<span class="main">,</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span></span></span><span class="main">]</span> this<span class="main">(</span>6<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"csupport_on carrier <span class="main">(</span><span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span> <span class="main">∩</span> carrier <span class="main">⊆</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">0</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> φ<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">.</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">φ</span> <span class="main">1</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">V</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> V_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> φ<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> assms that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> support_on_def csupport_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">diff_fun_on</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">W</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> <span class="bound">W</span> <span class="main">∧</span> <span class="bound">W</span> <span class="main">⊆</span> carrier <span class="main">∧</span> open <span class="bound">W</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="bound">W</span><span class="main">)</span> <span class="bound">f'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_onE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diff_fun_on <span class="free">A</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">W</span> <span class="free">f'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">⊆</span> carrier"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">W</span>"</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="free">W</span><span class="main">)</span> <span class="free">f'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_onI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">⊆</span> carrier"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">W</span>"</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="free">W</span><span class="main">)</span> <span class="free">f'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diff_fun_on <span class="free">A</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extension lemma:

  Given <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A ⊆ U ⊆ carrier›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> is closed and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span> is open, and a differentiable
  function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>, there exists a differentiable function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f'›</span></span></span></span> agreeing with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span>
  on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>, and where the support of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f'›</span></span></span></span> is contained in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> extension_lemmaE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closedin <span class="main">(</span>top_of_set carrier<span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diff_fun_on <span class="free">A</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> carrier"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">f'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"csupport_on carrier <span class="free">f'</span> <span class="main">∩</span> carrier <span class="main">⊆</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> diff_fun_onE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">W'</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> W'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="skolem">W'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W'</span> <span class="main">⊆</span> carrier"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">W'</span>"</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="skolem">W'</span><span class="main">)</span> <span class="skolem">f'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="main">=</span> <span class="skolem">W'</span> <span class="main">∩</span> <span class="free">U</span>"</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> W'<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"charts_submanifold <span class="skolem">W'</span>"</span></span> <span class="quoted"><span class="skolem">f'</span></span> <span class="keyword1"><span class="command">using</span></span> W' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">W'</span> <span class="main">∩</span> <span class="free">U</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> W' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> W'.diff_fun_submanifold<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">W</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>W'.src.charts_submanifold <span class="main">(</span><span class="skolem">W'</span> <span class="main">∩</span> <span class="free">U</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W'.src.charts_submanifold <span class="main">(</span><span class="skolem">W'</span> <span class="main">∩</span> <span class="free">U</span><span class="main">)</span> <span class="main">=</span> charts_submanifold <span class="main">(</span><span class="skolem">W'</span> <span class="main">∩</span> <span class="free">U</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> W'.src.charts_submanifold_def
    <span class="keyword1"><span class="command">unfolding</span></span> charts_submanifold_def
    <span class="keyword1"><span class="command">using</span></span> W' *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_image restrict_chart_restrict_chart <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span><span class="skolem">W'</span> <span class="main">∩</span> <span class="free">U</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> W' assms
  <span class="keyword1"><span class="command">have</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="skolem">W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="main">⊆</span> carrier"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">W</span>"</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="skolem">W</span><span class="main">)</span> <span class="skolem">f'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>

  <span class="keyword1"><span class="command">interpret</span></span> submanifold _ _ <span class="quoted"><span class="skolem">W</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> W<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>charts_submanifold <span class="skolem">W</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">f'</span></span> <span class="keyword1"><span class="command">using</span></span> W <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sub.carrier <span class="main">=</span> <span class="skolem">W</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">W</span> <span class="main">⊆</span> carrier›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">W</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> W_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> smooth_bump_functionE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="skolem">W</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">W</span> <span class="main">⊆</span> carrier›</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">W</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="skolem">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">φ</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="skolem">φ</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">φ</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"csupport_on carrier <span class="skolem">φ</span> <span class="main">∩</span> carrier <span class="main">⊆</span> <span class="skolem">W</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">interpret</span></span> φ<span class="main">:</span> diff_fun <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="skolem">φ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">W</span> <span class="keyword1">then</span> <span class="skolem">φ</span> <span class="skolem">p</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">f'</span> <span class="skolem">p</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>

  <span class="keyword1"><span class="command">thm</span></span> sub.diff_fun_scaleR
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> manifold_eucl.diff_open_Un<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> diff_fun_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="skolem">W</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">φ</span> <span class="bound">p</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">f'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sub.diff_fun_scaleR φ.diff_fun_submanifold W<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="skolem">W</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun.diff_fun_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> C<span class="main">:</span> submanifold _ _ <span class="quoted"><span class="quoted">"carrier <span class="main">-</span> csupport_on carrier <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> sub_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C.sub.carrier <span class="main">=</span> carrier <span class="main">-</span> csupport_on carrier <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span>carrier <span class="main">-</span> csupport_on carrier <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> C.sub.diff_fun_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="main">(</span>carrier <span class="main">-</span> csupport_on carrier <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun.diff_fun_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def not_in_csupportD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">W</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>carrier <span class="main">-</span> csupport_on carrier <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">⊆</span> <span class="skolem">W</span> <span class="main">∪</span> <span class="main">(</span>carrier <span class="main">-</span> csupport_on carrier <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> φ
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="skolem">W</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def φ W'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"csupport_on carrier <span class="skolem">g</span> <span class="main">∩</span> carrier  <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"csupport_on carrier <span class="skolem">g</span> <span class="main">⊆</span> csupport_on carrier <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> csupport_on_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>  <span class="main">∩</span> carrier <span class="main">⊆</span> <span class="free">U</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> φ<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">W</span> <span class="main">⊆</span> <span class="free">U</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">W</span> <span class="main">⊆</span> carrier›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">U</span> <span class="main">⊆</span> carrier›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tangent_Space">
<div class="head">
<h1>Theory Tangent_Space</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Tangent Space›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Tangent_Space
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Partition_Of_Unity.html">Partition_Of_Unity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> linear_imp_linear_on<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_on <span class="free">A</span> <span class="free">B</span> scaleR scaleR <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">f</span>"</span></span>
  <span class="quoted"><span class="quoted">"subspace <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> linear <span class="quoted"><span class="free">f</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add scaleR <span class="dynamic"><span class="dynamic">algebra_simps</span></span> subspace_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> vector_space_pair_on<span class="main">)</span>
  linear_sum'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S1</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S2</span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S1</span> <span class="main">⟹</span>
    linear_on <span class="free">S1</span> <span class="free">S2</span> <span class="free">scale1</span> <span class="free">scale2</span> <span class="free">f</span> <span class="main">⟹</span>
    <span class="free">f</span> <span class="main">(</span>sum <span class="free">g</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linear_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> if_distrib if_distribR m1.mem_zero <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Real vector (sub)spaces›</span></span>

<span class="keyword1"><span class="command">locale</span></span> real_vector_space_on <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="keyword2"><span class="keyword">assumes</span></span> subspace<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> vector_space_on <span class="quoted"><span class="free">S</span></span> <span class="quoted">scaleR</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> span_eq_real<span class="main">:</span> <span class="quoted"><span class="quoted">"local.span <span class="main">=</span> real_vector.span"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dependent_eq_real<span class="main">:</span> <span class="quoted"><span class="quoted">"local.dependent <span class="main">=</span> real_vector.dependent"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subspace_eq_real<span class="main">:</span> <span class="quoted"><span class="quoted">"local.subspace <span class="main">=</span> real_vector.subspace"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vector_space_on <span class="free">S</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">use</span> subspace<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subspace_def<span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> subspace<span class="main">:</span> vector_space_on <span class="quoted"><span class="free">S</span></span> <span class="quoted">scaleR</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace.span <span class="main">=</span> span"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subspace.span_on_def span_explicit <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace.dependent <span class="main">=</span> dependent"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subspace.dependent_on_def dependent_explicit <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace.subspace <span class="main">=</span> subspace"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subspace.subspace_on_def subspace_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dim_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"local.dim <span class="free">X</span> <span class="main">=</span> real_vector.dim <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∧</span> independent <span class="skolem">b</span> <span class="main">∧</span> span <span class="skolem">b</span> <span class="main">=</span> span <span class="free">X</span> <span class="main">⟷</span> independent <span class="skolem">b</span> <span class="main">∧</span> span <span class="skolem">b</span> <span class="main">=</span> span <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> local.subspace_UNIV real_vector.span_base real_vector.span_eq_iff real_vector.span_mono subsetCE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">unfolding</span></span> local.dim_def real_vector.dim_def *
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> real_vector_space_pair_on <span class="main">=</span> vs1<span class="main">:</span> real_vector_space_on <span class="quoted"><span class="free">S</span></span> <span class="main">+</span> vs2<span class="main">:</span> real_vector_space_on <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="free">T</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> vector_space_pair_on <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> span_eq_real1<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.span scaleR <span class="main">=</span> vs1.span"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dependent_eq_real1<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.dependent scaleR <span class="main">=</span> vs1.dependent"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subspace_eq_real1<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.subspace scaleR <span class="main">=</span> vs1.subspace"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> span_eq_real2<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.span scaleR <span class="main">=</span> vs2.span"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dependent_eq_real2<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.dependent scaleR <span class="main">=</span> vs2.dependent"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subspace_eq_real2<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.subspace scaleR <span class="main">=</span> vs2.subspace"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vs1.span_eq_real vs1.dependent_eq_real vs1.subspace_eq_real
      vs2.span_eq_real vs2.dependent_eq_real vs2.subspace_eq_real<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> finite_dimensional_real_vector_space_on <span class="main">=</span> real_vector_space_on <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">basis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_dimensional_basis<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">basis</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> dependent <span class="free">basis</span>"</span></span> <span class="quoted"><span class="quoted">"span <span class="free">basis</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">basis</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> finite_dimensional_vector_space_on <span class="quoted"><span class="free">S</span></span> <span class="quoted">scaleR</span> <span class="quoted"><span class="free">basis</span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> span_eq_real<span class="main">:</span> <span class="quoted"><span class="quoted">"local.span <span class="main">=</span> real_vector.span"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dependent_eq_real<span class="main">:</span> <span class="quoted"><span class="quoted">"local.dependent <span class="main">=</span> real_vector.dependent"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subspace_eq_real<span class="main">:</span> <span class="quoted"><span class="quoted">"local.subspace <span class="main">=</span> real_vector.subspace"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_dimensional_basis dependent_eq_real span_eq_real<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> finite_dimensional_real_vector_space_pair_1_on <span class="main">=</span>
  vs1<span class="main">:</span> finite_dimensional_real_vector_space_on <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">basis</span></span> <span class="main">+</span>
  vs2<span class="main">:</span> real_vector_space_on <span class="quoted"><span class="free">S2</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S1</span> <span class="free">S2</span> <span class="free">basis</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> finite_dimensional_vector_space_pair_1_on <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">S2</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span> <span class="quoted"><span class="free">basis</span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> span_eq_real1<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.span scaleR <span class="main">=</span> vs1.span"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dependent_eq_real1<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.dependent scaleR <span class="main">=</span> vs1.dependent"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subspace_eq_real1<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.subspace scaleR <span class="main">=</span> vs1.subspace"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> span_eq_real2<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.span scaleR <span class="main">=</span> vs2.span"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dependent_eq_real2<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.dependent scaleR <span class="main">=</span> vs2.dependent"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subspace_eq_real2<span class="main">:</span> <span class="quoted"><span class="quoted">"module_on.subspace scaleR <span class="main">=</span> vs2.subspace"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> real_vector_space_on.span_eq_real vs1.real_vector_space_on_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> real_vector_space_on.dependent_eq_real vs1.real_vector_space_on_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> real_vector_space_on.subspace_eq_real vs1.real_vector_space_on_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> real_vector_space_on.span_eq_real vs2.real_vector_space_on_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> real_vector_space_on.dependent_eq_real vs2.real_vector_space_on_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> real_vector_space_on.subspace_eq_real vs2.real_vector_space_on_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> finite_dimensional_real_vector_space_pair_on <span class="main">=</span>
  vs1<span class="main">:</span> finite_dimensional_real_vector_space_on <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">Basis1</span></span> <span class="main">+</span>
  vs2<span class="main">:</span> finite_dimensional_real_vector_space_on <span class="quoted"><span class="free">S2</span></span> <span class="quoted"><span class="free">Basis2</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S1</span> <span class="free">S2</span> <span class="free">Basis1</span> <span class="free">Basis2</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> finite_dimensional_real_vector_space_pair_1_on <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">S2</span></span> <span class="quoted"><span class="free">Basis1</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">sublocale</span></span> finite_dimensional_vector_space_pair_on <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">S2</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span> <span class="quoted"><span class="free">Basis1</span></span> <span class="quoted"><span class="free">Basis2</span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"module_on.span scaleR <span class="main">=</span> vs1.span"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"module_on.dependent scaleR <span class="main">=</span> vs1.dependent"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"module_on.subspace scaleR <span class="main">=</span> vs1.subspace"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"module_on.span scaleR <span class="main">=</span> vs2.span"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"module_on.dependent scaleR <span class="main">=</span> vs2.dependent"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"module_on.subspace scaleR <span class="main">=</span> vs2.subspace"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>      span_eq_real1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dependent_eq_real1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  subspace_eq_real1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>      span_eq_real2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dependent_eq_real2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  subspace_eq_real2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derivations›</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Set of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C^k›</span></span></span></span> differentiable functions on carrier, where the smooth structure
   is given by charts. We assume <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> is zero outside carrier›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diff_fun_space</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">diff_fun_space</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="bound">f</span> <span class="main">∧</span> extensional0 carrier <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_spaceD<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> diff_fun_space"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_space_order_le<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun_space <span class="main">⊆</span> c_manifold.diff_fun_space <span class="free">charts</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> l<span class="main">:</span> c_manifold <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">l</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_manifold_order_le<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> diff_fun_space_def l.diff_fun_space_def
    <span class="keyword1"><span class="command">using</span></span> diff_fun.diff_fun_order_le<span class="main">[</span><span class="operator">OF</span> _ that<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_space_extensionalD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> diff_fun_space <span class="main">⟹</span> extensional0 carrier <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_space_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun_space <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="bound">f</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> extensional0 carrier <span class="bound">f</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_diff_fun_space<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subspace diff_fun_space"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_fun_space_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subspace_inter subspace_Collect_diff_fun subspace_extensional0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_space_times<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">*</span> <span class="free">g</span> <span class="main">∈</span> diff_fun_space"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> diff_fun_space"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_fun_times<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_fun_space_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">+</span> <span class="free">g</span> <span class="main">∈</span> diff_fun_space"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> diff_fun_space"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_fun_add<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Set of differentiable functions is a vector space›</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> diff_fun_space<span class="main">:</span> vector_space_pair_on <span class="quoted">diff_fun_space</span> <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span>real set"</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">use</span> subspace_diff_fun_space<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subspace_def<span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
      <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> diff_fun_space_add <span class="dynamic"><span class="dynamic">algebra_simps</span></span> scaleR_fun_def›</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Linear functional from differentiable functions to real numbers›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">linear_diff_fun</span> <span class="main">≡</span> linear_on diff_fun_space <span class="main">(</span>UNIV<span class="main">::</span>real set<span class="main">)</span> scaleR scaleR"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   Definition of a derivation.

   A linear functional <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X›</span></span></span></span> is a derivation if it additionally satisfies the property
   <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X (f * g) = f p * X g + g p * X f›</span></span></span></span>. This is suppose to represent the product rule.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_derivation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_derivation</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="main">(</span>linear_diff_fun <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> diff_fun_space <span class="main">⟶</span> <span class="bound">g</span> <span class="main">∈</span> diff_fun_space <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">*</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">g</span> <span class="main">+</span> <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_derivationI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_derivation <span class="free">X</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"linear_diff_fun <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> diff_fun_space <span class="main">⟹</span> <span class="bound">g</span> <span class="main">∈</span> diff_fun_space <span class="main">⟹</span> <span class="free">X</span> <span class="main">(</span><span class="bound">f</span> <span class="main">*</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">g</span> <span class="main">+</span> <span class="bound">g</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> is_derivation_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_derivationD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="free">X</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> is_derivation_linear_on<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_diff_fun <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> is_derivation_derivation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> diff_fun_space <span class="main">⟹</span> <span class="bound">g</span> <span class="main">∈</span> diff_fun_space <span class="main">⟹</span> <span class="free">X</span> <span class="main">(</span><span class="bound">f</span> <span class="main">*</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">g</span> <span class="main">+</span> <span class="bound">g</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> is_derivation_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Differentiable functions on the Euclidean space›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> manifold_eucl_diff_fun_space_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> manifold_eucl.diff_fun_space <span class="free">k</span> <span class="main">⟷</span> <span class="free">k</span><span class="keyword1">-smooth_on</span> UNIV <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> manifold_eucl.diff_fun_space_def differentiable_on_def
      diff_fun_charts_euclI diff_fun_charts_euclD<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tangent space›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Definition of the tangent space.

  The tangent space at a point p is defined to be the set of derivations. Note
  we need to restrict the domain of the functional to differentiable functions.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tangent_space</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tangent_space</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">X</span><span class="main">.</span> is_derivation <span class="bound">X</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> extensional0 diff_fun_space <span class="bound">X</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tangent_space_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span> <span class="main">=</span> <span class="main">{</span><span class="bound">X</span><span class="main">.</span> is_derivation <span class="bound">X</span> <span class="free">p</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">X</span><span class="main">.</span> extensional0 diff_fun_space <span class="bound">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tangent_space_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_tangent_space<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span> <span class="main">⟷</span> is_derivation <span class="free">X</span> <span class="free">p</span> <span class="main">∧</span> extensional0 diff_fun_space <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tangent_space_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tangent_spaceI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"extensional0 diff_fun_space <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"linear_diff_fun <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> diff_fun_space <span class="main">⟹</span> <span class="bound">g</span> <span class="main">∈</span> diff_fun_space <span class="main">⟹</span> <span class="free">X</span> <span class="main">(</span><span class="bound">f</span> <span class="main">*</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">g</span> <span class="main">+</span> <span class="bound">g</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> tangent_space_def is_derivation_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> tangent_spaceD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> tangent_space_linear_on<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_diff_fun <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tangent_space_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 diff_fun_space <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tangent_space_derivation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> diff_fun_space <span class="main">⟹</span> <span class="bound">g</span> <span class="main">∈</span> diff_fun_space <span class="main">⟹</span> <span class="free">X</span> <span class="main">(</span><span class="bound">f</span> <span class="main">*</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">g</span> <span class="main">+</span> <span class="bound">g</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> tangent_space_def is_derivation_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_derivation_0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">0</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_derivation_def diff_fun_space.linear_zero zero_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_derivation_add<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="free">x</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="free">y</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_derivationI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> x y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_derivation_linear_on <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space.linear_compose_add plus_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_derivation_derivation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">]</span></span> is_derivation_derivation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> y<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_derivation_scaleR<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_derivationI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> x diff_fun_space.linear_compose_scale_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_derivation_linear_on <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>scaleR_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_derivation_derivation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_is_derivation<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="main">{</span><span class="bound">X</span><span class="main">.</span> is_derivation <span class="bound">X</span> <span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subspace_def is_derivation_0 is_derivation_add is_derivation_scaleR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_tangent_space<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tangent_space_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subspace_inter subspace_is_derivation subspace_extensional0<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> tangent_space<span class="main">:</span> real_vector_space_on <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">rule</span> subspace_tangent_space<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tangent_space_dim_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"tangent_space.dim <span class="free">p</span> <span class="free">X</span> <span class="main">=</span> dim <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> tangent_space <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⊆</span> tangent_space <span class="free">p</span> <span class="main">∧</span> independent <span class="skolem">b</span> <span class="main">∧</span> span <span class="skolem">b</span> <span class="main">=</span> span <span class="free">X</span> <span class="main">⟷</span> independent <span class="skolem">b</span> <span class="main">∧</span> span <span class="skolem">b</span> <span class="main">=</span> span <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> c_manifold.subspace_tangent_space c_manifold_axioms span_base span_eq_iff span_mono subsetCE<span class="main">)</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">unfolding</span></span> tangent_space.dim_def dim_def *
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹properties of derivations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restrict0_in_fun_space<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 carrier <span class="free">f</span> <span class="main">∈</span> diff_fun_space"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_fun.diff_fun_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict0_const_diff_fun_space<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 carrier <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> diff_fun_space"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> restrict0_in_fun_space<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> diff_fun_const<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_one_eq_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">(</span>restrict0 carrier <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="var">?f1</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="var">?f1</span> <span class="main">=</span> <span class="free">X</span> <span class="main">(</span><span class="var">?f1</span> <span class="main">*</span> <span class="var">?f1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict0_times<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">*</span> <span class="free">X</span> <span class="main">(</span>restrict0 carrier <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">*</span> <span class="free">X</span> <span class="main">(</span>restrict0 carrier <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> tangent_space_derivation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> restrict0_const_diff_fun_space<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_const_eq_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">(</span>restrict0 carrier <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> scaleR <span class="main">=</span> diff_fun_space.linear_scale<span class="main">[</span><span class="operator">OF</span> _ _ tangent_space_linear_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>restrict0 carrier <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">X</span> <span class="main">(</span>restrict0 carrier <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scaleR<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> restrict0_const_diff_fun_space<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> derivation_one_eq_zero<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> restrict0_scaleR<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scaleR_fun_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_times_eq_zeroI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> X<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> diff_fun_space"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tangent_space_derivation<span class="main">[</span><span class="operator">OF</span> X d<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_zero_localI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">W</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> diff_fun_space"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">W</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> carrier <span class="main">-</span> <span class="free">W</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> clA<span class="main">:</span> <span class="quoted"><span class="quoted">"closedin <span class="main">(</span>top_of_set carrier<span class="main">)</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">W</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> closedin_def openin_open <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">⊆</span> carrier›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun_on <span class="skolem">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> diff_fun_on_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">⊆</span> carrier›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">carrier</span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span> diff_fun_const<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> carrier <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def U_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> carrier"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> extension_lemmaE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">U</span></span><span class="main">,</span> <span class="operator">OF</span> clA d1 <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">U</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">U</span> <span class="main">⊆</span> carrier›</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">U</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">⟹</span> <span class="skolem">u</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"csupport_on carrier <span class="skolem">u</span> <span class="main">∩</span> carrier <span class="main">⊆</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> u_in_df<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 carrier <span class="skolem">u</span> <span class="main">∈</span> diff_fun_space"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> restrict0_in_fun_space<span class="main">)</span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> U_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict0 carrier <span class="skolem">u</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> u<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> IntI not_in_csupportD subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> restrict0 carrier <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> diff_fun_space›</span></span> u_in_df <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> derivation_times_eq_zeroI<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">*</span> restrict0 carrier <span class="skolem">u</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">W</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> restrict0 carrier <span class="skolem">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">W</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> restrict0 carrier <span class="skolem">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="free">W</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> carrier›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> carrier"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> diff_fun_space›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_fun_space_extensionalD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_outside<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_eq_localI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">f</span> <span class="main">=</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> carrier"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> diff_fun_space"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> diff_fun_space"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> minus <span class="main">=</span> diff_fun_space.linear_diff<span class="main">[</span><span class="operator">OF</span> _ _ _ tangent_space_linear_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-</span> <span class="free">g</span> <span class="main">∈</span> diff_fun_space"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subspace_diff_fun_space <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subspace_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">f</span> <span class="main">-</span> <span class="free">X</span> <span class="free">g</span> <span class="main">=</span> <span class="free">X</span> <span class="main">(</span><span class="free">f</span> <span class="main">-</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">U</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">U</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">-</span> <span class="free">g</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> derivation_zero_localI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Push-forward on the tangent space›</span></span>

<span class="keyword1"><span class="command">context</span></span> diff <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Push-forward on tangent spaces.

  Given an element of the tangent space at src, considered as a functional <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X›</span></span></span></span>,
  the push-forward of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X›</span></span></span></span> is a functional at dest, mapping <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X (g ∘ f)›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">push_forward</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">push_forward</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> restrict0 dest.diff_fun_space <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>restrict0 src.carrier <span class="main">(</span><span class="bound">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extensional_push_forward<span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 dest.diff_fun_space <span class="main">(</span>push_forward <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> push_forward_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_push_forward<span class="main">:</span> <span class="quoted"><span class="quoted">"linear push_forward"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> push_forward_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> o_def restrict0_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> linearI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Properties of push-forwards›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_compose_in_diff_fun_space<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dest.diff_fun_space <span class="main">⟹</span> restrict0 src.carrier <span class="main">(</span><span class="free">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> src.diff_fun_space"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> src.restrict0_in_fun_space<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun_compose<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_axioms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dest.diff_fun_spaceD<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Push-forward of a linear functional is a linear›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> linear_on_diff_fun_push_forward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dest.linear_diff_fun <span class="main">(</span>push_forward <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"src.linear_diff_fun <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">note</span></span> add <span class="main">=</span> src.diff_fun_space.linear_add<span class="main">[</span><span class="operator">OF</span> _ _ _ that<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> scale <span class="main">=</span> src.diff_fun_space.linear_scale<span class="main">[</span><span class="operator">OF</span> _ _ that<span class="main">]</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> dfx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dest.diff_fun_space"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dx<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts2</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 dest.carrier <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dest.diff_fun_space_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"push_forward <span class="free">X</span> <span class="main">(</span><span class="skolem">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> push_forward <span class="free">X</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> push_forward_def
    <span class="keyword1"><span class="command">using</span></span> defined dfx
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subspace_mul scaleR_compose restrict0_scaleR
        restrict_compose_in_diff_fun_space scale<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> dfy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> dest.diff_fun_space"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dy<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts2</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ey<span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 dest.carrier <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dest.diff_fun_space_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"push_forward <span class="free">X</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> push_forward <span class="free">X</span> <span class="skolem">x</span> <span class="main">+</span> push_forward <span class="free">X</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> push_forward_def
    <span class="keyword1"><span class="command">using</span></span> defined dfy dfx
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subspace_add plus_compose restrict0_add restrict_compose_in_diff_fun_space add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Push-forward preserves the product rule›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> push_forward_is_derivation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"push_forward <span class="free">X</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> push_forward <span class="free">X</span> <span class="free">y</span> <span class="main">+</span> <span class="free">y</span> <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> push_forward <span class="free">X</span> <span class="free">x</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">if</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> src.diff_fun_space <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> src.diff_fun_space <span class="main">⟹</span> <span class="free">X</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">y</span> <span class="main">+</span> <span class="bound">y</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dest.diff_fun_space"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> dest.diff_fun_space"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> src.carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">∈</span> dest.diff_fun_space"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dx dy
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dest.diff_fun_space_def dest.diff_fun_times<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="free">X</span> <span class="main">(</span>restrict0 src.carrier <span class="main">(</span><span class="free">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">*</span> restrict0 src.carrier <span class="main">(</span><span class="free">y</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> push_forward_def mult_compose restrict0_times<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> restrict0 src.carrier <span class="main">(</span><span class="free">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="main">(</span>restrict0 src.carrier <span class="main">(</span><span class="free">y</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
    restrict0 src.carrier <span class="main">(</span><span class="free">y</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">p</span> <span class="main">*</span> <span class="free">X</span> <span class="main">(</span>restrict0 src.carrier <span class="main">(</span><span class="free">x</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dx dy 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv restrict_compose_in_diff_fun_space<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dx dy
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> push_forward_def p<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Combining, we show that the push-forward of a derivation is a derivation›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> push_forward_in_tangent_space<span class="main">:</span>
  <span class="quoted"><span class="quoted">"push_forward <span class="main">`</span> <span class="main">(</span>src.tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> src.carrier"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> src.is_derivation_def dest.is_derivation_def src.tangent_space_def dest.tangent_space_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_on_diff_fun_push_forward<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dest.diff_fun_spaceD that push_forward_is_derivation<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> push_forward_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Functoriality of push-forward: identity›</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> push_forward_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff.push_forward <span class="free">k</span> <span class="free">charts</span> <span class="free">charts</span> <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> carrier"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> diff.push_forward_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff.diff_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_id<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext_extensional0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> extensional0_restrict0<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tangent_space_restrict<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext_extensional0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> extensional0_restrict0<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun_space_extensionalD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Functoriality of push-forward: composition›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> push_forward_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff.push_forward <span class="free">k</span> <span class="free">M2</span> <span class="free">M3</span> <span class="free">g</span> <span class="main">(</span>diff.push_forward <span class="free">k</span> <span class="free">M1</span> <span class="free">M2</span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> diff.push_forward <span class="free">k</span> <span class="free">M1</span> <span class="free">M3</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> c_manifold.tangent_space <span class="free">M1</span> <span class="free">k</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> manifold.carrier <span class="free">M1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> df<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">M1</span> <span class="free">M2</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dg<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">M2</span> <span class="free">M3</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> d12<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">M1</span></span> <span class="quoted"><span class="free">M2</span></span> <span class="quoted"><span class="free">f</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> d23<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">M2</span></span> <span class="quoted"><span class="free">M3</span></span> <span class="quoted"><span class="free">g</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> d13<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">M1</span></span> <span class="quoted"><span class="free">M3</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_compose<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext_extensional0<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> d23.extensional_push_forward<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> d13.extensional_push_forward<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> d23.dest.diff_fun_space"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"d23.push_forward <span class="main">(</span>d12.push_forward <span class="free">X</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> d13.push_forward <span class="free">X</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">unfolding</span></span> d12.push_forward_def d23.push_forward_def d13.push_forward_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d23.restrict_compose_in_diff_fun_space<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext_extensional0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> extensional0_restrict0<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> d12.src.diff_fun_space_extensionalD<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> d13.restrict_compose_in_diff_fun_space<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> d12.defined
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> diffeomorphism <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If f is a diffeomorphism, then the push-forward <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f*›</span></span></span></span> is a bijection›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_push_forward_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"push_forward <span class="main">(</span>inv.push_forward <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> dest.tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> dest.carrier"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> push_forward_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that inv.diff_axioms diff_axioms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dest.push_forward_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ that<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> push_forward_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"inv.push_forward <span class="main">(</span>push_forward <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> src.tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> src.carrier"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> push_forward_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that diff_axioms inv.diff_axioms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> src.push_forward_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ that<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_betw_push_forward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_betw push_forward <span class="main">(</span>src.tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">(</span>dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> src.carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betwI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"inv.push_forward"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"push_forward <span class="main">∈</span> src.tangent_space <span class="free">p</span> <span class="main">→</span> dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> push_forward_in_tangent_space<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inv.push_forward <span class="main">∈</span> dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">→</span> src.tangent_space <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv.push_forward_in_tangent_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span>"</span></span><span class="main">]</span> that defined <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inv.push_forward <span class="main">(</span>push_forward <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> src.tangent_space <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> push_forward_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that p<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"push_forward <span class="main">(</span>inv.push_forward <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inv_push_forward_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> defined p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dim_tangent_space_src_dest_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>src.tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> dim <span class="main">(</span>dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> src.carrier"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> dest.tangent_space.dim_pos_finite_dimensional_vector_spaceE<span class="main">[</span>
      <span class="operator">unfolded</span> dest.tangent_space_dim_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main">]</span></span><span class="main">,</span>
      <span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">basis</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">basis</span> <span class="main">⊆</span> dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite_dimensional_vector_space_on_with <span class="main">(</span>dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(+)</span> <span class="main">(-)</span> uminus <span class="main">0</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="skolem">basis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> finite_dimensional_vector_space_on <span class="quoted"><span class="quoted">"<span class="main">(</span>dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted">scaleR</span> <span class="quoted"><span class="skolem">basis</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> finite_dimensional_vector_space_on_with_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">implicit_ab_group_add</span></span> dest.tangent_space.dependent_eq_real dest.tangent_space.span_eq_real<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> rev<span class="main">:</span> finite_dimensional_vector_space_pair_1_on
     <span class="quoted"><span class="quoted">"dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"src.tangent_space <span class="free">p</span>"</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span> <span class="quoted"><span class="skolem">basis</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">from</span></span> bij_betw_push_forward<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on push_forward <span class="main">(</span>src.tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> push_forward <span class="main">`</span> src.tangent_space <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> src.tangent_space.dim <span class="free">p</span> <span class="main">(</span>inv.push_forward <span class="main">`</span> dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rev.dim_image_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ order_refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">inv.push_forward</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span>
        <span class="operator">unfolded</span> dest.tangent_space_dim_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> contra_subsetD defined f_inv image_eqI inv.push_forward_in_tangent_space p<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linear_imp_linear_on<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inv.linear_push_forward<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dest.subspace_tangent_space<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> src.subspace_tangent_space<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def dest.tangent_space.span_eq_real 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> span <span class="main">(</span>dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> span <span class="main">(</span>dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"inv.push_forward <span class="skolem">x</span> <span class="main">=</span> inv.push_forward <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">∈</span> dest.carrier"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> contra_subsetD defined image_eqI p<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a3 a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> c_manifold.subspace_tangent_space c_manifolds_axioms c_manifolds_def inv_push_forward_inverse span_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">∈</span> dest.carrier"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defined p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv.push_forward <span class="main">`</span> dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> src.tangent_space <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv.push_forward_in_tangent_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span>"</span></span><span class="main">]</span> that<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"push_forward <span class="skolem"><span class="skolem">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> push_forward_inverse<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> push_forward <span class="main">`</span> src.tangent_space <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src.tangent_space.dim <span class="free">p</span> <span class="main">…</span> <span class="main">=</span> dim <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> src.tangent_space_dim_eq<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dim_tangent_space_src_dest_eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>src.tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> dim <span class="main">(</span>dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> src.carrier"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>src.tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> rev<span class="main">:</span> diffeomorphism <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">charts2</span></span> <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">f'</span></span> <span class="quoted"><span class="free">f</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> that rev.dim_tangent_space_src_dest_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> contra_subsetD defined image_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Smooth inclusion map›</span></span>

<span class="keyword1"><span class="command">context</span></span> submanifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_inclusion<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="free">S</span><span class="main">)</span> <span class="free">charts</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_id
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff.diff_submanifold<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> charts_submanifold_def <span class="keyword1"><span class="command">using</span></span> open_submanifold
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sublocale</span></span> inclusion<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"charts_submanifold <span class="free">S</span>"</span></span> <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_inclusion<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_on_push_forward_inclusion<span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_on <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> scaleR scaleR inclusion.push_forward"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linear_imp_linear_on<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inclusion.linear_push_forward<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub.subspace_tangent_space<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_tangent_space<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extension lemma: given a differentiable function on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span>, and a closed set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B ⊆ S›</span></span></span></span>,
   there exists a function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f'›</span></span></span></span> agreeing with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B›</span></span></span></span>, such that the support
   of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f'›</span></span></span></span> is contained in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S.›</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> extension_lemma_submanifoldE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'e</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="free">S</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> sub.carrier"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="free">f'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"csupport_on carrier <span class="free">f'</span> <span class="main">∩</span> carrier <span class="main">⊆</span> sub.carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"closedin <span class="main">(</span>top_of_set carrier<span class="main">)</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> closed_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun_on <span class="free">B</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> sub.carrier"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sub.carrier <span class="main">⊆</span> carrier"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open sub.carrier"</span></span> <span class="keyword1"><span class="command">using</span></span> open_submanifold <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"charts_submanifold sub.carrier <span class="main">=</span> charts_submanifold <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> carrier_submanifold charts_submanifold_Int_carrier <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold sub.carrier<span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> extension_lemmaE<span class="main">[</span><span class="operator">OF</span> 1 2 <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">⊆</span> sub.carrier›</span></span><span class="main">]</span> open_submanifold
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="skolem">f'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="skolem">f'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"csupport_on carrier <span class="skolem">f'</span> <span class="main">∩</span> carrier <span class="main">⊆</span> sub.carrier"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_push_forward_inclusion<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on inclusion.push_forward <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sub.carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> sub<span class="main">:</span> vector_space_pair_on <span class="quoted"><span class="quoted">"sub.tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span>"</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sub.linear_inj_iff_eq_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ linear_on_push_forward_inclusion<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sub.tangent_space <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inclusion.push_forward <span class="skolem">v</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inclusion.push_forward_in_tangent_space<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> dv<span class="main">:</span> <span class="quoted"><span class="quoted">"inclusion.push_forward <span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extensional0 sub.diff_fun_space <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v<span class="main">[</span><span class="operator">THEN</span> sub.tangent_space_restrict<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext_extensional0<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extensional0 sub.diff_fun_space <span class="main">(</span><span class="main">0</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> sub.diff_fun_space"</span></span>
      <span class="keyword1"><span class="command">from</span></span> sub.precompact_neighborhoodE<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="skolem">B</span> <span class="main">⊆</span> sub.carrier"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> extension_lemma_submanifoldE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"closure <span class="skolem">B</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> sub.diff_fun_spaceD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="skolem">f'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> closure <span class="skolem">B</span> <span class="main">⟹</span> <span class="skolem">f'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"csupport_on carrier <span class="skolem">f'</span> <span class="main">∩</span> carrier <span class="main">⊆</span> sub.carrier"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> rf'<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 sub.carrier <span class="skolem">f'</span> <span class="main">∈</span> sub.diff_fun_space"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub.restrict0_in_fun_space<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun.diff_fun_submanifold<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> f'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> open_submanifold<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">have</span></span> supp_f'<span class="main">:</span> <span class="quoted"><span class="quoted">"support_on carrier <span class="skolem">f'</span> <span class="main">∩</span> carrier <span class="main">⊆</span> sub.carrier"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f'<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> csupport_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> f'<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> df'<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="main">(</span>restrict0 sub.carrier <span class="skolem">f'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun.diff_fun_cong<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> supp_f'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def support_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> rf'_diff_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 sub.carrier <span class="skolem">f'</span> <span class="main">∈</span> diff_fun_space"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f' df'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space_def extensional0_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">(</span>restrict0 sub.carrier <span class="skolem">f'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub.derivation_eq_localI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> U<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">B</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> B<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> B<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> v<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rf'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> f' B
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inclusion.push_forward <span class="skolem">v</span> <span class="main">(</span>restrict0 sub.carrier <span class="skolem">f'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rf' rf'_diff_fun
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inclusion.push_forward_def o_def restrict0_restrict0<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dv<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> surj_on_push_forward_inclusion<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inclusion.push_forward <span class="main">`</span> sub.tangent_space <span class="free">p</span> <span class="main">⊇</span> tangent_space <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sub.carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
  <span class="keyword3"><span class="command">assume</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> sub.precompact_neighborhoodE<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>closure <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="skolem">B</span> <span class="main">⊆</span> sub.carrier"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> w_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">w</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">b</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> derivation_eq_localI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> U<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">B</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> w B that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> tangent_space_linear_on<span class="main">[</span><span class="operator">OF</span> w<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> linear_w<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_on diff_fun_space UNIV <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> w_add <span class="main">=</span> diff_fun_space.linear_add<span class="main">[</span><span class="operator">OF</span> _ _ _ linear_w<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> w_scale <span class="main">=</span> diff_fun_space.linear_scale<span class="main">[</span><span class="operator">OF</span> _ _ linear_w<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> subspaceI <span class="main">=</span> sub.subspace_diff_fun_space<span class="main">[</span><span class="operator">THEN</span> subspace_add<span class="main">]</span>
    sub.subspace_diff_fun_space<span class="main">[</span><span class="operator">THEN</span> subspace_mul<span class="main">]</span>
    subspace_diff_fun_space<span class="main">[</span><span class="operator">THEN</span> subspace_add<span class="main">]</span>
    subspace_diff_fun_space<span class="main">[</span><span class="operator">THEN</span> subspace_mul<span class="main">]</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">f'</span><span class="main">.</span> <span class="bound">f'</span> <span class="main">∈</span> diff_fun_space <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>closure <span class="skolem">B</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">extend</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">extend</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f'</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">f</span> <span class="bound">f'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">f</span> <span class="bound">f'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> sub.diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="free">S</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub.diff_fun_spaceD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> extension_lemma_submanifoldE<span class="main">[</span><span class="operator">OF</span> this closed_closure <span class="quoted"><span class="quoted">‹closure <span class="skolem">B</span> <span class="main">⊆</span> sub.carrier›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="skolem">f'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> closure <span class="skolem">B</span> <span class="main">⟹</span> <span class="skolem">f'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"csupport_on carrier <span class="skolem">f'</span> <span class="main">∩</span> carrier <span class="main">⊆</span> sub.carrier"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"restrict0 carrier <span class="skolem"><span class="skolem">f'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> f' B
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> restrict0_in_fun_space<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> extend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">extend</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> sub.diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">using</span></span> ex<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> extend_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> extend <span class="main">=</span> extend<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span> extend<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> extend2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> sub.diff_fun_space <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">⟹</span> <span class="skolem">extend</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> extend <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">(</span><span class="skolem">extend</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>

  <span class="keyword1"><span class="command">have</span></span> ext_w<span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 diff_fun_space <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> w <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tangent_space_restrict<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> inclusion.push_forward <span class="main">(</span>restrict0 sub.diff_fun_space <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inclusion.push_forward_def o_def
    <span class="keyword1"><span class="command">using</span></span> ext_w extensional0_restrict0
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext_extensional0<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
    <span class="keyword3"><span class="command">assume</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> diff_fun_space"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="free">charts</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun_spaceD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> <span class="main">(</span>charts_submanifold <span class="free">S</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> open_submanifold
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun.diff_fun_submanifold<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> rgsd<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict0 sub.carrier <span class="skolem">g</span> <span class="main">∈</span> sub.diff_fun_space"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub.restrict0_in_fun_space<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">g</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">(</span>restrict0 sub.carrier <span class="skolem">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> v_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> w_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extend<span class="main">)</span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
        <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"restrict0 sub.carrier <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> B<span class="main">(</span>4<span class="main">)</span> rgsd
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> g rgsd <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">g</span> <span class="main">=</span> restrict0 diff_fun_space <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> restrict0 sub.diff_fun_space <span class="skolem">v</span> <span class="main">(</span>restrict0 sub.carrier <span class="bound">g</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict0 sub.diff_fun_space <span class="skolem">v</span> <span class="main">∈</span> sub.tangent_space <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> extensional0_restrict0
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sub.tangent_spaceI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">v</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sub.diff_fun_space"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> sub.diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">unfolding</span></span> v_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> w_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> w_eqI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extend2 subspaceI extend<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">(</span><span class="skolem">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">v</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sub.diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">c</span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">unfolding</span></span> v_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> w_scale<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> w_eqI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extend2 subspaceI extend<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear_on sub.diff_fun_space UNIV <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="main">(</span>restrict0 sub.diff_fun_space <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">using</span></span> sub.subspace_diff_fun_space<span class="main">[</span><span class="operator">THEN</span> subspace_add<span class="main">]</span>
        sub.subspace_diff_fun_space<span class="main">[</span><span class="operator">THEN</span> subspace_mul<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> sub.diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> sub.diff_fun_space"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">*</span> <span class="skolem">g</span> <span class="main">∈</span> sub.diff_fun_space"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub.diff_fun_space_times<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict0 sub.diff_fun_space <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">*</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">(</span><span class="skolem">extend</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">*</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">(</span><span class="skolem">extend</span> <span class="skolem">f</span> <span class="main">*</span> <span class="skolem">extend</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> w_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_fun_space_times extend f g<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> f g <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extend2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">extend</span> <span class="skolem">f</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">w</span> <span class="main">(</span><span class="skolem">extend</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">extend</span> <span class="skolem">g</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">w</span> <span class="main">(</span><span class="skolem">extend</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_derivation_derivation<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> w <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tangent_space_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extend f g<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="free">p</span> <span class="main">*</span> restrict0 sub.diff_fun_space <span class="skolem">v</span> <span class="skolem">g</span> <span class="main">+</span> <span class="skolem">g</span> <span class="free">p</span> <span class="main">*</span> restrict0 sub.diff_fun_space <span class="skolem">v</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f g v_def extend2 <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> <span class="skolem">B</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict0 sub.diff_fun_space <span class="skolem">v</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">*</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="free">p</span> <span class="main">*</span> restrict0 sub.diff_fun_space <span class="skolem">v</span> <span class="skolem">g</span> <span class="main">+</span> <span class="skolem">g</span> <span class="free">p</span> <span class="main">*</span> restrict0 sub.diff_fun_space <span class="skolem">v</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> inclusion.push_forward <span class="main">`</span> sub.tangent_space <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tangent space of submanifold›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> span_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"span <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> submanifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dim_tangent_space<span class="main">:</span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> dim <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sub.carrier"</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">basis</span></span> <span class="keyword2"><span class="keyword">where</span></span> basis<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="skolem">basis</span>"</span></span> <span class="quoted"><span class="quoted">"span <span class="skolem">basis</span> <span class="main">=</span> span <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dim_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> basis_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">basis</span> <span class="main">⊆</span> sub.tangent_space <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> basis
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> basis<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> span_base span_eq_iff sub.subspace_tangent_space<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">basis</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dim_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> basis span_base
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">basis</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sub.tangent_space <span class="free">p</span> <span class="main">=</span> span <span class="skolem">basis</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> basis<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> span_eq_iff sub.subspace_tangent_space<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sub.tangent_space <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> span_base<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">basis</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_ge_0_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> sub<span class="main">:</span> finite_dimensional_vector_space_on <span class="quoted"><span class="quoted">"sub.tangent_space <span class="free">p</span>"</span></span> <span class="quoted">scaleR</span> <span class="quoted"><span class="skolem">basis</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tangent_space.dependent_eq_real tangent_space.span_eq_real
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> basis <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub.subspace_tangent_space<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">interpret</span></span> sub<span class="main">:</span> finite_dimensional_vector_space_pair_1_on <span class="quoted"><span class="quoted">"sub.tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span>"</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span> <span class="quoted"><span class="skolem">basis</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> tangent_space.dim <span class="free">p</span> <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order_refl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tangent_space_dim_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> tangent_space.dim <span class="free">p</span> <span class="main">(</span>inclusion.push_forward <span class="main">`</span> sub.tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> surj_on_push_forward_inclusion<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> inclusion.push_forward_in_tangent_space<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tangent_space.dim <span class="free">p</span> <span class="main">(</span>inclusion.push_forward <span class="main">`</span> sub.tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
    sub.tangent_space.dim <span class="free">p</span> <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub.dim_image_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">inclusion.push_forward</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ order_refl linear_on_push_forward_inclusion<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> inclusion.push_forward_in_tangent_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tangent_space.span_eq_real span_idem<span class="main">[</span><span class="operator">OF</span> sub.subspace_tangent_space<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_push_forward_inclusion<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dim <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order_refl
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub.tangent_space_dim_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dim_tangent_space2<span class="main">:</span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> dim <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sub.carrier"</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">basis</span></span> <span class="keyword2"><span class="keyword">where</span></span> basis<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="skolem">basis</span>"</span></span> <span class="quoted"><span class="quoted">"span <span class="skolem">basis</span> <span class="main">=</span> span <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dim_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> basis_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">basis</span> <span class="main">⊆</span> tangent_space <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> basis
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> c_manifold.subspace_tangent_space c_manifold_axioms span_base span_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">basis</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dim_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> basis span_base
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">basis</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span> <span class="main">=</span> span <span class="skolem">basis</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> basis<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> span_eq_iff subspace_tangent_space<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> span_base<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">basis</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_ge_0_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> sub<span class="main">:</span> finite_dimensional_vector_space_on <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span>"</span></span> <span class="quoted">scaleR</span> <span class="quoted"><span class="skolem">basis</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tangent_space.dependent_eq_real tangent_space.span_eq_real
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> basis <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subspace_tangent_space<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">interpret</span></span> vector_space_pair_on <span class="quoted"><span class="quoted">"sub.tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span>"</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">interpret</span></span> finite_dimensional_vector_space_pair_1_on <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"sub.tangent_space <span class="free">p</span>"</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span> <span class="quoted"><span class="skolem">basis</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">from</span></span> linear_injective_left_inverse<span class="main">[</span><span class="operator">OF</span> _ linear_on_push_forward_inclusion inj_on_push_forward_inclusion<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sub.carrier›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    inclusion.push_forward_in_tangent_space<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sub.carrier›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> tangent_space <span class="free">p</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="main">∈</span> sub.tangent_space <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"linear_on <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">(</span>sub.tangent_space <span class="free">p</span><span class="main">)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="skolem">g</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> sub.tangent_space <span class="free">p</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="main">(</span>inclusion.push_forward <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inj_on_g<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">g</span> <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inj_on_push_forward_inclusion<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sub.carrier›</span></span><span class="main">]</span> g
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹inclusion.push_forward <span class="main">`</span> sub.tangent_space <span class="free">p</span> <span class="main">⊆</span> tangent_space <span class="free">p</span>›</span></span>
        imageE subset_antisym surj_on_push_forward_inclusion that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> tangent_space.dim <span class="free">p</span> <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order_refl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tangent_space.dim_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sub.tangent_space.dim <span class="free">p</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dim_image_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ order_refl<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> inj_on_g <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tangent_space.span_eq_real span_idem subspace_tangent_space<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">`</span> tangent_space <span class="free">p</span> <span class="main">=</span> sub.tangent_space <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g inj_on_g     <span class="keyword1"><span class="command">using</span></span> inj_on_push_forward_inclusion<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sub.carrier›</span></span><span class="main">]</span> g
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹inclusion.push_forward <span class="main">`</span> sub.tangent_space <span class="free">p</span> <span class="main">⊆</span> tangent_space <span class="free">p</span>›</span></span>
        contra_subsetD image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sub.tangent_space.dim <span class="free">p</span> <span class="main">…</span> <span class="main">=</span> dim <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order_refl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub.tangent_space_dim_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Directional derivatives›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When the manifold is the Euclidean space, The Frechet derivative
   at a in the direction of v is an element of the tangent space at a.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">directional_derivative</span><span class="main">::</span><span class="quoted"><span class="quoted">"enat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">directional_derivative</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> restrict0 <span class="main">(</span>manifold_eucl.diff_fun_space <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> frechet_derivative <span class="bound">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extensional0_directional_derivative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"extensional0 <span class="main">(</span>manifold_eucl.diff_fun_space <span class="free">k</span><span class="main">)</span> <span class="main">(</span>directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> directional_derivative_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> extensional0_directional_derivative_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"extensional0 <span class="main">(</span>manifold_eucl.diff_fun_space <span class="free">k</span><span class="main">)</span> <span class="main">(</span>directional_derivative <span class="free">k'</span> <span class="free">a</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">unfolding</span></span> directional_derivative_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional0_def restrict0_def manifold_eucl.diff_fun_space_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_fun.diff_fun_order_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ that<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> directional_derivative_add<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">x</span> <span class="main">+</span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> directional_derivative_scaleR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> directional_derivative_def restrict0_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> fun_eq_iff
      differentiable_on_def linear_iff that
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> linear_frechet_derivative spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span> smooth_on_imp_differentiable_on<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_directional_derivative<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> linear <span class="main">(</span>directional_derivative <span class="free">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> frechet_derivative_inner<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_at<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_inner_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_inner<span class="main">)</span>    

<span class="keyword1"><span class="command">lemma</span></span> directional_derivative_inner<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∙</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> directional_derivative_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict0_def differentiable_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_apply<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">X</span> <span class="free">i</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">i</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_directional_derivative<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>directional_derivative <span class="free">k</span> <span class="free">a</span><span class="main">)</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subset_UNIV<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> linear_injective_0<span class="main">[</span><span class="operator">OF</span> linear_directional_derivative<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> linear <span class="quoted"><span class="quoted">"directional_derivative <span class="free">k</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_directional_derivative<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> euclidean_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> Basis"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="skolem">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> euclidean_representation<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> frechet_derivative <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_apply <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">∙</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">∈</span> Basis›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_Basis if_distrib <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∙</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∙</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> directional_derivative_eq_frechet_derivative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">v</span> <span class="free">f</span> <span class="main">=</span> frechet_derivative <span class="free">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> UNIV <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> directional_derivative_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> directional_derivative_linear_on_diff_fun_space<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> manifold_eucl.linear_diff_fun <span class="free">k</span> <span class="main">(</span>directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> directional_derivative_eq_frechet_derivative differentiable_onD
      smooth_on_add_fun smooth_on_scaleR_fun
      frechet_derivative_plus_fun frechet_derivative_scaleR_fun<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> directional_derivative_is_derivation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">*</span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">x</span> <span class="free">g</span> <span class="main">+</span> <span class="free">g</span> <span class="free">a</span> <span class="main">*</span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">x</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> manifold_eucl.diff_fun_space <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> manifold_eucl.diff_fun_space <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> directional_derivative_eq_frechet_derivative smooth_on_times_fun
      frechet_derivative_times_fun differentiable_onD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> directional_derivative_in_tangent_space<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="free">x</span> <span class="main">∈</span> manifold_eucl.tangent_space <span class="free">k</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> manifold_eucl.tangent_spaceI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> extensional0_directional_derivative<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> directional_derivative_linear_on_diff_fun_space<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> directional_derivative_is_derivation<span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_derivation_order_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_derivation <span class="free">X</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"c_manifold.is_derivation <span class="free">charts</span> <span class="free">l</span> <span class="free">X</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> l<span class="main">:</span> c_manifold <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">l</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_manifold_order_le<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span> subspace_diff_fun_space
    <span class="keyword1"><span class="command">using</span></span> diff_fun_space_order_le<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_derivation_def l.is_derivation_def linear_on_def module_hom_on_def
        module_hom_on_axioms_def module_on_def subspace_def
        subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_imp_differentiable_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">differentiable_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  Key result: for the Euclidean space, the Frechet derivatives are the
  only elements of the tangent space.

  This result only holds for smooth manifolds, not for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C^k›</span></span></span></span> differentiable
  manifolds. Smoothness is used at a key point in the proof.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> surj_directional_derivative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"range <span class="main">(</span>directional_derivative <span class="free">k</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> manifold_eucl.tangent_space <span class="free">k</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> range <span class="main">(</span>directional_derivative <span class="free">k</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> manifold_eucl.tangent_space <span class="free">k</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> linear_X<span class="main">:</span> <span class="quoted"><span class="quoted">"manifold_eucl.linear_diff_fun <span class="free">k</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> manifold_eucl.tangent_space_linear_on<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">note</span></span> X_sum <span class="main">=</span> manifold_eucl.diff_fun_space.linear_sum'<span class="main">[</span><span class="operator">OF</span> _ _ linear_X<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> X_add <span class="main">=</span> manifold_eucl.diff_fun_space.linear_add<span class="main">[</span><span class="operator">OF</span> _ _ _ linear_X<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> X_scale <span class="main">=</span> manifold_eucl.diff_fun_space.linear_scale<span class="main">[</span><span class="operator">OF</span> _ _ linear_X<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="skolem">v</span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext_extensional0<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> that
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> manifold_eucl.tangent_space_restrict<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> extensional0_directional_derivative<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> manifold_eucl.diff_fun_space <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smooth_on UNIV <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">=</span> <span class="main">∞</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> smooth_on_Taylor2E<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_exp<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="free">a</span> <span class="main">+</span> frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> Basis <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> Basis <span class="main">⟹</span> smooth_on UNIV <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">thm</span></span> X_sum<span class="main">[</span><span class="operator">unfolded</span> sum_fun_def<span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> X_sum<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> sum_fun_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_sum smooth_on_mult smooth_on_inner smooth_on_minus <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> sum.neutral ballI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> X_sum<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> sum_fun_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_mult smooth_on_inner smooth_on_minus g<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_mult smooth_on_inner smooth_on_minus g<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.neutral ballI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
        <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> Basis"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> Basis"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xb</span><span class="main">.</span> <span class="main">(</span><span class="bound">xb</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="bound">xb</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">g</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="bound">xb</span><span class="main">)</span> <span class="main">=</span>
          <span class="skolem">X</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">xb</span><span class="main">.</span> <span class="main">(</span><span class="bound">xb</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xb</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">xb</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">g</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="bound">xb</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_fun_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> manifold_eucl.derivation_times_eq_zeroI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_sum smooth_on_mult smooth_on_inner smooth_on_minus<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_mult smooth_on_inner smooth_on_minus g ij<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">finally</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xb</span><span class="main">.</span> <span class="main">(</span><span class="bound">xb</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="bound">xb</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">g</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="bound">xb</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smooth_on UNIV <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> differentiable_onD<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_imp_differentiable_on<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">interpret</span></span> Df<span class="main">:</span> linear <span class="quoted"><span class="quoted">"frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linear_frechet_derivative<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">have</span></span> X_mult_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> UNIV <span class="skolem">xx</span> <span class="main">⟹</span> <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xx</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">cc</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span> <span class="skolem">xx</span> <span class="main">*</span> <span class="skolem">cc</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xx</span> <span class="skolem">cc</span>
        <span class="keyword1"><span class="command">using</span></span> X_scale<span class="main">[</span><span class="operator">unfolded</span> scaleR_fun_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">xx</span></span> <span class="quoted"><span class="skolem">cc</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> blf<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_linear <span class="main">(</span>frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_bounded_linear<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_worksI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">note</span></span> smooth_on_frechet <span class="main">=</span> smooth_on_compose<span class="main">[</span><span class="operator">OF</span> bounded_linear.smooth_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> blf<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> o_def<span class="main">,</span> <span class="operator">OF</span> _ _ open_UNIV subset_UNIV<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> frechet_derivative <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="skolem">v</span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> v_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> frechet_derivative_componentwise<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> X_sum<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> sum_fun_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_sum smooth_on_mult smooth_on_inner smooth_on_minus<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_frechet smooth_on_minus smooth_on_mult smooth_on_inner<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> X_mult_right<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_sum smooth_on_mult smooth_on_inner smooth_on_minus<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Df.sum<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Df.scaleR<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="skolem">f</span> <span class="main">=</span> directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="skolem">v</span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> f_exp<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> X_add<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> plus_fun_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_add smooth_on_frechet smooth_on_minus<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_add smooth_on_sum smooth_on_mult smooth_on_inner g smooth_on_minus<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> X_add<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> plus_fun_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_add smooth_on_frechet smooth_on_minus<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_frechet smooth_on_minus<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> manifold_eucl.derivation_const_eq_zero<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">f</span></span> <span class="free"><span class="free">a</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">X</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> f
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directional_derivative_def **<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> directional_derivative_in_tangent_space<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> span_directional_derivative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"span <span class="main">(</span>directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="main">`</span> Basis<span class="main">)</span> <span class="main">=</span> manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> span_linear_image<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linear_directional_derivative surj_directional_derivative<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> directional_derivative_in_span<span class="main">:</span>
  <span class="quoted"><span class="quoted">"directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="free">x</span> <span class="main">∈</span> span <span class="main">(</span>directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="main">`</span> Basis<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> span_directional_derivative
  <span class="keyword1"><span class="command">using</span></span> surj_directional_derivative
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_on_directional_derivative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> linear_on UNIV <span class="main">(</span>manifold_eucl.tangent_space <span class="free">k</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="main">(</span>directional_derivative <span class="free">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linear_imp_linear_on<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linear_directional_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> manifold_eucl.subspace_tangent_space<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The directional derivatives at Basis forms a basis of the tangent space at a›</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> manifold_eucl<span class="main">:</span> finite_dimensional_real_vector_space_on
  <span class="quoted"><span class="quoted">"manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="main">`</span> Basis"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"manifold_eucl.tangent_space.dependent <span class="main">(</span>directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="main">`</span> Basis<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> rvo<span class="main">:</span> real_vector_space_pair_on
       <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span><span class="tfree">'a</span> set"</span></span>
       <span class="quoted"><span class="quoted">"manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> UNIV <span class="main">⟶</span> directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">∈</span> manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Basis <span class="main">⊆</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>directional_derivative <span class="main">∞</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>span Basis<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_directional_derivative<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> rvo.linear_dependent_inj_imageD<span class="main">[</span><span class="operator">OF</span> 1 2 linear_on_directional_derivative 4 5<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> independent_Basis
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> span_directional_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> surj_directional_derivative<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">∞</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> independent_directional_derivative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> independent <span class="main">(</span>directional_derivative <span class="free">k</span> <span class="free">a</span> <span class="main">`</span> Basis<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_independent_injective_image<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> independent_Basis linear_directional_derivative inj_on_directional_derivative<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dimension›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the Euclidean space, the dimension of the tangent space
   equals the dimension of the original space.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> dim_eucl_tangent_space<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dim <span class="main">(</span>manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> finite_dimensional_real_vector_space_pair_on
    <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span><span class="tfree">'a</span> set"</span></span>
    <span class="quoted"><span class="quoted">"manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span>"</span></span>
    <span class="quoted">Basis</span> <span class="quoted"><span class="quoted">"directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="main">`</span> Basis"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> independent_Basis<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"manifold_eucl.tangent_space.dim <span class="main">∞</span> <span class="free">a</span> <span class="main">(</span>manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> manifold_eucl.tangent_space.dim <span class="main">∞</span> <span class="free">a</span> <span class="main">(</span>range <span class="main">(</span>directional_derivative <span class="main">∞</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> surj_directional_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> vs1.dim <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dim_image_eq<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linear_on_directional_derivative inj_on_directional_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vs1.dim_UNIV<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> manifold_eucl.tangent_space.dim <span class="main">∞</span> <span class="free">a</span> <span class="main">(</span>manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dim <span class="main">(</span>manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> manifold_eucl.basis_subset _ independent_directional_derivative
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dim_unique<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span> <span class="main">⊆</span> span <span class="main">(</span>directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="main">`</span> Basis<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> span_directional_derivative<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="main">`</span> Basis<span class="main">)</span> <span class="main">=</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_directional_derivative<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> *
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>directional_derivative <span class="main">∞</span> <span class="free">a</span> <span class="main">`</span> Basis<span class="main">)</span> <span class="main">=</span>
      manifold_eucl.tangent_space.dim <span class="main">∞</span> <span class="free">a</span> <span class="main">(</span>manifold_eucl.tangent_space <span class="main">∞</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For a general manifold, the dimension of the tangent space at point p
   equals the dimension of the manifold.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> dim_tangent_space<span class="main">:</span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">and</span></span> smooth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> carrierE<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">charts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> domain <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> submanifold <span class="quoted"><span class="free">charts</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"domain <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"charts_submanifold <span class="main">(</span>domain <span class="skolem">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"manifold_eucl.charts_submanifold <span class="main">(</span>codomain <span class="skolem">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="quoted"><span class="skolem">c</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff.diff_submanifold2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_apply_chart<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="free">charts</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> diff <span class="quoted"><span class="free">k</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="quoted"><span class="quoted">"inv_chart <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff.diff_submanifold2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> diff_inv_chart<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="free">charts</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff a.dest.carrierE domain_restrict_chart image_empty image_insert
        inv_chart_in_domain manifold_eucl.dest.charts_submanifold_def open_codomain singletonD<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> b<span class="main">:</span> submanifold <span class="quoted">charts_eucl</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"codomain <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">interpret</span></span> diffeomorphism <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"inv_chart <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> dim <span class="main">(</span>a.dest.tangent_space <span class="main">(</span><span class="skolem">c</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> dim <span class="main">(</span>manifold_eucl.tangent_space <span class="free">k</span> <span class="main">(</span><span class="skolem">c</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> smooth dim_eucl_tangent_space <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dim <span class="main">(</span>a.dest.tangent_space <span class="main">(</span><span class="skolem">c</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> b.dim_tangent_space2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">c</span></span> <span class="free"><span class="free">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> domain <span class="skolem">c</span>›</span></span> that
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> *<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dim <span class="main">(</span>a.sub.tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dim_tangent_space_src_dest_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> *<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> domain <span class="skolem">c</span>›</span></span> that 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> a.dim_tangent_space<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> *<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> **<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> domain <span class="skolem">c</span>›</span></span> that 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Cotangent_Space">
<div class="head">
<h1>Theory Cotangent_Space</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Cotangent Space›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Cotangent_Space
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Tangent_Space.html">Tangent_Space</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dual of a vector space›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">linear_fun_on</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> linear_on <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>UNIV<span class="main">::</span>real set<span class="main">)</span> scaleR scaleR"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dual_space</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_vector set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dual_space</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> linear_fun_on <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">E</span> <span class="main">∧</span> extensional0 <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">E</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dual_space_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dual_space <span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> linear_fun_on <span class="free">S</span> <span class="bound">E</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">E</span><span class="main">.</span> extensional0 <span class="free">S</span> <span class="bound">E</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_space_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_dual_space<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> dual_space <span class="free">S</span> <span class="main">⟷</span> linear_fun_on <span class="free">S</span> <span class="free">E</span> <span class="main">∧</span> extensional0 <span class="free">S</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_space_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dual_spaceI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> dual_space <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_space_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dual_spaceD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> dual_space <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> dual_space_linear_on<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="free">E</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dual_space_restrict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_space_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_fun_on_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> that<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subspace_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="free">a</span> <span class="main">+</span> <span class="free">x</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linear_on.axioms module_hom_on.add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_fun_on_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> x that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> linear_on.axioms
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> module_hom_on.add module_hom_on.scale subspace_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_fun_on_scaleR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> x that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> linear_on.axioms
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> module_hom_on.add module_hom_on.scale <span class="dynamic"><span class="dynamic">algebra_simps</span></span> subspace_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_linear_fun_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subspace <span class="main">{</span><span class="bound">E</span><span class="main">.</span> linear_fun_on <span class="free">S</span> <span class="bound">E</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subspace_def linear_fun_on_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span>
      linear_fun_on_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ that<span class="main"><span class="main">]</span></span> linear_fun_on_scaleR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ that<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_dual_space<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>dual_space <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dual_space_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_inter<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_linear_fun_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_extensional0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dimension of dual space›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mapping from S to the dual of S›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span> <span class="free">S</span> <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"independent <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"span <span class="free">B</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inner_Basis</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> representation <span class="free">B</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span> <span class="main">*</span> representation <span class="free">B</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹TODO: move to library›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">std_dual</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_vector <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">std_dual</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> restrict0 <span class="free">S</span> <span class="main">(</span>restrict0 <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> inner_Basis <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">b2</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> inner_Basis <span class="main">(</span><span class="free">b1</span> <span class="main">+</span> <span class="free">b2</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> inner_Basis <span class="free">b1</span> <span class="free">v</span> <span class="main">+</span> inner_Basis <span class="free">b2</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> std_dual_def restrict0_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> representation_add representation_scale
      B inner_Basis_def
      sum.distrib sum_distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_add2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">b2</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> inner_Basis <span class="free">v</span> <span class="main">(</span><span class="free">b1</span> <span class="main">+</span> <span class="free">b2</span><span class="main">)</span> <span class="main">=</span> inner_Basis <span class="free">v</span> <span class="free">b1</span> <span class="main">+</span> inner_Basis <span class="free">v</span> <span class="free">b2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> std_dual_def restrict0_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> representation_add representation_scale
      B inner_Basis_def
      sum.distrib sum_distrib_left<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_scale<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> inner_Basis <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b1</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> inner_Basis <span class="free">b1</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> std_dual_def restrict0_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> representation_add representation_scale
      B inner_Basis_def sum.distrib sum_distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_scale2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> inner_Basis <span class="free">v</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b1</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> inner_Basis <span class="free">v</span> <span class="free">b1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> std_dual_def restrict0_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> representation_add representation_scale
      B inner_Basis_def sum.distrib sum_distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_minus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">b2</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> inner_Basis <span class="main">(</span><span class="free">b1</span> <span class="main">-</span> <span class="free">b2</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> inner_Basis <span class="free">b1</span> <span class="free">v</span> <span class="main">-</span> inner_Basis <span class="free">b2</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inner_Basis_minus2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">b2</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> inner_Basis <span class="free">v</span> <span class="main">(</span><span class="free">b1</span> <span class="main">-</span> <span class="free">b2</span><span class="main">)</span> <span class="main">=</span> inner_Basis <span class="free">v</span> <span class="free">b1</span> <span class="main">-</span> inner_Basis <span class="free">v</span> <span class="free">b2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> std_dual_def restrict0_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> representation_diff representation_scale
      B inner_Basis_def
      sum_subtractf sum_distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_zero_representation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> representation <span class="free">B</span> <span class="free">v</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> representation <span class="free">B</span> <span class="free">v</span> <span class="bound">b</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> representation_ne_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> span <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B v <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> sum_nonzero_representation_eq<span class="main">[</span><span class="operator">OF</span> B<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inner_Basis <span class="main">0</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"inner_Basis <span class="free">a</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_Basis_def representation_zero<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_eq_zeroI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"inner_Basis <span class="free">a</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_zero_representation<span class="main">)</span>
    <span class="main">(</span><span class="operator">use</span> that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> inner_Basis_def that sum_nonneg_eq_0_iff›</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"inner_Basis <span class="free">a</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_Basis_eq_zeroI that<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> S<span class="main">:</span> real_vector_space_on <span class="quoted"><span class="free">S</span></span>
  <span class="keyword1"><span class="command">using</span></span> subspace_S
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">interpretation</span></span> dual<span class="main">:</span> real_vector_space_on <span class="quoted"><span class="quoted">"dual_space <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subspace_dual_space<span class="main">[</span><span class="operator">OF</span> subspace_S<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">lemma</span></span> std_dual_linear<span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_on <span class="free">S</span> <span class="main">(</span>dual_space <span class="free">S</span><span class="main">)</span> scaleR scaleR std_dual"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subspace_S<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subspace_def<span class="main"><span class="main">]</span></span> subspace_dual_space<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subspace_def<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span>
      std_dual_def inner_Basis_scale inner_Basis_add restrict0_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> image_std_dual<span class="main">:</span>
  <span class="quoted"><span class="quoted">"std_dual <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> dual_space <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"std_dual <span class="skolem">y</span> <span class="main">∈</span> dual_space <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dual_spaceI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="main">(</span>std_dual <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> std_dual_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="main">(</span>std_dual <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> std_dual_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> that<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subspace_def<span class="main"><span class="main">]</span></span>
        inner_Basis_add2 inner_Basis_scale2 B<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_std_dual<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on std_dual <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"std_dual <span class="skolem">x</span> <span class="main">=</span> std_dual <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inner_Basis <span class="skolem">x</span> <span class="skolem">b</span> <span class="main">=</span> inner_Basis <span class="skolem">y</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"std_dual <span class="skolem">x</span> <span class="skolem">b</span> <span class="main">=</span> inner_Basis <span class="skolem">x</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"std_dual <span class="skolem">y</span> <span class="skolem">b</span> <span class="main">=</span> inner_Basis <span class="skolem">y</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> std_dual_def restrict0_def
      <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> x y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subspace_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inner_Basis <span class="skolem">x</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">-</span> inner_Basis <span class="skolem">y</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inner_Basis <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_Basis_minus inner_Basis_minus2 2 B x y <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_Basis_zero B that 2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> inner_Basis <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">x</span> <span class="bound">i</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> inner_Basis <span class="main">(</span><span class="free">x</span> <span class="bound">i</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> inner_Basis_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subspace_span subspace_sum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_sum2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> inner_Basis <span class="free">v</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">x</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> inner_Basis <span class="free">v</span> <span class="main">(</span><span class="free">x</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> inner_Basis_add2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subspace_span subspace_sum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> B_sub_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> B<span class="main">(</span>2<span class="main">)</span> span_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_Basis_eq_representation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inner_Basis <span class="free">i</span> <span class="free">x</span> <span class="main">=</span> representation <span class="free">B</span> <span class="free">x</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inner_Basis_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> B that representation_basis if_distrib if_distribR <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> surj_std_dual<span class="main">:</span>
  <span class="quoted"><span class="quoted">"std_dual <span class="main">`</span> <span class="free">S</span> <span class="main">⊇</span> dual_space <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"subspace <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> dual_space <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> std_dual <span class="main">`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">(* Basic idea: let v_i be a basis of S. Let x be the sum of (y v_i) * v_i.
       Then y should be equal to std_dual S ` x. *)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="skolem">y</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_sum<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_scale<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> B span_superset
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> dual_space_linear_on<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> linear_y<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> linear_on <span class="quoted"><span class="free">S</span></span> <span class="quoted">UNIV</span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span> <span class="quoted"><span class="skolem">y</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> vector_space_pair_on <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span>real set"</span></span> <span class="quoted">scaleR</span> <span class="quoted">scaleR</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> std_dual <span class="var">?x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext_extensional0<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> y dual_space_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> std_dual_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> std_dual_def restrict0_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> inner_Basis_sum<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> B<span class="main">(</span>2<span class="main">)</span> span_base subspace_scale <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> inner_Basis <span class="main">(</span><span class="skolem">y</span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">(</span>inner_Basis <span class="bound">i</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">:</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_sub_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inner_Basis <span class="main">(</span><span class="skolem">y</span> <span class="skolem">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="skolem">i</span> <span class="main">*</span> inner_Basis <span class="skolem">i</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> inner_Basis_scale<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> B_sub_S i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">y</span> <span class="skolem">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> inner_Basis <span class="skolem">i</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">(</span>inner_Basis <span class="skolem">i</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> scale<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inner_Basis <span class="main">(</span><span class="skolem">y</span> <span class="skolem">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">(</span>inner_Basis <span class="skolem">i</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="main">(</span>inner_Basis <span class="bound">i</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="skolem">y</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> linear_sum'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ linear_y<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_Basis_eq_representation<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> B<span class="main">(</span>2<span class="main">)</span> S.mem_scale span_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> inner_Basis_eq_representation<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_representation_eq<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that B <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">:</span> <span class="free">S</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> std_dual_bij_betw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>std_dual<span class="main">)</span> <span class="free">S</span> <span class="main">(</span>dual_space <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
  <span class="keyword1"><span class="command">using</span></span> subspace_S inj_std_dual image_std_dual surj_std_dual that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> std_dual_eq_dual_space<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span> <span class="main">⟹</span> std_dual <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> dual_space <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> image_std_dual surj_std_dual subspace_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dim_dual_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>dual_space <span class="free">S</span><span class="main">)</span> <span class="main">=</span> dim <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> finite_dimensional_real_vector_space_pair_1_on <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"dual_space <span class="free">S</span>"</span></span> <span class="quoted"><span class="free">B</span></span>
    <span class="keyword1"><span class="command">using</span></span> B assms span_superset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"span <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subspace_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dual.dim <span class="main">(</span>std_dual <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> S.dim <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> dim_image_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ order_refl std_dual_linear<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> std_dual_bij_betw<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def *<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S.dim <span class="free">S</span> <span class="main">=</span> dim <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S.dim_eq<span class="main">[</span><span class="operator">OF</span> order_refl<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dual.dim <span class="main">(</span>std_dual <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> dim <span class="main">(</span>std_dual <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> image_std_dual<span class="main">[</span><span class="operator">OF</span> subspace_S<span class="main">]</span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dual.dim_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"std_dual <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> dual_space <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> std_dual_eq_dual_space<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dual map›</span></span>

<span class="keyword1"><span class="command">context</span></span> real_vector_space_pair_on <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dual_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dual_map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> restrict0 <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_dual_S<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>dual_space <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_dual_space<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> local.vs1.subspace<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_dual_T<span class="main">:</span> <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>dual_space <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_dual_space<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> local.vs2.subspace<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dual_map_linear<span class="main">:</span>
  <span class="quoted"><span class="quoted">"linear_on <span class="main">(</span>dual_space <span class="free">T</span><span class="main">)</span> <span class="main">(</span>dual_space <span class="free">S</span><span class="main">)</span> scaleR scaleR <span class="main">(</span>dual_map <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_map_def restrict0_def subspace_dual_S<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subspace_def<span class="main"><span class="main">]</span></span>
                     subspace_dual_T<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subspace_def<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_dual_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dual_map <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>dual_space <span class="free">T</span><span class="main">)</span> <span class="main">⊆</span> dual_space <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_on <span class="free">S</span> <span class="free">T</span> scaleR scaleR <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dual_space <span class="free">T</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dual_map <span class="free">f</span> <span class="skolem">x</span> <span class="main">∈</span> dual_space <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dual_spaceI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">T</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dual_space_linear_on<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="main">(</span>dual_map <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_map_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="free">S</span> <span class="main">(</span>dual_map <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_map_def restrict0_def linear_on_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> 
             local.vs1.subspace<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> subspace_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">+</span> <span class="skolem">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">b1</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">b2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b1</span> <span class="skolem">b2</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">b1</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b1</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> defined <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">b2</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b2</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> defined <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">+</span> <span class="skolem">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">b1</span> <span class="main">+</span> <span class="free">f</span> <span class="skolem">b2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> linear_on.axioms<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> module_hom_on.add<span class="main"><span class="main">]</span></span> that<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">b1</span> <span class="main">+</span> <span class="free">f</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">b1</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">b2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> linear_on.axioms<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> module_hom_on.add<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">b1</span> <span class="main">∈</span> <span class="free">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">b2</span> <span class="main">∈</span> <span class="free">T</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">b</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> defined <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> linear_on.axioms<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> module_hom_on.scale<span class="main"><span class="main">]</span></span> that<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> linear_on.axioms<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> module_hom_on.scale<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">b</span> <span class="main">∈</span> <span class="free">T</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Functoriality of dual map: identity›</span></span>

<span class="keyword1"><span class="command">context</span></span> real_vector_space_on <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dual_map_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"real_vector_space_pair_on.dual_map <span class="free">S</span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> dual_space <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext_extensional0<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"real_vector_space_pair_on <span class="free">S</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="main">(</span>real_vector_space_pair_on.dual_map <span class="free">S</span> <span class="free">f</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_vector_space_pair_on.dual_map_def<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extensional0 <span class="free">S</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real_vector_space_pair_on.dual_map <span class="free">S</span> <span class="free">f</span> <span class="free">y</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">y</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_vector_space_pair_on.dual_map <span class="free">S</span> <span class="free">f</span> <span class="free">y</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> real_vector_space_pair_on.dual_map_def<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span> restrict0_def x<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dual_map</span> <span class="main">≡</span> real_vector_space_pair_on.dual_map"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> dual_map_def <span class="main">=</span> real_vector_space_pair_on.dual_map_def

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Functoriality of dual map: composition›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dual_map_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dual_map <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>dual_map <span class="free">T</span> <span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> dual_map <span class="free">S</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dual_space <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"linear_on <span class="free">T</span> <span class="free">U</span> scaleR scaleR <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_on <span class="free">S</span> <span class="free">T</span> scaleR scaleR <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ST<span class="main">:</span> <span class="quoted"><span class="quoted">"real_vector_space_pair_on <span class="free">S</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> TU<span class="main">:</span> <span class="quoted"><span class="quoted">"real_vector_space_pair_on <span class="free">T</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> SU<span class="main">:</span> <span class="quoted"><span class="quoted">"real_vector_space_pair_on <span class="free">S</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ST TU <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_vector_space_pair_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dual_map <span class="free">S</span> <span class="free">f</span> <span class="main">(</span>dual_map <span class="free">T</span> <span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> dual_map <span class="free">S</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">v</span>"</span></span>    
  <span class="keyword1"><span class="command">unfolding</span></span> dual_map_def<span class="main">[</span><span class="operator">OF</span> ST<span class="main">]</span> dual_map_def<span class="main">[</span><span class="operator">OF</span> TU<span class="main">]</span> dual_map_def<span class="main">[</span><span class="operator">OF</span> SU<span class="main">]</span> restrict0_def
  <span class="keyword1"><span class="command">using</span></span> defined <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of cotangent space›</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cotangent_space</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cotangent_space</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> dual_space <span class="main">(</span>tangent_space <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subspace_cotangent_space<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subspace <span class="main">(</span>cotangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cotangent_space_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_dual_space<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subspace_tangent_space<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sublocale</span></span> cotangent_space<span class="main">:</span> real_vector_space_on <span class="quoted"><span class="quoted">"cotangent_space <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">rule</span> subspace_cotangent_space<span class="main">)</span>

<span class="comment1">(* Shouldn't there be a general theorem for this, instead of repeating the proof
   for tangent_space_dim_eq?
*)</span>
<span class="keyword1"><span class="command">lemma</span></span> cotangent_space_dim_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"cotangent_space.dim <span class="free">p</span> <span class="free">X</span> <span class="main">=</span> dim <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> cotangent_space <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⊆</span> cotangent_space <span class="free">p</span> <span class="main">∧</span> independent <span class="skolem">b</span> <span class="main">∧</span> span <span class="skolem">b</span> <span class="main">=</span> span <span class="free">X</span> <span class="main">⟷</span> independent <span class="skolem">b</span> <span class="main">∧</span> span <span class="skolem">b</span> <span class="main">=</span> span <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> c_manifold.subspace_cotangent_space c_manifold_axioms span_base span_eq_iff span_mono subsetCE<span class="main">)</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">unfolding</span></span> cotangent_space.dim_def dim_def *
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dim_cotangent_space<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dim <span class="main">(</span>cotangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> carrier"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> basis_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊆</span> tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"independent <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"tangent_space <span class="free">p</span> <span class="main">⊆</span> span <span class="skolem">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"card <span class="skolem">B</span> <span class="main">=</span> dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> card_ge_0_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> B
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dim_tangent_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>cotangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cotangent_space_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dim_dual_space<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">B</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> B span_minimal<span class="main">[</span><span class="operator">OF</span> B<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subspace_tangent_space<span class="main">]</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dim_tangent_space<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pullback of cotangent space›</span></span>

<span class="keyword1"><span class="command">context</span></span> diff <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pull_back</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pull_back</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> dual_map <span class="main">(</span>src.tangent_space <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> push_forward"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  linear_pullback<span class="main">:</span> <span class="quoted"><span class="quoted">"linear_on <span class="main">(</span>dest.cotangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>src.cotangent_space <span class="free">p</span><span class="main">)</span> scaleR scaleR <span class="main">(</span>pull_back <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  image_pullback<span class="main">:</span> <span class="quoted"><span class="quoted">"pull_back <span class="free">p</span> <span class="main">`</span> <span class="main">(</span>dest.cotangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> src.cotangent_space <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> src.carrier"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> a<span class="main">:</span> real_vector_space_pair_on <span class="quoted"><span class="quoted">"src.tangent_space <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"dest.tangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear_on <span class="main">(</span>dest.cotangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>src.cotangent_space <span class="free">p</span><span class="main">)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="main">(</span>pull_back <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dest.cotangent_space_def src.cotangent_space_def pull_back_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> a.dual_map_linear<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pull_back <span class="free">p</span> <span class="main">`</span> <span class="main">(</span>dest.cotangent_space <span class="main">(</span><span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> src.cotangent_space <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dest.cotangent_space_def src.cotangent_space_def pull_back_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> a.image_dual_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linear_imp_linear_on<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> local.linear_push_forward<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> local.src.subspace_tangent_space<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> local.dest.subspace_tangent_space<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> local.push_forward_in_tangent_space<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cotangent field of a function›</span></span>

<span class="keyword1"><span class="command">context</span></span> c_manifold <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given a function f, the cotangent vector of f at a point p is defined
  as follows: given a tangent vector X at p, considered as a functional, evaluate
  X on f.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cotangent_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cotangent_field</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> restrict0 <span class="main">(</span>tangent_space <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cotangent_field_is_cotangent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cotangent_field <span class="free">f</span> <span class="free">p</span> <span class="main">∈</span> cotangent_space <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cotangent_space_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dual_spaceI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extensional0 <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">(</span>cotangent_field <span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cotangent_field_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear_fun_on <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">(</span>cotangent_field <span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span> <span class="keyword1"><span class="command">unfolding</span></span> cotangent_field_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict0 <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">+</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b1</span> <span class="free">f</span> <span class="main">+</span> <span class="skolem">b2</span> <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b1</span> <span class="skolem">b2</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">+</span> <span class="skolem">b2</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b1 b2 subspace_tangent_space subspace_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict0 <span class="main">(</span>tangent_space <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">b</span> <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">b</span> <span class="main">∈</span> tangent_space <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b subspace_tangent_space subspace_scale <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tangent field of a path›</span></span>

<span class="comment1">(* Note: an alternative definition is as follows: consider the path as
   a smooth map from the manifold with boundary [a,b], then take the
   push-forward of the trivial tangent field on [a,b]. In this case,
   showing this is a tangent vector would be trivial. *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given a path <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span>, the tangent vector of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> at real number <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> (or at point <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c(x)›</span></span></span></span>)
  is defined as follows: given a function f, take the derivative of the
  real-valued function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f ∘ c›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tangent_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tangent_field</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> restrict0 diff_fun_space <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> frechet_derivative <span class="main">(</span><span class="bound">f</span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tangent_field_is_tangent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tangent_field <span class="free">c</span> <span class="free">x</span> <span class="main">∈</span> tangent_space <span class="main">(</span><span class="free">c</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> c_smooth<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> charts_eucl <span class="free">charts</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> smooth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tangent_spaceI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"extensional0 diff_fun_space <span class="main">(</span>tangent_field <span class="free">c</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tangent_field_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> diff_fun_c_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> diff_fun_space"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> diff_b<span class="main">:</span> <span class="quoted"><span class="quoted">"diff_fun <span class="free">k</span> charts_eucl <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">o</span> <span class="free">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> diff_fun_def
      <span class="keyword1"><span class="command">using</span></span> c_smooth diff_fun_spaceD<span class="main">[</span><span class="operator">OF</span> b<span class="main">,</span> <span class="operator">THEN</span> diff_fun.axioms<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_compose<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> diff_fun_charts_euclD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> smooth
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span> <span class="keyword1">o</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_imp_differentiable_on<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear_fun_on diff_fun_space <span class="main">(</span>tangent_field <span class="free">c</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span> <span class="keyword1"><span class="command">unfolding</span></span> cotangent_field_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tangent_field <span class="free">c</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">+</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">=</span> tangent_field <span class="free">c</span> <span class="free">x</span> <span class="skolem">b1</span> <span class="main">+</span> tangent_field <span class="free">c</span> <span class="free">x</span> <span class="skolem">b2</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b1</span> <span class="skolem">b2</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tangent_field_def restrict0_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space_add o_def diff_fun_c_diff b1 b2 frechet_derivative_plus<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tangent_field <span class="free">c</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> tangent_field <span class="free">c</span> <span class="free">x</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tangent_field_def restrict0_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space.m1.mem_scale o_def diff_fun_c_diff b frechet_derivative_times
          frechet_derivative_const<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tangent_field <span class="free">c</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">*</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span><span class="free">c</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> tangent_field <span class="free">c</span> <span class="free">x</span> <span class="skolem">g</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">c</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> tangent_field <span class="free">c</span> <span class="free">x</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">g</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tangent_field_def restrict0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f g diff_fun_space_times diff_fun_space_add o_def diff_fun_c_diff
        frechet_derivative_plus frechet_derivative_times<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Integral along a path›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fundamental_theorem_of_path_integral<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>cotangent_field <span class="free">f</span> <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tangent_field <span class="free">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span><span class="free">c</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span><span class="free">c</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> diff_fun_space"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> charts_eucl <span class="free">charts</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diff <span class="free">k</span> <span class="free">charts</span> charts_eucl <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_fun_space_def diff_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>diff_fun <span class="free">k</span> charts_eucl <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> diff_fun_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> diff_compose<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> c<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_on</span> UNIV <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> diff_fun_charts_euclD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">differentiable_on</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_imp_differentiable_on<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> k <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">c</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differentiable_on_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ab
    <span class="keyword1"><span class="command">unfolding</span></span> cotangent_field_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tangent_field_is_tangent c k<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tangent_field_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fundamental_theorem_of_calculus<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_vector_derivative_at_within<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> o_def has_vector_derivative_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> frechet_derivative_at_real_eq_scaleR<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frechet_derivative_worksI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Product_Manifold">
<div class="head">
<h1>Theory Product_Manifold</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Product Manifold›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Product_Manifold
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Differentiable_Manifold.html">Differentiable_Manifold</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> c_manifold_prod <span class="main">=</span>
  m1<span class="main">:</span> c_manifold <span class="quoted"><span class="free">charts1</span></span> <span class="quoted"><span class="free">k</span></span> <span class="main">+</span> 
  m2<span class="main">:</span> c_manifold <span class="quoted"><span class="free">charts2</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">charts1</span> <span class="free">charts2</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> prod_chart <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> chart <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> chart <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">d</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">,</span> <span class="bound">d'</span><span class="main">::</span><span class="tfree">'b</span> set<span class="main">,</span> <span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">,</span> <span class="bound">f'</span><span class="main">::</span><span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span>
      <span class="main">λ</span><span class="main">(</span><span class="bound">e</span><span class="main">::</span><span class="tfree">'c</span> set<span class="main">,</span> <span class="bound">e'</span><span class="main">::</span><span class="tfree">'d</span> set<span class="main">,</span> <span class="bound">g</span><span class="main">::</span><span class="tfree">'c</span><span class="main">⇒</span><span class="tfree">'d</span><span class="main">,</span> <span class="bound">g'</span><span class="main">::</span><span class="tfree">'d</span><span class="main">⇒</span><span class="tfree">'c</span><span class="main">)</span><span class="main">.</span>
        <span class="main">(</span><span class="bound">d</span> <span class="main">×</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">d'</span> <span class="main">×</span> <span class="bound">e'</span><span class="main">,</span> <span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f'</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">g'</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> open_Times <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_prod<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> domain_prod_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="main">(</span>prod_chart <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> domain <span class="free">c1</span> <span class="main">×</span> domain <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> codomain_prod_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"codomain <span class="main">(</span>prod_chart <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> codomain <span class="free">c1</span> <span class="main">×</span> codomain <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> apply_prod_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_chart <span class="main">(</span>prod_chart <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">c1</span> <span class="bound">x</span><span class="main">,</span> <span class="free">c2</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv_chart_prod_chart<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_chart <span class="main">(</span>prod_chart <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>inv_chart <span class="free">c1</span> <span class="bound">x</span><span class="main">,</span> inv_chart <span class="free">c2</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_chart_compat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="main">(</span>prod_chart <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>prod_chart <span class="free">d1</span> <span class="free">d2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> compat1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c1</span> <span class="free">d1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> compat2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="free">c2</span> <span class="free">d2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smooth_compat_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def case_prod_beta <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_Int_Times image_prod<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_Pair'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compat1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> smooth_compat_def comp_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compat2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> smooth_compat_def comp_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Times_Int_Times image_prod<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_Pair'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compat2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> smooth_compat_def comp_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compat1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> smooth_compat_def comp_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prod_charts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> chart set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_charts</span> <span class="main">=</span> <span class="main">{</span>prod_chart <span class="bound">c1</span> <span class="bound">c2</span> <span class="main">|</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="bound">c1</span> <span class="main">∈</span> <span class="free">charts1</span> <span class="main">∧</span> <span class="bound">c2</span> <span class="main">∈</span> <span class="free">charts2</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_manifold_atlas_product<span class="main">:</span> <span class="quoted"><span class="quoted">"c_manifold prod_charts <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> prod_charts"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> prod_charts"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> c_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> prod_chart <span class="skolem">c1</span> <span class="skolem">c2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">∈</span> <span class="free">charts1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">∈</span> <span class="free">charts2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c prod_charts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d1</span></span> <span class="skolem"><span class="skolem">d2</span></span> <span class="keyword2"><span class="keyword">where</span></span> d_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> prod_chart <span class="skolem">d1</span> <span class="skolem">d2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span> <span class="main">∈</span> <span class="free">charts1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d2</span> <span class="main">∈</span> <span class="free">charts2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d prod_charts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> compat1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="skolem">c1</span> <span class="skolem">d1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 d1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> m1.pairwise_compat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> compat2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="skolem">c2</span> <span class="skolem">d2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c2 d2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> m2.pairwise_compat<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="keyword1">-smooth_compat</span> <span class="skolem">c</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> c_def d_def
  <span class="keyword1"><span class="command">using</span></span> compat1 compat2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_chart_compat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Sphere">
<div class="head">
<h1>Theory Sphere</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sphere›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Sphere
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Differentiable_Manifold.html">Differentiable_Manifold</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="quoted">real_normed_vector</span><span class="main">)</span> sphere <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">×</span>real<span class="main">.</span> norm <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_sphere

<span class="comment1">(* First stereographic projection: between S^n - (0,1) and R^n. *)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> top_sphere <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span> sphere"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> st_proj1 <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span> sphere <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> st_proj1_inv <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> sphere"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_prod_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nonneg_eq_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="comment1">(* Second stereographic projection: between S^n - (0,-1) and R^n. *)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> bot_sphere <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span> sphere"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> st_proj2 <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span> sphere <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> st_proj2_inv <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>real_normed_vector<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> sphere"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_prod_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nonneg_eq_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> sphere <span class="main">::</span> <span class="main">(</span><span class="quoted">real_normed_vector</span><span class="main">)</span> <span class="quoted">topological_space</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">open_sphere</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sphere set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"openin <span class="main">(</span>subtopology <span class="main">(</span>euclidean<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">×</span>real<span class="main">)</span> topology<span class="main">)</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> norm <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> sphere <span class="main">::</span> <span class="main">(</span><span class="quoted">real_normed_vector</span><span class="main">)</span> <span class="quoted">t2_space</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hausdorff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> U V
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">U</span></span> <span class="main"><span class="main">∩</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">.</span></span> norm <span class="bound"><span class="bound">a</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">V</span></span> <span class="main"><span class="main">∩</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">.</span></span> norm <span class="bound"><span class="bound">a</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instance</span></span> sphere <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">second_countable_topology</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">BB</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span>real<span class="main">)</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> BB<span class="main">:</span> <span class="quoted"><span class="quoted">"countable <span class="skolem">BB</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">=</span> generate_topology <span class="skolem">BB</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ex_countable_subbasis<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">BB</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B</span><span class="main">::</span><span class="tfree">'a</span> sphere set set<span class="main">.</span> countable <span class="bound">B</span> <span class="main">∧</span> open <span class="main">=</span> generate_topology <span class="bound">B</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?B</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> BB <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> BB <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> openin_subtopology_eq_generate_topology<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> BB<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">BB</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_continuous_on1<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> pcr_sphere <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>t2_space set<span class="main">.</span> continuous_on <span class="bound">X</span><span class="main">)</span> continuous_on"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_transfer_right_total2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_prover</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_prover</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> transfer_continuous_on2<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="main">(</span>pcr_sphere <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span>pcr_sphere <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> continuous_on <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> continuous_on <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_transfer_right_total<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_prover</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_step</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_prover</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj1_inv_continuous<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on UNIV st_proj1_inv"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nonneg_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj1_continuous<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span>top_sphere<span class="main">}</span><span class="main">)</span> st_proj1"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nonneg_eq_0_iff split_beta' norm_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj1_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"st_proj1_inv <span class="main">(</span>st_proj1 <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> top_sphere"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> na<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">unfolding</span></span> norm_prod_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> norm <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> na<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">1</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>inverse <span class="main">¦</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">¦</span> <span class="main">*</span> norm <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>inverse <span class="main">¦</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">¦</span> <span class="main">*</span> norm <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> na<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">1</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> inverse <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>inverse <span class="main">¦</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">¦</span> <span class="main">*</span> norm <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj1_inv_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"st_proj1 <span class="main">(</span>st_proj1_inv <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> add_nonneg_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj1_inv_ne_top<span class="main">:</span> <span class="quoted"><span class="quoted">"st_proj1_inv <span class="free">xa</span> <span class="main">≠</span> top_sphere"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> add_nonneg_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_st_proj1<span class="main">:</span> <span class="quoted"><span class="quoted">"homeomorphism <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span>top_sphere<span class="main">}</span><span class="main">)</span> UNIV st_proj1 st_proj1_inv"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_def st_proj1_continuous st_proj1_inv_continuous st_proj1_inv_inv
      st_proj1_inv st_proj1_inv_ne_top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"st_proj1_inv <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> st_proj1_inv_inv st_proj1_inv_ne_top<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rangeI st_proj1_inv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj2_inv_continuous<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on UNIV st_proj2_inv"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nonneg_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj2_continuous<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span>bot_sphere<span class="main">}</span><span class="main">)</span> st_proj2"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nonneg_eq_0_iff split_beta' norm_prod_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj2_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"st_proj2_inv <span class="main">(</span>st_proj2 <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> bot_sphere"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="main">-</span><span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> na<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">unfolding</span></span> norm_prod_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> norm <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">-</span><span class="main">1</span>›</span></span> na<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">-</span><span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>inverse <span class="main">¦</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">¦</span> <span class="main">*</span> norm <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>inverse <span class="main">¦</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">¦</span> <span class="main">*</span> norm <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">-</span><span class="main">1</span>›</span></span> na<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">-</span><span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">S</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> inverse <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>inverse <span class="main">¦</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">¦</span> <span class="main">*</span> norm <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj2_inv_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"st_proj2 <span class="main">(</span>st_proj2_inv <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> add_nonneg_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> st_proj2_inv_ne_top<span class="main">:</span> <span class="quoted"><span class="quoted">"st_proj2_inv <span class="free">xa</span> <span class="main">≠</span> bot_sphere"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> add_nonneg_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_st_proj2<span class="main">:</span> <span class="quoted"><span class="quoted">"homeomorphism <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span>bot_sphere<span class="main">}</span><span class="main">)</span> UNIV st_proj2 st_proj2_inv"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_def st_proj2_continuous st_proj2_inv_continuous st_proj2_inv_inv
      st_proj2_inv st_proj2_inv_ne_top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"st_proj2_inv <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> st_proj2_inv_inv st_proj2_inv_ne_top<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rangeI st_proj2_inv<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> st_proj1_chart <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> sphere<span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span>top_sphere<span class="main">::</span><span class="tfree">'a</span> sphere<span class="main">}</span><span class="main">,</span> UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">,</span> st_proj1<span class="main">,</span> st_proj1_inv<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> homeomorphism_st_proj1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">lift_definition</span></span> st_proj2_chart <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> sphere<span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span>bot_sphere<span class="main">::</span><span class="tfree">'a</span> sphere<span class="main">}</span><span class="main">,</span> UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">,</span> st_proj2<span class="main">,</span> st_proj2_inv<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> homeomorphism_st_proj2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> st_projs_compat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∞</span><span class="keyword1">-smooth_compat</span> st_proj1_chart st_proj2_chart"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smooth_compat_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"smooth_on <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="bound">a</span><span class="main">.</span> norm <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">{</span><span class="bound">a</span><span class="main">.</span> norm <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"UNIV <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_divide smooth_on_inverse smooth_on_scaleR smooth_on_mult smooth_on_add
          smooth_on_minus smooth_on_norm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def power2_eq_square add_nonneg_eq_0_iff <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_prod_def power2_eq_square<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sos</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"smooth_on <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="bound">a</span><span class="main">.</span> norm <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">{</span><span class="bound">a</span><span class="main">.</span> norm <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span>norm <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"UNIV <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_divide smooth_on_inverse smooth_on_scaleR smooth_on_mult smooth_on_add
          smooth_on_minus smooth_on_norm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def power2_eq_square add_nonneg_eq_0_iff <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_prod_def add_eq_0_iff<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sos</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">charts_sphere</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space sphere<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> chart set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">charts_sphere</span> <span class="main">≡</span> <span class="main">{</span>st_proj1_chart<span class="main">,</span> st_proj2_chart<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_manifold_atlas_sphere<span class="main">:</span> <span class="quoted"><span class="quoted">"c_manifold charts_sphere <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> charts_sphere_def
  <span class="keyword1"><span class="command">using</span></span> smooth_compat_commute smooth_compat_refl st_projs_compat <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Projective_Space">
<div class="head">
<h1>Theory Projective_Space</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Projective Space›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Projective_Space
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Differentiable_Manifold.html">Differentiable_Manifold</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Quotient_Set.html">HOL-Library.Quotient_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some of the main things to note here: double transfer (-&gt; nonzero -&gt; quotient)›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subtype of nonzero elements›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_ne_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">{</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>t1_space<span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">c</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">c</span><span class="main">}</span> <span class="main">=</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_delete<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> open_UNIV<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'a</span><span class="main">::</span><span class="quoted">euclidean_space</span> nonzero <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_nonzero

<span class="keyword1"><span class="command">instantiation</span></span> nonzero <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">topological_space</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">open_nonzero</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nonzero set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"open<span class="main">::</span><span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_ne_zero<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_nonzero_openin_transfer<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="main">(</span>pcr_nonzero <span class="free">A</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>openin <span class="main">(</span>top_of_set <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="main">(</span>pcr_nonzero <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> open"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"is_equality <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_equality_def<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> that<span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Y</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nonzero set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="main">(</span>pcr_nonzero <span class="main">(=)</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span>top_of_set <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="main">(</span>pcr_nonzero <span class="main">(=)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> open <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_subtopology<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonzero.domain_eq open_ne_zero<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> t
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nonzero <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">scaleR</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">scaleR_nonzero</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> nonzero <span class="main">⇒</span> <span class="tfree">'a</span> nonzero"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> One <span class="keyword1">else</span> <span class="bound">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nonzero <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_nonzero</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nonzero <span class="main">⇒</span> <span class="tfree">'a</span> nonzero <span class="main">⇒</span> <span class="tfree">'a</span> nonzero"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> One <span class="keyword1">else</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nonzero <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">minus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">minus_nonzero</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nonzero <span class="main">⇒</span> <span class="tfree">'a</span> nonzero <span class="main">⇒</span> <span class="tfree">'a</span> nonzero"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> One <span class="keyword1">else</span> <span class="bound">x</span> <span class="main">-</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nonzero <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">dist</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">dist_nonzero</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nonzero <span class="main">⇒</span> <span class="tfree">'a</span> nonzero <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">dist</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nonzero <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">norm</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">norm_nonzero</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nonzero <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">norm</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> nonzero <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">t2_space</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
    <span class="keyword1"><span class="command">using</span></span> hausdorff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> U V
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">U</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">V</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> scaleR_one_nonzero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="main">_</span> nonzero<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> scaleR_scaleR_nonzero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> scaleR <span class="free">a</span> <span class="main">(</span>scaleR <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> scaleR <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="main">_</span> nonzero<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> nonzero <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">second_countable_topology</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">from</span></span> ex_countable_basis<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"countable <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"topological_basis <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> Abs_nonzero <span class="main">`</span> <span class="main">(</span><span class="bound">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="main">(</span>rel_set <span class="main">(</span>pcr_nonzero <span class="main">(=)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">`</span><span class="skolem">A</span><span class="main">)</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def rel_set_def pcr_nonzero_def OO_def cr_nonzero_def<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> Abs_nonzero_inverse Diff_iff UNIV_I singleton_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹topological_basis <span class="skolem">A</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"topological_basis <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> topological_basis_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> X
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> B'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">B'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B</span><span class="main">::</span><span class="tfree">'a</span> nonzero set set<span class="main">.</span> countable <span class="bound">B</span> <span class="main">∧</span> open <span class="main">=</span> generate_topology <span class="bound">B</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">B</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> B_def <span class="quoted"><span class="quoted">‹countable <span class="skolem">A</span>›</span></span> topological_basis_imp_subbasis<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quotient›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">proj_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space nonzero <span class="main">⇒</span> <span class="tfree">'a</span> nonzero <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">proj_rel</span> <span class="free">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_rel_parametric<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pcr_nonzero <span class="free">A</span> <span class="main">===&gt;</span> pcr_nonzero <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> proj_rel proj_rel"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> pcr_nonzero <span class="free">A</span> <span class="main">===&gt;</span> pcr_nonzero <span class="free">A</span><span class="main">)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span>"</span></span>
    <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> proj_rel.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">quotient_type</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'a</span> proj_space <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">×</span> real<span class="main">)</span> nonzero"</span></span> <span class="main">/</span>  <span class="quoted">proj_rel</span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> rep_proj Proj
    <span class="keyword2"><span class="keyword">parametric</span></span> proj_rel_parametric
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equivpI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reflp proj_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_rel.intros<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reflp_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp proj_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> symp_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> proj_rel.cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x c
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proj_rel.intros<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"inverse <span class="skolem"><span class="skolem"><span class="skolem">c</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">c</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"transp proj_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> proj_rel.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> proj_rel.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> surj_Proj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj Proj"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_topology</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space proj_space topology"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_topology</span> <span class="main">=</span> map_topology Proj euclidean"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> proj_space <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">topological_space</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">open_proj_space</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> proj_space set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">open_proj_space</span> <span class="main">=</span> openin <span class="main">(</span>map_topology Proj euclidean<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> topspace_map_Proj<span class="main">:</span> <span class="quoted"><span class="quoted">"topspace <span class="main">(</span>map_topology Proj euclidean<span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> surj_Proj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> class.Topological_Spaces.topological_space.of_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> open_proj_space_def
  <span class="keyword1"><span class="command">using</span></span> surj_Proj
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> topological_space_quotient<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_vimage_ProjI<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="free">T</span> <span class="main">⟹</span> open <span class="main">(</span>Proj <span class="main">-`</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_top.right_neutral open_openin open_proj_space_def openin_map_topology topspace_euclidean<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> open_vimage_ProjD<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>Proj <span class="main">-`</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟹</span> open <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_top.right_neutral open_openin open_proj_space_def openin_map_topology top.extremum topspace_euclidean topspace_map_Proj topspace_map_topology<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> open_vimage_Proj_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>Proj <span class="main">-`</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> open <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_vimage_ProjI open_vimage_ProjD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> euclidean_proj_space_def<span class="main">:</span> <span class="quoted"><span class="quoted">"euclidean <span class="main">=</span> map_topology Proj euclidean"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> topology_eq_iff openin_map_topology<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_proj_spaceI<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">S</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>Proj <span class="main">-`</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> Proj<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span> proj_space <span class="main">⇒</span> <span class="main">_</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> continuous_on_open_vimage open_vimage_Proj_iff that vimage_Int vimage_comp<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> saturate_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Proj <span class="main">-`</span> Proj <span class="main">`</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span>UNIV<span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="bound">c</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Proj <span class="skolem">x</span> <span class="main">=</span> Proj <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_rel <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> proj_space.abs_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> proj_rel.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"inverse <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">c</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> c x
    <span class="keyword1"><span class="command">using</span></span> proj_rel.intros<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageI proj_space.abs_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_scaling_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> open <span class="free">s</span> <span class="main">⟹</span> open <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="free">c</span> <span class="main">`</span> <span class="free">s</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space nonzero set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Hausdorff property›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Proj_open_map<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>Proj <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> saturate_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span> <span class="bound">c</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> open_Union<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> open_scaling_nonzero<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_rel_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>pcr_nonzero <span class="free">A</span> <span class="main">===&gt;</span> pcr_nonzero <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">a</span><span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">sr</span> <span class="bound">c</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> proj_rel"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> pcr_nonzero <span class="free">A</span> <span class="main">===&gt;</span> pcr_nonzero <span class="free">A</span><span class="main">)</span> <span class="free">sr</span> <span class="keyword1">(*<span class="hidden">⇩</span><sub>R</sub>)</span>"</span></span>
    <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> proj_rel.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_prover</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bool_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span> <span class="main">⟶</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_proj_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space nonzero<span class="main">,</span> <span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span> nonzero<span class="main">)</span><span class="main">.</span> proj_rel <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> closed_proj_rel_euclidean<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">∉</span> <span class="bound">A</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∉</span> <span class="bound">B</span> <span class="main">∧</span> open <span class="bound">A</span> <span class="main">∧</span> open <span class="bound">B</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="bound">A</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">∈</span> <span class="bound">B</span> <span class="main">∧</span>
      <span class="bound">A</span> <span class="main">×</span> <span class="bound">B</span> <span class="main">⊆</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="bound">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span><span class="comment1">― ‹explicitly constructing open ``cones'' that are disjoint›</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="skolem">a</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">=</span> <span class="skolem">b</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> norm_a1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">a1</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> norm_b1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">b1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a1_def b1_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> a_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> norm <span class="skolem">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">a1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> norm <span class="skolem">b</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">b1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a1_def b1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> a1_neq_b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">≠</span> <span class="skolem">b1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">≠</span> <span class="main">-</span><span class="skolem">b1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">b</span> <span class="main">/</span> norm <span class="skolem">a</span>"</span></span><span class="main">]</span> that<span class="main">(</span>2-<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a1_def b1_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> divideR_right divide_inverse inverse_eq_divide norm_eq_zero scaleR_scaleR<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.inverse_inverse b1_def b_alt_def inverse_eq_divide
            scaleR_scaleR scale_eq_0_iff scale_minus_left that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>min <span class="main">1</span> <span class="main">(</span>min <span class="main">(</span>dist <span class="skolem">a1</span> <span class="skolem">b1</span><span class="main">)</span> <span class="main">(</span>dist <span class="main">(</span><span class="main">-</span><span class="skolem">a1</span><span class="main">)</span> <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> e_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="skolem">e</span> <span class="main">≤</span> dist <span class="skolem">a1</span> <span class="skolem">b1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="skolem">e</span> <span class="main">≤</span> dist <span class="main">(</span><span class="main">-</span><span class="skolem">a1</span><span class="main">)</span> <span class="skolem">b1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> e_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that a1_neq_b1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> e_def min_def<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">=</span> ball <span class="skolem">a1</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B1</span> <span class="main">=</span> ball <span class="skolem">b1</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">∩</span> <span class="skolem">B1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> <span class="skolem">A1</span> <span class="main">∩</span> <span class="skolem">B1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e_less
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A1_def B1_def mem_ball<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> dist_commute dist_triangle<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_uminus_conv_diff diff_self dist_0_norm dist_add_cancel dist_commute dist_norm dist_triangle<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> norm_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A1</span> <span class="main">⟹</span> norm <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">B1</span> <span class="main">⟹</span> norm <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A1_def B1_def<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">scales</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">scales</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">|</span><span class="bound">c</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword1"><span class="command">have</span></span> scales_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">scales</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">scales</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span> <span class="skolem">x</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scales_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eq_vector_fraction_iff that<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> divisors_zero that<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">scales</span> <span class="skolem">A1</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">scales</span> <span class="skolem">B1</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> disjoint <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def B_def mem_ball scales_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> disjoint_iff_not_equal imageI mult_cancel_right norm_1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> norm_1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> norm_scaleR
          scaleR_left.minus scale_left_imp_eq scale_minus_right<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e_less <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def B_def A1_def B1_def mem_ball a1_def b1_def scales_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"top_of_set <span class="main">{</span><span class="bound">x</span><span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> open_scales<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">scales</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"openin <span class="var">?S</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> X1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> norm <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_subtopology<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_subtopology<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">scales</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="bound">x</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>topspace <span class="main">(</span>top_of_set <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scales_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> c x <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">∉</span> <span class="skolem">X</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> X1 norm_zero zero_neq_one<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"norm <span class="skolem"><span class="skolem">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">x</span></span> <span class="keyword1"><span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span></span> norm <span class="skolem"><span class="skolem">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span> norm <span class="skolem"><span class="skolem">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> divideR_right norm_eq_zero scale_minus_right<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="main">(</span>top_of_set <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">…</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">{</span><span class="bound">y</span><span class="main">.</span> inverse <span class="main">(</span>norm <span class="bound">y</span><span class="main">)</span> <span class="main">*</span> norm <span class="bound">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="var">?S</span> <span class="main">(</span>uminus <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_subtopology<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_negations <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"uminus <span class="main">`</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">T</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="var">?S</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹openin <span class="main">_</span> <span class="skolem">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> _ this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_map_open<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_map_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> openin_subtopology<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> openin_subtopology<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> T
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="keyword1"><span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span></span> norm <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">-`</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="main"><span class="main">∩</span></span> UNIV <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Diff_eq<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> open_continuous_vimage<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> openin_subtopology<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"openin <span class="var">?S</span> <span class="skolem">A1</span>"</span></span> <span class="quoted"><span class="quoted">"openin <span class="var">?S</span> <span class="skolem">B1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> openin_subtopology A1_def B1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> open_scales<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> open_scales<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def B_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def B_def A1_def B1_def that e_pos scales_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a_alt_def b_alt_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">c</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">∉</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def B_def scales_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">×</span> <span class="skolem">B</span> <span class="main">⊆</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_def open_prod_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta' bool_aux pred_prod.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_prod.simps<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="bound">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> closed_proj_rel_euclidean<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> A B
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">B</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_iff prod_eq_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_Proj_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> Proj <span class="bound">x</span> <span class="main">=</span> Proj <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> closed_proj_rel
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong case_prodE case_prodI2 prod.inject proj_space.abs_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> proj_space <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">t2_space</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> class.Topological_Spaces.t2_space.of_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> open_proj_space_def surj_Proj Proj_open_map closed_Proj_rel
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> t2_space_quotient<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> proj_space <span class="main">::</span> <span class="main">(</span><span class="quoted">euclidean_space</span><span class="main">)</span> <span class="quoted">second_countable_topology</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> class.Elementary_Topology.second_countable_topology.of_class.intro<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> open_proj_space_def surj_Proj Proj_open_map
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> second_countable_topology_quotient<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Charts›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Chart for last coordinate›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_last_nonzero <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">×</span> real<span class="main">)</span> nonzero <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_last_nonzero_scaleR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> chart_last_nonzero <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> chart_last_nonzero <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_last <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space proj_space <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">chart_last_nonzero</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> proj_rel.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_last_inv_nonzero <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">×</span>real<span class="main">)</span> nonzero"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_last_inv <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>euclidean_space proj_space"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">chart_last_inv_nonzero</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_last_domain_nonzeroP <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">×</span>real<span class="main">)</span> nonzero <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_last_domainP <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space proj_space <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">chart_last_domain_nonzeroP</span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_set_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> proj_rel.cases<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> open_chart_last_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>Collect chart_last_domainP<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> open_proj_space_def
  <span class="keyword1"><span class="command">unfolding</span></span> openin_map_topology 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Collect_conj_eq
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> open_Int<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_Collect_neq continuous_on_snd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Proj_vimage_chart_last_domainP<span class="main">:</span> <span class="quoted"><span class="quoted">"Proj <span class="main">-`</span> Collect chart_last_domainP <span class="main">=</span> Collect <span class="main">(</span>chart_last_domain_nonzeroP<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_last_continuous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> open_nonzero_openin_transfer
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>Collect chart_last_domainP<span class="main">)</span> chart_last"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_proj_spaceI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> o_def chart_last.abs_eq Proj_vimage_chart_last_domainP
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_chart_last_domain<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_last_inv_continuous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> open_nonzero_openin_transfer
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on UNIV chart_last_inv"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> chart_last_inv_def map_fun_def comp_id
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_compose<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> continuous_on_open_vimage continuous_on_subset inf_top.right_neutral open_UNIV open_vimage_Proj_iff top_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_rel_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_rel <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">c</span></span><span class="main">≠</span><span class="main">0</span><span class="main">.</span> <span class="free">b</span> <span class="main">=</span> <span class="bound">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> proj_rel.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> proj_rel.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chart_last_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"chart_last_inv <span class="main">(</span>chart_last <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"chart_last_domainP <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">unfolding</span></span> proj_rel_iff
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta prod_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_last_inv_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"chart_last <span class="main">(</span>chart_last_inv <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> chart_last_domainP_chart_last_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"chart_last_domainP <span class="main">(</span>chart_last_inv <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_chart_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"homeomorphism <span class="main">(</span>Collect chart_last_domainP<span class="main">)</span> UNIV chart_last chart_last_inv"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_def chart_last_inverse chart_last_inv_inverse
      chart_last_continuous chart_last_inv_continuous<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"chart_last <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chart_last_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> last_chart<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space proj_space<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> chart"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Collect chart_last_domainP<span class="main">,</span> UNIV<span class="main">,</span> chart_last<span class="main">,</span> chart_last_inv<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> homeomorphism_chart_last open_chart_last_domain <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Charts for first <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>DIM('a)›</span></span></span></span> coordinates›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_basis_nonzero <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">×</span>real<span class="main">)</span>nonzero <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="bound">c</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">∙</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_basis <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>euclidean_space proj_space <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">chart_basis_nonzero</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> proj_rel.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_basis_domain_nonzeroP <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space<span class="main">×</span>real<span class="main">)</span> nonzero <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∙</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_basis_domainP <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>euclidean_space proj_space <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">chart_basis_domain_nonzeroP</span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_set_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> proj_rel.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Proj_vimage_chart_basis_domainP<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Proj <span class="main">-`</span> Collect <span class="main">(</span>chart_basis_domainP <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Collect <span class="main">(</span>chart_basis_domain_nonzeroP <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> open_chart_basis_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>Collect <span class="main">(</span>chart_basis_domainP <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> open_proj_space_def
  <span class="keyword1"><span class="command">unfolding</span></span> openin_map_topology 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Collect_conj_eq
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> open_Int<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_Collect_neq continuous_on_fst continuous_on_inner <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_basis_continuous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> open_nonzero_openin_transfer
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>Collect <span class="main">(</span>chart_basis_domainP <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chart_basis <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_proj_spaceI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> o_def chart_basis.abs_eq Proj_vimage_chart_basis_domainP
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_chart_basis_domain<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Basis"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> b_neq0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_basis_inv_nonzero <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">×</span> real<span class="main">)</span> nonzero"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span><span class="main">,</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> b_neq0 <span class="keyword1"><span class="command">using</span></span> eq_neg_iff_add_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lift_definition</span></span> chart_basis_inv <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>euclidean_space proj_space"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">chart_basis_inv_nonzero</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_basis_inv_continuous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> open_nonzero_openin_transfer
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on UNIV chart_basis_inv"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> chart_basis_inv_def map_fun_def comp_id
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_compose<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> continuous_map_iff_continuous euclidean_proj_space_def
    <span class="keyword1"><span class="command">using</span></span> continuous_on_open_invariant open_vimage_Proj_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_basis_inv_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"chart_basis <span class="free">b</span> <span class="main">(</span>chart_basis_inv <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">using</span></span> b_neq0 b
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chart_basis_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"chart_basis_inv <span class="main">(</span>chart_basis <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"chart_basis_domainP <span class="free">b</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">unfolding</span></span> proj_rel_iff
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta prod_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">∙</span></span> <span class="free"><span class="free">b</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> b
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_basis_domainP_chart_basis_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"chart_basis_domainP <span class="free">b</span> <span class="main">(</span>chart_basis_inv <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">use</span> b <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span>›</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> homeomorphism_chart_basis<span class="main">:</span>
  <span class="quoted"><span class="quoted">"homeomorphism <span class="main">(</span>Collect <span class="main">(</span>chart_basis_domainP <span class="free">b</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">(</span>chart_basis <span class="free">b</span><span class="main">)</span> chart_basis_inv"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homeomorphism_def chart_basis_inverse chart_basis_inv_inverse
      chart_basis_continuous chart_basis_inv_continuous<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">∙</span></span> <span class="free"><span class="free">b</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="keyword1"><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="free">b</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">∙</span></span> <span class="free"><span class="free">b</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> prod_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral b_neq0 inner_commute inner_eq_zero_iff inner_right_distrib inner_zero_right<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta' <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"chart_basis <span class="free"><span class="free"><span class="free">b</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chart_basis_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> basis_chart<span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> proj_space<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> chart"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Collect <span class="main">(</span>chart_basis_domainP <span class="free">b</span><span class="main">)</span><span class="main">,</span> UNIV<span class="main">,</span> chart_basis <span class="free">b</span><span class="main">,</span> chart_basis_inv<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> homeomorphism_chart_basis <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_chart_basis_domain<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Atlas›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">charts_proj_space</span> <span class="main">=</span> insert last_chart <span class="main">(</span>basis_chart <span class="main">`</span> Basis<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chart_last_basis_defined<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chart_last_domainP <span class="free">xa</span> <span class="main">⟹</span> chart_basis_domainP <span class="free">b</span> <span class="free">xa</span> <span class="main">⟹</span> chart_last <span class="free">xa</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chart_basis_last_defined<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Basis <span class="main">⟹</span> chart_last_domainP <span class="free">xa</span> <span class="main">⟹</span> chart_basis_domainP <span class="free">b</span> <span class="free">xa</span> <span class="main">⟹</span> chart_basis <span class="free">b</span> <span class="free">xa</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_eq_iff <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compat_last_chart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∞</span><span class="keyword1">-smooth_compat</span> last_chart <span class="main">(</span>basis_chart <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Basis"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smooth_compat_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smooth_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">(</span>chart_basis <span class="free">b</span> <span class="main">∘</span> chart_last_inv<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_inverse smooth_on_scaleR smooth_on_inner smooth_on_add
        smooth_on_minus open_Collect_neq <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smooth_on <span class="main">(</span>chart_last <span class="main">`</span> <span class="main">(</span>Collect chart_last_domainP <span class="main">∩</span> Collect <span class="main">(</span>chart_basis_domainP <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chart_basis <span class="free">b</span> <span class="main">∘</span> chart_last_inv<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chart_last_basis_defined<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smooth_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>  <span class="main">(</span>chart_last <span class="main">∘</span> chart_basis_inv <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_add smooth_on_scaleR smooth_on_minus smooth_on_inverse 
        smooth_on_inner open_Collect_neq <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smooth_on <span class="main">(</span>chart_basis <span class="free">b</span> <span class="main">`</span> <span class="main">(</span>Collect chart_last_domainP <span class="main">∩</span> Collect <span class="main">(</span>chart_basis_domainP <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chart_last <span class="main">∘</span> chart_basis_inv <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chart_basis_last_defined that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smooth_on_basis_comp_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"smooth_on <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">(</span>chart_basis <span class="free">b</span> <span class="main">∘</span> chart_basis_inv <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Basis"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Basis"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smooth_on_add smooth_on_scaleR smooth_on_minus smooth_on_inner smooth_on_inverse
    smooth_on_mult open_Collect_neq <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> inner_Basis<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chart_basis_basis_defined<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">⟹</span> chart_basis_domainP <span class="free">a</span> <span class="free">xa</span> <span class="main">⟹</span> chart_basis_domainP <span class="free">b</span> <span class="free">xa</span> <span class="main">⟹</span> chart_basis <span class="free">a</span> <span class="free">xa</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Basis"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Basis"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> inner_Basis prod_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compat_basis_chart<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∞</span><span class="keyword1">-smooth_compat</span> <span class="main">(</span>basis_chart <span class="free">a</span><span class="main">)</span> <span class="main">(</span>basis_chart <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Basis"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Basis"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smooth_compat_refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> smooth_compat_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> smooth_on_basis_comp_inv<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> inner_Basis chart_basis_basis_defined that<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> smooth_on_basis_comp_inv<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smooth_on_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> inner_Basis chart_basis_basis_defined that<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_manifold_proj_space<span class="main">:</span> <span class="quoted"><span class="quoted">"c_manifold charts_proj_space <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> charts_proj_space_def smooth_compat_refl smooth_compat_commute compat_last_chart
      compat_basis_chart<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>