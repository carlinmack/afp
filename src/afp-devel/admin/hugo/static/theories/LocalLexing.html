<div id="CFG">
<div class="head">
<h1>Theory CFG</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CFG
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> symbol

<span class="keyword1"><span class="command">type_synonym</span></span> rule <span class="main">=</span> <span class="quoted"><span class="quoted">"symbol <span class="main">×</span> symbol list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> sentence <span class="main">=</span> <span class="quoted"><span class="quoted">"symbol list"</span></span>

<span class="keyword1"><span class="command">locale</span></span> CFG <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝔑</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝔗</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ℜ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝔖</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disjunct_symbols<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔑</span> <span class="main">∩</span> <span class="free">𝔗</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> startsymbol_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔖</span> <span class="main">∈</span> <span class="free">𝔑</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> validRules<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span><span class="main">.</span> <span class="bound">N</span> <span class="main">∈</span> <span class="free">𝔑</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="bound">α</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">𝔑</span> <span class="main">∪</span> <span class="free">𝔗</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_terminal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_terminal</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">𝔗</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_nonterminal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_nonterminal</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">𝔑</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_nonterminal_startsymbol<span class="main">:</span><span class="quoted"><span class="quoted">"is_nonterminal <span class="free">𝔖</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_nonterminal_def startsymbol_dom<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_symbol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_symbol</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>is_terminal <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> is_nonterminal <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_sentence</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_sentence</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> list_all is_symbol <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_word</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_word</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> list_all is_terminal <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
   
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">derives1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derives1</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">N</span> <span class="bound">α</span><span class="main">.</span> 
          <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="bound">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">y</span>
        <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">α</span> <span class="main">@</span> <span class="bound">y</span>
        <span class="main">∧</span> is_sentence <span class="bound">x</span>
        <span class="main">∧</span> is_sentence <span class="bound">y</span>
        <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">derivations1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sentence <span class="main">×</span> sentence<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derivations1</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> derives1 <span class="bound">u</span> <span class="bound">v</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">derivations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sentence <span class="main">×</span> sentence<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">derivations</span> <span class="main">=</span> derivations1<span class="main">^*</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">derives</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derives</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">∈</span> derivations<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_derivation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_derivation</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> derives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ℒ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℒ</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">v</span><span class="main">.</span> is_word <span class="bound">v</span> <span class="main">∧</span> is_derivation <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">ℒ<span class="hidden">⇩</span><sub>P</sub></span>"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℒ<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">u</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> is_word <span class="bound">u</span> <span class="main">∧</span> is_derivation <span class="main">(</span><span class="bound">u</span><span class="main">@</span><span class="bound">v</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="LocalLexing">
<div class="head">
<h1>Theory LocalLexing</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> LocalLexing
<span class="keyword2"><span class="keyword">imports</span></span> <a href="CFG.html">CFG</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> character

<span class="keyword1"><span class="command">type_synonym</span></span> lexer <span class="main">=</span> <span class="quoted"><span class="quoted">"character list <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span>  

<span class="keyword1"><span class="command">type_synonym</span></span> token <span class="main">=</span> <span class="quoted"><span class="quoted">"symbol <span class="main">×</span> character list"</span></span> 

<span class="keyword1"><span class="command">type_synonym</span></span> tokens <span class="main">=</span> <span class="quoted"><span class="quoted">"token list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">terminal_of_token</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token <span class="main">⇒</span> symbol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">terminal_of_token</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">terminals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens <span class="main">⇒</span> sentence"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">terminals</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> map terminal_of_token <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">chars_of_token</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token <span class="main">⇒</span> character list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chars_of_token</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">chars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens <span class="main">⇒</span> character list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chars</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">chars</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>chars_of_token <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">chars</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">charslength</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">charslength</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> length <span class="main">(</span>chars <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_lexer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"lexer <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_lexer</span> <span class="free"><span class="bound"><span class="entity">lexer</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">D</span> <span class="bound">p</span> <span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">≤</span> length <span class="bound">D</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">lexer</span></span></span> <span class="bound">D</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">+</span> <span class="bound">l</span> <span class="main">≤</span> length <span class="bound">D</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="bound">p</span> <span class="main">&gt;</span> length <span class="bound">D</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">lexer</span></span></span> <span class="bound">D</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> selector <span class="main">=</span> <span class="quoted"><span class="quoted">"token set <span class="main">⇒</span> token set <span class="main">⇒</span> token set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_selector</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"selector <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_selector</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="bound">B</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">A</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⊆</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">by_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> tokens set <span class="main">⇒</span> tokens set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">by_length</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">tss</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">ts</span> <span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">tss</span></span></span> <span class="main">∧</span> length <span class="main">(</span>chars <span class="bound">ts</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">funpower</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">funpower</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">funpower</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">funpower</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">natUnion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">natUnion</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span> <span class="main">|</span> <span class="bound">n</span><span class="main">.</span> True <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">limit</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">limit</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> LocalLexing <span class="main">=</span> CFG <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Lex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol <span class="main">⇒</span> lexer"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Sel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"selector"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Lex_is_lexer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">𝔗</span><span class="main">.</span> is_lexer <span class="main">(</span><span class="free">Lex</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Sel_is_selector<span class="main">:</span> <span class="quoted"><span class="quoted">"is_selector <span class="free">Sel</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Doc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"character list"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">admissible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">admissible</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span>terminals <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Append</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token set <span class="main">⇒</span> nat <span class="main">⇒</span> tokens set <span class="main">⇒</span> tokens set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Append</span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> 
    <span class="main">{</span> <span class="bound">p</span> <span class="main">@</span> <span class="main">[</span><span class="bound">t</span><span class="main">]</span> <span class="main">|</span> <span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> by_length <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span> <span class="main">∧</span> admissible <span class="main">(</span><span class="bound">p</span> <span class="main">@</span> <span class="main">[</span><span class="bound">t</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">𝒳</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> token set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒳</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">ω</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="bound">l</span> <span class="bound">ω</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">𝔗</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free">Lex</span> <span class="bound">t</span> <span class="free">Doc</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="bound">ω</span> <span class="main">=</span> take <span class="bound">l</span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free">Doc</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">𝒲</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens set <span class="main">⇒</span> nat <span class="main">⇒</span> token set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒲</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span>  <span class="main">{</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> 𝒳 <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> by_length <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> admissible <span class="main">(</span><span class="bound">p</span><span class="main">@</span><span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">𝒴</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token set <span class="main">⇒</span> tokens set <span class="main">⇒</span> nat <span class="main">⇒</span> token set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒴</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">Sel</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>𝒲 <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">𝒫</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> tokens set"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">𝒬</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> tokens set"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">𝒵</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> token set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒫</span> <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒫</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> limit <span class="main">(</span>Append <span class="main">(</span><span class="free">𝒵</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">𝒫</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒫</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">𝒬</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒵</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒵</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> 𝒴 <span class="main">(</span><span class="free">𝒵</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">𝒫</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒬</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> natUnion <span class="main">(</span><span class="free">𝒫</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">𝔓</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔓</span> <span class="main">=</span> 𝒬 <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ll</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ll</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> 𝔓 <span class="main">∧</span> charslength <span class="bound">p</span> <span class="main">=</span> length <span class="free">Doc</span> <span class="main">∧</span> terminals <span class="bound">p</span> <span class="main">∈</span> ℒ <span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LLEarleyParsing">
<div class="head">
<h1>Theory LLEarleyParsing</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> LLEarleyParsing 
<span class="keyword2"><span class="keyword">imports</span></span> <a href="LocalLexing.html">LocalLexing</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> item <span class="main">=</span> 
  Item 
    <span class="main">(</span><span class="free"><span class="entity">item_rule</span></span><span class="main">:</span> <span class="quoted">rule</span><span class="main">)</span> 
    <span class="main">(</span><span class="free"><span class="entity">item_dot</span></span> <span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> 
    <span class="main">(</span><span class="free"><span class="entity">item_origin</span></span> <span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">item_end</span></span> <span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> items <span class="main">=</span> <span class="quoted"><span class="quoted">"item set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">item_nonterminal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> symbol"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">item_nonterminal</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="main">(</span>item_rule <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">item_rhs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> sentence"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">item_rhs</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> snd <span class="main">(</span>item_rule <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">item_α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> sentence"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">item_α</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> take <span class="main">(</span>item_dot <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>item_rhs <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">item_β</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> sentence"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">item_β</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> drop <span class="main">(</span>item_dot <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>item_rhs <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_item</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule <span class="main">⇒</span> nat <span class="main">⇒</span> item"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_item</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> Item <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_complete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_complete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>item_dot <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≥</span> length <span class="main">(</span>item_rhs <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_symbol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> symbol option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_symbol</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_complete <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span><span class="main">(</span>item_rhs <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>item_dot <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inc_item</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> nat <span class="main">⇒</span> item"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inc_item</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> Item <span class="main">(</span>item_rule <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>item_dot <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>item_origin <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"items <span class="main">⇒</span> nat <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bin</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> item_end <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Init</span> <span class="main">=</span> <span class="main">{</span> init_item <span class="bound">r</span> <span class="main">0</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> fst <span class="bound">r</span> <span class="main">=</span> <span class="free">𝔖</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Predict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> items <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Predict</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∪</span>  
     <span class="main">{</span> init_item <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">|</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> bin <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> 
       next_symbol <span class="bound">x</span> <span class="main">=</span> Some<span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Complete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> items <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Complete</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∪</span> <span class="main">{</span> inc_item <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> 
     <span class="bound">x</span> <span class="main">∈</span> bin <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>item_origin <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> bin <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> is_complete <span class="bound">y</span> <span class="main">∧</span> 
     next_symbol <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span>item_nonterminal <span class="bound">y</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TokensAt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> items <span class="main">⇒</span> token set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">TokensAt</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> bin <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> 
     next_symbol <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> is_terminal <span class="bound">t</span> <span class="main">∧</span> 
     <span class="bound">l</span> <span class="main">∈</span> <span class="free">Lex</span> <span class="bound">t</span> <span class="free">Doc</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">=</span> take <span class="bound">l</span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free">Doc</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tokens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> token set <span class="main">⇒</span> items <span class="main">⇒</span> token set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Tokens</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free">Sel</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>TokensAt <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Scan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token set <span class="main">⇒</span> nat <span class="main">⇒</span> items <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Scan</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∪</span>
     <span class="main">{</span> inc_item <span class="bound">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> length <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">t</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> bin <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span>
       next_symbol <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">}</span>"</span></span>
      
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">π</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> token set <span class="main">⇒</span> items <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> 
     limit <span class="main">(</span><span class="main">λ</span> <span class="bound">I</span><span class="main">.</span> Scan <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Complete <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Predict <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">𝒥</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">ℐ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">𝒯</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> token set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒥</span> <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> π <span class="main">0</span> <span class="main">{}</span> Init"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒥</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> π <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free">𝒯</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒥</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒥</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> π <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">{}</span> <span class="main">(</span><span class="free">ℐ</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒯</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒯</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Tokens <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free">𝒯</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">𝒥</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> natUnion <span class="main">(</span><span class="free">𝒥</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ℑ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℑ</span> <span class="main">=</span> ℐ <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_finished</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_finished</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>item_nonterminal <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free">𝔖</span> <span class="main">∧</span> item_origin <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> item_end <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> length <span class="free">Doc</span> <span class="main">∧</span> 
    is_complete <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">earley_recognised</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">earley_recognised</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> ℑ<span class="main">.</span> is_finished <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 
</pre>
</div><div id="Limit">
<div class="head">
<h1>Theory Limit</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Limit
<span class="keyword2"><span class="keyword">imports</span></span> <a href="LocalLexing.html">LocalLexing</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">setmonotone</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">setmonotone</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">X</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> setmonotone_funpower<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span> <span class="main">⟹</span> setmonotone <span class="main">(</span>funpower <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setmonotone_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_setmonotone<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">f</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setmonotone_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> elem_setmonotone<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setmonotone_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> elem_natUnion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> natUnion <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_natUnion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⊆</span> natUnion <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> setmonotone_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fmono<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"setmonotone <span class="main">(</span>limit <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"setmonotone <span class="main">(</span>limit <span class="free">f</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setmonotone_def limit_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> elem_natUnion<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> elem_setmonotone<span class="main"><span class="main">[</span></span><span class="operator">OF</span> setmonotone_funpower<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"funpower id <span class="free">n</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"limit id <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def natUnion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> natUnion_decompose<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Decompose<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> natUnion <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> decompose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> decompose<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> limit_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Init Iterate<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">∈</span> limit <span class="free">f</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iterate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">q</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> p_in_natUnion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="free">X</span><span class="main">)</span>"</span></span>    
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="skolem">n</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">P</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> 
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> init<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> iterate<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> p_in_natUnion <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> natUnion_decompose<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chain</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">continuous</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">continuous</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">C</span><span class="main">.</span> chain <span class="bound">C</span> <span class="main">⟶</span> <span class="main">(</span>chain <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">o</span> <span class="bound">C</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>natUnion <span class="bound">C</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">o</span> <span class="bound">C</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous <span class="free">f</span> <span class="main">⟹</span> chain <span class="free">C</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>natUnion <span class="free">C</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_imp_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> continuous<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">A</span> <span class="keyword1">else</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chain_def sub<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fC<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="var">?C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> continuous continuous_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?C</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">(</span><span class="var">?C</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="main">¬</span> chain <span class="bound">f</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">n</span><span class="main">::</span><span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⊆</span> <span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 chain_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fC <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">A</span> <span class="main">⊆</span> <span class="free">f</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 
      
<span class="keyword1"><span class="command">lemma</span></span> mono_maps_chain_to_chain<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> C comp_def f chain_def mono_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> natUnion_upperbound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">⊆</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>natUnion <span class="free">f</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> funpower_upperbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> funpower <span class="free">f</span> <span class="free">n</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> limit_upperbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> limit <span class="free">f</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpower_upperbound limit_def natUnion_upperbound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> elem_limit_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> limit <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def natUnion_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pointwise</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pointwise</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">X</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">X</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> pointwise_simp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">X</span> <span class="main">=</span>  <span class="main">⋃</span> <span class="main">{</span> <span class="free">f</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span> <span class="free">f</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pointwise_def<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> natUnion_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> natUnion <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> natUnion_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
<span class="keyword1"><span class="command">lemma</span></span> limit_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="free">n</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> limit <span class="free">f</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def natUnion_elem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> limit_step_pointwise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> limit <span class="free">f</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> limit <span class="free">f</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="free">X</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elem_limit_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="skolem">n</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pointwise_simp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> y n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> limit <span class="free">f</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> limit_elem<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pointbase</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pointbase</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">X</span> <span class="main">|</span> <span class="bound">X</span><span class="main">.</span> finite <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pointbased</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pointbased</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">F</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> pointbase <span class="bound">F</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pointwise_implies_pointbased<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pointwise<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pointbased <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">X</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> pointbase <span class="var">?F</span> <span class="skolem">I</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> pointbase <span class="var">?F</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="skolem">I</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span><span class="free">f</span> <span class="bound">A</span> <span class="main">|</span><span class="bound">A</span><span class="main">.</span> finite <span class="bound">A</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="skolem">I</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pointbase_def x<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_simp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pointwise<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">I</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_simp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pointwise<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> rl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">I</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> pointbase <span class="var">?F</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_simp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pointwise<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">I</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">∧</span> finite <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> pointbase <span class="free">f</span> <span class="skolem">I</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointbase_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> lr rl
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">I</span><span class="main">.</span> pointbase <span class="free">f</span> <span class="bound">I</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pointbase <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pointbased_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>  
   
<span class="keyword1"><span class="command">lemma</span></span> pointbase_is_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mono <span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">⊆</span> <span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="skolem">B</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointbase_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chain_implies_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">C</span> <span class="main">⟹</span> mono <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chain_def mono_iff_le_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chain_cover_witness<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> chain <span class="free">C</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⊆</span> natUnion <span class="free">C</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">C</span> <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> emptyI <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insertI <span class="skolem">X</span> <span class="skolem">x</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> natUnion <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> insertI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="free">C</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">C</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> natUnion <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insertI.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="bound">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span><span class="bound">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="free">C</span> <span class="bound">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x natUnion_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> mono_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">C</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free">C</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chain_implies_mono insertI<span class="main">(</span>3<span class="main">)</span> mono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"max <span class="skolem">n</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> contra_subsetD m max.cobounded2 mono_C<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max_def mono_C n subsetCE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> pointbase_is_continuous<span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous <span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C mono_maps_chain_to_chain pointbase_is_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> subset1<span class="main">:</span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="main">(</span>natUnion <span class="skolem">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> natUnion <span class="main">(</span><span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="main">(</span>natUnion <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> natUnion_decompose<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Decompose <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply contra_subsetD mono_def natUnion_elem 
            pointbase_is_mono subsetI<span class="main">)</span> 
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> subset2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="main">(</span>natUnion <span class="skolem">C</span><span class="main">)</span> <span class="main">⊆</span> natUnion <span class="main">(</span><span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="main">(</span>natUnion <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">X</span><span class="main">.</span> finite <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆</span> natUnion <span class="skolem">C</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span><span class="free">f</span> <span class="bound">A</span> <span class="main">|</span><span class="bound">A</span><span class="main">.</span> finite <span class="bound">A</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">⊆</span> natUnion <span class="skolem">C</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> y pointbase_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span> <span class="main">∧</span> <span class="skolem">X</span> <span class="main">⊆</span> natUnion <span class="skolem">C</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">C</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_cover_witness C <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> X_sub_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">C</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> natUnion <span class="main">(</span><span class="main">(</span>pointbase <span class="free">f</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> natUnion_elem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span><span class="free">f</span> <span class="bound">A</span> <span class="main">|</span><span class="bound">A</span><span class="main">.</span> finite <span class="bound">A</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="skolem">C</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> X X_sub_C <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>pointbase <span class="free">f</span> <span class="main">∘</span> <span class="skolem">C</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointbase_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> mono subset1 subset2
  <span class="keyword1"><span class="command">}</span></span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_def subset_antisym<span class="main">)</span>   
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> pointbased_implies_continuous<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pointbased <span class="free">f</span> <span class="main">⟹</span> continuous <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pointbase_is_continuous pointbased_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> setmonotone_implies_chain_funpower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> setmonotone<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chain_def setmonotone subset_setmonotone<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> natUnion_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">⊆</span> <span class="free">g</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span> natUnion <span class="free">f</span> <span class="main">⊆</span> natUnion <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> natUnion_elem natUnion_upperbound subset_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> natUnion_eq<span class="main">[</span><span class="operator">case_names</span> Subset Superset<span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">⊆</span> <span class="free">g</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">⊆</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span> natUnion <span class="free">f</span> <span class="main">=</span> natUnion <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_subset subset_antisym<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> natUnion_shift<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"natUnion <span class="free">C</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> natUnion_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Subset <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> chain chain_implies_mono le_add1 mono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Superset <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">regular</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">regular</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span>setmonotone <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> continuous <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> regular_fixpoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> regular<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>limit <span class="free">f</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> limit <span class="free">f</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> setmonotone<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> regular regular_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> continuous<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> regular regular_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setmonotone setmonotone_implies_chain_funpower<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>limit <span class="free">f</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>natUnion <span class="var">?C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> limit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>natUnion <span class="var">?C</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="var">?C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> continuous continuous_def chain<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="var">?C</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span>funpower <span class="free">f</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> comp_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span>funpower <span class="free">f</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?C</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?C</span><span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> natUnion_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> chain <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  
    
<span class="keyword1"><span class="command">lemma</span></span> fix_is_fix_of_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fixpoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>   
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">f</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> funpower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">from</span></span> fixpoint <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"funpower <span class="free">f</span> <span class="skolem">n</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def funpower natUnion_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>     

<span class="keyword1"><span class="command">lemma</span></span> limit_is_idempotent<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">f</span> <span class="main">⟹</span> limit <span class="free">f</span> <span class="main">(</span>limit <span class="free">f</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> limit <span class="free">f</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fix_is_fix_of_limit regular_fixpoint<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_regular1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_regular1</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∪</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">q</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">q</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">q</span> <span class="bound">x</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_regular2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_regular2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∪</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> setmonotone_mk_regular1<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="main">(</span>mk_regular1 <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_regular1_def setmonotone_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> setmonotone_mk_regular2<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="main">(</span>mk_regular2 <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_regular2_def setmonotone_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pointbased_mk_regular1<span class="main">:</span> <span class="quoted"><span class="quoted">"pointbased <span class="main">(</span>mk_regular1 <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span> <span class="free">F</span> <span class="bound">q</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">q</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">q</span> <span class="bound">x</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"pointbase <span class="var">?f</span> <span class="skolem">I</span> <span class="main">⊆</span> mk_regular1 <span class="free">P</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointbase_def mk_regular1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"mk_regular1 <span class="free">P</span> <span class="free">F</span> <span class="skolem">I</span> <span class="main">⊆</span> pointbase <span class="var">?f</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointbase_def mk_regular1_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pointbase <span class="var">?f</span> <span class="skolem">I</span> <span class="main">=</span> mk_regular1 <span class="free">P</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pointbased_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pointbased_mk_regular2<span class="main">:</span> <span class="quoted"><span class="quoted">"pointbased <span class="main">(</span>mk_regular2 <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span> <span class="free">F</span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"pointbase <span class="var">?f</span> <span class="skolem">I</span> <span class="main">⊆</span> mk_regular2 <span class="free">P</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointbase_def mk_regular2_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"mk_regular2 <span class="free">P</span> <span class="free">F</span> <span class="skolem">I</span> <span class="main">⊆</span> pointbase <span class="var">?f</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointbase_def mk_regular2_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">x</span> <span class="skolem">y</span>
        <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">q</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">F</span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="var">?X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="free">F</span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∧</span> 
          finite <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">∧</span> <span class="free">F</span> <span class="skolem">q</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="bound">A</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x y<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> x y P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>  
    <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pointbase <span class="var">?f</span> <span class="skolem">I</span> <span class="main">=</span> mk_regular2 <span class="free">P</span> <span class="free">F</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pointbased_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> regular1<span class="main">:</span><span class="quoted"><span class="quoted">"regular <span class="main">(</span>mk_regular1 <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointbased_implies_continuous pointbased_mk_regular1 regular_def 
  setmonotone_mk_regular1<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> regular2<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>mk_regular2 <span class="free">P</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointbased_implies_continuous pointbased_mk_regular2 regular_def 
  setmonotone_mk_regular2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_comp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> comp_assoc comp_def continuous_def f g<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> setmonotone_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"setmonotone <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> comp_def f g rev_subsetD setmonotone_def subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> regular_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> continuous_comp f g regular_def setmonotone_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> setmonotone_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_def setmonotone_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> regular_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"regular id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> regular_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> regular_funpower<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">f</span> <span class="main">⟹</span> regular <span class="main">(</span>funpower <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> funpower<span class="main">:</span> <span class="quoted"><span class="quoted">"funpower <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="main">(</span>funpower <span class="free">f</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> funpower regular_comp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def id_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_funpower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>funpower <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.hyps mono monoD monoI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> mono_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>limit <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def limit_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> natUnion <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elem_limit_simp limit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="skolem">n</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>funpower <span class="free">f</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono mono_funpower<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="skolem">n</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> contra_subsetD monoD n subset<span class="main">)</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> natUnion <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_elem<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_funpower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> continuous<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span>funpower <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>funpower <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous continuous_imp_mono mono_funpower<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">C</span><span class="main">.</span> chain <span class="bound">C</span> <span class="main">⟶</span> chain <span class="main">(</span><span class="main">(</span>funpower <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpower.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono mono_maps_chain_to_chain<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> limit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">C</span><span class="main">.</span> chain <span class="bound">C</span> <span class="main">⟹</span> <span class="main">(</span>funpower <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>natUnion <span class="bound">C</span><span class="main">)</span> <span class="main">=</span> 
      natUnion <span class="main">(</span><span class="main">(</span>funpower <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> continuous_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> continuous_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> continuous<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.hyps continuous_imp_mono mono_maps_chain_to_chain<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"natUnion"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> chain limit <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> continuous_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1"><span class="command">lemma</span></span> natUnion_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> natUnion_elem natUnion_upperbound subsetI subset_antisym<span class="main">)</span>
      
<span class="keyword1"><span class="command">lemma</span></span> continuous_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> continuous<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span>limit <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>limit <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous continuous_imp_mono mono_limit<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">C</span><span class="main">.</span> chain <span class="bound">C</span> <span class="main">⟹</span> chain <span class="main">(</span><span class="main">(</span>limit <span class="free">f</span><span class="main">)</span> <span class="keyword1">o</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono mono_maps_chain_to_chain<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">C</span><span class="main">.</span> chain <span class="bound">C</span> <span class="main">⟹</span> <span class="main">(</span>limit <span class="free">f</span><span class="main">)</span> <span class="main">(</span>natUnion <span class="bound">C</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">(</span>limit <span class="free">f</span><span class="main">)</span> <span class="keyword1">o</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> chain_C<span class="main">:</span> <span class="quoted"><span class="quoted">"chain <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> contpower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> continuous <span class="main">(</span>funpower <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous continuous_funpower<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">F</span><span class="main">.</span> <span class="bound">F</span> <span class="keyword1">o</span> <span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">F</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>limit <span class="free">f</span><span class="main">)</span> <span class="main">(</span>natUnion <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="main">(</span>natUnion <span class="skolem">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="main">(</span>natUnion <span class="skolem">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> natUnion <span class="main">(</span><span class="main">(</span>funpower <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> continuous_apply<span class="main"><span class="main">[</span></span><span class="operator">OF</span> contpower<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chain_C<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> natUnion <span class="main">(</span><span class="main">(</span>funpower <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> comp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> natUnion_swap<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> limit <span class="free">f</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> limit <span class="free">f</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">(</span>limit <span class="free">f</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> comp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>limit <span class="free">f</span><span class="main">)</span> <span class="main">(</span>natUnion <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">(</span>limit <span class="free">f</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> chain <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>   
      
<span class="keyword1"><span class="command">lemma</span></span> regular_limit<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">f</span> <span class="main">⟹</span> regular <span class="main">(</span>limit <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_limit regular_def setmonotone_limit<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> regular_implies_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_imp_mono regular_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> regular_implies_setmonotone<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">f</span> <span class="main">⟹</span> setmonotone <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> regular_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> regular_implies_continuous<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="free">f</span> <span class="main">⟹</span> continuous <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> regular_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LocalLexingLemmas">
<div class="head">
<h1>Theory LocalLexingLemmas</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> LocalLexingLemmas
<span class="keyword2"><span class="keyword">imports</span></span> <a href="LocalLexing.html">LocalLexing</a> <a href="Limit.html">Limit</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="main">(</span>Append <span class="free">Z</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Append_def setmonotone_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_𝒫Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> 𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_setmonotone<span class="main"><span class="main">[</span></span><span class="operator">OF</span> setmonotone_limit<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_fSuc_strict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span><span class="main">.</span> <span class="free">f</span> <span class="bound">u</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">u</span> <span class="main">⊆</span> <span class="free">f</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">u</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">&lt;</span> <span class="skolem">v</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">u</span> <span class="main">⊆</span> <span class="free">f</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> Suc <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">u</span> <span class="main">⊆</span> <span class="free">f</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">u</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_fSuc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span><span class="main">.</span> <span class="free">f</span> <span class="bound">u</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">u</span> <span class="main">⊆</span> <span class="free">f</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> <span class="free">v</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_fSuc_strict<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_𝒫k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> 𝒫 <span class="free">k</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_fSuc<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subset_𝒫Suc<span class="main">)</span> 
  
<span class="keyword1"><span class="command">lemma</span></span> subset_𝒫𝒬k<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> 𝒬 <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_𝒬𝒫Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒬 <span class="free">k</span> <span class="main">⊆</span> 𝒫 <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">u</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒬 <span class="free">k</span> <span class="main">⊆</span> 𝒫 <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a subset_𝒫k<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_𝒬Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒬 <span class="free">k</span> <span class="main">⊆</span> 𝒬 <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_𝒬𝒫Suc subset_𝒫𝒬k<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_𝒬<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> 𝒬 <span class="free">i</span> <span class="main">⊆</span> 𝒬 <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_fSuc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">𝒬</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> subset_𝒬Suc<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_𝒳<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> length <span class="free">Doc</span> <span class="main">⟹</span> 𝒳 <span class="free">k</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒳_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> Lex_is_lexer<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_lexer_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sel_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Sel</span> <span class="main">{}</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> Sel_is_selector<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_selector_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_𝒵<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> length <span class="free">Doc</span> <span class="main">⟹</span> 𝒵 <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒴_def 𝒲_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Append <span class="main">{}</span> <span class="free">k</span> <span class="main">=</span> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Append_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> length <span class="free">Doc</span> <span class="main">⟹</span> 𝒫 <span class="free">k</span> <span class="free">v</span> <span class="main">=</span> 𝒫 <span class="free">k</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒴_def 𝒲_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒬SucEq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> length <span class="free">Doc</span> <span class="main">⟹</span> 𝒬 <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> 𝒬 <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_def<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> 𝒬_converges<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒬 <span class="free">k</span> <span class="main">=</span> 𝔓"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒬 <span class="main">(</span>length <span class="free">Doc</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> 𝔓"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝒬 <span class="main">(</span>length <span class="free">Doc</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> 𝔓"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝔓_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒬 <span class="main">(</span>length <span class="free">Doc</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> 𝔓"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒬 <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">Doc</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 𝔓"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 𝒬SucEq hyp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝒬 <span class="main">(</span>length <span class="free">Doc</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> 𝔓"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> helper <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">k</span> <span class="main">=</span> length <span class="free">Doc</span> <span class="main">+</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">n</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> length <span class="free">Doc</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> n<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> helper<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔓_covers_𝒬<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒬 <span class="free">k</span> <span class="main">⊆</span> 𝔓"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> length <span class="free">Doc</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 𝒬<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒬 <span class="free">k</span> <span class="main">=</span> 𝔓"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 𝒬_converges<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝒬 <span class="free">k</span> <span class="main">⊆</span> 𝔓"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 𝒬<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="free">Doc</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">Doc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 𝔓_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_𝒬<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Sel_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">Sel</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sel_is_selector is_selector_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sel_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">Sel</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sel_is_selector is_selector_def<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> 𝔓_covers_𝒫<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> 𝔓"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_𝒫𝒬k 𝔓_covers_𝒬<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒲_montone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span> 𝒲 <span class="free">P</span> <span class="free">k</span> <span class="main">⊆</span> 𝒲 <span class="free">Q</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒲_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Sel_precondition<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"𝒵 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> 𝒲 <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒴 <span class="main">(</span>𝒵 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="free">k</span> <span class="main">⊆</span> 𝒲 <span class="main">(</span>𝒫 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒴_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Sel_upper_bound<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒲 <span class="main">(</span>𝒫 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="free">k</span> <span class="main">⊆</span> 𝒲 <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒲_montone subset_𝒫Suc<span class="main">)</span>    
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> subset_trans<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"𝒲 <span class="main"><span class="main">(</span></span>𝒫 <span class="free"><span class="free">k</span></span> <span class="skolem"><span class="skolem">u</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">k</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> 𝒲_bounded_by_𝒳<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒲 <span class="free">P</span> <span class="free">k</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒲_def mem_Collect_eq subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒵_subset_𝒳<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒵 <span class="free">k</span> <span class="free">n</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sel_precondition 𝒲_bounded_by_𝒳 rev_subsetD subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒵_subset_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒵 <span class="free">k</span> <span class="free">n</span> <span class="main">⊆</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sel_lower_bound Sel_precondition 𝒴_def 𝒵.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒴_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒴 <span class="main">(</span>𝒵 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="free">k</span> <span class="main">⊆</span> 𝒲  <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒴_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sel_precondition Sel_upper_bound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔓_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Base Induct<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span> <span class="bound">k</span> <span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> 𝒫 <span class="bound">k</span> <span class="bound">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∈</span> 𝒫 <span class="bound">k</span> <span class="main">(</span>Suc <span class="bound">u</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="main">0</span> <span class="skolem">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> base <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> natUnion_decompose<span class="main">)</span> 
            <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> all <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝔓_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> natUnion_decompose<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> all <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> 
    
<span class="keyword1"><span class="command">lemma</span></span> Append_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span> Append <span class="free">U</span> <span class="free">k</span> <span class="free">P</span> <span class="main">⊆</span> Append <span class="free">V</span> <span class="free">k</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Append_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pointwise_Append<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise <span class="main">(</span>Append <span class="free">T</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_def Append_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> regular_Append<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>Append <span class="free">T</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pointwise <span class="main">(</span>Append <span class="free">T</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pointwise_Append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pointbased <span class="main">(</span>Append <span class="free">T</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pointwise_implies_pointbased <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span>Append <span class="free">T</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pointbased_implies_continuous <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"setmonotone <span class="main">(</span>Append <span class="free">T</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setmonotone_def Append_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> regular_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="InductRules">
<div class="head">
<h1>Theory InductRules</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> InductRules
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disjCases2<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> 1 2<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∨</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> AP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> BP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> AB AP BP <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disjCases3<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> 1 2 3<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∨</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> AP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> BP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> CP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> AB AP BP CP <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disjCases4<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> 1 2 3 4<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">∨</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> AP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> BP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> CP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> DP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> AB AP BP CP DP <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disjCases5<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> 1 2 3 4 5<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">∨</span> <span class="free">D</span> <span class="main">∨</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> AP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> BP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> CP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> DP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> EP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> AB AP BP CP DP EP <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minimal_witness_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">k</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k0</span><span class="main">.</span> <span class="bound">k0</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">k0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">k0</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">h</span> <span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> finite_K<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="var">?K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nonempty_K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?K</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="var">?K</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> witness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">P</span> <span class="var">?k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Min_in finite_K mem_Collect_eq nonempty_K<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> minimal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">&lt;</span> <span class="var">?k</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="bound">h</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min_le witness dual_order.strict_implies_order 
        dual_order.trans finite_K leD mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> witness minimal <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minimal_witness<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Minimal<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">k</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">K</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">K</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">K</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms minimal_witness_ex <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_minimal_witness<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Minimal<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">k</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">K</span><span class="main">.</span> <span class="free">P</span> <span class="bound">K</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">K</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">P</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms minimal_witness_ex <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ListTools">
<div class="head">
<h1>Theory ListTools</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ListTools
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_first</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_first</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">@</span><span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_last</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_last</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="bound">v</span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_prefix</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">@</span><span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_proper_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_proper_prefix</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">@</span><span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_eq_proper_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> is_proper_prefix <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 is_prefix_def is_proper_prefix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_proper_prefix_eq_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_proper_prefix <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">∧</span> is_prefix <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_self_conv is_prefix_eq_proper_prefix is_proper_prefix_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_suffix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_suffix</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_proper_suffix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_proper_suffix</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">w</span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_suffix_eq_proper_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_suffix <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> is_proper_suffix <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil is_proper_suffix_def is_suffix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_proper_suffix_eq_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_proper_suffix <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">∧</span> is_suffix <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_proper_suffix_def is_suffix_eq_proper_suffix self_append_conv2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_unsplit<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">u</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj is_prefix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_take_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> take <span class="free">j</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">j</span> <span class="free">b</span> <span class="main">⟹</span> take <span class="free">i</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">b</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min.absorb1 take_take<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_first_drop_length<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> length <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">X</span><span class="main">#</span><span class="free">w</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">k</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_first <span class="free">X</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> length <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> pos_d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> take_d'_v<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="var">?d</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> take <span class="var">?d</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj drop_take<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">1</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> take <span class="main">1</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI le_take_same pos_d'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">1</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id is_first_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_first_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"is_first <span class="free">x</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_first_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all_pos_neg_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">D</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span>list_all <span class="free">Q</span> <span class="free">D</span><span class="main">)</span> <span class="main">⟹</span> 
       <span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">∧</span> <span class="free">P</span><span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="free">Q</span><span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> list_all_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> split_list_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">D</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">D</span> <span class="main">!</span> <span class="free">k</span><span class="main">]</span><span class="main">@</span><span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil id_take_nth_drop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> take_eq_take_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">a</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> take <span class="free">j</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">a</span> <span class="main">@</span> <span class="bound">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex take_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_proper_suffix_length_cmp<span class="main">:</span> <span class="quoted"><span class="quoted">"is_proper_suffix <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> length <span class="free">a</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' append_Nil append_eq_append_conv 
  diff_is_0_eq is_proper_suffix_def leI length_append list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Derivations">
<div class="head">
<h1>Theory Derivations</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Derivations
<span class="keyword2"><span class="keyword">imports</span></span> <a href="CFG.html">CFG</a> <a href="ListTools.html">ListTools</a> <a href="InductRules.html">InductRules</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* leftderives and leftderives1 *)</span>
<span class="keyword1"><span class="command">context</span></span> CFG <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_terminal <span class="free">t</span> <span class="main">⟹</span> is_symbol <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_terminal_def is_symbol_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sentence_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_word_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">u</span> <span class="main">⟹</span> is_sentence <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_word_def is_sentence_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">leftderives1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">leftderives1</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">N</span> <span class="bound">α</span><span class="main">.</span> 
          <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="bound">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">y</span>
        <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">α</span> <span class="main">@</span> <span class="bound">y</span>
        <span class="main">∧</span> is_word <span class="bound">x</span>
        <span class="main">∧</span> is_sentence <span class="bound">y</span>
        <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> leftderives1_implies_derives1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives1 <span class="free">u</span> <span class="free">v</span> <span class="main">⟹</span> derives1 <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftderives1_def derives1_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">leftderivations1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sentence <span class="main">×</span> sentence<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">leftderivations1</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> leftderives1 <span class="bound">u</span> <span class="bound">v</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"leftderivations1 <span class="main">⊆</span> derivations1"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftderivations1_def derivations1_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">leftderivations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sentence <span class="main">×</span> sentence<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">leftderivations</span> <span class="main">=</span> leftderivations1<span class="main">^*</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_subset_implies<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊆</span> <span class="free">b</span><span class="main">^*</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderivations_subset_derivations<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"leftderivations <span class="main">⊆</span> derivations"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftderivations_def derivations_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_subset_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_subset_implies<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">leftderives</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">leftderives</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">∈</span> leftderivations<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives_implies_derives<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">u</span> <span class="free">v</span> <span class="main">⟹</span> derives <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftderives_def derives_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> leftderivations_subset_derivations<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_leftderivation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leftderivation</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leftderivation_implies_derivation<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_leftderivation <span class="free">u</span> <span class="main">⟹</span> is_derivation <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leftderivation_def is_derivation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">u</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftderives_def leftderivations_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives1_implies_leftderives<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"leftderives1 <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> leftderives <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftderives_def leftderivations_def leftderivations1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> leftderives <span class="free">b</span> <span class="free">c</span> <span class="main">⟹</span> leftderives <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftderives_def leftderivations_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives1_eq_leftderivations1<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives1 <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> leftderivations1<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftderivations1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Base Step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derives<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> leftderives <span class="free">a</span> <span class="bound">y</span> <span class="main">⟹</span> leftderives1 <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> rtrancl_lemma <span class="main">=</span> rtrancl_induct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted">leftderivations1</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> derives Pa induct rtrancl_lemma <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leftderives_def leftderivations_def leftderives1_eq_leftderivations1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Basic lemmas about derives1 and derives *)</span>
<span class="keyword1"><span class="command">context</span></span> CFG <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derives1_implies_derives<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"derives1 <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> derives <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derives_def derivations_def derivations1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derives_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> derives <span class="free">b</span> <span class="free">c</span> <span class="main">⟹</span> derives <span class="free">a</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derives_def derivations_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derives1_eq_derivations1<span class="main">:</span> <span class="quoted"><span class="quoted">"derives1 <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> derivations1<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivations1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derives_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Base Step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derives<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> derives <span class="free">a</span> <span class="bound">y</span> <span class="main">⟹</span> derives1 <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> rtrancl_lemma <span class="main">=</span> rtrancl_induct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted">derivations1</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> derives Pa induct rtrancl_lemma <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> derives_def derivations_def derives1_eq_derivations1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Derives1 and Derivation, LDerives1 and LDerivation *)</span>
<span class="keyword1"><span class="command">context</span></span> CFG <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Derives1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> nat <span class="main">⇒</span> rule <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Derives1</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">N</span> <span class="bound">α</span><span class="main">.</span> 
          <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="bound">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">y</span>
        <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">α</span> <span class="main">@</span> <span class="bound">y</span>
        <span class="main">∧</span> is_sentence <span class="bound">x</span>
        <span class="main">∧</span> is_sentence <span class="bound">y</span>
        <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>
        <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> length <span class="bound">x</span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> Derives1_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Derives1 <span class="free">u</span> <span class="free">i</span> <span class="free">r</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="main">[</span>fst <span class="free">r</span><span class="main">]</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_def fst_conv snd_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_implies_derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">u</span> <span class="free">i</span> <span class="free">r</span> <span class="free">v</span> <span class="main">⟹</span> derives1 <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def derives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derives1_implies_Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"derives1 <span class="free">u</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> Derives1 <span class="free">u</span> <span class="bound">i</span> <span class="bound">r</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def derives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_unique_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">u</span> <span class="free">i</span> <span class="free">r</span> <span class="free">v</span> <span class="main">⟹</span> Derives1 <span class="free">u</span> <span class="free">i</span> <span class="free">r</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def derives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_unique_src<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">u</span> <span class="free">i</span> <span class="free">r</span> <span class="free">w</span> <span class="main">⟹</span> Derives1 <span class="free">v</span> <span class="free">i</span> <span class="free">r</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def derives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> derivation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> rule<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Derivation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> derivation <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Derivation</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Derivation</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> Derives1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Derivation</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_implies_derives<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> derives <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derives_def derivations_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> ihyps <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> ihyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> Derivation <span class="bound">x</span> <span class="skolem">D</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xb<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Derives1_implies_derives1 <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="skolem">a</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ihyps xb <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span><span class="quoted"><span class="quoted">"derives <span class="skolem">x</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"derives <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> derives_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> d1 d2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> Derivation_Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">S</span> <span class="free">y</span> <span class="main">⟹</span> Derives1 <span class="free">y</span> <span class="free">i</span> <span class="free">r</span> <span class="free">z</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="main">(</span><span class="free">S</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derivation.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_Cons<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derives_implies_Derivation<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">D</span><span class="main">.</span> Derivation <span class="free">a</span> <span class="bound">D</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> derives_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Base
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ihyps <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> ihyps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> ay<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="skolem">D</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ihyps derives1_implies_Derives1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">y</span> <span class="skolem">i</span> <span class="skolem">r</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> Derivation_Derives1<span class="main">[</span><span class="operator">OF</span> ay yz<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> Derives1_take<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> take <span class="free">i</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_length<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> length <span class="free">b</span> <span class="main">=</span> length <span class="free">a</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">leftmost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">leftmost</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> is_word <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> is_nonterminal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> set_take<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">s</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> List.nth_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_trans linear not_le take_all<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> list_all_take<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">s</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_take list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_sentence_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">x</span><span class="main">@</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_sentence <span class="free">x</span> <span class="main">∧</span> is_sentence <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sentence_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_sentence_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_symbol <span class="free">x</span> <span class="main">∧</span> is_sentence <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sentence_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rule_nonterminal_type<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">⟹</span> is_nonterminal <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> validRules<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_nonterminal_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rule_α_type<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">⟹</span> is_sentence <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> validRules<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sentence_def is_symbol_def list_all_iff is_terminal_def is_nonterminal_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="free">N</span> <span class="main">⟹</span> is_symbol <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_symbol_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_sentence1<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> is_sentence <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def is_sentence_cons is_sentence_concat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_sentence2<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> is_sentence <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def is_sentence_cons is_sentence_concat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Derives1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_sentence_symbol<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">a</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">a</span> <span class="main">⟹</span> is_symbol <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sentence_def list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_symbol_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"is_symbol <span class="free">x</span> <span class="main">⟹</span> is_terminal <span class="free">x</span> <span class="main">≠</span> is_nonterminal <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> disjunct_symbols<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_symbol_def is_terminal_def is_nonterminal_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_terminal_nonterminal<span class="main">:</span> <span class="quoted"><span class="quoted">"is_terminal <span class="free">x</span> <span class="main">⟹</span> is_nonterminal <span class="free">x</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_symbol_def is_symbol_distinct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_leftmost<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> leftmost <span class="bound">j</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?J</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span> <span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">a</span> <span class="main">∧</span> is_nonterminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="var">?J</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> J1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="var">?J</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def is_nonterminal_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> prod.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> validRules<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> J2<span class="main">:</span><span class="quoted"><span class="quoted">"finite <span class="var">?J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> J <span class="main">=</span> J1 J2
  <span class="keyword1"><span class="command">from</span></span> J <span class="keyword1"><span class="command">have</span></span> M1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">∈</span> <span class="var">?J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?J</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> M3 <span class="main">=</span> this<span class="main">[</span><span class="operator">OF</span> J1<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> a_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_sentence1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> is_word<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span>take <span class="var">?M</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_word_def list_all_take<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> i_less_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?M</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> i_inbounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">a</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_terminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_terminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_inbounds a_sentence is_sentence_symbol is_symbol_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i_inbounds mem_Collect_eq<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> J2 Min_le i_less_M leD<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i_less_M less_asym'<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?M</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> M1 M3 is_word mem_Collect_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_leftmost<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> leftmost <span class="bound">i</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">D</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_leftmost<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonword_has_nonterminal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_sentence <span class="free">a</span> <span class="main">⟹</span>  <span class="main">¬</span> <span class="main">(</span>is_word <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">a</span> <span class="main">∧</span> is_nonterminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sentence_def list_all_iff is_word_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth is_symbol_distinct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_cons_nonterminal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_nonterminal <span class="free">x</span> <span class="main">⟹</span> leftmost <span class="main">0</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> CFG.is_word_def CFG_axioms leftmost_def length_greater_0_conv list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
    list_all_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nth_Cons_0 take_Cons'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_cons_terminal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_terminal <span class="free">x</span> <span class="main">⟹</span> leftmost <span class="free">i</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> leftmost <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_1 Suc_less_eq is_terminal_nonterminal is_word_def leftmost_def length_Cons 
    list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_gr0 nth_Cons' take_Cons'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_nonterminal_cons_terminal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_terminal <span class="free">x</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> is_nonterminal <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">a</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">a</span> <span class="main">∧</span> is_nonterminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI is_terminal_nonterminal less_diff_conv2 
    list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nth_non_equal_first_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_exists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_sentence <span class="free">a</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">a</span> <span class="main">⟹</span> is_nonterminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> 
   <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> leftmost <span class="bound">i</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_cons_nonterminal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"is_terminal <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> is_sentence_cons is_symbol_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> k <span class="main">=</span> is_nonterminal_cons_terminal<span class="main">[</span><span class="operator">OF</span> x Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> leftmost <span class="bound">i</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_sentence_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_cons_terminal<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_diff_conv2 Suc_leI add_Suc_right add_diff_cancel_right' k 
          le_0_eq le_imp_less_Suc nat_le_linear<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonword_leftmost_exists<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_sentence <span class="free">a</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span>is_word <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> leftmost <span class="bound">i</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leftmost_exists nonword_has_nonterminal<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> leftmost_unaffected_Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">j</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> leftmost <span class="free">j</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">a</span> <span class="main">∧</span> is_word <span class="main">(</span>take <span class="free">j</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> is_nonterminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">ss</span> <span class="bound">ssa</span><span class="main">.</span> take <span class="main">(</span>length <span class="main">(</span>take <span class="bound">n</span> <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">ssa</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="bound">ss</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n</span> <span class="bound">ssa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_take take_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ss</span><span class="main">.</span> take <span class="free">j</span> <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">=</span> take <span class="free">i</span> <span class="main">(</span>take <span class="free">j</span> <span class="bound">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_implies_order min.absorb2 take_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">j</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_implies_order length_take min.absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> min <span class="free">j</span> <span class="bound">n</span> <span class="main">=</span> length <span class="main">(</span>take <span class="bound">n</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">ss</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> length <span class="main">(</span>take <span class="bound">n</span> <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> length <span class="bound">ss</span> <span class="main">&lt;</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leI length_take min.absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ss</span><span class="main">.</span> take <span class="free">j</span> <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">=</span> take <span class="free">j</span> <span class="main">(</span>take <span class="free">i</span> <span class="bound">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f7 f6 f5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> take_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ss</span> <span class="bound">n</span><span class="main">.</span> length <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∨</span> length <span class="main">(</span>take <span class="bound">n</span> <span class="bound">ss</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f8 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_implies_order<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ss</span> <span class="bound">ssa</span><span class="main">.</span> length <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>take <span class="main">(</span>length <span class="bound">ss</span><span class="main">)</span> <span class="main">(</span><span class="bound">ssa</span><span class="main">::</span>symbol list<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> length <span class="main">(</span>take <span class="main">(</span>length <span class="bound">ssa</span><span class="main">)</span> <span class="bound">ss</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">ssa</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_take min.absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ss</span> <span class="bound">ssa</span> <span class="bound">n</span><span class="main">.</span> take <span class="main">(</span>length <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">ssa</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">=</span> take <span class="bound">n</span> <span class="main">(</span>take <span class="main">(</span>length <span class="bound">ss</span><span class="main">)</span> <span class="bound">ssa</span><span class="main">)</span> <span class="main">∨</span> length <span class="main">(</span>take <span class="bound">n</span> <span class="bound">ss</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f10 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min.absorb2 take_take<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">∧</span> length <span class="main">(</span>take <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> length <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="free">j</span> <span class="bound">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> length <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">a</span><span class="main">)</span> <span class="bound">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f12 f11 f6 f5 f4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ss</span> <span class="bound">ssa</span><span class="main">.</span> take <span class="main">(</span>length <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="free">j</span> <span class="main">(</span><span class="bound">ssa</span><span class="main">::</span>symbol list<span class="main">)</span><span class="main">)</span> <span class="main">≠</span> take <span class="main">(</span>length <span class="bound">ss</span><span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">a</span><span class="main">)</span> <span class="bound">ssa</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f9 f4 f3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f7 f6 f5 f3 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_take<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">=</span> <span class="free">j</span> <span class="main">⟶</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f9 f8 f7 f6 f4 f3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">b</span> <span class="main">∧</span> is_word <span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> is_nonterminal <span class="main">(</span><span class="free">b</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f9 f3 a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_take<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">derivation_ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"derivation <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derivation_ge</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">.</span> fst <span class="bound">d</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_ge_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span><span class="free">d</span><span class="main">#</span><span class="free">D</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">d</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">∧</span> derivation_ge <span class="free">D</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_ge_append<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="free">E</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>derivation_ge <span class="free">D</span> <span class="free">i</span> <span class="main">∧</span> derivation_ge <span class="free">E</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_unaffected_Derivation<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> leftmost <span class="free">i</span> <span class="free">a</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> leftmost <span class="free">i</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> Derivation <span class="bound">x</span> <span class="skolem">D</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> leftmost_x<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> leftmost_unaffected_Derives1<span class="main"><span class="main">[</span></span>
           <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">x</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem">d</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem">d</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons x2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_Derives1_take<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">j</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> Derives1_take<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> le D <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> le_take_same<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> Derivation_take<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">i</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> take <span class="free">i</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> Derivation <span class="bound">x</span> <span class="skolem">D</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> ax<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xb<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">from</span></span> derivation_ge_cons Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> fst <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">D</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> take_i_xb <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> D xb<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> take_i_ax <span class="main">=</span> le_Derives1_take<span class="main">[</span><span class="operator">OF</span> d ax<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> take_i_xb take_i_ax <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_cons_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">u</span> <span class="main">⟹</span> leftmost <span class="free">i</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> leftmost <span class="free">i</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_def nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_is_nonterminal<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">u</span> <span class="main">⟹</span> is_nonterminal <span class="main">(</span><span class="free">u</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leftmost_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_word_is_terminal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">u</span> <span class="main">⟹</span> is_word <span class="free">u</span> <span class="main">⟹</span> is_terminal <span class="main">(</span><span class="free">u</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_word_def list_all_length<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> leftmost_append<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> leftmost<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> is_word<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">u</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">u</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True 
  <span class="keyword1"><span class="command">with</span></span> leftmost <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> leftmost_cons_less<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_nonterminal<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="free">u</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> leftmost_is_nonterminal<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> is_terminal <span class="main">=</span> is_word_is_terminal<span class="main">[</span><span class="operator">OF</span> True is_word<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> is_terminal_nonterminal<span class="main">[</span><span class="operator">OF</span> is_terminal is_nonterminal<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_ge_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">[]</span> <span class="free">i</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_notword<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span>is_word <span class="main">(</span>take <span class="free">j</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_terminal_nonterminal is_word_def leftmost_def list_all_take<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">a</span> <span class="main">⟹</span> leftmost <span class="free">j</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leftmost_def leftmost_notword linorder_neqE_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">a</span> <span class="main">⟹</span> Derives1 <span class="free">a</span> <span class="free">j</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_leftmost leftmost_unique<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_Derives1_propagate<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> leftmost<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">j</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>is_word <span class="free">b</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> leftmost <span class="bound">k</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> leftmost_Derives1<span class="main">[</span><span class="operator">OF</span> leftmost Derives1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_word <span class="free">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1 True ij le_neq_implies_less leftmost 
          leftmost_unaffected_Derives1 order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Derives1 Derives1_bound Derives1_sentence2 
          Derives1_take append_take_drop_id ij le_neq_implies_less leftmost 
          leftmost_append leftmost_cons_less leftmost_def length_take 
          min.absorb2 nat_le_linear nonword_leftmost_exists not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_word_Derives1<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">a</span> <span class="main">⟹</span> Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_leftmost is_terminal_nonterminal is_word_is_terminal leftmost_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> is_word_Derivation<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">a</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derivation_leftmost is_terminal_nonterminal is_word_def 
    leftmost_def list_all_length<span class="main">)</span>
 
<span class="keyword1"><span class="command">lemma</span></span> leftmost_Derivation<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">a</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> derivation_ge <span class="free">D</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> Derivation <span class="bound">x</span> <span class="skolem">D</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> ax<span class="main">:</span><span class="quoted"><span class="quoted">"Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xb<span class="main">:</span><span class="quoted"><span class="quoted">"Derivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> ji <span class="main">=</span> Cons<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> i_fstd <span class="main">=</span> leftmost_Derives1<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ax<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> disj <span class="main">=</span> leftmost_Derives1_propagate<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ax<span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 
    <span class="keyword1"><span class="command">with</span></span> xb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 1 ji <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="skolem">k</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> ge <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> k xb<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> ji ik i_fstd ge <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_ge_list_all<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">i</span> <span class="main">=</span> list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">d</span><span class="main">.</span> fst <span class="bound">d</span> <span class="main">≥</span> <span class="free">i</span><span class="main">)</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_set derivation_ge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_derivation_leftmost<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>derivation_ge <span class="free">D</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">E</span> <span class="bound">F</span> <span class="bound">r</span><span class="main">.</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">E</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">]</span><span class="main">@</span><span class="bound">F</span> <span class="main">∧</span> derivation_ge <span class="bound">E</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">∧</span> fst<span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>fst<span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≥</span> Suc <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> derivation_ge_def in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">∧</span> fst<span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ex_minimal_witness<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minimal <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k_i<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="skolem">k</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> split <span class="main">=</span> split_list_at<span class="main">[</span><span class="operator">OF</span> k_len<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> k_i <span class="keyword1"><span class="command">have</span></span> D_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?E</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?F</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?r</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> D_k<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> split<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Minimal.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_leI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
            derivation_ge_list_all le_neq_implies_less list_all_length list_all_take<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_Derives1_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">j</span> <span class="free">p</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">b</span> <span class="free">i</span> <span class="free">q</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">q</span> <span class="bound">b'</span> <span class="main">∧</span> Derives1 <span class="bound">b'</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Derives1_split<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    a_src<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">[</span>fst <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">a2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> snd <span class="free">p</span> <span class="main">@</span> <span class="skolem">a2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> a1_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">a1</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> a <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> is_sentence_a1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="skolem">a1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1_sentence2 assms<span class="main">(</span>2<span class="main">)</span> is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> is_sentence_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="skolem">a2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1_sentence2 assms<span class="main">(</span>2<span class="main">)</span> is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> is_symbol_fst_p<span class="main">:</span>  <span class="quoted"><span class="quoted">"is_symbol <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_sentence1 assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_sentence_concat is_sentence_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Derives1_split<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    b_src<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span>fst <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="skolem">b1</span> <span class="main">@</span> snd <span class="free">q</span> <span class="main">@</span> <span class="skolem">b2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> b1_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">b1</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> a_take_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> take <span class="free">j</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a1_len a_src append_eq_conv_conj<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> b_take_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span>fst <span class="free">q</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc append_eq_conv_conj b1_len b_src length_append_singleton<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> a_take_j b_take_i  take_eq_take_append<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="skolem">a1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span>fst <span class="free">q</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="bound">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add Suc_leI a1_len a_dest append_eq_conv_conj assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> take_add<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span>fst <span class="free">q</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_i_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_eq_plus1 a1_len b1_len length_append length_append_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> u1 is_sentence_a1 <span class="keyword1"><span class="command">have</span></span> is_sentence_b1_u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="skolem">b1</span> <span class="main">∧</span> is_sentence <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
  <span class="keyword1"><span class="command">have</span></span> u2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> snd <span class="free">p</span> <span class="main">@</span> <span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a_dest append_assoc b_src same_append_eq u1<span class="main">)</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">@</span> <span class="main">(</span>snd <span class="free">q</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span>fst <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">a2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> q_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a_b'<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">q</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Derives1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">b1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">u</span></span><span class="main"><span class="main">@</span></span><span class="main"><span class="main">[</span></span>fst <span class="free"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">@</span></span><span class="skolem"><span class="skolem">a2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="free"><span class="free">q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="free"><span class="free">q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b1_len is_sentence_cons is_sentence_concat
           is_sentence_a2 is_symbol_fst_p is_sentence_b1_u a_src u1 q_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> p_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> is_sentence_snd_q<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span>snd <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Derives1_sentence2 a_b' is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> b'_c<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="var">?b</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Derives1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">b1</span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">(</span></span>snd <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">u</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">a2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="free"><span class="free">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="free"><span class="free">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sentence_concat is_sentence_b1_u is_sentence_a2 p_dom
           is_sentence_snd_q b_dest u2 b1_len j_i_u<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?b</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> a_b'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> b'_c<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">derivation_shift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"derivation <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> derivation"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derivation_shift</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">d</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">,</span> snd <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_shift_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_shift <span class="main">[]</span> <span class="free">left</span> <span class="free">right</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_shift_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"derivation_shift <span class="main">(</span><span class="free">d</span><span class="main">#</span><span class="free">D</span><span class="main">)</span> <span class="free">left</span> <span class="free">right</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fst <span class="free">d</span> <span class="main">-</span> <span class="free">left</span> <span class="main">+</span> <span class="free">right</span><span class="main">,</span> snd <span class="free">d</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>derivation_shift <span class="free">D</span> <span class="free">left</span> <span class="free">right</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_append<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="free">E</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="bound">b</span> <span class="main">∧</span> Derivation <span class="bound">b</span> <span class="free">E</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">E</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_implies_append<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> Derivation <span class="free">b</span> <span class="free">E</span> <span class="free">c</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="free">E</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Derivation_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_swap_single_end_to_front<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> derivation_ge <span class="free">D</span> <span class="free">j</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">b</span> <span class="main">⟹</span>
   Derivation <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">c</span> <span class="main">∧</span> Derivation <span class="bound">c</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> ac<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="skolem">c</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> D_j<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">D</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> D_j cb<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> cx<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">c</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  
    xb<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="skolem">x</span> <span class="main">(</span>derivation_shift <span class="skolem">D</span> <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_fst_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> fst <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons derivation_ge_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Derives1_Derives1_swap<span class="main">[</span><span class="operator">OF</span> i_fst_d ac cx<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab'<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">a</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">b'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    b'x<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">b'</span> <span class="main">(</span>fst <span class="skolem">d</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ab' b'x xb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> Derivation_swap_single_mid_to_front<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">j</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">@</span><span class="free">E</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> Derivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> Derivation <span class="bound">x</span> <span class="free">E</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derivation_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> ax<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xb<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="skolem">x</span> <span class="free">E</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derivation_swap_single_end_to_front <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Derivation_append xb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_derivation_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"length<span class="main">(</span>derivation_shift <span class="free">D</span> <span class="free">left</span> <span class="free">right</span><span class="main">)</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LeftDerives1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> nat <span class="main">⇒</span> rule <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">LeftDerives1</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span>leftmost <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> Derives1 <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_implies_leftderives1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">u</span> <span class="free">i</span> <span class="free">r</span> <span class="free">v</span> <span class="main">⟹</span> leftderives1 <span class="free">u</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_def LeftDerives1_def append_eq_conv_conj leftderives1_def 
    leftmost_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> leftmost_Derives1_leftderives<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">a</span> <span class="main">⟹</span> Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> leftderives <span class="free">b</span> <span class="free">c</span> <span class="main">⟹</span> leftderives <span class="free">a</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> LeftDerives1_def LeftDerives1_implies_leftderives1 
  leftderives1_implies_leftderives leftderives_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Derivation_implies_leftderives_gen<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">D</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> is_word <span class="free">u</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> 
          leftderives <span class="free">a</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="main">∀</span> <span class="bound">X</span><span class="main">.</span> is_first <span class="bound">X</span> <span class="free">v</span> <span class="main">⟶</span> is_first <span class="bound">X</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">D</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Suc Derivation_leftmost <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> leftmost <span class="bound">i</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="skolem">i</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?case</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">D</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> leftmost<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="skolem">i</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> leftmost_unaffected_Derivation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> True i<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> length_u<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> leftmost_append<span class="main">[</span><span class="operator">OF</span> leftmost Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> take_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span>  Derivation_take<span class="main">[</span><span class="operator">OF</span> True Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">with</span></span> length_u <span class="keyword1"><span class="command">have</span></span> is_prefix_u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">u</span> <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc append_take_drop_id dual_order.strict_implies_order 
              is_prefix_def le_imp_less_Suc take_all take_append<span class="main">)</span>  
        <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> is_prefix_unsplit<span class="main">[</span><span class="operator">OF</span> is_prefix_u<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">from</span></span> take_Suc <span class="keyword1"><span class="command">have</span></span> length_take_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI i leftmost_def length_take min.absorb2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> length_u <span class="keyword1"><span class="command">have</span></span> right<span class="main">:</span> <span class="quoted"><span class="quoted">"length<span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">note</span></span> left <span class="main">=</span> length_take_Suc
          <span class="keyword1"><span class="command">from</span></span> left right take_Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">=</span> length <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> length_u <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">X</span> <span class="bound">w</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">=</span> <span class="bound">X</span><span class="main">#</span><span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">#</span><span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> is_first_X<span class="main">:</span> <span class="quoted"><span class="quoted">"is_first <span class="skolem">X</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> is_first_drop_length<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> w<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> k<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc v<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI i leftmost_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> length_u<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"drop <span class="main"><span class="main">(</span></span>length <span class="skolem"><span class="skolem">u</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">a</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a v is_first_cons is_first_X<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> Di<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">D</span> <span class="skolem">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> leftmost_Derivation<span class="main">[</span><span class="operator">OF</span> i Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> split_derivation_leftmost<span class="main">[</span><span class="operator">OF</span> Di False<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> D_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">F</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> E_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">E</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>derivation_shift <span class="skolem">E</span> <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> D_split 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Derivation <span class="skolem">a</span> <span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="var">?D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Derivation_swap_single_mid_to_front E_Suc Suc.prems<span class="main">(</span>1<span class="main">)</span> lessI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> Derives1 <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">r</span> <span class="bound">y</span> <span class="main">∧</span> Derivation <span class="bound">y</span> <span class="var">?D</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> ay<span class="main">:</span><span class="quoted"><span class="quoted">"Derives1 <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">r</span> <span class="skolem">y</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> yuv<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="skolem">y</span> <span class="var">?D</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> length_D'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?D</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D_split Suc.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> length_D'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> yuv Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> is_first <span class="bound">X</span> <span class="skolem">v</span> <span class="main">⟶</span> is_first <span class="bound">X</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ay i leftmost_Derives1_leftderives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>    
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1"><span class="command">lemma</span></span> derives_implies_leftderives_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">a</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> is_word <span class="free">u</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> 
          leftderives <span class="free">a</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="main">∀</span> <span class="bound">X</span><span class="main">.</span> is_first <span class="bound">X</span> <span class="free">v</span> <span class="main">⟶</span> is_first <span class="bound">X</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Derivation_implies_leftderives_gen derives_implies_Derivation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> derives_implies_leftderives<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> is_word <span class="free">b</span> <span class="main">⟹</span> leftderives <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> derives_implies_leftderives_gen <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">LeftDerivation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> derivation <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LeftDerivation</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">LeftDerivation</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> LeftDerives1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">LeftDerivation</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_implies_Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_implies_Derivation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> CFG.LeftDerivation.simps<span class="main">(</span>2<span class="main">)</span> CFG_axioms Derivation.simps<span class="main">(</span>2<span class="main">)</span> 
    LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_implies_leftderives<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> leftderives <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> ihyps <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> ihyps <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> LeftDerives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> LeftDerivation <span class="bound">x</span> <span class="skolem">D</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xb<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> LeftDerives1_implies_leftderives1 <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="skolem">a</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ihyps xb <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span><span class="quoted"><span class="quoted">"leftderives <span class="skolem">x</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> leftderives_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> d1 d2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> leftmost_witness<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="main">(</span>length <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">@</span><span class="main">(</span><span class="free">N</span><span class="main">#</span><span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_word <span class="free">x</span> <span class="main">∧</span> is_nonterminal <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives1_implies_LeftDerives1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> leftderives1<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives1 <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> LeftDerives1 <span class="free">u</span> <span class="bound">i</span> <span class="bound">r</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> leftderives1 <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">N</span> <span class="bound">α</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="bound">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">α</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span> is_word <span class="bound">x</span> <span class="main">∧</span> is_sentence <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftderives1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    u<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    v<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    x<span class="main">:</span><span class="quoted"><span class="quoted">"is_word <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  
    y<span class="main">:</span><span class="quoted"><span class="quoted">"is_sentence <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerives1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_def x u rule_nonterminal_type<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def u v<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x y r<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_LeftDerives1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">S</span> <span class="free">y</span> <span class="main">⟹</span> LeftDerives1 <span class="free">y</span> <span class="free">i</span> <span class="free">r</span> <span class="free">z</span> <span class="main">⟹</span> LeftDerivation <span class="free">a</span> <span class="main">(</span><span class="free">S</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivation.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_Cons<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives_implies_LeftDerivation<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">D</span><span class="main">.</span> LeftDerivation <span class="free">a</span> <span class="bound">D</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> leftderives_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Base
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ihyps <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> ihyps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> ay<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="skolem">D</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ihyps leftderives1_implies_LeftDerives1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">y</span> <span class="skolem">i</span> <span class="skolem">r</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerivation_LeftDerives1<span class="main">[</span><span class="operator">OF</span> ay yz<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_append<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="free">E</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="bound">b</span> <span class="main">∧</span> LeftDerivation <span class="bound">b</span> <span class="free">E</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">E</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_implies_append<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> LeftDerivation <span class="free">b</span> <span class="free">E</span> <span class="free">c</span> <span class="main">⟹</span> LeftDerivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="free">E</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> LeftDerivation_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_unique_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> Derives1_unique_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_unique_src<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">c</span> <span class="main">⟹</span> Derivation <span class="free">b</span> <span class="free">D</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> Derives1_unique_src <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> LeftDerives1 <span class="free">a</span> <span class="free">j</span> <span class="free">s</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Derives1_def LeftDerives1_def leftmost_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
<span class="keyword1"><span class="command">lemma</span></span> leftlang<span class="main">:</span> <span class="quoted"><span class="quoted">"ℒ <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">v</span><span class="main">.</span> is_word <span class="bound">v</span> <span class="main">∧</span> is_leftderivation <span class="bound">v</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CFG.is_derivation_def CFG.is_leftderivation_def 
    CFG.leftderivation_implies_derivation CFG_axioms Collect_cong 
    ℒ_def derives_implies_leftderives<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> leftprefixlang<span class="main">:</span>  <span class="quoted"><span class="quoted">"ℒ<span class="hidden">⇩</span><sub>P</sub> <span class="main">=</span> <span class="main">{</span> <span class="bound">u</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> is_word <span class="bound">u</span> <span class="main">∧</span> is_leftderivation <span class="main">(</span><span class="bound">u</span><span class="main">@</span><span class="bound">v</span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_def<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> derives_implies_leftderives_gen is_derivation_def is_leftderivation_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">using</span></span> leftderivation_implies_derivation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> derives_implies_leftderives_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_word <span class="free">a</span> <span class="main">⟹</span> derives <span class="free">u</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">X</span><span class="main">#</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> leftderives <span class="free">u</span>  <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">X</span><span class="main">#</span><span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil derives_implies_leftderives_gen is_first_def<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> is_word_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_word <span class="free">a</span> <span class="main">∧</span> is_word <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_word_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">@</span><span class="free">b</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_is_word<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub> <span class="main">⟹</span> is_word <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> leftprefixlang mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Derive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> derivation <span class="main">⇒</span> sentence"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Derive</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">b</span><span class="main">.</span> Derivation <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_dest_ex_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">∃!</span> <span class="bound">x</span><span class="main">.</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> CFG.Derivation_unique_dest CFG_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Derive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derive <span class="free">a</span> <span class="free">D</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> the1_equality<span class="main">[</span><span class="operator">OF</span> Derivation_dest_ex_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ab<span class="main"><span class="main">]</span></span> ab<span class="main">]</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derive_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Validity">
<div class="head">
<h1>Theory Validity</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Validity 
<span class="keyword2"><span class="keyword">imports</span></span> <a href="LLEarleyParsing.html">LLEarleyParsing</a> <a href="Derivations.html">Derivations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wellformed_token</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wellformed_token</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> is_terminal <span class="main">(</span>terminal_of_token <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wellformed_tokens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wellformed_tokens</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> list_all wellformed_token <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">doc_tokens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">doc_tokens</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>wellformed_tokens <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> is_prefix <span class="main">(</span>chars <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free">Doc</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wellformed_item</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">wellformed_item</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>
    item_rule <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> 
    item_origin <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> item_end <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> 
    item_end <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> length <span class="free">Doc</span> <span class="main">∧</span>
    item_dot <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> length <span class="main">(</span>item_rhs <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wellformed_items</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"items <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wellformed_items</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> wellformed_item <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_word_terminals<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="free">p</span> <span class="main">⟹</span> is_word <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_word_def list_all_length terminals_def wellformed_token_def wellformed_tokens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_word_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">x</span> <span class="main">⟹</span> set <span class="free">y</span> <span class="main">⊆</span> set <span class="free">x</span> <span class="main">⟹</span> is_word <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> in_set_conv_nth is_word_def list_all_length subsetCE<span class="main">)</span>
 
<span class="keyword1"><span class="command">lemma</span></span> is_word_terminals_take<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="free">p</span> <span class="main">⟹</span> is_word<span class="main">(</span>terminals <span class="main">(</span>take <span class="free">n</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id is_word_terminals list_all_append wellformed_tokens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_word_terminals_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="free">p</span> <span class="main">⟹</span> is_word<span class="main">(</span>terminals <span class="main">(</span>drop <span class="free">n</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id is_word_terminals list_all_append wellformed_tokens_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pvalid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens <span class="main">⇒</span> item <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pvalid</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u</span> <span class="bound">γ</span><span class="main">.</span>
     wellformed_tokens <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span>
     wellformed_item <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
     <span class="bound">u</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span>
     charslength <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> item_end <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
     charslength <span class="main">(</span>take <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> item_origin <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
     is_derivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="bound">γ</span><span class="main">)</span> <span class="main">∧</span>
     derives <span class="main">(</span>item_α <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Gen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens set <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Gen</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> pvalid <span class="bound">p</span> <span class="bound">x</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>Gen <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gen_def pvalid_def wellformed_items_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>Init<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_def Init_def init_item_def wellformed_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pvalid_left</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens <span class="main">⇒</span> item <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pvalid_left</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u</span> <span class="bound">γ</span><span class="main">.</span>
     wellformed_tokens <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span>
     wellformed_item <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
     <span class="bound">u</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span>
     charslength <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> item_end <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
     charslength <span class="main">(</span>take <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> item_origin <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
     is_leftderivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="bound">γ</span><span class="main">)</span> <span class="main">∧</span>
     leftderives <span class="main">(</span>item_α <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pvalid_left<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> pvalid_left <span class="free">p</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> right_imp_left<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid_left <span class="free">p</span> <span class="free">x</span> <span class="main">⟹</span> pvalid <span class="free">p</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> CFG.leftderives_implies_derives CFG_axioms LocalLexing.pvalid_def 
        LocalLexing.pvalid_left_def LocalLexing_axioms leftderivation_implies_derivation<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> left_imp_right<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span> <span class="main">⟹</span> pvalid_left <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"wellformed_tokens <span class="free">p</span> <span class="main">∧</span>
       wellformed_item <span class="free">x</span> <span class="main">∧</span>
       <span class="skolem">u</span> <span class="main">≤</span> length <span class="free">p</span> <span class="main">∧</span>
       charslength <span class="free">p</span> <span class="main">=</span> item_end <span class="free">x</span> <span class="main">∧</span>
       charslength <span class="main">(</span>take <span class="skolem">u</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> item_origin <span class="free">x</span> <span class="main">∧</span>
       is_derivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">u</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span> <span class="main">∧</span>
       derives <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">u</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_left_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_leftderivation_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> derives_implies_leftderives_cons<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> is_word_terminals_take<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_derivation_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> derives_implies_leftderives is_word_terminals_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> left_imp_right right_imp_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_wellformed_tokens<span class="main">:</span> <span class="quoted"><span class="quoted">"terminals <span class="free">p</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub> <span class="main">⟹</span> wellformed_tokens <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_is_word is_word_def length_map list_all_length 
    nth_map terminals_def wellformed_token_def wellformed_tokens_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD2">
<div class="head">
<h1>Theory TheoremD2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD2
<span class="keyword2"><span class="keyword">imports</span></span> <a href="LocalLexingLemmas.html">LocalLexingLemmas</a> <a href="Validity.html">Validity</a> <a href="Derivations.html">Derivations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">splits_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> nat <span class="main">⇒</span> sentence <span class="main">⇒</span> symbol <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">splits_at</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splits_at_combine<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">δ</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="free">β</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_take_nth_drop splits_at_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splits_at_combine_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> splits_at <span class="free">a</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">@</span> <span class="free">β</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Derives1_drop Derives1_split append_assoc append_eq_conv_conj 
      length_append splits_at_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_nonterminal<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"splits_at <span class="free">a</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">r</span> <span class="main">=</span> <span class="free">N</span> <span class="main">∧</span> is_nonterminal <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">r</span> <span class="main">=</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_split append_Cons nth_append_length splits_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.collapse rule_nonterminal_type<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fst <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

  
<span class="keyword1"><span class="command">lemma</span></span> splits_at_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span><span class="main">.</span> splits_at <span class="free">δ</span> <span class="free">i</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_bound splits_at_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splits_at_α<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> splits_at <span class="free">δ</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span> <span class="main">⟹</span> 
  <span class="free">α</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">δ</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">s</span> <span class="main">∧</span> length <span class="free">α</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_split append_eq_conv_conj splits_at_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_splits_at_is_word<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> splits_at <span class="free">δ</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span> <span class="main">⟹</span> is_word <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerives1_def leftmost_def splits_at_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> splits_at_β<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> splits_at <span class="free">δ</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span> <span class="main">⟹</span> 
  <span class="free">β</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">δ</span> <span class="main">∧</span> <span class="free">β</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">∧</span> length <span class="free">β</span> <span class="main">=</span> length <span class="free">δ</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_drop Suc_eq_plus1 diff_diff_left length_drop splits_at_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">δ</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">α</span> <span class="free">a</span> <span class="main">∨</span> is_prefix <span class="free">a</span> <span class="free">α</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> take <span class="free">i</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ab split splits_at_α <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">α</span> <span class="free">a</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id is_prefix_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">a</span> <span class="free">α</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_def nat_le_linear take<span class="main">)</span> 
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">δ</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_suffix <span class="free">β</span> <span class="free">b</span> <span class="main">∨</span> is_suffix <span class="free">b</span> <span class="free">β</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> drop1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ab split splits_at_β <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> drop2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> drop1 drop2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_suffix <span class="free">b</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_suffix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">≤</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">with</span></span> drop1 drop2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_suffix <span class="free">β</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil append_take_drop_id drop_append drop_eq_Nil is_suffix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_skip_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> Derives1 <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">c</span><span class="main">)</span> <span class="main">⟹</span> Derives1 <span class="free">b</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span><span class="main">)</span> <span class="free">r</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_append_conv_if is_sentence_concat is_sentence_cons is_symbol_def 
    length_drop rule_nonterminal_type<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cancel_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="free">b</span> <span class="main">@</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">c</span> <span class="main">≤</span> length <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">@</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">d</span> <span class="main">-</span> length <span class="free">c</span><span class="main">)</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">@</span> take <span class="main">(</span>length <span class="free">d</span> <span class="main">-</span> length <span class="free">c</span><span class="main">)</span> <span class="free">d</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="free">d</span> <span class="main">-</span> length <span class="free">c</span><span class="main">)</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc append_take_drop_id assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_append_conv assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_diff_cancel length_drop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_sentence_take<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_sentence <span class="free">y</span> <span class="main">⟹</span> is_sentence <span class="main">(</span>take <span class="free">n</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id is_sentence_concat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_skip_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">c</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">b</span><span class="main">@</span><span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> Derives1_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">@</span><span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">@</span><span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">N</span> <span class="bound">α</span><span class="main">.</span>
    <span class="free">a</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="bound">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span>
    <span class="free">b</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">α</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span> is_sentence <span class="bound">x</span> <span class="main">∧</span> is_sentence <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> length <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">∧</span>
     <span class="free">b</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">∧</span> is_sentence <span class="skolem">x</span> <span class="main">∧</span> is_sentence <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> length <span class="skolem">x</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> split <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">c</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">+</span> length <span class="free">c</span> <span class="main">=</span> length <span class="skolem">x</span> <span class="main">+</span> length <span class="skolem">y</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> split <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">+</span> length <span class="free">c</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> length <span class="skolem">y</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> len_c_y<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">c</span> <span class="main">≤</span> length <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">y</span> <span class="main">-</span> length <span class="free">c</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> split <span class="keyword1"><span class="command">have</span></span> ac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> cancel_suffix<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">@</span><span class="main">[</span><span class="skolem">N</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> ac len_c_y<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> split <span class="keyword1"><span class="command">have</span></span> bc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> cancel_suffix<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">@</span><span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> bc len_c_y<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="skolem">α</span> <span class="main">@</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> split len_c_y a b <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Derives1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_sentence_take<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> drop_cancel_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">@</span><span class="free">c</span> <span class="main">=</span> drop <span class="free">n</span> <span class="main">(</span><span class="free">b</span><span class="main">@</span><span class="free">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> drop <span class="free">n</span> <span class="main">(</span><span class="free">b</span> <span class="main">@</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>drop <span class="free">n</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> length <span class="free">b</span> <span class="main">+</span> length <span class="free">c</span> <span class="main">-</span> <span class="free">n</span> <span class="main">-</span> length <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' diff_commute length_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' append_eq_append_conv drop_append 
      length_append length_drop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> drop_keep_last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> drop <span class="free">n</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id drop_butlast last_appendR snoc_eq_iff_butlast<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Derives1_X_is_part_of_rule<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> Suffix Prefix<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> aXb<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">δ</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">β</span><span class="main">.</span> <span class="free">δ</span> <span class="main">=</span> <span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="bound">β</span> <span class="main">⟹</span> length <span class="free">a</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> 
                     Derives1 <span class="bound">β</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">α</span><span class="main">.</span> <span class="free">δ</span> <span class="main">=</span> <span class="bound">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span> <span class="main">⟹</span> Derives1 <span class="bound">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">a</span> <span class="main">⟹</span> False"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">@</span> <span class="free">β</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="bound">u</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> prefix_or<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">α</span> <span class="free">a</span> <span class="main">∨</span> is_proper_prefix <span class="free">a</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_prefix split aXb is_prefix_eq_proper_prefix<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_proper_prefix <span class="free">a</span> <span class="free">α</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> proper<span class="main">:</span><span class="quoted"><span class="quoted">"is_proper_prefix <span class="free">a</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">=</span> <span class="free">a</span><span class="main">@</span><span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_proper_prefix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">=</span> <span class="free">a</span><span class="main">@</span><span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> splits_at <span class="main">=</span> splits_at_α<span class="main">[</span><span class="operator">OF</span> aXb split<span class="main">]</span> splits_at_combine<span class="main">[</span><span class="operator">OF</span> split<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> α1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> α2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> take <span class="free">i</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> lenα<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">α</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> proper <span class="keyword1"><span class="command">have</span></span> lena<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> append_eq_conv_conj drop_eq_Nil leI u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> u α2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">@</span><span class="skolem">u</span> <span class="main">=</span> take <span class="free">i</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> lena <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_or_eq_imp_le<span class="main">)</span> 
    <span class="keyword1"><span class="command">with</span></span> lena <span class="keyword1"><span class="command">have</span></span> uX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="main">(</span>take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less take_Cons'<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?β</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> u uX <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="var">?β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> skip <span class="main">=</span> Derives1_skip_prefix<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="var">?β</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
      r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="var">?β</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> One_nat_def Suc_leI aXb append_assoc diff_diff_left f2 lena length_Cons 
        length_append length_append_singleton list.size<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">note</span></span> prefix<span class="main">[</span><span class="operator">OF</span> f2 lena D<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> prefix_or <span class="keyword1"><span class="command">have</span></span> is_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">α</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> aXb <span class="keyword1"><span class="command">have</span></span> aXb'<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span>  Derives1_suffix<span class="main">[</span><span class="operator">OF</span> aXb' split<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> suffix_or<span class="main">:</span> <span class="quoted"><span class="quoted">"is_suffix <span class="free">β</span> <span class="free">b</span> <span class="main">∨</span> is_proper_suffix <span class="free">b</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_suffix_eq_proper_suffix<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_proper_suffix <span class="free">b</span> <span class="free">β</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> proper<span class="main">:</span> <span class="quoted"><span class="quoted">"is_proper_suffix <span class="free">b</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">β</span> <span class="main">=</span> <span class="bound">u</span><span class="main">@</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_proper_suffix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">β</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">@</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> splits_at <span class="main">=</span> splits_at_β<span class="main">[</span><span class="operator">OF</span> aXb split<span class="main">]</span> splits_at_combine<span class="main">[</span><span class="operator">OF</span> split<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> β1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> β2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> lenβ<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">β</span> <span class="main">=</span> length <span class="free">δ</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> proper <span class="keyword1"><span class="command">have</span></span> lenb<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">&lt;</span> length <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_proper_suffix_length_cmp<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> u β2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">@</span><span class="free">b</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_cancel_suffix<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> uX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_keep_last u<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?α</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> u uX <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="var">?α</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> skip <span class="main">=</span> Derives1_skip_suffix<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="var">?α</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
      r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">i</span> <span class="main">+</span> length <span class="free">b</span> <span class="main">=</span> length <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">+</span> length <span class="free">b</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1_left length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>22<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">δ</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> length <span class="main">(</span><span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> Suc <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f2 length_drop splits_at<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="main">[]</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">≠</span> length <span class="free">δ</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' append_Nil2 append_eq_append_conv lenβ length_append u<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="main">[]</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">≠</span> length <span class="free">α</span> <span class="main">+</span> length <span class="main">(</span><span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1_left add_diff_cancel_right' diff_diff_left length_append<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> aXb f2 <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="var">?α</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> skip<span class="main">[</span><span class="operator">OF</span> f3 D<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> suffix<span class="main">[</span><span class="operator">OF</span> f2  skip<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f3 D<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> suffix_or <span class="keyword1"><span class="command">have</span></span> is_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_suffix <span class="free">β</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> is_prefix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> is_suffix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free">b</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">@</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_suffix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">@</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">from</span></span> u v splits_at_combine<span class="main">[</span><span class="operator">OF</span> split<span class="main">]</span> aXb <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span><span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span><span class="main">@</span><span class="free">β</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> splits_at_α<span class="main">[</span><span class="operator">OF</span> aXb split<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">α</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">α</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> Derives1_skip_suffix<span class="main">[</span><span class="operator">OF</span> _ Derives1_skip_prefix<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i1 D<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> i2<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">0</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="free">r</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_split append_Cons append_Nil length_0_conv list.inject self_append_conv<span class="main">)</span> 

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> u v r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1"><span class="command">lemma</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_derives<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> derives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_def is_derivation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_leftderives<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℒ<span class="hidden">⇩</span><sub>P</sub>_derives ℒ<span class="hidden">⇩</span><sub>P</sub>_is_word derives_implies_leftderives_gen<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="main">[]</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">a</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> <span class="free">b</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">c</span> <span class="main">∧</span> is_prefix <span class="free">a</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons is_prefix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_cancel<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">c</span><span class="main">)</span> <span class="main">=</span> is_prefix <span class="free">b</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc is_prefix_def same_append_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_chars<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> is_prefix <span class="main">(</span>chars <span class="free">a</span><span class="main">)</span> <span class="main">(</span>chars <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="bound">c</span> <span class="main">∧</span> is_prefix <span class="skolem">a</span> <span class="bound">c</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">c</span> <span class="main">∧</span> is_prefix <span class="skolem">a</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> c Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_length<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> length <span class="free">a</span> <span class="main">≤</span> length <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_take<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="main">(</span>take <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> doc_tokens_length<span class="main">:</span> <span class="quoted"><span class="quoted">"doc_tokens <span class="free">p</span> <span class="main">⟹</span> length <span class="main">(</span>chars <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> doc_tokens_def is_prefix_length<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">count_terminals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_terminals</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_terminals</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>is_terminal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="free">count_terminals</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">count_terminals</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_terminals_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"count_terminals <span class="free">p</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> count_terminals_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"count_terminals <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> count_terminals <span class="free">a</span> <span class="main">+</span> count_terminals <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_count_terminals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"count_terminals <span class="free">b</span> <span class="main">=</span> count_terminals <span class="free">a</span> <span class="main">+</span> count_terminals <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span><span class="main">.</span> splits_at <span class="free">a</span> <span class="free">i</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D splits_at_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">a</span> <span class="free">i</span> <span class="skolem">α</span> <span class="skolem">N</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> D split <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_nonterminal<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">α</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> split splits_at_combine<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> D split <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">α</span> <span class="main">@</span> <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> splits_at_combine_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a b<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_terminal_nonterminal<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_count_terminals_leq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"count_terminals <span class="free">a</span> <span class="main">≤</span> count_terminals <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_count_terminals assms le_less_linear not_add_less1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_count_terminals_leq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">E</span> <span class="free">b</span> <span class="main">⟹</span> count_terminals <span class="free">a</span> <span class="main">≤</span> count_terminals <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">E</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> Derives1 <span class="skolem">a</span> <span class="bound">i</span> <span class="bound">r</span> <span class="bound">x</span> <span class="main">∧</span> Derivation <span class="bound">x</span> <span class="skolem">E</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derivation.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> axb<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">r</span> <span class="skolem">x</span> <span class="main">∧</span> Derivation <span class="skolem">x</span> <span class="skolem">E</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> axb <span class="keyword1"><span class="command">have</span></span> ax<span class="main">:</span> <span class="quoted"><span class="quoted">"count_terminals <span class="skolem">a</span> <span class="main">≤</span> count_terminals <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1_count_terminals_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> axb <span class="keyword1"><span class="command">have</span></span> xb<span class="main">:</span> <span class="quoted"><span class="quoted">"count_terminals <span class="skolem">x</span> <span class="main">≤</span> count_terminals <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ax xb <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derives_count_terminals_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> count_terminals <span class="free">a</span> <span class="main">≤</span> count_terminals <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Derivation_count_terminals_leq derives_implies_Derivation <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> is_word_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_terminal <span class="free">x</span> <span class="main">∧</span> is_word <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_word_def<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> count_terminals_of_word<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">w</span> <span class="main">⟹</span> count_terminals <span class="free">w</span> <span class="main">=</span> length <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_terminals<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span> <span class="main">=</span> length <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminals_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> path_length_is_upper_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derives<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">u</span><span class="main">)</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">α</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> counts<span class="main">:</span> <span class="quoted"><span class="quoted">"count_terminals <span class="free">α</span> <span class="main">≤</span> count_terminals <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> derives derives_count_terminals_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> len1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">α</span> <span class="main">=</span> count_terminals <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α count_terminals_of_word<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span> <span class="main">=</span> count_terminals <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_terminals_of_word is_word_terminals p<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> counts len1 len2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>   
 
<span class="keyword1"><span class="command">lemma</span></span> is_word_Derives1_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">a</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> length <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> derives1 <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">a</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1_nonterminal splits_at_def splits_at_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">⟹</span> is_terminal <span class="main">(</span><span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">a</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_word_is_terminal nth_append<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t n is_terminal_nonterminal less_le_not_le nat_le_linear<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>   
    
<span class="keyword1"><span class="command">lemma</span></span> is_word_Derivation_derivation_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">a</span><span class="main">)</span> <span class="free">D</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="main">(</span>length <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> D Derivation_leftmost derivation_ge_empty leftmost_Derivation leftmost_append w<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derives_word_is_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derives<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">a</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">w</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derivation_take append_eq_conv_conj derives derives_implies_Derivation 
    is_prefix_take is_word_Derivation_derivation_ge w<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> terminals_take<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"terminals <span class="main">(</span>take <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_map terminals_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> terminals_drop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"terminals <span class="main">(</span>drop <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">n</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_map terminals_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> take_prefix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> take <span class="main">(</span>length <span class="free">a</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj is_prefix_unsplit<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> Derives1_drop_prefixword<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wa_b<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">a</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">w</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wa_b is_word_Derives1_index w <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">w</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj i is_prefix_take le_Derives1_take wa_b<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">w</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_unsplit<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Derives1_skip_prefix<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> wa_b<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derives1_drop_prefixword<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wa_b<span class="main">:</span> <span class="quoted"><span class="quoted">"derives1 <span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">a</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derives1 <span class="free">a</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_drop_prefixword Derives1_implies_derives1 derives1_implies_Derives1 w wa_b<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derives1_is_word_is_prefix_drop<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w_a<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">w</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"derives1 <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derives1 <span class="main">(</span>drop <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ab append_take_drop_id derives1_drop_prefixword take_prefix w w_a<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> derives_drop_prefixword_helper<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"derives <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> is_word <span class="free">w</span> <span class="main">⟹</span> is_prefix <span class="free">w</span> <span class="free">a</span> <span class="main">⟹</span> derives <span class="main">(</span>drop <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> derives_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> is_prefix_w_y<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">w</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Step.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Step.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Step.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> derives_word_is_prefix is_prefix_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Step.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Step.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Step.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Step.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> derives1_implies_derives 
        derives1_is_word_is_prefix_drop derives_trans<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derive_drop_prefixword<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_word <span class="free">w</span> <span class="main">⟹</span> derives <span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">a</span><span class="main">)</span> <span class="free">b</span> <span class="main">⟹</span> derives <span class="free">a</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj derives_drop_prefixword_helper is_prefix_take<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thmD2'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"is_terminal <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"doc_tokens <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> pvalid <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> next_symbol <span class="bound">x</span> <span class="main">=</span> Some <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> wellformed_p<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doc_tokens_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ω</span><span class="main">.</span> leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="bound">ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_leftderives pX <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">D</span><span class="main">.</span> LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="bound">D</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ω</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> leftderives_implies_LeftDerivation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">D</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="bound">k</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">(</span><span class="bound">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> derives <span class="bound">a</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>length <span class="skolem">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"terminals <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">ω</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> minimal_witness<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minimal <span class="skolem">K</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Minimal<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span>
       aXb<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="skolem">K</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       a<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="skolem">a</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> KD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> length <span class="skolem">D</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> length <span class="skolem">D</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">K</span> <span class="skolem">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> True aXb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔖</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil_is_append_conv append_self_conv2 butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
              butlast_append hd_append2 list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_Cons_self2<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> X is_nonterminal_startsymbol is_terminal_nonterminal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">K</span> <span class="skolem">D</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">D</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Minimal.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> One_nat_def Suc_less_eq Suc_pred hd_drop_conv_nth 
          le_imp_less_Suc take_hd_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">δ</span><span class="main">.</span> LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span> <span class="bound">δ</span> <span class="main">∧</span> LeftDerivation <span class="bound">δ</span> <span class="main">[</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="skolem">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivation_append aXb<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      δ1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">δ</span>"</span></span>  
      <span class="keyword2"><span class="keyword">and</span></span> δ2<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">δ</span> <span class="main">[</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="skolem">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="skolem">b</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> δ2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> LeftDerives1 <span class="skolem">δ</span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">(</span><span class="skolem">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> LeftDerives1_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">δ</span> <span class="skolem">i</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Derives1_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">δ</span> <span class="skolem">i</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="skolem">b</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerives1_implies_Derives1<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span> <span class="main">.</span> splits_at <span class="skolem">δ</span> <span class="skolem">i</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splits_at_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="skolem">δ</span> <span class="skolem">i</span> <span class="skolem">α</span> <span class="skolem">N</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> is_word_α<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="skolem">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerives1_δ LeftDerives1_splits_at_is_word split_δ<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?P</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> KD Minimal<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> δ1 <span class="keyword1"><span class="command">have</span></span> min_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="skolem">δ</span> <span class="main">=</span> <span class="bound">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="bound">b</span> <span class="main">∧</span> derives <span class="bound">a</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Derives1_δ split_δ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">α</span> <span class="main">@</span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">@</span> <span class="skolem">β</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="bound">u</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Derives1_X_is_part_of_rule<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suffix <span class="skolem">γ</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> min_δ Suffix<span class="main">(</span>1<span class="main">)</span> a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prefix <span class="skolem">γ</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"derives <span class="skolem">γ</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_implies_derives1 Prefix<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> a 
              derives1_implies_derives derives_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> min_δ Prefix<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> uXv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">β</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">α</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="var">?l</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Item <span class="skolem">r</span> <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>charslength <span class="var">?q</span><span class="main">)</span> <span class="main">(</span>charslength <span class="free">p</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_rhs <span class="var">?x</span> <span class="main">=</span> snd <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_rhs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> item_rhs_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_rhs <span class="var">?x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uXv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="var">?x</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_item_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_δ Derives1_rule<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_prefix_length<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_prefix_chars<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doc_tokens_length<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> item_rhs_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> item_rhs_x <span class="keyword1"><span class="command">have</span></span> next_symbol_x<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="var">?x</span> <span class="main">=</span> Some <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_symbol_def is_complete_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len_α_p<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">α</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> path_length_is_upper_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_p<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_word_α<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> a uXv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> item_nonterminal_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_nonterminal <span class="var">?x</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_nonterminal_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Derives1_δ Derives1_nonterminal split_δ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> take_terminals<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">α</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> take_prefix<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> a derives_word_is_prefix is_word_α uXv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> item_α_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_α <span class="var">?x</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> item_α_def item_rhs_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">from</span></span> wellformed_x next_symbol_x len_α_p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_def wellformed_p<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> item_nonterminal_x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_terminals<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">β</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivation_implies_leftderives δ1 is_leftderivation_def split_δ splits_at_combine 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> item_α_x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a derive_drop_prefixword is_word_α uXv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    
        
<span class="keyword1"><span class="command">lemma</span></span> admissible_wellformed_tokens<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="free">p</span> <span class="main">⟹</span> wellformed_tokens <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admissible_def ℒ<span class="hidden">⇩</span><sub>P</sub>_wellformed_tokens<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chars_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"chars <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>chars <span class="free">a</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>chars <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chars_of_token_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"chars_of_token <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chars_of_token_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒳_is_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> 𝒳 <span class="free">k</span> <span class="main">⟹</span> is_prefix <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">k</span> <span class="free">Doc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒳_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_append<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="free">D</span> <span class="main">=</span> <span class="main">(</span>is_prefix <span class="free">a</span> <span class="free">D</span> <span class="main">∧</span> is_prefix <span class="free">b</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">a</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc is_prefix_cancel is_prefix_def is_prefix_unsplit<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> 𝔓_are_doc_tokens<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓 <span class="main">⟹</span> doc_tokens <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝔓_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doc_tokens_def wellformed_tokens_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Induct <span class="skolem">p</span> <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Induct<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> limit_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Init <span class="skolem">p</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Induct<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Init<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Iterate <span class="skolem">p</span> <span class="skolem">Y</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> Y_is_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">Y</span> <span class="main">⟹</span> is_prefix <span class="main">(</span>chars <span class="bound">p</span><span class="main">)</span> <span class="free">Doc</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Iterate<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doc_tokens_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒴 <span class="main">(</span>𝒵 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">⊆</span> 𝒳 <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒵.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 𝒵_subset_𝒳<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Append <span class="main">(</span>𝒴 <span class="main">(</span>𝒵 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">Y</span> <span class="main">⊆</span> Append <span class="main">(</span>𝒳 <span class="skolem">k</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Append_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> Append <span class="main">(</span>𝒳 <span class="skolem">k</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">Y</span> <span class="main">⟹</span> doc_tokens <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Append_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Iterate<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doc_tokens_def admissible_wellformed_tokens 
             is_prefix_append Y_is_prefix<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒳_is_prefix snd_conv<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"1"</span> Iterate<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">theorem</span></span> thmD2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"is_terminal <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> pvalid <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> next_symbol <span class="bound">x</span> <span class="main">=</span> Some <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> X 𝔓_are_doc_tokens p pX thmD2'<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD4">
<div class="head">
<h1>Theory TheoremD4</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD4
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD2.html">TheoremD2</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒳_are_terminals<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> 𝒳 <span class="free">k</span> <span class="main">⟹</span> is_terminal <span class="main">(</span>terminal_of_token <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒳_def is_terminal_def terminal_of_token_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> terminals_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"terminals <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>terminals <span class="free">a</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>terminals <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminals_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> terminals_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"terminals <span class="main">[</span><span class="free">u</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span>terminal_of_token <span class="free">u</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminals_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> terminal_of_token_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"terminal_of_token <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminal_of_token_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pvalid_item_end<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span> <span class="main">⟹</span> item_end <span class="free">x</span> <span class="main">=</span> charslength <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pvalid_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒲_elem_in_TokensAt<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> 𝔓"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u_in_𝒲<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> 𝒲 <span class="free">P</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> TokensAt <span class="free">k</span> <span class="main">(</span>Gen <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> 𝒳 <span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">∈</span>by_length <span class="free">k</span> <span class="free">P</span><span class="main">.</span> admissible <span class="main">(</span><span class="bound">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u_in_𝒲
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒲_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> by_length <span class="free">k</span> <span class="free">P</span> <span class="main">∧</span> admissible <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength_p<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> by_length.simps charslength.simps mem_Collect_eq<span class="main">)</span>   
  <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> 𝒳 <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> p_in_𝔓<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝔓"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> P by_length.simps mem_Collect_eq subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> doc_tokens_p<span class="main">:</span> <span class="quoted"><span class="quoted">"doc_tokens <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝔓_are_doc_tokens<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"terminal_of_token <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> X_is_terminal<span class="main">:</span> <span class="quoted"><span class="quoted">"is_terminal <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒳_are_terminals u<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminals <span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span>terminal_of_token <span class="free">u</span><span class="main">]</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admissible_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> thmD2<span class="main">[</span><span class="operator">OF</span> X_is_terminal p_in_𝔓 this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    x<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">∧</span> next_symbol <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>terminal_of_token <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> x_is_in_Gen_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Gen <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Gen_def by_length.simps mem_Collect_eq p x<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> u_split<span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">=</span> terminal_of_token <span class="free">u</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">=</span> chars_of_token <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chars_of_token_simp fst_conv terminal_of_token_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TokensAt_def bin_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_is_in_Gen_P x X_is_terminal<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> x charslength_p pvalid_item_end <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒳_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_derivation_is_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="free">s</span> <span class="main">⟹</span> is_sentence <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Derives1_sentence2 derives1_implies_Derives1 
    derives_induct is_derivation_def is_nonterminal_startsymbol is_sentence_cons 
    is_sentence_def is_symbol_def list.pred_inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> is_sentence_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">N</span><span class="main">#</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_symbol <span class="free">N</span> <span class="main">∧</span> is_sentence <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sentence_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_derivation_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uNv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Nα<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">α</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> uNv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_derivation_is_sentence<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> is_sentence_concat is_sentence_cons 
  <span class="keyword1"><span class="command">have</span></span> u_is_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_is_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Nα <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"derives1 <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">α</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derives1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">N</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_is_sentence v_is_sentence<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> derives1_implies_derives derives_trans is_derivation_def uNv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> is_derivation_derives<span class="main">:</span>
  <span class="quoted"><span class="quoted">"derives <span class="free">α</span> <span class="free">β</span> <span class="main">⟹</span> is_derivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">α</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> is_derivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">β</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> derives_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Step <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Step <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"derives1 <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc derives1_def is_derivation_step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> item_rhs_split<span class="main">:</span> <span class="quoted"><span class="quoted">"item_rhs <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id item_α_def item_β_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pvalid_is_derivation_terminals_item_β<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pvalid<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">δ</span><span class="main">.</span> is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span><span class="main">@</span><span class="bound">δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pvalid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="bound">γ</span><span class="main">.</span> is_derivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="bound">u</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="bound">γ</span><span class="main">)</span> <span class="main">∧</span>
    derives <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="bound">u</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_def<span class="main">)</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">u</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span> <span class="main">∧</span>
    derives <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">u</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> x_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>item_nonterminal <span class="free">x</span><span class="main">,</span> item_rhs <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LocalLexing.pvalid_def LocalLexing_axioms assms case_prodE item_nonterminal_def item_rhs_def prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snd_conv validRules wellformed_item_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 x_rule is_derivation_step <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>take <span class="skolem">u</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>item_rhs <span class="free">x</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>take <span class="skolem">u</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_rhs_split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>take <span class="skolem">u</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>take <span class="skolem">u</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="skolem">u</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 is_derivation_derives terminals_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc append_take_drop_id<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_symbol_not_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span>is_complete <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> next_symbol_def option.discI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_symbol_starts_item_β<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> next_symbol<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">δ</span><span class="main">.</span> item_β <span class="free">x</span> <span class="main">=</span> <span class="free">t</span><span class="main">#</span><span class="bound">δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> next_symbol <span class="keyword1"><span class="command">have</span></span> nc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>is_complete <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> next_symbol_not_complete <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> next_symbol <span class="keyword1"><span class="command">have</span></span> atdot<span class="main">:</span> <span class="quoted"><span class="quoted">"item_rhs <span class="free">x</span> <span class="main">!</span> item_dot <span class="free">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_symbol_def nc<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nc <span class="keyword1"><span class="command">have</span></span> inrange<span class="main">:</span> <span class="quoted"><span class="quoted">"item_dot <span class="free">x</span> <span class="main">&lt;</span> length <span class="main">(</span>item_rhs <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_complete_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inrange atdot <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_β_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1"><span class="command">lemma</span></span> pvalid_prefixlang<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pvalid<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_terminal<span class="main">:</span> <span class="quoted"><span class="quoted">"is_terminal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> next_symbol<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">δ</span><span class="main">.</span> item_β <span class="free">x</span> <span class="main">=</span> <span class="free">t</span><span class="main">#</span><span class="bound">δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> next_symbol next_symbol_starts_item_β pvalid pvalid_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="main">:</span><span class="quoted"><span class="quoted">"item_β <span class="free">x</span> <span class="main">=</span> <span class="free">t</span><span class="main">#</span><span class="skolem">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ω</span><span class="main">.</span> is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span><span class="main">@</span><span class="bound">ω</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pvalid pvalid_is_derivation_terminals_item_β<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span><span class="main">@</span><span class="skolem">ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="skolem">δ</span><span class="main">)</span><span class="main">@</span><span class="skolem">ω</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> δ<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="skolem">δ</span><span class="main">@</span><span class="skolem">ω</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CFG.ℒ<span class="hidden">⇩</span><sub>P</sub>_def CFG_axioms  
      append_Nil2 is_terminal is_word_append is_word_cons 
      is_word_terminals mem_Collect_eq pvalid pvalid_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> TokensAt_elem_in_𝒲<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> 𝔓"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u_in_Tokens_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> TokensAt <span class="free">k</span> <span class="main">(</span>Gen <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> 𝒲 <span class="free">P</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span> <span class="bound">s</span> <span class="bound">x</span> <span class="bound">l</span><span class="main">.</span>
         <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
         <span class="bound">x</span> <span class="main">∈</span> bin <span class="main">(</span>Gen <span class="free">P</span><span class="main">)</span> <span class="free">k</span> <span class="main">∧</span>
         next_symbol <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> is_terminal <span class="bound">t</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free">Lex</span> <span class="bound">t</span> <span class="free">Doc</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">=</span> take <span class="bound">l</span> <span class="main">(</span>drop <span class="free">k</span> <span class="free">Doc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> u_in_Tokens_at <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TokensAt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span>
         <span class="skolem">x</span> <span class="main">∈</span> bin <span class="main">(</span>Gen <span class="free">P</span><span class="main">)</span> <span class="free">k</span> <span class="main">∧</span>
         next_symbol <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">t</span> <span class="main">∧</span> is_terminal <span class="skolem">t</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">∈</span> <span class="free">Lex</span> <span class="skolem">t</span> <span class="free">Doc</span> <span class="free">k</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">=</span> take <span class="skolem">l</span> <span class="main">(</span>drop <span class="free">k</span> <span class="free">Doc</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> terminal_of_token <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> terminal_of_token_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> chars_of_token <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chars_of_token_simp<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> item_end_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bin_def mem_Collect_eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> pvalid <span class="bound">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bin_def Gen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pvalid<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="skolem">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> p_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>chars <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> charslength.simps item_end_x pvalid pvalid_item_end<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> u_in_𝒳<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> 𝒳 <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒳_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_terminal_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒲_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_in_𝒳<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p p_len<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admissible_def t<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pvalid_prefixlang<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> thmD4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> 𝔓"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒲 <span class="free">P</span> <span class="free">k</span> <span class="main">=</span> TokensAt <span class="free">k</span> <span class="main">(</span>Gen <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> 𝒲_elem_in_TokensAt TokensAt_elem_in_𝒲
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Collect_cong Collect_mem_eq assms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD5">
<div class="head">
<h1>Theory TheoremD5</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD5
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD4.html">TheoremD4</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Scan_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="main">{}</span> <span class="free">k</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Scan_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> π_no_tokens<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="main">{}</span> <span class="free">I</span> <span class="main">=</span>  limit <span class="main">(</span><span class="main">λ</span> <span class="bound">I</span><span class="main">.</span> Complete <span class="free">k</span> <span class="main">(</span>Predict <span class="free">k</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def Scan_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bin_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bin_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Gen_implies_pvalid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Gen <span class="free">P</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> pvalid <span class="bound">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gen_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_init_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span> <span class="main">⟹</span> wellformed_item <span class="main">(</span>init_item <span class="free">r</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_item_def wellformed_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_item_origin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_origin <span class="main">(</span>init_item <span class="free">r</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_origin_def init_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_item_end<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="main">(</span>init_item <span class="free">r</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_end_def init_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_item_nonterminal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_nonterminal <span class="main">(</span>init_item <span class="free">r</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_item_def item_nonterminal_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_item_α<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_α <span class="main">(</span>init_item <span class="free">r</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_item_def item_α_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Predict_elem_in_Gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I_in_Gen_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> Gen <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_Predict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Predict <span class="free">k</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Gen <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">r</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> init_item <span class="bound">r</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="free">k</span> <span class="main">∧</span> next_symbol <span class="bound">y</span> <span class="main">=</span> Some<span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_in_Predict <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Predict_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> I_in_Gen_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> ry<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> init_item <span class="skolem">r</span> <span class="free">k</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="free">k</span> <span class="main">∧</span> 
      next_symbol <span class="skolem">y</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> pvalid <span class="bound">p</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Gen_implies_pvalid I_in_Gen_P bin_elem subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> pvalid <span class="skolem">p</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> wellformed_p<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ry k<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ry <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">y</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bin_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> charslength_p<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> item_end_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="free">x</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ry<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pvalid_x<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="skolem">p</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_p<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_x<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> charslength_p ry<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons next_symbol_starts_item_β p pvalid_def 
        pvalid_is_derivation_terminals_item_β ry<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Gen_def mem_Collect_eq p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Predict_subset_Gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> Gen <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Predict <span class="free">k</span> <span class="free">I</span> <span class="main">⊆</span> Gen <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Predict_elem_in_Gen assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_superfluous_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">a</span><span class="main">!</span><span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tokens_nth_in_𝒵<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓 <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="free">p</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="bound">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝔓_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Induct <span class="skolem">p</span> <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> limit <span class="main">(</span>Append <span class="main">(</span>𝒵 <span class="skolem">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> limit_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Init <span class="skolem">p</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Induct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Iterate <span class="skolem">p</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Iterate<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">Y</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="bound">q</span><span class="main">@</span><span class="main">[</span><span class="bound">t</span><span class="main">]</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">∈</span> by_length <span class="skolem">k</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> 𝒵 <span class="skolem">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span> <span class="main">∧</span> 
      admissible <span class="main">(</span><span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="bound">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Append_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Iterate<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        qt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">∈</span> by_length <span class="skolem">k</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">∈</span> 𝒵 <span class="skolem">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span> <span class="main">∧</span> admissible <span class="main">(</span><span class="skolem">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q_in_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> qt <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> charslength <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> qt <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> 𝒵 <span class="skolem">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qt<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">q</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">=</span> length <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>length <span class="main">(</span>chars <span class="main">(</span>take <span class="skolem">i</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">from</span></span> Iterate<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> q_in_Y<span class="main">]</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> k t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> path_append_token<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pt<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="free">p</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 𝒫.simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> limit_elem<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> p t pt k <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Append_def funpower.simps<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indexlt_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">indexlt_rel</span> <span class="main">=</span> less_than <span class="keyword1">&lt;*lex*&gt;</span> less_than"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indexlt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">indexlt</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> indexlt_rel<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> indexlt_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"indexlt <span class="free">k'</span> <span class="free">u'</span> <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∨</span> <span class="main">(</span><span class="free">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">u'</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexlt_def indexlt_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_indexlt_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"wf indexlt_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> indexlt_rel_def pair_less_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒫_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Induct<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span> <span class="bound">k</span> <span class="bound">u</span> <span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">p'</span> <span class="bound">k'</span> <span class="bound">u'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> 𝒫 <span class="bound">k'</span> <span class="bound">u'</span> <span class="main">⟹</span> indexlt <span class="bound">k'</span> <span class="bound">u'</span> <span class="bound">k</span> <span class="bound">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p'</span> <span class="bound">k'</span> <span class="bound">u'</span><span class="main">)</span> 
                     <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∈</span> 𝒫 <span class="bound">k</span> <span class="bound">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p</span> <span class="bound">k</span> <span class="bound">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"indexlt_rel <span class="keyword1">&lt;*lex*&gt;</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> wf_R<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_indexlt_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> snd <span class="bound">a</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>snd <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">p</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_R<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">u</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexlt_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> induct<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_path_indices<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">note</span></span> u <span class="main">=</span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> p u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> nonempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> base_paths<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">k</span> <span class="main">=</span> Suc <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i natUnion_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> indexlt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"indexlt <span class="free">k''</span> <span class="free">u''</span> <span class="free">k'</span> <span class="free">u'</span> <span class="main">⟹</span> indexlt <span class="free">k'</span> <span class="free">u'</span> <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> indexlt <span class="free">k''</span> <span class="free">u''</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans indexlt_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_continuation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> tokens <span class="main">⇒</span> tokens <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_continuation</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> 𝒫 <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> charslength <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> admissible <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> 𝒵 <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> limit_Append_path_nonelem_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> limit <span class="main">(</span>Append <span class="free">T</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∉</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span>
  <span class="main">∃</span> <span class="bound">q</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">q</span><span class="main">@</span><span class="bound">ts</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">∧</span> charslength <span class="bound">q</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> admissible <span class="main">(</span><span class="bound">q</span><span class="main">@</span><span class="bound">ts</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="bound">ts</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>butlast <span class="bound">ts</span><span class="main">)</span><span class="main">.</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> limit_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Init <span class="skolem">p</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Iterate <span class="skolem">p</span> <span class="skolem">Y</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> Iterate<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True Iterate<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Append_def Iterate<span class="main">(</span>2<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="bound">q</span><span class="main">@</span><span class="main">[</span><span class="bound">t</span><span class="main">]</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">∈</span> by_length <span class="free">k</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> admissible <span class="main">(</span><span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="bound">t</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> qt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">∈</span> by_length <span class="free">k</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> admissible <span class="main">(</span><span class="skolem">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> qt <span class="keyword1"><span class="command">have</span></span> qlen<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">q</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="main">∉</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> qlen <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qt 1<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> q_in_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Iterate<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> q_in_Y 2<span class="main">]</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        q'ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q'</span> <span class="main">@</span> <span class="skolem">ts</span> <span class="main">∧</span> <span class="skolem">q'</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">∧</span> charslength <span class="skolem">q'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span><span class="main">)</span> <span class="main">∧</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set<span class="main">(</span>butlast <span class="skolem">ts</span><span class="main">)</span><span class="main">.</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> qlen <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">ts</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> set<span class="main">(</span><span class="skolem">ts</span><span class="main">)</span><span class="main">.</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">ts</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> qt q'ts empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> limit_Append_path_nonelem_split'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> limit <span class="main">(</span>Append <span class="main">(</span>𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∉</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span>
   <span class="main">∃</span> <span class="bound">q</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">q</span><span class="main">@</span><span class="bound">ts</span> <span class="main">∧</span> is_continuation <span class="free">k</span> <span class="free">u</span> <span class="bound">q</span> <span class="bound">ts</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> limit_Append_path_nonelem_split<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> final_step_of_path<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span> <span class="bound">ts</span> <span class="bound">k'</span> <span class="bound">u'</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">q</span><span class="main">@</span><span class="bound">ts</span> <span class="main">∧</span> indexlt <span class="bound">k'</span> <span class="bound">u'</span> <span class="free">k</span> <span class="free">u</span> 
  <span class="main">∧</span> is_continuation <span class="bound">k'</span> <span class="bound">u'</span> <span class="bound">q</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝒫_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Induct <span class="skolem">p</span> <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Induct<span class="main">(</span>2<span class="main">)</span> Induct<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ku_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty_path_indices <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> ku_0 <span class="keyword1"><span class="command">have</span></span> k_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">with</span></span> True Induct<span class="main">(</span>2<span class="main">)</span> base_paths <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u'</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> indexlt<span class="main">:</span> <span class="quoted"><span class="quoted">"indexlt <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">u'</span> <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexlt_simp k_0<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Induct<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> u' indexlt Induct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> indexlt indexlt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u'</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">=</span> Suc <span class="bound">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Suc <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Induct<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> p_limit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> limit <span class="main">(</span>Append <span class="main">(</span>𝒵 <span class="skolem">k</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒫.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> u' <span class="keyword1"><span class="command">have</span></span> indexlt<span class="main">:</span> <span class="quoted"><span class="quoted">"indexlt <span class="skolem">k</span> <span class="skolem">u'</span> <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexlt_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u'</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">∉</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">from</span></span> Induct<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1 indexlt Induct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> indexlt indexlt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">from</span></span> limit_Append_path_nonelem_split'<span class="main">[</span><span class="operator">OF</span> p_limit 2<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> indexlt u' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1"><span class="command">lemma</span></span> terminals_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"terminals <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminals_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_in_ℒ<span class="hidden">⇩</span><sub>P</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> ℒ<span class="hidden">⇩</span><sub>P</sub>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_def is_derivation_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">𝔖</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
     
<span class="keyword1"><span class="command">lemma</span></span> admissible_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admissible_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔓_are_admissible<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓 <span class="main">⟹</span> admissible <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝔓_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Induct <span class="skolem">p</span> <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Induct<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> limit_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Init <span class="skolem">p</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Induct<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Init<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Iterate <span class="skolem">p</span> <span class="skolem">Y</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒴 <span class="main">(</span>𝒵 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">⊆</span> 𝒳 <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒵.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 𝒵_subset_𝒳<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Append <span class="main">(</span>𝒴 <span class="main">(</span>𝒵 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">Y</span> <span class="main">⊆</span> Append <span class="main">(</span>𝒳 <span class="skolem">k</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Append_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> Append <span class="main">(</span>𝒳 <span class="skolem">k</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">Y</span> <span class="main">⟹</span> admissible <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Append_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Iterate<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> Iterate<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_empty_is_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">q</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  is_prefix_cons neq_Nil_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_𝒫 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∨</span> <span class="main">(</span><span class="free">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">u'</span> <span class="main">≤</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒫 <span class="free">k'</span> <span class="free">u'</span> <span class="main">⊆</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> leq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒫 <span class="free">k'</span> <span class="free">u'</span> <span class="main">⊆</span> 𝒬 <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> subset_𝒫𝒬k<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒬 <span class="free">k'</span> <span class="main">⊆</span> 𝒬 <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> subset_𝒬<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">from</span></span> subset_𝒬𝒫Suc<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> 1 <span class="keyword1"><span class="command">have</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒬 <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊆</span> 𝒫 <span class="free">k</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> s4<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒫 <span class="free">k</span> <span class="main">0</span> <span class="main">⊆</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> subset_𝒫k<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> s1 s2 s3 s4 subset_trans <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subset_𝒫k<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> empty_path_is_elem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> 𝒫 <span class="main">0</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le0 not_gr0 subsetCE subset_𝒫<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_of_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">p</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">p</span> <span class="free">a</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="bound">b'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> is_prefix <span class="bound">b'</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span><span class="main">@</span><span class="bound">b'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_def<span class="main">)</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 append_eq_append_conv2 assms is_prefix_cancel is_prefix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_is_continuation<span class="main">:</span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="free">u</span> <span class="free">p</span> <span class="free">ts</span> <span class="main">⟹</span> is_prefix <span class="free">ts'</span> <span class="free">ts</span> <span class="main">⟹</span> 
  is_continuation <span class="free">k</span> <span class="free">u</span> <span class="free">p</span> <span class="free">ts'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def is_prefix_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℒ<span class="hidden">⇩</span><sub>P</sub>_split admissible_def append_assoc terminals_append<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> in_set_butlast_appendI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1"><span class="command">lemma</span></span> charslength_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>charslength <span class="free">ts</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> is_continuation_in_𝒫<span class="main">:</span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="free">u</span> <span class="free">p</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">@</span><span class="free">ts</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> subset_𝒫Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="free">u</span> <span class="free">p</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 is_prefix_cancel is_prefix_empty prefix_is_continuation<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> induct <span class="main">=</span> snoc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">@</span><span class="skolem">ts</span> <span class="main">∈</span> limit <span class="main">(</span>Append <span class="main">(</span>𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> is_cont <span class="main">=</span> snoc<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> admissible<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="free">p</span><span class="main">@</span><span class="skolem">ts</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> is_cont <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> is_cont <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="skolem">ts</span><span class="main">.</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">ts</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> charslength_0<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> is_cont <span class="keyword1"><span class="command">have</span></span> plen<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 𝒫.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> limit_step_pointwise<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pts<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_Append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Append_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admissible<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> charslength_ts <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> plen <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> indexlt_subset_𝒫<span class="main">:</span> <span class="quoted"><span class="quoted">"indexlt <span class="free">k'</span> <span class="free">u'</span> <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> 𝒫 <span class="free">k'</span> <span class="main">(</span>Suc <span class="free">u'</span><span class="main">)</span> <span class="main">⊆</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> subset_𝒫<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexlt_simp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_are_paths<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> is_prefix <span class="free">x</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝒫_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Induct <span class="skolem">p</span> <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Induct.prems prefix_of_empty_is_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> final_step_of_path<span class="main">[</span><span class="operator">OF</span> Induct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> False<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">@</span><span class="skolem">ts</span> <span class="main">∧</span> indexlt <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">k</span> <span class="skolem">u</span> <span class="main">∧</span> is_continuation <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">q</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒫 <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="main">⊆</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indexlt_simp less_or_eq_imp_le step subset_𝒫<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">x</span> <span class="skolem">q</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ts'</span><span class="main">.</span> <span class="bound">ts'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> is_prefix <span class="bound">ts'</span> <span class="skolem">ts</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">@</span><span class="bound">ts'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> is_prefix_of_append<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Induct<span class="main">(</span>3<span class="main">)</span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒫 <span class="skolem">k'</span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 Induct step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">ts'</span> <span class="skolem">ts</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">@</span><span class="skolem">ts'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">q</span> <span class="skolem">ts'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step prefix_is_continuation ts' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">with</span></span> ts' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒫 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ts'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> is_continuation_in_𝒫<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> subset <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> indexlt_subset_𝒫 step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> empty_or_last_of_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q'</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">p</span> <span class="main">@</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ts'</span><span class="main">.</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">@</span> <span class="bound">ts'</span> <span class="main">∧</span> <span class="bound">ts'</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">=</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_append last_appendR snoc_eq_iff_butlast<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_butlast<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">q</span> <span class="main">(</span>butlast <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> is_prefix <span class="free">q</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> butlast_conv_take is_prefix_append is_prefix_def is_prefix_take<span class="main">)</span>
        
<span class="keyword1"><span class="command">lemma</span></span> last_step_of_path<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q'</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">⟹</span>
   <span class="main">∃</span> <span class="bound">k'</span> <span class="bound">u'</span><span class="main">.</span> indexlt <span class="bound">k'</span> <span class="bound">u'</span> <span class="free">k</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">∈</span> 𝒫 <span class="bound">k'</span> <span class="main">(</span>Suc <span class="bound">u'</span><span class="main">)</span> <span class="main">∧</span> charslength <span class="free">q'</span> <span class="main">=</span> <span class="bound">k'</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">∈</span> 𝒵 <span class="bound">k'</span> <span class="main">(</span>Suc <span class="bound">u'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝒫_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Induct <span class="skolem">q</span> <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="bound">ts</span> <span class="bound">k'</span> <span class="bound">u'</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> <span class="bound">p</span><span class="main">@</span><span class="bound">ts</span> <span class="main">∧</span> indexlt <span class="bound">k'</span> <span class="bound">u'</span> <span class="skolem">k</span> <span class="skolem">u</span> <span class="main">∧</span> is_continuation <span class="bound">k'</span> <span class="bound">u'</span> <span class="bound">p</span> <span class="bound">ts</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> final_step_of_path<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Induct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Induct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> pts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">@</span><span class="skolem">ts</span> <span class="main">∧</span> indexlt <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">k</span> <span class="skolem">u</span> <span class="main">∧</span> is_continuation <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">p</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> indexlt<span class="main">:</span> <span class="quoted"><span class="quoted">"indexlt <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> pts <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ts'</span><span class="main">.</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="bound">ts'</span> <span class="main">∧</span> <span class="bound">ts'</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_or_last_of_suffix Induct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">with</span></span> pts <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="skolem">k'</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Induct<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this indexlt Induct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> indexlt indexlt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">ts'</span> <span class="main">∧</span> <span class="skolem">ts'</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">ts'</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">p</span> <span class="skolem">ts'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prefix_is_continuation pts<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">ts'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> charslength_0 is_continuation_def pts ts' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q'len<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">q'</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_continuation_def pts ts' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ts' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> pts <span class="keyword1"><span class="command">have</span></span> t_in_𝒵<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> 𝒵 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_continuation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">have</span></span> q_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pts is_continuation_in_𝒫 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> indexlt q'len t_in_𝒵 q_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
      
<span class="keyword1"><span class="command">lemma</span></span> charslength_of_butlast_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="free">q</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">⟹</span> charslength <span class="free">q</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> last_step_of_path LocalLexing_axioms indexlt_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> charslength_of_butlast<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="free">q</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">⟹</span> charslength <span class="free">q</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indexlt_simp last_step_of_path eq_imp_le less_imp_le_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> last_token_of_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q'</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"charslength <span class="free">q'</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k'</span> <span class="bound">u'</span><span class="main">.</span> indexlt <span class="bound">k'</span> <span class="bound">u'</span> <span class="free">k</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">∈</span> 𝒫 <span class="bound">k'</span> <span class="main">(</span>Suc <span class="bound">u'</span><span class="main">)</span> <span class="main">∧</span> charslength <span class="free">q'</span> <span class="main">=</span> <span class="bound">k'</span> <span class="main">∧</span> 
    <span class="free">t</span> <span class="main">∈</span> 𝒵 <span class="bound">k'</span> <span class="main">(</span>Suc <span class="bound">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> last_step_of_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> th<span class="main">:</span> <span class="quoted"><span class="quoted">"indexlt <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="free">k</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">∈</span> 𝒫 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span> <span class="main">∧</span> charslength <span class="free">q'</span> <span class="main">=</span> <span class="skolem">k'</span> <span class="main">∧</span> 
    <span class="free">t</span> <span class="main">∈</span> 𝒵 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> th <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> 𝒵 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">u'</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> indexlt_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> 𝒵_subset_Suc k' linorder_neqE_nat not_less_eq 
      subsetCE subset_fSuc_strict<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> final_step_of_path'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∉</span> 𝒫 <span class="free">k</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">∃</span> <span class="bound">q</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">u</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">q</span><span class="main">@</span><span class="bound">ts</span> <span class="main">∧</span> is_continuation <span class="free">k</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">q</span> <span class="bound">ts</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_1 𝒫.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_0_eq_0 limit_Append_path_nonelem_split' not_gr0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_continuation_continue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="free">u</span> <span class="free">q</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"charslength <span class="free">ts</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="free">q</span> <span class="main">@</span> <span class="free">ts</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="free">u</span> <span class="free">q</span> <span class="main">(</span><span class="free">ts</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def charslength_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* In an older version of local lexing, compatibility was an assumption we had to make, 
   but now it is a theorem *)</span>

<span class="keyword1"><span class="command">theorem</span></span> compatibility_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> q_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_charslength<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> q_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q'</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> q'len<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="free">q'</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> admissible<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="free">q'</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> charslength_of_butlast_0 q_in_dom q_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
      <span class="keyword1"><span class="command">with</span></span> q'len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> t_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> last_token_of_path q'len q_in_dom q_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">∉</span> 𝒫 <span class="free">k</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">with</span></span> t_dom p_charslength admissible u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> u <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred is_continuation_in_𝒫<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">from</span></span> final_step_of_path'<span class="main">[</span><span class="operator">OF</span> p_in_dom 2<span class="main">]</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">@</span> <span class="skolem">ts</span> <span class="main">∧</span> is_continuation <span class="free">k</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">ts</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> p' p_charslength is_continuation_def <span class="keyword1"><span class="command">have</span></span> charslength_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">ts</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="main">(</span><span class="free">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">(</span><span class="skolem">ts</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> is_continuation_continue<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> p' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> charslength_ts <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> u' t_dom<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> admissible p' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> is_continuation_in_𝒫<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> p' u'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_admissible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"admissible <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"admissible <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_def admissible_def ℒ<span class="hidden">⇩</span><sub>P</sub>_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> butlast_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">q</span> <span class="main">⟹</span> butlast <span class="free">q</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">q</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">n</span> <span class="main">(</span>butlast <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id take_butlast<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_𝒫_charslength<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>charslength <span class="free">p</span><span class="main">)</span> <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">≥</span> <span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True le_neq_implies_less p_dom subsetCE subset_𝒫<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> final_step_of_path<span class="main">[</span><span class="operator">OF</span> p_dom 2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="skolem">ts</span> <span class="main">∧</span> indexlt <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="free">k</span> <span class="free">u</span> <span class="main">∧</span> is_continuation <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">q</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_continuation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
        <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">q</span> <span class="main">≤</span> charslength <span class="free">p</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>       
        <span class="keyword1"><span class="command">with</span></span> k' <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> charslength <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_continuation_in_𝒫 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">with</span></span> k' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>charslength <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_neq_implies_less subsetCE subset_𝒫<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> general_compatibility<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> charslength <span class="free">p</span> <span class="main">=</span> charslength <span class="main">(</span>take <span class="free">n</span> <span class="free">q</span><span class="main">)</span> 
    <span class="main">⟹</span> charslength <span class="free">p</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> admissible <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">@</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">q</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> length <span class="skolem">q</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> length <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> length <span class="skolem">q</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"butlast <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> q_nonempty Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> length <span class="var">?q'</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q'</span> <span class="main">∈</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_conv_take is_prefix_take prefixes_are_paths<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p</span> <span class="main">=</span> charslength <span class="main">(</span>take <span class="skolem">n</span> <span class="var">?q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.hyps"</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> take_butlast <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> drop <span class="skolem">n</span> <span class="var">?q'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> drop <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_conv_take drop_take<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> h4 <span class="main">=</span> is_prefix_admissible<span class="main">[</span><span class="operator">OF</span> this Suc.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">note</span></span> induct <span class="main">=</span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> h1 Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> h2 h3 Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> h4<span class="main">]</span> 
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">@</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span>butlast <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> induct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p'</span> <span class="main">∈</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"charslength <span class="var">?p'</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> charslength_i<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="var">?q'</span> <span class="main">=</span> <span class="var">?i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> butlast_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> q_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="var">?q'</span><span class="main">@</span><span class="main">[</span>last <span class="skolem">q</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_nonempty<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> charslength_of_butlast <span class="keyword1"><span class="command">have</span></span> charslength_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="var">?q'</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">from</span></span> q_nonempty <span class="keyword1"><span class="command">have</span></span> p'last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p'</span><span class="main">@</span><span class="main">[</span>last <span class="skolem">q</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">@</span><span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.hyps"</span> append_assoc drop_eq_Nil drop_keep_last not_le q_split<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> charslength_i charslength_q'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">have</span></span> charslength_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="var">?q'</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> charslength_i<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">from</span></span> compatibility_def<span class="main">[</span><span class="operator">OF</span> induct Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 1 q_split charslength_q'<span class="main">]</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> p'last Suc.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">from</span></span> in_𝒫_charslength<span class="main">[</span><span class="operator">OF</span> induct<span class="main">]</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword">where</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p'</span> <span class="main">∈</span> 𝒫 <span class="var">?i</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword1"><span class="command">from</span></span> last_step_of_path<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> q_split<span class="main">]</span> 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="var">?i</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> charslength_i<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="var">?i</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"max <span class="skolem">v1</span> <span class="skolem">v2</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≤</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> v1 <span class="keyword1"><span class="command">have</span></span> dom1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p'</span> <span class="main">∈</span> 𝒫 <span class="var">?i</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> subsetCE subset_𝒫k<span class="main">)</span> 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≤</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> v2 <span class="keyword1"><span class="command">have</span></span> dom2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="var">?i</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> subsetCE subset_𝒫k<span class="main">)</span> 
            <span class="keyword1"><span class="command">from</span></span> compatibility_def<span class="main">[</span><span class="operator">OF</span> dom1 dom2 _ q_split<span class="main">]</span> 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">@</span> drop <span class="skolem">n</span> <span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="var">?i</span> <span class="var">?v</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> p'last charslength_i<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Suc.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">@</span> drop <span class="skolem">n</span> <span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"2.hyps"</span> subsetCE subset_𝒫<span class="main">)</span> 
        <span class="keyword1"><span class="command">qed</span></span>                                                          
    <span class="keyword1"><span class="command">qed</span></span>        
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_item_derives<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derives <span class="main">[</span>item_nonterminal <span class="free">x</span><span class="main">]</span> <span class="main">(</span>item_rhs <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wellformed <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>item_nonterminal <span class="free">x</span><span class="main">,</span> item_rhs <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_nonterminal_def item_rhs_def wellformed_item_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 derives1_def derives1_implies_derives is_sentence_concat 
        rule_α_type self_append_conv2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1"><span class="command">lemma</span></span> wellformed_complete_item_β<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> complete<span class="main">:</span> <span class="quoted"><span class="quoted">"is_complete <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"item_β <span class="free">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> complete is_complete_def item_β_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_complete_item_derives<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> complete<span class="main">:</span> <span class="quoted"><span class="quoted">"is_complete <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derives <span class="main">[</span>item_nonterminal <span class="free">x</span><span class="main">]</span> <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> complete is_complete_def item_α_def wellformed wellformed_item_derives <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">lemma</span></span> is_derivation_implies_admissible<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span>terminals <span class="free">p</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⟹</span> is_word <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> admissible <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ℒ<span class="hidden">⇩</span><sub>P</sub>_def admissible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> item_rhs_of_inc_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_rhs <span class="main">(</span>inc_item <span class="free">x</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> item_rhs <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_item_def item_rhs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_rule_of_inc_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_rule <span class="main">(</span>inc_item <span class="free">x</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> item_rule <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_origin_of_inc_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_origin <span class="main">(</span>inc_item <span class="free">x</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> item_origin <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_end_of_inc_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="main">(</span>inc_item <span class="free">x</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_dot_of_inc_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_dot <span class="main">(</span>inc_item <span class="free">x</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>item_dot <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_nonterminal_of_inc_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_nonterminal <span class="main">(</span>inc_item <span class="free">x</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> item_nonterminal <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_item_def item_nonterminal_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_inc_item<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> next_symbol<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="free">x</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> item_end <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed_item <span class="main">(</span>inc_item <span class="free">x</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> k_lower_bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> item_origin <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k_lower_bound wellformed wellformed_item_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_item_def k_upper_bound k_lower_bound'<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> wellformed wellformed_item_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> is_complete_def next_symbol next_symbol_not_complete not_less_eq_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> item_α_of_inc_item<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> next_symbol<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="free">x</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"item_α <span class="main">(</span>inc_item <span class="free">x</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> item_α <span class="free">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> item_dot_of_inc_item item_rhs_of_inc_item 
  One_nat_def add.right_neutral add_Suc_right is_complete_def item_α_def item_β_def 
  le_neq_implies_less list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_symbol next_symbol_not_complete next_symbol_starts_item_β 
  take_hd_drop wellformed wellformed_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derives1_pad<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"derives1 <span class="free">α</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derives1 <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">α</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">β</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> derives1 <span class="keyword1"><span class="command">have</span></span> 
   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">N</span> <span class="bound">δ</span><span class="main">.</span> <span class="free">α</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="bound">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">β</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">δ</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span> is_sentence <span class="bound">x</span> <span class="main">∧</span> is_sentence <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derives1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
   1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">β</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="skolem">δ</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">∧</span> is_sentence <span class="skolem">x</span> <span class="main">∧</span> is_sentence <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> derives1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">@</span><span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">@</span><span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 1 u v is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derives_pad<span class="main">:</span>
  <span class="quoted"><span class="quoted">"derives <span class="free">α</span> <span class="free">β</span> <span class="main">⟹</span> is_sentence <span class="free">u</span> <span class="main">⟹</span> is_sentence <span class="free">v</span> <span class="main">⟹</span> derives <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">α</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">β</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> derives_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> Step <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">α</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="skolem">y</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Step <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"derives1 <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"derives1 <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="skolem">y</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="skolem">z</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Step.prems derives1_pad<span class="main">)</span>    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> derives1_implies_derives derives_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> derives1_is_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"derives1 <span class="free">α</span> <span class="free">β</span> <span class="main">⟹</span> is_sentence <span class="free">α</span> <span class="main">∧</span> is_sentence <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Derives1_sentence1 Derives1_sentence2 derives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> derives_is_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">α</span> <span class="free">β</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">α</span> <span class="main">=</span> <span class="free">β</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>is_sentence <span class="free">α</span> <span class="main">∧</span> is_sentence <span class="free">β</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> derives_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Step.hyps<span class="main">(</span>2<span class="main">)</span> Step.hyps<span class="main">(</span>3<span class="main">)</span> derives1_is_sentence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derives_append<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> au<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">a</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bv<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">b</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_sentence_a<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_sentence_b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derives <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> au <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∨</span> <span class="main">(</span>is_sentence <span class="free">a</span> <span class="main">∧</span> is_sentence <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> derives_is_sentence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> au_sentences<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">a</span> <span class="main">∧</span> is_sentence <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_sentence_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> bv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">v</span> <span class="main">∨</span> <span class="main">(</span>is_sentence <span class="free">b</span> <span class="main">∧</span> is_sentence <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> derives_is_sentence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bv_sentences<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">b</span> <span class="main">∧</span> is_sentence <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_sentence_b <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> derives_pad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> au<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> is_sentence_b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> derives_pad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bv<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> au_sentences<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 derives_trans <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> is_sentence_item_α<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span> <span class="main">⟹</span> is_sentence <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_sentence_take item_α_def item_rhs_def prod.collapse rule_α_type wellformed_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_nonterminal_item_nonterminal<span class="main">:</span>  <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span> <span class="main">⟹</span> is_nonterminal <span class="main">(</span>item_nonterminal <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> item_nonterminal_def prod.collapse rule_nonterminal_type wellformed_item_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Complete_elem_in_Gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I_in_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_Complete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Complete <span class="free">k</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> x_in_Complete <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> inc_item <span class="bound">x1</span> <span class="free">k</span> <span class="main">∧</span> 
     <span class="bound">x1</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="main">(</span>item_origin <span class="bound">x2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x2</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="free">k</span> <span class="main">∧</span> is_complete <span class="bound">x2</span> <span class="main">∧</span> 
     next_symbol <span class="bound">x1</span> <span class="main">=</span> Some <span class="main">(</span>item_nonterminal <span class="bound">x2</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complete_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> I_in_Gen subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword">where</span></span> x12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> inc_item <span class="skolem">x1</span> <span class="free">k</span> <span class="main">∧</span> 
      <span class="skolem">x1</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="main">(</span>item_origin <span class="skolem">x2</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x2</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="free">k</span> <span class="main">∧</span> is_complete <span class="skolem">x2</span> <span class="main">∧</span> 
      next_symbol <span class="skolem">x1</span> <span class="main">=</span> Some <span class="main">(</span>item_nonterminal <span class="skolem">x2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> x12 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span> <span class="bound">p1</span> <span class="main">∈</span> <span class="var">?P</span> <span class="main">∧</span> pvalid <span class="bound">p1</span> <span class="skolem">x1</span> <span class="main">∧</span> <span class="bound">p2</span> <span class="main">∈</span> <span class="var">?P</span> <span class="main">∧</span> pvalid <span class="bound">p2</span> <span class="skolem">x2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Gen_implies_pvalid I_in_Gen bin_elem subsetCE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">∈</span> <span class="var">?P</span> <span class="main">∧</span> pvalid <span class="skolem">p1</span> <span class="skolem">x1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p2</span> <span class="main">∈</span> <span class="var">?P</span> <span class="main">∧</span> pvalid <span class="skolem">p2</span> <span class="skolem">x2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> p1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> p1valid<span class="main">:</span>
      <span class="quoted"><span class="quoted">"wellformed_tokens <span class="skolem">p1</span> <span class="main">∧</span>
       wellformed_item <span class="skolem">x1</span> <span class="main">∧</span>
       <span class="skolem">w</span> <span class="main">≤</span> length <span class="skolem">p1</span> <span class="main">∧</span>
       charslength <span class="skolem">p1</span> <span class="main">=</span> item_end <span class="skolem">x1</span> <span class="main">∧</span>
       charslength <span class="main">(</span>take <span class="skolem">w</span> <span class="skolem">p1</span><span class="main">)</span> <span class="main">=</span> item_origin <span class="skolem">x1</span> <span class="main">∧</span>
       is_derivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">w</span> <span class="skolem">p1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="skolem">x1</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">∧</span>
       derives <span class="main">(</span>item_α <span class="skolem">x1</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">w</span> <span class="skolem">p1</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> pvalid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> p2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> p2valid<span class="main">:</span>
      <span class="quoted"><span class="quoted">"wellformed_tokens <span class="skolem">p2</span> <span class="main">∧</span>
       wellformed_item <span class="skolem">x2</span> <span class="main">∧</span>
       <span class="skolem">y</span> <span class="main">≤</span> length <span class="skolem">p2</span> <span class="main">∧</span>
       charslength <span class="skolem">p2</span> <span class="main">=</span> item_end <span class="skolem">x2</span> <span class="main">∧</span>
       charslength <span class="main">(</span>take <span class="skolem">y</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">=</span> item_origin <span class="skolem">x2</span> <span class="main">∧</span>
       is_derivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">y</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="skolem">x2</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span> <span class="main">∧</span>
       derives <span class="main">(</span>item_α <span class="skolem">x2</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">y</span> <span class="skolem">p2</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> pvalid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">@</span> <span class="main">(</span>drop <span class="skolem">y</span> <span class="skolem">p2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> charslength_p1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p1</span> <span class="main">=</span> item_end <span class="skolem">x1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> p1valid<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> x12 <span class="keyword1"><span class="command">have</span></span> item_end_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x1</span> <span class="main">=</span> item_origin <span class="skolem">x2</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> bin_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> item_end_x2<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x2</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bin_def x12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength_p1_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p1</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> charslength_p1_eq item_end_x1 p2valid wellformed_item_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">δ'</span><span class="main">.</span> item_β <span class="skolem">x1</span> <span class="main">=</span> <span class="main">[</span>item_nonterminal <span class="skolem">x2</span><span class="main">]</span> <span class="main">@</span> <span class="bound">δ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_symbol_starts_item_β p1valid x12<span class="main">)</span>  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ'<span class="main">:</span> <span class="quoted"><span class="quoted">"item_β <span class="skolem">x1</span> <span class="main">=</span> <span class="main">[</span>item_nonterminal <span class="skolem">x2</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">δ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">w</span> <span class="skolem">p1</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_rhs <span class="skolem">x1</span><span class="main">)</span><span class="main">@</span><span class="skolem">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_derivation_derives p1valid wellformed_item_derives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">w</span> <span class="skolem">p1</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_α <span class="skolem">x1</span> <span class="main">@</span> item_β <span class="skolem">x1</span><span class="main">)</span><span class="main">@</span><span class="skolem">δ</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_rhs_split<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">w</span> <span class="skolem">p1</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">w</span> <span class="skolem">p1</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> item_β <span class="skolem">x1</span><span class="main">)</span><span class="main">@</span><span class="skolem">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_derivation_derives p1valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="skolem">p1</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="skolem">x1</span><span class="main">)</span><span class="main">@</span><span class="skolem">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc append_take_drop_id terminals_append<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="skolem">p1</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="main">[</span>item_nonterminal <span class="skolem">x2</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">δ'</span><span class="main">)</span><span class="main">@</span><span class="skolem">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_derivation_derives δ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="main">(</span>terminals <span class="skolem">p1</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">y</span> <span class="skolem">p2</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">δ'</span> <span class="main">@</span><span class="skolem">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_complete_def is_derivation_derives is_derivation_step item_α_def 
        item_nonterminal_def item_rhs_def p2valid wellformed_item_def x12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span>terminals <span class="main">(</span><span class="skolem">p1</span> <span class="main">@</span> <span class="main">(</span>drop <span class="skolem">y</span> <span class="skolem">p2</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">δ'</span> <span class="main">@</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> admissible_r<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="skolem">p1</span> <span class="main">@</span> <span class="main">(</span>drop <span class="skolem">y</span> <span class="skolem">p2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> is_derivation_implies_admissible<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_word_terminals<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p1valid<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> p2valid <span class="keyword1"><span class="command">using</span></span> is_word_terminals_drop terminals_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> r_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> general_compatibility<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> p2valid charslength_p1_eq item_end_x1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> charslength_p1_leq<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admissible_r<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> wellformed_r<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="var">?r</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> admissible_r admissible_wellformed_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x12<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> wellformed_inc_item<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p1valid<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x12<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> charslength_p1_eq charslength_p1_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> charslength_p1_as_p2<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p1</span> <span class="main">=</span> charslength <span class="main">(</span>take <span class="skolem">y</span> <span class="skolem">p2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> charslength_p1_eq item_end_x1 p2valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>     
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength_r<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="var">?r</span> <span class="main">=</span> item_end <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x12<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> length_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> chars_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> append_take_drop_id<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> item_end_x2 p2valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> item_α_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_α <span class="free">x</span> <span class="main">=</span> item_α <span class="skolem">x1</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="skolem">x2</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x12 p1valid <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_α_of_inc_item<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> p2valid <span class="keyword1"><span class="command">have</span></span> derives_item_nonterminal_x2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"derives <span class="main">[</span>item_nonterminal <span class="skolem">x2</span><span class="main">]</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">y</span> <span class="skolem">p2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> derives_trans wellformed_complete_item_derives x12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pvalid <span class="var">?r</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pvalid_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_r<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_x<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> p1valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> charslength_r<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> x12 p1valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> x12 p1valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  item_α_x<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> derives_append<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> p1valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> derives_item_nonterminal_x2 p1valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_sentence_item_α p1valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> is_derivation_is_sentence is_sentence_concat p2valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> r_in_dom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Gen_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Complete_subset_Gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I_in_Gen_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Complete <span class="free">k</span> <span class="free">I</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Complete_elem_in_Gen I_in_Gen_P k <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒫_are_admissible<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> admissible <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> 𝔓_are_admissible<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> 𝔓_covers_𝒫 subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_continuation_base<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> charslength_p<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="free">u</span> <span class="free">p</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_dom<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> charslength_p <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">using</span></span> 𝒫_are_admissible p_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_continuation_empty_chars<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="free">u</span> <span class="free">q</span> <span class="free">ts</span> <span class="main">⟹</span> charslength <span class="main">(</span><span class="free">q</span><span class="main">@</span><span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span> <span class="main">⟹</span> chars <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒵_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> 𝒵 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> 𝒵 <span class="free">k</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> 𝒵_subset_Suc subset_fSuc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_continuation_increase_u<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="free">u</span> <span class="free">q</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="free">v</span> <span class="free">q</span> <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cont is_continuation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> uv <span class="keyword1"><span class="command">have</span></span> q_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> subsetCE subset_𝒫k<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> uv <span class="keyword1"><span class="command">have</span></span> 𝒵<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝒵_subset le_neq_implies_less less_imp_le_nat not_less_eq subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> is_continuation_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> cont is_continuation_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> cont is_continuation_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> cont is_continuation_def 𝒵 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> cont is_continuation_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pvalid_next_symbol_derivable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pvalid<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> next_symbol<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="free">x</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">δ</span><span class="main">.</span> is_derivation<span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="bound">δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pvalid pvalid_def <span class="keyword1"><span class="command">have</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> next_symbol_starts_item_β<span class="main">[</span><span class="operator">OF</span> wellformed_x next_symbol<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span> ω<span class="main">:</span> <span class="quoted"><span class="quoted">"item_β <span class="free">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ω</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pvalid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">γ</span><span class="main">.</span> is_derivation<span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span><span class="main">@</span><span class="bound">γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pvalid_is_derivation_terminals_item_β <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_derivation<span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span><span class="main">@</span><span class="skolem">γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> ω <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_derivation<span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">ω</span><span class="main">@</span><span class="skolem">γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pvalid_admissible<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> pvalid<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"admissible <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">δ</span><span class="main">.</span> is_derivation<span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span><span class="main">@</span><span class="bound">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid pvalid_is_derivation_terminals_item_β<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation<span class="main">(</span><span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>item_β <span class="free">x</span><span class="main">)</span><span class="main">@</span><span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> is_word<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pvalid_def is_word_terminals pvalid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> δ is_derivation_implies_admissible is_word <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> pvalid_next_terminal_admissible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pvalid<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> next_symbol<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> terminal<span class="main">:</span> <span class="quoted"><span class="quoted">"is_terminal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="free">p</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_word_terminals pvalid pvalid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> is_derivation_implies_admissible next_symbol pvalid pvalid_next_symbol_derivable 
      terminal <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒳_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> 𝒳 <span class="free">k</span> <span class="main">⟹</span> wellformed_token <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒳_are_terminals wellformed_token_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒵_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> 𝒵 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> wellformed_token <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 𝒳_wellformed 𝒵_subset_𝒳 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 
<span class="keyword1"><span class="command">lemma</span></span> Scan_elem_in_Gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I_in_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_Scan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒵 <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Scan <span class="free">T</span> <span class="free">k</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Scan_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_in_Scan <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="free">u</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="bound">t</span> <span class="bound">c</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> inc_item <span class="bound">y</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> length <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="free">k</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> next_symbol <span class="bound">y</span> <span class="main">=</span> Some <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_in_Scan Scan_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> I_in_Gen <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_is_scan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> inc_item <span class="skolem">y</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> length <span class="skolem">c</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="free">k</span> <span class="main">∧</span> 
       <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> next_symbol <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> u_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">.</span> pvalid <span class="bound">p</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Gen_implies_pvalid I_in_Gen bin_elem x_is_scan <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">∧</span> pvalid <span class="skolem">p</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> p_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> p pvalid_def x_is_scan <span class="keyword1"><span class="command">have</span></span> charslength_p<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bin_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tok</span></span> <span class="keyword2"><span class="keyword">where</span></span> tok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tok</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_is_scan <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> tok_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tok</span> <span class="main">∈</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tok x_is_scan T <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">q</span> <span class="bound">ts</span> <span class="bound">u'</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="bound">q</span><span class="main">@</span><span class="bound">ts</span> <span class="main">∧</span> <span class="bound">u'</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="main">∧</span> charslength <span class="bound">ts</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> is_continuation <span class="free">k</span> <span class="bound">u'</span> <span class="bound">q</span> <span class="bound">ts</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2 is_continuation_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> charslength_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">from</span></span> final_step_of_path<span class="main">[</span><span class="operator">OF</span> p_dom 2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">u'</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> final_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="skolem">ts</span> <span class="main">∧</span> indexlt <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="free">k</span> <span class="free">u</span> <span class="main">∧</span> is_continuation <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">q</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> indexlt_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∨</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> final_step is_continuation_in_𝒫 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> 1 subsetCE subset_𝒫<span class="main">)</span> 
        <span class="keyword1"><span class="command">with</span></span> charslength_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="main">0</span> <span class="skolem">p</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_continuation_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_gt_0<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">with</span></span> final_step indexlt_simp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> final_step 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">using</span></span> charslength_p is_continuation_empty_chars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      p_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">@</span><span class="skolem">ts</span> <span class="main">∧</span> <span class="skolem">u'</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="main">∧</span> charslength <span class="skolem">ts</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> is_continuation <span class="free">k</span> <span class="skolem">u'</span> <span class="skolem">q</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u''</span><span class="main">.</span> <span class="skolem">u'</span> <span class="main">≤</span> <span class="bound">u''</span> <span class="main">∧</span> Suc <span class="bound">u''</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="keyword2"><span class="keyword">where</span></span> u''<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">u'</span> <span class="main">≤</span> <span class="skolem">u''</span> <span class="main">∧</span> Suc <span class="skolem">u''</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> p_split <span class="keyword1"><span class="command">have</span></span> cont_u''<span class="main">:</span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="skolem">u''</span> <span class="skolem">q</span> <span class="skolem">ts</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> is_continuation_increase_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> admissible<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">tok</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tok<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> pvalid_next_terminal_admissible<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_is_scan<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 𝒵_wellformed tok tok_dom wellformed_token_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_continuation <span class="free">k</span> <span class="skolem">u''</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">ts</span><span class="main">@</span><span class="main">[</span><span class="skolem">tok</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_continuation_continue<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cont_u''<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> p_split <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> u'' tok_dom <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> admissible p_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> p_split u'' <span class="keyword1"><span class="command">have</span></span> ptok_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">tok</span><span class="main">]</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> append_assoc is_continuation_in_𝒫 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> valid<span class="main">:</span>
      <span class="quoted"><span class="quoted">"wellformed_tokens <span class="skolem">p</span> <span class="main">∧</span>
       wellformed_item <span class="skolem">y</span> <span class="main">∧</span>
       <span class="skolem">i</span> <span class="main">≤</span> length <span class="skolem">p</span> <span class="main">∧</span>
       charslength <span class="skolem">p</span> <span class="main">=</span> item_end <span class="skolem">y</span> <span class="main">∧</span>
       charslength <span class="main">(</span>take <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> item_origin <span class="skolem">y</span> <span class="main">∧</span>
       is_derivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="skolem">y</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span> <span class="main">∧</span>
       derives <span class="main">(</span>item_α <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> clen_ptok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> length <span class="skolem">c</span> <span class="main">=</span> charslength <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">tok</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> charslength_p tok <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> ptok_dom <span class="keyword1"><span class="command">have</span></span> ptok_doc_tokens<span class="main">:</span> <span class="quoted"><span class="quoted">"doc_tokens <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">tok</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝔓_are_doc_tokens 𝔓_covers_𝒫 rev_subsetD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_is_scan<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> wellformed_inc_item<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_is_scan<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> clen_ptok<span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> ptok_doc_tokens charslength.simps doc_tokens_length <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> clen_ptok<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pvalid <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">tok</span><span class="main">]</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pvalid_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ptok_dom admissible admissible_wellformed_tokens <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_x<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_is_scan clen_ptok<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_is_scan<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_is_scan<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_is_scan<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> item_α_of_inc_item<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> valid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> x_is_scan <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> derives_append<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tok<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> is_sentence_item_α <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> pvalid_next_symbol_derivable LocalLexing_axioms is_derivation_is_sentence 
          is_sentence_concat p x_is_scan<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ptok_dom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Gen_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Scan_subset_Gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I_in_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Scan <span class="free">T</span> <span class="free">k</span> <span class="free">I</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> I_in_Gen Scan_elem_in_Gen T k <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> thmD5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> limit_upperbound<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> I k T Predict_subset_Gen Complete_subset_Gen Scan_subset_Gen <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD6">
<div class="head">
<h1>Theory TheoremD6</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD6
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD5.html">TheoremD5</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inc_dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> item <span class="main">⇒</span> item"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inc_dot</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Item <span class="main">(</span>item_rule <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>item_dot <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">(</span>item_origin <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>item_end <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inc_dot_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inc_dot <span class="main">0</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Predict_mk_regular1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="main">(</span><span class="bound">P</span> <span class="main">::</span> rule <span class="main">⇒</span> item <span class="main">⇒</span> bool<span class="main">)</span> <span class="bound">F</span><span class="main">.</span> Predict <span class="free">k</span> <span class="main">=</span> mk_regular1 <span class="bound">P</span> <span class="bound">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">::</span>item<span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> item_end <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> next_symbol <span class="bound">x</span> <span class="main">=</span> Some<span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">r</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span>item<span class="main">)</span><span class="main">.</span> init_item <span class="bound">r</span> <span class="free">k</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?F</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_regular1_def bin_def Predict_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Complete_mk_regular2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="main">(</span><span class="bound">P</span> <span class="main">::</span> dummy <span class="main">⇒</span> item <span class="main">⇒</span> item <span class="main">⇒</span> bool<span class="main">)</span> <span class="bound">F</span><span class="main">.</span> Complete <span class="free">k</span> <span class="main">=</span> mk_regular2 <span class="bound">P</span> <span class="bound">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>dummy<span class="main">)</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> item_end <span class="bound">x</span> <span class="main">=</span> item_origin <span class="bound">y</span> <span class="main">∧</span> item_end <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> is_complete <span class="bound">y</span> <span class="main">∧</span> 
     next_symbol <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span>item_nonterminal <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>dummy<span class="main">)</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> inc_item <span class="bound">x</span> <span class="free">k</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?F</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_regular2_def bin_def Complete_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Scan_mk_regular1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="main">(</span><span class="bound">P</span> <span class="main">::</span> token <span class="main">⇒</span> item <span class="main">⇒</span> bool<span class="main">)</span> <span class="bound">F</span><span class="main">.</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="main">=</span> mk_regular1 <span class="bound">P</span> <span class="bound">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">tok</span><span class="main">::</span>token<span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span>item<span class="main">)</span><span class="main">.</span> item_end <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">tok</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> next_symbol <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="bound">tok</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">tok</span><span class="main">::</span>token<span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span>item<span class="main">)</span><span class="main">.</span> inc_item <span class="bound">x</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="bound">tok</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?F</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_regular1_def bin_def Scan_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Predict_regular<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>Predict <span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Predict_mk_regular1 regular1<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Complete_regular<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>Complete <span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Complete_mk_regular2 regular2<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> Scan_regular<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Scan_mk_regular1 regular1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> π_functional<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="free">T</span> <span class="main">=</span> limit <span class="main">(</span><span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Complete <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Predict <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="free">T</span> <span class="main">=</span> limit <span class="main">(</span><span class="main">λ</span> <span class="bound">I</span><span class="main">.</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Complete <span class="free">k</span> <span class="main">(</span>Predict <span class="free">k</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> π_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">I</span><span class="main">.</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Complete <span class="free">k</span> <span class="main">(</span>Predict <span class="free">k</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Complete <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Predict <span class="free">k</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_step_regular<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span><span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Complete <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Predict <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complete_regular Predict_regular Scan_regular regular_comp<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> π_regular<span class="main">:</span> <span class="quoted"><span class="quoted">"regular <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_functional π_step_regular regular_limit<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> π_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Complete <span class="free">k</span> <span class="main">(</span>Predict <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> π_functional π_step_regular regular_fixpoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> π_fix'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Complete <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Predict <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> π_functional π_step_regular regular_fixpoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> setmonotone_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span> <span class="main">∨</span> <span class="free">X</span> <span class="main">⊂</span> <span class="free">f</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms elem_setmonotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> distribute_fixpoint_over_setmonotone_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fixpoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">g</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> setmonotone_cases<span class="main">[</span><span class="operator">OF</span> g<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">I</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fixpoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊂</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply fixpoint less_asym' setmonotone_cases<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fixpoint <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distribute_fixpoint_over_setmonotone_comp_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fixpoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span> <span class="keyword1">o</span> <span class="free">h</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">g</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">h</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> distribute_fixpoint_over_setmonotone_comp f fixpoint g h setmonotone_comp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Predict_π_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"Predict <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Complete_regular Predict_regular Scan_regular π_fix' 
  distribute_fixpoint_over_setmonotone_comp_3 regular_implies_setmonotone<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Scan_π_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Complete_regular Predict_regular Scan_regular π_fix' 
  distribute_fixpoint_over_setmonotone_comp_3 regular_implies_setmonotone<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Complete_π_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Complete_regular Predict_regular Scan_regular π_fix' 
  distribute_fixpoint_over_setmonotone_comp_3 regular_implies_setmonotone<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> π_idempotent<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="free">T</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_functional π_step_regular limit_is_idempotent<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_shift_identity<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_shift <span class="free">D</span> <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_skip_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="free">D</span> <span class="free">w</span> <span class="main">⟹</span> derivation_ge <span class="free">D</span> <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> 
  Derivation <span class="free">v</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> Derives1 <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> Derivation <span class="bound">x</span> <span class="skolem">D</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span> Derivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">d</span> <span class="main">≥</span> length <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">D</span> <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> derivation_ge_cons <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> derivation_ge_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">@</span><span class="bound">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj d le_Derives1_take x<span class="main">)</span>   
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">@</span><span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.hyps D Derives1_skip_prefix d x x' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_skip_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≥</span> length <span class="free">u</span> <span class="main">⟹</span> leftmost <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">u</span><span class="main">)</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_def less_diff_conv2 nth_append<span class="main">)</span>
 
<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_skip_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="free">D</span> <span class="free">w</span> <span class="main">⟹</span> derivation_ge <span class="free">D</span> <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> 
  LeftDerivation <span class="free">v</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> LeftDerives1 <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> LeftDerivation <span class="bound">x</span> <span class="skolem">D</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span> LeftDerivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">d</span> <span class="main">≥</span> length <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">D</span> <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> derivation_ge_cons <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> derivation_ge_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">@</span><span class="bound">x'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerives1_implies_Derives1 append_eq_conv_conj d le_Derives1_take x<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">@</span><span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> leftmost<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerives1_def x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">v</span> <span class="main">(</span>fst <span class="skolem">d</span> <span class="main">-</span> length <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerives1_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost d leftmost_skip_prefix<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Derives1_skip_prefix LeftDerives1_implies_Derives1 d x x' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">x'</span> <span class="main">(</span>derivation_shift <span class="skolem">D</span> <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.hyps D x x' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splits_at_append<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">u</span> <span class="free">i</span> <span class="free">u1</span> <span class="free">N</span> <span class="free">u2</span> <span class="main">⟹</span> splits_at <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">u1</span> <span class="free">N</span> <span class="main">(</span><span class="free">u2</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splits_at_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_append_leftmost_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">c</span> <span class="main">⟹</span> leftmost <span class="free">j</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> LeftDerives1_def leftmost_cons_less leftmost_def leftmost_unique<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> drop_derivation_shift<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="free">left</span> <span class="free">right</span><span class="main">)</span> <span class="main">=</span> derivation_shift <span class="main">(</span>drop <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">left</span> <span class="free">right</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def drop_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> take_derivation_shift<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="free">left</span> <span class="free">right</span><span class="main">)</span> <span class="main">=</span> derivation_shift <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">left</span> <span class="free">right</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def take_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_shift_0_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_shift <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="free">left1</span> <span class="main">0</span><span class="main">)</span> <span class="free">left2</span> <span class="free">right2</span> <span class="main">=</span> 
  derivation_shift <span class="free">D</span> <span class="main">(</span><span class="free">left1</span> <span class="main">+</span> <span class="free">left2</span><span class="main">)</span> <span class="free">right2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splits_at_append_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"splits_at <span class="free">v</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span> <span class="main">⟹</span> splits_at <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">N</span> <span class="free">β</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splits_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> splits_at_implies_Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">δ</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span> <span class="main">⟹</span> is_sentence <span class="free">δ</span> <span class="main">⟹</span> <span class="free">r</span><span class="main">∈</span> <span class="free">ℜ</span> <span class="main">⟹</span> fst <span class="free">r</span> <span class="main">=</span> <span class="free">N</span> 
 <span class="main">⟹</span> Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">@</span><span class="free">β</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Derives1_def is_sentence_concat length_take 
  less_or_eq_imp_le min.absorb2 prod.collapse splits_at_combine splits_at_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_append_prefix<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">v</span> <span class="free">i</span> <span class="free">r</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">u</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span><span class="main">.</span> splits_at <span class="free">v</span> <span class="free">i</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms splits_at_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_v<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">v</span> <span class="free">i</span> <span class="skolem">α</span> <span class="skolem">N</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> split_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">@</span><span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">@</span><span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms split_v splits_at_combine_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> split_uv<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="skolem">α</span><span class="main">)</span> <span class="skolem">N</span> <span class="skolem">β</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_v splits_at_append_prefix<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> is_sentence_uv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1 Derives1_sentence1 is_sentence_concat u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1 Derives1_nonterminal Derives1_rule append_assoc is_sentence_uv 
        split_uv split_v split_w splits_at_implies_Derives1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_prepend_word<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">v</span> <span class="main">⟹</span> is_word <span class="free">u</span> <span class="main">⟹</span> leftmost <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_def nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_append_prefix<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">v</span> <span class="free">i</span> <span class="free">r</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">u</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">v</span> <span class="free">i</span> <span class="free">r</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1 LeftDerives1_implies_Derives1<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1 LeftDerives1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">u</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1"</span> <span class="quoted">"3"</span> Derives1_append_prefix<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2"</span> leftmost_prepend_word u<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"4"</span> <span class="quoted">"5"</span> LeftDerives1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>     

<span class="keyword1"><span class="command">lemma</span></span> Derivation_append_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">v</span> <span class="free">D</span> <span class="free">w</span> <span class="main">⟹</span> is_sentence <span class="free">u</span> <span class="main">⟹</span>
  Derivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> Derives1 <span class="skolem">v</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> Derivation <span class="bound">x</span> <span class="skolem">D</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">v</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span> Derivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="skolem">D</span> <span class="main">0</span> <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">+</span> length <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Derives1_append_prefix x<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">@</span><span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Derives1 x<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>     

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_append_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">v</span> <span class="free">D</span> <span class="free">w</span> <span class="main">⟹</span> is_word <span class="free">u</span> <span class="main">⟹</span> 
  LeftDerivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> LeftDerives1 <span class="skolem">v</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> LeftDerivation <span class="bound">x</span> <span class="skolem">D</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">v</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span> LeftDerivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="skolem">D</span> <span class="main">0</span> <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">+</span> length <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> LeftDerives1_append_prefix x<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">@</span><span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Derives1 x<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>     

<span class="keyword1"><span class="command">lemma</span></span> derivation_ge_shift_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≥</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≥</span> <span class="free">l</span> <span class="main">⟹</span> 
   derivation_shift <span class="free">D</span> <span class="free">l</span> <span class="free">r</span> <span class="main">=</span> derivation_shift <span class="free">D</span> <span class="main">0</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> fst_d<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">d</span> <span class="main">≥</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> Cons.prems<span class="main">(</span>2<span class="main">)</span> derivation_ge_cons le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> Cons fst_d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span> 
    <span class="keyword1"><span class="command">using</span></span> Cons derivation_ge_cons <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> append_dropped_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">u</span> <span class="free">v</span> <span class="main">⟹</span> drop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span><span class="main">@</span><span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> is_prefix_unsplit <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1"><span class="command">lemma</span></span> derivation_ge_shift_plus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="free">u</span> <span class="main">0</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="main">(</span><span class="free">u</span> <span class="main">+</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def derivation_shift_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_breakdown<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="free">D</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">n</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">w1</span> <span class="main">@</span> <span class="bound">w2</span> <span class="main">∧</span> 
     LeftDerivation <span class="free">u</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="bound">w1</span> <span class="main">∧</span>
     derivation_ge <span class="main">(</span>drop <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">w1</span><span class="main">)</span> <span class="main">∧</span>
     LeftDerivation <span class="free">v</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">w1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="bound">w2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">D</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> D <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">d</span> <span class="bound">D'</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">=</span> <span class="bound">d</span><span class="main">#</span><span class="bound">D'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivation.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_0_conv nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> D_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">d</span><span class="main">#</span><span class="skolem">D'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> is_sentence_uv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> D_split Derives1_sentence1 LeftDerivation.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> LeftDerives1_implies_Derives1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_sentence_u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> is_sentence_v<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sentence_concat<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>   
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_word <span class="skolem">u</span> <span class="main">∨</span> <span class="main">(</span><span class="main">¬</span> is_word <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> derivation_ge_u<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">D</span> <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> LeftDerivation_implies_Derivation Suc.prems is_word_Derivation_derivation_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> is_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">u</span> <span class="skolem">w</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span> LeftDerivation_implies_leftderives Suc.prems 
              derives_word_is_prefix leftderives_implies_derives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>          
          <span class="keyword1"><span class="command">have</span></span> u_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.hyps"</span> LeftDerivation_implies_leftderives Suc.prems 
              derives_word_is_prefix is_prefix_unsplit leftderives_implies_derives<span class="main">)</span>  
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> u_w<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> derivation_ge_u<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivation_skip_prefix Suc.prems derivation_ge_u<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
          <span class="keyword1"><span class="command">with</span></span> is_sentence_u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span> <span class="bound">u1</span> <span class="bound">N</span> <span class="bound">u2</span><span class="main">.</span> splits_at <span class="skolem">u</span> <span class="bound">i</span> <span class="bound">u1</span> <span class="bound">N</span> <span class="bound">u2</span> <span class="main">∧</span> leftmost <span class="bound">i</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> leftmost_def nonword_leftmost_exists splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_u<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="skolem">u</span> <span class="skolem">i</span> <span class="skolem">u1</span> <span class="skolem">N</span> <span class="skolem">u2</span> <span class="main">∧</span> leftmost <span class="skolem">i</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> is_word_u1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leftmost_def split_u splits_at_def<span class="main">)</span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span><span class="main">#</span><span class="skolem">D'</span><span class="main">)</span> <span class="skolem">w</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> D_split Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> LeftDerives1 <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> LeftDerivation <span class="bound">x</span> <span class="skolem">D'</span> <span class="skolem">w</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span> LeftDerivation <span class="skolem">x</span> <span class="skolem">D'</span> <span class="skolem">w</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fst_d_eq_i<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 
            splits_at_combine LeftDerives1_append_leftmost_unique split_u
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span> split_uv<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">u1</span> <span class="skolem">N</span> <span class="main">(</span><span class="skolem">u2</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_u splits_at_append<span class="main">)</span> 
          <span class="keyword1"><span class="command">have</span></span> split_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u2</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> LeftDerives1_implies_Derives1 fst_d_eq_i split_uv 
              splits_at_combine_dest x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">have</span></span> derivation_ge_D'<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">D'</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> LeftDerivation_implies_Derivation is_word_Derivation_derivation_ge 
              leftmost_def split_u split_x splits_at_def x <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">have</span></span> D1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u2</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="skolem">D'</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> 
            <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> LeftDerivation_skip_prefix derivation_ge_D' split_x x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D2<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="main">(</span><span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u2</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="skolem">D'</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> 
            <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> length <span class="main">(</span>derivation_shift <span class="skolem">D'</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> D_split Suc.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this D2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> induct<span class="main">:</span>
            <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">w1</span> <span class="main">@</span> <span class="skolem">w2</span> <span class="main">∧</span> 
             LeftDerivation <span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u2</span><span class="main">)</span> 
               <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span>derivation_shift <span class="skolem">D'</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w1</span> <span class="main">∧</span> 
             derivation_ge <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span>derivation_shift <span class="skolem">D'</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span> <span class="main">∧</span>
             LeftDerivation <span class="skolem">v</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span>derivation_shift <span class="skolem">D'</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> 
               <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> derivation_ge_D'_u1_w1<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">u1</span> <span class="main">+</span> length <span class="skolem">w1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">from</span></span> induct <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> drop_derivation_shift<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id derivation_ge_D' derivation_ge_append<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 derivation_ge_shift_plus <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">u1</span><span class="main">@</span><span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>derivation_shift 
                <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span>derivation_shift <span class="skolem">D'</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u1</span><span class="main">@</span><span class="skolem">w1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> induct LeftDerivation_append_prefix is_word_u1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> der1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">u1</span><span class="main">@</span><span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u2</span><span class="main">)</span><span class="main">)</span> 
              <span class="main">(</span>derivation_shift <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u1</span><span class="main">@</span><span class="skolem">w1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> take_derivation_shift derivation_shift_0_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_shift <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">u1</span><span class="main">)</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="skolem">D'</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> derivation_ge_shift_simp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem">u1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id derivation_ge_D' derivation_ge_append<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> der1 eq1 <span class="keyword1"><span class="command">have</span></span> der2<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">u1</span><span class="main">@</span><span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u1</span><span class="main">@</span><span class="skolem">w1</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">D</span> <span class="main">=</span> <span class="skolem">d</span><span class="main">#</span><span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_split<span class="main">)</span>  
          <span class="keyword1"><span class="command">have</span></span> der3<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u1</span><span class="main">@</span><span class="skolem">w1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">u1</span><span class="main">@</span><span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_skip_suffix LeftDerives1_def append_assoc der2 fst_d_eq_i 
              split_u split_x splits_at_def x<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">u1</span> <span class="skolem">w</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> LeftDerivation_implies_leftderives derives_word_is_prefix is_word_u1 
              leftderives_implies_derives split_x x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">w1</span><span class="main">@</span><span class="skolem">w2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>  
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> append_dropped_prefix<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> induct<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">u1</span><span class="main">@</span><span class="skolem">w1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">w2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq3<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> der3<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_split<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> derivation_ge_D'_u1_w1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_split<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> induct derivation_shift_0_shift drop_derivation_shift <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
                  
<span class="keyword1"><span class="command">lemma</span></span> Derives1_terminals_stay<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">u</span> <span class="free">i</span> <span class="free">r</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> terminal<span class="main">:</span> <span class="quoted"><span class="quoted">"is_terminal <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α</span> <span class="bound">β</span> <span class="bound">N</span><span class="main">.</span> splits_at <span class="free">u</span> <span class="free">i</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derives1 splits_at_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_u<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">u</span> <span class="free">i</span> <span class="skolem">α</span> <span class="skolem">N</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">α</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">β</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> splits_at_combine t_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_possible_locations<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="skolem">α</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">∈</span> set <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> is_nonterminal<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derives1 Derives1_nonterminal split_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">with</span></span> t_possible_locations terminal <span class="keyword1"><span class="command">have</span></span> t_locations<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="skolem">α</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">∈</span> set <span class="skolem">β</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_terminal_nonterminal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> Derives1 split_u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">α</span> <span class="main">@</span> <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splits_at_combine_dest<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> t_locations <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_terminals_stay<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">u</span> <span class="free">D</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> set <span class="free">u</span> <span class="main">⟹</span> is_terminal <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> set <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> Derives1 <span class="skolem">u</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> Derivation <span class="bound">x</span> <span class="skolem">D</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">u</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span> Derivation <span class="skolem">x</span> <span class="skolem">D</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons Derives1_terminals_stay x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> Derivation_empty_no_terminals<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">u</span> <span class="free">D</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> set <span class="free">u</span> <span class="main">⟹</span> is_nonterminal <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ball_set Derivation_implies_derives Derivation_terminals_stay 
    derives_is_sentence is_sentence_def is_symbol_distinct list.pred_inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_subset_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_inc_dot<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span> <span class="main">⟹</span> item_dot <span class="free">x</span> <span class="main">+</span> <span class="free">d</span> <span class="main">≤</span> length <span class="main">(</span>item_rhs <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
  wellformed_item<span class="main">(</span>inc_dot <span class="free">d</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def item_rhs_def wellformed_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_item_dot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_dot <span class="main">(</span>init_item <span class="free">r</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_item_rhs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_rhs <span class="main">(</span>init_item <span class="free">r</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_item_def item_rhs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_item_β<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_β <span class="main">(</span>init_item <span class="free">r</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_β_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_π<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_regular regular_implies_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> π_subset_elem_trans<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span>  π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="free">T</span> <span class="free">Y</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="free">T</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoD mono_π<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="free">T</span> <span class="free">Y</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> π_idempotent <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">with</span></span> z <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> contra_subsetD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inc_dot_origin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_origin <span class="main">(</span>inc_dot <span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> item_origin <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inc_dot_end<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="main">(</span>inc_dot <span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> item_end <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inc_dot_rhs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_rhs <span class="main">(</span>inc_dot <span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> item_rhs <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def item_rhs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inc_dot_dot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_dot <span class="main">(</span>inc_dot <span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> item_dot <span class="free">x</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inc_dot_nonterminal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_nonterminal <span class="main">(</span>inc_dot <span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> item_nonterminal <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def item_nonterminal_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Predict_subset_π<span class="main">:</span> <span class="quoted"><span class="quoted">"Predict <span class="free">k</span> <span class="free">X</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"setmonotone <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_regular regular_implies_setmonotone<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_setmonotone<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>Predict <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Predict_regular regular_implies_mono<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Predict <span class="free">k</span> <span class="free">X</span> <span class="main">⊆</span> Predict <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoD<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Predict <span class="free">k</span> <span class="free">X</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Predict_π_fix<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> Complete_subset_π<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete <span class="free">k</span> <span class="free">X</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"setmonotone <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_regular regular_implies_setmonotone<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_setmonotone<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>Complete <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complete_regular regular_implies_mono<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complete <span class="free">k</span> <span class="free">X</span> <span class="main">⊆</span> Complete <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoD<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Complete <span class="free">k</span> <span class="free">X</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complete_π_fix<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> inc_inc_dot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inc_dot <span class="free">a</span> <span class="main">(</span>inc_dot <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> inc_dot <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> thmD6_Left<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span> <span class="main">⟹</span> item_β <span class="free">x</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="free">ω</span> <span class="main">⟹</span> item_end <span class="free">x</span> <span class="main">=</span> <span class="free">k</span> <span class="main">⟹</span> 
  LeftDerivation <span class="free">δ</span> <span class="free">D</span> <span class="main">[]</span> <span class="main">⟹</span> inc_dot <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="free">x</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">D</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ω</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">δ</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> length <span class="skolem">δ</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> length <span class="skolem">δ</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases3<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_regular elem_setmonotone regular_implies_setmonotone<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">N</span><span class="main">.</span> <span class="skolem">δ</span> <span class="main">=</span> <span class="main">[</span><span class="bound">N</span><span class="main">]</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def append_self_conv2 drop_all id_take_nth_drop 
            le_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> lessI take_0<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∈</span> set <span class="skolem">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_nonterminal_N<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derivation_empty_no_terminals 
          LeftDerivation_implies_Derivation less.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivation.elims<span class="main">(</span>2<span class="main">)</span> N less.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e</span> <span class="bound">E</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">=</span> <span class="bound">e</span><span class="main">#</span><span class="bound">E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivation.elims<span class="main">(</span>2<span class="main">)</span> less.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> eE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">γ</span><span class="main">.</span> LeftDerives1 <span class="skolem">δ</span> <span class="main">(</span>fst <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="bound">γ</span> <span class="main">∧</span> 
          LeftDerivation <span class="bound">γ</span> <span class="skolem">E</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivation.simps<span class="main">(</span>2<span class="main">)</span> less.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">δ</span> <span class="main">(</span>fst <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="skolem">γ</span> <span class="main">∧</span> LeftDerivation <span class="skolem">γ</span> <span class="skolem">E</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> N <span class="keyword1"><span class="command">have</span></span> γ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.hyps"</span> Derives1_split LeftDerives1_def One_nat_def append_Cons 
            append_Nil append_Nil2 leftmost_def length_0_conv less_nat_zero_code linorder_neqE_nat 
            list.inject not_less_eq<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> next_symbol_x<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">N</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> N less.prems<span class="main">(</span>1<span class="main">)</span> less.prems<span class="main">(</span>2<span class="main">)</span> next_symbol_def next_symbol_starts_item_β 
            wellformed_complete_item_β <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
        <span class="keyword1"><span class="command">have</span></span> x_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> π_regular regular_implies_setmonotone subset_setmonotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"init_item <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> Predict <span class="free">k</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Predict_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">using</span></span> Derives1_rule LeftDerives1_implies_Derives1 γ <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Derives1_split LeftDerives1_def N γ 
              append.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> append.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bin_def is_nonterminal_N leftmost_cons_nonterminal 
              leftmost_unique length_greater_0_conv less.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_nat_zero_code 
              list.inject mem_Collect_eq next_symbol_x singletonI<span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Predict_subset_π <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
       <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inc_dot <span class="main">(</span>length <span class="skolem">γ</span><span class="main">)</span> <span class="var">?y</span>"</span></span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_dot <span class="var">?y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"item_rhs <span class="var">?y</span> <span class="main">=</span> <span class="skolem">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_def<span class="main">)</span>
       <span class="keyword1"><span class="command">note</span></span> y_props <span class="main">=</span> this
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wellformed_y<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="var">?y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Derives1_rule LeftDerives1_implies_Derives1 γ less.prems<span class="main">(</span>1<span class="main">)</span> less.prems<span class="main">(</span>3<span class="main">)</span> 
          wellformed_init_item wellformed_item_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
       <span class="keyword1"><span class="command">with</span></span> y_props <span class="keyword1"><span class="command">have</span></span> wellformed_z<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="var">?z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_inc_dot<span class="main">)</span>
       <span class="keyword1"><span class="command">have</span></span> item_β_y<span class="main">:</span> <span class="quoted"><span class="quoted">"item_β <span class="var">?y</span> <span class="main">=</span> <span class="skolem">γ</span> <span class="main">@</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> item_rhs_split y_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">have</span></span> is_complete_z<span class="main">:</span> <span class="quoted"><span class="quoted">"is_complete <span class="var">?z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_complete_def γ_def<span class="main">)</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="var">?y</span><span class="main">}</span>"</span></span> 
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> D<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">E</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eE wellformed_y γ<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
       <span class="keyword1"><span class="command">with</span></span> y_dom <span class="keyword1"><span class="command">have</span></span> z_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> π_subset_elem_trans empty_subsetI insert_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
       <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inc_dot <span class="main">(</span>length <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> 
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">∈</span> Complete <span class="free">k</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="var">?z</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complete_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> disjI2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def inc_item_def less<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bin_def less is_complete_z next_symbol_x<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_split LeftDerives1_def N γ append_Cons append_self_conv2 
          is_nonterminal_N leftmost_cons_nonterminal leftmost_unique length_0_conv list.inject<span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="var">?z</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Complete_subset_π <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> π_subset_elem_trans insert_subset x_subset z_dom<span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">N</span> <span class="bound">α</span><span class="main">.</span> <span class="skolem">δ</span> <span class="main">=</span> <span class="main">[</span><span class="bound">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">α</span>"</span></span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil count_terminals.cases le0 le_0_eq list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
           numeral_le_iff semiring_norm<span class="main"><span class="main">(</span></span>69<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword1"><span class="command">have</span></span> α_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> One_nat_def Suc_eq_plus1 append_Nil2 impossible_Cons length_Cons 
          list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_1_add_1<span class="main">)</span> 
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">α</span><span class="main">)</span> <span class="skolem">D</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> δ_split less.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
       <span class="keyword1"><span class="command">from</span></span> LeftDerivation_breakdown<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> 
       <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">[]</span> <span class="main">∧</span> LeftDerivation <span class="skolem">α</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="skolem">n</span> <span class="skolem">D</span>"</span></span>
       <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="var">?E</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="skolem">D</span>"</span></span>
       <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">α</span> <span class="var">?F</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">have</span></span> length_add<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?E</span> <span class="main">+</span> length <span class="var">?F</span> <span class="main">=</span> length <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_E_0<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?E</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F α_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_F_0<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?F</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">from</span></span> length_add length_E_0 length_F_0 
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?E</span> <span class="main">&lt;</span> length <span class="skolem">D</span> <span class="main">∧</span> length <span class="var">?F</span> <span class="main">&lt;</span> length <span class="skolem">D</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> add.commute nat_add_left_cancel_less nat_neq_iff not_add_less2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_E<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?E</span> <span class="main">&lt;</span> length <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> length_F<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?F</span> <span class="main">&lt;</span> length <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
       <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inc_dot <span class="main">(</span>length <span class="main">[</span><span class="skolem">N</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
       <span class="keyword1"><span class="command">have</span></span> y_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> D<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?E</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ω<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">α</span></span><span class="main"><span class="main">@</span></span><span class="skolem"><span class="skolem">ω</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> length_E<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less δ_split E<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inc_dot <span class="main">(</span>length <span class="skolem">α</span><span class="main">)</span> <span class="var">?y</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> wellformed_y<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="var">?y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> δ_split is_complete_def less.prems<span class="main">(</span>1<span class="main">)</span> less.prems<span class="main">(</span>2<span class="main">)</span> wellformed_complete_item_β 
          wellformed_inc_dot <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="var">?y</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> D<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?F</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ω<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">ω</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> length_F<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wellformed_y<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F less<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> δ_split add.commute append_assoc append_eq_conv_conj drop_drop inc_dot_dot 
          inc_dot_rhs item_β_def length_Cons less.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> π_subset_elem_trans y_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">=</span> inc_dot <span class="main">(</span>length <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> δ_split<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> z_dom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> derives_empty_implies_LeftDerivation<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="free">δ</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">D</span><span class="main">.</span> LeftDerivation <span class="free">δ</span> <span class="bound">D</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> derives_implies_leftderives is_word_def leftderives_implies_LeftDerivation 
    list.pred_inject<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">lemma</span></span> thmD6<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span> <span class="main">⟹</span> item_β <span class="free">x</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="free">ω</span> <span class="main">⟹</span> item_end <span class="free">x</span> <span class="main">=</span> <span class="free">k</span> <span class="main">⟹</span> 
  derives <span class="free">δ</span> <span class="main">[]</span> <span class="main">⟹</span> inc_dot <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="free">x</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> derives_empty_implies_LeftDerivation thmD6_Left <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD7">
<div class="head">
<h1>Theory TheoremD7</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD7
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD6.html">TheoremD6</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_keep_first_terminal<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">u</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">v</span><span class="main">)</span> <span class="main">⟹</span> is_terminal <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_leftmost Derives1_take leftmost_cons_terminal list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_le take_Cons'<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Derives1_nonterminal_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">u</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">N</span><span class="main">#</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u'</span> <span class="bound">M</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="bound">M</span><span class="main">#</span><span class="bound">u'</span> <span class="main">∧</span> is_nonterminal <span class="bound">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> nonempty_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_bound less_nat_zero_code list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u'</span> <span class="bound">M</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="bound">M</span><span class="main">#</span><span class="bound">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> count_terminals.cases nonempty_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">M</span><span class="main">#</span><span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> is_sentence_u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> Derives1_sentence1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_terminal <span class="skolem">M</span> <span class="main">∨</span> is_nonterminal <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_sentence_cons is_symbol_distinct split_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_terminal <span class="free">N</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span> Derives1_keep_first_terminal 
        assms<span class="main">(</span>1<span class="main">)</span> split_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> is_terminal_nonterminal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">with</span></span> split_u <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sentence_starts_with_nonterminal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derives <span class="free">u</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">X</span> <span class="bound">r</span><span class="main">.</span> <span class="free">u</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">=</span> <span class="bound">X</span><span class="main">#</span><span class="bound">r</span> <span class="main">∧</span> is_nonterminal <span class="bound">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">X</span> <span class="bound">r</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="bound">X</span><span class="main">#</span><span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> count_terminals.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> Xr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> count_terminals.simps derives_count_terminals_leq 
      derives_is_sentence is_sentence_cons is_symbol_distinct not_le zero_less_Suc<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> Xr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_nonterminal_head'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">u</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">v1</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">v2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derives <span class="free">v1</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u'</span> <span class="bound">M</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="bound">M</span><span class="main">#</span><span class="bound">u'</span> <span class="main">∧</span> is_nonterminal <span class="bound">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sentence_starts_with_nonterminal<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">#</span> <span class="skolem">r</span> <span class="main">∧</span> is_nonterminal <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_nonterminal_head append_Cons append_assoc assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>   
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> thmD7_helper<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="free">D</span> <span class="main">(</span><span class="free">N</span><span class="main">#</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔖</span> <span class="main">≠</span> <span class="free">N</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="bound">M</span> <span class="bound">a</span> <span class="bound">a1</span> <span class="bound">a2</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="bound">M</span><span class="main">#</span><span class="bound">w</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="bound">a</span> <span class="main">=</span> <span class="bound">a1</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">a2</span> <span class="main">∧</span> derives <span class="bound">a1</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="bound">u</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> derives <span class="bound">u</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ex_minimal_witness<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minimal <span class="skolem">K</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> nonzero_K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> Minimal <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">=</span> <span class="bound">u</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="bound">v</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> LeftDerivation.simps<span class="main">(</span>1<span class="main">)</span> take_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> Minimal<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="skolem">K</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∧</span> derives <span class="skolem">u</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> nonzero_K <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">K</span> <span class="free">D</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Minimal.hyps<span class="main">(</span>2<span class="main">)</span> less_nat_zero_code nat_neq_iff take_eq_Nil uv <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">E</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span>take <span class="skolem">K</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="bound">E</span><span class="main">@</span><span class="main">[</span><span class="bound">e</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rev_exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ee<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">K</span> <span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> uv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">E</span> <span class="bound">x</span> <span class="main">∧</span> LeftDerives1 <span class="bound">x</span> <span class="main">(</span>fst <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivation_append<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">E</span> <span class="skolem">x</span> <span class="main">∧</span> LeftDerives1 <span class="skolem">x</span> <span class="main">(</span>fst <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w</span> <span class="bound">M</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">M</span><span class="main">#</span><span class="bound">w</span> <span class="main">∧</span> is_nonterminal <span class="bound">M</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Derives1_nonterminal_head' LeftDerives1_implies_Derives1 assms<span class="main">(</span>2<span class="main">)</span> uv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">M</span><span class="main">#</span><span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> is_nonterminal_M<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> Ee nonzero_K <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">D</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Minimal.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_snoc butlast_take dual_order.strict_implies_order 
          le_less_linear take_all uv<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftmost <span class="main">(</span>fst <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span><span class="main">#</span><span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x LeftDerives1_def split_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">with</span></span> is_nonterminal_M <span class="keyword1"><span class="command">have</span></span> fst_e<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_cons_nonterminal leftmost_unique<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="skolem">x</span> <span class="main">0</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LeftDerives1_implies_Derives1 fst_e x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">have</span></span> x_splits_at<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="skolem">x</span> <span class="main">0</span> <span class="main">[]</span> <span class="skolem">M</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_x splits_at_def<span class="main">)</span>       
      <span class="keyword1"><span class="command">from</span></span> Derives1 x_splits_at 
      <span class="keyword1"><span class="command">have</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="bound">p</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">=</span> <span class="bound">q</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Derives1_X_is_part_of_rule<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suffix <span class="skolem">α</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prefix <span class="skolem">β</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> derives_β<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="skolem">β</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Derives1_implies_derives1 derives1_implies_derives derives_trans uv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">with</span></span> Prefix<span class="main">(</span>1<span class="main">)</span> x Minimal E nonzero_K <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> diff_less less_nat_zero_code less_one nat_neq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="free">N</span> <span class="main">#</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> M_def<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">M</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Derives1 Derives1_nonterminal x_splits_at <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">K</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">M</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1 Derives1_rule E Ee M_def One_nat_def Suc_pred pq append_Nil 
          append_same_eq dual_order.strict_implies_order le_less_linear nonzero_K not_Cons_self2 
          not_gr0 not_less_eq prod.collapse q self_append_conv split_x take_all uv x<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1"><span class="command">lemma</span></span> head_of_item_β_is_next_symbol<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span> <span class="main">⟹</span> item_β <span class="free">x</span> <span class="main">=</span> <span class="free">t</span><span class="main">#</span><span class="free">δ</span> <span class="main">⟹</span> next_symbol <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> next_symbol_def next_symbol_starts_item_β wellformed_complete_item_β <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
 
<span class="keyword1"><span class="command">lemma</span></span> next_symbol_predicts<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="free">x</span> <span class="main">=</span> Some <span class="free">N</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">=</span> item_end <span class="free">x</span> <span class="main">⟹</span> 
  init_item <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="free">k</span> <span class="main">∈</span> Predict <span class="free">k</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Predict_def bin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> thmD7_LeftDerivation<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="free">D</span> <span class="main">(</span><span class="free">N</span><span class="main">#</span><span class="free">γ</span><span class="main">)</span> <span class="main">⟹</span> is_nonterminal <span class="free">N</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">⟹</span> 
  init_item <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="main">0</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> Init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">D</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">γ</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?trivial</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">𝔖</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?trivial</span> <span class="main">∨</span> <span class="main">¬</span> <span class="var">?trivial</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"init_item <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">0</span> <span class="main">∈</span> Init"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Init_def<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> π_regular contra_subsetD regular_implies_setmonotone subset_setmonotone<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> thmD7_helper<span class="main">[</span><span class="operator">OF</span> less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 2<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  
          <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">a2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"derives <span class="skolem">a1</span> <span class="main">[]</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">note</span></span> M <span class="main">=</span> this
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"init_item <span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> x_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> Init"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ M<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> _ M<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> M<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">using</span></span> M<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inc_dot <span class="main">(</span>length <span class="skolem">a1</span><span class="main">)</span> <span class="var">?x</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> <span class="main">{</span><span class="var">?x</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> thmD6<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ω<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">N</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">a2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> wellformed_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> x_dom <span class="keyword1"><span class="command">have</span></span> y_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> Init"</span></span>
          <span class="keyword1"><span class="command">using</span></span> π_subset_elem_trans empty_subsetI insert_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> wellformed_y<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> M<span class="main">(</span>4<span class="main">)</span> wellformed_inc_dot wellformed_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>          
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_β <span class="var">?y</span> <span class="main">=</span> <span class="skolem">N</span><span class="main">#</span><span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> item_β_def<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> next_symbol_y<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="var">?y</span> <span class="main">=</span> Some <span class="skolem">N</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> head_of_item_β_is_next_symbol wellformed_y<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"init_item <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> Predict <span class="main">0</span> <span class="main">{</span><span class="var">?y</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> next_symbol_predicts next_symbol_y<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> <span class="main">{</span><span class="var">?y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Predict_subset_π <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> y_dom <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> Init"</span></span>
          <span class="keyword1"><span class="command">using</span></span> π_subset_elem_trans empty_subsetI insert_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>      
 
<span class="keyword1"><span class="command">theorem</span></span> thmD7<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span><span class="free">N</span><span class="main">#</span><span class="free">γ</span><span class="main">)</span> <span class="main">⟹</span> is_nonterminal <span class="free">N</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">⟹</span> 
  init_item <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="main">0</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> Init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℒ<span class="hidden">⇩</span><sub>P</sub>_is_word derives_implies_leftderives_cons empty_in_ℒ<span class="hidden">⇩</span><sub>P</sub> is_derivation_def 
  leftderives_implies_LeftDerivation self_append_conv2 thmD7_LeftDerivation<span class="main">)</span>
         
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD8">
<div class="head">
<h1>Theory TheoremD8</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD8
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD7.html">TheoremD7</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_tokens_empty_path<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_tokens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒫_0_0_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>𝒫 <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> wellformed_item <span class="bound">x</span> <span class="main">∧</span> item_origin <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> item_end <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
  derives <span class="main">(</span>item_α <span class="bound">x</span><span class="main">)</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">γ</span><span class="main">.</span> is_derivation <span class="main">(</span><span class="main">[</span>item_nonterminal <span class="bound">x</span><span class="main">]</span> <span class="main">@</span> <span class="bound">γ</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gen_def pvalid_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Init_subset_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"Init <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="main">0</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 𝒫_0_0_Gen<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Init_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_derivation_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒥_0_0_subset_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒥 <span class="main">0</span> <span class="main">0</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="main">0</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 𝒥.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> thmD5<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Init_subset_Gen<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inc_dot_rule<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_rule <span class="main">(</span>inc_dot <span class="free">d</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> item_rule <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_item_rule<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_rule <span class="main">(</span>init_item <span class="free">r</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_item_def<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> item_dot_is_α_length<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span> <span class="main">⟹</span> item_dot <span class="free">x</span> <span class="main">=</span> length <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_α_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_absorb2 wellformed_item_def<span class="main">)</span> 
  
<span class="keyword1"><span class="command">lemma</span></span> Gen_subset_𝒥_0_0_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"item_origin <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"item_end <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derives <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_derivation <span class="main">(</span>item_nonterminal <span class="free">x</span> <span class="main">#</span> <span class="free">γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> Init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"init_item <span class="main">(</span>item_nonterminal <span class="free">x</span><span class="main">,</span> item_rhs <span class="free">x</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> y_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> Init"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> thmD7<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> is_nonterminal_item_nonterminal <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_nonterminal_def item_rhs_def wellformed_item_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inc_dot <span class="main">(</span>length <span class="main">(</span>item_α <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="var">?y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"item_rule <span class="free">x</span> <span class="main">=</span> item_rule <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_nonterminal_def item_rhs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"item_dot <span class="free">x</span> <span class="main">=</span> item_dot <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> item_dot_is_α_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> x3<span class="main">:</span> <span class="quoted"><span class="quoted">"item_origin <span class="free">x</span> <span class="main">=</span> item_origin <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="free">x</span> <span class="main">=</span> item_end <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x1 x2 x3 x4 <span class="keyword1"><span class="command">have</span></span> x_is_inc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> item.expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> wellformed_item_y<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="var">?y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> item_nonterminal_def item_rhs_def wellformed_item_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> π <span class="main">0</span> <span class="main">{}</span> <span class="main">{</span><span class="var">?y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> x_is_inc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> thmD6<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_item_y<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_rhs_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> y_dom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> π_subset_elem_trans empty_subsetI insert_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>        

<span class="keyword1"><span class="command">lemma</span></span> Gen_subset_𝒥_0_0<span class="main">:</span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>𝒫 <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊆</span> 𝒥 <span class="main">0</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 𝒫_0_0_Gen<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> Gen_subset_𝒥_0_0_helper <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">theorem</span></span> thmD8<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒥 <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> Gen <span class="main">(</span>𝒫 <span class="main">0</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Gen_subset_𝒥_0_0 𝒥_0_0_subset_Gen <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD9">
<div class="head">
<h1>Theory TheoremD9</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD9
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD8.html">TheoremD8</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">items_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> items <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">items_le</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> item_end <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">items_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> items <span class="main">⇒</span> items"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">items_eq</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> item_end <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">paths_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> tokens set <span class="main">⇒</span> tokens set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">paths_le</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> charslength <span class="bound">p</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">paths_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> tokens set <span class="main">⇒</span> tokens set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">paths_eq</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> charslength <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_pointwise<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise <span class="main">(</span>items_le <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_def items_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_is_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> items_eq_pointwise<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise <span class="main">(</span>items_eq <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_def items_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> items_eq_is_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"items_eq <span class="free">k</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> paths_le_pointwise<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise <span class="main">(</span>paths_le <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_def paths_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> paths_le_continuous<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span>paths_le <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_le_pointwise pointbased_implies_continuous pointwise_implies_pointbased<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> paths_le_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>paths_le <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_imp_mono paths_le_continuous<span class="main">)</span>
   
<span class="keyword1"><span class="command">lemma</span></span> paths_le_is_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"paths_le <span class="free">k</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> paths_eq_pointwise<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise <span class="main">(</span>paths_eq <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_def paths_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> paths_eq_is_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"paths_eq <span class="free">k</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Predict_item_end<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Predict <span class="free">k</span> <span class="free">Y</span> <span class="main">⟹</span> item_end <span class="free">x</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Predict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Complete_item_end<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Complete <span class="free">k</span> <span class="free">Y</span> <span class="main">⟹</span> item_end <span class="free">x</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Complete_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒥_0_0_item_end<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒥 <span class="main">0</span> <span class="main">0</span> <span class="main">⟹</span> item_end <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> limit_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Init <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Init_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Iterate <span class="skolem">x</span> <span class="skolem">Y</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Complete <span class="main">0</span> <span class="main">(</span>Predict <span class="main">0</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Scan_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> Predict <span class="main">0</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Complete_item_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Predict_item_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Iterate <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_𝒥_0_0<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="main">0</span> <span class="main">(</span>𝒥 <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> 𝒥 <span class="main">0</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LocalLexing.𝒥_0_0_item_end LocalLexing.items_le_def LocalLexing_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> paths_le_𝒫_0_0<span class="main">:</span> <span class="quoted"><span class="quoted">"paths_le <span class="main">0</span> <span class="main">(</span>𝒫 <span class="main">0</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> 𝒫 <span class="main">0</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_tokens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token set <span class="main">⇒</span> token set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_tokens</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_Predict<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>Predict <span class="free">k</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> Predict <span class="free">k</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_def Predict_def bin_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_Complete<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"wellformed_items <span class="free">I</span> <span class="main">⟹</span> items_le <span class="free">k</span> <span class="main">(</span>Complete <span class="free">k</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> Complete <span class="free">k</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_def Complete_def bin_def is_complete_def wellformed_items_def 
    wellformed_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_Scan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> Scan <span class="main">(</span>empty_tokens <span class="free">T</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_def Scan_def bin_def empty_tokens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>Gen <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Gen_implies_pvalid pvalid_def wellformed_items_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">lemma</span></span> wellformed_𝒥_0_0<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>𝒥 <span class="main">0</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> thmD8 wellformed_items_Gen <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_Predict<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"wellformed_items <span class="free">I</span> <span class="main">⟹</span> wellformed_items <span class="main">(</span>Predict <span class="free">k</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_def wellformed_item_def Predict_def bin_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_Complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wellformed_items <span class="free">I</span> <span class="main">⟹</span> wellformed_items <span class="main">(</span>Complete <span class="free">k</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_def wellformed_item_def Complete_def bin_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> is_complete_def next_symbol_not_complete not_less_eq_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒳_length_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> 𝒳 <span class="free">k</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">+</span> length <span class="free">c</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 𝒳_is_prefix is_prefix_length not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_Scan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wellformed_items <span class="free">I</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span> <span class="main">⟹</span> wellformed_items <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_def wellformed_item_def Scan_def bin_def 𝒳_length_bound<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> is_complete_def next_symbol_not_complete not_less_eq_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_π<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">item</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span> <span class="main">⟹</span> wellformed_item <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> limit_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Init <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Iterate <span class="skolem">x</span> <span class="skolem">Y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Iterate.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wellformed_items_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Complete <span class="free">k</span> <span class="main">(</span>Predict <span class="free">k</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wellformed_items_Complete wellformed_items_Predict 
          wellformed_items_Scan<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Iterate.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wellformed_items_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wellformed_items_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1"><span class="command">lemma</span></span> 𝒥_subset_Suc_u<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒥 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> 𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Complete_π_fix Complete_subset_π 𝒥.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 𝒥.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 𝒥.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not0_implies_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_TokensAt<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>TokensAt <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def TokensAt_def bin_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> 𝒯_subset_TokensAt<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> TokensAt <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Tokens <span class="free">k</span> <span class="main">(</span>𝒯 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">Sel</span> <span class="main">(</span>𝒯 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>TokensAt <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tokens_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Sel</span> <span class="main">(</span>𝒯 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>TokensAt <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> TokensAt <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sel_upper_bound Suc.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆</span> TokensAt <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> 𝒥_subset_Suc_u mono_TokensAt mono_subset_elem subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1"><span class="command">lemma</span></span> TokensAt_subset_𝒳<span class="main">:</span> <span class="quoted"><span class="quoted">"TokensAt <span class="free">k</span> <span class="free">I</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> TokensAt_def 𝒳_def is_terminal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_𝒥_induct_u<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">item</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> wellformed_item <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> limit_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Init <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Iterate <span class="skolem">p</span> <span class="skolem">Y</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Iterate<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wellformed_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="skolem">Y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>Complete <span class="free">k</span> <span class="main">(</span>Predict <span class="free">k</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_Complete wellformed_items_Predict<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>Scan <span class="main">(</span>Tokens <span class="free">k</span> <span class="main">(</span>𝒯 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span>Complete <span class="free">k</span> <span class="main">(</span>Predict <span class="free">k</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> wellformed_items_Scan<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tokens_def<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Sel_upper_bound TokensAt_subset_𝒳 𝒯_subset_TokensAt subset_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Iterate.hyps<span class="main">(</span>2<span class="main">)</span> wellformed_items_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wellformed_items_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_𝒥_k_u_if_0<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> wellformed_items <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> wellformed_items_𝒥_induct_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_natUnion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> wellformed_items <span class="main">(</span><span class="free">I</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> wellformed_items <span class="main">(</span>natUnion <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_def wellformed_items_def<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_ℐ_k_if_0<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> wellformed_items <span class="main">(</span>ℐ <span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wellformed_items_natUnion<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> wellformed_items_𝒥_k_u_if_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 
<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_𝒥_ℐ<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">∧</span> wellformed_items <span class="main">(</span>ℐ <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> wellformed_𝒥_0_0 wellformed_items_ℐ_k_if_0 wellformed_items_𝒥_k_u_if_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>𝒥 <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps wellformed_items_π <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> wellformed_items_ℐ_k_if_0 wellformed_items_𝒥_k_u_if_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_𝒥<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_𝒥_ℐ<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_items_ℐ<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>ℐ <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> wellformed_items_𝒥_ℐ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> funpower_consume_function<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">g</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>funpower <span class="free">g</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">(</span>funpower <span class="free">g</span> <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> funpower <span class="free">h</span> <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> S1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>funpower <span class="free">g</span> <span class="skolem">n</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>funpower <span class="free">g</span> <span class="skolem">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> funpower <span class="free">h</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">f</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> law1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> law <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> law2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">X</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">g</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> law <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> law1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"funpower <span class="free"><span class="free">g</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="free"><span class="free">I</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> S2<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> law2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> limit_consume_function<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> continuous<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> law<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">g</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> setmonotone<span class="main">:</span> <span class="quoted"><span class="quoted">"setmonotone <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>limit <span class="free">g</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> limit <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>limit <span class="free">g</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> funpower <span class="free">g</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> funpower <span class="free">g</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setmonotone setmonotone_implies_chain_funpower<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> continuous_apply<span class="main">[</span><span class="operator">OF</span> continuous this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> funpower <span class="free">g</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> funpower <span class="free">g</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> funpower <span class="free">g</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>funpower <span class="free">g</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>funpower <span class="free">g</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">h</span> <span class="bound">n</span> <span class="main">(</span><span class="free">f</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> funpower_consume_function<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> law<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> funpower <span class="free">g</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">h</span> <span class="bound">n</span> <span class="main">(</span><span class="free">f</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> swap <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> funpower <span class="free">g</span> <span class="bound">n</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">h</span> <span class="bound">n</span> <span class="main">(</span><span class="free">f</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> funpower <span class="free">h</span> <span class="bound">n</span> <span class="main">(</span><span class="free">f</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> limit <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> limit_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 2 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_π_swap<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed_I<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> π <span class="free">k</span> <span class="main">(</span>empty_tokens <span class="free">T</span><span class="main">)</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Complete <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Predict <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Scan <span class="main">(</span>empty_tokens <span class="free">T</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Complete <span class="free">k</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Predict <span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> law1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">I</span><span class="main">.</span> wellformed_items <span class="bound">I</span> <span class="main">⟹</span> items_le <span class="free">k</span> <span class="main">(</span><span class="var">?g</span> <span class="bound">I</span><span class="main">)</span> <span class="main">=</span> <span class="var">?h</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LocalLexing.wellformed_items_Predict LocalLexing_axioms items_le_Complete 
      items_le_Predict items_le_Scan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> law2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">I</span><span class="main">.</span> wellformed_items <span class="bound">I</span> <span class="main">⟹</span> wellformed_items <span class="main">(</span><span class="var">?g</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T wellformed_items_Complete wellformed_items_Predict wellformed_items_Scan<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> π_functional<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> limit_consume_function<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"wellformed_items"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_pointwise pointbased_implies_continuous pointwise_implies_pointbased<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> law1 law2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_step_regular regular_implies_setmonotone<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wellformed_I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> π_functional<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> items_le_idempotent<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> items_le <span class="free">k</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> items_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">lemma</span></span> paths_le_idempotent<span class="main">:</span> <span class="quoted"><span class="quoted">"paths_le <span class="free">k</span> <span class="main">(</span>paths_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> paths_le <span class="free">k</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> paths_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_fix_D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> items_le_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"item_end <span class="free">x</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> items_le_def items_le_fix x_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> remove_paths_le_in_subset_Gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> Gen <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">item</span>
    <span class="keyword3"><span class="command">assume</span></span> x_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_item_end<span class="main">:</span>  <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms items_le_fix_D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Gen <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms x_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> pvalid <span class="skolem">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Gen_implies_pvalid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> charslength_p<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p pvalid_item_end x_item_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> paths_le <span class="free">k</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p paths_le_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Gen_def p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"mono Gen"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def Gen_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_tokens_idempotent<span class="main">:</span> <span class="quoted"><span class="quoted">"empty_tokens <span class="main">(</span>empty_tokens <span class="free">T</span><span class="main">)</span> <span class="main">=</span> empty_tokens <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_tokens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_tokens_is_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"empty_tokens <span class="free">T</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_tokens_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_paths_le<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>Gen <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LocalLexing.Gen_def LocalLexing.items_le_def LocalLexing_axioms paths_le_def 
  pvalid_item_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      

<span class="keyword1"><span class="command">lemma</span></span> bin_items_le<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bin <span class="free">I</span> <span class="free">k</span> <span class="main">=</span> bin <span class="main">(</span>items_le <span class="free">k</span> <span class="free">I</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bin_def items_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> TokensAt_items_le<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"TokensAt <span class="free">k</span> <span class="free">I</span> <span class="main">=</span> TokensAt <span class="free">k</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> TokensAt_def bin_items_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> by_length_paths_le<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"by_length <span class="free">k</span> <span class="free">P</span> <span class="main">=</span> by_length <span class="free">k</span> <span class="main">(</span>paths_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> by_length.simps paths_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒲_paths_le<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝒲 <span class="free">P</span> <span class="free">k</span> <span class="main">=</span> 𝒲 <span class="main">(</span>paths_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 𝒲_def by_length_paths_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> 𝒯_equals_𝒵_induct_step<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct_tokens<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TokensAt <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> TokensAt <span class="free">k</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> TokensAt_items_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TokensAt <span class="free">k</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> TokensAt <span class="free">k</span> <span class="main">(</span>Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> TokensAt_le<span class="main">:</span> <span class="quoted"><span class="quoted">"TokensAt <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> TokensAt <span class="free">k</span> <span class="main">(</span>Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TokensAt <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> 𝒲 <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> TokensAt_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 𝒲_paths_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> thmD4<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 𝔓_covers_𝒫 paths_le_is_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> induct_tokens Tokens_def 𝒴_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">theorem</span></span> thmD9<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct_tokens<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> items_le <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="main">(</span>𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="main">(</span>𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    π <span class="free">k</span> <span class="main">(</span>empty_tokens <span class="main">(</span>𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> items_le_π_swap<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_𝒥<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> TokensAt_subset_𝒳 𝒯_subset_TokensAt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> t3<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="main">(</span>empty_tokens <span class="main">(</span>𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    π <span class="free">k</span> <span class="main">(</span>empty_tokens <span class="main">(</span>𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 𝒫_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> 𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_𝒫Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">⊆</span> paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_subset_elem paths_le_mono subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mono_Gen <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_subset_elem subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t4<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="main">(</span>empty_tokens <span class="main">(</span>𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
    π <span class="free">k</span> <span class="main">(</span>empty_tokens <span class="main">(</span>𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_π<span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 𝒯_eq_𝒵<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝒯_equals_𝒵_induct_step assms<span class="main">(</span>1<span class="main">)</span> induct_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> t5<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="main">(</span>empty_tokens <span class="main">(</span>𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 
    Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> remove_paths_le_in_subset_Gen<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> items_le_π_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> wellformed_items_Gen <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> 𝒯_eq_𝒵 𝒵_subset_𝒳 empty_tokens_is_filter <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> empty_tokens_idempotent paths_le_idempotent items_le_paths_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> thmD5<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> items_le_is_filter items_le_paths_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> k<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 𝒯_eq_𝒵 empty_tokens_is_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> t1 t2 t3 t4 t5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subset_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>      
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ladder">
<div class="head">
<h1>Theory Ladder</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Ladder
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD9.html">TheoremD9</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LeftDerivationFix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> nat <span class="main">⇒</span> derivation <span class="main">⇒</span> nat <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LeftDerivationFix</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> <span class="main">(</span>is_sentence <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> is_sentence <span class="free"><span class="bound"><span class="entity">β</span></span></span> 
     <span class="main">∧</span> LeftDerivation <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">β</span></span></span>
     <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">E</span> <span class="bound">F</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="bound">E</span><span class="main">@</span><span class="main">(</span>derivation_shift <span class="bound">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
       LeftDerivation <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="bound">E</span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">∧</span>
       LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="bound">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LeftDerivationIntro</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> nat <span class="main">⇒</span> rule <span class="main">⇒</span> nat <span class="main">⇒</span> derivation <span class="main">⇒</span> nat <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LeftDerivationIntro</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ix</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">β</span><span class="main">.</span> LeftDerives1 <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">β</span> <span class="main">∧</span>  
     <span class="free"><span class="bound"><span class="entity">ix</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">ix</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span>
     LeftDerivationFix <span class="bound">β</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">ix</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">α</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">α</span> <span class="main">⟹</span> LeftDerivationFix <span class="free">α</span> <span class="free">i</span> <span class="main">[]</span> <span class="free">i</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derive_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Derive <span class="free">a</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derive_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_append1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="bound">b</span> 
  <span class="main">∧</span> LeftDerives1 <span class="bound">b</span> <span class="free">i</span> <span class="free">r</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivation_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_append1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> Derivation <span class="free">a</span> <span class="free">D</span> <span class="bound">b</span> 
  <span class="main">∧</span> Derives1 <span class="bound">b</span> <span class="free">i</span> <span class="free">r</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derivation_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  Derivation_take_derive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Derive <span class="free">a</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derivation_append Derive append_take_drop_id assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  LeftDerivation_take_derive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Derive <span class="free">a</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LeftDerivation_append LeftDerivation_implies_Derivation append_take_drop_id assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Derivation_Derive_take_Derives1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≤</span> length <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> Derive <span class="free">a</span> <span class="main">(</span>take <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> Derive <span class="free">a</span> <span class="main">(</span>take <span class="free">N</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">α</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="free">N</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D2</span> <span class="main">=</span> <span class="var">?D1</span> <span class="main">@</span> <span class="main">[</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq Suc_pred le_imp_less_Suc take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Derivation <span class="free">a</span> <span class="var">?D2</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derivation_take_derive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> app <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Derivation.simps Derivation_append Derive α <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_Derive_take_LeftDerives1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≤</span> length <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> Derive <span class="free">a</span> <span class="main">(</span>take <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> Derive <span class="free">a</span> <span class="main">(</span>take <span class="free">N</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">α</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="free">N</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D2</span> <span class="main">=</span> <span class="var">?D1</span> <span class="main">@</span> <span class="main">[</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq Suc_pred le_imp_less_Suc take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="var">?D2</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivation_take_derive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> app <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LeftDerivation_append1 LeftDerivation_implies_Derivation α prod.collapse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_skip_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> LeftDerives1 <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">c</span><span class="main">)</span> <span class="main">⟹</span> LeftDerives1 <span class="free">b</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span><span class="main">)</span> <span class="free">r</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerives1_def<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> leftmost_skip_prefix <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1_skip_prefix<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_skip_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">c</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">b</span><span class="main">@</span><span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> Derives1_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">@</span><span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">@</span><span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">N</span> <span class="bound">α</span><span class="main">.</span>
    <span class="free">a</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="bound">N</span><span class="main">]</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span>
    <span class="free">b</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">α</span> <span class="main">@</span> <span class="bound">y</span> <span class="main">∧</span> is_sentence <span class="bound">x</span> <span class="main">∧</span> is_sentence <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> length <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">∧</span>
     <span class="free">b</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">∧</span> is_sentence <span class="skolem">x</span> <span class="main">∧</span> is_sentence <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> length <span class="skolem">x</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> split <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">c</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">+</span> length <span class="free">c</span> <span class="main">=</span> length <span class="skolem">x</span> <span class="main">+</span> length <span class="skolem">y</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> split <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">+</span> length <span class="free">c</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> length <span class="skolem">y</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> len_c_y<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">c</span> <span class="main">≤</span> length <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">y</span> <span class="main">-</span> length <span class="free">c</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> split <span class="keyword1"><span class="command">have</span></span> ac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> cancel_suffix<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">@</span><span class="main">[</span><span class="skolem">N</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> ac len_c_y<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> split <span class="keyword1"><span class="command">have</span></span> bc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">@</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> cancel_suffix<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">@</span><span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> bc len_c_y<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@</span> <span class="skolem">α</span> <span class="main">@</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> split len_c_y a b <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> LeftDerives1_def Derives1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> D LeftDerives1_def i leftmost_cons_less <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_sentence_take<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_X_is_part_of_rule<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> Suffix Prefix<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> aXb<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">δ</span> <span class="free">i</span> <span class="free">α</span> <span class="free">N</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">β</span><span class="main">.</span> <span class="free">δ</span> <span class="main">=</span> <span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="bound">β</span> <span class="main">⟹</span> length <span class="free">a</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> is_word <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
                     LeftDerives1 <span class="bound">β</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">α</span><span class="main">.</span> <span class="free">δ</span> <span class="main">=</span> <span class="bound">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span> <span class="main">⟹</span> LeftDerives1 <span class="bound">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">a</span> <span class="main">⟹</span> False"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">@</span> <span class="free">β</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="bound">u</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> aXb_old<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerives1_implies_Derives1 aXb <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> prefix_or<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">α</span> <span class="free">a</span> <span class="main">∨</span> is_proper_prefix <span class="free">a</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_prefix split aXb_old is_prefix_eq_proper_prefix<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> is_word_α<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerives1_splits_at_is_word aXb assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_proper_prefix <span class="free">a</span> <span class="free">α</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> proper<span class="main">:</span><span class="quoted"><span class="quoted">"is_proper_prefix <span class="free">a</span> <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">=</span> <span class="free">a</span><span class="main">@</span><span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_proper_prefix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">=</span> <span class="free">a</span><span class="main">@</span><span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> splits_at <span class="main">=</span> splits_at_α<span class="main">[</span><span class="operator">OF</span> aXb_old split<span class="main">]</span> splits_at_combine<span class="main">[</span><span class="operator">OF</span> split<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> α1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> α2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> take <span class="free">i</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> lenα<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">α</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> proper <span class="keyword1"><span class="command">have</span></span> lena<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> append_eq_conv_conj drop_eq_Nil leI u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">with</span></span> is_word_α α2 <span class="keyword1"><span class="command">have</span></span> is_word_aX<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_word_terminals not_less take_Cons' u<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> u α2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">@</span><span class="skolem">u</span> <span class="main">=</span> take <span class="free">i</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> lena <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_or_eq_imp_le<span class="main">)</span> 
    <span class="keyword1"><span class="command">with</span></span> lena <span class="keyword1"><span class="command">have</span></span> uX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="main">(</span>take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less take_Cons'<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?β</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> u uX <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="var">?β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> skip <span class="main">=</span> LeftDerives1_skip_prefix<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="var">?β</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
      r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="var">?β</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">r</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> One_nat_def Suc_leI aXb append_assoc diff_diff_left f2 lena length_Cons 
        length_append length_append_singleton list.size<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">note</span></span> prefix<span class="main">[</span><span class="operator">OF</span> f2 lena is_word_aX D<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> prefix_or <span class="keyword1"><span class="command">have</span></span> is_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">α</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> aXb <span class="keyword1"><span class="command">have</span></span> aXb'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> aXb'_old<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">δ</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerives1_implies_Derives1<span class="main">)</span>  
  <span class="keyword1"><span class="command">note</span></span> Derives1_suffix<span class="main">[</span><span class="operator">OF</span> aXb'_old split<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> suffix_or<span class="main">:</span> <span class="quoted"><span class="quoted">"is_suffix <span class="free">β</span> <span class="free">b</span> <span class="main">∨</span> is_proper_suffix <span class="free">b</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_suffix_eq_proper_suffix<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_proper_suffix <span class="free">b</span> <span class="free">β</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> proper<span class="main">:</span> <span class="quoted"><span class="quoted">"is_proper_suffix <span class="free">b</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">β</span> <span class="main">=</span> <span class="bound">u</span><span class="main">@</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_proper_suffix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">β</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">@</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> splits_at <span class="main">=</span> splits_at_β<span class="main">[</span><span class="operator">OF</span> aXb_old split<span class="main">]</span> splits_at_combine<span class="main">[</span><span class="operator">OF</span> split<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> β1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> β2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> lenβ<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">β</span> <span class="main">=</span> length <span class="free">δ</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> proper <span class="keyword1"><span class="command">have</span></span> lenb<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">&lt;</span> length <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_proper_suffix_length_cmp<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> u β2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">@</span><span class="free">b</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_cancel_suffix<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> uX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_keep_last u<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?α</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> splits_at <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> u uX <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="var">?α</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> skip <span class="main">=</span> LeftDerives1_skip_suffix<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="var">?α</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
      r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">i</span> <span class="main">+</span> length <span class="free">b</span> <span class="main">=</span> length <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">+</span> length <span class="free">b</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1_left length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>22<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">δ</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> length <span class="main">(</span><span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> Suc <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f2 length_drop splits_at<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="main">[]</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">≠</span> length <span class="free">δ</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> length <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' append_Nil2 append_eq_append_conv lenβ length_append u<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="main">[]</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">≠</span> length <span class="free">α</span> <span class="main">+</span> length <span class="main">(</span><span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1_left add_diff_cancel_right' diff_diff_left length_append<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> aXb f2 <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="var">?α</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> skip<span class="main">[</span><span class="operator">OF</span> f3 D<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> suffix<span class="main">[</span><span class="operator">OF</span> f2  skip<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f3 D<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> suffix_or <span class="keyword1"><span class="command">have</span></span> is_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_suffix <span class="free">β</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> is_prefix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">α</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> is_suffix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free">b</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">@</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_suffix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">@</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">from</span></span> u v splits_at_combine<span class="main">[</span><span class="operator">OF</span> split<span class="main">]</span> aXb <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span><span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="main">(</span><span class="skolem">u</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="skolem">v</span><span class="main">)</span><span class="main">@</span><span class="free">β</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> splits_at_α<span class="main">[</span><span class="operator">OF</span> aXb_old split<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">α</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">α</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> LeftDerives1_skip_suffix<span class="main">[</span><span class="operator">OF</span> _ LeftDerives1_skip_prefix<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i1 D<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> i2<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">0</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="main">0</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="free">r</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_split append_Cons append_Nil length_0_conv list.inject self_append_conv<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> u v r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_grow_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LDF<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">b1</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> suffix_b2<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">suffix</span> <span class="free">e</span> <span class="free">r</span> <span class="free">b2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_word_b1X<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span><span class="free">b1</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">b1</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">suffix</span><span class="main">)</span> <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">e</span> <span class="main">+</span> length <span class="main">(</span><span class="free">b1</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="free">D</span><span class="main">)</span> <span class="free">j</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> LDF <span class="keyword1"><span class="command">have</span></span> LDF'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">b1</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b2</span><span class="main">)</span> <span class="main">∧</span> is_sentence <span class="free">c</span> <span class="main">∧</span> 
    LeftDerivation <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span> <span class="free">D</span> <span class="free">c</span> <span class="main">∧</span> length <span class="free">b1</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">c</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span> <span class="main">!</span> length <span class="free">b1</span> <span class="main">=</span> <span class="free">c</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">F</span><span class="main">.</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">E</span> <span class="main">@</span> derivation_shift <span class="bound">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>take <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="bound">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="bound">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> EF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>take <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> LD_b1_c<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">b1</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">with</span></span> is_word_b1X <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivation_implies_Derivation is_word_Derivation is_word_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">=</span> take <span class="free">j</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LD_b1_c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> length <span class="free">b1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LDF' dual_order.strict_implies_order min.absorb2<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> EF E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">suffix</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">e</span> <span class="main">+</span> length <span class="free">b1</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span> <span class="main">∧</span> 
    LeftDerivation  <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span> <span class="free">D</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LDF' LeftDerives1_append_prefix add_Suc_right append_assoc assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_word_b1X 
      length_append_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_sentence_b1Xsuffix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">suffix</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1_sentence1 LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> X_eq_cj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">c</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LDF' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> is_sentence_b1Xsuffix <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LDF' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LDF' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> X_eq_cj<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> b1_len<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> b1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">b2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suffix_b2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> EF <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derives1_append_suffix<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">v</span> <span class="free">i</span> <span class="free">r</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="free">u</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span><span class="main">.</span> splits_at <span class="free">v</span> <span class="free">i</span> <span class="bound">α</span> <span class="bound">N</span> <span class="bound">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms splits_at_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_v<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">v</span> <span class="free">i</span> <span class="skolem">α</span> <span class="skolem">N</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> split_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">@</span><span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">@</span><span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms split_v splits_at_combine_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> split_uv<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="free">u</span><span class="main">)</span> <span class="free">i</span> <span class="skolem">α</span> <span class="skolem">N</span> <span class="main">(</span><span class="skolem">β</span><span class="main">@</span><span class="free">u</span><span class="main">)</span>"</span></span>   
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_v splits_at_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> is_sentence_uv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1 Derives1_sentence1 is_sentence_concat u <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1 Derives1_nonterminal Derives1_rule append_assoc is_sentence_uv 
        split_uv split_v split_w splits_at_implies_Derives1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leftmost_append_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">v</span> <span class="main">⟹</span> leftmost <span class="free">i</span> <span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leftmost_def nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_append_suffix<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Derives1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">v</span> <span class="free">i</span> <span class="free">r</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="free">u</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">v</span> <span class="free">i</span> <span class="free">r</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derives1 LeftDerives1_implies_Derives1<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1 LeftDerives1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="free">u</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">w</span><span class="main">@</span><span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1"</span> <span class="quoted">"3"</span> Derives1_append_suffix<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"leftmost <span class="free">i</span> <span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2"</span> leftmost_append_suffix u<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"4"</span> <span class="quoted">"5"</span> LeftDerives1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>     

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_is_sentence<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">a</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">b</span> <span class="main">⟹</span> is_sentence <span class="free">a</span> <span class="main">∧</span> is_sentence <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_is_sentence<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span> <span class="main">⟹</span> is_sentence <span class="free">α</span> <span class="main">∧</span> is_sentence <span class="free">γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Derives1_sentence1 LeftDerivationFix_is_sentence LeftDerivationIntro_def 
    LeftDerives1_implies_Derives1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_grow_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LDF<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">b1</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prefix_b1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">prefix</span> <span class="free">e</span> <span class="free">r</span> <span class="free">b1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">prefix</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">prefix</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="free">D</span><span class="main">)</span> <span class="free">j</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> LDF <span class="keyword1"><span class="command">have</span></span> LDF'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span> <span class="free">D</span> <span class="free">c</span> <span class="main">∧</span>
    length <span class="free">b1</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">c</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span> <span class="main">!</span> length <span class="free">b1</span> <span class="main">=</span> <span class="free">c</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">F</span><span class="main">.</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">E</span> <span class="main">@</span> derivation_shift <span class="bound">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>take <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="bound">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="bound">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> EF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>take <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> E_b1_c<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">b1</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">with</span></span> EF <span class="keyword1"><span class="command">have</span></span> F_b2_c<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">b2</span> <span class="skolem">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">prefix</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span> <span class="free">e</span> <span class="free">r</span> <span class="main">(</span><span class="free">b1</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">@</span> <span class="free">b2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LDF LeftDerivationFix_is_sentence LeftDerives1_append_suffix 
      is_sentence_concat prefix_b1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_sentence1 LDF LeftDerivationFix_def LeftDerives1_implies_Derives1 
      is_sentence_concat is_sentence_cons prefix_b1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LDF LeftDerivationFix_is_sentence <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">b1</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">@</span><span class="free">b2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> LDF' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LDF' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LDF' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EF F_b2_c<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">b1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefix_b1 E_b1_c<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFixOrIntro<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">γ</span> <span class="main">⟹</span> is_sentence <span class="free">γ</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">γ</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> LeftDerivationFix <span class="free">a</span> <span class="bound">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span><span class="main">)</span> <span class="main">∨</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">d</span> <span class="bound">α</span> <span class="bound">ix</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">∧</span> LeftDerivation <span class="free">a</span> <span class="main">(</span>take <span class="bound">d</span> <span class="free">D</span><span class="main">)</span> <span class="bound">α</span> <span class="main">∧</span> 
    LeftDerivationIntro <span class="bound">α</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="bound">ix</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="bound">d</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="free">j</span> <span class="free">γ</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">D</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">γ</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span> 
  <span class="comment1">(* The induction here is unnecessary, but we use it anyway for context reasons *)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">D</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> length <span class="skolem">D</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> LeftDerivationFix <span class="skolem">a</span> <span class="bound">i</span> <span class="skolem">D</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">note</span></span> less2 <span class="main">=</span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="bound">β</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="skolem">D</span> <span class="main">∧</span> <span class="bound">β</span> <span class="main">=</span> Derive <span class="skolem">a</span> <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">∧</span> LeftDerivationFix <span class="bound">β</span> <span class="bound">i</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> Derive LeftDerivationFix_empty LeftDerivation_implies_Derivation less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ex_minimal_witness<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Minimal <span class="skolem">N</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> Minimal_N<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≤</span> length <span class="skolem">D</span> <span class="main">∧</span> <span class="skolem">β</span> <span class="main">=</span> Derive <span class="skolem">a</span> <span class="main">(</span>take <span class="skolem">N</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">∧</span> LeftDerivationFix <span class="skolem">β</span> <span class="skolem">i</span> <span class="main">(</span>drop <span class="skolem">N</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">with</span></span> Minimal_N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 1 Minimal_N <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> disjI1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Derive <span class="skolem">a</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> LeftDerives1_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="var">?δ</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.hyps"</span> LeftDerivation_Derive_take_LeftDerives1 Minimal_N less.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Derives1_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="var">?δ</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
        <span class="keyword1"><span class="command">have</span></span> i_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Minimal_N 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">X</span> <span class="bound">β_1</span> <span class="bound">β_2</span><span class="main">.</span> splits_at <span class="skolem">β</span> <span class="skolem">i</span> <span class="bound">β_1</span> <span class="bound">X</span> <span class="bound">β_2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">β_1</span></span> <span class="skolem"><span class="skolem">β_2</span></span> <span class="keyword2"><span class="keyword">where</span></span> β_split<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="skolem">β</span> <span class="skolem">i</span> <span class="skolem">β_1</span> <span class="skolem">X</span> <span class="skolem">β_2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> β_combine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="skolem">β_1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">β_2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> splits_at_combine <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> LeftDerives1_δ_hyp<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"LeftDerives1 <span class="var">?δ</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">β_1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">β_2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerives1_δ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">from</span></span> β_split <span class="keyword1"><span class="command">have</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> length <span class="skolem">β_1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_order.strict_implies_order  min.absorb2 splits_at_def<span class="main">)</span>  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Y</span> <span class="bound">δ_1</span> <span class="bound">δ_2</span><span class="main">.</span> splits_at <span class="var">?δ</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">δ_1</span> <span class="bound">Y</span> <span class="bound">δ_2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Derives1_δ splits_at_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">δ_1</span></span> <span class="skolem"><span class="skolem">δ_2</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ_split<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="var">?δ</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">δ_1</span> <span class="skolem">Y</span> <span class="skolem">δ_2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">have</span></span> NFix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="skolem">β_1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">β_2</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">β_1</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">N</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span>              
          <span class="keyword1"><span class="command">using</span></span> Minimal_N β_combine i_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
        <span class="keyword1"><span class="command">from</span></span> LeftDerives1_δ_hyp δ_split 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="skolem">β_1</span> <span class="main">=</span> <span class="skolem">δ_1</span> <span class="main">@</span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">β_2</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">@</span> <span class="skolem">δ_2</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">X</span><span class="main">]</span> <span class="main">@</span> <span class="bound">v</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> LeftDerives1_X_is_part_of_rule<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suffix <span class="skolem">suffix</span><span class="main">)</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?β</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Derive <span class="skolem">a</span> <span class="main">(</span>take <span class="var">?k</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">β_1</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> k_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&lt;</span> length <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.hyps"</span> Minimal_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≤</span> length <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> drop_k_d<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="var">?k</span> <span class="skolem">D</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>drop <span class="skolem">N</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.hyps"</span> Cons_nth_drop_Suc k_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
            <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_grow_suffix<span class="main">[</span><span class="operator">OF</span> NFix Suffix<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Suffix<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> Suffix<span class="main">(</span>1<span class="main">)</span> Suffix<span class="main">(</span>2<span class="main">)</span> 2
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="var">?β</span> <span class="var">?i</span> <span class="main">(</span>drop <span class="var">?k</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def drop_k_d<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> Minimal<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?k</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.hyps"</span> k_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prefix <span class="skolem">prefix</span><span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> collapse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> drop <span class="skolem">N</span> <span class="skolem">D</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">D</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.hyps"</span> Cons_nth_drop_Suc Minimal_N Suc_diff_1 neq0_conv not_less 
                not_less_eq prod.collapse<span class="main">)</span>          
            <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_grow_prefix<span class="main">[</span><span class="operator">OF</span> NFix Prefix<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> Prefix<span class="main">(</span>1<span class="main">)</span> collapse
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="var">?δ</span> <span class="main">(</span>length <span class="skolem">prefix</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> Minimal<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Minimal_N collapse diff_le_self le_neq_implies_less less_imp_diff_less 
                less_or_eq_imp_le not_Cons_self2<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> uv<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">β_1</span> <span class="main">=</span> <span class="skolem">δ_1</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="skolem">β_2</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">δ_2</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">X</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> X_1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">u</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> X_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_def NFix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> Minimal_N less2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerivation_take_derive less.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> LeftDerivationIntro_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerives1_δ One_nat_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span>
          <span class="keyword1"><span class="command">using</span></span> uv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> X_1 X_2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"2.hyps"</span> Derives1_δ Derives1_split Minimal_N One_nat_def 
            Suc_diff_1 δ_split append_eq_conv_conj i_def length_append neq0_conv splits_at_def uv<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> deriv <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">×</span> nat"</span></span> 
<span class="keyword1"><span class="command">type_synonym</span></span> ladder <span class="main">=</span> <span class="quoted"><span class="quoted">"deriv list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">deriv_n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"deriv <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">deriv_n</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">deriv_j</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"deriv <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deriv_j</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">deriv_ix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"deriv <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deriv_ix</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">deriv_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"deriv <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deriv_i</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_j</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_j</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> deriv_j <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_i</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> deriv_i <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="keyword1">else</span> ladder_j <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_n</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> deriv_n <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_prev_n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_prev_n</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">(</span>ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_ix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_ix</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span> deriv_ix <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_last_j</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_last_j</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> ladder_j <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_last_n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_last_n</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ladder</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"derivation <span class="main">⇒</span> ladder <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_ladder</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⟶</span> ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">u</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⟶</span> ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">u</span> <span class="main">&lt;</span> ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span>
    ladder_last_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>   

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> derivation <span class="main">⇒</span> ladder <span class="main">⇒</span> nat <span class="main">⇒</span> sentence"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_γ</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> Derive <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> derivation <span class="main">⇒</span> ladder <span class="main">⇒</span> nat <span class="main">⇒</span> sentence"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_α</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> ladder_γ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LeftDerivationIntrosAt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> derivation <span class="main">⇒</span> ladder <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LeftDerivationIntrosAt</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">=</span> <span class="main">(</span>
       <span class="keyword1">let</span> <span class="bound">α</span> <span class="main">=</span> ladder_α <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="keyword1">in</span>
       <span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> ladder_i <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="keyword1">in</span>
       <span class="keyword1">let</span> <span class="bound">j</span> <span class="main">=</span> ladder_j <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="keyword1">in</span>
       <span class="keyword1">let</span> <span class="bound">ix</span> <span class="main">=</span> ladder_ix <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="keyword1">in</span>
       <span class="keyword1">let</span> <span class="bound">γ</span> <span class="main">=</span> ladder_γ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="keyword1">in</span> 
       <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">in</span>
       <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="keyword1">in</span>
       <span class="keyword1">let</span> <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">in</span>
       <span class="keyword1">let</span> <span class="bound">E</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="bound">i</span> <span class="main">=</span> fst <span class="bound">e</span> <span class="main">∧</span>
        LeftDerivationIntro <span class="bound">α</span> <span class="bound">i</span> <span class="main">(</span>snd <span class="bound">e</span><span class="main">)</span> <span class="bound">ix</span> <span class="bound">E</span> <span class="bound">j</span> <span class="bound">γ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LeftDerivationIntros</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> derivation <span class="main">⇒</span> ladder <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LeftDerivationIntros</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="main">∀</span> <span class="bound">index</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">index</span> <span class="main">∧</span> <span class="bound">index</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⟶</span> LeftDerivationIntrosAt <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">index</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LeftDerivationLadder</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> derivation <span class="main">⇒</span> ladder <span class="main">⇒</span> sentence <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">LeftDerivationLadder</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span>
    LeftDerivation <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> 
    is_ladder <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span>
    LeftDerivationFix <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>ladder_i <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> 
    LeftDerivationIntros <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_deriv_fix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> deriv"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_deriv_fix</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_deriv_intro</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> deriv"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_deriv_intro</span> <span class="free"><span class="bound"><span class="entity">ix</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ix</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_deriv_fix_i<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"deriv_i <span class="main">(</span>mk_deriv_fix <span class="free">i</span> <span class="free">n</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_i_def mk_deriv_fix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_deriv_fix_j<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"deriv_j <span class="main">(</span>mk_deriv_fix <span class="free">i</span> <span class="free">n</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_j_def mk_deriv_fix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_deriv_fix_n<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"deriv_n <span class="main">(</span>mk_deriv_fix <span class="free">i</span> <span class="free">n</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_n_def mk_deriv_fix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_deriv_intro_i<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"deriv_i <span class="main">(</span>mk_deriv_intro <span class="free">i</span> <span class="free">n</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_i_def mk_deriv_intro_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_deriv_intro_ix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"deriv_ix <span class="main">(</span>mk_deriv_intro <span class="free">ix</span> <span class="free">n</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">ix</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_ix_def mk_deriv_intro_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_deriv_intro_j<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"deriv_j <span class="main">(</span>mk_deriv_intro <span class="free">i</span> <span class="free">n</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_j_def mk_deriv_intro_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_deriv_intro_n<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"deriv_n <span class="main">(</span>mk_deriv_intro <span class="free">i</span> <span class="free">n</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_n_def mk_deriv_intro_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_implies_ex_ladder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">a</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">L</span><span class="main">.</span> LeftDerivationLadder <span class="free">a</span> <span class="free">D</span> <span class="bound">L</span> <span class="free">γ</span> <span class="main">∧</span> 
    ladder_last_j <span class="bound">L</span> <span class="main">=</span> <span class="free">j</span> <span class="main">∧</span> ladder_last_n <span class="bound">L</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>mk_deriv_fix <span class="free">i</span> <span class="main">(</span>length <span class="free">D</span><span class="main">)</span> <span class="free">j</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_def ladder_j_def ladder_n_def ladder_γ_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_last_n_def ladder_n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Derive LeftDerivationFix_def LeftDerivation_implies_Derivation <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntros_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_last_j_def ladder_j_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_last_n_def ladder_n_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 

<span class="keyword1"><span class="command">lemma</span></span> trivP<span class="main">[</span><span class="operator">case_names</span> prems<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_ladder_n_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="free">index</span> <span class="main">≤</span> length <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> is_ladder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_deriv_n_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"deriv_n <span class="main">(</span><span class="free">L</span> <span class="main">!</span> <span class="free">index</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> is_ladder_def ladder_n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_n_simp1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_n <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="free">L'</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_n_simp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>length <span class="free">L</span><span class="main">)</span> <span class="main">=</span> deriv_n <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_j_simp1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_j <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="free">L'</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_j_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_j_simp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>length <span class="free">L</span><span class="main">)</span> <span class="main">=</span> deriv_j <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_j_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_i_simp1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_i <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="free">L'</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_ix_simp1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_ix <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="free">L'</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> ladder_ix <span class="free">L</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_ix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_ix_simp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> ladder_ix <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>length <span class="free">L</span><span class="main">)</span> <span class="main">=</span> deriv_ix <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_ix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_γ_simp1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_γ <span class="free">a</span> <span class="free">D</span> <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="free">L'</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> ladder_γ <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_γ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_γ_simp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> is_ladder <span class="free">D</span> <span class="free">L</span> <span class="main">⟹</span> 
  ladder_γ <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="free">D'</span><span class="main">)</span> <span class="free">L</span> <span class="free">u</span> <span class="main">=</span> ladder_γ <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def ladder_γ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_α_simp1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_α <span class="free">a</span> <span class="free">D</span> <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="free">L'</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> ladder_α <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_α_simp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> is_ladder <span class="free">D</span> <span class="free">L</span> <span class="main">⟹</span> 
  ladder_α <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="free">D'</span><span class="main">)</span> <span class="free">L</span> <span class="free">u</span> <span class="main">=</span> ladder_α <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def ladder_α_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_n_minus_1_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span> <span class="main">⟹</span> <span class="free">index</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> 
  ladder_n <span class="free">L</span> <span class="main">(</span><span class="free">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_diff_1 Suc_le_lessD dual_order.strict_implies_order 
  is_ladder_def le_neq_implies_less not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntrosAt_ignore_appendix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="free">a</span> <span class="main">(</span><span class="free">D</span> <span class="main">@</span> <span class="free">D'</span><span class="main">)</span> <span class="main">(</span><span class="free">L</span> <span class="main">@</span> <span class="free">L'</span><span class="main">)</span> <span class="free">index</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> index_minus_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">have</span></span> is_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="free">index</span> <span class="main">-</span> length <span class="free">D</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_less is_ladder is_ladder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> index_ge index_less <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntrosAt_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_minus_1 is_ladder ladder_n_minus_1_bound is_0<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntrosAt_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_i_eq_last_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> ladder_i <span class="main">(</span><span class="free">L</span> <span class="main">@</span> <span class="free">L'</span><span class="main">)</span> <span class="main">(</span>length <span class="free">L</span><span class="main">)</span> <span class="main">=</span> ladder_last_j <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_def ladder_last_j_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_last_n_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> ladder_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> ladder_last_n <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_last_n_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> is_ladder_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span> <span class="main">⟹</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> is_ladder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword1"><span class="command">lemma</span></span> last_ladder_γ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder_last_n<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_n <span class="free">L</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_γ <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Derive <span class="free">a</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> is_ladder is_ladder_not_empty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_γ_def ladder_last_n_intro ladder_last_n<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_α_full<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder_last_n<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_n <span class="free">L</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_α <span class="free">a</span> <span class="main">(</span><span class="free">D</span> <span class="main">@</span> <span class="free">D'</span><span class="main">)</span> <span class="main">(</span><span class="free">L</span> <span class="main">@</span> <span class="free">L'</span><span class="main">)</span> <span class="main">(</span>length <span class="free">L</span><span class="main">)</span> <span class="main">=</span> Derive <span class="free">a</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> is_ladder <span class="keyword1"><span class="command">have</span></span> L_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def<span class="main">)</span>  
  <span class="keyword1"><span class="command">with</span></span> is_ladder ladder_last_n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_ladder_γ<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_implies_LeftDerivation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span> <span class="main">⟹</span> LeftDerivation <span class="free">α</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="free">D</span><span class="main">)</span> <span class="free">γ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_def LeftDerivationIntro_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_grow<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">α</span> <span class="main">⟹</span> ladder_last_j <span class="free">L</span> <span class="main">=</span> <span class="free">i</span> <span class="main">⟹</span>
   LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">E</span> <span class="free">j</span> <span class="free">γ</span> <span class="main">⟹</span>
   LeftDerivationLadder <span class="free">a</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">@</span><span class="free">E</span><span class="main">)</span> <span class="main">(</span><span class="free">L</span><span class="main">@</span><span class="main">[</span>mk_deriv_intro <span class="free">ix</span> <span class="main">(</span>Suc<span class="main">(</span>length <span class="free">D</span> <span class="main">+</span> length <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="free">γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">ix</span></span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trivP<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> prems
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">L</span> <span class="main">∨</span> <span class="skolem">u</span> <span class="main">=</span> length <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="main">(</span><span class="skolem">L</span> <span class="main">@</span> <span class="main">[</span>mk_deriv_intro <span class="skolem">ix</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">D</span> <span class="main">+</span> length <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">≤</span> 
      Suc <span class="main">(</span>length <span class="skolem">D</span> <span class="main">+</span> length <span class="skolem">E</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> LeftDerivationLadder_ladder_n_bound le_Suc_eq le_add1 le_trans prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> ladder_n_ineqs <span class="main">=</span> this    
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> u_less_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="skolem">L</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">=</span> length <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="main">(</span><span class="skolem">L</span> <span class="main">@</span> <span class="main">[</span>mk_deriv_intro <span class="skolem">ix</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">D</span> <span class="main">+</span> length <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="skolem">u</span>
           <span class="main">&lt;</span> ladder_n <span class="main">(</span><span class="skolem">L</span> <span class="main">@</span> <span class="main">[</span>mk_deriv_intro <span class="skolem">ix</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">D</span> <span class="main">+</span> length <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span> 
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">with</span></span> u_less_v <span class="keyword1"><span class="command">have</span></span> u_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 u_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> prems u_less_v LeftDerivationLadder_def is_ladder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">with</span></span> u_less_v <span class="keyword1"><span class="command">have</span></span> u_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deriv_n <span class="main">(</span><span class="skolem">L</span> <span class="main">!</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">D</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_deriv_n_bound prems<span class="main">(</span>1<span class="main">)</span> u_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_bound<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_def 2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> ladder_n_ineqs <span class="main">=</span> ladder_n_ineqs this
  <span class="keyword1"><span class="command">have</span></span> is_ladder<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"is_ladder <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">(</span><span class="skolem">L</span> <span class="main">@</span> <span class="main">[</span>mk_deriv_intro <span class="skolem">ix</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">D</span> <span class="main">+</span> length <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ladder_n_ineqs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_last_n_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> is_ladder_L<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="skolem">D</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def prems.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> ladder_last_n_eq_length<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_n <span class="skolem">L</span> <span class="main">=</span> length <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_L is_ladder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
  <span class="keyword1"><span class="command">have</span></span> L_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def is_ladder_def prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> index_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">≤</span> <span class="skolem">index</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&lt;</span> length <span class="skolem">L</span> <span class="main">∨</span> <span class="skolem">index</span> <span class="main">=</span> length <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="skolem">a</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span> 
      <span class="main">(</span><span class="skolem">L</span> <span class="main">@</span> <span class="main">[</span>mk_deriv_intro <span class="skolem">ix</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">D</span> <span class="main">+</span> length <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="skolem">index</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> LeftDerivationIntrosAt_ignore_appendix
          LeftDerivationIntros_def LeftDerivationLadder_def One_nat_def 
          index_ge prems.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> min_simp<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">E</span><span class="main">.</span> min <span class="bound">n</span> <span class="main">(</span>Suc <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> length <span class="bound">E</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> 2 prems is_ladder_L ladder_last_n_eq_length <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>        
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntrosAt_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_not_empty ladder_i_eq_last_j ladder_last_n_intro<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_full min_simp<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_γ_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LeftDerivationIntro_implies_LeftDerivation LeftDerivationLadder_def 
          LeftDerivation_implies_Derivation LeftDerivation_implies_append<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_def LeftDerivationIntro_def LeftDerivation_append <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> L_not_empty <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def LeftDerivationLadder_ladder_n_bound ladder_γ_def 
      prems.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> LeftDerivationIntros_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_bounds_ij<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">β</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">α</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">β</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Derives1_bound LeftDerivationFix_def LeftDerivationIntro_def 
    LeftDerives1_implies_Derives1<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> LeftDerivationLadder_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">γ</span> <span class="main">⟹</span> is_sentence <span class="free">γ</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">γ</span> <span class="main">⟹</span> 
  <span class="main">∃</span> <span class="bound">L</span><span class="main">.</span> LeftDerivationLadder <span class="free">a</span> <span class="free">D</span> <span class="bound">L</span> <span class="free">γ</span> <span class="main">∧</span> ladder_last_j <span class="bound">L</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">D</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">γ</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationFixOrIntro<span class="main">[</span><span class="operator">OF</span> less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">D</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span> LeftDerivationFix_implies_ex_ladder <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">ix</span></span> <span class="keyword2"><span class="keyword">where</span></span> inductrule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">D</span> <span class="main">∧</span>
      LeftDerivation <span class="skolem">a</span> <span class="main">(</span>take <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">α</span> <span class="main">∧</span>
      LeftDerivationIntro <span class="skolem">α</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ix</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> less_length_D<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">D</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> LeftDerivation_α<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">a</span> <span class="main">(</span>take <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> is_sentence_α<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="skolem">α</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivationIntro_is_sentence inductrule <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">α</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivationIntro_bounds_ij inductrule <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> less_length_D LeftDerivation_α is_sentence_α<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> induct_Ladder<span class="main">:</span>
      <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="skolem">a</span> <span class="main">(</span>take <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> induct_last<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> induct_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="skolem">α</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">D</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ix</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inductrule <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inductrule <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> simp_to_D<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">d</span> <span class="skolem">D</span> <span class="main">@</span> <span class="skolem">D</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="skolem">D</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>        
    <span class="keyword1"><span class="command">from</span></span> LeftDerivationLadder_grow<span class="main">[</span><span class="operator">OF</span> induct_Ladder induct_last induct_intro<span class="main">]</span> simp_to_D
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">@</span> <span class="main">[</span>mk_deriv_intro <span class="skolem">ix</span> <span class="main">(</span>Suc <span class="main">(</span>min <span class="main">(</span>length <span class="skolem">D</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">+</span> <span class="main">(</span>length <span class="skolem">D</span> <span class="main">-</span> Suc <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_last_j_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_L_0<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> LeftDerivationFix <span class="free">α</span> <span class="bound">i</span> <span class="free">D</span> <span class="main">(</span>ladder_last_j <span class="free">L</span><span class="main">)</span> <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ladder_n<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="main">0</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_ladder_def ladder_last_n_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LeftDerivationFix_def LeftDerivation_implies_Derivation One_nat_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
      diff_Suc_1 ladder_last_j_def ladder_n order_refl take_all<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>    
  
<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_splits_at_derives<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">a</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">U</span> <span class="bound">a1</span> <span class="bound">a2</span> <span class="bound">b1</span> <span class="bound">b2</span><span class="main">.</span> splits_at <span class="free">a</span> <span class="free">i</span> <span class="bound">a1</span> <span class="bound">U</span> <span class="bound">a2</span> <span class="main">∧</span> splits_at <span class="free">b</span> <span class="free">j</span> <span class="bound">b1</span> <span class="bound">U</span> <span class="bound">b2</span> <span class="main">∧</span> 
    derives <span class="bound">a1</span> <span class="bound">b1</span> <span class="main">∧</span> derives <span class="bound">a2</span> <span class="bound">b2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> hyp <span class="main">=</span> LeftDerivationFix_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> β<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> D<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> hyp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> EF<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
      LeftDerivation <span class="main">(</span>take <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="free">j</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Derivation_implies_derives LeftDerivation_implies_Derivation assms hyp 
      splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>  LeftDerivation_append_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> is_sentence <span class="free">c</span> <span class="main">⟹</span> LeftDerivation <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">c</span><span class="main">)</span> <span class="free">D</span> <span class="main">(</span><span class="free">b</span><span class="main">@</span><span class="free">c</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">x</span><span class="main">@</span><span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerives1_append_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_impossible<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">a</span> <span class="main">⟹</span> 
  is_nonterminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> derivation_ge <span class="free">D</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> leftmost <span class="bound">j</span> <span class="free">a</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_sentence1 LeftDerivation.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> LeftDerives1_implies_Derives1 
      leftmost_exists leftmost_unique<span class="main">)</span>     
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def LeftDerives1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> lm<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">d</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_ge_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>derivation_shift <span class="free">F</span> <span class="main">0</span> <span class="free">j</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">F</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_splits_at_nonterminal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">a</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="free">a</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">U</span> <span class="bound">a1</span> <span class="bound">a2</span> <span class="bound">b1</span><span class="main">.</span> splits_at <span class="free">a</span> <span class="free">i</span> <span class="bound">a1</span> <span class="bound">U</span> <span class="bound">a2</span> <span class="main">∧</span> splits_at <span class="free">b</span> <span class="free">j</span> <span class="bound">b1</span> <span class="bound">U</span> <span class="bound">a2</span> <span class="main">∧</span> LeftDerivation <span class="bound">a1</span> <span class="free">D</span> <span class="bound">b1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> hyp <span class="main">=</span> LeftDerivationFix_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> β<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> D<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> hyp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> EF<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span> LeftDerivation <span class="main">(</span>take <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> 
      LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">β</span><span class="main">.</span> LeftDerivation <span class="free">a</span> <span class="skolem">E</span> <span class="bound">β</span> <span class="main">∧</span> LeftDerivation <span class="bound">β</span> <span class="main">(</span>derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> EF LeftDerivation_append assms<span class="main">(</span>1<span class="main">)</span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> β_intro<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="skolem">E</span> <span class="skolem">β</span> <span class="main">∧</span> LeftDerivation <span class="skolem">β</span> <span class="main">(</span>derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="main">(</span>take <span class="free">i</span> <span class="free">a</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span><span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF LeftDerivation_append_suffix append_take_drop_id assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hyp is_sentence_concat<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="skolem">E</span> <span class="main">(</span><span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> β_decomposed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derivation_unique_dest LeftDerivation_implies_Derivation β_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="free">a</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hyp length_take min.absorb2 nth_append_length 
      order.strict_implies_order<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="skolem">β</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> index_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> β_decomposed assms<span class="main">(</span>1<span class="main">)</span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> derivation<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">β</span> <span class="main">(</span>derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> β_intro<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> LeftDerivation_impossible<span class="main">[</span><span class="operator">OF</span> derivation index_j is_nt derivation_ge_shift<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_0_conv length_derivation_shift<span class="main">)</span>    
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> β_is_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> β_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>     
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="free">j</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> EF F assms<span class="main">(</span>1<span class="main">)</span> hyp splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_implies_nonterminal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="main">(</span>snd <span class="free">e</span><span class="main">)</span> <span class="free">ix</span> <span class="free">E</span> <span class="free">j</span> <span class="free">γ</span> <span class="main">⟹</span> is_nonterminal <span class="main">(</span><span class="free">α</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntro_def LeftDerives1_def leftmost_is_nonterminal<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntrosAt_implies_nonterminal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span> <span class="main">⟹</span> is_nonterminal<span class="main">(</span><span class="main">(</span>ladder_α <span class="free">a</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="free">index</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> LeftDerivationIntro_implies_nonterminal LeftDerivationIntrosAt_def<span class="main">)</span>
   
<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_examine_rule<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span> <span class="main">⟹</span> splits_at <span class="free">α</span> <span class="free">i</span> <span class="free">α1</span> <span class="free">M</span> <span class="free">α2</span> <span class="main">⟹</span> 
    <span class="main">∃</span> <span class="bound">η</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> fst <span class="free">r</span> <span class="main">∧</span> <span class="bound">η</span> <span class="main">=</span> snd <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="bound">η</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_nonterminal Derives1_rule LeftDerivationIntro_def LeftDerives1_implies_Derives1 
  prod.collapse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_skip_prefixword_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="free">D</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_word <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w'</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span><span class="main">@</span><span class="bound">w'</span> <span class="main">∧</span> LeftDerivation <span class="free">v</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="bound">w'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivation.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> LeftDerivation_breakdown LeftDerivation_implies_Derivation 
  LeftDerivation_skip_prefix append_eq_conv_conj assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_word_Derivation 
  is_word_Derivation_derivation_ge<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_cut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat <span class="main">⇒</span> ladder"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ladder_cut</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">[</span><span class="bound">i</span> <span class="main">:=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">deriv_shift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> deriv <span class="main">⇒</span> deriv"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">deriv_shift</span> <span class="free"><span class="bound"><span class="entity">dn</span></span></span> <span class="free"><span class="bound"><span class="entity">dj</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">dn</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">dj</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_shift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> ladder"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ladder_shift</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">dn</span></span></span> <span class="free"><span class="bound"><span class="entity">dj</span></span></span> <span class="main">=</span> map <span class="main">(</span>deriv_shift <span class="free"><span class="bound"><span class="entity">dn</span></span></span> <span class="free"><span class="bound"><span class="entity">dj</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splits_at_append_suffix_prevails<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="free">i</span> <span class="free">u</span> <span class="free">N</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">v'</span><span class="main">@</span><span class="free">b</span> <span class="main">∧</span> <span class="free">a</span><span class="main">=</span><span class="free">u</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="bound">v'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_leI assms<span class="main">(</span>2<span class="main">)</span> min.absorb2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> append_assoc append_eq_conv_conj append_take_drop_id assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
      hd_drop_conv_nth length_take splits_at_def take_hd_drop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_shift_right_left_cancel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"derivation_shift <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">0</span> <span class="free">r</span><span class="main">)</span> <span class="free">r</span> <span class="main">0</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">D</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_shift_left_right_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derivation_shift <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="free">r</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">r</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms derivation_ge_shift_simp derivation_shift_0_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_ge_take<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">k</span> <span class="free">b</span> <span class="main">∧</span> is_word <span class="main">(</span>take <span class="free">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">#</span><span class="skolem">D'</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> list.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> LeftDerives1 <span class="free">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> LeftDerivation <span class="bound">x</span> <span class="skolem">D'</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivation.simps<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">a</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span> LeftDerivation <span class="skolem">x</span> <span class="skolem">D'</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> fst_d_k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">d</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d assms<span class="main">(</span>1<span class="main">)</span> derivation_ge_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> x fst_d_k <span class="keyword1"><span class="command">have</span></span> is_word<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span>take <span class="free">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerives1_def append_take_drop_id is_word_append leftmost_def 
      min.absorb2 take_append take_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> is_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">a</span> <span class="main">=</span> take <span class="free">k</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derivation_take LeftDerivation_implies_Derivation assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_word is_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> 
        
<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_splits_at_symbol<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">a</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">U</span> <span class="bound">a1</span> <span class="bound">a2</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="bound">n</span><span class="main">.</span> splits_at <span class="free">a</span> <span class="free">i</span> <span class="bound">a1</span> <span class="bound">U</span> <span class="bound">a2</span> <span class="main">∧</span> splits_at <span class="free">b</span> <span class="free">j</span> <span class="bound">b1</span> <span class="bound">U</span> <span class="bound">b2</span> <span class="main">∧</span> 
    <span class="bound">n</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">∧</span> LeftDerivation <span class="bound">a1</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="bound">b1</span> <span class="main">∧</span> derivation_ge <span class="main">(</span>drop <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc<span class="main">(</span>length <span class="bound">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    LeftDerivation <span class="bound">a2</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc<span class="main">(</span>length <span class="bound">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="bound">b2</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">n</span> <span class="main">=</span> length <span class="free">D</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">∧</span> is_word <span class="main">(</span><span class="bound">b1</span><span class="main">@</span><span class="main">[</span><span class="bound">U</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> hyp <span class="main">=</span> LeftDerivationFix_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> β<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> D<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> hyp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> EF<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span> LeftDerivation <span class="main">(</span>take <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> 
      LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">β</span><span class="main">.</span> LeftDerivation <span class="free">a</span> <span class="skolem">E</span> <span class="bound">β</span> <span class="main">∧</span> LeftDerivation <span class="bound">β</span> <span class="main">(</span>derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> EF LeftDerivation_append assms<span class="main">(</span>1<span class="main">)</span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> β_intro<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="skolem">E</span> <span class="skolem">β</span> <span class="main">∧</span> LeftDerivation <span class="skolem">β</span> <span class="main">(</span>derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="main">(</span>take <span class="free">i</span> <span class="free">a</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span><span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF LeftDerivation_append_suffix append_take_drop_id assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hyp is_sentence_concat<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="skolem">E</span> <span class="main">(</span><span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> β_decomposed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">b</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derivation_unique_dest LeftDerivation_implies_Derivation β_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> derivation<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">β</span> <span class="main">(</span>derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> β_intro<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">∧</span> <span class="skolem">E</span> <span class="main">=</span> take <span class="bound">n</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF append_eq_conv_conj is_prefix_length is_prefix_take<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">∧</span> <span class="skolem">E</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> F_def<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="free">D</span> <span class="main">=</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF append_eq_conv_conj length_take min.absorb2 n<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> min_j<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="free">b</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">have</span></span> derivation_ge_Suc_j<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F_def derivation_ge_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> LeftDerivation_β_b<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">β</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def β_intro<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> is_word_Suc_j_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> length <span class="free">D</span> <span class="main">⟹</span> is_word <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF F_def LeftDerivation_ge_take β_intro append_Nil2 derivation_ge_Suc_j 
      length_take min.absorb2 n<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> take_Suc_j_b_decompose<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> take <span class="free">j</span> <span class="free">b</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms hyp take_Suc_conv_app_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="free">j</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_j<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms hyp splits_at_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> assms hyp splits_at_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> EF n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> F_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> derivation_ge_shift <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> F_def  derivation_shift_right_left_cancel <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> EF <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">using</span></span> is_word_Suc_j_b  take_Suc_j_b_decompose is_word_append <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_breakdown'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="free">D</span> <span class="free">w</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">n</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span>
    <span class="bound">n</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">∧</span>
    <span class="free">w</span> <span class="main">=</span> <span class="bound">w1</span> <span class="main">@</span> <span class="bound">w2</span> <span class="main">∧</span>
    LeftDerivation <span class="free">u</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="bound">w1</span> <span class="main">∧</span>
    derivation_ge <span class="main">(</span>drop <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">w1</span><span class="main">)</span> <span class="main">∧</span>
    LeftDerivation <span class="free">v</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="bound">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">w1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="bound">w2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="free">D</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerivation_breakdown<span class="main">[</span><span class="operator">OF</span> hyp<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> breakdown<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">w1</span> <span class="main">@</span> <span class="skolem">w2</span> <span class="main">∧</span>
    LeftDerivation <span class="free">u</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">w1</span> <span class="main">∧</span>
    derivation_ge <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span> <span class="main">∧</span>
    LeftDerivation <span class="free">v</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> min <span class="main">(</span>length <span class="free">D</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> take_m<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">m</span> <span class="free">D</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m is_prefix_take take_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> drop_m<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">m</span> <span class="free">D</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj append_take_drop_id length_take m<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> m_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> length <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m<span class="main">)</span>      
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">w1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">w2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> breakdown m_bound take_m drop_m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_append_replace_in_left<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> ld1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α'</span><span class="main">.</span> <span class="free">β</span> <span class="main">=</span> <span class="bound">α'</span><span class="main">@</span><span class="free">δ</span> <span class="main">∧</span> LeftDerives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="bound">α'</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> length <span class="bound">α'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="keyword2"><span class="keyword">where</span></span> α'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">α</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> fst_r<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">r</span> <span class="main">=</span> <span class="free">α</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ss</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">ssa</span><span class="main">.</span> <span class="main">¬</span> LeftDerives1 <span class="bound">ss</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">ssa</span> <span class="main">∨</span> Derives1 <span class="bound">ss</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">ssa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">β</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ld1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Derives1_nonterminal i_bound splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">α'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_bound ld1
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α' Derives1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fst_r<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> id_take_nth_drop <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> Derives1_sentence1 LeftDerives1_implies_Derives1 is_sentence_concat 
      is_sentence_take <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_sentence1 LeftDerives1_implies_Derives1 append_take_drop_id 
      is_sentence_concat<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Derives1_rule LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> leftderives1_α_α'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">α'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerives1_def i_bound ld1 leftmost_cons_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_bound_α'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">α'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> α' i_bound
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mono_thms_linordered_semiring<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> le_add1 less_or_eq_imp_le min.absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> is_sentence_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derives1_sentence1 LeftDerives1_implies_Derives1 is_sentence_concat ld1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> β<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="main">=</span> <span class="skolem">α'</span><span class="main">@</span><span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ld1 leftderives1_α_α' Derives1_append_suffix Derives1_unique_dest 
      LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">α'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> β i_bound_α' leftderives1_α_α' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>   
    
<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_propagate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> intro<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="free">γ</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ω</span><span class="main">.</span> LeftDerivation <span class="free">α</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="free">D</span><span class="main">)</span> <span class="bound">ω</span> <span class="main">∧</span> <span class="free">γ</span> <span class="main">=</span> <span class="bound">ω</span><span class="main">@</span><span class="free">δ</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="bound">ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> intro LeftDerivationIntro_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">α</span><span class="main">@</span><span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ix<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ix</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> D<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
    j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">γ</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> ld_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">β</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
     ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ix</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> snd <span class="free">r</span> <span class="main">!</span> <span class="free">ix</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
     β_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="skolem">β</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerives1_append_replace_in_left<span class="main">[</span><span class="operator">OF</span> ld_β i_α<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="keyword2"><span class="keyword">where</span></span> α'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span> <span class="main">∧</span> LeftDerives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">α'</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">α'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> i_plus_ix_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">ix</span> <span class="main">&lt;</span> length <span class="skolem">α'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> α' ix <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> ld_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> β_fix α' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_i_ix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="main">(</span><span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def non<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_splits_at_nonterminal<span class="main">[</span><span class="operator">OF</span> ld_γ non_i_ix<span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="keyword2"><span class="keyword">where</span></span> U<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span><span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="skolem">a1</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span> splits_at <span class="free">γ</span> <span class="free">j</span> <span class="skolem">b1</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span> LeftDerivation <span class="skolem">a1</span> <span class="free">D</span> <span class="skolem">b1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">q</span><span class="main">.</span> <span class="skolem">a2</span> <span class="main">=</span> <span class="bound">q</span><span class="main">@</span><span class="free">δ</span> <span class="main">∧</span> <span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> splits_at_append_suffix_prevails<span class="main">[</span><span class="operator">OF</span> _ i_plus_ix_bound<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">δ</span></span><span class="main">]</span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">@</span><span class="free">δ</span> <span class="main">∧</span> <span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">@</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">@</span><span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">α'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationFix_def LeftDerivation_append_suffix U α' 
      q append_Cons append_Nil is_sentence_concat ld_γ<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> U q splits_at_combine <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> U splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_finish<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> intro<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="bound">ω</span> <span class="bound">δ'</span><span class="main">.</span>
    <span class="bound">k</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">∧</span>
    LeftDerivation <span class="free">α</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>take <span class="bound">k</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="bound">ω</span> <span class="main">∧</span>
    LeftDerivation <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>take <span class="bound">k</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">ω</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
    derivation_ge <span class="main">(</span>drop <span class="bound">k</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">ω</span><span class="main">)</span> <span class="main">∧</span>
    LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="bound">k</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">ω</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="bound">δ'</span> <span class="main">∧</span>
    <span class="free">γ</span> <span class="main">=</span> <span class="bound">ω</span> <span class="main">@</span> <span class="bound">δ'</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="bound">ω</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> intro LeftDerivationIntro_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">α</span><span class="main">@</span><span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ix<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ix</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> D<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
    j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">γ</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> ld_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">β</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
     ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ix</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> snd <span class="free">r</span> <span class="main">!</span> <span class="free">ix</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
     β_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="skolem">β</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerives1_append_replace_in_left<span class="main">[</span><span class="operator">OF</span> ld_β i_α<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="keyword2"><span class="keyword">where</span></span> α'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span> <span class="main">∧</span> LeftDerives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">α'</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">α'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> i_plus_ix_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">ix</span> <span class="main">&lt;</span> length <span class="skolem">α'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> α' ix <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> ld_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> β_fix α' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_splits_at_symbol<span class="main">[</span><span class="operator">OF</span> ld_γ<span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> U<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span><span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="skolem">a1</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span>
     splits_at <span class="free">γ</span> <span class="free">j</span> <span class="skolem">b1</span> <span class="skolem">U</span> <span class="skolem">b2</span> <span class="main">∧</span>
     <span class="skolem">n</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">∧</span>
     LeftDerivation <span class="skolem">a1</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">b1</span> <span class="main">∧</span>
     derivation_ge <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     LeftDerivation <span class="skolem">a2</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">b2</span> <span class="main">∧</span>
     <span class="main">(</span><span class="skolem">n</span> <span class="main">=</span> length <span class="free">D</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">∧</span> is_word <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> n_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">q</span><span class="main">.</span> <span class="skolem">a2</span> <span class="main">=</span> <span class="bound">q</span><span class="main">@</span><span class="free">δ</span> <span class="main">∧</span> <span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> splits_at_append_suffix_prevails<span class="main">[</span><span class="operator">OF</span> _ i_plus_ix_bound<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">δ</span></span><span class="main">]</span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">@</span><span class="free">δ</span> <span class="main">∧</span> <span class="skolem">α'</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> length <span class="skolem">b1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_order.strict_implies_order  min.absorb2 splits_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">D</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">∧</span> is_word <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> drop_n_D<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="free">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> U<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">a2</span> <span class="main">[]</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2_eq_b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span> <span class="main">=</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">@</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">@</span><span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">α'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationFix_is_sentence LeftDerivation_append_suffix U α' 
            append_Cons append_Nil is_sentence_concat ld_γ q<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.hyps"</span> LeftDerivationFix_def U α' a2_eq_b2 id_take_nth_drop ld_β 
            ld_γ q splits_at_def take_all<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_n_D<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> U a2_eq_b2 id_take_nth_drop q splits_at_def<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2   
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">q</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="skolem">E</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U q  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> LeftDerivation_breakdown'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> w1w2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≤</span> length <span class="skolem">E</span> <span class="main">∧</span>
         <span class="skolem">b2</span> <span class="main">=</span> <span class="skolem">w1</span> <span class="main">@</span> <span class="skolem">w2</span> <span class="main">∧</span>
         LeftDerivation <span class="skolem">q</span> <span class="main">(</span>take <span class="skolem">n'</span> <span class="skolem">E</span><span class="main">)</span> <span class="skolem">w1</span> <span class="main">∧</span>
         derivation_ge <span class="main">(</span>drop <span class="skolem">n'</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span> <span class="main">∧</span>
         LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">n'</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> length_E_D<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">E</span> <span class="main">=</span> length <span class="free">D</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E n_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> n_plus_n'_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n'</span> <span class="main">≤</span> length <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_E_D w1w2 n_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">have</span></span> take_breakdown<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n'</span><span class="main">)</span> <span class="free">D</span> <span class="main">=</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>take <span class="skolem">n'</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> take_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> q_w1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">q</span> <span class="main">(</span>take <span class="skolem">n'</span> <span class="skolem">E</span><span class="main">)</span> <span class="skolem">w1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w1w2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> isw<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> take_n'<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">n'</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> derivation_shift <span class="main">(</span>take <span class="skolem">n'</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> E U derivation_shift_left_right_cancel take_derivation_shift<span class="main">)</span>  
      <span class="keyword1"><span class="command">have</span></span> α'_derives_b1_U_w1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">α'</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="skolem">U</span> <span class="main">#</span> <span class="skolem">w1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> take_breakdown<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> LeftDerivation_implies_append<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">b1</span></span><span class="main"><span class="main">@</span></span><span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">U</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">@</span></span><span class="skolem"><span class="skolem">q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationFix_is_sentence LeftDerivation_append_suffix U 
          is_sentence_concat ld_γ q<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_n'<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeftDerivation_append_prefix<span class="main"><span class="main">[</span></span><span class="operator">OF</span> q_w1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">b1</span></span></span><span class="main"><span class="main"><span class="main">@</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">U</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> isw<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> dge<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span> <span class="main">+</span> length <span class="skolem">w1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="skolem">n'</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">b1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="skolem">w1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> E Suc_eq_plus1 U append_take_drop_id derivation_ge_append derivation_ge_shift_plus drop_derivation_shift w1w2<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span> <span class="main">+</span> length <span class="skolem">w1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 add.commute drop_drop semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">+</span><span class="skolem">n'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">using</span></span> n_plus_n'_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">α'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> α' α'_derives_b1_U_w1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_appendI LeftDerivationFix_is_sentence LeftDerivation_append_suffix
          α' α'_derives_b1_U_w1 append_assoc is_sentence_concat ld_β ld_γ<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dge<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> E Suc_eq_plus1 add.commute derivation_shift_0_shift drop_derivation_shift 
          drop_drop w1w2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> U splits_at_combine w1w2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j<span class="main">)</span>  
  <span class="keyword1"><span class="command">qed</span></span>      
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_propagate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span> <span class="main">⟹</span> ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">α</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="free">index</span>
   <span class="main">⟹</span> <span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> 
     <span class="keyword1">if</span> <span class="main">(</span><span class="free">index</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span><span class="main">)</span> <span class="keyword1">then</span>
       <span class="main">(</span><span class="main">∃</span> <span class="bound">β</span><span class="main">.</span> LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="bound">β</span> <span class="main">∧</span> ladder_γ <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span> <span class="main">=</span> <span class="bound">β</span><span class="main">@</span><span class="free">δ</span> <span class="main">∧</span> 
         ladder_j <span class="free">L</span> <span class="free">index</span> <span class="main">&lt;</span> length <span class="bound">β</span><span class="main">)</span>
     <span class="keyword1">else</span> 
       <span class="main">(</span><span class="main">∃</span> <span class="bound">n'</span> <span class="bound">β</span> <span class="bound">δ'</span><span class="main">.</span> <span class="main">(</span><span class="free">index</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> ladder_prev_n <span class="free">L</span> <span class="free">index</span> <span class="main">&lt;</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">n'</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="bound">n'</span> <span class="free">D</span><span class="main">)</span> <span class="bound">β</span> <span class="main">∧</span>
         LeftDerivation <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="bound">β</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
         derivation_ge <span class="main">(</span>drop <span class="bound">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">β</span><span class="main">)</span> <span class="main">∧</span> 
         LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="bound">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">β</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="bound">δ'</span> <span class="main">∧</span>
         ladder_γ <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span> <span class="main">=</span> <span class="bound">β</span><span class="main">@</span><span class="bound">δ'</span> <span class="main">∧</span> ladder_j <span class="free">L</span> <span class="free">index</span> <span class="main">&lt;</span> length <span class="bound">β</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">index</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span>
    <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"0.prems"</span><span class="main">(</span>3<span class="main">)</span> LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">∨</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"1.hyps"</span> LeftDerivationIntros_def LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> LeftDerivationIntrosAt_implies_nonterminal<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span> <span class="main">!</span> ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_def ladder_i_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ldfix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_splits_at_nonterminal<span class="main">[</span><span class="operator">OF</span> ldfix this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> thesplit<span class="main">:</span>
      <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">a1</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span>
       splits_at <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">b</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span> 
       LeftDerivation <span class="skolem">a1</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">δ'</span><span class="main">.</span> <span class="skolem">a2</span> <span class="main">=</span> <span class="bound">δ'</span> <span class="main">@</span> <span class="free">δ</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="bound">δ'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> thesplit splits_at_append_suffix_prevails <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span> <span class="main">=</span> <span class="skolem">δ'</span> <span class="main">@</span> <span class="free">δ</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> β<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_is_sentence is_sentence_concat ldfix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> δ' is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> δ' thesplit <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">a1</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">δ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">δ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivation_append_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> α_derives_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> β δ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> β_append_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">β</span><span class="main">@</span><span class="free">δ</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> β δ' append_assoc splits_at_combine thesplit<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> ladder_j_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="free">L</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">β</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def β diff_add_inverse dual_order.strict_implies_order leD le_add1 
        length_Cons length_append length_take list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> min.absorb2 neq0_conv splits_at_def 
        thesplit zero_less_diff zero_less_one<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">β</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α_derives_β β_append_δ ladder_j_bound<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2  
    <span class="keyword1"><span class="command">note</span></span> case_2 <span class="main">=</span> 2
    <span class="keyword1"><span class="command">have</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted">"2.hyps"</span> LeftDerivationLadder_def One_nat_def 
        diff_Suc_1 is_ladder_def ladder_last_n_intro<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> take_n_D<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">n</span> <span class="free">D</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_imp_le<span class="main">)</span>   
    <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_splits_at_symbol<span class="main">[</span><span class="operator">OF</span> ldfix<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> U<span class="main">:</span>
      <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">a1</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span>
       splits_at <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">b1</span> <span class="skolem">U</span> <span class="skolem">b2</span> <span class="main">∧</span>
       <span class="skolem">m</span> <span class="main">≤</span> length <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">∧</span>
       LeftDerivation <span class="skolem">a1</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b1</span> <span class="main">∧</span>
       derivation_ge <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
       LeftDerivation <span class="skolem">a2</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">b2</span> <span class="main">∧</span>
       <span class="main">(</span><span class="skolem">m</span> <span class="main">=</span> length <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">&lt;</span> length <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">∧</span> is_word <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> D'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> derivation_shift <span class="main">(</span>drop <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2_derives_b2<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">a2</span> <span class="skolem">D'</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U take_n_D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> U <span class="keyword1"><span class="command">have</span></span> m_leq_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> LeftDerivationLadder_def is_ladder_def 
         min.absorb2<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> U <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">a1</span> <span class="skolem">U</span> <span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> splits_at_append_suffix_prevails<span class="main">[</span><span class="operator">OF</span> this 0<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      v'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">@</span> <span class="free">δ</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> a1_derives_b1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">a1</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m_leq_n U
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted">"2.hyps"</span> LeftDerivationLadder_def One_nat_def 
        cancel_comm_monoid_add_class.diff_cancel is_ladder_def ladder_last_n_intro order_refl 
        take_all<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">v'</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">D'</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a2_derives_b2 v' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> LeftDerivation_breakdown'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> w12<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">=</span> <span class="skolem">w1</span> <span class="main">@</span> <span class="skolem">w2</span> <span class="main">∧</span>
       <span class="skolem">m'</span> <span class="main">≤</span> length <span class="skolem">D'</span> <span class="main">∧</span>
       LeftDerivation <span class="skolem">v'</span> <span class="main">(</span>take <span class="skolem">m'</span> <span class="skolem">D'</span><span class="main">)</span> <span class="skolem">w1</span> <span class="main">∧</span>
       derivation_ge <span class="main">(</span>drop <span class="skolem">m'</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span> <span class="main">∧</span>
       LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">m'</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">D'</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w12 dual_order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m_m'_leq_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n_def m_leq_n le_diff_conv2 add.commute 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>  
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> β<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="skolem">b1</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_is_sentence is_sentence_concat ldfix v' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">a1</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivation_append_suffix a1_derives_b1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> α_derives_pre_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> v' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">∧</span> is_word <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> U n_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> take_n_D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pre_β_derives_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m'</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="skolem">β</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m_m'_leq_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> β<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> w12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_word_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> take_drop_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">m'</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> derivation_shift <span class="main">(</span>take <span class="skolem">m'</span> <span class="skolem">D'</span><span class="main">)</span> 
            <span class="main">0</span> <span class="main">(</span>length <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D' take_derivation_shift<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> U derivation_shift_left_right_cancel take_derivation_shift take_n_D<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> v'_derives_w1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">v'</span> <span class="main">(</span>take <span class="skolem">m'</span> <span class="skolem">D'</span><span class="main">)</span> <span class="skolem">w1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w12<span class="main">)</span>  
        <span class="keyword1"><span class="command">with</span></span> is_word_prefix <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="main">(</span>take <span class="skolem">m'</span> <span class="skolem">D'</span><span class="main">)</span> 
            <span class="main">0</span> <span class="main">(</span>length <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">w1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span>  LeftDerivation_append_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> take_drop_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> β<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>   
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>take <span class="skolem">m'</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_add<span class="main">)</span>  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> α_derives_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">β</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivation_implies_append α_derives_pre_β pre_β_derives_β <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> derivation_ge_drop_m_m'<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">β</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">m'</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">)</span> <span class="free">D</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="skolem">m'</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> U append_take_drop_id derivation_ge_append take_n_D<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">β</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> D' β append_assoc derivation_ge_shift_plus 
            drop_derivation_shift length_append length_append_singleton w12<span class="main">)</span>   
      <span class="keyword1"><span class="command">qed</span></span>  
    <span class="keyword1"><span class="command">have</span></span> δ_derives_w2<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">β</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w2</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"derivation_shift <span class="main">(</span>drop <span class="skolem">m'</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w1</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> derivation_shift <span class="main">(</span>drop <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">β</span><span class="main">)</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D' β add.commute derivation_shift_0_shift drop_derivation_shift<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">β</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> w12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> ladder_γ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">β</span> <span class="main">@</span> <span class="skolem">w2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> U β splits_at_combine w12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_j_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="free">L</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U β splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">+</span> <span class="skolem">m'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_m'_leq_n<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">β</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α_derives_β<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_is_sentence LeftDerivation_append_suffix α_derives_β 
        is_sentence_concat ldfix <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> derivation_ge_drop_m_m' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">w2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> δ_derives_w2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> ladder_γ_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> ladder_j_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntros_def LeftDerivationLadder_def Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span>      
      Suc_eq_plus1_left le_add1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> index_plus_1_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="skolem">index</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.hyps<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> n' index_bound<span class="main">]</span> index_plus_1_bound 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α'</span><span class="main">.</span> LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="skolem">n'</span> <span class="free">D</span><span class="main">)</span> <span class="bound">α'</span> <span class="main">∧</span> 
    ladder_γ <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> <span class="bound">α'</span><span class="main">@</span><span class="free">δ</span> <span class="main">∧</span> ladder_j <span class="free">L</span> <span class="skolem">index</span> <span class="main">&lt;</span> length <span class="bound">α'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="keyword2"><span class="keyword">where</span></span> α'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="skolem">n'</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">α'</span> <span class="main">∧</span> 
    ladder_γ <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> <span class="skolem">α'</span><span class="main">@</span><span class="free">δ</span> <span class="main">∧</span> ladder_j <span class="free">L</span> <span class="skolem">index</span> <span class="main">&lt;</span> length <span class="skolem">α'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> Suc_index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> is_ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc_index_bound n' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> n' <span class="keyword1"><span class="command">have</span></span> n'_less_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_ladder Suc_index_bound is_ladder_def lessI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ladder_α_is_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_α <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span> <span class="main">=</span> ladder_γ <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ix</span></span> <span class="keyword2"><span class="keyword">where</span></span> ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ix</span> <span class="main">=</span> ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">=</span> ladder_γ <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> intro<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span><span class="skolem">α'</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="skolem">ix</span> <span class="skolem">E</span> <span class="skolem">j</span> <span class="skolem">γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> E LeftDerivationIntrosAt_def α' γ ladder_α_is_γ 
      diff_Suc_1 e i ix j local.step n' n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> is_eq_fst_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> fst <span class="skolem">e</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntrosAt_def diff_Suc_1 e i local.step n'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_less_α'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">α'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i α' ladder_i_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">∨</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_index_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntros_def LeftDerivationLadder_def Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
          Suc_eq_plus1 Suc_eq_plus1_left le_add1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> LeftDerivationIntrosAt_implies_nonterminal<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span>ladder_α <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_γ_j<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="skolem">γ</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ j ladder_α_def ladder_i_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> LeftDerivationIntro_propagate<span class="main">[</span><span class="operator">OF</span> intro i_less_α' non_γ_j<span class="main">]</span>  
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span> ω<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">α'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span> snd <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span> <span class="skolem">ω</span> <span class="main">∧</span> <span class="skolem">γ</span> <span class="main">=</span> <span class="skolem">ω</span> <span class="main">@</span> <span class="free">δ</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ω</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> α_ω<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span><span class="main">(</span>take <span class="skolem">n'</span> <span class="free">D</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span> snd <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> α' ω LeftDerivation_implies_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> i_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> snd <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_eq_fst_e<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> take_n_D_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>take <span class="skolem">n'</span> <span class="free">D</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">(* automatically found *)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> symbol <span class="main">×</span> symbol list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          <span class="skolem"><span class="skolem">nna</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> symbol <span class="main">×</span> symbol list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          <span class="skolem"><span class="skolem">nnb</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> symbol <span class="main">×</span> symbol list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">ps</span> <span class="bound">psa</span><span class="main">.</span> <span class="main">¬</span> is_ladder <span class="bound">ps</span> <span class="bound">psa</span> <span class="main">∨</span> <span class="bound">psa</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="bound">psa</span> <span class="main">∨</span> 
            ladder_n <span class="bound">psa</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="bound">ps</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">na</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">na</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">na</span> <span class="main">&lt;</span> length <span class="bound">psa</span><span class="main">)</span> <span class="main">∨</span> 
            ladder_n <span class="bound">psa</span> <span class="bound">n</span> <span class="main">&lt;</span> ladder_n <span class="bound">psa</span> <span class="bound">na</span><span class="main">)</span> <span class="main">∧</span> ladder_last_n <span class="bound">psa</span> <span class="main">=</span> length <span class="bound">ps</span><span class="main">)</span> <span class="main">∧</span> 
            <span class="main">(</span><span class="main">∀</span><span class="bound">ps</span> <span class="bound">psa</span><span class="main">.</span> <span class="main">(</span><span class="bound">psa</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">nn</span> <span class="bound">ps</span> <span class="bound">psa</span> <span class="main">&lt;</span> length <span class="bound">psa</span> <span class="main">∧</span> <span class="main">¬</span> ladder_n <span class="bound">psa</span> <span class="main">(</span><span class="skolem">nn</span> <span class="bound">ps</span> <span class="bound">psa</span><span class="main">)</span> <span class="main">≤</span> 
              length <span class="bound">ps</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">nna</span> <span class="bound">ps</span> <span class="bound">psa</span> <span class="main">&lt;</span> <span class="skolem">nnb</span> <span class="bound">ps</span> <span class="bound">psa</span> <span class="main">∧</span> <span class="skolem">nnb</span> <span class="bound">ps</span> <span class="bound">psa</span> <span class="main">&lt;</span> length <span class="bound">psa</span><span class="main">)</span> <span class="main">∧</span> 
              <span class="main">¬</span> ladder_n <span class="bound">psa</span> <span class="main">(</span><span class="skolem">nna</span> <span class="bound">ps</span> <span class="bound">psa</span><span class="main">)</span> <span class="main">&lt;</span> ladder_n <span class="bound">psa</span> <span class="main">(</span><span class="skolem">nnb</span> <span class="bound">ps</span> <span class="bound">psa</span><span class="main">)</span> <span class="main">∨</span> 
              ladder_last_n <span class="bound">psa</span> <span class="main">≠</span> length <span class="bound">ps</span><span class="main">)</span> <span class="main">∨</span> is_ladder <span class="bound">ps</span> <span class="bound">psa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_ladder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_n <span class="free">L</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_ladder <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>ladder_last_n <span class="free">L</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 index_plus_1_bound is_ladder 
            min.absorb2 n_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">n'</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">@</span> take <span class="skolem">n</span> <span class="free">D</span> <span class="main">!</span> <span class="skolem">n'</span> <span class="main">#</span> <span class="skolem">E</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="free">D</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> E id_take_nth_drop length_take n'_less_n<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> f3 f2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> append_assoc append_eq_conv_conj 
            dual_order.strict_implies_order e length_take min.absorb2 n'_less_n nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>             
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">using</span></span> α_ω i_e take_n_D_e <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">using</span></span> γ ω <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> ω j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2  
    <span class="keyword1"><span class="command">from</span></span> LeftDerivationIntro_finish<span class="main">[</span><span class="operator">OF</span> intro i_less_α'<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> kwδ'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">E</span> <span class="main">∧</span>
       LeftDerivation <span class="skolem">α'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span> snd <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> take <span class="skolem">k</span> <span class="skolem">E</span><span class="main">)</span> <span class="skolem">ω</span> <span class="main">∧</span>
       LeftDerivation <span class="main">(</span><span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span> snd <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> take <span class="skolem">k</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
       derivation_ge <span class="main">(</span>drop <span class="skolem">k</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">ω</span><span class="main">)</span> <span class="main">∧</span>
       LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">k</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">ω</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">δ'</span> <span class="main">∧</span> 
       <span class="skolem">γ</span> <span class="main">=</span> <span class="skolem">ω</span> <span class="main">@</span> <span class="skolem">δ'</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ω</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_last_n_1<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_n <span class="free">L</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.hyps"</span> Suc_eq_plus1 diff_Suc_1 ladder_last_n_def n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> is_ladder <span class="keyword1"><span class="command">have</span></span> ladder_last_n_2<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_n <span class="free">L</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_ladder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> ladder_last_n_1 ladder_last_n_2 <span class="keyword1"><span class="command">have</span></span> n_eq_length_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
    <span class="keyword1"><span class="command">have</span></span> take_split<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span> <span class="main">=</span> <span class="main">(</span>take <span class="skolem">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">,</span> snd <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> take <span class="skolem">k</span> <span class="skolem">E</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> E n_eq_length_D<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons_eq_appendI add_Suc append_eq_appendI e 
        is_eq_fst_e n'_less_n n_eq_length_D prod.collapse 
        self_append_conv2 take_Suc_conv_app_nth take_add<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> α_ω<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> take_split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LeftDerivation_implies_append<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">α'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> kwδ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> Suc_n'_k_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E kwδ' n'_less_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>   
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">n'</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_prev_n_def n'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Suc_n'_k_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">ω</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> α_ω <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> α_ω LeftDerivationFix_def LeftDerivationLadder_def LeftDerivation_append_suffix 
        Suc.prems<span class="main">(</span>1<span class="main">)</span> is_sentence_concat <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> E add.commute add_Suc_right drop_drop kwδ' n_eq_length_D nat_le_linear 
        take_all<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">δ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> E LeftDerivationLadder_ladder_n_bound Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_index_bound 
        add.commute add_Suc_right drop_drop kwδ' n_def n_eq_length_D take_all<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> γ kwδ' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> j kwδ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> ladder_i_of_cut_at_0<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> L_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_i <span class="main">(</span>ladder_cut <span class="free">L</span> <span class="free">n</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_non_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_cut_def ladder_i_def deriv_i_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms hd_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>  
    <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_cut_def ladder_i_def deriv_i_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_is_0_eq hd_conv_nth leD list_update_nonempty nth_list_update_neq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> ladder_last_j_of_cut<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> L_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="main">(</span>ladder_cut <span class="free">L</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> ladder_last_j <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> length_L_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_non_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_ladder_cut<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>ladder_cut <span class="free">L</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ladder_cut_def length_list_update<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_last_j_def length_ladder_cut<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_cut_def ladder_j_def deriv_j_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_L_nonzero diff_less neq0_conv nth_list_update_eq snd_conv zero_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_ladder_cut<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>ladder_cut <span class="free">L</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> length <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ladder_cut_def length_list_update<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_last_n_of_cut<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_last_n <span class="main">(</span>ladder_cut <span class="free">L</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_last_n_def length_ladder_cut<span class="main"><span class="main">[</span></span><span class="operator">OF</span> L_non_empty<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_def ladder_cut_def deriv_n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms diff_Suc_less fst_conv length_greater_0_conv nth_list_update_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> ladder_n_of_cut<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="main">(</span>ladder_cut <span class="free">L</span> <span class="free">n</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="free">index</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ladder_cut_def ladder_n_def nat_neq_iff nth_list_update_neq<span class="main">)</span>
     
<span class="keyword1"><span class="command">lemma</span></span> ladder_n_prev_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="free">u</span> <span class="main">≤</span> ladder_prev_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="free">u</span> <span class="main">≤</span> ladder_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> u_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> diff_Suc_less is_ladder_def ladder leI length_greater_0_conv 
        not_less_eq numeral_2_eq_2 order.order_iff_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_diff_Suc diff_Suc_1 ladder_prev_n_def neq0_conv not_less0 
      numeral_2_eq_2 u_bound zero_less_diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1"><span class="command">lemma</span></span> ladder_n_last_is_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms is_ladder_def ladder_last_n_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_ge_shift_implies_derivation_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dge<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>derivation_shift <span class="free">F</span> <span class="main">0</span> <span class="free">j</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">F</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>derivation_shift <span class="free">F</span> <span class="main">0</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≥</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dge derivation_ge_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol <span class="main">×</span> <span class="main">(</span>symbol list<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>derivation_shift <span class="free">F</span> <span class="main">0</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span> <span class="main">-</span> <span class="main">0</span> <span class="main">+</span> <span class="free">j</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="free">F</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ir diff_zero image_eqI prod.collapse prod.inject<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="free">j</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dge derivation_ge_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">-</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> derivation_ge_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1"><span class="command">lemma</span></span> Derives1_bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="free">a</span> <span class="free">i</span> <span class="free">r</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_bound Derives1_take append_Nil2 append_take_drop_id drop_eq_Nil 
    dual_order.strict_implies_order length_take min.absorb2 nat_le_linear<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_Derives1_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">a</span> <span class="free">D</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">(</span>Derive <span class="free">a</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">D</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>last <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>last <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LeftDerivation_Derive_take_LeftDerives1 LeftDerivation_implies_Derivation 
  LeftDerives1_implies_Derives1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> last_conv_nth le_refl length_0_conv take_all<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> last_of_prefix_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="free">E</span><span class="main">@</span><span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"last <span class="free">E</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>drop <span class="free">n</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> last <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">E</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Cons_nth_drop_Suc assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> append.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_butlast_last_id append_eq_conv_conj assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> drop_append in_set_dropD insertCI list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_cut_appendix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="main">(</span><span class="free">β</span><span class="main">@</span><span class="free">δ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dge<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="free">β</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="free">i</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">j</span> <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">α</span><span class="main">@</span><span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> D<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> β<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">β</span><span class="main">@</span><span class="free">δ'</span>"</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> EF<span class="main">:</span>
    <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
     is_sentence <span class="main">(</span><span class="free">β</span> <span class="main">@</span> <span class="free">δ'</span><span class="main">)</span> <span class="main">∧</span>
     LeftDerivation <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="main">(</span><span class="free">β</span> <span class="main">@</span> <span class="free">δ'</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">β</span> <span class="main">@</span> <span class="free">δ'</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">β</span> <span class="main">@</span> <span class="free">δ'</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∧</span>
     <span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="main">(</span><span class="free">β</span> <span class="main">@</span> <span class="free">δ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">β</span> <span class="main">@</span> <span class="free">δ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ldfix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> i_in j_in <span class="keyword1"><span class="command">have</span></span> take_i_E_take_j<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span>take <span class="free">i</span> <span class="free">α</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">β</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_or_eq_imp_le<span class="main">)</span>  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> n_less_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> E_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gr_implies_not0 list.size<span class="main">(</span>3<span class="main">)</span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> last_E_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="skolem">E</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="free">D</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> last_of_prefix_in_set n_less_m m EF <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> kr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> last <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> old.prod.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> k_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> length <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dge last_E_in_set kr
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> derivation_ge_def fst_conv<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α'</span><span class="main">.</span> Derives1 <span class="bound">α'</span> <span class="skolem">k</span> <span class="skolem">r</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">β</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> LeftDerivation_Derives1_last take_i_E_take_j
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> E_nonempty kr fst_conv snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_bound' j_in length_take less_imp_le_nat min.absorb2<span class="main">)</span>   
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">from</span></span> k_lower_bound k_upper_bound <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m_le_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">have</span></span> take_i_E_take_j<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span>take <span class="free">i</span> <span class="free">α</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">β</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_i_E_take_j<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> <span class="main">(</span>take <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> EF m m_le_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> take_n_D<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> <span class="main">(</span>derivation_shift <span class="main">(</span>take <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_derivation_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F'</span></span> <span class="keyword2"><span class="keyword">where</span></span> F'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F'</span> <span class="main">=</span> derivation_shift <span class="main">(</span>take <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="main">(</span>take <span class="free">i</span> <span class="free">α</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span><span class="main">(</span>take <span class="free">j</span> <span class="free">β</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> take_i_E_take_j
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF LeftDerivation_append_suffix append_take_drop_id is_sentence_concat<span class="main">)</span>     
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="skolem">E</span> <span class="main">(</span><span class="main">(</span>take <span class="free">j</span> <span class="free">β</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> take_n_D <span class="keyword1"><span class="command">have</span></span> take_j_drop_i<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="main">(</span>take <span class="free">j</span> <span class="free">β</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F'</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F'  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derivation_unique_dest LeftDerivation_append LeftDerivation_implies_Derivation α_β<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> F'_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">F'</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F' derivation_ge_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> drop_append<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">i</span> <span class="free">α</span> <span class="main">=</span> <span class="main">[</span><span class="free">α</span><span class="main">!</span><span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc i_in<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> take_append<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">j</span> <span class="free">β</span> <span class="main">@</span> <span class="main">[</span><span class="free">α</span><span class="main">!</span><span class="free">i</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationFix_def i_in j_in ldfix nth_superfluous_append take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> take_drop_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">j</span> <span class="free">β</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="free">i</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">β</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">α</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_append take_append<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> take_drop_Suc take_j_drop_i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="main">(</span>take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">β</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F'</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> helper <span class="main">=</span> LeftDerivation_skip_prefix<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> len_take<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">β</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI j_in min.absorb2<span class="main">)</span>    
  <span class="keyword1"><span class="command">have</span></span> F'_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_shift <span class="skolem">F'</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> take <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F' derivation_shift_right_left_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> LeftDerivation_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">β</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> helper len_take F'_shift F'_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_is_sentence is_sentence_concat ldfix <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_is_sentence is_sentence_concat ldfix <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> α_β <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> i_in <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> j_in <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_def i_in j_in ldfix <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> take_n_D <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> take_i_E_take_j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivation_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_cut_appendix'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="main">(</span><span class="free">β</span><span class="main">@</span><span class="free">δ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="free">D</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="free">i</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">j</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> LeftDerivationFix_cut_appendix<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ldfix<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> α_β n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_in <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> j_in <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_cut_appendix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="main">(</span><span class="free">β</span><span class="main">@</span><span class="free">δ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dge<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="free">β</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">j</span> <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationIntro_def<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">α</span><span class="main">@</span><span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ix<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ix</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> D<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">β</span><span class="main">@</span><span class="free">δ'</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span> ω<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">ω</span> <span class="main">∧</span>
      <span class="free">ix</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> snd <span class="free">r</span> <span class="main">!</span> <span class="free">ix</span> <span class="main">=</span> <span class="main">(</span><span class="free">β</span> <span class="main">@</span> <span class="free">δ'</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∧</span> LeftDerivationFix <span class="skolem">ω</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="main">(</span><span class="free">β</span> <span class="main">@</span> <span class="free">δ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ldfix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α'</span><span class="main">.</span> <span class="skolem">ω</span> <span class="main">=</span> <span class="bound">α'</span> <span class="main">@</span> <span class="free">δ</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> length <span class="bound">α'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> i_in <span class="keyword1"><span class="command">using</span></span> LeftDerives1_append_replace_in_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="keyword2"><span class="keyword">where</span></span> α'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ω</span> <span class="main">=</span> <span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">α'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> α_α'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">α'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> α' ω <span class="keyword1"><span class="command">using</span></span> LeftDerives1_skip_suffix i_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> α_β <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">u</span> <span class="main">∧</span> LeftDerivation <span class="skolem">u</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> α_α' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">α'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derives1_unique_dest LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> u <span class="keyword1"><span class="command">have</span></span> α'_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">α'</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ldfix_append<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="skolem">α'</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="main">(</span><span class="free">β</span> <span class="main">@</span> <span class="free">δ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> α' ω <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> i_plus_ix_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">ix</span> <span class="main">&lt;</span> length <span class="skolem">α'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ω α'
    <span class="keyword1"><span class="command">using</span></span> add_lessD1 le_add_diff_inverse less_asym' linorder_neqE_nat nat_add_left_cancel_less 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_cut_appendix<span class="main">[</span><span class="operator">OF</span> ldfix_append α'_β n_bound dge i_plus_ix_bound j_in<span class="main">]</span>  
  <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="skolem">α'</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">j</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntro_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">α'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> α_α' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ω <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ω j_in<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ldfix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_cut_appendix'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="main">(</span><span class="free">β</span><span class="main">@</span><span class="free">δ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">#</span><span class="free">D</span><span class="main">)</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="free">j</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> LeftDerivationIntro_cut_appendix<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ldfix<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> α_β n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_in <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> j_in <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_n_monotone<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_n <span class="free">L</span> <span class="free">u</span> <span class="main">≤</span> ladder_n <span class="free">L</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ladder_def le_neq_implies_less linear not_less<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> ladder_i_cut<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_i <span class="main">(</span>ladder_cut <span class="free">L</span> <span class="free">n</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="free">index</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">index</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 
      <span class="keyword1"><span class="command">with</span></span> index_bound <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_of_cut_at_0<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_def ladder_cut_def ladder_j_def deriv_j_def Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> index_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_j_cut<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_j <span class="main">(</span>ladder_cut <span class="free">L</span> <span class="free">n</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="free">index</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr_implies_not0 index_bound ladder_cut_def ladder_j_def ladder_last_j_def 
  ladder_last_j_of_cut length_ladder_cut list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_list_update_neq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_ix_cut<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> index_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_ix <span class="main">(</span>ladder_cut <span class="free">L</span> <span class="free">n</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> ladder_ix <span class="free">L</span> <span class="free">index</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> index_lower_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_ix_def deriv_ix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> index_upper_bound ladder_cut_def nth_list_update_eq nth_list_update_neq snd_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivation_from_in_between<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α_β<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="free">u</span> <span class="free">D</span><span class="main">)</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="free">v</span> <span class="free">D</span><span class="main">)</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u_le_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">β</span> <span class="main">(</span>drop <span class="free">u</span> <span class="main">(</span>take <span class="free">v</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="free">γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> take_split<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">v</span> <span class="free">D</span> <span class="main">=</span> take <span class="free">u</span> <span class="free">D</span> <span class="main">@</span> <span class="main">(</span>drop <span class="free">u</span> <span class="main">(</span>take <span class="free">v</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> u_le_v add_diff_cancel_left' drop_take le_Suc_ex take_add<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> α_γ α_β
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Derivation_unique_dest LeftDerivation_append 
      LeftDerivation_implies_Derivation<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_cut_appendix_helper<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> LDLadder<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder_i_in_α<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">E</span> <span class="bound">F</span> <span class="bound">γ1</span> <span class="bound">γ2</span> <span class="bound">L'</span><span class="main">.</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">E</span><span class="main">@</span><span class="bound">F</span> <span class="main">∧</span> 
    <span class="free">γ</span> <span class="main">=</span> <span class="bound">γ1</span> <span class="main">@</span> <span class="bound">γ2</span> <span class="main">∧</span> 
    LeftDerivationLadder <span class="free">α</span> <span class="bound">E</span> <span class="bound">L'</span> <span class="bound">γ1</span> <span class="main">∧</span> 
    derivation_ge <span class="bound">F</span> <span class="main">(</span>length <span class="bound">γ1</span><span class="main">)</span> <span class="main">∧</span>
    LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="bound">F</span> <span class="main">(</span>length <span class="bound">γ1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="bound">γ2</span> <span class="main">∧</span>
    <span class="bound">L'</span> <span class="main">=</span> ladder_cut <span class="free">L</span> <span class="main">(</span>length <span class="bound">E</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> is_ladder_D_L<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LDLadder LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> ladder_last_n <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n_eq_ladder_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ladder_last_n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> length_L_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def assms<span class="main">(</span>1<span class="main">)</span> is_ladder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationLadder_propagate<span class="main">[</span><span class="operator">OF</span> LDLadder ladder_i_in_α n_eq_ladder_n<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> finish<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> ladder_prev_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">∧</span>
     <span class="skolem">n'</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">∧</span>
     LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="skolem">n'</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">β</span> <span class="main">∧</span>
     LeftDerivation <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">β</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
     derivation_ge <span class="main">(</span>drop <span class="skolem">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span>
     LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">β</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">δ'</span> <span class="main">∧</span>
     ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">β</span> <span class="main">@</span> <span class="skolem">δ'</span> <span class="main">∧</span> ladder_j <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">β</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> take <span class="skolem">n'</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> drop <span class="skolem">n'</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> ladder_cut <span class="free">L</span> <span class="main">(</span>length <span class="skolem">E</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> γ_ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">=</span> ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LDLadder LeftDerivationLadder_def LeftDerivation_implies_Derivation 
      append_Nil2 append_take_drop_id drop_eq_Nil is_ladder_def ladder_γ_def le_refl n 
      n_eq_ladder_n<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">=</span> <span class="skolem">β</span> <span class="main">@</span> <span class="skolem">δ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finish <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LDLadder LeftDerivationFix_is_sentence LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_sentence_α<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Derivation_implies_derives LDLadder LeftDerivationFix_is_sentence 
      LeftDerivationLadder_def LeftDerivation_implies_Derivation derives_is_sentence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_sentence_β<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> γ is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> length_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">L'</span> <span class="main">=</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L' ladder_cut_def length_list_update<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ladder_last_n_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_n <span class="skolem">L'</span> <span class="main">=</span> length <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L' ladder_last_n_of_cut length_L_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> length_D_eq_n<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">D</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LDLadder LeftDerivationLadder_def is_ladder_def n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>     
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_E_eq_n'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">E</span> <span class="main">=</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> E finish min.absorb2<span class="main">)</span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">L'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">u</span> <span class="main">=</span> length <span class="skolem">L'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">u</span> <span class="main">≤</span> length <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span> 
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">have</span></span> u_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_L'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> L'_eq_L<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">u</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L' ladder_n_of_cut 
          length_L_nonzero length_greater_0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">from</span></span> u_bound <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="skolem">u</span> <span class="main">≤</span> ladder_prev_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> ladder_n_prev_bound LeftDerivationLadder_def assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> L'_eq_L finish length_E_eq_n' u_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">u</span> <span class="main">=</span> length <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ladder_last_n_L' ladder_last_n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> ladder_n_bound <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> u_less_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> v_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="skolem">L'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">=</span> length <span class="skolem">L'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">u</span> <span class="main">&lt;</span> ladder_n <span class="skolem">L'</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span> L' LeftDerivationLadder_def assms<span class="main">(</span>1<span class="main">)</span> is_ladder_def ladder_n_of_cut 
            length_L' u_less_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">note</span></span> v_def <span class="main">=</span> 2
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> u_less_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_prev_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finish v_def length_L' 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> L' LeftDerivationLadder_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
              ladder_last_n_L' ladder_last_n_def ladder_n_of_cut ladder_n_prev_bound 
              le_neq_implies_less length_E_eq_n' length_L' length_greater_0_conv 
              less_trans u_less_v v_def<span class="main">)</span> 
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> ladder_n_pairwise_bound <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> is_ladder_E_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="skolem">E</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def ladder_last_n_L'<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> length_L_nonzero length_L' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> ladder_n_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ladder_n_pairwise_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> index_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">from</span></span> index_bound <span class="keyword1"><span class="command">have</span></span> len_L_minus_1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="skolem">index</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> LeftDerivationLadder_propagate<span class="main">[</span><span class="operator">OF</span> LDLadder ladder_i_in_α m index_le<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      ω<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">ω</span> <span class="main">∧</span> ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> <span class="skolem">ω</span> <span class="main">@</span> <span class="free">δ</span> <span class="main">∧</span> 
      ladder_j <span class="free">L</span> <span class="skolem">index</span> <span class="main">&lt;</span> length <span class="skolem">ω</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> L'_Derive<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> Derive <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_γ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_n_L'_eq_L<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L' index_bound ladder_n_of_cut length_L_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_prev_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finish len_L_minus_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n'_is_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_bound
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_diff_left ladder_prev_n_def len_L_minus_1 one_add_one<span class="main">)</span>  
    <span class="keyword1"><span class="command">have</span></span> index_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">≤</span> length <span class="free">L</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>  
    <span class="keyword1"><span class="command">have</span></span> ladder_n_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="skolem">index</span> <span class="main">≤</span> ladder_n <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> ladder_n_monotone<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> is_ladder_D_L<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> index_upper_bound<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> n'_is_upper_bound <span class="keyword1"><span class="command">have</span></span> m_le_n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dual_order.strict_implies_order le_less_trans m <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">m</span> <span class="skolem">E</span> <span class="main">=</span> take <span class="skolem">m</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> E le_take_same length_E_eq_n' order_refl take_all<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> take_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">=</span> take <span class="skolem">m</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_L'_eq_L m<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Derive_eq_ω<span class="main">:</span> <span class="quoted"><span class="quoted">"Derive <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ω</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derive LeftDerivation_implies_Derivation ω<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">@</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L'_Derive ω<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ω_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ω</span> <span class="main">=</span> ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derive_eq_ω L'_Derive<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ω m <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> t3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m take_helper<span class="main">)</span>     
    <span class="keyword1"><span class="command">have</span></span> t4<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="free">L</span> <span class="skolem">index</span> <span class="main">&lt;</span> length <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ω ω_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>     
    <span class="keyword1"><span class="command">have</span></span> t5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">!</span> <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">=</span> <span class="free">D</span> <span class="main">!</span> <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E ladder_n_L'_eq_L ladder_n_upper_bound n'_is_upper_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> t1 t2 t3 t4 t5
  <span class="keyword1"><span class="command">}</span></span>  
  <span class="keyword1"><span class="command">note</span></span> ladder_early_stage <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L' ladder_i_cut <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_bound<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L' ladder_j_cut <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_bound<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> ladder_ix <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_ix <span class="free">L</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L' ladder_ix_cut <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_bound<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_α <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> <span class="main">(</span>ladder_α <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">@</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_bound ladder_α_def ladder_early_stage<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> i_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> ladder_i <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">&lt;</span> length <span class="main">(</span>ladder_α <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i index_bound ladder_α_def ladder_early_stage<span class="main">(</span>4<span class="main">)</span> ladder_i_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>     
    <span class="keyword1"><span class="command">note</span></span> ij <span class="main">=</span> i j ix α i_bound
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> ladder_every_stage <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> u_le_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> v_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="skolem">u</span> <span class="main">≤</span> ladder_n <span class="free">L</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_ladder_D_L ladder_n_monotone u_le_v v_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>       
  <span class="keyword1"><span class="command">note</span></span> ladder_L_n_pairwise_le <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> index_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> index_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> derivation <span class="main">=</span> ladder_early_stage<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> derivation1<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> derivation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">]</span> index_lower_bound index_upper_bound
      <span class="keyword1"><span class="command">using</span></span> One_nat_def Suc_diff_1 Suc_eq_plus1 le_less_trans lessI less_or_eq_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">have</span></span> derivation2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> derivation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">index</span></span><span class="main">]</span> index_upper_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_α_is_γ<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> ladder_α <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> index_lower_bound ladder_α_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_n_le<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> ladder_n <span class="free">L</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> ladder_L_n_pairwise_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">using</span></span> index_upper_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span> 
    <span class="keyword1"><span class="command">from</span></span> LeftDerivation_from_in_between<span class="main">[</span><span class="operator">OF</span> derivation1 derivation2 ladder_n_le<span class="main">]</span> ladder_α_is_γ
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span>ladder_α <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L' Suc_leI add_lessD1 index_lower_bound index_upper_bound ladder_early_stage<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
        ladder_n_of_cut le_add_diff_inverse2 length_L_nonzero length_greater_0_conv less_diff_conv<span class="main">)</span>          
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> LeftDerivation_delta_early <span class="main">=</span> this 
   
  <span class="keyword1"><span class="command">have</span></span> LeftDerivationFix_α_0<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="main">(</span>ladder_i <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span> 
    <span class="main">(</span>ladder_j <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> 
      <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LDLadder LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_i_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="main">0</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L' ladder_i_of_cut_at_0 length_L_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_j_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="skolem">L'</span> <span class="main">0</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L' ladder_cut_def ladder_j_def ladder_last_j_def ladder_last_j_of_cut 
         length_L' length_greater_0_conv nth_list_update_neq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> ladder_n_L'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">n'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> diff_is_0_eq' ladder_last_n_L' ladder_last_n_def length_E_eq_n' 
            length_L' less_or_eq_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">have</span></span> take_n'_E<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">n'</span> <span class="skolem">E</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_E_eq_n'<span class="main">)</span> 
        <span class="keyword1"><span class="command">from</span></span> ladder_n_L'_0 take_n'_E <span class="keyword1"><span class="command">have</span></span> take_ladder_n_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="main">0</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.hyps"</span> length_D_eq_n n_eq_ladder_n<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> take_ladder_n_L_0<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
        <span class="keyword1"><span class="command">have</span></span> ladder_γ_α<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_γ_def take_ladder_n_L'<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Derive E LeftDerivation_implies_Derivation finish<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> ladder_j_in_β<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="free">L</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">β</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> finish <span class="quoted">"1.hyps"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">have</span></span> ldfix_1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">β</span><span class="main">@</span><span class="skolem">δ'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span> γ γ_ladder ldfix take_ladder_n_L_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> E LeftDerivationFix_cut_appendix finish ladder_i_in_α ladder_j_in_β 
            length_D_eq_n<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_L' ladder_j_L' take_ladder_n_L' ladder_γ_α<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.hyps"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">note</span></span> stage <span class="main">=</span> ladder_early_stage<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span></span></span></span></span><span class="main">,</span> <span class="operator">OF</span> h<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> ldfix0<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> 
          <span class="main">(</span><span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="main">@</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ladder_i_L' ladder_j_L' ldfix stage<span class="main">(</span>1<span class="main">)</span> stage<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_cut_appendix'<span class="main">[</span><span class="operator">OF</span> ldfix0 stage<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ladder_i_in_α stage<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_L' ladder_j_L' stage<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> index_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">index</span> <span class="main">∧</span> <span class="skolem">index</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> introsAt_appendix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LDLadder LeftDerivationIntros_def LeftDerivationLadder_def add_lessD1 index_bounds 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> index_plus_1_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_bounds <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">note</span></span> early_stage <span class="main">=</span> ladder_early_stage<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">index</span></span></span></span></span></span></span></span></span></span><span class="main">,</span> <span class="operator">OF</span> index_plus_1_upper_bound<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_i_L_index_eq_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> introsAt_appendix LeftDerivationIntrosAt_def index_bounds <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> E_at_D_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ladder_early_stage<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">index</span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">-</span></span></span></span></span> Suc <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">0</span></span></span></span></span>"</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def add_lessD1 index_bounds le_add_diff_inverse2<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ladder_i_L'_index_eq_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">E</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> index_bounds ladder_i_L_index_eq_fst ladder_every_stage<span class="main">(</span>1<span class="main">)</span> le_add1 le_less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> same_derivation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> L' early_stage<span class="main">(</span>3<span class="main">)</span> index_bounds ladder_n_of_cut length_L_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> deriv_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">(</span>ladder_i <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">,</span> snd <span class="main">(</span><span class="skolem">E</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span>
      drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc One_nat_def Suc_le_lessD add_lessD1 diff_Suc_less index_bounds 
        ladder_i_L'_index_eq_fst ladder_n_bound ladder_n_pairwise_bound length_L' 
        length_take min.absorb2 nth_take prod.collapse<span class="main">)</span>       
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntrosAt_def Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ladder_i_L'_index_eq_fst <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> LeftDerivationIntro_cut_appendix'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> δ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">δ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> δ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">δ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> E_at_D_at LeftDerivationIntrosAt_def One_nat_def Suc_le_lessD add_lessD1 
        early_stage<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_bounds introsAt_appendix ladder_every_stage<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
        ladder_every_stage<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ladder_every_stage<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ladder_i_L'_index_eq_fst same_derivation<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1
      <span class="keyword1"><span class="command">using</span></span> index_bounds ladder_every_stage<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> early_stage<span class="main">(</span>4<span class="main">)</span> index_bounds ladder_every_stage<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivation_delta_early deriv_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_le_eq index_bounds<span class="main">)</span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> LeftDerivationIntrosAt_early <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> index_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">index</span> <span class="main">∧</span> <span class="skolem">index</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> introsAt_appendix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LDLadder LeftDerivationIntros_def LeftDerivationLadder_def add_lessD1 index_bounds
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 not_less_eq<span class="main">)</span>      
    <span class="keyword1"><span class="command">have</span></span> ladder_i_L_index_eq_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> introsAt_appendix LeftDerivationIntrosAt_def index_bounds <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> E_at_D_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ladder_early_stage<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">index</span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">-</span></span></span></span></span> Suc <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">0</span></span></span></span></span>"</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 index_bounds le_add_diff_inverse2 lessI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ladder_i_L'_index_eq_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">E</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> index_bounds ladder_i_L_index_eq_fst ladder_every_stage<span class="main">(</span>1<span class="main">)</span> le_add1 le_less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> D'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_n_L'_index<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> length <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_add_inverse2 index_bounds ladder_last_n_L' ladder_last_n_def length_L'<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> take_is_E<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_L'_index<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_n_L_index<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_add_inverse2 index_bounds length_D_eq_n n_eq_ladder_n<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> take_is_D<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_L_index<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> write_as_take_k_D'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">=</span> take <span class="skolem">k</span> <span class="skolem">D'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> take_is_D
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> D' E L' One_nat_def Suc_le_lessD add_diff_cancel_right' diff_Suc_less 
        drop_take index_bounds k ladder_n_L'_index ladder_n_of_cut length_E_eq_n' 
        length_L_nonzero length_greater_0_conv<span class="main">)</span>   
    <span class="keyword1"><span class="command">have</span></span> k_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">D'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add append_take_drop_id k ladder_n_L'_index length_append 
        length_drop write_as_take_k_D'<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> D'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D' take_is_D<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntrosAt_def Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ladder_i_L'_index_eq_fst <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> take_is_E<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> write_as_take_k_D'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> LeftDerivationIntro_cut_appendix<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> δ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">δ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> δ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">δ'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> D' Derive E E_at_D_at LeftDerivationIntrosAt_def 
        LeftDerivation_implies_Derivation One_nat_def Suc_le_lessD add_diff_cancel_right' 
        diff_Suc_less finish index_bounds introsAt_appendix ladder_γ_def ladder_every_stage<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
        ladder_every_stage<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ladder_every_stage<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ladder_i_L'_index_eq_fst length_L_nonzero 
        take_is_E<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc E L' LeftDerivation_from_in_between LeftDerivation_take_derive 
        One_nat_def Suc_le_lessD add_diff_cancel_right' diff_Suc_less finish index_bounds 
        ladder_α_def ladder_γ_def ladder_i_L'_index_eq_fst ladder_n_L'_index ladder_n_of_cut 
        ladder_prev_n_def length_E_eq_n' length_L_nonzero less_imp_le_nat less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
        list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prod.collapse take_is_E write_as_take_k_D'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> k_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> D'_alt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Derive E L' LeftDerivation_implies_Derivation 
        One_nat_def Suc_leI Suc_le_lessD add_diff_cancel_right' diff_Suc_less drop_drop finish 
        index_bounds k ladder_γ_def ladder_n_L'_index ladder_n_of_cut ladder_prev_n_def 
        le_add_diff_inverse2 length_E_eq_n' length_L_nonzero length_greater_0_conv 
        less_not_refl2 take_is_E<span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> index_bounds ladder_every_stage<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive E LeftDerivation_implies_Derivation One_nat_def add_diff_cancel_right' 
        diff_Suc_less finish index_bounds ladder_γ_def ladder_every_stage<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_L_nonzero 
        take_is_E<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> LeftDerivationIntrosAt_last <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> ladder_E_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">β</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> finish E <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_E_L' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_α_0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationIntros_def LeftDerivationIntrosAt_early LeftDerivationIntrosAt_last
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI le_neq_implies_less length_L'<span class="main">)</span>
    
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">δ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> E F <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> γ<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ladder_E_L' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> F finish <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> F finish <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> L'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">theorem</span></span> LeftDerivationLadder_cut_appendix<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> LDLadder<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">δ</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder_i_in_α<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">E</span> <span class="bound">F</span> <span class="bound">γ1</span> <span class="bound">γ2</span> <span class="bound">L'</span><span class="main">.</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">E</span><span class="main">@</span><span class="bound">F</span> <span class="main">∧</span> 
    <span class="free">γ</span> <span class="main">=</span> <span class="bound">γ1</span> <span class="main">@</span> <span class="bound">γ2</span> <span class="main">∧</span> 
    LeftDerivationLadder <span class="free">α</span> <span class="bound">E</span> <span class="bound">L'</span> <span class="bound">γ1</span> <span class="main">∧</span> 
    derivation_ge <span class="bound">F</span> <span class="main">(</span>length <span class="bound">γ1</span><span class="main">)</span> <span class="main">∧</span>
    LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="bound">F</span> <span class="main">(</span>length <span class="bound">γ1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="bound">γ2</span> <span class="main">∧</span>
    length <span class="bound">L'</span> <span class="main">=</span> length <span class="free">L</span> <span class="main">∧</span> ladder_i <span class="bound">L'</span> <span class="main">0</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">∧</span>
    ladder_last_j <span class="bound">L'</span> <span class="main">=</span> ladder_last_j <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationLadder_cut_appendix_helper<span class="main">[</span><span class="operator">OF</span> LDLadder ladder_i_in_α<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">γ1</span></span> <span class="skolem"><span class="skolem">γ2</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> helper<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> <span class="skolem">F</span> <span class="main">∧</span>
     <span class="free">γ</span> <span class="main">=</span> <span class="skolem">γ1</span> <span class="main">@</span> <span class="skolem">γ2</span> <span class="main">∧</span>
     LeftDerivationLadder <span class="free">α</span> <span class="skolem">E</span> <span class="skolem">L'</span> <span class="skolem">γ1</span> <span class="main">∧</span>
     derivation_ge <span class="skolem">F</span> <span class="main">(</span>length <span class="skolem">γ1</span><span class="main">)</span> <span class="main">∧</span>
     LeftDerivation <span class="free">δ</span> <span class="main">(</span>derivation_shift <span class="skolem">F</span> <span class="main">(</span>length <span class="skolem">γ1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">γ2</span> <span class="main">∧</span> <span class="skolem">L'</span> <span class="main">=</span> ladder_cut <span class="free">L</span> <span class="main">(</span>length <span class="skolem">E</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">γ1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">γ2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> helper LDLadder LeftDerivationLadder_def is_ladder_def ladder_i_of_cut_at_0 
      ladder_last_j_of_cut length_ladder_cut <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_stepdown_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_stepdown_diff</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> Suc <span class="main">(</span>ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_stepdown_α_0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sentence <span class="main">⇒</span> derivation <span class="main">⇒</span> ladder <span class="main">⇒</span> sentence"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_stepdown_α_0</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> Derive <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>take <span class="main">(</span>ladder_stepdown_diff <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_LeftDerives1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"splits_at <span class="free">α</span> <span class="free">i</span> <span class="free">a1</span> <span class="free">A</span> <span class="free">a2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">a1</span><span class="main">@</span><span class="main">(</span>snd <span class="free">r</span><span class="main">)</span><span class="main">@</span><span class="free">a2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntro_def LeftDerivationIntro_examine_rule LeftDerivationIntro_is_sentence 
  LeftDerives1_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.collapse splits_at_implies_Derives1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_Derive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derive <span class="free">α</span> <span class="main">[</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">γ</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LeftDerivation.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> LeftDerivation_LeftDerives1 
  LeftDerivation_implies_Derivation append_Nil assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_stepdown_α_0_altdef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="free">a1</span> <span class="free">A</span> <span class="free">a2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">=</span> <span class="free">a1</span> <span class="main">@</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="free">a2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span> <span class="main">=</span> Derive <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_def ladder_γ_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rule</span></span>  <span class="keyword2"><span class="keyword">where</span></span> rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rule</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">E</span> <span class="bound">ω</span><span class="main">.</span> LeftDerivationIntro <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">rule</span> <span class="main">(</span>ladder_ix <span class="free">L</span> <span class="main">1</span><span class="main">)</span>
    <span class="bound">E</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="bound">ω</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntrosAt_def LeftDerivationIntros_def LeftDerivationLadder_def 
      One_nat_def diff_Suc_1 ladder length_L order_refl rule<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span> intro<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">rule</span> <span class="main">(</span>ladder_ix <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">ω</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">rule</span> <span class="main">(</span><span class="free">a1</span><span class="main">@</span><span class="main">(</span>snd <span class="skolem">rule</span><span class="main">)</span><span class="main">@</span><span class="free">a2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationIntro_LeftDerives1 split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> fst_D<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntrosAt_def LeftDerivationIntros_def LeftDerivationLadder_def 
      One_nat_def diff_Suc_1 ladder le_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> length_L<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> derive_derive<span class="main">:</span> <span class="quoted"><span class="quoted">"Derive <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> 
    Derive <span class="main">(</span>Derive <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Derive <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Derivation_take_derive LeftDerivationLadder_def LeftDerivation_implies_Derivation ladder <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> length_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> length_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span> <span class="main">=</span> take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span> <span class="main">@</span> <span class="main">[</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> LeftDerivationLadder_def is_ladder_def ladder ladder_last_n_def take_Suc_conv_app_nth<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sss</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> symbol <span class="main">×</span> symbol list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> symbol <span class="main">×</span> symbol list<span class="main">)</span> list <span class="main">⇒</span> symbol list <span class="main">⇒</span> symbol list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v4</span><span class="main">.</span> Derivation <span class="bound">x3</span> <span class="bound">x2</span> <span class="bound">v4</span> <span class="main">∧</span> Derivation <span class="bound">v4</span> <span class="bound">x1</span> <span class="bound">x0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Derivation <span class="bound">x3</span> <span class="bound">x2</span> <span class="main">(</span><span class="skolem">sss</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">)</span> <span class="main">∧</span> Derivation <span class="main">(</span><span class="skolem">sss</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">)</span> <span class="bound">x1</span> <span class="bound">x0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f3 f1 Derivation_append Derive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">=</span> Derive <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="free">D</span> <span class="main">!</span> <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_stepdown_α_0_def ladder_stepdown_diff_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">!</span> <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">rule</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rule fst_D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 4 LeftDerives1_Derive snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1"><span class="command">lemma</span></span> ladder_i_0_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> 
    <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ld LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_j_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_j <span class="free">L</span> <span class="free">index</span> <span class="main">&lt;</span> length <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ld'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="main">[]</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ld <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ladder_i_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ladder_i_0_bound ld <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="free">index</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> propagate <span class="main">=</span> LeftDerivationLadder_propagate<span class="main">[</span><span class="operator">OF</span> ld' ladder_i_0 n index_bound<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> index_bound <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">∨</span> <span class="free">index</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">β</span><span class="main">.</span> LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="bound">β</span> <span class="main">∧</span>
         ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span> <span class="main">=</span> <span class="bound">β</span> <span class="main">@</span> <span class="main">[]</span> <span class="main">∧</span> ladder_j <span class="free">L</span> <span class="free">index</span> <span class="main">&lt;</span> length <span class="bound">β</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> propagate <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
        <span class="main">∃</span><span class="bound">n'</span> <span class="bound">β</span> <span class="bound">δ'</span><span class="main">.</span>
          <span class="main">(</span><span class="free">index</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> ladder_prev_n <span class="free">L</span> <span class="free">index</span> <span class="main">&lt;</span> <span class="bound">n'</span><span class="main">)</span> <span class="main">∧</span>
          <span class="bound">n'</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">∧</span>
          LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="bound">n'</span> <span class="free">D</span><span class="main">)</span> <span class="bound">β</span> <span class="main">∧</span>
          LeftDerivation <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="bound">β</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
          derivation_ge <span class="main">(</span>drop <span class="bound">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">β</span><span class="main">)</span> <span class="main">∧</span>
          LeftDerivation <span class="main">[]</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="bound">n'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">β</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="bound">δ'</span> <span class="main">∧</span>
          ladder_γ <span class="main">(</span><span class="free">α</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span> <span class="main">=</span> <span class="bound">β</span> <span class="main">@</span> <span class="bound">δ'</span> <span class="main">∧</span> ladder_j <span class="free">L</span> <span class="free">index</span> <span class="main">&lt;</span> length <span class="bound">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> propagate <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> ladder_last_j_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="free">L</span> <span class="main">&lt;</span> length <span class="free">γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def assms is_ladder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> ladder_j_bound<span class="main">[</span><span class="operator">OF</span> ld this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LeftDerivationLadder_def LeftDerivation_implies_Derivation One_nat_def 
      is_ladder_def ladder_last_j_def last_ladder_γ ld<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ladder_shift_n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ladder <span class="main">⇒</span> ladder"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ladder_shift_n</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ladder_shift_n</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">ladder_shift_n</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ladder_stepdown</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ladder <span class="main">⇒</span> ladder"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ladder_stepdown</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ladder_stepdown</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ladder_stepdown</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i0</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ix1</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="main">-</span> Suc <span class="free"><span class="bound"><span class="entity">n0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j0</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">ix1</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>ladder_shift_n <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span>"</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> ladder_shift_n_length<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>ladder_shift_n <span class="free">N</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> length <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_stepdown_prepare<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">,</span> ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">,</span> ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">#</span>
    <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">1</span><span class="main">,</span> ladder_j <span class="free">L</span> <span class="main">1</span><span class="main">,</span> ladder_ix <span class="free">L</span> <span class="main">1</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>drop <span class="numeral">2</span> <span class="free">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n0</span> <span class="bound">j0</span> <span class="bound">i0</span> <span class="bound">n1</span> <span class="bound">j1</span> <span class="bound">ix1</span> <span class="bound">L'</span><span class="main">.</span> <span class="free">L</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">n0</span><span class="main">,</span> <span class="bound">j0</span><span class="main">,</span> <span class="bound">i0</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="bound">n1</span><span class="main">,</span> <span class="bound">j1</span><span class="main">,</span> <span class="bound">ix1</span><span class="main">)</span><span class="main">#</span><span class="bound">L'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 assms ladder_stepdown.cases less_not_refl list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
      list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_less0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n0</span></span> <span class="skolem"><span class="skolem">j0</span></span> <span class="skolem"><span class="skolem">i0</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="skolem"><span class="skolem">ix1</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n0</span><span class="main">,</span> <span class="skolem">j0</span><span class="main">,</span> <span class="skolem">i0</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">n1</span><span class="main">,</span> <span class="skolem">j1</span><span class="main">,</span> <span class="skolem">ix1</span><span class="main">)</span><span class="main">#</span><span class="skolem">L'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n0</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_def deriv_n_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> L'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_def deriv_n_def ladder_j_def deriv_j_def 
      ladder_i_def deriv_i_def ladder_ix_def deriv_ix_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_stepdown_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>ladder_stepdown <span class="free">L</span><span class="main">)</span> <span class="main">=</span> length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_stepdown_prepare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_n_length<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_stepdown_i_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_i <span class="main">(</span>ladder_stepdown <span class="free">L</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">1</span> <span class="main">+</span> ladder_ix <span class="free">L</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ladder_stepdown_prepare<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> ladder_i_def ladder_j_def deriv_j_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def deriv_i_def diff_Suc_1 ladder_stepdown.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
    snd_conv zero_neq_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_shift_n_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_shift_n <span class="free">N</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">L</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">x</span> <span class="main">-</span> <span class="free">N</span><span class="main">,</span> snd <span class="free">x</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>ladder_shift_n <span class="free">N</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_shift_n_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_shift_n <span class="free">N</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">n</span> <span class="main">(</span>ladder_shift_n <span class="free">N</span> <span class="free">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">L</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_n_cons Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> drop_2_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="numeral">2</span> <span class="free">L</span> <span class="main">!</span> <span class="main">(</span><span class="free">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">L</span> <span class="main">!</span> Suc <span class="free">index</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span> <span class="main">=</span> <span class="free">L</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> <span class="free">L</span> <span class="main">!</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> drop <span class="numeral">2</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="skolem">l1</span> <span class="main">#</span> <span class="skolem">l2</span> <span class="main">#</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">index</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_shift_n_at<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> <span class="main">(</span>ladder_shift_n <span class="free">N</span> <span class="free">L</span><span class="main">)</span> <span class="main">!</span> <span class="free">index</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">L</span> <span class="main">!</span> <span class="free">index</span><span class="main">)</span> <span class="main">-</span> <span class="free">N</span><span class="main">,</span> snd <span class="main">(</span><span class="free">L</span> <span class="main">!</span> <span class="free">index</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">L</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_n_cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">index</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_stepdown_j<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L_greater_1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L'</span> <span class="main">=</span> ladder_stepdown <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_j <span class="free">L'</span> <span class="free">index</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="free">index</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> L_prepare <span class="main">=</span> ladder_stepdown_prepare<span class="main">[</span><span class="operator">OF</span> length_L_greater_1<span class="main">]</span>  
  <span class="keyword1"><span class="command">have</span></span> ladder_stepdown_L_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_stepdown <span class="free">L</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> ladder_j <span class="free">L</span> <span class="main">0</span> <span class="main">+</span> ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span>
    ladder_shift_n <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="numeral">2</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> L_prepare<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">index</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ladder_j <span class="free">L'</span> <span class="free">index</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="free">index</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L' ladder_stepdown_L_def 1 ladder_j_def deriv_j_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> index_bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> index_bound L' ladder_stepdown_length length_L_greater_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L' ladder_stepdown_L_def 2 ladder_j_def ladder_shift_n_drop drop_2_shift<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> drop_2_shift<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> length_L_greater_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_n_length<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_j_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_n_at<span class="main"><span class="main">[</span></span><span class="operator">OF</span> index_bound'<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> ladder_stepdown_last_j<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L_greater_1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="main">(</span>ladder_stepdown <span class="free">L</span><span class="main">)</span> <span class="main">=</span> ladder_last_j <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ladder_stepdown_j Suc_diff_Suc diff_Suc_1 ladder_last_j_def ladder_stepdown_length 
  length_L_greater_1 lessI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_stepdown_n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L_greater_1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L'</span> <span class="main">=</span> ladder_stepdown <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L'</span> <span class="free">index</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="free">index</span><span class="main">)</span> <span class="main">-</span> ladder_stepdown_diff <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> L_prepare <span class="main">=</span> ladder_stepdown_prepare<span class="main">[</span><span class="operator">OF</span> length_L_greater_1<span class="main">]</span>  
  <span class="keyword1"><span class="command">have</span></span> ladder_stepdown_L_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_stepdown <span class="free">L</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> ladder_j <span class="free">L</span> <span class="main">0</span> <span class="main">+</span> ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span>
    ladder_shift_n <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="numeral">2</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> L_prepare<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">index</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L'</span> <span class="free">index</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="free">index</span><span class="main">)</span> <span class="main">-</span> ladder_stepdown_diff <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L' ladder_stepdown_L_def 1 ladder_n_def deriv_n_def ladder_stepdown_diff_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> index_bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> index_bound L' ladder_stepdown_length length_L_greater_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L' ladder_stepdown_L_def 2 ladder_n_def ladder_shift_n_drop drop_2_shift
          ladder_stepdown_diff_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> drop_2_shift<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> length_L_greater_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_n_length<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_n_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_n_at<span class="main"><span class="main">[</span></span><span class="operator">OF</span> index_bound'<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> ladder_stepdown_ix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L_greater_1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L'</span> <span class="main">=</span> ladder_stepdown <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">index</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> index_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_ix <span class="free">L'</span> <span class="free">index</span> <span class="main">=</span> ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="free">index</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> L_prepare <span class="main">=</span> ladder_stepdown_prepare<span class="main">[</span><span class="operator">OF</span> length_L_greater_1<span class="main">]</span>  
  <span class="keyword1"><span class="command">have</span></span> ladder_stepdown_L_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_stepdown <span class="free">L</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> ladder_j <span class="free">L</span> <span class="main">0</span> <span class="main">+</span> ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span>
    ladder_shift_n <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="numeral">2</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> L_prepare<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      
  <span class="keyword1"><span class="command">have</span></span> index_bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_upper_bound L' ladder_stepdown_length length_L_greater_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L' ladder_stepdown_L_def index_lower_bound ladder_ix_def ladder_shift_n_drop<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> drop_2_shift<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_lower_bound<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> length_L_greater_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_n_length<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_ix_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_n_at<span class="main"><span class="main">[</span></span><span class="operator">OF</span> index_bound'<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> index_lower_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derive_Derive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Derivation <span class="free">α</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="free">E</span><span class="main">)</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Derive <span class="main">(</span>Derive <span class="free">α</span> <span class="free">D</span><span class="main">)</span> <span class="free">E</span> <span class="main">=</span> Derive <span class="free">α</span> <span class="main">(</span><span class="free">D</span><span class="main">@</span><span class="free">E</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Derivation_append Derive assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_at_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">index</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">D</span> <span class="main">!</span> <span class="main">(</span><span class="free">index</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">D</span> <span class="main">!</span> <span class="free">index</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> LeftDerivationLadder_stepdown<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ldl<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">L'</span><span class="main">.</span> LeftDerivationLadder <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span>
           <span class="bound">L'</span> <span class="free">γ</span> <span class="main">∧</span> length <span class="bound">L'</span> <span class="main">=</span> length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> ladder_i <span class="bound">L'</span> <span class="main">0</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">1</span> <span class="main">+</span> ladder_ix <span class="free">L</span> <span class="main">1</span> <span class="main">∧</span>
           ladder_last_j <span class="bound">L'</span> <span class="main">=</span> ladder_last_j <span class="free">L</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> ladder_stepdown <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ldl1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="free">γ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> D_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> D_split ldl
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sss</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> symbol <span class="main">×</span> symbol list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> symbol <span class="main">×</span> symbol list<span class="main">)</span> list <span class="main">⇒</span> symbol list <span class="main">⇒</span> symbol list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v4</span><span class="main">.</span> LeftDerivation <span class="bound">x3</span> <span class="bound">x2</span> <span class="bound">v4</span> <span class="main">∧</span> LeftDerivation <span class="bound">v4</span> <span class="bound">x1</span> <span class="bound">x0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LeftDerivation <span class="bound">x3</span> <span class="bound">x2</span> <span class="main">(</span><span class="skolem">sss</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">)</span> <span class="main">∧</span> LeftDerivation <span class="main">(</span><span class="skolem">sss</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">)</span> <span class="bound">x1</span> <span class="bound">x0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span> <span class="main">@</span> drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="free">γ</span> <span class="main">∨</span> LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sss</span> <span class="free">γ</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="free">α</span><span class="main">)</span> <span class="main">∧</span> LeftDerivation <span class="main">(</span><span class="skolem">sss</span> <span class="free">γ</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="free">γ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span> <span class="main">@</span> drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="free">γ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ss</span><span class="main">.</span> <span class="main">¬</span> LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="bound">ss</span> <span class="main">∨</span> <span class="main">¬</span> LeftDerivation <span class="bound">ss</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="free">γ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerivation_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> D_split Derivation_take_derive Derivation_unique_dest LeftDerivationLadder_def LeftDerivation_implies_Derivation ladder_stepdown_α_0_def ldl<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> L'_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L' ladder_stepdown_length length_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Suc_u<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">u</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L' ladder_stepdown_length length_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span>  <span class="main">≤</span> length <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ldl Suc_u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_ladder_n_bound<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">u</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">-</span> ladder_stepdown_diff <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_stepdown_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_L L' u'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> is_ladder_prop1 <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> u_less_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> v_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> u_less_v v_L' <span class="keyword1"><span class="command">have</span></span> u_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span> <span class="main">&lt;</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ldl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> L' LeftDerivationLadder_def One_nat_def Suc_diff_1 
        Suc_lessD Suc_mono is_ladder_def ladder_stepdown_length length_L u_less_v v_L'<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">u</span> <span class="main">&lt;</span> ladder_n <span class="skolem">L'</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_stepdown_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_L L'<span class="main"><span class="main">]</span></span> u_L' v_L'<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> L' LeftDerivationLadder_def Suc_eq_plus1 Suc_leI 
        diff_less_mono is_ladder_def ladder_stepdown_diff_def ladder_stepdown_length ldl 
        length_L less_diff_conv u_L' zero_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> is_ladder_prop2 <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> is_ladder_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> L'_nonempty <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_prop1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_prop2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ladder_last_n_def ladder_stepdown_n L' LeftDerivationLadder_def Suc_diff_Suc diff_Suc_1 
      ladder_n_last_is_length ladder_stepdown_length ldl length_L lessI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span>
     <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span>
     <span class="main">(</span>ladder_γ <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> introsAt_L_1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivationIntros_def LeftDerivationLadder_def ldl length_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">thm</span></span> LeftDerivationIntrosAt_def
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>ladder_ix <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> n m introsAt_L_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntrosAt_def One_nat_def diff_Suc_1<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span>  LeftDerivationIntro_def this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> β<span class="main">:</span>
      <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">β</span> <span class="main">∧</span>
       ladder_ix <span class="free">L</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       snd <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> ladder_ix <span class="free">L</span> <span class="main">1</span> <span class="main">=</span> ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span> <span class="main">!</span> ladder_j <span class="free">L</span> <span class="main">1</span> <span class="main">∧</span>
       LeftDerivationFix <span class="skolem">β</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span> <span class="main">+</span> ladder_ix <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">1</span><span class="main">)</span>
       <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> Derive <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> LeftDerivationIntrosAt_def LeftDerives1_Derive β 
        cancel_comm_monoid_add_class.diff_cancel introsAt_L_1 n prod.collapse<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> β_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sss</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> symbol list <span class="main">⇒</span> symbol list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> symbol list <span class="main">⇒</span> symbol"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">sssa</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> symbol list <span class="main">⇒</span> symbol list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x2</span> <span class="bound">x3</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v4</span> <span class="bound">v5</span> <span class="bound">v6</span><span class="main">.</span> splits_at <span class="bound">x3</span> <span class="bound">x2</span> <span class="bound">v4</span> <span class="bound">v5</span> <span class="bound">v6</span><span class="main">)</span> <span class="main">=</span> splits_at <span class="bound">x3</span> <span class="bound">x2</span> <span class="main">(</span><span class="skolem">sss</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ss</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sssa</span> <span class="bound">x2</span> <span class="bound">x3</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ssa</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">ssb</span><span class="main">.</span> <span class="main">¬</span> Derives1 <span class="bound">ssa</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">ssb</span> <span class="main">∨</span> splits_at <span class="bound">ssa</span> <span class="bound">n</span> <span class="main">(</span><span class="skolem">sss</span> <span class="bound">n</span> <span class="bound">ssa</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ss</span> <span class="bound">n</span> <span class="bound">ssa</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sssa</span> <span class="bound">n</span> <span class="bound">ssa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> splits_at_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="skolem">sss</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">@</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">sssa</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> LeftDerives1_implies_Derives1 β splits_at_combine_dest<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> LeftDerives1_implies_Derives1 β ladder_stepdown_α_0_altdef ldl length_L n<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>       
    <span class="keyword1"><span class="command">have</span></span> ladder_i_L'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="main">0</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">1</span> <span class="main">+</span> ladder_ix <span class="free">L</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L' ladder_stepdown_i_0 length_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> derivation_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n m
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L' L'_nonempty One_nat_def drop_take ladder_stepdown_diff_def ladder_stepdown_n
        length_L length_greater_0_conv<span class="main">)</span>  
    <span class="keyword1"><span class="command">have</span></span> ladder_j_L'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="skolem">L'</span> <span class="main">0</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L' L'_nonempty ladder_stepdown_j length_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command">have</span></span> ladder_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ladder_γ <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
      ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derivation_take_derive Derivation_unique_dest LeftDerivationFix_def 
        LeftDerivation_implies_Derivation β β_def derivation_eq ladder_γ_def ldl1<span class="main">)</span>   
    <span class="keyword1"><span class="command">from</span></span> β_def β ladder_i_L'_0 derivation_eq ladder_j_L'_0 ladder_γ
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> index_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">≤</span> <span class="skolem">index</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> index_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Suc_index_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L' Suc_diff_Suc Suc_less_eq diff_Suc_1 ladder_stepdown_length length_L less_Suc_eq 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> intros_at_Suc_index<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntros_def LeftDerivationLadder_def Suc_eq_plus1_left ldl le_add1<span class="main">)</span>      
    <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationIntrosAt_def this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ldintro<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">α'</span> <span class="main">=</span> ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">;</span> <span class="bound">i</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">;</span> <span class="bound">j</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">ix</span> <span class="main">=</span> ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">;</span> <span class="bound">γ</span> <span class="main">=</span> ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">;</span> <span class="bound">n</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">m</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">;</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">D</span> <span class="main">!</span> <span class="bound">n</span><span class="main">;</span> <span class="bound">E</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">m</span> <span class="free">D</span><span class="main">)</span>
       <span class="keyword1">in</span> <span class="bound">i</span> <span class="main">=</span> fst <span class="bound">e</span> <span class="main">∧</span> LeftDerivationIntro <span class="bound">α'</span> <span class="bound">i</span> <span class="main">(</span>snd <span class="bound">e</span><span class="main">)</span> <span class="bound">ix</span> <span class="bound">E</span> <span class="bound">j</span> <span class="bound">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> index_minus_Suc_0_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_upper_bound less_imp_diff_less<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> helpers <span class="main">=</span> length_L L' index_minus_Suc_0_bound
    <span class="keyword1"><span class="command">have</span></span> ladder_i_L'_index<span class="main">:</span>
      <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> fst <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> index_lower_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_stepdown_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> helpers<span class="main"><span class="main">]</span></span> ladder_stepdown_j<span class="main"><span class="main">[</span></span><span class="operator">OF</span> helpers<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> drop_at_shift<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def Suc_index_upper_bound Suc_leI Suc_lessD is_ladder_def 
        ladder_stepdown_diff_def ldl <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationLadder_def One_nat_def Suc_eq_plus1 Suc_index_upper_bound 
        add.commute add_diff_cancel_right' ladder_n_minus_1_bound ldl le_add1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntrosAt_def intros_at_Suc_index diff_Suc_1 ladder_i_def nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> intro_at_index<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span>ladder_α <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>
       <span class="main">(</span>ladder_i <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>ladder_ix <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>
       <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>ladder_j <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> 
         <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> arg1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ladder_α <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> 
        <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">=</span> ladder_α <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_def ladder_γ_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> index_lower_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_stepdown_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> helpers<span class="main"><span class="main">]</span></span> ladder_stepdown_α_0_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Derive_Derive<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"ladder_γ <span class="free"><span class="free">α</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">L</span></span> <span class="skolem"><span class="skolem">index</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Derivation_take_derive LeftDerivationLadder_def 
          LeftDerivation_implies_Derivation Suc_index_upper_bound Suc_leI Suc_lessD 
          add.commute is_ladder_def ladder_γ_def ladder_stepdown_diff_def ldl 
          le_add_diff_inverse2 take_add<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationLadder_def Suc_index_upper_bound Suc_leI Suc_lessD add.commute 
          is_ladder_def ladder_stepdown_diff_def ldl le_add_diff_inverse2 take_add<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> arg2<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L' index_lower_bound index_minus_Suc_0_bound ladder_i_def ladder_stepdown_j 
          length_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> arg3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_stepdown_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> helpers<span class="main"><span class="main">]</span></span> index_lower_bound<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> drop_at_shift<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> index_lower_bound
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> L' LeftDerivationLadder_def One_nat_def Suc_eq_plus1 
          add.commute diff_Suc_1 index_upper_bound is_ladder_def ladder_stepdown_diff_def 
          ladder_stepdown_length ldl le_add_diff_inverse2 length_L less_or_eq_imp_le n 
          nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> neq0_conv not_less not_less_eq_eq<span class="main">)</span> 
        <span class="keyword1"><span class="command">using</span></span> index_lower_bound
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationLadder_def One_nat_def Suc_index_upper_bound Suc_le_lessD 
          Suc_pred diff_Suc_1 ladder_n_minus_1_bound ldl le_imp_less_Suc less_imp_le<span class="main">)</span> 
        <span class="keyword1"><span class="command">using</span></span> index_lower_bound n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_diff_le<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> arg4<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_ix <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ladder_stepdown_ix L' Suc_le_lessD index_lower_bound index_upper_bound length_L 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> Suc_index_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">index</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> index_lower_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">have</span></span> arg5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> 
        <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_stepdown_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> helpers<span class="main"><span class="main">]</span></span> 
          ladder_stepdown_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_L L' index_upper_bound<span class="main"><span class="main">]</span></span> n m Suc_index_Suc<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LeftDerivationLadder_def Suc_eq_plus1_left 
          Suc_index_upper_bound Suc_leI Suc_le_lessD Suc_lessD drop_drop drop_take 
          index_lower_bound is_ladder_def ladder_stepdown_diff_def ldl le_add_diff_inverse2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> arg6<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L' index_upper_bound ladder_stepdown_j length_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> arg7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ladder_γ <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> 
         <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">=</span> ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_γ_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_stepdown_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_L L' index_upper_bound<span class="main"><span class="main">]</span></span> ladder_stepdown_α_0_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Derive_Derive<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"ladder_γ <span class="free"><span class="free">α</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">L</span></span> <span class="main"><span class="main">(</span></span>Suc <span class="skolem"><span class="skolem">index</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> L' LeftDerivationLadder_def 
          LeftDerivation_implies_Derivation LeftDerivation_take_derive Suc_le_lessD 
          add_diff_inverse_nat diff_is_0_eq index_lower_bound index_upper_bound is_ladder_L' 
          is_ladder_def ladder_γ_def ladder_stepdown_n ldl le_0_eq length_L less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
          less_or_eq_imp_le take_add<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> L' One_nat_def add_diff_inverse_nat diff_is_0_eq 
          index_lower_bound index_upper_bound is_ladder_L' is_ladder_def ladder_stepdown_n le_0_eq 
          le_neq_implies_less length_L less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_or_eq_imp_le take_add zero_less_one<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ldintro arg1 arg2 arg3 arg4 arg5 arg6 arg7 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> m n<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>            
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="main">(</span>ladder_stepdown_α_0 <span class="free">α</span> <span class="free">D</span> <span class="free">L</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="free">L</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> 
      <span class="skolem">L'</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntrosAt_def Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ladder_i_L'_index <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> intro_at_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>  
  <span class="keyword1"><span class="command">note</span></span> introsAt <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">L'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1
    <span class="keyword1"><span class="command">using</span></span> L' ladder_stepdown_length length_L <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> ladder_stepdown_i_0 length_L L' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> ladder_stepdown_last_j L' length_L <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ldl1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_L' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ldfix <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntros_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> introsAt<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ladder_shift_j</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ladder <span class="main">⇒</span> ladder"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ladder_shift_j</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ladder_shift_j</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">ladder_shift_j</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ladder_cut_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ladder <span class="main">⇒</span> ladder"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ladder_cut_prefix</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> 
    <span class="main">(</span>ladder_shift_j <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">[</span><span class="main">0</span> <span class="main">:=</span> <span class="main">(</span>ladder_n <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">0</span><span class="main">,</span> ladder_j <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">0</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> ladder_i <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">0</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_shift_j_length<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>ladder_shift_j <span class="free">d</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> length <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_cut_prefix_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>ladder_cut_prefix <span class="free">d</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> length <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_cut_prefix_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_j_length<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_shift_j_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_shift_j <span class="free">d</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">L</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">,</span> fst <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">d</span><span class="main">,</span> snd<span class="main">(</span>snd <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">#</span>
  <span class="main">(</span>ladder_shift_j <span class="free">d</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_j_ladder_shift_j<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> deriv_j <span class="main">(</span>ladder_shift_j <span class="free">d</span> <span class="free">L</span> <span class="main">!</span> <span class="free">index</span><span class="main">)</span> <span class="main">=</span> deriv_j <span class="main">(</span><span class="free">L</span> <span class="main">!</span> <span class="free">index</span><span class="main">)</span> <span class="main">-</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">L</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_shift_j_cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">index</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_j_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>     

<span class="keyword1"><span class="command">lemma</span></span> deriv_n_ladder_shift_j<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> deriv_n <span class="main">(</span>ladder_shift_j <span class="free">d</span> <span class="free">L</span> <span class="main">!</span> <span class="free">index</span><span class="main">)</span> <span class="main">=</span> deriv_n <span class="main">(</span><span class="free">L</span> <span class="main">!</span> <span class="free">index</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">L</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_shift_j_cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">index</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_n_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>     

<span class="keyword1"><span class="command">lemma</span></span> deriv_ix_ladder_shift_j<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> deriv_ix <span class="main">(</span>ladder_shift_j <span class="free">d</span> <span class="free">L</span> <span class="main">!</span> <span class="free">index</span><span class="main">)</span> <span class="main">=</span> deriv_ix <span class="main">(</span><span class="free">L</span> <span class="main">!</span> <span class="free">index</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">L</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_shift_j_cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">index</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_ix_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>     

<span class="keyword1"><span class="command">lemma</span></span> ladder_cut_prefix_j<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_j <span class="main">(</span>ladder_cut_prefix <span class="free">d</span> <span class="free">L</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="free">index</span> <span class="main">-</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_j_def ladder_cut_prefix_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_L<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nth_list_update_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ladder_shift_j_length length_L<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_j_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> deriv_j_ladder_shift_j<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> index_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

<span class="keyword1"><span class="command">lemma</span></span> hd_0_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> hd <span class="main">(</span><span class="free">L</span> <span class="main">[</span><span class="main">0</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hd_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_conv_take_nth_drop<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> ladder_cut_prefix_i<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_i <span class="main">(</span>ladder_cut_prefix <span class="free">d</span> <span class="free">L</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="free">index</span> <span class="main">-</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_def ladder_cut_prefix_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> hd_0_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> length_L ladder_shift_j_length <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_i_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">nat</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_j_def deriv_j_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nth_list_update_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> length_L ladder_shift_j_length <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_j_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> deriv_j_ladder_shift_j<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> index_bound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1"><span class="command">lemma</span></span> ladder_cut_prefix_n<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="main">(</span>ladder_cut_prefix <span class="free">d</span> <span class="free">L</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="free">index</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_cut_prefix_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_n_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nth_list_update_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_shift_j_length<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> length_L <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deriv_n_def <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> deriv_n_ladder_shift_j<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> index_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1"><span class="command">lemma</span></span> ladder_cut_prefix_ix<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> index_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> length_L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ladder_ix <span class="main">(</span>ladder_cut_prefix <span class="free">d</span> <span class="free">L</span><span class="main">)</span> <span class="free">index</span> <span class="main">=</span> ladder_ix <span class="free">L</span> <span class="free">index</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_cut_prefix_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_ix_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> deriv_ix_ladder_shift_j<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> index_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_derivation_ge_is_nonterminal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derivation_ge_d<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_nonterminal<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="free">γ</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">i</span> <span class="main">&gt;</span> <span class="free">d</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">≥</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="free">α</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ldfix is_nonterminal
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def<span class="main">)</span>  
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_splits_at_nonterminal<span class="main">[</span><span class="operator">OF</span> ldfix this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="keyword2"><span class="keyword">where</span></span> U<span class="main">:</span>
    <span class="quoted"><span class="quoted">"splits_at <span class="free">α</span> <span class="free">i</span> <span class="skolem">a1</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span> splits_at <span class="free">γ</span> <span class="free">j</span> <span class="skolem">b1</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span> LeftDerivation <span class="skolem">a1</span> <span class="free">D</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">D</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_eq_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_implies_order length_take min.absorb2 splits_at_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ldfix LeftDerivationFix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> 1 i_eq_j <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a1'</span><span class="main">.</span> LeftDerives1 <span class="skolem">a1</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>hd <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="bound">a1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U 2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivation.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a1'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">a1</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>hd <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a1'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>hd <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">a1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derives1_bound LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fst_less_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>hd <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leD min.absorb2 nat_le_linear splits_at_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> d_le_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> fst <span class="main">(</span>hd <span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> derivation_ge_d 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_ge_def<span class="main">)</span>  
      <span class="keyword1"><span class="command">with</span></span> fst_less_i <span class="keyword1"><span class="command">have</span></span> d_less_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b1'</span><span class="main">.</span> LeftDerives1 <span class="bound">b1'</span> <span class="main">(</span>fst <span class="main">(</span>last <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>last <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U 2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LeftDerivation_Derive_take_LeftDerives1 LeftDerivation_implies_Derivation 
          last_conv_nth length_0_conv order_refl take_all<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b1'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">b1'</span> <span class="main">(</span>fst <span class="main">(</span>last <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>last <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>last <span class="free">D</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">b1</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Derives1_bound' LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fst_le_j<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>last <span class="free">D</span><span class="main">)</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> fst <span class="main">(</span>last <span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> derivation_ge_d 2 <span class="keyword1"><span class="command">using</span></span> derivation_ge_def last_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">with</span></span> fst_le_j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
      <span class="keyword1"><span class="command">with</span></span> d_less_i <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_derivation_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derivation_ge_d<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">∨</span> <span class="main">(</span><span class="free">i</span> <span class="main">&gt;</span> <span class="free">d</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">≥</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_splits_at_symbol<span class="main">[</span><span class="operator">OF</span> ldfix<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> U<span class="main">:</span>
    <span class="quoted"><span class="quoted">"splits_at <span class="free">α</span> <span class="free">i</span> <span class="skolem">a1</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span>
     splits_at <span class="free">γ</span> <span class="free">j</span> <span class="skolem">b1</span> <span class="skolem">U</span> <span class="skolem">b2</span> <span class="main">∧</span>
     <span class="skolem">n</span> <span class="main">≤</span> length <span class="free">D</span> <span class="main">∧</span>
     LeftDerivation <span class="skolem">a1</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="skolem">b1</span> <span class="main">∧</span>
     derivation_ge <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     LeftDerivation <span class="skolem">a2</span> <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">b1</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">b2</span> <span class="main">∧</span>
     <span class="main">(</span><span class="skolem">n</span> <span class="main">=</span> length <span class="free">D</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">D</span> <span class="main">∧</span> is_word <span class="main">(</span><span class="skolem">b1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_eq_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_implies_order length_take min.absorb2 splits_at_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> E_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E 2
        <span class="keyword1"><span class="command">using</span></span> U less_nat_zero_code list.size<span class="main">(</span>3<span class="main">)</span> take_eq_Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a1'</span><span class="main">.</span> LeftDerives1 <span class="skolem">a1</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>hd <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="bound">a1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U E E_nonempty
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivation.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.exhaust list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>        
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a1'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">a1</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>hd <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a1'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">a1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derives1_bound LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fst_less_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leD min.absorb2 nat_le_linear splits_at_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> d_le_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> fst <span class="main">(</span>hd <span class="skolem">E</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> derivation_ge_d E_nonempty E
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivation.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> U derivation_ge_def hd_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fst_less_i <span class="keyword1"><span class="command">have</span></span> d_less_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b1'</span><span class="main">.</span> LeftDerives1 <span class="bound">b1'</span> <span class="main">(</span>fst <span class="main">(</span>last <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>last <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E_nonempty U E
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivation_append1 append_butlast_last_id prod.collapse<span class="main">)</span>                
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b1'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">b1'</span> <span class="main">(</span>fst <span class="main">(</span>last <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>last <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>last <span class="skolem">E</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">b1</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Derives1_bound' LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fst_le_j<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>last <span class="skolem">E</span><span class="main">)</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> fst <span class="main">(</span>last <span class="skolem">E</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> derivation_ge_d E_nonempty E 
        <span class="keyword1"><span class="command">using</span></span> derivation_ge_d last_in_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> derivation_ge_def set_take_subset subsetCE<span class="main">)</span> 
      <span class="keyword1"><span class="command">with</span></span> fst_le_j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
      <span class="keyword1"><span class="command">with</span></span> d_less_i <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_derivation_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ldintro<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i_ge_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derivation_ge_d<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationIntro_def ldintro<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> β<span class="main">:</span>
    <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">α</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">β</span> <span class="main">∧</span> <span class="free">ix</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> snd <span class="free">r</span> <span class="main">!</span> <span class="free">ix</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∧</span> 
     LeftDerivationFix <span class="skolem">β</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span> <span class="main">=</span> <span class="free">j</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span> <span class="main">&gt;</span> <span class="free">d</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">≥</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_derivation_ge derivation_ge_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> i_ge_d trans_le_add1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_ge_LeftDerivationLadder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derivation_ge_d<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder_i_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">≥</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_i <span class="free">L</span> <span class="free">index</span> <span class="main">≥</span> <span class="free">d</span> <span class="main">∧</span> ladder_j <span class="free">L</span> <span class="free">index</span> <span class="main">≥</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationLadder_def ladder<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> derivation_ge_d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id derivation_ge_append<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> ladder_i_0 derivation_ge_d LeftDerivationFix_derivation_ge<span class="main">[</span><span class="operator">OF</span> ldfix this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_i_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≥</span> <span class="free">d</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_i_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationLadder_def ladder<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntros <span class="free">α</span> <span class="free">D</span> <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntros_def Suc_eq_plus1_left le_add1<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationIntrosAt_def this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ladder_i_Suc LeftDerivationIntro_derivation_ge
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id derivation_ge_append derivation_ge_d<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>        

<span class="keyword1"><span class="command">lemma</span></span> derivation_shift_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"derivation_shift <span class="main">(</span><span class="free">A</span><span class="main">@</span><span class="free">B</span><span class="main">)</span> <span class="free">left</span> <span class="free">right</span> <span class="main">=</span> 
    <span class="main">(</span>derivation_shift <span class="free">A</span> <span class="free">left</span> <span class="free">right</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>derivation_shift <span class="free">B</span> <span class="free">left</span> <span class="free">right</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivation_shift_right_left_subtract<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">right</span> <span class="main">≥</span> <span class="free">left</span> <span class="main">⟹</span> derivation_shift <span class="main">(</span>derivation_shift <span class="free">L</span> <span class="main">0</span> <span class="free">right</span><span class="main">)</span> <span class="free">left</span> <span class="main">0</span> <span class="main">=</span> 
  derivation_shift <span class="free">L</span> <span class="main">0</span> <span class="main">(</span><span class="free">right</span> <span class="main">-</span> <span class="free">left</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">L</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_cut_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> length <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_word_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">γ'</span><span class="main">.</span> <span class="free">γ</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="bound">γ'</span> <span class="main">∧</span> 
    LeftDerivationFix <span class="free">α</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="bound">γ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> j_ge_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> length <span class="free">δ</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> LeftDerivationFix_derivation_ge<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationFix_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> EF<span class="main">:</span>
   <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="main">∧</span>
    is_sentence <span class="free">γ</span> <span class="main">∧</span>
    LeftDerivation <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">γ</span> <span class="main">∧</span>
    <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">γ</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∧</span>
    <span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
    LeftDerivation <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">γ</span><span class="main">)</span> <span class="main">∧</span>
    LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="skolem">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerivation_skip_prefixword_ex<span class="main">[</span><span class="operator">OF</span> this is_word_δ<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="skolem">γ'</span> <span class="main">∧</span> LeftDerivation <span class="free">α</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ldf1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> EF is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> ldf2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="skolem">γ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> EF γ' is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> ldf3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> length <span class="free">δ</span> <span class="main">&lt;</span> length <span class="free">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF append_Nil assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> drop_append drop_eq_Nil not_le<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> ldf4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> length <span class="free">δ</span> <span class="main">&lt;</span> length <span class="skolem">γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> EF append_Nil j_ge_d γ' drop_append drop_eq_Nil not_le<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> ldf5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">γ'</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> γ' EF assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> j_ge_d leD nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> D_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> EF <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ldf1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ldf2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> γ' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ldf3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ldf4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ldf5 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"derivation_shift <span class="skolem">E</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> D_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> derivation_shift_right_left_subtract<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j_ge_d le_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> j_ge_d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_diff_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> EF LeftDerivation_implies_Derivation LeftDerivation_skip_prefix γ' 
      append_eq_conv_conj assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> drop_take is_word_Derivation_derivation_ge is_word_δ 
      take_all take_append<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> EF Suc_diff_le γ' assms<span class="main">(</span>3<span class="main">)</span> j_ge_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerives1_propagate_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">β</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≥</span> length <span class="free">δ</span> <span class="main">⟹</span> is_prefix <span class="free">δ</span> <span class="free">β</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">β</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">δ</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">β</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 Derives1_take LeftDerives1_implies_Derives1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">i</span> <span class="free">β</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Derives1_bound LeftDerives1_implies_Derives1 dual_order.strict_implies_order length_take min.absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">β</span><span class="main">)</span> <span class="main">=</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f3 a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f4 a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> append_Nil2 append_eq_conv_conj diff_is_0_eq' is_prefix_take take_0 take_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationIntro_cut_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="free">ix</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> length <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_word_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">γ'</span><span class="main">.</span> <span class="free">γ</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="bound">γ'</span> <span class="main">∧</span> 
    LeftDerivationIntro <span class="free">α</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="free">r</span> <span class="free">ix</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="bound">γ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationIntro_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> β<span class="main">:</span>
    <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="skolem">β</span> <span class="main">∧</span>
     <span class="free">ix</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> snd <span class="free">r</span> <span class="main">!</span> <span class="free">ix</span> <span class="main">=</span> <span class="free">γ</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∧</span> LeftDerivationFix <span class="skolem">β</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">β'</span><span class="main">.</span> <span class="skolem">β</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="bound">β'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> LeftDerives1_propagate_prefix β assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_dropped_prefix<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β'</span></span> <span class="keyword2"><span class="keyword">where</span></span> β'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="skolem">β'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> β <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="skolem">β'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerives1_skip_prefix<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> this<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> α_β'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="free">α</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="free">r</span> <span class="skolem">β'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="skolem">β'</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> β β' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> δ_le_i_plus_ix<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">δ</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="free">ix</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_cut_prefix<span class="main">[</span><span class="operator">OF</span> ldfix assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> δ_le_i_plus_ix assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="skolem">γ'</span> <span class="main">∧</span>
     LeftDerivationFix <span class="skolem">β'</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ix</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="skolem">γ'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> same_symbol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="skolem">γ'</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationFix_def β β' δ_le_i_plus_ix γ' leD nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> β'_γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="skolem">β'</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">δ</span> <span class="main">+</span> <span class="free">ix</span><span class="main">)</span> 
    <span class="main">(</span>derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="skolem">γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ' assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>   
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntro_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">β'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> β α_β' same_symbol β'_γ'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_implies_LeftDerivation_at_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="free">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def LeftDerivation_take_derive assms<span class="main">(</span>1<span class="main">)</span> ladder_γ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_cut_prefix_propagate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_word_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> derivation_ge_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder_i_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">≥</span> length <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L'</span> <span class="main">=</span> ladder_cut_prefix <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">=</span> derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> 
    LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L'</span> <span class="free">index</span><span class="main">)</span> <span class="free">D'</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="free">index</span><span class="main">)</span> <span class="main">∧</span>
    ladder_α <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span> <span class="main">=</span> <span class="free">δ</span><span class="main">@</span><span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="free">index</span><span class="main">)</span> <span class="main">∧</span>
    ladder_γ <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">index</span> <span class="main">=</span> <span class="free">δ</span><span class="main">@</span><span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="free">index</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">index</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> ladder_α<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_α <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span> <span class="main">=</span> <span class="free">δ</span><span class="main">@</span><span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> 
      <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ladder LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> dge_take<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> derivation_ge_δ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id derivation_ge_append<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_cut_prefix<span class="main">[</span><span class="operator">OF</span> ldfix dge_take ladder_i_0 is_word_δ<span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="skolem">γ'</span> <span class="main">∧</span>
      LeftDerivationFix <span class="free">α</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="skolem">γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span> <span class="main">=</span> <span class="free">δ</span><span class="main">@</span><span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> γ' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span> D' Derive L' LeftDerivationFix_def 
        LeftDerivation_implies_Derivation ladder_γ_def ladder_cut_prefix_n take_derivation_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L'</span> <span class="main">0</span><span class="main">)</span> <span class="free">D'</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_implies_LeftDerivation_at_index ladder <span class="quoted">"0.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> D' LeftDerivationLadder_def LeftDerivation_skip_prefix 
          LeftDerivation_take_derive derivation_ge_δ ladder ladder_γ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>        
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ladder_α ladder_γ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> index_less_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> <span class="free">δ</span><span class="main">@</span><span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ladder_α<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_α <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span> <span class="main">=</span> <span class="free">δ</span><span class="main">@</span><span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> introsAt<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> ladder
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntros_def LeftDerivationLadder_def Suc_eq_plus1_left le_add1<span class="main">)</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="free">D</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationIntrosAt_def introsAt<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span>ladder_α <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> 
       <span class="main">(</span>ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n m e E Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ldintro<span class="main">:</span>
      <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> 
       <span class="main">(</span>ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> dge_E_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="skolem">E</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> E<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> derivation_ge_δ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id derivation_ge_append<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> ladder_i_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">δ</span> <span class="main">≤</span> ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems derivation_ge_LeftDerivationLadder derivation_ge_δ ladder ladder_i_0 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> LeftDerivationIntro_cut_prefix<span class="main">[</span><span class="operator">OF</span> ldintro dge_E_δ ladder_i_Suc is_word_δ<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="skolem">γ'</span> <span class="main">∧</span>
      LeftDerivationIntro <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span>
      <span class="main">(</span>ladder_ix <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="skolem">E</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="skolem">γ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span>ladder_α <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">,</span> snd <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>derivation_shift <span class="skolem">E</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">γ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivationIntro_implies_LeftDerivation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="skolem">index</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">,</span> snd <span class="skolem">e</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>derivation_shift <span class="skolem">E</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">γ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_α_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L'</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="free">D'</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D'</span> <span class="free">L'</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>Suc <span class="skolem">index</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_implies_LeftDerivation_at_index ladder Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> D' LeftDerivationLadder_def LeftDerivation_skip_prefix 
          LeftDerivation_take_derive derivation_ge_δ ladder ladder_γ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>        
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> γ' D' Derive L' LeftDerivationIntro_def n m e E ld
        LeftDerivation_implies_Derivation ladder_γ_def ladder_cut_prefix_n take_derivation_shift
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LeftDerivationLadder_implies_LeftDerivation_at_index 
        LeftDerivation_skip_prefixword_ex Suc.prems Suc_leI index_less_L is_word_δ ladder 
        ladder_α le_0_eq neq0_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>       

<span class="keyword1"><span class="command">theorem</span></span> LeftDerivationLadder_cut_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_word_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder_i_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">≥</span> length <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">D'</span> <span class="bound">L'</span> <span class="bound">γ'</span><span class="main">.</span> <span class="free">γ</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="bound">γ'</span> <span class="main">∧</span> 
    LeftDerivationLadder <span class="free">α</span> <span class="bound">D'</span> <span class="bound">L'</span> <span class="bound">γ'</span> <span class="main">∧</span>
    <span class="bound">D'</span> <span class="main">=</span> derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span> <span class="main">∧</span>
    length <span class="bound">L'</span> <span class="main">=</span> length <span class="free">L</span> <span class="main">∧</span> ladder_i <span class="bound">L'</span> <span class="main">0</span> <span class="main">+</span> length <span class="free">δ</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">∧</span>
    ladder_last_j <span class="bound">L'</span> <span class="main">+</span> length <span class="free">δ</span> <span class="main">=</span> ladder_last_j <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> D'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> derivation_shift <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> ladder_cut_prefix <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> ladder_last_j_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="free">L</span> <span class="main">&lt;</span> length <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ladder
    <span class="keyword1"><span class="command">using</span></span> ladder_last_j_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> derivation_ge_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="free">D</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_word_δ LeftDerivationLadder_def 
    LeftDerivation_implies_Derivation is_word_Derivation_derivation_ge ladder <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">note</span></span> derivation_ge_ladder <span class="main">=</span>  
    derivation_ge_LeftDerivationLadder<span class="main">[</span><span class="operator">OF</span> derivation_ge_δ ladder ladder_i_0<span class="main">]</span>  
  <span class="keyword1"><span class="command">have</span></span> ladder_last_j_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="free">L</span> <span class="main">≥</span> length <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def derivation_ge_ladder is_ladder_def ladder 
      ladder_last_j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> ladder_last_j_upper_bound ladder_last_j_lower_bound 
  <span class="keyword1"><span class="command">have</span></span> δ_less_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">δ</span> <span class="main">&lt;</span> length <span class="free">γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> γ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="skolem">γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivation.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> LeftDerivationLadder_def LeftDerivation_ge_take γ' 
      append_eq_conv_conj derivation_ge_δ ladder<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> length_L_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def is_ladder_def ladder <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ladder_i_L'_thm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">index</span><span class="main">.</span> <span class="bound">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_i <span class="skolem">L'</span> <span class="bound">index</span> <span class="main">+</span> length <span class="free">δ</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="bound">index</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_cut_prefix_i<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> derivation_ge_ladder <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
  <span class="keyword1"><span class="command">have</span></span> ladder_j_L'_thm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">index</span><span class="main">.</span> <span class="bound">index</span> <span class="main">&lt;</span> length <span class="free">L</span> <span class="main">⟹</span> ladder_j <span class="skolem">L'</span> <span class="bound">index</span> <span class="main">+</span> length <span class="free">δ</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="bound">index</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_cut_prefix_j<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def is_ladder_def ladder <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def is_ladder_def ladder <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">using</span></span> derivation_ge_ladder <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> length_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">L'</span> <span class="main">=</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L' ladder_cut_prefix_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> α_γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="skolem">D'</span> <span class="skolem">γ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D' LeftDerivationLadder_def LeftDerivation_skip_prefix γ' derivation_ge_δ ladder 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> length_D'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">D'</span> <span class="main">=</span> length <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D'<span class="main">)</span>   
  <span class="keyword1"><span class="command">have</span></span> is_ladder_D_L<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="free">D</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def ladder <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> u_bound_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> u_bound_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_L' <span class="keyword1"><span class="command">using</span></span> u_bound_L' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">u</span> <span class="main">≤</span> length <span class="skolem">D'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_D' L'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_cut_prefix_n<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_bound_L<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">using</span></span> u_bound_L is_ladder_D_L
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> is_ladder_1 <span class="main">=</span> this 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> u_less_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> v_bound_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> v_bound_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_L'<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> u_less_v <span class="keyword1"><span class="command">have</span></span> u_bound_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_n <span class="skolem">L'</span> <span class="skolem">u</span> <span class="main">&lt;</span> ladder_n <span class="skolem">L'</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_cut_prefix_n<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> u_bound_L <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_cut_prefix_n<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> v_bound_L <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> u_less_v v_bound_L is_ladder_D_L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>      
  <span class="keyword1"><span class="command">note</span></span> is_ladder_2 <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> is_ladder_3<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_n <span class="skolem">L'</span> <span class="main">=</span> length <span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_D' ladder_last_n_def L'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_cut_prefix_n<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_cut_prefix_length<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_cut_prefix_length<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_D_L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def ladder_last_n_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> is_ladder_4<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="main">(</span>ladder_i <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">D'</span><span class="main">)</span> 
    <span class="main">(</span>ladder_j <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">D'</span> <span class="skolem">L'</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> 
    <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ladder LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> dge<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> derivation_ge_δ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id derivation_ge_append<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_cut_prefix<span class="main">[</span><span class="operator">OF</span> ldfix dge ladder_i_0 is_word_δ<span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="skolem">γ'</span> <span class="main">∧</span>
      LeftDerivationFix <span class="free">α</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="main">(</span>derivation_shift <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="skolem">γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_cut_prefix_propagate D' L' append_eq_conv_conj derivation_ge_δ 
        is_word_δ ladder ladder_cut_prefix_i ladder_cut_prefix_j ladder_cut_prefix_n ladder_i_0 
        length_0_conv length_L_nonzero length_greater_0_conv take_derivation_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> index_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">≤</span> <span class="skolem">index</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> index_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">&lt;</span> length <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> introsAt<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntros_def LeftDerivationLadder_def One_nat_def index_lower_bound 
        index_upper_bound ladder length_L'<span class="main">)</span>    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ladder_i_L<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntrosAt_def One_nat_def <span class="quoted"><span class="quoted">‹LeftDerivationIntrosAt <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ladder_i_L'_as_L<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="skolem">index</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ladder_cut_prefix_i L' index_upper_bound is_ladder_D_L is_ladder_not_empty length_L' 
        length_greater_0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> length_L_gr_0<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_L' length_L_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">have</span></span> index_Suc_upper_bound_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_upper_bound length_L' <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">D'</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  fst <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> D'<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> L'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_cut_prefix_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> index_Suc_upper_bound_L length_L_gr_0<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> index_lower_bound index_upper_bound is_ladder_D_L ladder_n_minus_1_bound length_L' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ladder_i_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">D'</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ladder_i_L ladder_i_L'_as_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span>ladder_α <span class="free">α</span> <span class="skolem">D'</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>
      <span class="main">(</span>snd <span class="main">(</span><span class="skolem">D'</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_ix <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>
      <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">D'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>
      <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="skolem">D'</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span>ladder_α <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>
        <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_ix <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>
        <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>
        <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> introsAt
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntrosAt_def One_nat_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ldintro<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="main">(</span>ladder_α <span class="free">α</span> <span class="skolem">D'</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>
        <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_ix <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>
        <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>
        <span class="main">(</span>ladder_γ <span class="main">(</span><span class="free">δ</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D' L' LeftDerivationLadder_cut_prefix_propagate derivation_ge_δ index_upper_bound 
          is_word_δ ladder ladder_i_0 length_L' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">have</span></span> dge<span class="main">:</span> <span class="quoted"><span class="quoted">"derivation_ge <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> derivation_ge_δ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id derivation_ge_append<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> δ_le_i_L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">δ</span> <span class="main">≤</span> ladder_i <span class="free">L</span> <span class="skolem">index</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> derivation_ge_ladder index_upper_bound length_L' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
      <span class="keyword1"><span class="command">from</span></span> LeftDerivationIntro_cut_prefix<span class="main">[</span><span class="operator">OF</span> ldintro dge δ_le_i_L is_word_δ<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ'<span class="main">:</span>
         <span class="quoted"><span class="quoted">"ladder_γ <span class="main">(</span><span class="free">δ</span> <span class="main">@</span> <span class="free">α</span><span class="main">)</span> <span class="free">D</span> <span class="free">L</span> <span class="skolem">index</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">@</span> <span class="skolem">γ'</span> <span class="main">∧</span>
           LeftDerivationIntro <span class="main">(</span>ladder_α <span class="free">α</span> <span class="skolem">D'</span> <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="skolem">index</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span>
           <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ladder_ix <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span>
           <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> 
           <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="skolem">index</span> <span class="main">-</span> length <span class="free">δ</span><span class="main">)</span> <span class="skolem">γ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_i <span class="free">L</span> <span class="skolem">index</span> <span class="main">-</span> length <span class="free">δ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L' ladder_cut_prefix_i ladder_i_L'_as_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span><span class="skolem">D'</span> <span class="main">!</span> ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">D</span> <span class="main">!</span> ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> L'<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ladder_cut_prefix_n<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_Suc_upper_bound_L<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> length_L_gr_0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> D'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> index_lower_bound index_upper_bound is_ladder_D_L ladder_n_minus_1_bound 
          length_L' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_ix <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_ix <span class="free">L</span> <span class="skolem">index</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ladder_cut_prefix_ix L' index_upper_bound length_L' length_L_gr_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="skolem">L'</span> <span class="skolem">index</span><span class="main">)</span> <span class="skolem">D'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span>derivation_shift <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">(</span><span class="skolem">index</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="skolem">index</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> 
           <span class="main">(</span>length <span class="free">δ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> D'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> L'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_cut_prefix_n<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_Suc_upper_bound_L<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> length_L_gr_0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_cut_prefix_n<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> index_upper_bound length_L' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">using</span></span> length_L_gr_0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derivation_shift_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_map take_map<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_j <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> ladder_j <span class="free">L</span> <span class="skolem">index</span> <span class="main">-</span> length <span class="free">δ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ladder_cut_prefix_j L' index_upper_bound length_L' length_L_gr_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_γ <span class="free">α</span> <span class="skolem">D'</span> <span class="skolem">L'</span> <span class="skolem">index</span> <span class="main">=</span> <span class="skolem">γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D' L' LeftDerivationLadder_cut_prefix_propagate γ' derivation_ge_δ index_upper_bound 
          is_word_δ ladder ladder_i_0 length_L' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 h2 h3 h4 h5 h6 γ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="free">α</span> <span class="skolem">D'</span> <span class="skolem">L'</span> <span class="skolem">index</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntrosAt_def Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ladder_i_L' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> is_ladder_5 <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">D'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">L'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">γ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> γ_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1
    <span class="keyword1"><span class="command">using</span></span> D' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> L' ladder_cut_prefix_length <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_i_L'_thm<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def is_ladder_def ladder <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ladder_last_j_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ladder_j_L'_thm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_L'<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> length_L_nonzero <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_L'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> α_γ' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> length_L_nonzero length_L' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> is_ladder_4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationIntros_def is_ladder_5<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD10">
<div class="head">
<h1>Theory TheoremD10</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD10
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD9.html">TheoremD9</a> <a href="Ladder.html">Ladder</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒫_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> wellformed_tokens <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> 𝒫_are_admissible admissible_wellformed_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒳_token_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> 𝒳 <span class="free">k</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_diff_conv2 𝒳_is_prefix add.commute chars_of_token_def empty_𝒳 
  empty_iff is_prefix_length le_neq_implies_less length_drop linear<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_Scan<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Scan_regular regular_implies_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> π_apply_setmonotone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Complete_subset_π LocalLexing.Complete_def LocalLexing_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Scan_apply_setmonotone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Scan_def<span class="main">)</span>
  
  
<span class="keyword1"><span class="command">lemma</span></span> leftderives_padfront<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="free">α</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_word <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">α</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">β</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> LeftDerivation_append_prefix LeftDerivation_implies_leftderives assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> 
  leftderives_implies_LeftDerivation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives_padback<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="free">α</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">(</span><span class="free">α</span><span class="main">@</span><span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">β</span><span class="main">@</span><span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> LeftDerivation_append_suffix LeftDerivation_implies_leftderives assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> 
  leftderives_implies_LeftDerivation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives_pad<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> α_β<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">α</span> <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_word<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">α</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">β</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α_β is_sentence is_word leftderives_padback leftderives_padfront<span class="main">)</span>    

<span class="keyword1"><span class="command">lemma</span></span> leftderives_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil append_Nil2 assms is_sentence_def is_word_terminals leftderives1_def 
  leftderives1_implies_leftderives list.pred_inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> terminals_empty wellformed_tokens_empty_path<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives_rule_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">a</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_word<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="free">a</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">w</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> N_w<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rule leftderives_rule <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">w</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> leftderives_pad is_word is_sentence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="free">a</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">w</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> leftderives_trans ld <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leftderives_trans_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">a</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">b</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rule<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">b</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_word<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="free">a</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">c</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">b</span><span class="main">@</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">@</span><span class="free">c</span><span class="main">@</span><span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> leftderives_pad ld rule is_word is_sentence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> leftderives_trans ld <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> charslength_of_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"charslength <span class="free">a</span> <span class="main">≤</span> charslength <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms is_prefix_chars is_prefix_length<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_rhs_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_rhs <span class="main">(</span>Item <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">d</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_rhs_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Prefixes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Prefixes</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> is_prefix <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔓_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓 <span class="main">⟹</span> wellformed_tokens <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝔓_are_admissible admissible_wellformed_tokens<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> Prefixes_reflexive<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> Prefixes <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Prefixes_def is_prefix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Prefixes_is_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> Prefixes <span class="free">p</span> <span class="main">=</span> is_prefix <span class="free">q</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Prefixes_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_are_paths'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓 <span class="main">⟹</span> is_prefix <span class="free">q</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> 𝔓"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 𝒫.simps<span class="main">(</span>3<span class="main">)</span> 𝔓_def prefixes_are_paths <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> thmD10_ladder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓 <span class="main">⟹</span> 
   charslength <span class="free">p</span> <span class="main">=</span> <span class="free">k</span> <span class="main">⟹</span> 
   <span class="free">X</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> 
   <span class="free">T</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span> <span class="main">⟹</span> 
   <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">⟹</span>
   <span class="free">r</span> <span class="main">≤</span> length <span class="free">p</span> <span class="main">⟹</span> 
   leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">γ</span><span class="main">)</span> <span class="main">⟹</span>
   LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
   ladder_last_j <span class="free">L</span> <span class="main">=</span> length <span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> 
   <span class="free">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">=</span> Item <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="main">(</span>length <span class="free">α</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span> <span class="main">⟹</span>
   <span class="free">I</span> <span class="main">=</span> items_le <span class="free">k'</span> <span class="main">(</span>π <span class="free">k'</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
   <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">β</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">γ</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword1"><span class="command">have</span></span> item_origin_x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"item_origin <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less.prems<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_k<span class="main">:</span> <span class="quoted"><span class="quoted">"item_origin <span class="skolem">x</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> charslength.simps is_prefix_chars is_prefix_length is_prefix_take less.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command">have</span></span> item_end_x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less.prems<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> item_dot_x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"item_dot <span class="skolem">x</span> <span class="main">=</span> length <span class="skolem">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less.prems<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">)</span>  
    <span class="keyword1"><span class="command">have</span></span> k'_upperbound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒳_token_length less.prems<span class="main">(</span>10<span class="main">)</span> less.prems<span class="main">(</span>3<span class="main">)</span> less.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">note</span></span> item_def <span class="main">=</span> less.prems<span class="main">(</span>11<span class="main">)</span> 
    <span class="keyword1"><span class="command">note</span></span> k' <span class="main">=</span> less.prems<span class="main">(</span>10<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> rule_dom <span class="main">=</span> less.prems<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> p_charslength <span class="main">=</span> less.prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> p_dom <span class="main">=</span> less.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> r <span class="main">=</span> less.prems<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> leftderives_start <span class="main">=</span> less.prems<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> X_dom <span class="main">=</span> less.prems<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_item_def item_def rule_dom p_charslength<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> k'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> charslength.simps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> p_charslength<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> item_origin_x_def p_charslength x_k <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> k'_upperbound<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span>  leftderives_α<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="skolem">α</span> <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def LeftDerivation_implies_leftderives less.prems<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
    <span class="keyword1"><span class="command">have</span></span> is_sentence_drop_pX<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span>drop <span class="skolem">r</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>terminal_of_token <span class="free">X</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> derives_is_sentence is_sentence_concat leftderives_α leftderives_implies_derives 
        rule_α_type rule_dom terminals_append terminals_drop terminals_singleton<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> snd_item_rule_x<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>item_rule <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">@</span><span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_ladder <span class="skolem">D</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">L</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_ladder_not_empty<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">L</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> length <span class="skolem">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> LeftDerivationFix <span class="skolem">α</span> <span class="bound">i</span> <span class="skolem">D</span> <span class="main">(</span>length <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span> LeftDerivationLadder_L_0 less.prems<span class="main">(</span>8<span class="main">)</span> less.prems<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> LDF<span class="main">:</span>
          <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="skolem">α</span> <span class="skolem">i</span> <span class="skolem">D</span> <span class="main">(</span>length <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> LeftDerivationFix_splits_at_derives<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> decompose<span class="main">:</span>
          <span class="quoted"><span class="quoted">"splits_at <span class="skolem">α</span> <span class="skolem">i</span> <span class="skolem">a1</span> <span class="skolem">U</span> <span class="skolem">a2</span> <span class="main">∧</span> splits_at <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
            <span class="main">(</span>length <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b1</span> <span class="skolem">U</span> <span class="skolem">b2</span> <span class="main">∧</span> derives <span class="skolem">a1</span> <span class="skolem">b1</span> <span class="main">∧</span> derives <span class="skolem">a2</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">=</span> terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj splits_at_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> decompose <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> fst <span class="free">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_terminals nth_append_length splits_at_def terminal_of_token_def 
            terminals_append terminals_singleton<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> decompose b1 U <span class="keyword1"><span class="command">have</span></span> b2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splits_at_combine splits_at_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="skolem">α</span> <span class="skolem">D</span> <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> LDF LeftDerivationLadder_def less.prems<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Item <span class="main">(</span>item_rule <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">a1</span><span class="main">)</span> <span class="main">(</span>item_origin <span class="skolem">x</span><span class="main">)</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> wellformed_y<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wellformed_x
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_item_def x_k<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> k' k'_upperbound <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_rhs_def snd_item_rule_x<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> decompose splits_at_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_length trans_le_add1<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> y_nonterminal<span class="main">:</span> <span class="quoted"><span class="quoted">"item_nonterminal <span class="var">?y</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_def item_nonterminal_def<span class="main">)</span>   
        <span class="keyword1"><span class="command">have</span></span> item_α_y<span class="main">:</span> <span class="quoted"><span class="quoted">"item_α <span class="var">?y</span> <span class="main">=</span> <span class="skolem">a1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc append_eq_conv_conj append_take_drop_id decompose item.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
            item.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> item_α_def item_rhs_def snd_item_rule_x splits_at_def<span class="main">)</span>    
        <span class="keyword1"><span class="command">have</span></span> pvalid_y<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_def<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> p_dom 𝔓_wellformed <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">using</span></span> wellformed_y <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> p_charslength <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">using</span></span> item_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> y_nonterminal <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">using</span></span> is_derivation_def leftderives_start <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_α_y<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> b1 decompose <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inc_item <span class="var">?y</span> <span class="free">k'</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> item_rhs_y<span class="main">:</span> <span class="quoted"><span class="quoted">"item_rhs <span class="var">?y</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">@</span><span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_def item_rhs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> split_α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> <span class="skolem">a1</span><span class="main">@</span><span class="main">[</span><span class="skolem">U</span><span class="main">]</span><span class="main">@</span><span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> decompose splits_at_combine <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">have</span></span> next_symbol_y<span class="main">:</span> <span class="quoted"><span class="quoted">"next_symbol <span class="var">?y</span> <span class="main">=</span> Some<span class="main">(</span>fst <span class="free">X</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_symbol_def is_complete_def item_rhs_y split_α U<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> z_in_Scan_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="main">{</span><span class="var">?y</span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Scan_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bin_def X_dom<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> k' chars_of_token_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">using</span></span> next_symbol_y <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">from</span></span> pvalid_y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> Gen<span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gen_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_le_def p_dom<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Scan <span class="free">T</span> <span class="free">k</span> <span class="main">{</span><span class="var">?y</span><span class="main">}</span> <span class="main">⊆</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Gen<span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_Scan<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">with</span></span> z_in_Scan_y <span class="keyword1"><span class="command">have</span></span> z_in_Scan_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?z</span> <span class="main">∈</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Gen<span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rev_subsetD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> wellformed_z<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="var">?z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k' k'_upperbound next_symbol_y wellformed_inc_item wellformed_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> item_β_z<span class="main">:</span> <span class="quoted"><span class="quoted">"item_β <span class="var">?z</span> <span class="main">=</span> <span class="skolem">a2</span><span class="main">@</span><span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_β_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_rhs_y split_α<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">have</span></span> item_end_z<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="var">?z</span> <span class="main">=</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> x_via_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> inc_dot <span class="main">(</span>length <span class="skolem">a2</span><span class="main">)</span> <span class="var">?z</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inc_dot_def less.prems<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> split_α<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> x_in_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="free">k'</span> <span class="main">{}</span> <span class="main">{</span><span class="var">?z</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> x_via_z<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> thmD6<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wellformed_z item_β_z item_end_z<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> decompose b2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"π <span class="free">k'</span> <span class="main">{}</span> <span class="main">{</span><span class="var">?z</span><span class="main">}</span> <span class="main">⊆</span> π <span class="free">k'</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Gen<span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_π<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> z_in_Scan_Gen <span class="keyword1"><span class="command">using</span></span> empty_subsetI insert_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_in_Scan_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="free">k'</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Gen<span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x_in_z <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_end_x_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> x_in_Scan_Gen <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> items_le_def less.prems<span class="main">(</span>12<span class="main">)</span> mem_Collect_eq nat_le_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> ladder_i <span class="skolem">L</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> ladder_j <span class="skolem">L</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="keyword2"><span class="keyword">where</span></span> α'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> ladder_γ <span class="skolem">α</span> <span class="skolem">D</span> <span class="skolem">L</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> ladder_n <span class="skolem">L</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="skolem">α</span> <span class="skolem">i</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span>  <span class="skolem">i'</span> <span class="skolem">α'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerivationLadder_def α' i i' n less.prems<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">have</span></span> α'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> ladder_α <span class="skolem">α</span> <span class="skolem">D</span> <span class="skolem">L</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α' ladder_α_def<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> i'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> ladder_i <span class="skolem">L</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i' ladder_i_def<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="skolem">D</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ix</span></span> <span class="keyword2"><span class="keyword">where</span></span> ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ix</span> <span class="main">=</span> ladder_ix <span class="skolem">L</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> ladder_n <span class="skolem">L</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> ldintro<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="skolem">α'</span> <span class="skolem">i'</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="skolem">ix</span> <span class="skolem">E</span> <span class="main">(</span>ladder_j <span class="skolem">L</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>ladder_γ <span class="skolem">α</span> <span class="skolem">D</span> <span class="skolem">L</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.hyps"</span> LeftDerivationIntrosAt_def LeftDerivationIntros_def 
            LeftDerivationLadder_def One_nat_def α'_alt E diff_Suc_1 e i'_alt ix leI 
            less.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> m n not_less_eq zero_less_one<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> is_nonterminal_α'_at_i'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="skolem">α'</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerivationIntro_implies_nonterminal ldintro <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_nonterminal_α_at_i<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="main">(</span><span class="skolem">α</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_def ldfix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A</span> <span class="bound">a1</span> <span class="bound">a2</span> <span class="bound">a1'</span><span class="main">.</span> splits_at <span class="skolem">α</span> <span class="skolem">i</span> <span class="bound">a1</span> <span class="bound">A</span> <span class="bound">a2</span> <span class="main">∧</span> splits_at <span class="skolem">α'</span> <span class="skolem">i'</span> <span class="bound">a1'</span> <span class="bound">A</span> <span class="bound">a2</span> <span class="main">∧</span>
          LeftDerivation <span class="bound">a1</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="bound">a1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_splits_at_nonterminal ldfix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">a1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="skolem">α</span> <span class="skolem">i</span> <span class="skolem">a1</span> <span class="skolem">A</span> <span class="skolem">a2</span> <span class="main">∧</span> splits_at <span class="skolem">α'</span> <span class="skolem">i'</span> <span class="skolem">a1'</span> <span class="skolem">A</span> <span class="skolem">a2</span> <span class="main">∧</span>
          LeftDerivation <span class="skolem">a1</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">a1'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> A_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">α'</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">have</span></span> is_nonterminal_A<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def is_nonterminal_α'_at_i' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rule</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> <span class="bound">rule</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> e <span class="quoted">"2.hyps"</span> LeftDerivationIntrosAt_def LeftDerivationIntros_def 
            LeftDerivationLadder_def One_nat_def Suc_leI diff_Suc_1 i'_alt less.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> 
            n prod.collapse zero_less_one<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rule</span></span> <span class="keyword2"><span class="keyword">where</span></span> rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> <span class="skolem">rule</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> snd <span class="skolem">rule</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α''</span></span> <span class="keyword2"><span class="keyword">where</span></span> α''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α''</span> <span class="main">=</span> <span class="skolem">a1'</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">@</span> <span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> α'_α''<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">α'</span> <span class="skolem">i'</span> <span class="skolem">rule</span> <span class="skolem">α''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A w LeftDerivationFix_is_sentence LeftDerivationIntro_def 
            LeftDerivationIntro_examine_rule LeftDerives1_def α'' ldfix ldintro prod.collapse 
            rule snd_conv splits_at_implies_Derives1<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_word_a1'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="skolem">a1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeftDerives1_splits_at_is_word A <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> A_eq_fst_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> fst <span class="skolem">rule</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A LeftDerivationIntro_examine_rule ldintro rule <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
        <span class="keyword1"><span class="command">have</span></span> ix_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ix</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ix w rule ldintro LeftDerivationIntro_def snd_conv 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w1</span> <span class="bound">W</span> <span class="bound">w2</span><span class="main">.</span> splits_at <span class="skolem">w</span> <span class="skolem">ix</span> <span class="bound">w1</span> <span class="bound">W</span> <span class="bound">w2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">W</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="skolem">w</span> <span class="skolem">ix</span> <span class="skolem">w1</span> <span class="skolem">W</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> a1'_w_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1'</span><span class="main">@</span><span class="skolem">w</span><span class="main">@</span><span class="skolem">a2</span> <span class="main">=</span> ladder_stepdown_α_0 <span class="skolem">α</span> <span class="skolem">D</span> <span class="skolem">L</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> ladder_stepdown_α_0_altdef <span class="quoted">"2.hyps"</span> A α'_alt e i'_alt less.prems<span class="main">(</span>8<span class="main">)</span> n rule 
          snd_conv w <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
        <span class="keyword1"><span class="command">from</span></span> LeftDerivationLadder_stepdown<span class="main">[</span><span class="operator">OF</span> less.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> 2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> L'<span class="main">:</span>
          <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">(</span><span class="skolem">a1'</span><span class="main">@</span><span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="skolem">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="skolem">L</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">L'</span>
           <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
           length <span class="skolem">L'</span> <span class="main">=</span> length <span class="skolem">L</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span>
           ladder_i <span class="skolem">L'</span> <span class="main">0</span> <span class="main">=</span> ladder_i <span class="skolem">L</span> <span class="main">1</span> <span class="main">+</span> ladder_ix <span class="skolem">L</span> <span class="main">1</span> <span class="main">∧</span> ladder_last_j <span class="skolem">L'</span> <span class="main">=</span> ladder_last_j <span class="skolem">L</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> a1'_w_a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> ladder_i_L'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L'</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">+</span> <span class="skolem">ix</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L' i'_alt ix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> ladder_last_j_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="skolem">L'</span> <span class="main">=</span> length <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L' less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> L' <span class="keyword1"><span class="command">have</span></span> this1<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">(</span><span class="skolem">a1'</span><span class="main">@</span><span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="skolem">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="skolem">L</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">L'</span>
           <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> this2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">a1'</span> <span class="main">≤</span> ladder_i <span class="skolem">L'</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A ladder_i_L'_0 splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>     
        <span class="keyword1"><span class="command">from</span></span> LeftDerivationLadder_cut_prefix<span class="main">[</span><span class="operator">OF</span> this1 is_word_a1' this2<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">L''</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> L''<span class="main">:</span>
          <span class="quoted"><span class="quoted">"terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a1'</span> <span class="main">@</span> <span class="skolem">γ'</span> <span class="main">∧</span>
            LeftDerivationLadder <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="skolem">a2</span><span class="main">)</span> <span class="skolem">D'</span> <span class="skolem">L''</span> <span class="skolem">γ'</span> <span class="main">∧</span>
            <span class="skolem">D'</span> <span class="main">=</span> derivation_shift <span class="main">(</span>drop <span class="main">(</span>ladder_stepdown_diff <span class="skolem">L</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">a1'</span><span class="main">)</span> <span class="main">0</span> <span class="main">∧</span>
            length <span class="skolem">L''</span> <span class="main">=</span> length <span class="skolem">L'</span> <span class="main">∧</span>
            ladder_i <span class="skolem">L''</span> <span class="main">0</span> <span class="main">+</span> length <span class="skolem">a1'</span> <span class="main">=</span> ladder_i <span class="skolem">L'</span> <span class="main">0</span> <span class="main">∧</span> 
            ladder_last_j <span class="skolem">L''</span> <span class="main">+</span> length <span class="skolem">a1'</span> <span class="main">=</span> ladder_last_j <span class="skolem">L'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> length_a1'_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">a1'</span> <span class="main">≤</span> length <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L'' ladder_last_j_L' 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_prefix_a1'_drop_r_p<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">a1'</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ss</span> <span class="bound">ssa</span> <span class="bound">ssb</span><span class="main">.</span> <span class="main">¬</span> is_prefix <span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">(</span><span class="bound">ssa</span> <span class="main">@</span> <span class="bound">ssb</span><span class="main">)</span> <span class="main">∨</span> is_prefix <span class="bound">ss</span> <span class="bound">ssa</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ssc</span><span class="main">.</span> <span class="bound">ssc</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> is_prefix <span class="bound">ssc</span> <span class="bound">ssb</span> <span class="main">∧</span> <span class="bound">ss</span> <span class="main">=</span> <span class="bound">ssa</span> <span class="main">@</span> <span class="bound">ssc</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_of_append<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ss</span> <span class="bound">ssa</span><span class="main">.</span> is_prefix <span class="main">(</span><span class="main">(</span><span class="bound">ss</span><span class="main">::</span>symbol list<span class="main">)</span> <span class="main">@</span> <span class="bound">ssa</span><span class="main">)</span> <span class="bound">ss</span> <span class="main">∨</span> <span class="main">¬</span> is_prefix <span class="bound">ssa</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> append_Nil2 is_prefix_cancel<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ss</span><span class="main">.</span> is_prefix <span class="bound">ss</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">¬</span> is_prefix <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="bound">ss</span><span class="main">)</span> <span class="skolem">a1'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> drop_eq_Nil is_prefix_append length_a1'_bound length_terminals<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">a1'</span> <span class="main">(</span><span class="skolem">a1'</span> <span class="main">@</span> <span class="skolem">γ'</span><span class="main">)</span> <span class="main">∧</span> is_prefix <span class="skolem">a1'</span> <span class="skolem">a1'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> append_Nil2 is_prefix_cancel is_prefix_empty<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> f3 f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L'' terminals_append<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">+</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> length_a1'_eq_i'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">a1'</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A less_or_eq_imp_le min.absorb2 splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
        <span class="keyword1"><span class="command">have</span></span> a1'_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> <span class="skolem">r'</span> <span class="main">∧</span> <span class="skolem">r'</span> <span class="main">≤</span> length <span class="free">p</span> <span class="main">∧</span> 
          terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a1'</span> <span class="main">@</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_prefix_a1'_drop_r_p r'
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">q</span><span class="main">.</span> terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a1'</span> <span class="main">@</span> <span class="bound">q</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> is_prefix_a1'_drop_r_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_prefix_unsplit<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a1'</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> drop <span class="skolem">i'</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> length_a1'_eq_i' q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> terminals <span class="main">(</span>drop <span class="skolem">i'</span> <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> terminals <span class="main">(</span>drop <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r' add.commute<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> add.commute diff_add_inverse le_Suc_ex le_add1 le_diff_conv length_a1'_bound 
              length_a1'_eq_i' length_drop r r' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>    
        <span class="keyword1"><span class="command">have</span></span> ladder_i_L''<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L''</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">ix</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L'' ladder_i_L'_0 length_a1'_eq_i' 
          add.commute add_left_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
        <span class="keyword1"><span class="command">have</span></span> L''_ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="skolem">a2</span><span class="main">)</span> <span class="skolem">D'</span> <span class="skolem">L''</span> <span class="skolem">γ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L''</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ladder_i_L'' ix_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">from</span></span> LeftDerivationLadder_cut_appendix<span class="main">[</span><span class="operator">OF</span> L''_ladder this<span class="main">]</span> 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="skolem"><span class="skolem">F'</span></span> <span class="skolem"><span class="skolem">γ1'</span></span> <span class="skolem"><span class="skolem">γ2'</span></span> <span class="skolem"><span class="skolem">L'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> L'''<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> <span class="skolem">E'</span> <span class="main">@</span> <span class="skolem">F'</span> <span class="main">∧</span>
           <span class="skolem">γ'</span> <span class="main">=</span> <span class="skolem">γ1'</span> <span class="main">@</span> <span class="skolem">γ2'</span> <span class="main">∧</span>
           LeftDerivationLadder <span class="skolem">w</span> <span class="skolem">E'</span> <span class="skolem">L'''</span> <span class="skolem">γ1'</span> <span class="main">∧</span>
           derivation_ge <span class="skolem">F'</span> <span class="main">(</span>length <span class="skolem">γ1'</span><span class="main">)</span> <span class="main">∧</span>
           LeftDerivation <span class="skolem">a2</span> <span class="main">(</span>derivation_shift <span class="skolem">F'</span> <span class="main">(</span>length <span class="skolem">γ1'</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">γ2'</span> <span class="main">∧</span>
           length <span class="skolem">L'''</span> <span class="main">=</span> length <span class="skolem">L''</span> <span class="main">∧</span> ladder_i <span class="skolem">L'''</span> <span class="main">0</span> <span class="main">=</span> ladder_i <span class="skolem">L''</span> <span class="main">0</span> <span class="main">∧</span> 
           ladder_last_j <span class="skolem">L'''</span> <span class="main">=</span> ladder_last_j <span class="skolem">L''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Item <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
        <span class="keyword1"><span class="command">have</span></span> z1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">L'''</span> <span class="main">&lt;</span> length <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.hyps"</span> L' L'' L''' <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">have</span></span> z2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_dom<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> z3<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_charslength <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">have</span></span> z4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X_dom<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> z5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rule</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Derives1_rule LeftDerives1_implies_Derives1 α'_α'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">w</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w A_eq_fst_rule <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> z7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1'_r' <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">N</span><span class="main">]</span><span class="main">@</span><span class="skolem">γ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> leftderives_start <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="skolem">α</span><span class="main">@</span><span class="skolem">β</span><span class="main">)</span><span class="main">@</span><span class="skolem">γ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝔓_wellformed is_derivation_def is_derivation_is_sentence is_sentence_concat 
            is_word_terminals_take leftderives_implies_derives leftderives_rule_step p_dom rule_dom<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="skolem">a1</span><span class="main">@</span><span class="main">(</span><span class="main">[</span><span class="skolem">A</span><span class="main">]</span><span class="main">@</span><span class="skolem">a2</span><span class="main">@</span><span class="skolem">β</span><span class="main">)</span><span class="main">@</span><span class="skolem">γ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A splits_at_combine append_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z8_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="skolem">a1'</span><span class="main">@</span><span class="main">(</span><span class="main">[</span><span class="skolem">A</span><span class="main">]</span><span class="main">@</span><span class="skolem">a2</span><span class="main">@</span><span class="skolem">β</span><span class="main">)</span><span class="main">@</span><span class="skolem">γ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> A LeftDerivation_implies_leftderives 𝔓_wellformed is_derivation_def 
            is_derivation_is_sentence is_sentence_concat is_word_terminals_take 
            leftderives_implies_derives leftderives_trans_step p_dom<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> join_terminals<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="skolem">a1'</span> <span class="main">=</span> terminals <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_prefix_a1'_drop_r_p length_a1'_eq_i' r' take_add take_prefix 
            terminals_drop terminals_take<span class="main">)</span>  
        <span class="keyword1"><span class="command">from</span></span> z8_helper join_terminals <span class="keyword1"><span class="command">have</span></span> z8<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">A</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">a2</span> <span class="main">@</span> <span class="skolem">β</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> γ'_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ'</span> <span class="main">=</span> terminals <span class="main">(</span>drop <span class="skolem">r'</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L'' a1'_r' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="skolem">L'''</span> <span class="main">+</span> length <span class="skolem">a1'</span> <span class="main">=</span> length <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L'' L''' ladder_last_j_L' <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ladder_last_j_L'''_γ'<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="skolem">L'''</span> <span class="main">=</span> length <span class="skolem">γ'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ'_altdef length_a1'_eq_i' r'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">γ'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">γ1'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L''' ladder_last_j_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">γ1'</span> <span class="main">+</span> length <span class="skolem">γ2'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">γ1'</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L''' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">γ2'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> γ2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ2'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> γ1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ1'</span> <span class="main">=</span> terminals <span class="main">(</span>drop <span class="skolem">r'</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> γ'_altdef L''' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z9<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="skolem">w</span> <span class="skolem">E'</span> <span class="skolem">L'''</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r'</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L''' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> z10<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="skolem">L'''</span> <span class="main">=</span> length <span class="main">(</span>drop <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> γ'_altdef ladder_last_j_L'''_γ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> z11 <span class="main">=</span> k'
        <span class="keyword1"><span class="command">have</span></span> z12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Item <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">w</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">note</span></span> z13 <span class="main">=</span> less.prems<span class="main">(</span>12<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> induct <span class="main">=</span> less.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">L'''</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="skolem">r'</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span><span class="main">@</span><span class="skolem">β</span><span class="main">@</span><span class="skolem">γ</span>"</span></span> <span class="quoted"><span class="skolem">E'</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">note</span></span> z_in_I <span class="main">=</span> induct<span class="main">[</span><span class="operator">OF</span> z1 z2 z3 z4 z5 z6 z7 z8 z9 z10 z11 z12 z13<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> a2_derives_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="skolem">a2</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L''' γ2'
          <span class="keyword1"><span class="command">using</span></span> LeftDerivation_implies_leftderives leftderives_implies_derives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> Item <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">@</span><span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">a1</span><span class="main">)</span> 
          <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> take <span class="skolem">r'</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_prefix_q_p<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">q</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q_in_Prefixes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> Prefixes <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Prefixes_is_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wellformed_q<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> p_dom is_prefix_q_p prefixes_are_paths' 𝔓_wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
        <span class="keyword1"><span class="command">have</span></span> item_rule_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"item_rule <span class="skolem">x1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">@</span><span class="skolem">β</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> x1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> is_prefix_r_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj is_prefix_take r' take_add<span class="main">)</span>          
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength_le_r_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> charslength <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> charslength_of_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength_r'_p<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> charslength <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> charslength_of_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>1<span class="main">)</span> add_leE k' k'_upperbound z3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> charslength_r'_p <span class="keyword1"><span class="command">have</span></span> charslength_r'_Doc<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"charslength <span class="main">(</span>take <span class="skolem">r'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">have</span></span> α_decompose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">A</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A splits_at_combine <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">have</span></span> wellformed_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="skolem">x1</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_item_def<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> item_rule_x1 less.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> charslength_le_r_r' x1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> charslength_r'_Doc x1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command">using</span></span> x1 α_decompose <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> item_nonterminal_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"item_nonterminal <span class="skolem">x1</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x1 item_nonterminal_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> r_q_p<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">r</span> <span class="main">(</span>terminals <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> q is_prefix_r_r' length_take min.absorb2 r take_prefix terminals_take<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> item_α_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"item_α <span class="skolem">x1</span> <span class="main">=</span> <span class="skolem">a1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α_decompose item_α_def x1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> a1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1'</span> <span class="main">=</span> drop <span class="skolem">r</span> <span class="main">(</span>terminals <span class="skolem">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj join_terminals length_take length_terminals min.absorb2 q r<span class="main">)</span>         
        <span class="keyword1"><span class="command">have</span></span> pvalid_q_x1<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="skolem">q</span> <span class="skolem">x1</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_def wellformed_q wellformed_x1 item_nonterminal_x1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a1'_r' min.absorb2 q<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q x1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q x1 r'<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> r_q_p less.prems<span class="main">(</span>7<span class="main">)</span> append_Cons is_leftderivation_def 
            leftderivation_implies_derivation <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_α_x1<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> a1' A LeftDerivation_implies_leftderives leftderives_implies_derives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">have</span></span> item_end_x1_le_k'<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x1</span> <span class="main">≤</span> <span class="free">k'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> charslength_r'_p
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x1<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> x1_in_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> less.prems<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_def item_end_x1_le_k'<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> π_apply_setmonotone<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Scan_apply_setmonotone<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gen_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_q_x1 paths_le_def q_in_Prefixes<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword">where</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> inc_item <span class="skolem">x1</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> x1_in_bin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">∈</span> bin <span class="free">I</span> <span class="main">(</span>item_origin <span class="skolem">z</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> bin_def x1 x1_in_I z12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>           
        <span class="keyword1"><span class="command">have</span></span> x2_in_Complete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">∈</span> Complete <span class="free">k'</span> <span class="free">I</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complete_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">using</span></span> x1_in_bin <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">using</span></span> bin_def z12 z_in_I <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_complete_def z12<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α_decompose is_complete_def item_nonterminal_def next_symbol_def x1 z12<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> wf_I'<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>π <span class="free">k'</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_Gen wellformed_items_Scan wellformed_items_π z5<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> items_le_Complete<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> x2_in_Complete
        <span class="keyword1"><span class="command">have</span></span> x2_in_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Complete_π_fix z13<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="free">I</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wf_I' items_le_is_filter wellformed_items_def z13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> x2_in_I <span class="keyword1"><span class="command">have</span></span> wellformed_x2<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="skolem">x2</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_items_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> item_dot_x2<span class="main">:</span> <span class="quoted"><span class="quoted">"item_dot <span class="skolem">x2</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">a1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x2 x1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> item_β_x2<span class="main">:</span> <span class="quoted"><span class="quoted">"item_β <span class="skolem">x2</span> <span class="main">=</span> <span class="skolem">a2</span> <span class="main">@</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_β_def item_dot_x2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_rhs_def x2 x1 α_decompose<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
        <span class="keyword1"><span class="command">have</span></span> item_end_x2<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x2</span> <span class="main">=</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x2<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> inc_dot_x2_by_a2 <span class="main">=</span> thmD6<span class="main">[</span><span class="operator">OF</span> wellformed_x2 item_β_x2 item_end_x2 a2_derives_empty<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> inc_dot <span class="main">(</span>length <span class="skolem">a2</span><span class="main">)</span> <span class="skolem">x2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α_decompose inc_dot_def less.prems<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> x1 x2<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> inc_dot_x2_by_a2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="free">k'</span> <span class="main">{}</span> <span class="main">{</span><span class="skolem">x2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="free">k'</span> <span class="main">{}</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x2_in_I
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> contra_subsetD empty_subsetI insert_subset monoD mono_π<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> π_subset_elem_trans dual_order.refl item_end_x_def 
            items_le_def items_le_is_filter mem_Collect_eq z13<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>       

<span class="keyword1"><span class="command">theorem</span></span> thmD10<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_charslength<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> T_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rule_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> leftderives_start<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> leftderives_α<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">α</span> <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> item_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Item <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="main">(</span>length <span class="free">α</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> items_le <span class="free">k'</span> <span class="main">(</span>π <span class="free">k'</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">D</span><span class="main">.</span> LeftDerivation <span class="free">α</span> <span class="bound">D</span> <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> leftderives_α leftderives_implies_LeftDerivation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="free">α</span> <span class="skolem">D</span> <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> is_sentence<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span>terminals <span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> derives_is_sentence is_sentence_concat leftderives_α leftderives_implies_derives 
      rule_α_type rule_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">L</span><span class="main">.</span> LeftDerivationLadder <span class="free">α</span> <span class="skolem">D</span> <span class="bound">L</span>  <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         ladder_last_j <span class="bound">L</span> <span class="main">=</span> length <span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LeftDerivationLadder_exists<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_sentence<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="skolem">D</span> <span class="skolem">L</span>  <span class="main">(</span>terminals <span class="main">(</span><span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    L_ladder_last_j<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="skolem">L</span> <span class="main">=</span> length <span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> thmD10_ladder<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span>
    L L_ladder_last_j k' item_def I<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD11">
<div class="head">
<h1>Theory TheoremD11</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD11
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD10.html">TheoremD10</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_length_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> singleton_L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">L</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span> <span class="main">(</span>ladder_last_j <span class="free">L</span><span class="main">)</span> <span class="free">γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="free">α</span> <span class="main">(</span>ladder_i <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>ladder_n <span class="free">L</span> <span class="main">0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span>ladder_j <span class="free">L</span> <span class="main">0</span><span class="main">)</span> 
    <span class="main">(</span>ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ladder LeftDerivationLadder_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ladder_n_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_n <span class="free">L</span> <span class="main">0</span> <span class="main">=</span> length <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ladder singleton_L
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationLadder_def One_nat_def diff_Suc_1 is_ladder_def ladder_last_n_intro<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> ldfix ladder_n_0 ladder singleton_L <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derivation_unique_dest LeftDerivationLadder_def 
      LeftDerivationLadder_implies_LeftDerivation_at_index LeftDerivationLadder_ladder_n_bound 
      LeftDerivation_implies_Derivation One_nat_def diff_Suc_1 ladder_last_j_def take_all 
      zero_less_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_from_singleton_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">0</span> <span class="free">D</span> <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">B</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationFix_def assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> EF<span class="main">:</span>
    <span class="quoted"><span class="quoted">"is_sentence <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">∧</span>
     is_sentence <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">B</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span>
     LeftDerivation <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="free">D</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">B</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">0</span> <span class="main">&lt;</span> length <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">∧</span>
     length <span class="free">u</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">B</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">B</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="main">!</span> length <span class="free">u</span> <span class="main">∧</span>
     <span class="free">D</span> <span class="main">=</span> <span class="skolem">E</span> <span class="main">@</span> derivation_shift <span class="skolem">F</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     LeftDerivation <span class="main">(</span>take <span class="main">0</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span><span class="main">)</span> <span class="skolem">E</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">B</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     LeftDerivation <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span><span class="main">)</span> <span class="skolem">F</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="main">[</span><span class="free">B</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EF <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derivation.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Derives1_split LeftDerivation_implies_Derivation 
      Nil_is_append_conv list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> take_0<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> EF <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> E LeftDerivation.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> LeftDerivation_ge_take LeftDerivation_implies_Derivation 
      append_eq_conv_conj derivation_ge_shift is_word_Derivation length_Cons length_derivation_shift 
      list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons_0 nth_append self_append_conv2 take_0<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EF E F <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationFix_from_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="free">i</span> <span class="free">D</span> <span class="free">j</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="bound">B</span> <span class="bound">v</span><span class="main">.</span> splits_at <span class="free">γ</span> <span class="free">j</span> <span class="bound">u</span> <span class="bound">B</span> <span class="bound">v</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> LeftDerivationFix_splits_at_derives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="free">γ</span> <span class="free">j</span> <span class="skolem">u</span> <span class="skolem">B</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">B</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> splits_at_combine <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> length <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms s1 s2 LeftDerivationFix_from_singleton_helper 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationFix_def length_Cons less_Suc0 list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LeftDerivationLadder_ladder_γ_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">=</span> ladder_γ <span class="free">α</span> <span class="free">D</span> <span class="free">L</span> <span class="main">(</span>length <span class="free">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derive LeftDerivationLadder_def LeftDerivation_implies_Derivation One_nat_def assms 
  is_ladder_def last_ladder_γ<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> thmD11_helper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓 <span class="main">⟹</span>
   charslength <span class="free">p</span> <span class="main">=</span> <span class="free">k</span> <span class="main">⟹</span> 
   <span class="free">X</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span>
   <span class="free">T</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span> <span class="main">⟹</span>
   <span class="free">q</span> <span class="main">=</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span> <span class="main">⟹</span>
   <span class="free">r</span> <span class="main">≤</span> length <span class="free">q</span> <span class="main">⟹</span>
   LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="free">D</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">γ</span><span class="main">)</span> <span class="main">⟹</span>
   leftderives <span class="free">α</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">=</span> Item <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="main">(</span>length <span class="free">α</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span> <span class="main">⟹</span>
   <span class="free">I</span> <span class="main">=</span> items_le <span class="free">k'</span> <span class="main">(</span>π <span class="free">k'</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">D</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">γ</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">β</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">D</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivation.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> diff_add_0 diff_add_inverse2 le_0_eq length_0_conv 
            length_append length_terminals less.prems<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> less.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> take_eq_Nil<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerivation.simps<span class="main">(</span>1<span class="main">)</span> append_Cons append_self_conv2 less.prems<span class="main">(</span>8<span class="main">)</span> list.inject 
            take_eq_Nil terminals_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">from</span></span> r γ 1 <span class="keyword1"><span class="command">have</span></span> start_is_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔖</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LeftDerivation.simps<span class="main">(</span>1<span class="main">)</span> append_eq_Cons_conv less.prems<span class="main">(</span>8<span class="main">)</span> list.inject take_eq_Nil 
            terminals_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
        <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r γ start_is_N<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="skolem">α</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"less.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r <span class="quoted">"less.prems"</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Item <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"less.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r <span class="quoted">"less.prems"</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">from</span></span> thmD10<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"less.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">,</span></span> 4<span class="main"><span class="main">,</span></span> 6<span class="main"><span class="main">)</span></span> h1 h2 h3 <span class="quoted">"less.prems"</span><span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> h4  <span class="quoted">"less.prems"</span><span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span> 
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">note</span></span> D_non_empty <span class="main">=</span> 2
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> length <span class="free">q</span> <span class="main">∨</span> <span class="skolem">r</span> <span class="main">=</span> length <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> take_q_p<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">r</span> <span class="free">q</span> <span class="main">=</span> take <span class="skolem">r</span> <span class="free">p</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 1 less.prems
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_keep_last le_neq_implies_less nat_le_linear not_less_eq not_less_eq_eq<span class="main">)</span> 
            <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> take_q_p<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> less.prems LeftDerivation_implies_leftderives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="skolem">α</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>5<span class="main">,</span> 9<span class="main">)</span> h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Item <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> less.prems take_q_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">from</span></span> thmD10<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"less.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">,</span></span> 4<span class="main"><span class="main">,</span></span> 6<span class="main"><span class="main">)</span></span> h1 h2 h3 h4 h5 less.prems<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">D</span> <span class="main">(</span>terminals <span class="free">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> α_derives_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="skolem">α</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> is_sentence_p<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>1<span class="main">)</span> ℒ<span class="hidden">⇩</span><sub>P</sub>_derives 𝔓_are_admissible admissible_def is_derivation_def 
                is_derivation_is_sentence is_sentence_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> is_symbol_X<span class="main">:</span> <span class="quoted"><span class="quoted">"is_symbol <span class="main">(</span>terminal_of_token <span class="free">X</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> 𝒳_are_terminals is_symbol_def rev_subsetD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
            <span class="keyword1"><span class="command">have</span></span> is_sentence_q<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span>terminals <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_sentence_p is_symbol_X 
              less.prems LeftDerivation_implies_leftderives is_derivation_def 
              is_derivation_is_sentence is_sentence_concat ld leftderives_implies_derives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> is_symbol_N<span class="main">:</span> <span class="quoted"><span class="quoted">"is_symbol <span class="skolem">N</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>6<span class="main">)</span> is_symbol_def rule_nonterminal_type <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword1"><span class="command">have</span></span> is_sentence_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="skolem">γ</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> LeftDerivation_implies_leftderives is_derivation_def is_derivation_is_sentence 
                is_sentence_concat ld leftderives_implies_derives<span class="main">)</span> 
            <span class="keyword1"><span class="command">have</span></span> ld_exists_h1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sentence <span class="main">(</span>terminals <span class="free">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> is_sentence_q is_sentence_γ is_symbol_N is_sentence_concat 
                LeftDerivation_implies_leftderives is_derivation_def is_derivation_is_sentence ld 
                leftderives_implies_derives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> ld_exists_h2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">q</span> <span class="main">&lt;</span> length <span class="main">(</span>terminals <span class="free">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">from</span></span> LeftDerivationLadder_exists<span class="main">[</span><span class="operator">OF</span> ld ld_exists_h1 ld_exists_h2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
              L<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationLadder <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">D</span> <span class="skolem">L</span> <span class="main">(</span>terminals <span class="free">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
              L_last_j<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_last_j <span class="skolem">L</span> <span class="main">=</span> length <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">note</span></span> r_eq_length_q <span class="main">=</span> 2
            <span class="keyword1"><span class="command">have</span></span> ladder_i_0_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ladder_i <span class="skolem">L</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L append_Nil ladder_i_0_bound 
              length_append_singleton less_Suc0 list.size<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>          
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">L</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> length <span class="skolem">L</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationLadder_def Suc_eq_plus1 Suc_eq_plus1_left butlast_conv_take 
                butlast_snoc diff_add_inverse2 is_ladder_def le_add1 le_neq_implies_less 
                length_append_singleton old.nat.exhaust take_0<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> 1
                <span class="keyword1"><span class="command">from</span></span> LeftDerivationLadder_length_1<span class="main">[</span><span class="operator">OF</span> L 1<span class="main">]</span> ladder_i_0_eq_0 
                <span class="keyword1"><span class="command">have</span></span> ldfix<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationFix <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">0</span> <span class="skolem">D</span> <span class="main">(</span>ladder_last_j <span class="skolem">L</span><span class="main">)</span> <span class="main">(</span>terminals <span class="free">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> LeftDerivationFix_from_singleton <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">with</span></span> D_non_empty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> 2
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> ladder_α <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">D</span> <span class="skolem">L</span> <span class="main">(</span>length <span class="skolem">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a_as_γ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> ladder_γ <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">D</span> <span class="skolem">L</span> <span class="main">(</span>length <span class="skolem">L</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 ladder_α_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_diff_left diff_is_0_eq not_le one_add_one<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> introsAt<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntrosAt <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">D</span> <span class="skolem">L</span> <span class="main">(</span>length <span class="skolem">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.hyps"</span> LeftDerivationIntros_def LeftDerivationLadder_def One_nat_def 
                    Suc_leI Suc_lessD diff_less less_not_refl not_less_eq zero_less_diff<span class="main">)</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> ladder_i <span class="skolem">L</span> <span class="main">(</span>length <span class="skolem">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> ladder_j <span class="skolem">L</span> <span class="main">(</span>length <span class="skolem">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ix</span></span> <span class="keyword2"><span class="keyword">where</span></span> ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ix</span> <span class="main">=</span> ladder_ix <span class="skolem">L</span> <span class="main">(</span>length <span class="skolem">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> ladder_γ <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">D</span> <span class="skolem">L</span> <span class="main">(</span>length <span class="skolem">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> ladder_n <span class="skolem">L</span> <span class="main">(</span>length <span class="skolem">L</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> ladder_n <span class="skolem">L</span> <span class="main">(</span>length <span class="skolem">L</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="skolem">D</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationIntrosAt_def introsAt<span class="main">]</span>  
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> fst <span class="skolem">e</span> <span class="main">∧</span> LeftDerivationIntro <span class="skolem">a</span> <span class="skolem">i</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="skolem">ix</span> <span class="skolem">E</span> <span class="skolem">j</span> <span class="skolem">c</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> E a c e i ix j m n<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_eq_fst_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> fst <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                  ldintro<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivationIntro <span class="skolem">a</span> <span class="skolem">i</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="skolem">ix</span> <span class="skolem">E</span> <span class="skolem">j</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> c_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> terminals <span class="free">q</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> c L LeftDerivationLadder_ladder_γ_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>            
                <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> LeftDerivationIntro_def ldintro<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span>
                  <span class="quoted"><span class="quoted">"LeftDerives1 <span class="skolem">a</span> <span class="skolem">i</span> <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">ix</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
                   snd <span class="main">(</span>snd <span class="skolem">e</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">ix</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∧</span> LeftDerivationFix <span class="skolem">b</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ix</span><span class="main">)</span> <span class="skolem">E</span> <span class="skolem">j</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span> Mω<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">ω</span><span class="main">)</span> <span class="main">=</span> snd <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                <span class="keyword1"><span class="command">have</span></span> j_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> length <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_last_j j ladder_last_j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">with</span></span> c_def <span class="keyword1"><span class="command">have</span></span> c_at_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons length_terminals nth_append_length<span class="main">)</span>  
                <span class="keyword1"><span class="command">with</span></span> b Mω <span class="keyword1"><span class="command">have</span></span> ω_at_ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ω</span> <span class="main">!</span> <span class="skolem">ix</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv<span class="main">)</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ1</span></span> <span class="skolem"><span class="skolem">μ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_ω<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="skolem">ω</span> <span class="skolem">ix</span> <span class="skolem">μ1</span> <span class="skolem">N</span> <span class="skolem">μ2</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mω ω_at_ix b snd_conv splits_at_def<span class="main">)</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_a<span class="main">:</span> <span class="quoted"><span class="quoted">"splits_at <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">a1</span> <span class="skolem">M</span> <span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerivationIntro_bounds_ij LeftDerivationIntro_examine_rule Mω 
                   fst_conv ldintro splits_at_def<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_word_a1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="skolem">a1</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> LeftDerives1_splits_at_is_word b <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="skolem">ω</span> <span class="main">@</span> <span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_a b Mω
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeftDerives1_implies_Derives1 snd_conv splits_at_combine_dest<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="skolem">μ1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">μ2</span> <span class="main">@</span> <span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_ω splits_at_combine 
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">have</span></span> is_nonterminal_N<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nonterminal <span class="skolem">N</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>6<span class="main">)</span> rule_nonterminal_type <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                <span class="keyword1"><span class="command">with</span></span> LeftDerivationFix_splits_at_nonterminal split_a b 
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">U</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="bound">c1</span><span class="main">.</span> splits_at <span class="skolem">b</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ix</span><span class="main">)</span> <span class="bound">b1</span> <span class="bound">U</span> <span class="bound">b2</span> <span class="main">∧</span> splits_at <span class="skolem">c</span> <span class="skolem">j</span> <span class="bound">c1</span> <span class="bound">U</span> <span class="bound">b2</span> <span class="main">∧</span>
                  LeftDerivation <span class="bound">b1</span> <span class="skolem">E</span> <span class="bound">c1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationFix_def c_at_j<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> b1b2c1<span class="main">:</span>
                  <span class="quoted"><span class="quoted">"splits_at <span class="skolem">b</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ix</span><span class="main">)</span> <span class="skolem">b1</span> <span class="skolem">N</span> <span class="skolem">b2</span> <span class="main">∧</span> splits_at <span class="skolem">c</span> <span class="skolem">j</span> <span class="skolem">c1</span> <span class="skolem">N</span> <span class="skolem">b2</span> <span class="main">∧</span>
                   LeftDerivation <span class="skolem">b1</span> <span class="skolem">E</span> <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_at_j splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c1_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">=</span> terminals <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_def j_q
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj splits_at_def<span class="main">)</span> 
                <span class="keyword1"><span class="command">have</span></span> length_a1_eq_i<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">a1</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_a splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
                <span class="keyword1"><span class="command">have</span></span> length_μ1_eq_ix<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">μ1</span> <span class="main">=</span> <span class="skolem">ix</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_ω splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ix</span><span class="main">)</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b1b2c1 splits_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1_eq_a1_μ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="skolem">μ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_def length_a1_eq_i length_μ1_eq_ix
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj take_add<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">(</span><span class="skolem">a1</span> <span class="main">@</span> <span class="skolem">μ1</span><span class="main">)</span> <span class="skolem">E</span> <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b1b2c1 b1_eq_a1_μ1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">from</span></span> LeftDerivation_skip_prefixword_ex<span class="main">[</span><span class="operator">OF</span> this is_word_a1<span class="main">]</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">∧</span> 
                  LeftDerivation <span class="skolem">μ1</span> <span class="main">(</span>derivation_shift <span class="skolem">E</span> <span class="main">(</span>length <span class="skolem">a1</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">have</span></span> a1_eq_take_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="main">(</span>terminals <span class="free">q</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> w c1_q split_a append_eq_conv_conj length_a1_eq_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                <span class="keyword1"><span class="command">have</span></span> μ1_leftderives<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="skolem">μ1</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">i</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w c1_q split_a 
                  LeftDerivation_implies_leftderives append_eq_conv_conj length_a1_eq_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2.hyps"</span> L LeftDerivationLadder_implies_LeftDerivation_at_index 
                    One_nat_def Suc_lessD a_as_γ diff_Suc_eq_diff_pred diff_Suc_less n numeral_2_eq_2<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> LD_to_M<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">i</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">M</span><span class="main">]</span><span class="main">@</span><span class="skolem">a2</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> split_a splits_at_combine a1_eq_take_i terminals_take <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> is_ladder<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ladder <span class="skolem">D</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LeftDerivationLadder_def<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n_less_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n m is_ladder_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"2.hyps"</span> One_nat_def diff_Suc_less 
                    length_greater_0_conv zero_less_diff<span class="main">)</span> 
                <span class="keyword1"><span class="command">have</span></span> m_le_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> length <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m is_ladder_def is_ladder dual_order.refl 
                  ladder_n_last_is_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  n_less_m m_le_D
                  <span class="keyword1"><span class="command">using</span></span> length_take less_irrefl less_le_trans linear min.absorb2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_take_n_D<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">D</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> n_less_m m_le_D less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
                <span class="keyword1"><span class="command">have</span></span> ω_decompose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ω</span> <span class="main">=</span> <span class="skolem">μ1</span><span class="main">@</span><span class="main">(</span><span class="skolem">N</span><span class="main">#</span><span class="skolem">μ2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_ω splits_at_combine <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">ω</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Derives1_rule LeftDerives1_implies_Derives1 Mω b<span class="main">)</span> 
                <span class="keyword1"><span class="command">with</span></span> ω_decompose <span class="keyword1"><span class="command">have</span></span> M_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">μ1</span><span class="main">@</span><span class="main">(</span><span class="skolem">N</span><span class="main">#</span><span class="skolem">μ2</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">have</span></span> i_le_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> length <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1_eq_take_i length_a1_eq_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
                  y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Item <span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">μ1</span> <span class="main">@</span> <span class="skolem">N</span> <span class="main">#</span> <span class="skolem">μ2</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">μ1</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">i</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">from</span></span> less.hyps<span class="main">[</span><span class="operator">OF</span> length_take_n_D less.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">,</span></span> 4<span class="main"><span class="main">,</span></span> 5<span class="main"><span class="main">)</span></span> M_rule i_le_q LD_to_M
                   μ1_leftderives less.prems<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> y less.prems<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">have</span></span> y_in_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Item <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">@</span><span class="skolem">β</span><span class="main">)</span> <span class="main">0</span> <span class="free">k'</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z_is_init_item<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> init_item <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">@</span><span class="skolem">β</span><span class="main">)</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_item_def<span class="main">)</span> 
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> Predict <span class="free">k'</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span>"</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z_is_init_item<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_symbol_predicts<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_complete_def next_symbol_def y<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y item_end_def<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> Predict <span class="free">k'</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Predict_def bin_def y_in_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z_in_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Predict_π_fix items_le_Predict less.prems<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main">)</span> 
                <span class="keyword1"><span class="command">have</span></span> length_chars_q<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>chars <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">have</span></span> x_is_inc_dot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> inc_dot <span class="main">(</span>length <span class="skolem">α</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less.prems<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> r_eq_length_q length_chars_q z inc_dot_def<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> wellformed_items_I<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_items <span class="free">I</span>"</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> less.prems<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> LocalLexing.items_le_is_filter LocalLexing.wellformed_items_Gen 
                    LocalLexing_axioms empty_subsetI less.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> subsetCE wellformed_items_Scan 
                    wellformed_items_π wellformed_items_def<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> z_in_I <span class="keyword1"><span class="command">have</span></span> wellformed_z<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="skolem">z</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> wellformed_items_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
                <span class="keyword1"><span class="command">have</span></span> item_β_z<span class="main">:</span> <span class="quoted"><span class="quoted">"item_β <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">α</span><span class="main">@</span><span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z_is_init_item<span class="main">)</span> 
                <span class="keyword1"><span class="command">have</span></span> item_end_z<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">z</span> <span class="main">=</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z_is_init_item<span class="main">)</span>               
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="free">k'</span> <span class="main">{}</span> <span class="main">{</span><span class="skolem">z</span><span class="main">}</span>"</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_is_inc_dot<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> thmD6<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wellformed_z<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> item_β_z<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> item_end_z<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α_derives_empty<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="free">k'</span> <span class="main">{}</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z_in_I
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> contra_subsetD empty_subsetI insert_subset monoD mono_π<span class="main">)</span> 
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LocalLexing.wellformed_item_def LocalLexing_axioms 
                    π_subset_elem_trans item.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> item.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> items_le_def items_le_is_filter 
                    less.prems<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> less.prems<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span> mem_Collect_eq wellformed_z z<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>    
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> thmD11<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_charslength<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="free">p</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> T_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> q_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">X</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rule_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> length <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> leftderives_start<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> leftderives_α<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="free">α</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> item_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Item <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">@</span><span class="free">β</span><span class="main">)</span> <span class="main">(</span>length <span class="free">α</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> items_le <span class="free">k'</span> <span class="main">(</span>π <span class="free">k'</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">D</span><span class="main">.</span> LeftDerivation  <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="bound">D</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> leftderives_start leftderives_implies_LeftDerivation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"LeftDerivation  <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">D</span> <span class="main">(</span><span class="main">(</span>terminals <span class="main">(</span>take <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">N</span><span class="main">]</span><span class="main">@</span><span class="free">γ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> thmD11_helper<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">,</span></span> 4<span class="main"><span class="main">,</span></span> 5<span class="main"><span class="main">,</span></span> 6<span class="main"><span class="main">,</span></span> 7<span class="main"><span class="main">)</span></span> D assms<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">,</span></span> 10<span class="main"><span class="main">,</span></span> 11<span class="main"><span class="main">,</span></span> 12<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD12">
<div class="head">
<h1>Theory TheoremD12</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD12
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD11.html">TheoremD11</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> charslength_appendix_is_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"charslength <span class="main">(</span><span class="free">p</span><span class="main">@</span><span class="free">ts</span><span class="main">)</span> <span class="main">=</span> charslength <span class="free">p</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> charslength <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> charslength <span class="free">p</span> <span class="main">+</span> charslength <span class="skolem">ts</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">ts</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> charslength_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>        

<span class="keyword1"><span class="command">lemma</span></span> empty_tokens_have_charslength_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span> charslength <span class="free">ts</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_idempotent'<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="main">{}</span> <span class="main">(</span>π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> π <span class="free">k</span> <span class="free">T</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_no_tokens<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complete_π_fix Predict_π_fix fix_is_fix_of_limit<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> thmD12<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct_tokens<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">⊇</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">item</span>
    <span class="keyword3"><span class="command">assume</span></span> x_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">q</span><span class="main">.</span> pvalid <span class="bound">q</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span> <span class="main">∧</span> charslength <span class="bound">q</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">I</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">∉</span> items_le <span class="bound">n</span> <span class="bound">I</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> items_le_is_filter subsetCE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Gen_implies_pvalid x_dom items_le_fix_D items_le_idempotent items_le_paths_le 
          pvalid_item_end<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span> <span class="main">∧</span> charslength <span class="skolem">q</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="main">∉</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span> 
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">with</span></span> q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gen_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_le_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> induct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> LocalLexing.items_le_def LocalLexing_axioms 𝒥_subset_Suc_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">have</span></span> q_is_limit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> limit <span class="main">(</span>Append <span class="main">(</span>𝒴 <span class="main">(</span>𝒵 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> limit_Append_path_nonelem_split<span class="main">[</span><span class="operator">OF</span> q_is_limit 2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_ts<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">ts</span> <span class="main">∧</span>
           <span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span> <span class="main">∧</span>
           charslength <span class="skolem">p</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span>
           admissible <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> 𝒴 <span class="main">(</span>𝒵 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="main">(</span>butlast <span class="skolem">ts</span><span class="main">)</span><span class="main">.</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ts_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">using</span></span> self_append_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> 𝒴 <span class="main">(</span>𝒵 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> π <span class="free">k</span> <span class="skolem">T</span> <span class="main">(</span>Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> q p_ts <span class="keyword1"><span class="command">have</span></span> chars_of_token_is_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span> <span class="main">⟹</span> chars_of_token <span class="bound">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> charslength_appendix_is_empty chars_append charslength.simps le_add1 le_imp_less_Suc 
            le_neq_implies_less length_append not_less_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token list"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">sss</span> <span class="skolem">ts</span> <span class="main">⟹</span> pvalid <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="skolem">sss</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="skolem">sss</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sss</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> less
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sss</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">sss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> 1                
                  <span class="keyword1"><span class="command">with</span></span> less <span class="keyword1"><span class="command">have</span></span> pvalid_p_x<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="skolem">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> charslength_p<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_ts <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                  <span class="keyword1"><span class="command">with</span></span> p_ts <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_le_def<span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> pvalid_p_x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                    <span class="keyword1"><span class="command">using</span></span> Gen_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="free">k</span> <span class="skolem">T</span> <span class="main">(</span>Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> π_apply_setmonotone 
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid_item_end q J LocalLexing.items_le_def 
                    LocalLexing_axioms charslength_p mem_Collect_eq pvalid_p_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> 2
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span> <span class="bound">ss</span><span class="main">.</span> <span class="skolem">sss</span> <span class="main">=</span> <span class="bound">ss</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rev_exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sss</span> <span class="main">=</span> <span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pvalid_left <span class="main">(</span><span class="skolem">p'</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc less pvalid_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> pvalid_left_def this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="keyword2"><span class="keyword">where</span></span> pvalid<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"wellformed_tokens <span class="main">(</span><span class="skolem">p'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
                     wellformed_item <span class="skolem">x</span> <span class="main">∧</span>
                     <span class="skolem">r</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">p'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
                     charslength <span class="main">(</span><span class="skolem">p'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> item_end <span class="skolem">x</span> <span class="main">∧</span>
                     charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> item_origin <span class="skolem">x</span> <span class="main">∧</span>
                     is_leftderivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ω</span><span class="main">)</span> <span class="main">∧</span>
                     leftderives <span class="main">(</span>item_α <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="skolem">p'</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">have</span></span> is_prefix_ss_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc less 
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_append<span class="main">)</span> 
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="skolem">ss</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p' snoc p_ts <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">p'</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> 𝔓"</span></span> <span class="keyword1"><span class="command">using</span></span> q 𝔓_covers_𝒫 prefixes_are_paths' subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                  <span class="keyword1"><span class="command">have</span></span> charslength_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">ss</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> empty_tokens_have_charslength_0<span class="main">)</span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_prefix_ss_ts append_is_Nil_conv chars_append chars_of_token_is_empty 
                      charslength.simps charslength_0 is_prefix_def length_greater_0_conv list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p'</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p' p_ts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
                  <span class="keyword1"><span class="command">have</span></span> a_in_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_dropD is_prefix_append is_prefix_cons list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
                      snoc less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T p_ts <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> 𝒳 <span class="free">k</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> LocalLexing.𝒵.simps<span class="main">(</span>2<span class="main">)</span> LocalLexing_axioms T 𝒵_subset_𝒳 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">note</span></span> h5 <span class="main">=</span> q'
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> item_nonterminal <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> item_α <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> β<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> item_β <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">have</span></span> item_rule_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_rule <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> N α β item_nonterminal_def item_rhs_def item_rhs_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_item <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span><span class="main">@</span><span class="skolem">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> item_rule_x
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_item_def<span class="main">)</span> 
                  <span class="keyword1"><span class="command">have</span></span> h7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid q' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                  <span class="keyword1"><span class="command">have</span></span> h8<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ω</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> N is_leftderivation_def pvalid q' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">have</span></span> h9<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="skolem">α</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="skolem">q'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> α pvalid q' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">have</span></span> h10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="skolem">a</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_in_ts chars_of_token_is_empty<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> h11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Item <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="skolem">q'</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> α charslength_ss a_in_ts append_Nil2 chars.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chars_append 
                      chars_of_token_is_empty charslength.simps h2 item.collapse item_dot_is_α_length 
                      item_rule_x length_greater_0_conv list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> pvalid q'<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> x_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> items_le <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="skolem">T</span> <span class="free">k</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
                    <span class="keyword1"><span class="command">using</span></span> thmD11<span class="main">[</span><span class="operator">OF</span> h1 h2 h3 h4 h5 h6 h7 h8 h9 h10 h11<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">{</span></span>
                    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">item</span>
                    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">toks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token list"</span></span>
                    <span class="keyword3"><span class="command">assume</span></span> pvalid_toks_y<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="skolem">toks</span> <span class="skolem">y</span>"</span></span>
                    <span class="keyword3"><span class="command">assume</span></span> is_prefix_toks_p'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">toks</span> <span class="skolem">p'</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength_toks<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">toks</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> charslength_of_prefix h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> item_end_y<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">y</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid_item_end pvalid_toks_y 
                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">toks</span> <span class="skolem">p</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ss'</span><span class="main">.</span> is_prefix <span class="bound">ss'</span> <span class="skolem">ss</span> <span class="main">∧</span> <span class="skolem">toks</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">@</span><span class="bound">ss'</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> is_prefix_of_append is_prefix_toks_p' p' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> 1  
                        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">toks</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_ts prefixes_are_paths <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                        <span class="keyword1"><span class="command">with</span></span> charslength_toks <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">toks</span> <span class="main">∈</span> paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_le_def<span class="main">)</span>
                        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid_toks_y
                          Gen_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> π <span class="free">k</span> <span class="skolem">T</span> <span class="main">(</span>Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> π_apply_setmonotone 
                          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> J items_le_def item_end_y<span class="main">)</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> 2
                        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">ss'</span> <span class="skolem">ss</span> <span class="main">∧</span> <span class="skolem">toks</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">@</span><span class="skolem">ss'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss'</span> <span class="main">&lt;</span> length <span class="skolem">sss</span>"</span></span>
                          <span class="keyword1"><span class="command">using</span></span> append_eq_conv_conj append_self_conv is_prefix_length length_append 
                            less_le_trans nat_neq_iff not_Cons_self2 not_add_less1 snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                        <span class="keyword1"><span class="command">have</span></span> l2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="skolem">ss'</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ss' is_prefix_ss_ts
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_dropped_prefix is_prefix_append<span class="main">)</span> 
                        <span class="keyword1"><span class="command">have</span></span> l3<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="skolem">ss'</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ss' pvalid_toks_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
                        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> less.hyps<span class="main">[</span><span class="operator">OF</span> l1 l2 l3<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>Prefixes <span class="skolem">p'</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">J</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Gen_implies_pvalid Prefixes_is_prefix subsetI<span class="main">)</span> 
                  <span class="keyword1"><span class="command">with</span></span> x_dom <span class="keyword1"><span class="command">have</span></span> r0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> items_le <span class="free">k</span> <span class="main">(</span>π <span class="free">k</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="skolem">T</span> <span class="free">k</span> <span class="skolem">J</span><span class="main">)</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LocalLexing.items_le_def LocalLexing_axioms 
                      mem_Collect_eq mono_Scan mono_π mono_subset_elem subsetI<span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_in_π<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="skolem">T</span> <span class="free">k</span> <span class="skolem">J</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> LocalLexing.items_le_is_filter LocalLexing_axioms subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
                  <span class="keyword1"><span class="command">have</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="skolem">T</span> <span class="free">k</span> <span class="skolem">J</span> <span class="main">=</span> <span class="skolem">J</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> J Scan_π_fix<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="free">k</span> <span class="main">{}</span> <span class="skolem">J</span> <span class="main">=</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> π_idempotent' <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">from</span></span> x_in_π r1 r2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>    
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">note</span></span> th <span class="main">=</span> this
        <span class="keyword1"><span class="command">have</span></span> x_in_J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> th<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ts</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_prefix_eq_proper_prefix<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> p_ts q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> 𝒯_eq_𝒵<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> induct induct_tokens 𝒯_equals_𝒵_induct_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> T_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> 𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒯_eq_𝒵 T <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> π <span class="free">k</span> <span class="skolem">T</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> induct J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊆</span> π <span class="free">k</span> <span class="skolem">T</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_is_filter monoD mono_π<span class="main">)</span> 
        <span class="keyword1"><span class="command">with</span></span> T_alt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">⊆</span> 𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒥.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> x_in_J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> LocalLexing.items_le_def LocalLexing_axioms pvalid_item_end q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD13">
<div class="head">
<h1>Theory TheoremD13</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD13
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD12.html">TheoremD12</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pointwise_natUnion_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pointwise_f<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>natUnion <span class="free">G</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">G</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> f_simp <span class="main">=</span> pointwise_simp<span class="main">[</span><span class="operator">OF</span> pointwise_f<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>natUnion <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">{</span><span class="free">f</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>natUnion <span class="free">G</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">G</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>  <span class="main">⋃</span> <span class="main">{</span><span class="free">f</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">G</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> h1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> h2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> pointwise_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"pointwise Gen"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pointwise_def Gen_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> thmD13_part1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 𝒯 <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> start <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> thmD9 valid_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> sup<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">⊇</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> thmD12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> tokens<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒯_equals_𝒵_induct_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> sub sup tokens <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> thmD13_part2<span class="main">:</span>      
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>ℐ <span class="free">k</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒬 <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> part1 <span class="main">=</span> thmD13_part1<span class="main">[</span><span class="operator">OF</span> start valid_k<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>ℐ <span class="free">k</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> items_le_pointwise pointwise_natUnion_swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> natUnion  <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> part1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> e3<span class="main">:</span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pointwise_Gen pointwise_natUnion_swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> e4<span class="main">:</span> <span class="quoted"><span class="quoted">"natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> paths_le <span class="free">k</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> 𝒫 <span class="free">k</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> paths_le_pointwise pointwise_natUnion_swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>   
  <span class="keyword1"><span class="command">from</span></span> e1 e2 e3 e4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">theorem</span></span> thmD13<span class="main">:</span>      
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 𝒯 <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="free">u</span> 
    <span class="main">∧</span> items_le <span class="free">k</span> <span class="main">(</span>ℐ <span class="free">k</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒬 <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> thmD13_part1<span class="main">[</span><span class="operator">OF</span> start valid_k<span class="main">]</span> thmD13_part2<span class="main">[</span><span class="operator">OF</span> start valid_k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TheoremD14">
<div class="head">
<h1>Theory TheoremD14</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> TheoremD14
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD13.html">TheoremD13</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_tokens_of_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"empty_tokens <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> empty_tokens_is_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> items_le_split_via_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">J</span> <span class="main">=</span> items_le <span class="free">k</span> <span class="free">J</span> <span class="main">∪</span> items_eq <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">J</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_def items_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> paths_le_split_via_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"paths_le <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> paths_le <span class="free">k</span> <span class="free">P</span> <span class="main">∪</span> paths_eq <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_le_def paths_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> natUnion_superset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">i</span> <span class="main">⊆</span> natUnion <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> natUnion_elem subset_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indexle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">indexle</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>indexlt <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">produced_by_scan_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">produced_by_scan_step</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k'</span> <span class="bound">u'</span> <span class="bound">y</span> <span class="bound">X</span><span class="main">.</span> indexle <span class="bound">k'</span> <span class="bound">u'</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> 𝒥 <span class="bound">k'</span> <span class="bound">u'</span> <span class="main">∧</span> 
   item_end <span class="bound">y</span> <span class="main">=</span> <span class="bound">k'</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="main">(</span>𝒯 <span class="bound">k'</span> <span class="bound">u'</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> inc_item <span class="bound">y</span> <span class="main">(</span><span class="bound">k'</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="bound">X</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
   next_symbol <span class="bound">y</span> <span class="main">=</span> Some <span class="main">(</span>terminal_of_token <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> indexle_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"indexle <span class="free">k''</span> <span class="free">u''</span> <span class="free">k'</span> <span class="free">u'</span> <span class="main">⟹</span> indexle <span class="free">k'</span> <span class="free">u'</span> <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> indexle <span class="free">k''</span> <span class="free">u''</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> indexle_def indexlt_trans
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"indexle <span class="free">k''</span> <span class="free">u''</span> <span class="free">k'</span> <span class="free">u'</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"indexle <span class="free">k'</span> <span class="free">u'</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">na</span><span class="main">.</span> <span class="free">u'</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∨</span> indexlt <span class="bound">n</span> <span class="bound">na</span> <span class="free">k</span> <span class="free">u</span> <span class="main">∨</span> <span class="main">¬</span> indexlt <span class="bound">n</span> <span class="bound">na</span> <span class="free">k'</span> <span class="free">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> indexle_def indexlt_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">na</span><span class="main">.</span> <span class="free">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> indexlt <span class="bound">n</span> <span class="bound">na</span> <span class="free">k</span> <span class="free">u</span> <span class="main">∨</span> <span class="main">¬</span> indexlt <span class="bound">n</span> <span class="bound">na</span> <span class="free">k'</span> <span class="free">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> indexle_def indexlt_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f3 a2 a1 indexle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> produced_by_scan_step_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"indexle <span class="free">k'</span> <span class="free">u'</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"produced_by_scan_step <span class="free">x</span> <span class="free">k'</span> <span class="free">u'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"produced_by_scan_step <span class="free">x</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> produced_by_scan_step_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'a</span></span> <span class="skolem"><span class="skolem">u'a</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> produced_k'_u'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"indexle <span class="skolem">k'a</span> <span class="skolem">u'a</span> <span class="free">k'</span> <span class="free">u'</span> <span class="main">∧</span>
     <span class="skolem">y</span> <span class="main">∈</span> 𝒥 <span class="skolem">k'a</span> <span class="skolem">u'a</span> <span class="main">∧</span>
     item_end <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">k'a</span> <span class="main">∧</span>
     <span class="skolem">X</span> <span class="main">∈</span> 𝒯 <span class="skolem">k'a</span> <span class="skolem">u'a</span> <span class="main">∧</span>
     <span class="free">x</span> <span class="main">=</span> inc_item <span class="skolem">y</span> <span class="main">(</span><span class="skolem">k'a</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="skolem">X</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> next_symbol <span class="skolem">y</span> <span class="main">=</span> Some <span class="main">(</span>terminal_of_token <span class="skolem">X</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> indexle_trans assms<span class="main">(</span>1<span class="main">)</span> produced_by_scan_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒥_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Induct<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒥 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">k</span> <span class="bound">u</span> <span class="main">.</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x'</span> <span class="bound">k'</span> <span class="bound">u'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> 𝒥 <span class="bound">k'</span> <span class="bound">u'</span> <span class="main">⟹</span> indexlt <span class="bound">k'</span> <span class="bound">u'</span> <span class="bound">k</span> <span class="bound">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x'</span> <span class="bound">k'</span> <span class="bound">u'</span><span class="main">)</span> 
                     <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> 𝒥 <span class="bound">k</span> <span class="bound">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">k</span> <span class="bound">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"indexlt_rel <span class="keyword1">&lt;*lex*&gt;</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> wf_R<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_indexlt_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> snd <span class="bound">a</span> <span class="main">∈</span> 𝒥 <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>snd <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒥 <span class="free">k</span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">x</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_R<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">u</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexlt_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> induct<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_no_tokens_item_end<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_π<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> π <span class="free">k</span> <span class="main">{}</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"item_end <span class="free">x</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> x_in_limit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> limit <span class="main">(</span><span class="main">λ</span><span class="bound">I</span><span class="main">.</span> Complete <span class="free">k</span> <span class="main">(</span>Predict <span class="free">k</span> <span class="bound">I</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_in_π π_no_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> limit_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Init <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Iterate <span class="skolem">x</span> <span class="skolem">J</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Iterate<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> Predict <span class="free">k</span> <span class="skolem">J</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Complete_item_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Predict_item_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Iterate<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> natUnion_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> natUnion <span class="free">f</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> mk_disjoint_insert natUnion_superset natUnion_upperbound 
    subsetCE subset_insert<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> locate_in_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_limit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> limit <span class="free">f</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_notin_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> funpower <span class="free">f</span> <span class="bound">n</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">N</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="bound">N</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_in_limit limit_def natUnion_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="skolem">N</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="skolem">n</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound"><span class="bound">m</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> funpower <span class="free">f</span> <span class="bound">m</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 
        <span class="keyword1"><span class="command">with</span></span> x_notin_X <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> funpower <span class="free">f</span> <span class="skolem">n</span> <span class="free">X</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> funpower <span class="free">f</span> <span class="skolem">n</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1     
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> less_SucI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> N <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> produced_by_scan_step<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> 𝒥 <span class="free">k</span> <span class="free">u</span> <span class="main">⟹</span> item_end <span class="free">x</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="main">⟹</span> produced_by_scan_step <span class="free">x</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> 𝒥_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Induct <span class="skolem">x</span> <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases3<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">with</span></span> Induct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒥_0_0_item_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
        <span class="keyword1"><span class="command">with</span></span> Induct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span>  <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc_pred' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">with</span></span> Induct 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒥 <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>ℐ <span class="skolem">k'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k'<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> ℐ <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> π_no_tokens_item_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">with</span></span> Induct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> 𝒥 <span class="skolem">k'</span> <span class="bound">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ℐ.simps natUnion_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒥 <span class="skolem">k'</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> k'_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> item_end <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k' Induct <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
            <span class="keyword1"><span class="command">have</span></span> indexlt<span class="main">:</span> <span class="quoted"><span class="quoted">"indexlt <span class="skolem">k'</span> <span class="skolem">u'</span> <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexlt_simp k'<span class="main">)</span> 
            <span class="keyword1"><span class="command">from</span></span> Induct<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> u' this k'_bound<span class="main">]</span> 
            <span class="keyword1"><span class="command">have</span></span> pred_produced<span class="main">:</span> <span class="quoted"><span class="quoted">"produced_by_scan_step <span class="skolem">x</span> <span class="skolem">k'</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> indexlt produced_by_scan_step_trans indexle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ex_u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u'</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">=</span> Suc <span class="bound">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Suc <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> Induct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒥 <span class="skolem">k</span> <span class="main">(</span>Suc <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_in_π<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="skolem">k</span> <span class="main">(</span>𝒯 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u' 𝒥.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒥 <span class="skolem">k</span> <span class="skolem">u'</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∉</span> 𝒥 <span class="skolem">k</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">have</span></span> indexlt<span class="main">:</span> <span class="quoted"><span class="quoted">"indexlt <span class="skolem">k</span> <span class="skolem">u'</span> <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexlt_simp u'<span class="main">)</span>             
            <span class="keyword1"><span class="command">with</span></span> Induct<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1 indexlt Induct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> indexle_def produced_by_scan_step_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">have</span></span> item_end_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> item_end <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Induct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> Scan <span class="main">(</span>𝒯 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">∘</span> Complete <span class="skolem">k</span> <span class="main">∘</span> Predict <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> limit <span class="skolem">f</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> x_in_π π_functional f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">from</span></span> locate_in_limit<span class="main">[</span><span class="operator">OF</span> this 2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> funpower <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">∧</span>
               <span class="skolem">x</span> <span class="main">∉</span> funpower <span class="skolem">f</span> <span class="skolem">n</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> funpower <span class="skolem">f</span> <span class="skolem">n</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> x_f_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Y n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Scan <span class="main">(</span>𝒯 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>Complete <span class="skolem">k</span> <span class="main">(</span>Predict <span class="skolem">k</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> comp_apply f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>Complete <span class="skolem">k</span> <span class="main">(</span>Predict <span class="skolem">k</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
              <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span> inc_item <span class="bound">x'</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> length <span class="bound">c</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x'</span> <span class="bound">t</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">∈</span> bin <span class="main">(</span>Complete <span class="skolem">k</span> <span class="main">(</span>Predict <span class="skolem">k</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">∧</span> 
                    <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>𝒯 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∧</span> next_symbol <span class="bound">x'</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Scan_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> 1
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> item_end_x x_f_Y Complete_item_end Predict_item_end
                  <span class="keyword1"><span class="command">using</span></span> less_not_refl3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> 2
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> limit <span class="skolem">f</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Y limit_def natUnion_superset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> π <span class="skolem">k</span> <span class="main">(</span>𝒯 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_functional<span class="main">)</span>  
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Y_in_𝒥<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> 𝒥 <span class="skolem">k</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_𝒥<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete <span class="skolem">k</span> <span class="main">(</span>Predict <span class="skolem">k</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">⊆</span> 𝒥 <span class="skolem">k</span> <span class="skolem">u</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">(* automatically generated *)</span>
                  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="bound">I</span> <span class="bound">Ia</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span> mono <span class="bound">f</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">I</span><span class="main">::</span>item set<span class="main">)</span> <span class="main">⊆</span> <span class="bound">Ia</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">i</span><span class="main">::</span>item<span class="main">)</span> <span class="main">∉</span> <span class="bound">f</span> <span class="bound">I</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">f</span> <span class="bound">Ia</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mono_subset_elem<span class="main">)</span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ii</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"item set <span class="main">⇒</span> item set <span class="main">⇒</span> item"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
                    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v2</span><span class="main">.</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="bound">x1</span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main">∉</span> <span class="bound">x0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ii</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="main">∈</span> <span class="bound">x1</span> <span class="main">∧</span> <span class="skolem">ii</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="main">∉</span> <span class="bound">x0</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span> <span class="bound">Ia</span><span class="main">.</span> <span class="skolem">ii</span> <span class="bound">Ia</span> <span class="bound">I</span> <span class="main">∈</span> <span class="bound">I</span> <span class="main">∧</span> <span class="skolem">ii</span> <span class="bound">Ia</span> <span class="bound">I</span> <span class="main">∉</span> <span class="bound">Ia</span> <span class="main">∨</span> <span class="bound">I</span> <span class="main">⊆</span> <span class="bound">Ia</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
                    f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Suc <span class="skolem">nn</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> ex_u' <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>Complete <span class="skolem">k</span> <span class="main">(</span>Predict <span class="skolem">k</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Complete <span class="skolem">k</span> <span class="main">(</span>π <span class="skolem">k</span> <span class="main">(</span>𝒯 <span class="skolem">k</span> <span class="main">(</span>Suc <span class="skolem">nn</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="skolem">nn</span><span class="main">)</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                      <span class="keyword1"><span class="command">using</span></span> f3 f2 Complete_π_fix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Complete_regular Predict_π_fix Predict_regular 
                      𝒥.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Y_in_𝒥 regular_implies_mono<span class="main">)</span>
                <span class="keyword1"><span class="command">qed</span></span> 
                <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span>  <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'_t_c<span class="main">:</span>
                  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> inc_item <span class="skolem">x'</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> length <span class="skolem">c</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x'</span> <span class="main">∈</span> bin <span class="main">(</span>Complete <span class="skolem">k</span> <span class="main">(</span>Predict <span class="skolem">k</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">∧</span> 
                    <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> 𝒯 <span class="skolem">k</span> <span class="skolem">u</span> <span class="main">∧</span> next_symbol <span class="skolem">x'</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> produced_by_scan_step_def<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexle_def<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">using</span></span> x'_t_c bin_def in_𝒥 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                  <span class="keyword1"><span class="command">using</span></span> x'_t_c bin_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> x'_t_c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>      
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> limit_single_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> limit <span class="free">f</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms elem_limit_simp funpower.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> funpower.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Gen_union<span class="main">:</span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Gen <span class="free">A</span> <span class="main">∪</span> Gen <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Gen_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_prefix_Prefixes_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">q</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Prefixes <span class="free">q</span> <span class="main">⊆</span> Prefixes <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Prefixes_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_prefix_append is_prefix_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Prefixes_subset_𝒫<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Prefixes <span class="free">p</span> <span class="main">⊆</span> 𝒫 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Prefixes_is_prefix assms prefixes_are_paths <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Prefixes_subset_paths_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Prefixes <span class="free">p</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Prefixes <span class="free">p</span> <span class="main">⊆</span> paths_le <span class="main">(</span>charslength <span class="free">p</span><span class="main">)</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Prefixes_is_prefix assms charslength_of_prefix paths_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Scan_𝒥_subset_𝒥<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Scan <span class="main">(</span>𝒯 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">⊆</span> 𝒥 <span class="free">k</span> <span class="main">(</span>Suc <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Scan_π_fix 𝒥.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 𝒥_subset_Suc_u monoD mono_Scan<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_𝒥k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> 𝒥 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> 𝒥 <span class="free">k</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">thm</span></span> 𝒥_subset_Suc_u
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_fSuc<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> 𝒥_subset_Suc_u<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> subset_𝒥ℐk<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒥 <span class="free">k</span> <span class="free">u</span> <span class="main">⊆</span> ℐ <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natUnion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_ℐ𝒥Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ <span class="free">k</span> <span class="main">⊆</span> 𝒥 <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">u</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ <span class="free">k</span> <span class="main">⊆</span> 𝒥 <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 𝒥.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> π_apply_setmonotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a subset_𝒥k<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_ℐSuc<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ <span class="free">k</span> <span class="main">⊆</span> ℐ <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_ℐ𝒥Suc subset_𝒥ℐk<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_ℐ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> ℐ <span class="free">i</span> <span class="main">⊆</span> ℐ <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_fSuc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> u<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">ℐ</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> subset_ℐSuc<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_𝒥 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">∨</span> <span class="main">(</span><span class="free">k'</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">u'</span> <span class="main">≤</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒥 <span class="free">k'</span> <span class="free">u'</span> <span class="main">⊆</span> 𝒥 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> leq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒥 <span class="free">k'</span> <span class="free">u'</span> <span class="main">⊆</span> ℐ <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> subset_𝒥ℐk<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ <span class="free">k'</span> <span class="main">⊆</span> ℐ <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> subset_ℐ<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">from</span></span> subset_ℐ𝒥Suc<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> 1 <span class="keyword1"><span class="command">have</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊆</span> 𝒥 <span class="free">k</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> s4<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒥 <span class="free">k</span> <span class="main">0</span> <span class="main">⊆</span> 𝒥 <span class="free">k</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> subset_𝒥k<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> s1 s2 s3 s4 subset_trans <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subset_𝒥k<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> 𝒥_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"indexle <span class="free">k'</span> <span class="free">u'</span> <span class="free">k</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒥 <span class="free">k'</span> <span class="free">u'</span> <span class="main">⊆</span> 𝒥 <span class="free">k</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> subset_𝒥 indexle_def indexlt_simp
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms less_imp_le_nat order_refl<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> Scan_items_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bounded_T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> length <span class="main">(</span>chars_of_token <span class="bound">t</span><span class="main">)</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span> <span class="main">⊆</span> items_le <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">item</span>
    <span class="keyword3"><span class="command">assume</span></span> x_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="main">(</span>items_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_dom'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Scan <span class="free">T</span> <span class="free">k</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> items_le_is_filter mono_Scan mono_subset_elem<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> x_dom <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> items_le <span class="free">k</span> <span class="free">P</span> <span class="main">∨</span> 
      <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="bound">t</span> <span class="bound">c</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> inc_item <span class="bound">y</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> length <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> bin <span class="main">(</span>items_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span> <span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span>
       <span class="main">∧</span> next_symbol <span class="bound">y</span> <span class="main">=</span> Some <span class="bound">t</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Scan_def <span class="keyword1"><span class="command">using</span></span> UnE mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> items_le_fix_D items_le_idempotent trans_le_add1<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> inc_item <span class="skolem">y</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> length <span class="skolem">c</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> bin <span class="main">(</span>items_le <span class="free">k</span> <span class="free">P</span><span class="main">)</span> <span class="free">k</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> next_symbol <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> item_end_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> length <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> bounded_T y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">c</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> chars_of_token_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">with</span></span> item_end_x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> x_dom' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> items_le <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>Scan <span class="free">T</span> <span class="free">k</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> items_le_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Scan_mono_tokens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span> Scan <span class="free">P</span> <span class="free">k</span> <span class="free">I</span> <span class="main">⊆</span> Scan <span class="free">Q</span> <span class="free">k</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Scan_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> thmD14<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">Doc</span> <span class="main">⟹</span> items_le <span class="free">k</span> <span class="main">(</span>𝒥 <span class="free">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒫 <span class="free">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 𝒯 <span class="free">k</span> <span class="free">u</span> <span class="main">=</span> 𝒵 <span class="free">k</span> <span class="free">u</span> 
    <span class="main">∧</span> items_le <span class="free">k</span> <span class="main">(</span>ℐ <span class="free">k</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="free">k</span> <span class="main">(</span>𝒬 <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjCases2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">have</span></span> 𝒥_eq_𝒫<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 1 thmD8 items_le_paths_le<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> thmD13<span class="main">[</span><span class="operator">OF</span> 𝒥_eq_𝒫 less.prems<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k'</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">=</span> Suc <span class="bound">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> k'_less_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>          
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> simp_left<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>items_le <span class="skolem">k</span> <span class="main">(</span>ℐ <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> items_le_π_swap k' wellformed_items_ℐ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">have</span></span> simp_right<span class="main">:</span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k' paths_le_pointwise pointwise_Gen pointwise_natUnion_swap<span class="main">)</span>            
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">nat</span>
            <span class="keyword1"><span class="command">have</span></span> split_𝒥<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> items_le <span class="skolem">k'</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∪</span> items_eq <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> k'  items_le_split_via_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> sub1<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k'</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k'</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">(* automatically generated *)</span>
                <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k'</span> <span class="main">(</span>Gen <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> items_eq <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span> <span class="main">(</span>Gen <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                  Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> LocalLexing.items_le_split_via_eq LocalLexing_axioms items_le_paths_le k' 
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> dual_order.trans k' less.prems lessI less_imp_le_nat<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k'</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> items_le <span class="skolem">k'</span> <span class="main">(</span>Gen <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_paths_le k' less.hyps<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> natUnion_superset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">item</span>
              <span class="keyword3"><span class="command">assume</span></span> x_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> items_eq <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> x_in_𝒥<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> 𝒥 <span class="skolem">k'</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_dom items_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> item_end_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_dom items_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k'_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> item_end <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
              <span class="keyword1"><span class="command">from</span></span> produced_by_scan_step<span class="main">[</span><span class="operator">OF</span> x_in_𝒥 k'_bound<span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"produced_by_scan_step <span class="skolem">x</span> <span class="skolem">k'</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> produced_by_scan_step_def this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> scan_step<span class="main">:</span>
                <span class="quoted"><span class="quoted">"indexle <span class="skolem">k''</span> <span class="skolem">v''</span> <span class="skolem">k'</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> 𝒥 <span class="skolem">k''</span> <span class="skolem">v''</span> <span class="main">∧</span> item_end <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">k''</span> <span class="main">∧</span> <span class="skolem">X</span> <span class="main">∈</span> 𝒯 <span class="skolem">k''</span> <span class="skolem">v''</span> <span class="main">∧</span>
                 <span class="skolem">x</span> <span class="main">=</span> inc_item <span class="skolem">y</span> <span class="main">(</span><span class="skolem">k''</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="skolem">X</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
                 next_symbol <span class="skolem">y</span> <span class="main">=</span> Some <span class="main">(</span>terminal_of_token <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y_in_items_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> items_le <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="skolem">v''</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> items_le_def LocalLexing_axioms le_refl mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
              <span class="keyword1"><span class="command">have</span></span> y_in_Gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> Gen<span class="main">(</span>paths_le <span class="skolem">k''</span> <span class="main">(</span>𝒫 <span class="skolem">k''</span> <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">(* automatically generated *)</span>
                <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">k'</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∨</span> <span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="bound">n</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> Suc_lessD k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k''</span> <span class="main">=</span> <span class="skolem">k'</span> <span class="main">∨</span> <span class="skolem">k''</span> <span class="main">&lt;</span> <span class="skolem">k'</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> indexle_def indexlt_simp scan_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less.prems less_Suc_eq_le<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k''</span> <span class="main">≤</span> length <span class="free">Doc</span> <span class="main">∨</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">k''</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc_lessD less.prems less_Suc_eq_le less_trans_Suc<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> f4 f3 f2 Suc_lessD y_in_items_le less.hyps less_trans_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> 𝒫 <span class="skolem">k''</span> <span class="skolem">v''</span> <span class="main">∧</span> pvalid <span class="bound">p</span> <span class="skolem">y</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Gen_implies_pvalid paths_le_is_filter rev_subsetD<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="skolem">k''</span> <span class="skolem">v''</span> <span class="main">∧</span> pvalid <span class="skolem">p</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength_p<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">k''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid_item_end scan_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
              <span class="keyword1"><span class="command">have</span></span> pvalid_p_y<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="skolem">p</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="main">(</span>fst <span class="skolem">X</span><span class="main">,</span> snd <span class="skolem">X</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pvalid_next_terminal_admissible<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pvalid_p_y<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> scan_step <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminal_of_token_def<span class="main">)</span> 
                <span class="keyword1"><span class="command">using</span></span> scan_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> TokensAt_subset_𝒳 𝒯_subset_TokensAt 𝒳_are_terminals 
                  rev_subsetD terminal_of_token_def<span class="main">)</span> 
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> admissible_p_X<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">X</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">have</span></span> X_in_𝒵<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> 𝒵 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_lessD 𝒵_subset_Suc 
                k'_bound dual_order.trans indexle_def indexlt_simp item_end_of_inc_item item_end_x 
                le_add1 le_neq_implies_less less.hyps less.prems not_less_eq scan_step subsetCE<span class="main">)</span> 
              <span class="keyword1"><span class="command">have</span></span> pX_in_𝒫_k''_v''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">X</span><span class="main">]</span> <span class="main">∈</span> 𝒫 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span>"</span></span>   
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 𝒫.simps<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> limit_single_step<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Append_def<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> admissible_p_X X_in_𝒵<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> charslength_p p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"indexle <span class="skolem">k''</span> <span class="skolem">v''</span> <span class="skolem">k'</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scan_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"indexle <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexle_def indexlt_simp<span class="main">)</span>               
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒫 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span> <span class="main">⊆</span> 𝒫 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indexle_def indexlt_simp less_or_eq_imp_le subset_𝒫<span class="main">)</span> 
              <span class="keyword1"><span class="command">with</span></span> pX_in_𝒫_k''_v'' <span class="keyword1"><span class="command">have</span></span> pX_in_𝒫_k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">X</span><span class="main">]</span> <span class="main">∈</span> 𝒫 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">X</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k''</span> <span class="main">+</span>  length <span class="main">(</span>chars_of_token <span class="skolem">X</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> charslength_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">X</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> item_end <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scan_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> charslength_p_X<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">X</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> item_end_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pX_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">X</span><span class="main">]</span> <span class="main">∈</span> paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> lessI less_Suc_eq_le mem_Collect_eq pX_in_𝒫_k' paths_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> item_end_x less.prems scan_step wellformed_inc_item wellformed_items_𝒥 
                  wellformed_items_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> wellformed_p_X<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">X</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> 𝒫_wellformed pX_in_𝒫_k''_v'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> pvalid_def pvalid_p_y<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_γ<span class="main">:</span>
                <span class="quoted"><span class="quoted">"wellformed_tokens <span class="skolem">p</span> <span class="main">∧</span>
                 wellformed_item <span class="skolem">y</span> <span class="main">∧</span>
                 <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">p</span> <span class="main">∧</span>
                 charslength <span class="skolem">p</span> <span class="main">=</span> item_end <span class="skolem">y</span> <span class="main">∧</span>
                 charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> item_origin <span class="skolem">y</span> <span class="main">∧</span>
                 is_derivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="skolem">y</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span> <span class="main">∧</span>
                 derives <span class="main">(</span>item_α <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">have</span></span> r_le_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_γ<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> item_nonterminal_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_nonterminal <span class="skolem">x</span> <span class="main">=</span> item_nonterminal <span class="skolem">y</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scan_step<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> item_α_x<span class="main">:</span> <span class="quoted"><span class="quoted">"item_α <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>item_α <span class="skolem">y</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>terminal_of_token <span class="skolem">X</span><span class="main">]</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> item_α_of_inc_item r_γ scan_step<span class="main">)</span>              
              <span class="keyword1"><span class="command">have</span></span> pvalid_x<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">X</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>                
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_def wellformed_x wellformed_p_X<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_SucI r_γ<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> r_γ scan_step <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                <span class="keyword1"><span class="command">using</span></span> r_γ scan_step <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_le_p item_nonterminal_x<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> r_γ <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_le_p item_α_x<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> terminals_singleton append_Nil2 
                  derives_implies_leftderives derives_is_sentence is_sentence_concat 
                  is_sentence_cons is_symbol_def is_word_append is_word_cons is_word_terminals 
                  is_word_terminals_drop leftderives_implies_derives leftderives_padback 
                  leftderives_refl r_γ terminals_append terminals_drop wellformed_p_X<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pX_dom Gen_def 
                LocalLexing_axioms mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sub2<span class="main">:</span> <span class="quoted"><span class="quoted">"items_eq <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans natUnion_superset subsetI<span class="main">)</span>                                       
            <span class="keyword1"><span class="command">have</span></span> suffices3<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> split_𝒥 sub1 sub2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⊆</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> suffices3 simp_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">note</span></span> suffices2 <span class="main">=</span> this
          <span class="keyword1"><span class="command">have</span></span> items_le_natUnion_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>ℐ <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> natUnion<span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_pointwise pointwise_natUnion_swap<span class="main">)</span>            
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> suffices1<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>ℐ <span class="skolem">k'</span><span class="main">)</span> <span class="main">⊆</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> suffices2 natUnion_upperbound <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>    
          <span class="keyword1"><span class="command">have</span></span> sub_lemma<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊆</span> Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊆</span> Gen <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> simp_left<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> thmD5<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> less<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> suffices1 items_le_is_filter items_le_paths_le subsetCE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> items_le_idempotent remove_paths_le_in_subset_Gen<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>          
          <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>items_le <span class="skolem">k</span> <span class="main">(</span>ℐ <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>items_le <span class="skolem">k</span> <span class="main">(</span>natUnion <span class="main">(</span>𝒥 <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>items_le <span class="skolem">k</span> <span class="main">(</span>natUnion <span class="main">(</span>𝒥 <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> items_le_natUnion_swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> simp_left eq1 eq2 
          <span class="keyword1"><span class="command">have</span></span> simp_left'<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">nat</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"token list"</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">item</span>
            <span class="keyword3"><span class="command">assume</span></span> q_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> paths_eq <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> pvalid_q_x<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="skolem">q</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> q_in_𝒫<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="skolem">k'</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_dom paths_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> charslength_q<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_dom paths_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> k'_less_k <span class="keyword1"><span class="command">have</span></span> q_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.hyps"</span> chars.simps<span class="main">(</span>1<span class="main">)</span> charslength.simps list.size<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="main">[</span><span class="bound">X</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id<span class="main">)</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> pX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">X</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">from</span></span> last_step_of_path<span class="main">[</span><span class="operator">OF</span> q_in_𝒫 pX<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> k''<span class="main">:</span>
              <span class="quoted"><span class="quoted">"indexlt <span class="skolem">k''</span> <span class="skolem">v''</span> <span class="skolem">k'</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span> <span class="main">∧</span> charslength <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">k''</span> <span class="main">∧</span> 
               <span class="skolem">X</span> <span class="main">∈</span> 𝒵 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝔓"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LocalLexing.𝔓_covers_𝒫 LocalLexing_axioms 
                append_Nil2 is_prefix_cancel is_prefix_empty pX prefixes_are_paths q_in_𝒫 subsetCE<span class="main">)</span> 
            <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">k''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> 𝒳 <span class="skolem">k''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒵_subset_𝒳 T k'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> item_nonterminal <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> item_α <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> β<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> item_β <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid_def pvalid_q_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> N α β item_nonterminal_def item_rhs_def item_rhs_split prod.collapse 
                wellformed_item_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">have</span></span> pvalid_left_q_x<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid_left <span class="skolem">q</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid_q_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_left<span class="main">)</span> 
            <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> pvalid_left_def pvalid_left_q_x<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_γ<span class="main">:</span> 
              <span class="quoted"><span class="quoted">"wellformed_tokens <span class="skolem">q</span> <span class="main">∧</span>
               wellformed_item <span class="skolem">x</span> <span class="main">∧</span>
               <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">q</span> <span class="main">∧</span>
               charslength <span class="skolem">q</span> <span class="main">=</span> item_end <span class="skolem">x</span> <span class="main">∧</span>
               charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> item_origin <span class="skolem">x</span> <span class="main">∧</span>
               is_leftderivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="skolem">x</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span> <span class="main">∧</span>
               leftderives <span class="main">(</span>item_α <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_γ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> h7<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>terminals <span class="main">(</span>take <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">N</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">γ</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> r_γ N is_leftderivation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword1"><span class="command">have</span></span> h8<span class="main">:</span> <span class="quoted"><span class="quoted">"leftderives <span class="skolem">α</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_γ α <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> h9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k''</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_γ
              <span class="keyword1"><span class="command">using</span></span> charslength_q h2 pX <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">have</span></span> h10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Item <span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="skolem">α</span> <span class="main">@</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> N α β charslength_q item.collapse item_dot_is_α_length item_nonterminal_def 
                item_rhs_def item_rhs_split prod.collapse r_γ<span class="main">)</span>             
            <span class="keyword1"><span class="command">from</span></span> thmD11<span class="main">[</span><span class="operator">OF</span> h1 h2 h3 h4 pX h5 h6 h7 h8 h9 h10<span class="main">]</span> 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> items_le <span class="skolem">k</span> <span class="main">(</span>π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> items_le_is_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>             
            <span class="keyword1"><span class="command">have</span></span> subset1<span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="skolem">p</span> <span class="main">⊆</span> Prefixes <span class="skolem">q</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_prefix_Prefixes_subset<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pX is_prefix_def<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> subset2<span class="main">:</span> <span class="quoted"><span class="quoted">"Prefixes <span class="skolem">q</span> <span class="main">⊆</span> 𝒫 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Prefixes_subset_𝒫<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> k'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">from</span></span> subset1 subset2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Prefixes <span class="skolem">p</span> <span class="main">⊆</span> 𝒫 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Prefixes <span class="skolem">p</span> <span class="main">⊆</span> paths_le <span class="skolem">k''</span> <span class="main">(</span>𝒫 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> k'' Prefixes_subset_paths_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>            
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subset3<span class="main">:</span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>Prefixes <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> Gen <span class="main">(</span>paths_le <span class="skolem">k''</span> <span class="main">(</span>𝒫 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Gen_def LocalLexing_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> k''_less_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k''</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k'' k' <span class="keyword1"><span class="command">using</span></span> indexlt_simp less_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k''_Doc_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k''</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> k''_less_k k''_Doc_bound<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">v''</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> induct1<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="skolem">k''</span> <span class="main">(</span>𝒫 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> k''_less_k k''_Doc_bound<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc<span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> induct2<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 𝒵 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> subset4<span class="main">:</span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>Prefixes <span class="skolem">p</span><span class="main">)</span> <span class="main">⊆</span> items_le <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> subset3 induct1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> induct1 subset4
            <span class="keyword1"><span class="command">have</span></span> subset6<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 
              Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>items_le <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_Scan<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k''</span> <span class="main">+</span> length <span class="main">(</span>chars_of_token <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h9<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">T</span> <span class="main">⟹</span> length <span class="main">(</span>chars_of_token <span class="bound">t</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>chars_of_token <span class="skolem">X</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> Scan_items_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">T</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k''</span></span> <span class="quoted"><span class="quoted">"𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span>"</span></span><span class="main">]</span> h9
            <span class="keyword1"><span class="command">have</span></span> subset7<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>items_le <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">⊆</span> items_le <span class="skolem">k</span> <span class="main">(</span>Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> 𝒵 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T k''
              <span class="keyword1"><span class="command">using</span></span> 𝒵_subset_Suc rev_subsetD singletonD subsetI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> T_subset_𝒯<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> 𝒯 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> induct2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> subset8<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
              Scan <span class="main">(</span>𝒯 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> T_subset_𝒯 Scan_mono_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> subset9<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="main">(</span>𝒯 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Scan_𝒥_subset_𝒥<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> subset10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> subset8 subset9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k''</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k'' indexlt_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"indexle <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> indexlt_simp
              <span class="keyword1"><span class="command">using</span></span> indexle_def le_neq_implies_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subset11<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 𝒥 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 𝒥_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> subset12<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 𝒥 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> subset8 subset9 subset10 subset11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subset13<span class="main">:</span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k</span> <span class="main">(</span>Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>𝒥 <span class="skolem">k''</span> <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
              items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> items_le_def mem_Collect_eq rev_subsetD subsetI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">have</span></span> subset14<span class="main">:</span> <span class="quoted"><span class="quoted">"Scan <span class="skolem">T</span> <span class="skolem">k''</span> <span class="main">(</span>Gen <span class="main">(</span>Prefixes <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> subset6 subset7 subset13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> x_in
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> π_apply_setmonotone π_subset_elem_trans subsetCE subsetI<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> x_in' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> k' mono_π mono_subset_elem natUnion_superset<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">note</span></span> suffices6 <span class="main">=</span> this
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">nat</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>paths_eq <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> suffices6 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Gen_implies_pvalid subsetI<span class="main">)</span> 
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">note</span></span> suffices5 <span class="main">=</span> this
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">nat</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> paths_le <span class="skolem">k'</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∪</span> paths_eq <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span>  paths_le_split_via_eq k' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Gen_split<span class="main">:</span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              Gen <span class="main">(</span>paths_le <span class="skolem">k'</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> Gen<span class="main">(</span>paths_eq <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Gen_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> case_le<span class="main">:</span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>paths_le <span class="skolem">k'</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>  π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">from</span></span> less k'_less_k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
              <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> k'_less_k this<span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"items_le <span class="skolem">k'</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> Gen <span class="main">(</span>paths_le <span class="skolem">k'</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>paths_le <span class="skolem">k'</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> items_le_def LocalLexing_axioms k'_less_k natUnion_superset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> π_apply_setmonotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> π <span class="skolem">k</span> <span class="main">{}</span> <span class="main">(</span>natUnion <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k'</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Gen_split case_le suffices5 UnE rev_subsetD subsetI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">note</span></span> suffices4 <span class="main">=</span> this
          <span class="keyword1"><span class="command">have</span></span> super_lemma<span class="main">:</span> <span class="quoted"><span class="quoted">"Gen <span class="main">(</span>paths_le <span class="skolem">k</span> <span class="main">(</span>𝒫 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> items_le <span class="skolem">k</span> <span class="main">(</span>𝒥 <span class="skolem">k</span> <span class="main">0</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> simp_right<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> simp_left'<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> suffices4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> natUnion_ex rev_subsetD subsetI<span class="main">)</span> 
          <span class="keyword1"><span class="command">from</span></span> super_lemma sub_lemma <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>             
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> thmD13 less.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PathLemmas">
<div class="head">
<h1>Theory PathLemmas</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> PathLemmas
<span class="keyword2"><span class="keyword">imports</span></span> <a href="TheoremD14.html">TheoremD14</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> characterize_𝒫<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">p</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="bound">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟹</span> admissible <span class="free">p</span> <span class="main">⟹</span>
  <span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>charslength <span class="free">p</span><span class="main">)</span> <span class="bound">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> snoc.prems <span class="keyword1"><span class="command">have</span></span> admissible_p<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 is_prefix_admissible is_prefix_cancel is_prefix_empty<span class="main">)</span> 
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> ilen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">p</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI Suc_le_lessD trans_le_add1<span class="main">)</span> 
      <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">i</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">i</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> ilen <span class="keyword1"><span class="command">have</span></span> p_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>  
      <span class="keyword1"><span class="command">from</span></span> ilen <span class="keyword1"><span class="command">have</span></span> p_take<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_or_eq_imp_le<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> u p_at p_take <span class="keyword1"><span class="command">have</span></span> p_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="bound">i</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> admissible_p snoc.hyps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>charslength <span class="skolem">p</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add_Suc_right append_Nil2 length_Cons length_append 
        less_Suc_eq_le less_or_eq_imp_le<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="skolem">p</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> v_leq_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> LocalLexing.subset_fSuc LocalLexing_axioms 𝒵_subset_Suc subsetCE<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> path_append_token<span class="main">[</span><span class="operator">OF</span> u this snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>charslength <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_𝒫_charslength <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> case_v_leq_u <span class="main">=</span> this
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> u_less_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Suc <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less_imp_Suc_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">with</span></span> u_less_v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">with</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>charslength <span class="skolem">p</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> subsetCE subset_𝒫k<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> v w path_append_token<span class="main">[</span><span class="operator">OF</span> this _ snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>charslength <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_𝒫_charslength <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> case_u_less_v <span class="main">=</span> this
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> case_v_leq_u case_u_less_v not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> drop_empty_tokens<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> length <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"charslength <span class="main">(</span>take <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> admissible<span class="main">:</span> <span class="quoted"><span class="quoted">"admissible <span class="main">(</span>drop <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">r</span> <span class="free">p</span> <span class="main">∈</span> 𝔓"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> p_𝒵<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">p</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="bound">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
    <span class="keyword1"><span class="command">using</span></span> tokens_nth_in_𝒵 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> drop <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> j <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> length_p_q_r<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">=</span> length <span class="skolem">q</span> <span class="main">+</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r q add.commute diff_add_inverse le_Suc_ex length_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> j_plus_r_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="free">r</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j length_p_q_r<span class="main">)</span> 
    <span class="keyword1"><span class="command">with</span></span> p_𝒵 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">p</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> p_at_is_q_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute q r<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>take <span class="skolem">j</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute q take_add<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> empty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charslength <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> charslength <span class="main">(</span>take <span class="skolem">j</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> u p_at_is_q_at <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">j</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="skolem">j</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> 𝒵 <span class="main">(</span>charslength <span class="main">(</span>take <span class="bound">i</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> characterize_𝒫<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">∈</span> 𝒫 <span class="main">(</span>charslength <span class="skolem">q</span><span class="main">)</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> admissible q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 𝔓_covers_𝒫 q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="MainTheorems">
<div class="head">
<h1>Theory MainTheorems</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> MainTheorems
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PathLemmas.html">PathLemmas</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> LocalLexing <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ℑ_is_generated_by_𝔓<span class="main">:</span> <span class="quoted"><span class="quoted">"ℑ <span class="main">=</span> Gen 𝔓"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_items <span class="main">(</span>ℐ <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wellformed_items_ℐ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> ℐ <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">⟹</span> item_end <span class="bound">x</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wellformed_item_def wellformed_items_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ℐ <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">⊆</span> items_le <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">(</span>ℐ <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> items_le_def<span class="main">)</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ℐ <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">=</span> items_le <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">(</span>ℐ <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> items_le_is_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ℑ_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"ℑ <span class="main">=</span> items_le <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">(</span>ℐ <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ℑ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">(</span>𝒬 <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> charslength <span class="bound">p</span> <span class="main">≤</span> length <span class="free">Doc</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝔓_are_doc_tokens 𝔓_def doc_tokens_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒬 <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">⊆</span> paths_le <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">(</span>𝒬 <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> paths_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒬 <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">=</span> paths_le <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">(</span>𝒬 <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> paths_le_is_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 𝔓_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔓 <span class="main">=</span> paths_le <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span> <span class="main">(</span>𝒬 <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝔓_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ℑ_altdef 𝔓_altdef thmD14 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finished_item</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"symbol list <span class="main">⇒</span> item"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finished_item</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> Item <span class="main">(</span><span class="free">𝔖</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">Doc</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> item_rule_finished_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_rule <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">𝔖</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_origin_finished_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_origin <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_end_finished_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_end <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">=</span> length <span class="free">Doc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_dot_finished_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_dot <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">=</span> length <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_rhs_finished_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_rhs <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_item_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_α_finished_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_α <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_item_def item_α_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> item_nonterminal_finished_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"item_nonterminal <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">=</span> <span class="free">𝔖</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_item_def item_nonterminal_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Derives1_of_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">[</span><span class="free">N</span><span class="main">]</span> <span class="free">i</span> <span class="free">r</span> <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derives1_bound
    <span class="keyword1"><span class="command">using</span></span> length_Cons less_Suc0 list.size<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> Derives1_def append_Cons append_self_conv append_self_conv2 length_0_conv 
      list.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pvalid_with</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tokens <span class="main">⇒</span> item <span class="main">⇒</span> nat <span class="main">⇒</span> symbol list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pvalid_with</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">=</span> 
     <span class="main">(</span>wellformed_tokens <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span>
     wellformed_item <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span>
     charslength <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> item_end <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
     charslength <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> item_origin <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
     is_derivation <span class="main">(</span>terminals <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>item_nonterminal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span><span class="main">)</span> <span class="main">∧</span>
     derives <span class="main">(</span>item_α <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>terminals <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pvalid_with<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u</span> <span class="bound">γ</span><span class="main">.</span> pvalid_with <span class="free">p</span> <span class="free">x</span> <span class="bound">u</span> <span class="bound">γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pvalid_def pvalid_with_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> Completeness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_in_ll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> ll"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α</span><span class="main">.</span> pvalid_with <span class="free">p</span> <span class="main">(</span>finished_item <span class="bound">α</span><span class="main">)</span> <span class="main">0</span> <span class="main">[]</span> <span class="main">∧</span> finished_item <span class="bound">α</span> <span class="main">∈</span> ℑ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> 𝔓 <span class="main">∧</span> charslength <span class="free">p</span> <span class="main">=</span> length <span class="free">Doc</span> <span class="main">∧</span> terminals <span class="free">p</span> <span class="main">∈</span> ℒ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p_in_ll ll_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> derives_p<span class="main">:</span> <span class="quoted"><span class="quoted">"derives <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℒ_def is_derivation_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">D</span><span class="main">.</span> Derivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="bound">D</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> derives_implies_Derivation<span class="main">)</span>   
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivation <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="skolem">D</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> is_word_p<span class="main">:</span> <span class="quoted"><span class="quoted">"is_word <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> leftlang p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> not_is_word_𝔖<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>is_word <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_nonterminal_startsymbol is_terminal_nonterminal 
    is_word_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D is_word_p not_is_word_𝔖 <span class="keyword1"><span class="command">using</span></span> Derivation.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">d</span> <span class="bound">D'</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">=</span> <span class="bound">d</span><span class="main">#</span><span class="bound">D'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D Derivation.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">d</span><span class="main">#</span><span class="skolem">D'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α</span><span class="main">.</span> Derives1 <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="bound">α</span> <span class="main">∧</span> derives <span class="bound">α</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d D Derivation.simps<span class="main">(</span>2<span class="main">)</span> Derivation_implies_derives <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"Derives1 <span class="main">[</span><span class="free">𝔖</span><span class="main">]</span> <span class="main">(</span>fst <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">d</span><span class="main">)</span> <span class="skolem">α</span> <span class="main">∧</span> derives <span class="skolem">α</span> <span class="main">(</span>terminals <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> snd_d_in_ℜ<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">d</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derives1_rule <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">with</span></span> α <span class="keyword1"><span class="command">have</span></span> snd_d<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="free">𝔖</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Derives1_of_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> wellformed_p<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_tokens <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝔓_wellformed p<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wellformed_finished_item<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="main">(</span>finished_item <span class="skolem">α</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_item_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> snd_d snd_d_in_ℜ <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>    
  <span class="keyword1"><span class="command">have</span></span> pvalid_with<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid_with <span class="free">p</span> <span class="main">(</span>finished_item <span class="skolem">α</span><span class="main">)</span> <span class="main">0</span> <span class="main">[]</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_with_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> wellformed_p <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> wellformed_finished_item <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_item_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_derivation_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pvalid <span class="free">p</span> <span class="main">(</span>finished_item <span class="skolem">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid_def pvalid_with_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finished_item <span class="skolem">α</span> <span class="main">∈</span> Gen 𝔓"</span></span> <span class="keyword1"><span class="command">using</span></span> Gen_def mem_Collect_eq p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finished_item <span class="skolem">α</span> <span class="main">∈</span> ℑ"</span></span> <span class="keyword1"><span class="command">using</span></span> ℑ_is_generated_by_𝔓 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">with</span></span> pvalid_with <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> Soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finished_item_α<span class="main">:</span> <span class="quoted"><span class="quoted">"finished_item <span class="free">α</span> <span class="main">∈</span> ℑ"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span><span class="main">.</span> pvalid_with <span class="bound">p</span> <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">0</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> ll"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finished_item <span class="free">α</span> <span class="main">∈</span> Gen 𝔓"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℑ_is_generated_by_𝔓 finished_item_α <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> 𝔓 <span class="main">∧</span> pvalid <span class="skolem">p</span> <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Gen_implies_pvalid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> pvalid_p_finished_item<span class="main">:</span> <span class="quoted"><span class="quoted">"pvalid  <span class="skolem">p</span> <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> pvalid_def this<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> pvalid<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wellformed_tokens <span class="skolem">p</span> <span class="main">∧</span>
     wellformed_item <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">∧</span>
     <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">p</span> <span class="main">∧</span>
     length <span class="main">(</span>chars <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> length <span class="free">Doc</span> <span class="main">∧</span>
     chars <span class="main">(</span>take <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span>
     is_derivation <span class="main">(</span>take <span class="skolem">r</span> <span class="main">(</span>terminals <span class="skolem">p</span><span class="main">)</span> <span class="main">@</span> <span class="free">𝔖</span> <span class="main">#</span> <span class="skolem">γ</span><span class="main">)</span> <span class="main">∧</span> derives <span class="free">α</span> <span class="main">(</span>drop <span class="skolem">r</span> <span class="main">(</span>terminals <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span>  <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"item_rule <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pvalid
    <span class="keyword1"><span class="command">using</span></span> wellformed_item_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">𝔖</span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℜ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is_derivation_α<span class="main">:</span> <span class="quoted"><span class="quoted">"is_derivation <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_derivation_def leftderives_rule<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> drop_r_p_in_𝔓<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">∈</span> 𝔓"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> drop_empty_tokens<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> pvalid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> pvalid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 derives_trans is_derivation_α is_derivation_def 
      is_derivation_implies_admissible is_word_terminals_drop pvalid terminals_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_ll<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">∈</span> ll"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ll_def<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil append_take_drop_id chars_append pvalid<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> is_derivation_α pvalid
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ℒ_def derives_trans is_derivation_def 
      is_word_terminals_drop mem_Collect_eq terminals_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pvalid_with <span class="main">(</span>drop <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>finished_item <span class="free">α</span><span class="main">)</span> <span class="main">0</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pvalid_with_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 𝔓_wellformed drop_r_p_in_𝔓 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">using</span></span> pvalid <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil append_take_drop_id chars_append pvalid<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_derivation_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> pvalid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> in_ll <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_finished_and_finished_item<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed_item <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_finished <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">α</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> finished_item <span class="bound">α</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> is_finished_x<span class="main">:</span> <span class="quoted"><span class="quoted">"is_finished <span class="free">x</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> item_rhs <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> finished_item <span class="skolem">α</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> item.expand<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> α is_finished_def is_finished_x item_nonterminal_def item_rhs_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> α assms is_complete_def is_finished_def is_finished_x wellformed_item_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_finished_def is_finished_x <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> is_finished_def is_finished_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> finished_item <span class="bound">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> left_implies_right <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">α</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> finished_item <span class="bound">α</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> finished_item <span class="skolem">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_finished <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> α is_finished_def is_complete_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> right_implies_left <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> left_implies_right right_implies_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">theorem</span></span> Correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ll <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> earley_recognised"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ll <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">α</span><span class="main">.</span> finished_item <span class="bound">α</span> <span class="main">∈</span> ℑ<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Soundness Completeness ex_in_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">α</span><span class="main">.</span> finished_item <span class="bound">α</span> <span class="main">∈</span> ℑ<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> ℑ<span class="main">.</span> is_finished <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℑ_def is_finished_and_finished_item wellformed_items_ℐ wellformed_items_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> earley_recognised_def 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>