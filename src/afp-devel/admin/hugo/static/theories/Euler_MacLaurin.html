<div id="Euler_MacLaurin">
<div class="head">
<h1>Theory Euler_MacLaurin</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Euler--MacLaurin summation formula›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Euler_MacLaurin
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Complex_Analysis/Complex_Analysis.html">HOL-Complex_Analysis.Complex_Analysis</a>"</span>
  <a href="../Bernoulli/Periodic_Bernpoly.html">Bernoulli.Periodic_Bernpoly</a>
  <a href="../Bernoulli/Bernoulli_FPS.html">Bernoulli.Bernoulli_FPS</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary facts›</span></span>

<span class="comment1">(* TODO Move? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> pbernpoly_of_int <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pbernpoly <span class="free">n</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">=</span> bernoulli <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_bernpoly' <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bernpoly <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_algebra_1<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> continuous_on_compose2<span class="main">[</span><span class="operator">OF</span> continuous_on_bernpoly assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_atLeastAtMost_int_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">b</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">+</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">b</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">…</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">+</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_atLeastAtMost_int_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">b</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">a</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_in_nonpos_Reals_imp_add_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∉</span> <span class="main">ℝ<span class="hidden">⇩</span><sub>≤</sub><span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> of_real <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_eq_0_iff2<span class="main">)</span>
<span class="comment1">(* END TODO *)</span>

<span class="keyword1"><span class="command">lemma</span></span> negligible_atLeastAtMostI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> negligible <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="main">(</span><span class="free">b</span><span class="main">::</span>real<span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> integrable_on_negligible<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"negligible <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'n</span> <span class="main">::</span> euclidean_space <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach<span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integrable_spike_set_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integrable_on_empty<span class="main">)</span>  
    
<span class="keyword1"><span class="command">lemma</span></span> Union_atLeastAtMost_real_of_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span>real_of_int <span class="bound">n</span><span class="main">..</span>real_of_int <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>real_of_int <span class="free">a</span><span class="main">..</span>real_of_int <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real_of_int <span class="free">a</span><span class="main">..</span>real_of_int <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span>real_of_int <span class="bound">n</span><span class="main">..</span>real_of_int <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> real_of_int <span class="free">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> real_of_int <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> real_of_int <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> of_int <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> of_int <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span> 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="bound">n</span><span class="main">..</span>of_int <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">⌊</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">⌋</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The remainder terms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following describes the remainder term in the classical version of the Euler--MacLaurin
  formula.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EM_remainder'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach<span class="main">)</span> <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EM_remainder'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">/</span> fact <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> integral <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we define the remainder term that occurs when one lets the right bound of summation 
  in the Euler--MacLaurin formula tend to infinity.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EM_remainder_converges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EM_remainder_converges</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">L</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="bound">L</span><span class="main">)</span> at_top<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EM_remainder</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EM_remainder</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> EM_remainder_converges <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span>
        Lim at_top <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemmas are fairly obvious -- but tedious to prove -- 
  properties of the remainder terms.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_eqI<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">b</span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">L</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">b</span> <span class="main">=</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EM_remainder_def EM_remainder_converges_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_Lim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> integrable_EM_remainder'_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="skolem">A</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span>
    <span class="keyword1"><span class="command">using</span></span> continuous_on_subset<span class="main">[</span><span class="operator">OF</span> assms that<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="free">b</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span>real_of_int <span class="bound">n</span><span class="main">..</span>real_of_int <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_combine_division<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">intro</span> ballI<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">division_of</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Union_atLeastAtMost_real_of_int<span class="main">[</span><span class="operator">OF</span> ab<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> division_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">{</span>of_int <span class="skolem">i</span><span class="main">..</span>of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="skolem">I</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_spike<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> of_int <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="skolem">I</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">-</span> <span class="main">{</span>of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> of_int <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"floor <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pbernpoly <span class="free">n</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> of_int <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def bernpoly_def frac_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integrable_on_negligible<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> integrable_EM_remainder'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span> <span class="main">≤</span> <span class="main">⌊</span><span class="free">b</span><span class="main">⌋</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">b</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≤</span> <span class="skolem">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a'_def b'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">(</span><span class="main">{</span><span class="skolem">a'</span><span class="main">..</span><span class="skolem">b'</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_EM_remainder'_int continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">(</span><span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">a'</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_spike<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pbernpoly <span class="free">n</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> bernpoly <span class="free">n</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> of_int <span class="main">(</span>floor <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> 
         <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span>real_of_int <span class="skolem">a'</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>real_of_int <span class="skolem">a'</span><span class="main">}</span>"</span></span><span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span>real_of_int <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"floor <span class="skolem">x</span> <span class="main">=</span> floor <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a'_def
        <span class="keyword1"><span class="command">using</span></span> ceiling_diff_floor_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> floor_unique<span class="main"><span class="keyword3">;</span></span> <span class="operator">linarith</span><span class="main">)</span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def frac_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> integrable_continuous_real 
         continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">(</span><span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_spike<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pbernpoly <span class="free">n</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> bernpoly <span class="free">n</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> of_int <span class="skolem">b'</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real_of_int <span class="skolem">b'</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>real_of_int <span class="skolem">b'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> real_of_int <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"floor <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> b'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> floor_unique<span class="main"><span class="keyword3">;</span></span> <span class="operator">linarith</span><span class="main">)</span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def frac_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> integrable_continuous_real 
         continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">(</span><span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">a'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a'</span><span class="main">..</span><span class="skolem">b'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * A B C
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_Un<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">subst</span> ivl_disj_un<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ivl_disj_un max_def min_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">a'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a'</span><span class="main">..</span><span class="skolem">b'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>ceiling <span class="free">a</span> <span class="main">≤</span> floor <span class="free">b</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_spike<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> floor <span class="free">a</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pbernpoly <span class="free">n</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> bernpoly <span class="free">n</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> floor <span class="free">a</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">-</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> floor <span class="free">a</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> ceiling_altdef <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_floor_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">with</span></span> * ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"floor <span class="skolem">x</span> <span class="main">=</span> floor <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def frac_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder'_bounded_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded_linear <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="free">h</span> <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
           integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linear_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">h</span> <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_linear <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_EM_remainder' assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EM_remainder'_def linear_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_converges_of_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EM_remainder_converges_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> of_real <span class="skolem">L</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> of_real <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span>
         <span class="main">(</span><span class="operator">intro</span> EM_remainder'_bounded_linear <span class="main"><span class="main">[</span></span><span class="operator">OF</span> bounded_linear_of_real<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> L<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder_converges_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_converges_of_real_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> 
            <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span> real_normed_algebra_1<span class="main">,</span> real_inner<span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟷</span> EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EM_remainder_converges_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span> <span class="main">∙</span> <span class="main">1</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">=</span>
            EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span>
         <span class="main">(</span><span class="operator">subst</span> EM_remainder'_bounded_linear <span class="main"><span class="main">[</span></span><span class="operator">OF</span> bounded_linear_of_real<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> L<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder_converges_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">intro</span> EM_remainder_converges_of_real assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_of_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> 
             <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span> real_normed_algebra_1<span class="main">,</span> real_inner<span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> 
             of_real <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">=</span> 
              <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>int<span class="main">.</span> of_real <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext EM_remainder'_bounded_linear<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bounded_linear_of_real<span class="main"><span class="main">]</span></span>
            continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> EM_remainder_converges_of_real_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EM_remainder_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EM_remainder_converges_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_real <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="free">a</span> 
                <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> of_real <span class="skolem">L</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tendsto_of_real L<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> L L' tendsto_Lim<span class="main">[</span><span class="operator">OF</span> _ L<span class="main">]</span> tendsto_Lim<span class="main">[</span><span class="operator">OF</span> _ L'<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EM_remainder_def EM_remainder_converges_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder'_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> EM_remainder' <span class="free">n'</span> <span class="free">g</span> <span class="free">a'</span> <span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> integral <span class="main">{</span><span class="free">a'</span><span class="main">..</span><span class="free">b'</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n'</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">g</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EM_remainder'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_converges_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> of_int <span class="free">a</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">a'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> EM_remainder_converges <span class="free">n'</span> <span class="free">g</span> <span class="free">a'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder_converges_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> EM_remainder'_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl refl refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> of_int <span class="free">a</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">a'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> EM_remainder <span class="free">n'</span> <span class="free">g</span> <span class="free">a'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> EM_remainder_converges <span class="free">n'</span> <span class="free">g</span> <span class="free">a'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> EM_remainder_converges_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> EM_remainder'_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl refl refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms * <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_converges_cnj<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> bounded_linear <span class="quoted">cnj</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bounded_linear_cnj<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder_converges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> tendsto_cnj <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> EM_remainder'_bounded_linear <span class="main"><span class="main">[</span></span><span class="operator">OF</span> bounded_linear_cnj<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> continuous_on_subset <span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span> <span class="main">⤏</span> cnj <span class="skolem">L</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EM_remainder_converges_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_converges_cnj_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟷</span> EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span>cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> EM_remainder_converges_cnj <span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> assms<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">intro</span> EM_remainder_converges_cnj assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_cnj<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> cnj <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>EM_remainder_converges <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> EM_remainder_converges_cnj_iff <span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EM_remainder_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder_converges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> tendsto_cnj <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> EM_remainder'_bounded_linear <span class="main"><span class="main">[</span></span><span class="operator">OF</span> bounded_linear_cnj<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> continuous_on_subset <span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span> <span class="main">⤏</span> cnj <span class="skolem">L</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> EM_remainder_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> cnj <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> EM_remainder_eqI<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder'_combine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">c</span><span class="main">}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">+</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">b</span> <span class="free">c</span> <span class="main">=</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">+</span> integral <span class="main">{</span><span class="free">b</span><span class="main">..</span><span class="free">c</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span>
          integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">c</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Henstock_Kurzweil_Integration.integral_combine assms integrable_EM_remainder'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EM_remainder'_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> uniformly_convergent_EM_remainder'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span>real_normed_algebra<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">G</span> <span class="keyword1">has_real_derivative</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">y</span> <span class="keyword1">within</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> integrable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a'</span> <span class="bound">b</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span>  <span class="free">a</span> <span class="main">≤</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="bound">a'</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">⟹</span> 
                         <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="bound">a'</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"convergent <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span>real <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"uniformly_convergent_on <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">s</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> bounded_linear <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">/</span> fact <span class="free">n</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bounded_linear_scaleR_right<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> bounded_pbernpoly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> C <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> C <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> C<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder'_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> uniformly_convergent_on uniformly_convergent_improper_integral'<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">a</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">C</span> <span class="main">*</span> <span class="free">G</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> <span class="skolem">C</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> DERIV_cmult deriv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">a'</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="skolem">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">y</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="skolem">a'</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> integrable<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> conv <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span>real <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> convergent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tendsto_mult<span class="main">[</span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"convergent <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">C</span> <span class="main">*</span> <span class="free">G</span> <span class="main">(</span>real <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> convergent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> norm <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">unfolding</span></span> norm_scaleR 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bound<span class="main"><span class="main">]</span></span> ballI mult_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> uniform_limit_EM_remainder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span>real_normed_algebra<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">G</span> <span class="keyword1">has_real_derivative</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">y</span> <span class="keyword1">within</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> integrable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a'</span> <span class="bound">b</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span>  <span class="free">a</span> <span class="main">≤</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="bound">a'</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">⟹</span> 
                         <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="bound">a'</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"convergent <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span>real <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"uniform_limit <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">s</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span> <span class="bound">b</span><span class="main">)</span> 
             <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> sequentially"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"uniformly_convergent_on <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">s</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> uniformly_convergent_EM_remainder'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> uniformly_convergent_uniform_limit_iff
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> uniform_limit_cong refl always_eventually allI ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"convergent <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="free">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> uniformly_convergent_imp_convergent<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lim <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="free">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> EM_remainder_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span>
               lim <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">⤏</span> <span class="var">?L</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">unfolding</span></span> convergent_LIMSEQ_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real <span class="main">(</span>nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="var">?L</span><span class="main">)</span> at_top"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> filterlim_nat_sequentially<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="var">?L</span><span class="main">)</span> at_top"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_EM_remainder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span>real_normed_algebra<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">G</span> <span class="keyword1">has_real_derivative</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">y</span> <span class="keyword1">within</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> integrable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a'</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="bound">a'</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">⟹</span> 
                         <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="bound">a'</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"convergent <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span>real <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="bound">b</span><span class="main">)</span> 
             <span class="main">(</span>nhds <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> sequentially"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uniform_limit <span class="main">{</span><span class="main">()</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">s</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="bound">b</span><span class="main">)</span> 
             <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> sequentially"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> uniform_limit_EM_remainder<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> G <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">()</span> <span class="main">∈</span> <span class="main">{</span><span class="main">()</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_uniform_limitI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> EM_remainder_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EM_remainder'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> holomorphic_EM_remainder'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> 
       <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> <span class="free">f'</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">z</span> <span class="keyword1">within</span> <span class="free">U</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">c</span> <span class="bound">z</span> <span class="bound">e</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="bound">b</span><span class="main">..</span><span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">U</span> <span class="main">×</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"convex <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder'_def scaleR_conv_of_real
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> holo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> leibniz_rule_holomorphic<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> cbox <span class="skolem">b</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> complex_of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span>
             complex_of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f'</span> <span class="skolem">z</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">z</span> <span class="keyword1">within</span> <span class="free">U</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> DERIV_cmult deriv<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> complex_of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">z</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> cbox <span class="skolem">b</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">U</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">b</span><span class="main">..</span><span class="skolem">c</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cont <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_subset<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">U</span> <span class="main">×</span> cbox <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span>
            complex_of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f'</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"floor <span class="free">x</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"floor <span class="free">x</span> <span class="main">&gt;</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="free">a</span> <span class="free">x</span> <span class="keyword1">holomorphic_on</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
                   <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> holo<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="free">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext integral_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">z</span> <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"floor <span class="skolem">t</span> <span class="main">=</span> floor <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def frac_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="main">{</span><span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">..&lt;</span><span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">..</span>of_int <span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">}</span> <span class="main">(</span>insert <span class="main">{</span>of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> 
                          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span>of_int <span class="bound">n</span><span class="main">..</span>of_int <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span>of_int <span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">}</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span>of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="main">|</span>
             <span class="skolem">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span>of_int <span class="skolem">n</span><span class="main">..</span>of_int <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A_cases <span class="main">=</span> this

    <span class="keyword1"><span class="command">have</span></span> division<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="keyword1">division_of</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> division_ofI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def N_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span> <span class="keyword3"><span class="command">assume</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> ceiling_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"floor <span class="free">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> K 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def N_def<span class="main">)</span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> K <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="skolem">K</span> <span class="main">=</span> cbox <span class="bound">a</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K1</span> <span class="skolem">K2</span> <span class="keyword3"><span class="command">assume</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K1</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K2</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K1</span> <span class="main">≠</span> <span class="skolem">K2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"interior <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">}</span> <span class="main">∩</span> interior <span class="main">{</span><span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 ceiling_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"floor <span class="free">x</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def max_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">hence</span></span> F2<span class="main">:</span> <span class="quoted"><span class="quoted">"interior <span class="main">{</span><span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> interior <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> F3<span class="main">:</span> <span class="quoted"><span class="quoted">"interior <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">}</span> <span class="main">∩</span> interior <span class="main">{</span>of_int <span class="skolem">n</span><span class="main">..</span>of_int <span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
               <span class="quoted"><span class="quoted">"interior <span class="main">{</span><span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> interior <span class="main">{</span>of_int <span class="skolem">n</span><span class="main">..</span>of_int <span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
               <span class="quoted"><span class="quoted">"interior <span class="main">{</span>of_int <span class="skolem">n</span><span class="main">..</span>of_int <span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">∩</span> interior <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
               <span class="quoted"><span class="quoted">"interior <span class="main">{</span>of_int <span class="skolem">n</span><span class="main">..</span>of_int <span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">∩</span> interior <span class="main">{</span><span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">using</span></span> 3 ceiling_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"floor <span class="free">x</span>"</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def max_def N_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> F4<span class="main">:</span> <span class="quoted"><span class="quoted">"interior <span class="main">{</span>real_of_int <span class="skolem">n</span><span class="main">..</span>of_int <span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">∩</span> interior <span class="main">{</span>of_int <span class="skolem">m</span><span class="main">..</span>of_int <span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>real_of_int <span class="skolem">n</span><span class="main">..</span>of_int <span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{</span>of_int <span class="skolem">m</span><span class="main">..</span>of_int <span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> F1 F2 F3 F4 K <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"interior <span class="skolem">K1</span> <span class="main">∩</span> interior <span class="skolem">K2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> A_cases<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> not_False_eq_True<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def N_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main">)</span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span> <span class="main">&lt;</span> <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span>of_int <span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="main">{</span>of_int <span class="bound">n</span><span class="main">..</span>of_int <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def Un_ac<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">∈</span><span class="skolem">N</span><span class="main">.</span> <span class="main">{</span>of_int <span class="bound">n</span><span class="main">..</span>of_int <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>of_int <span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">..</span>real_of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Union_atLeastAtMost_real_of_int<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..</span>of_int <span class="main">⌈</span><span class="free">a</span><span class="main">⌉</span><span class="main">}</span> <span class="main">∪</span> <span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span>real_of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ivl_disj_un<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∪</span> <span class="main">{</span>of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ivl_disj_un<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>


    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">∑</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> integral <span class="bound">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> <span class="main">⌊</span>Inf <span class="bound">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> 
            <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> holomorphic_on_sum holo<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">X</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> division <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> division_of_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> cbox <span class="skolem">b</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> subset <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">(</span>cbox <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> <span class="main">⌊</span>Inf <span class="main">{</span><span class="skolem">b</span><span class="main">..</span><span class="skolem">c</span><span class="main">}</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> 
               <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> holo<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> 
                           <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> holomorphic_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">z</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> integral <span class="bound">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> <span class="main">⌊</span>Inf <span class="bound">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> division
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_combine_division<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">b</span><span class="main">..</span><span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> A_cases<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> X <span class="keyword2"><span class="keyword">and</span></span> division <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> division_of_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> X' <span class="keyword1"><span class="command">have</span></span> bc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> of_int <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">z</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span>
                 integral <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> of_int <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> X' <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> bc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_integral int<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">z</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span>
                 integral <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> of_int <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_spike_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span>Sup <span class="skolem"><span class="skolem">X</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t</span><span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> this
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="skolem">t</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> A_cases <span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> floor_unique<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ceiling_altdef <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> floor_unique<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ceiling_altdef <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> 3
            <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> floor_unique<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ceiling_altdef N_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def frac_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">G</span> <span class="keyword1">has_real_derivative</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">y</span> <span class="keyword1">within</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv'<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span> <span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="main">⟹</span> 
       <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> <span class="free">f'</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">z</span> <span class="keyword1">within</span> <span class="free">U</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">U</span> <span class="main">×</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">c</span> <span class="bound">z</span> <span class="bound">e</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> of_real <span class="main">(</span>bernpoly <span class="free">n</span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="bound">b</span><span class="main">..</span><span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> int'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a'</span> <span class="bound">b</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span>  <span class="free">a</span> <span class="main">≤</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="bound">a'</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">⟹</span> 
                         <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="bound">a'</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"convergent <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">G</span> <span class="main">(</span>real <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"open <span class="free">U</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> analytic_EM_remainder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">::</span>complex<span class="main">.</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> holomorphic_EM_remainder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">::</span>complex<span class="main">.</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">::</span>complex<span class="main">.</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> analytic_on_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹open <span class="free">U</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ε</span></span> <span class="keyword2"><span class="keyword">where</span></span> ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="skolem">z</span> <span class="skolem">ε</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_contains_ball<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> ball <span class="skolem">z</span> <span class="skolem">ε</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> holomorphic_uniform_sequence<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> ball <span class="skolem">z</span> <span class="skolem">ε</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> holomorphic_EM_remainder'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> ball <span class="skolem">z</span> <span class="skolem">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span>real_of_int <span class="free">a</span><span class="main">..</span>real <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> <span class="free">f'</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">s</span> <span class="keyword1">within</span> ball <span class="skolem">z</span> <span class="skolem">ε</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ε <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> DERIV_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deriv'<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">e</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ε <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ε int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> cont <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>ball <span class="skolem">z</span> <span class="skolem">ε</span> <span class="main">×</span> <span class="main">{</span>real_of_int <span class="free">a</span><span class="main">..</span>real <span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">z</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_subset<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> ε<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> ball <span class="skolem">z</span> <span class="skolem">ε</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>ball <span class="skolem">z</span> <span class="skolem">ε</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> s <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"cball <span class="skolem">s</span> <span class="skolem">δ</span> <span class="main">⊆</span> ball <span class="skolem">z</span> <span class="skolem">ε</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> open_contains_cball <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>cball <span class="skolem">s</span> <span class="skolem">δ</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> at_top"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_mono <span class="main"><span class="main">[</span></span><span class="operator">OF</span> bound<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> δ ε<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uniform_limit <span class="main">(</span>cball <span class="skolem">s</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> sequentially"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> uniform_limit_EM_remainder<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deriv int' conv bound'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> δ ε s<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">δ</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> cball <span class="skolem">s</span> <span class="bound">δ</span> <span class="main">⊆</span> ball <span class="skolem">z</span> <span class="skolem">ε</span> <span class="main">∧</span> uniform_limit <span class="main">(</span>cball <span class="skolem">s</span> <span class="bound">δ</span><span class="main">)</span>
                          <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> sequentially"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ε <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">ε</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> ball <span class="skolem">z</span> <span class="bound">ε</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">::</span>complex<span class="main">.</span> EM_remainder <span class="free">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analytic_imp_holomorphic<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma is the first step in the proof of the Euler--MacLaurin formula: 
  We show the relationship between the first-order remainder term and the difference of 
  the integral and the sum.
›</span></span>
  
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">f'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">I</span> <span class="free">S</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>real_of_int <span class="free">a</span><span class="main">..</span>real_of_int <span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> S_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">&lt;..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≡</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span>
  diff_sum_integral_has_integral_int<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>frac <span class="bound">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">I</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def I_def has_integral_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span>real_of_int <span class="bound">n</span><span class="main">..</span>real_of_int <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> division<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">division_of</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Union_atLeastAtMost_real_of_int<span class="main">[</span><span class="operator">OF</span> ab<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> division_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cont' <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="skolem">A</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span>
    <span class="keyword1"><span class="command">using</span></span> continuous_on_subset<span class="main">[</span><span class="operator">OF</span> cont that<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="numeral">2</span> <span class="main">-</span> integral <span class="main">{</span><span class="bound">x</span><span class="main">..</span><span class="bound">x</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span>"</span></span>    
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>frac <span class="bound">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="skolem">d</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">{</span>of_int <span class="skolem">i</span><span class="main">..</span>of_int <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_spike<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>frac <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> of_int <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="skolem">i</span><span class="main">..</span>of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> of_int <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"floor <span class="skolem">x</span> <span class="main">=</span> of_int <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> floor_unique<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> of_int <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> of_int <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> integral <span class="main">{</span>of_int <span class="skolem">i</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">{</span>real_of_int <span class="skolem">i</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="skolem">i</span><span class="main">&lt;..&lt;</span>of_int <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that i
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_has_vector_derivative cont'<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">{</span>real_of_int <span class="skolem">i</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="skolem">i</span><span class="main">&lt;..&lt;</span>of_int <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> 
      <span class="keyword1"><span class="command">using</span></span> that i at_within_interior<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>of_int <span class="skolem">i</span><span class="main">..</span>of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span> <span class="keyword1">has_integral</span> <span class="skolem">g</span> <span class="main">(</span>of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">g</span> <span class="main">(</span>of_int <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>of_int <span class="skolem">i</span><span class="main">..</span>of_int <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> g_def h_def <span class="keyword1"><span class="command">using</span></span> that 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus_interior_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> indefinite_integral_continuous_1
             integrable_continuous_real<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">(</span>of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">g</span> <span class="main">(</span>of_int <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">d</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def scaleR_add_right <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> d_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span> <span class="keyword1">has_integral</span> <span class="skolem">d</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">{</span>of_int <span class="skolem">i</span><span class="main">..</span>of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span><span class="main">∈</span><span class="var">?A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>frac <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="skolem">d</span> <span class="main">(</span><span class="main">⌊</span>Inf <span class="bound">I</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="bound">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="main">(</span>frac <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="var">?A</span><span class="main">.</span> <span class="skolem">d</span> <span class="main">(</span><span class="main">⌊</span>Inf <span class="bound">I</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="var">?A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_Union * finite_imageI<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> negligible_atLeastAtMostI pairwiseI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="var">?A</span> <span class="main">=</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Union_atLeastAtMost_real_of_int ab<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="var">?A</span><span class="main">.</span> <span class="skolem">d</span> <span class="main">(</span><span class="main">⌊</span>Inf <span class="bound">I</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">.</span> <span class="skolem">d</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
                    <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
                  <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">.</span> integral <span class="main">{</span>real_of_int <span class="bound">i</span><span class="main">..</span><span class="main">1</span> <span class="main">+</span> real_of_int <span class="bound">i</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="var">?S1</span> <span class="main">+</span> <span class="var">?S2</span><span class="main">)</span> <span class="main">-</span> <span class="var">?S3</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum.distrib sum_subtractf scaleR_sum_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">using</span></span> ab <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_atLeastAtMost_int_last<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="main">+</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">using</span></span> ab <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_atLeastAtMost_int_head<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S2</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">+</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">+</span> <span class="free">f</span> <span class="free">a</span> <span class="main">-</span> <span class="free">f</span> <span class="free">b</span> <span class="main">+</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> 
                <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">S</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">S</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">S</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleR_add_right <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S3</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">I</span><span class="main">∈</span><span class="var">?A</span><span class="main">.</span> integral <span class="bound">I</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_combine_division_topdown <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> division integrable_continuous_real 
              <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_sum_integral_has_integral_int'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="main">1</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">I</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="numeral">2</span> <span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_sum_integral_has_integral_int <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def bernpoly_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> EM_remainder'_Suc_0<span class="main">:</span> <span class="quoted"><span class="quoted">"EM_remainder' <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">f'</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="free">S</span> <span class="main">-</span> <span class="free">I</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_sum_integral_has_integral_int' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff EM_remainder'_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we show that the $n$-th-order remainder can be expressed in terms of the $n+1$-th-order 
  remainder term. Iterating this essentially yields the Euler--MacLaurin formula.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">f'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span>   <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span>  <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont'<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span> <span class="free">f'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">&lt;..&lt;</span>of_int <span class="free">b</span><span class="main">}</span> <span class="main">-</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> EM_remainder'_integral_conv_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span>bernoulli <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span>
              integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder'_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span> <span class="main">=</span> has_field_derivative_pbernpoly_Suc'
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">`</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">∪</span> <span class="free">A</span>"</span></span>
    
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">-</span><span class="skolem">T</span> <span class="main">+</span> <span class="main">(</span><span class="var">?h</span> <span class="free">b</span> <span class="main">-</span> <span class="var">?h</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integration_by_parts_interior_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bounded_bilinear_scaleR<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f'</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">&lt;..&lt;</span>of_int <span class="free">b</span><span class="main">}</span> <span class="main">-</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
      <span class="keyword1"><span class="command">using</span></span> deriv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_EM_remainder' cont'<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_cmul<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> 
                    <span class="keyword1">has_integral</span> <span class="var">?h</span> <span class="free">b</span> <span class="main">-</span> <span class="var">?h</span> <span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">T</span> <span class="main">+</span> <span class="main">(</span><span class="var">?h</span> <span class="free">b</span> <span class="main">-</span> <span class="var">?h</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> integrable_EM_remainder'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">f'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff T_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> ab n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span>
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> not_le <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Ints_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="free">b</span> <span class="main">-</span> <span class="var">?h</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span>bernoulli <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> bernoulli'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span> <span class="main">-</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_cmul<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder'_conv_Suc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">*</span> bernoulli <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">f</span> <span class="free">b</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> 
     EM_remainder' <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EM_remainder'_def EM_remainder'_integral_conv_Suc scaleR_diff_right 
                scaleR_add_right <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">f'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">C</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span>   <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span>  <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont'<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="free">f'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lim<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">&lt;..}</span> <span class="main">-</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>  
  
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> EM_remainder_converges_iff_Suc_converges<span class="main">:</span>
          <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">⟷</span> EM_remainder_converges <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   EM_remainder_conv_Suc<span class="main">:</span> 
           <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">⟹</span> 
              EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> 
                  <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">*</span> bernoulli <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> 
                  EM_remainder <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">*</span> bernoulli <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">*</span> bernoulli <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> limit_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span> <span class="main">⤏</span> <span class="skolem">G</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def G_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> lim<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
              <span class="skolem">g</span> <span class="bound">x</span> <span class="main">+</span> EM_remainder' <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> EM_remainder'_conv_Suc<span class="main">[</span><span class="operator">OF</span> elim n fin continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont<span class="main"><span class="main">]</span></span> 
            continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont'<span class="main"><span class="main">]</span></span> deriv<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EM_remainder_converges_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span> <span class="main">-</span> <span class="skolem">G</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_top<span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="main">=</span>
               EM_remainder' <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span> <span class="main">-</span> <span class="skolem">G</span><span class="main">)</span> at_top"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> limit_g<span class="main"><span class="main">]</span></span> L<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder_converges_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EM_remainder <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="free">a</span> <span class="main">=</span> <span class="skolem">L</span> <span class="main">-</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> EM_remainder_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> EM_remainder_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="skolem">G</span> <span class="main">+</span> EM_remainder <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="free">a</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> EM_remainder_converges_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">G</span> <span class="main">+</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="main">+</span> EM_remainder' <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
                EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="main">+</span> EM_remainder' <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f'</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">G</span> <span class="main">+</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> limit_g<span class="main"><span class="main">]</span></span> L<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">n</span> <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder_converges_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The conventional version of the Euler--MacLaurin formula›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following theorems are the classic Euler--MacLaurin formula that can be found,
  with slight variations, in many sources (e.\,g.\ \cite{AS_HMF, apostol99, GKP_CM}).
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">assumes</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">N</span> <span class="main">⟹</span> continuous_on <span class="main">{</span>real_of_int <span class="free">a</span><span class="main">..</span>real_of_int <span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">N</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="keyword1">has_vector_derivative</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> euler_maclaurin_raw_strong_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">&lt;..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≡</span> integral <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="free">b</span> <span class="main">-</span> <span class="free">fs</span> <span class="bound">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="free">c'</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> bernoulli <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="free">b</span> <span class="main">-</span> <span class="free">fs</span> <span class="bound">k</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">m</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> EM_remainder' <span class="skolem">m</span> <span class="main">(</span><span class="free">fs</span> <span class="skolem">m</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dec_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">with</span></span> ab fin fs_cont<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fs_deriv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> N <span class="keyword1"><span class="command">unfolding</span></span> One_nat_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> EM_remainder'_Suc_0<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> S_def I_def c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> step.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> EM_remainder' <span class="skolem">n</span> <span class="main">(</span><span class="free">fs</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> step.IH<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span>
                  <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> bernoulli <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="skolem">n</span> <span class="free">b</span> <span class="main">-</span> <span class="free">fs</span> <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?c</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EM_remainder'_Suc_0 c_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">+</span> EM_remainder' <span class="skolem">n</span> <span class="main">(</span><span class="free">fs</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?c</span> <span class="main">+</span> EM_remainder' <span class="skolem">n</span> <span class="main">(</span><span class="free">fs</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> step.prems step.hyps ab fin
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">+</span> EM_remainder' <span class="skolem">n</span> <span class="main">(</span><span class="free">fs</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> EM_remainder' <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> EM_remainder'_conv_Suc <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fs_deriv fs_cont<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> N 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-</span> <span class="free">I</span> <span class="main">=</span> sum <span class="skolem">c</span> <span class="main">{..&lt;</span><span class="free">N</span><span class="main">}</span> <span class="main">+</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="skolem">c</span> <span class="main">{..&lt;</span><span class="free">N</span><span class="main">}</span> <span class="main">=</span> sum <span class="free">c'</span> <span class="main">{..&lt;</span><span class="free">N</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">c'</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="skolem">k</span>"</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c_def c'_def bernoulli'_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> bernoulli_odd_eq_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">theorem</span></span> euler_maclaurin_strong_raw_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">N</span> <span class="main">⟹</span> continuous_on <span class="main">{</span>real <span class="free">a</span><span class="main">..</span>real <span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">N</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="free">a</span><span class="main">..</span>real <span class="free">b</span><span class="main">}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="keyword1">has_vector_derivative</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">&lt;..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> integral <span class="main">{</span>real <span class="free">a</span><span class="main">..</span>real <span class="free">b</span><span class="main">}</span> <span class="free">f</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>real <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>real <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
           EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>real <span class="free">a</span><span class="main">)</span> <span class="main">(</span>real <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span>int <span class="free">a</span><span class="main">&lt;..</span>int <span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
           integral <span class="main">{</span>real_of_int <span class="main">(</span>int <span class="free">a</span><span class="main">)</span><span class="main">..</span>real_of_int <span class="main">(</span>int <span class="free">b</span><span class="main">)</span><span class="main">}</span> <span class="free">f</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> 
             <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>real_of_int <span class="main">(</span>int <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>real_of_int <span class="main">(</span>int <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
           EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="main">(</span>int <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="main">(</span>int <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> euler_maclaurin_raw_strong_int<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> assms<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span>int <span class="free">a</span><span class="main">&lt;..</span>int <span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">&lt;..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">int</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">nat</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The ``Concrete Mathematics'' version of the Euler--MacLaurin formula›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As explained in \textit{Concrete Mathematics}~\cite{GKP_CM}, the above form of the 
  formula has some drawbacks: When applying it to determine the asymptotics of some concrete 
  function, one is usually left with several different unwieldy constant terms that are difficult 
  to get rid of.

  There is no general way to determine what these constant terms are, but in concrete applications, 
  they can often be determined or estimated by other means. We can therefore simply group all the 
  constant terms into a single constant and have the user provide a proof of what it is.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> euler_maclaurin_int <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">assumes</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">N</span> <span class="main">⟹</span> continuous_on <span class="main">{</span>real_of_int <span class="free">a</span><span class="main">..}</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">N</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="keyword1">has_vector_derivative</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">F</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> limit<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span> <span class="main">-</span> 
         <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C'</span> <span class="free">T</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">C'</span> <span class="main">≡</span> <span class="main">-</span><span class="free">f</span> <span class="free">a</span> <span class="main">+</span> <span class="free">F</span> <span class="free">a</span> <span class="main">+</span> <span class="free">C</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> euler_maclaurin_strong_int_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">T</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">=</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">C'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> C'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def EM_remainder'_def T_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">T'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T'</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">&lt;..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> integral <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span> <span class="free">f</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
          EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ab
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> euler_maclaurin_raw_strong_int <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> N fin fs_0
              continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fs_cont<span class="main"><span class="main">]</span></span> fs_deriv<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">F</span> <span class="free">b</span> <span class="main">-</span> <span class="free">F</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ab
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> F_cont<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">derivative_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span>of_int <span class="free">a</span><span class="main">..</span>of_int <span class="free">b</span><span class="main">}</span> <span class="free">f</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">fs</span> <span class="bound">k</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="free">T</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">T'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_def T'_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_subtractf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">&lt;..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">using</span></span> ab <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_atLeastAtMost_int_head<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> C'_def T'_def<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> EM_remainder_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≡</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"EM_remainder <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="free">C'</span> <span class="main">-</span> <span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> EM_remainder_converges<span class="main">:</span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> limit
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="free">a</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span> <span class="main">-</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top <span class="main">=</span>
             <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="free">a</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">T</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> T_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">T</span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> 
               EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">C'</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> eventually_gt_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">rule</span> euler_maclaurin_strong_int_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ab<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top <span class="main">⟷</span> <span class="main">(</span><span class="var">?g</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_cong refl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">C'</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">C'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ tendsto_const<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C'</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">D</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C'</span> <span class="main">-</span> <span class="free">D</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> *<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">D</span> <span class="main">=</span> 
                          EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> at_top"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
            <span class="free">D</span> <span class="main">+</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">(</span>of_int <span class="skolem">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> elim ab <span class="keyword1"><span class="command">unfolding</span></span> D_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> EM_remainder'_combine <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fs_cont<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">⤏</span> <span class="free">C'</span> <span class="main">-</span> <span class="free">D</span><span class="main">)</span> at_top <span class="main">⟷</span> <span class="main">(</span><span class="var">?g</span> <span class="main">⤏</span> <span class="free">C'</span> <span class="main">-</span> <span class="free">D</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_cong refl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"EM_remainder_converges <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> EM_remainder_converges_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"EM_remainder <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="free">b</span> <span class="main">=</span> <span class="free">C'</span> <span class="main">-</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> EM_remainder_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> euler_maclaurin_strong_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span> <span class="main">+</span> <span class="free">T</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">-</span> EM_remainder <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">T</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="free">C'</span> <span class="main">-</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> euler_maclaurin_strong_int_aux<span class="main">[</span><span class="operator">OF</span> ab<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C'</span> <span class="main">-</span> EM_remainder' <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">=</span> EM_remainder <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ab <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> EM_remainder_limit<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following version of the formula removes all the terms where the associated
  Bernoulli numbers vanish. 
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> euler_maclaurin_int' <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span> <span class="main">⟹</span> continuous_on <span class="main">{</span>real_of_int <span class="free">a</span><span class="main">..}</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">N</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="keyword1">has_vector_derivative</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>of_int <span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">F</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> limit<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span> <span class="main">-</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> euler_maclaurin_int <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">Y</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">insert</span> fin fs_0 fs_cont fs_deriv F_cont F_deriv limit<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> euler_maclaurin_strong_int'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
             <span class="free">F</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">+</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
             EM_remainder <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real_of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               <span class="free">F</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
               EM_remainder <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> euler_maclaurin_strong_int<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lessThan_Suc_atMost Suc_eq_plus1 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">0</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span> <span class="main">+</span> 
               <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms bernoulli'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.reindex_bij_witness_not_neutral<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">}</span><span class="main">.</span> even <span class="bound">i</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">}</span> <span class="main">-</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli_odd_eq_0 bernoulli'_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bernoulli'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For convenience, we also offer a version where the sum ranges over natural numbers
  instead of integers.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_atLeastAtMost_of_int_nat_transfer<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span>int <span class="free">a</span><span class="main">..</span>int <span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_nat <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">int</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">nat</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> euler_maclaurin_nat_int_transfer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_vector"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">T</span> <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span>int <span class="free">a</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">T</span> <span class="main">(</span>of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span>int <span class="free">a</span><span class="main">..</span>int <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>of_int <span class="main">(</span>int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">T</span> <span class="main">(</span>of_int <span class="main">(</span>int <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_atLeastAtMost_of_int_nat_transfer<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_int_of_nat_at_topD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">locale</span></span> euler_maclaurin_nat <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">assumes</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">N</span> <span class="main">⟹</span> continuous_on <span class="main">{</span>real <span class="free">a</span><span class="main">..}</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">N</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="keyword1">has_vector_derivative</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>real <span class="free">a</span><span class="main">..}</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">F</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> limit<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span> <span class="main">-</span> 
         <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> euler_maclaurin_int <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="quoted">"int <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">Y</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">insert</span> N fin fs_cont fs_deriv F_cont F_deriv 
                 euler_maclaurin_nat_int_transfer<span class="main"><span class="main">[</span></span><span class="operator">OF</span> limit<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> euler_maclaurin_strong_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>real <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>real <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
               EM_remainder <span class="free">N</span> <span class="main">(</span><span class="free">fs</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>int <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> euler_maclaurin_strong_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"int <span class="free">b</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_atLeastAtMost_of_int_nat_transfer<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> euler_maclaurin_nat' <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span> <span class="main">⟹</span> continuous_on <span class="main">{</span>real <span class="free">a</span><span class="main">..}</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fs_deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">N</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fs</span> <span class="bound">k</span> <span class="keyword1">has_vector_derivative</span> <span class="free">fs</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span>real <span class="free">a</span><span class="main">..}</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_deriv <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">F</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> limit<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">F</span> <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span> <span class="main">-</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="bound">i</span> <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> euler_maclaurin_int' <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="quoted">"int <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">Y</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">insert</span> fin fs_cont fs_deriv F_cont F_deriv 
                 euler_maclaurin_nat_int_transfer<span class="main"><span class="main">[</span></span><span class="operator">OF</span> limit<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> euler_maclaurin_strong_nat'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
             <span class="free">F</span> <span class="main">(</span>real <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span>real <span class="free">b</span><span class="main">)</span> <span class="main">+</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>real <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
             EM_remainder <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> euler_maclaurin_strong_int'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_atLeastAtMost_of_int_nat_transfer<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bounds on the remainder term›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following theorems provide some simple means to bound the remainder terms.
  In practice, better bounds can often be obtained e.\,g. for the $n$-th remainder term
  by expanding it to the sum of the first discarded term in the expansion and the $n+1$-th 
  remainder term.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>real_normed_field<span class="main">,</span> banach<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="free">g'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span>     <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pbernpoly_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span>pbernpoly <span class="free">n</span> <span class="bound">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_f<span class="main">:</span>  <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_g<span class="main">:</span>  <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_g'<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> limit_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">⤏</span> <span class="free">C</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="free">g'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   norm_EM_remainder_le_strong_int<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> of_int <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     norm_EM_remainder_le_strong_nat<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> real <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pbernpoly_bound <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> D_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> <span class="free">D</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> D_nonneg <span class="keyword1"><span class="command">have</span></span> D'_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D'</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">y</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> norm <span class="main">(</span>integral <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EM_remainder'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">D</span> <span class="main">*</span> <span class="free">g'</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xy
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span> continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_g'<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>integral <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
            integral <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">D</span> <span class="main">*</span> <span class="free">g'</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D D_nonneg xy
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_norm_bound_integral integrable_EM_remainder' 
               continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_f<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_mono f_bound<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">D</span> <span class="main">*</span> integral <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span> <span class="free">g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g'</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">y</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xy
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">]</span></span> continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_g<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> deriv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span> <span class="free">g'</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">y</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D'_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> lim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span>of_int <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> at_top"</span></span> 
    <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">C</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> limit_g filterlim_real_sequentially<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> Cauchy<span class="main">:</span> <span class="quoted"><span class="quoted">"Cauchy <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> convergent_eq_Cauchy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Cauchy <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span>int <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> CauchyI'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ε</span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ε'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">D'</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">D'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> D'_nonneg <span class="keyword1"><span class="command">have</span></span> ε'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ε'_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> CauchyD<span class="main">[</span><span class="operator">OF</span> Cauchy this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> 
        <span class="keyword2"><span class="keyword">where</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">M</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≥</span> <span class="skolem">M</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">g</span> <span class="main">(</span>real <span class="bound">m</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">ε'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> CauchyI' exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"max <span class="main"><span class="main">(</span></span>max <span class="main"><span class="main">0</span></span> <span class="skolem"><span class="skolem">M</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>nat <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">l</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="main">+</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">k</span> <span class="skolem">l</span> <span class="main">=</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> EM_remainder'_combine continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_f<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="skolem">l</span> <span class="main">-</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="main">=</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">k</span> <span class="skolem">l</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 1 x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="skolem">D'</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">l</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bound<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">l</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">k</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">g</span> <span class="skolem">l</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">ε'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">*</span> <span class="skolem">ε'</span> <span class="main">≤</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ε'_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D'_nonneg mult_left_mono dist_norm norm_minus_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span>int <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cauchy_convergent_iff convergent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> filterlim_int_of_nat_at_topD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span>of_int <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">L</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> EM_remainder_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span>of_int <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D'</span> <span class="main">*</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_le<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">D'</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span>of_int <span class="bound">y</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>of_int <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">D'</span> <span class="main">*</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>of_int <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> limit_g<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> norm <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span>of_int <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tendsto_norm lim<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> norm <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>of_int <span class="bound">y</span><span class="main">)</span><span class="main">)</span>
             <span class="main">≤</span> <span class="skolem">D'</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span>of_int <span class="bound">y</span><span class="main">)</span> <span class="main">-</span> <span class="free">g</span> <span class="main">(</span>of_int <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> at_top"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">rule</span> bound<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> of_int <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D'</span> <span class="main">*</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D'</span> <span class="main">*</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">using</span></span> x *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"int <span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> real <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D'</span> <span class="main">*</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>real_normed_field<span class="main">,</span> banach<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="free">g'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span>     <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pbernpoly_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span>pbernpoly <span class="free">n</span> <span class="bound">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_f<span class="main">:</span>  <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_g<span class="main">:</span>  <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_g'<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> limit_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="main">-</span><span class="free">g'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   norm_EM_remainder_le_strong_int'<span class="main">:</span> 
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> of_int <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   norm_EM_remainder_le_strong_nat'<span class="main">:</span> 
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> real <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> of_int <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">0</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> norm_EM_remainder_le_strong_int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin pbernpoly_bound _ _ cont_g'<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> of_int <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> real <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">0</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> norm_EM_remainder_le_strong_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin pbernpoly_bound _ _ cont_g'<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> real <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> norm_EM_remainder'_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>real_normed_field<span class="main">,</span> banach<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="free">g'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_f<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_g'<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g'</span> <span class="bound">x</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span>  <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="free">g'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">C</span> <span class="free">D</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">C</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> at_top"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> cont <span class="main">=</span> continuous_on_subset<span class="main">[</span><span class="operator">OF</span> cont_f<span class="main">]</span> continuous_on_subset<span class="main">[</span><span class="operator">OF</span> cont_g'<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> bounded_pbernpoly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span>pbernpoly <span class="free">n</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> D_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> eventually_conj<span class="main">[</span><span class="operator">OF</span> f_bigo eventually_conj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deriv eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x0</span></span> <span class="keyword2"><span class="keyword">where</span></span> x0<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x0</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">x0</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g'</span> <span class="bound">x</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">x0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="free">g'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_top_linorder<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span>norm <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">x0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">D</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x0</span><span class="main">)</span> <span class="main">/</span> fact <span class="free">n</span>"</span></span>
      
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x0</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span>
            integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">x0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">+</span>
            integral <span class="main">{</span><span class="skolem">x0</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I1</span> <span class="main">+</span> <span class="var">?I2</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> elim x0<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Henstock_Kurzweil_Integration.integral_combine <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> integrable_EM_remainder' cont<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> norm <span class="var">?I1</span> <span class="main">+</span> norm <span class="var">?I2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm_triangle_ineq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="var">?I2</span> <span class="main">≤</span> integral <span class="main">{</span><span class="skolem">x0</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">*</span> <span class="free">g'</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x0 D D_nonneg
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_norm_bound_integral integrable_EM_remainder'<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span> cont mult_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">D</span> <span class="main">*</span> integral <span class="main">{</span><span class="skolem">x0</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> elim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g'</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">x0</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">x0</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus<span class="main">)</span> 
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_field_derivative_at_within<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x0<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> 
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="skolem">x0</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">g'</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">x0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> pbernpoly <span class="free">n</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> norm <span class="var">?I1</span> <span class="main">+</span> <span class="skolem">D</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">x0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>EM_remainder' <span class="free">n</span> <span class="free">f</span> <span class="free">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EM_remainder'_def <span class="dynamic"><span class="dynamic">field_simps</span></span> C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Application to harmonic numbers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As a first application, we can apply the machinery we have developed to the 
  harmonic numbers.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">harm_remainder</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">harm_remainder</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> EM_remainder <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> harm_expansion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"harm <span class="free">n</span> <span class="main">=</span> ln <span class="free">n</span> <span class="main">+</span> euler_mascheroni <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="main">-</span>
                     <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> harm_remainder <span class="free">N</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> fact <span class="bound">k</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>    
  <span class="keyword1"><span class="command">interpret</span></span> euler_maclaurin_nat' <span class="quoted">ln</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="bound">x</span>"</span></span> <span class="quoted"><span class="skolem">fs</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted">euler_mascheroni</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="main">1</span><span class="main">..}</span> <span class="main">-</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">fs</span> <span class="skolem">k</span> <span class="keyword1">has_vector_derivative</span> <span class="skolem">fs</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> 
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs_def has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 
                     <span class="dynamic"><span class="dynamic">field_simps</span></span> power_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> harm <span class="bound">b</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span> <span class="main">-</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="bound">b</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">⇢</span> <span class="main">(</span>euler_mascheroni <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tendsto_diff euler_mascheroni_LIMSEQ tendsto_sum 
            real_tendsto_divide_at_top<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">]</span></span> 
            filterlim_tendsto_pos_mult_at_top<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">]</span></span> filterlim_pow_at_top
            filterlim_real_sequentially<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span> <span class="main">-</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">fs</span> <span class="bound">i</span> <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> euler_mascheroni"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> fs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> n N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span>
         <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs_def has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"harm <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">+</span> euler_mascheroni <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="free">n</span><span class="main">)</span> <span class="main">+</span>
                     <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
                     EM_remainder <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>int <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n N
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> euler_maclaurin_strong_nat'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> 
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fs_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> fact_reduce <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_remainder_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_ge_1_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="free">x</span> <span class="main">≥</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linordered_semidom<span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> of_nat_le_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> harm_remainder_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="main">1</span><span class="main">.</span> norm <span class="main">(</span>harm_remainder <span class="free">N</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">C</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bounded_pbernpoly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span>pbernpoly <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> real <span class="bound">x</span> <span class="main">⟶</span> norm <span class="main">(</span>harm_remainder <span class="free">N</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span>
          <span class="skolem">D</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> harm_remainder_def of_int_of_nat_eq
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> norm_EM_remainder_le_strong_nat'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">-</span>fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> fact <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> real_tendsto_divide_at_top<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">]</span></span> filterlim_pow_at_top filterlim_ident<span class="main">)</span>
         <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> N D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟶</span> norm <span class="main">(</span>harm_remainder <span class="free">N</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Application to sums of inverse squares›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the same vein, we can derive the asymptotics of the partial sum of inverse squares.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_inverse_squares_expansion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> 
            pi <span class="main">^</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> real <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span>
                     <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> 
                    EM_remainder <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>int <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> fact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>    
  <span class="keyword1"><span class="command">interpret</span></span> euler_maclaurin_nat' <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="bound">x</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="quoted"><span class="skolem">fs</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="quoted">"pi<span class="main">^</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">6</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="main">1</span><span class="main">..}</span> <span class="main">-</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">fs</span> <span class="skolem">k</span> <span class="keyword1">has_vector_derivative</span> <span class="skolem">fs</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> 
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs_def has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 
                     <span class="dynamic"><span class="dynamic">field_simps</span></span> power_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> inverse_squares_sums
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">⇢</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">6</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Suc</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">k</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">b</span> <span class="main">-</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">b</span> <span class="main">^</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">⇢</span> <span class="main">(</span>pi<span class="main">^</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">6</span> <span class="main">+</span> <span class="main">0</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tendsto_diff tendsto_add real_tendsto_divide_at_top<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">]</span></span> 
            filterlim_tendsto_pos_mult_at_top<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">]</span></span> filterlim_pow_at_top
            filterlim_real_sequentially tendsto_sum<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="bound">b</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">k</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">b</span><span class="main">)</span> <span class="main">-</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span>bernoulli' <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">fs</span> <span class="bound">i</span> <span class="main">(</span>real <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> pi<span class="main">^</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">6</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_def <span class="dynamic"><span class="dynamic">field_simps</span></span> fs_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc of_nat_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> n N<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span>
         <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs_def has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> power2_eq_square<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> real <span class="free">n</span> <span class="main">+</span> pi<span class="main">^</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">6</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="free">n</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
               EM_remainder <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>int <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n N
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> euler_maclaurin_strong_nat'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">fs</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span>bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> 
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fs_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> fact_reduce <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> real <span class="free">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fs_def 3<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_inverse_squares_remainder_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> EM_remainder <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>int <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="main">1</span><span class="main">.</span> norm <span class="main">(</span><span class="free">R</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">C</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> bounded_pbernpoly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span>pbernpoly <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> real <span class="bound">x</span> <span class="main">⟶</span> norm <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D</span> <span class="main">/</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R_def of_int_of_nat_eq
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> norm_EM_remainder_le_strong_nat'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">-</span>fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> real_tendsto_divide_at_top<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">]</span></span> filterlim_pow_at_top filterlim_ident<span class="main">)</span>
         <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> N D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power_diff 3<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="main">1</span><span class="main">.</span> norm <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D</span> <span class="main">/</span> real <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Euler_MacLaurin_Landau">
<div class="head">
<h1>Theory Euler_MacLaurin_Landau</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Connection of Euler--MacLaurin summation to Landau symbols›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Euler_MacLaurin_Landau
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Euler_MacLaurin.html">Euler_MacLaurin</a>
  <a href="../Landau_Symbols/Landau_More.html">Landau_Symbols.Landau_More</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹$O$-bound for the remainder term›</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Landau symbols allow us to state the bounds on the remainder terms 
  from the Euler--MacLaurin formula a bit more nicely.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>real_normed_field<span class="main">,</span> banach<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="free">g'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span>     <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_f<span class="main">:</span>  <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_g<span class="main">:</span>  <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont_g'<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> limit_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">-</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="main">-</span><span class="free">g'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   EM_remainder_strong_bigo_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>int<span class="main">.</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   EM_remainder_strong_bigo_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>nat<span class="main">.</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bounded_pbernpoly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span>pbernpoly <span class="free">n</span> <span class="bound">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> norm_EM_remainder_le_strong_int'<span class="main">[</span><span class="operator">OF</span> fin D assms<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>int<span class="main">.</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> abs <span class="main">(</span><span class="skolem">D</span> <span class="main">/</span> fact <span class="free">n</span><span class="main">)</span> <span class="main">*</span> abs <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ceiling <span class="free">a</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ceiling_le_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> abs <span class="main">(</span><span class="skolem">D</span> <span class="main">/</span> fact <span class="free">n</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_ge_self<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> abs <span class="main">(</span><span class="skolem">D</span> <span class="main">/</span> fact <span class="free">n</span><span class="main">)</span> <span class="main">*</span> abs <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>int<span class="main">.</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigoI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"abs <span class="skolem"><span class="skolem"><span class="skolem">D</span></span></span> <span class="main"><span class="main"><span class="main">/</span></span></span> fact <span class="free"><span class="free"><span class="free">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>nat<span class="main">.</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span>of_int <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> landau_o.big.compose<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> filterlim_int_sequentially<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>nat<span class="main">.</span> norm <span class="main">(</span>EM_remainder <span class="free">n</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Asymptotic expansion of the harmonic numbers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now show the asymptotic expansion
  \[H_n = \ln n + \gamma + \frac{1}{2n} - \sum_{i=1}^m \frac{B_{2i}}{2i} n^{-2i} + O(n^{-2m-2})\]
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> harm_remainder_bigo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"harm_remainder <span class="free">N</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> harm_remainder_bound<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigoI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">C</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> harm_expansion_bigo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="bound">n</span> <span class="main">+</span> euler_mascheroni <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span> <span class="main">-</span>
                     <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">*</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>Suc <span class="free">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="free">T</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="free">T</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span><span class="free">S</span> <span class="bound">n</span> <span class="main">-</span> harm_remainder <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigthetaI_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">::</span></span></span>nat"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def harm_expansion<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">N</span>"</span></span><span class="main"><span class="main">]</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span><span class="free">S</span> <span class="bound">n</span> <span class="main">-</span> harm_remainder <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum_in_bigo<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> landau_o.big.compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ filterlim_real_sequentially<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"harm_remainder <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="free">N</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> harm_remainder_bigo<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="free">N</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> landau_o.big.compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ filterlim_real_sequentially<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"harm_remainder <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> harm_expansion_bigo_simple1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="main">(</span>ln <span class="bound">n</span> <span class="main">+</span> euler_mascheroni <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> harm_expansion_bigo<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> harm_expansion_bigo_simple2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="main">(</span>ln <span class="bound">n</span> <span class="main">+</span> euler_mascheroni<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="main">(</span>ln <span class="bound">n</span> <span class="main">+</span> euler_mascheroni <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_in_bigo<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="main">(</span>ln <span class="bound">n</span> <span class="main">+</span> euler_mascheroni <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> harm_expansion_bigo_simple1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> landau_o.big.compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ filterlim_real_sequentially<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> harm <span class="bound">n</span> <span class="main">-</span> <span class="main">(</span>ln <span class="bound">n</span> <span class="main">+</span> euler_mascheroni <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> harm_expansion_bigo_simple'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"harm <span class="keyword1">=o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="bound">n</span> <span class="main">+</span> euler_mascheroni <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">+o</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> harm_expansion_bigo_simple1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> set_minus_plus <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_diff_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Asymptotic expansion of the sum of inverse squares›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Similarly to before, we show
  \[\sum_{i=1}^n \frac{1}{i^2} = \frac{\pi^2}{6} - \frac{1}{n} + \frac{1}{2n^2} - 
     \sum_{i=1}^m B_{2i} n^{-2i-1} + O(n^{-2m-3})\]  
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">N</span> <span class="bound">n</span><span class="main">.</span> EM_remainder <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">N</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>fact <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">N</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">N</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>int <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_inverse_squares_remainder_bigo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">N</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sum_inverse_squares_remainder_bound<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigoI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">C</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_inverse_squares_expansion_bigo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> pi <span class="main">^</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span>
                     <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> bernoulli <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">i</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="free">T</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">i</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="free">T</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span><span class="free">S</span> <span class="bound">n</span> <span class="main">-</span> <span class="free">R</span> <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigthetaI_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">::</span></span></span>nat"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def sum_inverse_squares_expansion<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">N</span>"</span></span><span class="main"><span class="main">]</span></span> S_def 3
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span><span class="free">S</span> <span class="bound">n</span> <span class="main">-</span> <span class="free">R</span> <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum_in_bigo<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> landau_o.big.compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ filterlim_real_sequentially<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="free">N</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_inverse_squares_remainder_bigo<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> Suc <span class="free">N</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> landau_o.big.compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ filterlim_real_sequentially<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_inverse_squares_expansion_bigo_simple<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">i</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>pi <span class="main">^</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">n</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span> <span class="main">^</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_inverse_squares_expansion_bigo<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_inverse_squares_expansion_bigo_simple'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">i</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> pi <span class="main">^</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">6</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">n</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">+o</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">n</span><span class="main">^</span><span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_inverse_squares_expansion_bigo_simple
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> set_minus_plus <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_diff_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>